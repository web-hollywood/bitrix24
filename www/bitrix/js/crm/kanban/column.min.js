(function(){BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Column=function(t){BX.Kanban.Column.apply(this,arguments)};BX.CRM.Kanban.Column.prototype={__proto__:BX.Kanban.Column.prototype,constructor:BX.CRM.Kanban.Column,renderSubtitleTime:6,subtitleNode:null,pathToAdd:null,editorNodeTransition:200,editorNodeWaiting:null,editorNodeIsBlock:null,editorNodeIsVissible:false,editorNode:null,editorNodeContainer:null,editorNodeCreate:null,editorLoaded:false,quickFormSaveButton:null,quickFormCancelButton:null,editorId:null,editor:null,loader:null,currencyFormat:function(t,i,e){var o="",n;if(typeof BX.Currency==="undefined"){return t}e=!!e;n=BX.Currency.getCurrencyFormat(i);if(!!n&&typeof n==="object"){n.CURRENT_DECIMALS=n.DECIMALS;n.HIDE_ZERO="Y";if(n.HIDE_ZERO==="Y"&&t==parseInt(t,10)){n.CURRENT_DECIMALS=0}o=BX.util.number_format(t,n.CURRENT_DECIMALS,n.DEC_POINT,n.THOUSANDS_SEP);if(e){o=n.FORMAT_STRING.replace(/(^|[^&])#/,"$1"+o)}}return o},decPrice:function(t){var i=this.getData();i.sum=parseFloat(i.sum)-t;this.setData(i)},incPrice:function(t){var i=this.getData();i.sum=parseFloat(i.sum)+t;this.setData(i)},getAddColumnButton:function(){var t=this.getData();if(t.type==="WIN"){this.layout.info.style.marginRight="0";return BX.create("div")}else{return BX.Kanban.Column.prototype.getAddColumnButton.apply(this,arguments)}},getAddPath:function(){if(this.pathToAdd!==null){return this.pathToAdd}var t=this.getGridData();var i=t.entityType.toLowerCase();var e,o;if(i==="invoice"){e="crm_invoice_toolbar"}else{e="toolbar_"+i+"_list"}if(BX(e)){o=BX(e).querySelector("a");this.pathToAdd=o.getAttribute("href");this.pathToAdd+=this.pathToAdd.indexOf("?")===-1?"?":"&"}return this.pathToAdd},processQuickEditor:function(){this.editor.save();this.getLoader().show();BX.addClass(this.quickFormSaveButton,"ui-btn-wait");this.resetQuickEditor()},resetQuickEditor:function(){this.editorNodeContainer.style.height=this.editorNodeContainer.offsetHeight+"px";this.editorNodeContainer.innerHTML=""},showQuickEditor:function(t){if(t!==true){this.animateShowQuickEditor();this.getLoader().show()}var i=this.getGridData();var e=i.entityType;this.editorId="quick_editor_"+this.getId()+"_"+e.toLowerCase();if(typeof i.quickEditorPath[e.toLowerCase()]==="undefined"){return}var o={PARAMS:i.params};o[e==="DEAL"?"STAGE_ID":"STATUS_ID"]=this.getId();if(!this.editorNodeContainer.innerHTML){BX.ajax.post(i.quickEditorPath[e.toLowerCase()],{ACTION:"PREPARE_EDITOR_HTML",ACTION_ENTITY_TYPE_NAME:e,ACTION_ENTITY_ID:0,GUID:this.editorId,IS_EMBEDDED:"Y",ENABLE_REQUIRED_USER_FIELD_CHECK:"N",FIELDS:e==="DEAL"?["TITLE","OPPORTUNITY_WITH_CURRENCY","CLIENT"]:["TITLE","CLIENT"],CONTEXT:o},function(i){this.editorNodeContainer.innerHTML=i;this.editorNodeContainer.appendChild(this.editorNodeCreate);if(t){return}BX.removeClass(this.quickFormSaveButton,"ui-btn-wait");this.getLoader().hide();this.animateShowQuickEditor();this.editorNodeWaiting=setTimeout(function(){this.setHeightAuto()}.bind(this),this.editorNodeTransition)}.bind(this))}else{this.getLoader().hide();this.animateShowQuickEditor();BX.removeClass(this.quickFormSaveButton,"ui-btn-wait");setTimeout(function(){this.setHeightAuto()}.bind(this),this.editorNodeTransition)}if(!this.editorLoaded){BX.addCustomEvent(window,"BX.Crm.EntityEditor:onInit",function(t,i){if(t.getId()===this.editorId){this.editor=t}}.bind(this));BX.addCustomEvent(window,"onCrmEntityCreate",function(t){var i=t.sender.getContext();var o=e==="DEAL"?"STAGE_ID":"STATUS_ID";if(i[o]===this.getId()){this.getGrid().loadNew(t.entityId,true)}}.bind(this));BX.bind(window,"keydown",function(t){if(!this.editorNodeIsVissible){return}if(t.key==="Enter"&&this.editorNodeIsVissible){this.processQuickEditor();return}if(t.key==="Escape"&&!this.editorNodeIsBlock){this.hideQuickFormEditor();this.enabledAddButton()}}.bind(this));BX.bind(window,"click",function(t){if(this.isQuickFormPopup(t.target)||this.isQuickFormEditor(t.target)){return}this.hideQuickFormEditor();this.enabledAddButton()}.bind(this));BX.addCustomEvent(window,"BX.CRM.Kanban.Item.select",this.hideQuickFormEditor.bind(this));BX.addCustomEvent(window,"BX.CRM.Kanban.Item.select",this.enabledAddButton.bind(this));BX.addCustomEvent(window,"Kanban.Column:render",this.hideQuickFormEditor.bind(this));BX.addCustomEvent(window,"Kanban.Column:render",this.enabledAddButton.bind(this));BX.addCustomEvent(window,"Kanban.Grid:onItemDragStart",this.hideQuickFormEditor.bind(this));BX.addCustomEvent(window,"Kanban.Grid:onItemDragStart",this.enabledAddButton.bind(this))}this.editorLoaded=true;this.layout.items.insertBefore(this.editorNode,this.layout.items.firstChild)},hideQuickFormEditor:function(){BX.removeClass(this.editorNode,"crm-kanban-quick-form-show");this.editorNode.style.opacity="0";this.editorNode.style.height=this.editorNode.offsetHeight+"px";this.editorNode.style.marginBottom="0";setTimeout(function(){this.editorNode.style.height="0"}.bind(this));this.editorNodeIsBlock=true;setTimeout(function(){this.editorNodeIsBlock=false;this.editorNodeIsVissible=false}.bind(this),this.editorNodeTransition*2)},removeQuickFormEditor:function(){this.editorNode.parentNode.removeChild(this.editorNode)},disabledAddButton:function(t){BX.addClass(t,"crm-kanban-column-add-item-button-event")},enabledAddButton:function(){BX.removeClass(this.layout.subTitleAddButton,"crm-kanban-column-add-item-button-event")},animateShowQuickEditor:function(){BX.addClass(this.editorNode,"crm-kanban-quick-form-show");this.editorNode.style.opacity="1";this.editorNode.style.height="0px";this.editorNode.style.marginBottom="6px";setTimeout(function(){this.editorNode.style.height=this.getGridData().encodingType==="DEAL"?"358px":"285px"}.bind(this));this.editorNodeIsBlock=true;setTimeout(function(){this.editorNodeIsBlock=false;this.editorNodeIsVissible=true}.bind(this),this.editorNodeTransition*2)},setHeightAuto:function(){this.editorNode.style.height="auto"},isShowFormButton:function(t){var i=BX.findParent(t,{className:"crm-kanban-column-add-item-button"});return i===this.editorNode},isQuickFormPopup:function(t){return BX.findParent(t,{className:"popup-window"})},isQuickFormEditor:function(t){return BX.findParent(t,{className:"crm-kanban-quick-form"})},renderSubTitle:function(){var t=this.getData();var i=this.getGridData();if(i.entityType!=="LEAD"){if(!this.layout.subTitlePrice){this.layout.subTitlePriceText=BX.create("span",{attrs:{className:"crm-kanban-total-price-total"}});this.layout.subTitlePrice=BX.create("div",{attrs:{className:"crm-kanban-total-price"},children:[this.layout.subTitlePriceText]})}}else{this.layout.subTitlePrice=null}if(this.layout.subTitlePriceText){t.sum=parseFloat(t.sum);t.sum_old=t.sum_old?t.sum_old:t.sum_init;t.sum_init=t.sum;this.renderSubTitleAnimation(t.sum_old,t.sum,Math.abs(t.sum_old-t.sum)/20,this.layout.subTitlePriceText,function(e,o){e.innerHTML=this.currencyFormat(Math.round(o),i.currency,true);t.sum_old=t.sum}.bind(this));this.setData(t)}if(this.subtitleNode){return this.subtitleNode}var e="",o=true,n=false;if(t.sort===100&&(i.entityType==="LEAD"||i.entityType==="DEAL")){n=true;e=BX.message("CRM_KANBAN_PLUS_TITLE_"+i.entityType)}if(o){this.editorNode=BX.create("div",{props:{className:"crm-kanban-quick-form"},style:{transition:this.editorNodeTransition+"ms"},children:[this.editorNodeContainer=BX.create("div",{props:{className:"crm-kanban-quick-form-container"},style:{animationDelay:this.editorNodeTransition+"ms"}})]});BX.addCustomEvent(window,"CRM.Kanban.Column:clickAddButton",function(){this.hideQuickFormEditor();this.enabledAddButton()}.bind(this));this.editorNodeCreate=BX.create("div",{props:{className:"crm-kanban-qiuck-form-buttons"},children:[this.quickFormSaveButton=BX.create("input",{attrs:{type:"button",value:BX.message("CRM_KANBAN_POPUP_SAVE"),className:"ui-btn ui-btn-sm ui-btn-primary"},events:{click:function(t){this.processQuickEditor();BX.PreventDefault(t)}.bind(this)}}),this.quickFormCancelButton=BX.create("input",{attrs:{type:"button",value:BX.message("CRM_KANBAN_CONFIRM_N"),className:"ui-btn ui-btn-sm ui-btn-link"},events:{click:function(){this.enabledAddButton();this.hideQuickFormEditor()}.bind(this)}})]})}if(i.entityType==="LEAD"||i.entityType==="DEAL"){this.layout.subTitleAddButton=BX.create("div",{text:e,attrs:{className:"crm-kanban-column-add-item-button"},events:{click:o?function(t){if(document.getElementsByTagName("html")[0].classList.contains("bx-ie")){BX.SidePanel.Instance.open("/crm/lead/details/0/");return}if(BX.hasClass(this.layout.subTitleAddButton,"crm-kanban-column-add-item-button-event")||this.editorNodeIsVissible){BX.PreventDefault(t);return}BX.onCustomEvent(this,"CRM.Kanban.Column:clickAddButton");this.disabledAddButton(t.target);this.showQuickEditor();BX.PreventDefault(t)}.bind(this):null}})}else{this.layout.subTitleAddButton=this.getAddPath()?BX.create("a",{text:e,attrs:{className:"crm-kanban-column-add-item-button",href:this.getAddPath()+(i.entityType==="DEAL"?"stage_id=":"status_id=")+this.getId()}}):null}this.subtitleNode=BX.create("div",{children:[this.layout.subTitlePrice,o?this.layout.subTitleAddButton:this.getAddPath()?BX.create("a",{text:e,attrs:{className:"crm-kanban-column-add-item-button",href:this.getAddPath()+(i.entityType==="DEAL"?"stage_id=":"status_id=")+this.getId()}}):null,this.editorNode]});if(n){setTimeout(function(){this.showQuickEditor(true)}.bind(this))}return this.subtitleNode},getLoader:function(){if(!this.loader){this.loader=new BX.Loader({target:this.editorNode})}return this.loader},renderSubTitleAnimation:function(t,i,e,o,n){var s=+t;var d=parseFloat(i);var r=this.renderSubtitleTime;if(s<d){(function(){if(s<=d){setTimeout(arguments.callee,r);o.textContent=BX.util.number_format(s,0,","," ");s=s+e}else{if(typeof n==="function"){n(o,i)}}})()}else if(s>d){(function(){if(s>=d){setTimeout(arguments.callee,r);o.textContent=BX.util.number_format(s,0,","," ");s=s-e}else{if(typeof n==="function"){n(o,i)}}})()}else if(typeof n==="function"){n(o,i)}},handleAddColumnButtonClick:function(t){var i=this.getGridData();if(i.rights&&i.rights.canAddColumn){BX.Kanban.Column.prototype.handleAddColumnButtonClick.apply(this,arguments)}else if(typeof BX.Intranet!=="undefined"){this.getGrid().accessNotify()}},switchToEditMode:function(){var t=this.getGridData();if(t.rights&&t.rights.canAddColumn){BX.Kanban.Column.prototype.switchToEditMode.apply(this,arguments)}else if(typeof BX.Intranet!=="undefined"){this.getGrid().accessNotify()}}}})();