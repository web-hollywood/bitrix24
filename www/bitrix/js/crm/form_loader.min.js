var Bitrix24FormLoader={init:function(){this.yaId=null;this.forms={};this.eventHandlers=[];this.frameHeight="200";this.defaultNodeId="bx24_form_";if(!window.Bitrix24FormObject||!window[window.Bitrix24FormObject])return;if(!window[window.Bitrix24FormObject].forms)return;window[window.Bitrix24FormObject].forms.forEach(this.preLoad,this)},preLoad:function(e){var t=this;switch(e.type){case"click":case"button":case"link":var i=document.getElementById(this.defaultNodeId+e.type);var o=document.getElementsByClassName("b24-web-form-popup-btn-"+e.id);var n=e.click||null;if(!n&&o&&o.length>0){n=[];for(var a=0;a<o.length;a++){n.push(o.item(a))}}else if(!n&&i){n=i.nextElementSibling}if(n&&Object.prototype.toString.call(n)!="[object Array]"){n=[n]}var r=e;if(this.isFormExisted(e)){r=this.forms[this.getUniqueLoadId(e)]}n.forEach(function(e){var t=this;this.addEventListener(e,"click",function(){t.showPopup(r)})},this);break;case"delay":window.setTimeout(function(){t.showPopup(e)},1e3*(e.delay?e.delay:5));break;case"inline":default:this.load(e);break}},createPopup:function(e){if(this.isFormExisted(e))return;var t=this;var i=document.createElement("div");i.innerHTML=""+'<div style="display: none; position: fixed; width: 100%; min-height: 100%; background-color: rgba(0,0,0,0.5); overflow: hidden;  z-index: 10000; top: 0; right: 0; bottom: 0; left: 0;">'+'<div style="position: absolute; top: 50%; left: 50%; margin: 0 auto; min-width: 300px; min-height: 110px; background: #fff; -webkit-transform: translate(-50%, -50%); -moz-transform: translate(-50%, -50%); transform: translate(-50%, -50%); -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; -webkit-box-shadow: 1px 1px 10px 1px rgba(0,0,0,0.5); -moz-box-shadow: 1px 1px 10px 1px rgba(0,0,0,0.5); box-shadow: 1px 1px 10px 1px rgba(0,0,0,0.5);">'+'<div style="position: absolute; top: -10px; right: -10px; cursor: pointer; z-index: 1;">'+'<div data-bx-form-popup-close="" style="width: 20px; height: 20px; -webkit-border-radius: 50%;  -moz-border-radius: 50%; border-radius: 50%; background: rgba(0,0,0, .5);">'+'<svg viewbox="-5 -5 50 50"><path style="stroke: #fff; fill: transparent; stroke-width: 5;" d="M 10,10 L 30,30 M 30,10 L 10,30" /></svg>'+"</div>"+"</div>"+'<div data-bx-form-popup-cont="" style="margin: 0 auto; min-width: 600px; -webkit-overflow-scrolling: touch;"></div>'+"</div>"+"</div>";i=i.children[0];var o=i.querySelector("[data-bx-form-popup-cont]");var n=i.querySelector("[data-bx-form-popup-close]");this.addEventListener(i,"click",function(){t.hidePopup(e)});this.addEventListener(n,"click",function(){t.hidePopup(e)});if(document.body.children[0]){document.body.insertBefore(i,document.body.children[0])}else{document.body.appendChild(i)}var a=document.createElement("STYLE");a.setAttribute("type","text/css");a.appendChild(document.createTextNode("html.bx-ios-fix-frame-focus, .bx-ios-fix-frame-focus body {"+"height: 100%;"+"overflow: auto;"+"-webkit-overflow-scrolling: touch;"+"}"));document.head.appendChild(a);e.popup=i;e.node=o;this.addEventListener(window,"resize",function(){t.resizePopup(e)});this.addEventHandler(e,"keyboard",function(e,i){if(i==27)t.hidePopup(e)});this.addEventListener(document,"keyup",function(i){i=i||window.e;var o=typeof i.which=="number"?i.which:i.keyCode;if(o==27){t.hidePopup(e)}})},resizePopup:function(e){if(!e||!e["popup"]||!e["node"]){return}var t=100;var i=[document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight];i=i.filter(function(e){return e>0});var o=Math.min.apply(Math,i);var n=o-t;var a=n<=e.frameHeight;if(a){e.node.style["overflow-y"]="scroll";e.node.style["height"]=n+"px"}else{e.node.style["overflow-y"]="hidden";e.node.style.height=null}var r=Math.min(document.body.scrollWidth,document.documentElement.scrollWidth,document.body.offsetWidth,document.documentElement.offsetWidth,document.body.clientWidth,document.documentElement.clientWidth);r-=20;if(r<300)r=300;else if(r>600)r=600;e.node.style["min-width"]=r+"px"},showPopup:function(e){if(!e.popup){this.createPopup(e);this.load(e)}if(e.popup){if(this.util.isIOS())this.util.addClass(document.documentElement,"bx-ios-fix-frame-focus");e.popup.style.display="block"}},hidePopup:function(e){e.popup.style.display="none";if(this.util.isIOS())this.util.removeClass(document.documentElement,"bx-ios-fix-frame-focus")},scrollToPopupMiddle:function(e){var t=this.forms[e];if(!t){return}var i;if(t.popup){i=t.node.scrollHeight/2-200;t.node.scrollTop=i>0?i:0}else if(window.BX&&window.BX.pos){i=t.iframe.scrollHeight/2-200;var o=BX.pos(t.iframe);i+=o.top;var n=document.documentElement.clientHeight;var a=window.pageYOffset;if(i&&(i<a||i>a+n)){window.scrollTo(window.scrollWidth,i)}}},util:{addClass:function(e,t){if(e&&typeof e.className=="string"&&e.className.indexOf(t)===-1){e.className+=" "+t;e.className=e.className.replace("  "," ")}},removeClass:function(e,t){if(!e||!e.className){return}e.className=e.className.replace(t,"").replace("  "," ")},hasClass:function(e,t){var i=this.nodeListToArray(e.classList);var o=i.filter(function(e){return e==t});return o.length>0},isIOS:function(){return/(iPad;)|(iPhone;)/i.test(navigator.userAgent)},isMobile:function(){return/(ipad|iphone|android|mobile|touch)/i.test(navigator.userAgent)}},createFrame:function(e){var t=e.page||this.domain+"/pub/form.php";t+=t.indexOf("?")>-1?"&":"?";var i=document.createElement("iframe");var o="bx_form_iframe_"+e.id;var n={domain:window.location.protocol+"//"+window.location.host,from:window.location.href};if(e.fields){n.fields=e.fields}if(e.options){n.options=e.options}if(e.presets){n.presets=e.presets}var a=t+"view=frame&"+"form_id="+e.id+"&widget_user_lang="+e.lang+"&sec="+e.sec+"&r="+1*new Date+"#"+encodeURIComponent(JSON.stringify(n));i.setAttribute("id",o);i.setAttribute("name",o);i.setAttribute("src",a);i.setAttribute("scrolling","no");i.setAttribute("frameborder","0");i.setAttribute("marginheight","0");i.setAttribute("marginwidth","0");i.setAttribute("style","width: 100%; height: "+this.frameHeight+"px; border: 0px; overflow: hidden; padding: 0; margin: 0;");return i},getUniqueLoadId:function(e){var t=e.type;switch(t){case"click":case"button":case"link":t="button";break}return t+"_"+e.id},isFormExisted:function(e){return!!this.forms[this.getUniqueLoadId(e)]},load:function(e){if(this.isFormExisted(e))return;e.handlers=e.handlers||{};this.execEventHandler(e,"init",[e]);var t=this.getUniqueLoadId(e);this.forms[t]=e;var i=e.node?e.node:null;var o=document.getElementById(this.defaultNodeId+e.type);if(!i&&!o)return;this.domain=e.ref.match(/((http|https):\/\/[^\/]+?)\//)[1];var n=this.createFrame(e);e.iframe=n;if(i)i.appendChild(n);else o.parentNode.insertBefore(n,o);var a=this;this.addEventListener(n,"load",function(){a.onFrameLoad(t)});this.addEventListener(window,"message",function(e){if(e&&e.origin==a.domain){a.doFrameAction(e.data)}})},unload:function(e){if(!this.isFormExisted(e))return;this.execEventHandler(e,"unload",[e]);var t=this.getUniqueLoadId(e);var i=this.forms[t].iframe;if(i&&null!=i.parentNode)i.parentNode.removeChild(i);this.forms[t]=null},doFrameAction:function(e,t){var i={};try{i=JSON.parse(e)}catch(e){}if(!i.action||!i.value)return;switch(i.action){case"change_height":this.setFrameHeight(i.uniqueLoadId||t,parseInt(i.value));break;case"popup_showed":this.scrollToPopupMiddle(i.uniqueLoadId||t);break;case"redirect":window.location=i.value;break;case"keyboard":if(i.value==27){var o=this.forms[i.uniqueLoadId||t];if(o)this.execEventHandler(o,"keyboard",[o,i.value])}break;case"event":var o=this.forms[i.uniqueLoadId||t];if(o)this.execEventHandler(o,i.eventName,i.value);break;case"analytics":i.value.forEach(function(e){if(e.type=="ga"&&window.dataLayer){if(e.params[0]=="pageview"){window.dataLayer.push({event:"VirtualPageview",virtualPageURL:e.params[1]})}else if(e.params[0]=="event"){window.dataLayer.push({event:"crm-form",eventCategory:e.params[1],eventAction:e.params[2]})}}else if(e.type=="ga"&&window.ga){var t=window.ga.getAll().filter(function(t){return t.get("trackingId")==e.gaId}).length>0;if(!e.gaId||!t){if(e.params[2])window.ga("send",e.params[0],e.params[1],e.params[2]);else window.ga("send",e.params[0],e.params[1])}}else if(e.type=="ya"&&!window["yaCounter"+e.yaId]){if(!this.yaId){if(window["Ya"]&&Ya.Metrika&&Ya.Metrika.counters()[0]){this.yaId=Ya.Metrika.counters()[0].id}}if(this.yaId){window["yaCounter"+this.yaId].reachGoal(e.params[0])}}});break}},checkHash:function(e){var t=window.location.hash.substring(1);this.doFrameAction(t,e);var i=this;setTimeout(function(){i.checkHash(e)},500)},onFrameLoad:function(e){var t=this.forms[e];if(window.BX&&window.BX.onCustomEvent){BX.onCustomEvent("onFormFrameLoad",[t,e])}var i=0;if(typeof window.postMessage==="function"&&!i){var o={domain:this.domain,uniqueLoadId:e};if(window.BX&&window.BX.SiteGuest){var n=window.BX.SiteGuest.getPages();if(n&&n.length>0){o.visitedPages=n;this.addEventHandler(t,"send",function(e){window.BX.SiteGuest.send("link",e.gid)})}}this.execEventHandler(t,"init-frame-params",[t,o]);t.iframe.contentWindow.postMessage(JSON.stringify(o),this.domain)}else{this.checkHash(e)}this.execEventHandler(t,"load",[t])},addEventListener:function(e,t,i){e=e||window;if(window.addEventListener){e.addEventListener(t,i,false)}else{e.attachEvent("on"+t,i)}},addEventHandler:function(e,t,i){if(!t||!i){return}this.eventHandlers.push({target:e,eventName:t,handler:i})},execEventHandler:function(e,t,i){i=i||[];if(!t){return}this.eventHandlers.forEach(function(o){if(o.eventName!=t){return}if(o.target!=e){return}o.handler.apply(this,i)},this);if(e==this){}else{if(e.handlers&&e.handlers[t]){e.handlers[t].apply(this,i)}}},setFrameHeight:function(e,t){var i=this.forms[e];if(!i){return}if(i["frameHeight"]&&i.frameHeight==t)return;i.frameHeight=t;i.iframe.style["height"]=t+"px";if(i.popup){this.resizePopup(i)}}};Bitrix24FormLoader.init();