BX.namespace("BX.Tasks");BX.Tasks.DayPlan=BX.Tasks.Util.Base.extend({options:{query:false,data:[]},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Base);if(typeof this.vars=="undefined"){this.vars={}}this.vars.state={};this.vars.timeOffsets={};this.vars.taskData=BX.clone(this.option("data"));this.onPlannerUpdate=BX.debounce(this.onPlannerUpdate,100,this);this.onTimerUpdate=this.onTimerUpdate.bind(this);this.handleTimeManDataReceived=this.handleTimeManDataReceived.bind(this);this.handlePlannerDataReceived=this.handlePlannerDataReceived.bind(this);this.handleSliderDestroy=this.handleSliderDestroy.bind(this);if(window!==window.top){this.bindWidgetEvents(window.top);BX.addCustomEvent("SidePanel.Slider:onDestroy",this.handleSliderDestroy)}else{this.bindWidgetEvents(window)}BX.ready(BX.delegate(function(){if(!this.hasPlanner()){setInterval(BX.delegate(this.timerTickEmulation,this),1e3);BX.addCustomEvent(window,"tasksTaskEvent",BX.delegate(this.onTaskGlobalEvent,this))}},this))},bindWidgetEvents:function(e){e.BX.addCustomEvent(e,"onTimeManDataRecieved",this.handleTimeManDataReceived);e.BX.addCustomEvent(e,"onPlannerDataRecieved",this.handlePlannerDataReceived);e.BX.addCustomEvent(e,"onTaskTimerChange",this.onTimerUpdate)},unbindWidgetEvents:function(e){e.BX.removeCustomEvent(e,"onTimeManDataRecieved",this.handleTimeManDataReceived);e.BX.removeCustomEvent(e,"onPlannerDataRecieved",this.handlePlannerDataReceived);e.BX.removeCustomEvent(e,"onTaskTimerChange",this.onTimerUpdate)},handlePlannerDataReceived:function(e,t){this.onPlannerUpdate(t)},handleTimeManDataReceived:function(e){console.log("handleTimeManDataReceived",e.PLANNER);this.onPlannerUpdate(e.PLANNER)},handleSliderDestroy:function(e){this.unbindWidgetEvents(window.top);BX.removeCustomEvent("SidePanel.Slider:onDestroy",this.handleSliderDestroy)},onPlannerUpdate:function(e){e=e||{};e.TASKS=e.TASKS||[];e.TASK_ON_TIMER=e.TASK_ON_TIMER||{};var t;var a;var i={};for(a=0;a<e.TASKS.length;a++){t=parseInt(e.TASKS[a].ID);if(isNaN(t)){continue}i[t]=true;if(typeof this.vars.state[t]=="undefined"){this.vars.state[t]={timer:false,plan:false}}this.vars.state[t].plan=true}for(a in this.vars.state){if(typeof i[a]=="undefined"){this.fireEvent("task-plan-toggle",[a,false]);this.vars.state[a].plan=false}}t=parseInt(e.TASK_ON_TIMER.ID);if(!isNaN(t)){if(typeof this.vars.state[t]=="undefined"){this.vars.state[t]={timer:false,plan:false}}for(a in this.vars.state){if(this.vars.state[a].timer&&a!=t){this.fireEvent("task-timer-toggle",[false,a])}this.vars.state[a].timer=false}this.vars.state[t].timer=true}},updatePlanner:function(){if(!this.hasPlanner()){return false}var e=true;if(window.BXTIMEMAN)window.BXTIMEMAN.Update(true);else if(window.BXPLANNER&&window.BXPLANNER.update)window.BXPLANNER.update();else e=false;if(window.top!==window){if(window.top.BXTIMEMAN)window.top.BXTIMEMAN.Update(true);else if(window.top.BXPLANNER&&window.top.BXPLANNER.update)window.top.BXPLANNER.update()}return e},hasPlanner:function(){return!!(window.top.BXPLANNER||window.top.BXTIMEMAN)},onTimerUpdate:function(e){e=e||{};e.taskData=e.taskData||{};if(e.action=="refresh_daemon_event"){var t=parseInt(e.data.TASK.TIME_SPENT_IN_LOGS);if(isNaN(t)){t=0}var a=parseInt(e.data.TIMER.RUN_TIME);if(isNaN(a)){a=0}this.fireEvent("task-timer-tick",[e.taskId,t+a,e.data.TASK])}else if(e.action=="stop_timer"){e.taskData.TIMER_IS_RUNNING_FOR_CURRENT_USER=false;this.fireEvent("task-timer-toggle",[e.taskId,false,e.taskData])}else if(e.action=="start_timer"){e.taskData.TIMER_IS_RUNNING_FOR_CURRENT_USER=true;this.fireEvent("task-timer-toggle",[e.taskId,true,e.taskData])}},onTaskGlobalEvent:function(e,t){if(e=="UPDATE"&&typeof t.task!="undefined"&&t.task.ID){this.vars.taskData[t.task.ID]=BX.clone(t.task);this.setTaskTimeOffset(t.task.ID,t.task.TIME_ELAPSED)}},setTaskTimeOffset:function(e,t){this.vars.timeOffsets[e]={inLog:parseInt(t),current:0}},timerTickEmulation:function(){var e=this.vars.taskData;for(var t in e){var a=e[t];if(a.ID&&a.TIMER_IS_RUNNING_FOR_CURRENT_USER){if(typeof this.vars.timeOffsets[a.ID]=="undefined"){this.setTaskTimeOffset(a.ID,a.TIME_ELAPSED)}var i=this.vars.timeOffsets[a.ID];this.fireEvent("task-timer-tick",[a.ID,i.inLog+i.current,a]);i.current++}}},addToPlan:function(e){if(BX.addTaskToPlanner){BX.addTaskToPlanner(e);return true}else if(window.top.BX.addTaskToPlanner){window.top.BX.addTaskToPlanner(e);return true}return false},startTimer:function(e,t,a){if(!e){return}if(t){this.getQuery().add("task.dayplan.timer.start",{taskId:e,stopPrevious:a||false},{},BX.delegate(function(t){var a=t.getByCode("OTHER_TASK_ON_TIMER");if(a){var i=a.data();var s=[e,[]];if(i.TASK&&i.TASK.TITLE&&i.TASK.ID){s[1]={id:i.TASK.ID,title:i.TASK.TITLE}}this.fireEvent("other-task-on-timer",s);t.deleteByCodeAll("OTHER_TASK_ON_TIMER")}else{this.fireEvent("task-timer-toggle",[e,true])}},this))}else{this.fireEvent("task-timer-toggle",[e,true])}},stopTimer:function(e,t){if(!e){return}if(t){this.getQuery().add("task.dayplan.timer.stop",{taskId:e},{},BX.delegate(function(){this.fireEvent("task-timer-toggle",[e,false])},this))}else{this.fireEvent("task-timer-toggle",[e,false])}},getQuery:function(){if(typeof this.query=="undefined"){if(this.option("query")){this.query=this.option("query")}else{this.query=new BX.Tasks.Util.Query({autoExec:true})}}return this.query}}});