BX.namespace("BX.Tasks.Integration");(function(){BX.Tasks.Integration.Socialnetwork={};var t=false;var e=false;var i=false;BX.Tasks.Integration.Socialnetwork.NetworkSelector=BX.Tasks.Util.Widget.extend({sys:{code:"network-selector"},options:{mode:"user",query:false,useSearch:false,useAdd:false,popupOffsetTop:0,popupOffsetLeft:0,syncLast:true,lastSelectedContext:"TASKS"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);if(!("SocNetLogDestination"in BX)){throw new ReferenceError("No BX.SocNetLogDestination detected. Forgot to include socialnetwork module and/or its assets?")}this.vars.snldId=false;this.vars.intendSearch="";this.vars.last={};this.vars.intendOpen=false;this.vars.changed=false},initialize:function(){if(this.dialogInitialized()){this.fireInitEvent()}else{if(t===false){this.fetchDestinationData()}else{this.initializeDialog()}}},dialogInitialized:function(){return this.vars.snldId!==false},open:function(){if(!this.dialogInitialized()){this.vars.intendOpen=true;this.initialize()}else if(this.vars.snldId!=i){this.vars.intendOpen=false;if(i!=false){BX.SocNetLogDestination.openDialog(this.vars.snldId)}BX.SocNetLogDestination.openDialog(this.vars.snldId);i=this.vars.snldId}},close:function(){this.vars.intendOpen=false;if(this.vars.snldId==i){BX.SocNetLogDestination.closeDialog()}},addLast:function(t){this.vars.changed=true;this.vars.last[t.id]={id:t.entityId,type:this.getEntityType(t)}},deleteLast:function(t){this.vars.changed=true;delete this.vars.last[t.id]},updateLast:function(){if(!this.option("syncLast")){return}if(!this.vars.changed){return}var t=this.vars.last;this.vars.last={};var e={};var i=0;for(var s in t){if(t.hasOwnProperty(s)){if(typeof e[t[s].type]=="undefined"){e[t[s].type]=[]}e[t[s].type].push(t[s].id);i++}}if(i>0){this.getQuery().add("integration.socialnetwork.setdestinationlast",{items:e,context:this.option("lastSelectedContext")})}this.vars.changed=false},fetchDestinationData:function(){if(!e){e=true;this.getQuery().add("integration.socialnetwork.getdestinationdata",{context:this.option("lastSelectedContext")},{code:"get_destination_data"}).execute()}},getQuery:function(){if(typeof this.instances.query=="undefined"){if(this.option("query")){this.instances.query=this.option("query")}else{this.instances.query=new BX.Tasks.Util.Query({autoExec:true})}this.instances.query.bindEvent("executed",BX.delegate(this.onQueryExecuted,this))}return this.instances.query},onQueryExecuted:function(i){e=false;if(i.success){if(typeof i.data!="undefined"&&typeof i.data["get_destination_data"]!="undefined"){if(i.data["get_destination_data"].SUCCESS){t=i.data["get_destination_data"].RESULT;this.initializeDialog()}}}},onSelectDestination:function(t){this.addLast(t);t.params=t.params||{};var e={extranet:t.isExtranet=="Y",crmemail:t.isCrmEmail=="Y",email:t.isEmail=="Y",network:t.isNetwork=="Y"};this.fireEvent("item-selected",[{id:t.entityId,entityType:this.getEntityType(t),networkId:e.network&&t.networkId?t.networkId:"",nameFormatted:t.name||"",description:t.desc||"",avatar:t.avatar||"",name:t.params.name||"",lastName:t.params.lastName||"",email:t.email||"",type:e}])},getEntityType:function(t){var e="U";if(t.isEmail){return e}if(!t.id){return e}var i=t.id.toString().trim().match(/^[a-z]+/i);if(i&&i[0]){e=i[0]}return e},onUnSelectDestination:function(t){this.deleteLast(t);this.fireEvent("item-deselected",[{id:t.entityId,entityType:this.getEntityType(t),name:t.name}])},onOpenDialogDestination:function(t){i=t},onCloseDialogDestination:function(t){if(t==i){this.fireEvent("close");this.updateLast()}i=false},onOpenSearchDestination:function(t){i=t},onCloseSearchDestination:function(t){if(t==i){this.fireEvent("close");this.updateLast()}i=false},onOpenEmailDestination:function(t){i=t},onCloseEmailDestination:function(t){if(t==i){this.fireEvent("close");this.updateLast()}i=false},checkIsOpened:function(){return i==this.vars.snldId},deselectItem:function(t){if(this.vars.snldId!=false){var e=this.option("mode")=="user";BX.SocNetLogDestination.deleteItem(this.checkEntityId(t),e?"users":"groups",this.vars.snldId)}},selectItem:function(t){if(this.vars.snldId!=false){var e=this.option("mode")=="user";BX.SocNetLogDestination.selectItem(this.vars.snldId,null,null,this.checkEntityId(t),e?"users":"groups")}},checkEntityId:function(t){if(typeof t=="undefined"||t===null){return""}t=t.toString();if(t.substring(0,1)=="U"||t.substring(0,2)=="SG"){return t}var e=this.option("mode")=="user";return(e?"U":"SG")+t},initializeDialog:function(){if(this.vars.snldId==false){this.vars.snldId=BX.util.hashCode(Math.random().toString());var e=this.scope();var i="name-"+this.id();var s=this.control("search");if(s){BX.adjust(s,{attrs:{input:i,id:i}})}var n=this.option("mode")=="all";var a=this.option("mode")=="user";var o=this.option("mode")=="group";var r={name:this.vars.snldId,searchInput:s||null,bindMainPopup:{node:e,offsetTop:parseInt(this.option("popupOffsetTop"))+"px",offsetLeft:parseInt(this.option("popupOffsetLeft"))+"px"},bindSearchPopup:{node:e,offsetTop:parseInt(this.option("popupOffsetTop"))+"px",offsetLeft:parseInt(this.option("popupOffsetLeft"))+"px"},sendAjaxSearch:a||n||o&&(typeof t.SONETGROUPS_LIMITED!="undefined"&&t.SONETGROUPS_LIMITED=="Y"),useClientDatabase:!o,allowUserSearch:!o,allowSonetGroupsAjaxSearch:typeof t.SONETGROUPS_LIMITED!="undefined"&&t.SONETGROUPS_LIMITED=="Y",enableProjects:o,departmentSelectDisable:!n,allowAddUser:t.CAN_ADD_MAIL_USERS,allowAddSocNetGroup:false,callback:{select:BX.proxy(this.onSelectDestination,this),unSelect:BX.proxy(this.onUnSelectDestination,this),openDialog:BX.proxy(this.onOpenDialogDestination,this),closeDialog:BX.proxy(this.onCloseDialogDestination,this),openSearch:BX.proxy(this.onOpenSearchDestination,this),closeSearch:BX.proxy(this.onCloseSearchDestination,this),openEmailAdd:BX.proxy(this.onOpenEmailDestination,this),closeEmailAdd:BX.proxy(this.onCloseEmailDestination,this)}};if(this.option("useSearch")){r.showSearchInput=true}if(this.option("forceTop")){r.bindOptions={position:"top",forceTop:true}}r.items={users:a||n?t.USERS||{}:{},emails:a||n?t.EMAILS||{}:{},groups:{},department:a||n?t.DEPARTMENT||{}:{},departmentRelation:a||n?t.DEPARTMENT_RELATION||{}:{},sonetgroups:o||n?t.SONETGROUPS||{}:{},projects:o||n?t.PROJECTS||{}:{}};r.itemsLast={users:a||n?t.LAST.USERS||{}:{},emails:a||n?t.LAST.EMAILS||{}:{},groups:{},department:n?t.LAST.DEPARTMENT:{},sonetgroups:o||n?t.LAST.SONETGROUPS||{}:{},projects:o||n?t.LAST.PROJECTS||{}:{}};r.itemsSelected=t.SELECTED||{};r.allowSearchNetworkUsers=t.NETWORK_ENABLED;r.showVacations=t.SHOW_VACATIONS;r.usersVacation=t.USERS_VACATION||{};if(o){r.allowSearchEmailUsers=false}BX.SocNetLogDestination.init(r);if(s){var d={formName:this.vars.snldId,inputName:"name-"+this.id(),sendAjax:a||o&&(typeof t.SONETGROUPS_LIMITED!="undefined"&&t.SONETGROUPS_LIMITED=="Y")};var l=BX.clone(d);l.onPasteEvent=true;BX.bind(s,"keyup",BX.proxy(BX.SocNetLogDestination.BXfpSearch,d));BX.bind(s,"keydown",BX.proxy(BX.SocNetLogDestination.BXfpSearchBefore,d));BX.bind(s,"paste",BX.defer(BX.SocNetLogDestination.BXfpSearch,l));BX.bind(s,"click",BX.delegate(this.open,this))}}this.fireInitEvent();if(this.vars.intendOpen){this.open()}},fireInitEvent:function(){this.fireEvent("initialized")},clearDataCache:function(){t=false}}})})();