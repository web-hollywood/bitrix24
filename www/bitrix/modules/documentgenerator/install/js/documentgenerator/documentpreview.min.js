(function(){"use strict";BX.namespace("BX.DocumentGenerator");if(typeof BX.DocumentGenerator.DocumentPreview!=="undefined"){return}var e=false;BX.DocumentGenerator.DocumentPreview=function(e){this.loader=null;this.documentId=null;this.pullTag=null;this.startImageUrl=null;this.imageUrl=null;this.imageContainer=null;this.imageNode=null;this.printUrl=null;this.pdfUrl=null;this.isTransformationError=false;this.transformationErrorNode=null;this.previewNode=null;this.onReady=BX.DoNothing;this.applyOptions(e);this.initPushEvent();this.start()};BX.DocumentGenerator.DocumentPreview.prototype={};BX.DocumentGenerator.DocumentPreview.prototype.isPullConnected=function(){if(top.BX.PULL){if(BX.type.isFunction(top.BX.PULL.isConnected)){return top.BX.PULL.isConnected()}else{var e=top.BX.PULL.getDebugInfoArray();return e.connected}}return false};BX.DocumentGenerator.DocumentPreview.prototype.initPushEvent=function(){if(!e){if(this.isPullConnected()){e=true;top.BX.addCustomEvent("onPullEvent-documentgenerator",BX.proxy(this.showImage,this))}else if(this.documentId>0&&!this.imageUrl){e=true;setTimeout(BX.proxy(function(){BX.ajax.runAction("documentgenerator.api.document.get",{data:{documentId:this.documentId}}).then(BX.proxy(function(t){e=false;if(t.data.document.imageUrl){this.showImage("showImage",t.data.document)}else{this.initPushEvent()}},this),function(){e=false})},this),5e3)}}};BX.DocumentGenerator.DocumentPreview.prototype.applyOptions=function(e){if(e.id){this.documentId=e.id}if(e.pullTag){this.pullTag=e.pullTag}if(e.imageUrl){this.imageUrl=e.imageUrl}if(e.startImageUrl){this.startImageUrl=e.startImageUrl}if(e.printUrl){this.printUrl=e.printUrl}if(e.pdfUrl){this.pdfUrl=e.pdfUrl}if(e.emailDiskFile){this.emailDiskFile=e.emailDiskFile}if(BX.type.isDomNode(e.imageContainer)){this.imageContainer=e.imageContainer}if(BX.type.isDomNode(e.previewNode)){this.previewNode=e.previewNode}if(BX.type.isDomNode(e.transformationErrorNode)){this.transformationErrorNode=e.transformationErrorNode}if(BX.type.isBoolean(e.isTransformationError)){this.isTransformationError=e.isTransformationError}if(BX.type.isFunction(e.onReady)){this.onReady=e.onReady}this.initPushEvent()};BX.DocumentGenerator.DocumentPreview.prototype.getLoader=function(){if(!this.loader){this.loader=new BX.Loader({size:100,offset:{left:"-8%",top:"6%"}})}return this.loader};BX.DocumentGenerator.DocumentPreview.prototype.showLoader=function(){if(this.imageContainer){if(!this.getLoader().isShown()){this.getLoader().show(this.imageContainer)}}if(BX.type.isDomNode(this.imageNode)){this.imageNode.style.opacity=.5}};BX.DocumentGenerator.DocumentPreview.prototype.hideLoader=function(){if(this.getLoader().isShown()){this.getLoader().hide()}if(BX.type.isDomNode(this.imageNode)){this.imageNode.style.opacity=1}};BX.DocumentGenerator.DocumentPreview.prototype.isValidPullTag=function(e,t){return e==="showImage"&&t["pullTag"]===this.pullTag};BX.DocumentGenerator.DocumentPreview.prototype.showImage=function(e,t){if(this.isValidPullTag(e,t)){this.applyOptions(t);if(BX.type.isDomNode(this.previewNode)){BX.hide(this.previewNode)}if(BX.type.isDomNode(this.transformationErrorNode)){if(this.isTransformationError){BX.show(this.transformationErrorNode)}else{BX.hide(this.transformationErrorNode)}}this.showImageNode();this.onReady(t);this.hideLoader()}};BX.DocumentGenerator.DocumentPreview.prototype.start=function(){if(this.imageUrl){this.showImageNode()}else if(this.startImageUrl){this.imageUrl=this.startImageUrl;this.startImageUrl=null;this.showImageNode();if(BX.type.isDomNode(this.imageNode)){this.imageNode.style.opacity=.2}if(this.pullTag){this.showLoader()}}else if(!this.isTransformationError&&!this.previewNode){this.showLoader()}};BX.DocumentGenerator.DocumentPreview.prototype.showImageNode=function(){if(!BX.type.isDomNode(this.imageContainer)){return}if(!BX.type.isDomNode(this.imageNode)){this.imageNode=BX.create("img",{style:{opacity:.1,display:"none"}});BX.append(this.imageNode,this.imageContainer)}if(this.imageUrl){this.imageNode.src=this.imageUrl;BX.show(this.imageNode);this.imageNode.style.opacity=1}};BX.DocumentGenerator.Document={isProcessing:false};BX.DocumentGenerator.Document.onBeforeCreate=function(e,t,o){if(BX.type.isNotEmptyObject(t)&&t.hasOwnProperty("checkNumber")&&t.checkNumber){var i=BX.DocumentGenerator.parseUrl(e,"params");if(!i.hasOwnProperty("documentId")){if(BX.DocumentGenerator.Document.isProcessing===true){return}BX.DocumentGenerator.Document.isProcessing=true;var n=decodeURIComponent(i.providerClassName).toLowerCase().replace(/\\/g,"\\\\");BX.ajax.runAction("documentgenerator.api.document.list",{data:{select:["id","number"],filter:{provider:n,templateId:i.templateId,value:i.value},order:{id:"desc"}},navigation:{size:1}}).then(function(t){BX.DocumentGenerator.Document.isProcessing=false;if(t.data.documents.length>0){var i=t.data.documents[0].number;BX.DocumentGenerator.showMessage(BX.message("DOCGEN_POPUP_USE_OLD_NUMBER"),[new BX.PopupWindowButton({text:BX.message("DOCGEN_POPUP_NEW_BUTTON"),className:"ui-btn ui-btn-md ui-btn-primary",events:{click:function(){BX.DocumentGenerator.openUrl(e,o);this.popupWindow.close()}}}),new BX.PopupWindowButton({text:BX.message("DOCGEN_POPUP_OLD_BUTTON"),className:"ui-btn ui-btn-md ui-btn-primary",events:{click:function(){e=BX.util.add_url_param(e,{number:i});BX.DocumentGenerator.openUrl(e,o);this.popupWindow.close()}}})],BX.message("DOCGEN_POPUP_NUMBER_TITLE"))}else{BX.DocumentGenerator.openUrl(e,o)}}).then(function(){BX.DocumentGenerator.Document.isProcessing=false;BX.DocumentGenerator.openUrl(e,o)})}}else{BX.DocumentGenerator.openUrl(e,o)}};BX.DocumentGenerator.Feedback={open:function(e,t,o){var i="/bitrix/components/bitrix/documentgenerator.feedback/slider.php";i=BX.util.add_url_param(i,{provider:e||"",templateName:t||"",templateCode:o||""});if(BX.SidePanel){BX.SidePanel.Instance.open(i,{width:735})}else{location.href=i}}};BX.DocumentGenerator.parseUrl=function(e,t){var o=document.createElement("a"),i={},n,r,a;o.href=e;n=o.search.replace(/^\?/,"").split("&");for(a=0;a<n.length;a++){r=n[a].split("=");i[r[0]]=r[1]}var s={protocol:o.protocol,host:o.host,hostname:o.hostname,port:o.port,pathname:o.pathname,search:o.search,params:i,hash:o.hash};if(t&&s.hasOwnProperty(t)){return s[t]}return s};BX.DocumentGenerator.openUrl=function(e,t,o){if(BX.SidePanel){if(!BX.type.isNumber(o)){o=980}BX.SidePanel.Instance.open(e,{width:o,cacheable:false,loader:t});var i=BX.PopupMenu.getCurrentMenu();if(i&&i.popupWindow){i.popupWindow.close()}}else{location.href=e}};BX.DocumentGenerator.showMessage=function(e,t,o){o=o||"";if(typeof t==="undefined"||typeof t==="object"&&t.length<=0){t=[new BX.PopupWindowButton({text:BX.message("DOCGEN_POPUP_CLOSE_BUTTON"),className:"ui-btn ui-btn-md ui-btn-default",events:{click:function(e){this.popupWindow.close();BX.PreventDefault(e)}}})]}if(this.popupConfirm!=null){this.popupConfirm.destroy()}this.popupConfirm=new BX.PopupWindow("bx-popup-documentgenerator-popup",null,{zIndex:200,autoHide:true,closeByEsc:true,buttons:t,closeIcon:true,overlay:true,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupConfirm=null},this)},content:BX.create("span",{attrs:{className:"bx-popup-documentgenerator-popup-content-text"},children:e}),titleBar:o,contentColor:"white",className:"bx-popup-documentgenerator-popup",maxWidth:470});this.popupConfirm.show()}})(window);