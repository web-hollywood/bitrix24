BX.namespace("BX.Crm");if(typeof BX.Crm.BatchConversionManager==="undefined"){BX.Crm.BatchConversionManager=function(){this._id="";this._settings={};this._gridId="";this._config=null;this._entityIds=null;this._serviceUrl="";this._containerId="";this._errors=null;this._progress=null;this._hasLayout=false;this._succeededItemCount=0;this._failedItemCount=0;this._isRunning=false;this._progressChangeHandler=BX.delegate(this.onProgress,this);this._documentUnloadHandler=BX.delegate(this.onDocumentUnload,this)};BX.Crm.BatchConversionManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_batch_conversion_mgr_"+Math.random().toString().substring(2);this._settings=e?e:{};this._gridId=BX.prop.getString(this._settings,"gridId",this._id);this._config=BX.prop.getObject(this._settings,"config",{});this._entityIds=BX.prop.getArray(this._settings,"entityIds",[]);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");if(this._serviceUrl===""){throw"BX.Crm.BatchConversionManager. Could not find 'serviceUrl' parameter in settings."}this._containerId=BX.prop.getString(this._settings,"container","");if(this._containerId===""){throw"BX.Crm.BatchConversionManager: Could not find container."}this._progress=BX.AutorunProcessManager.create(this._id,{serviceUrl:this._serviceUrl,actionName:"PROCESS_BATCH_CONVERSION",container:this._containerId,enableCancellation:true,title:BX.prop.getString(this._settings,"title",this.getMessage("title")),stateTemplate:BX.prop.getString(this._settings,"stateTemplate",this.getMessage("stateTemplate")),enableLayout:false});this._errors=[]},getId:function(){return this._id},getConfig:function(){return this._config},setConfig:function(t){this._config=BX.type.isPlainObject(t)?t:{}},getEntityIds:function(){return this._entityIds},setEntityIds:function(t){this._entityIds=BX.type.isArray(t)?t:[]},getMessage:function(t){var e=BX.Crm.BatchConversionManager.messages;return e.hasOwnProperty(t)?e[t]:t},layout:function(){if(this._hasLayout){return}this._progress.layout();this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}this._progress.clearLayout();this._hasLayout=false},getState:function(){return this._progress.getState()},getProcessedItemCount:function(){return this._progress.getProcessedItemCount()},getTotalItemCount:function(){return this._progress.getTotalItemCount()},execute:function(){var t={ACTION:"PREPARE_BATCH_CONVERSION",PARAMS:{GRID_ID:this._gridId,CONFIG:this._config,IDS:this._entityIds}};BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:t,onsuccess:BX.delegate(this.onPrepare,this)})},onPrepare:function(t){var e=t["DATA"];var s=BX.prop.getString(e,"STATUS","");this._config=BX.prop.getObject(e,"CONFIG",{});if(s==="ERROR"){var r=BX.prop.getArray(e,"ERRORS",[]);var i=BX.Crm.NotificationDialog.create("batch_conversion_error",{title:this.getMessage("title"),content:r.join("<br/>")});i.open();return}if(s==="REQUIRES_SYNCHRONIZATION"){var n=BX.CrmLeadConverter.getCurrent().createSynchronizationEditor(this._id,this._config,BX.prop.getArray(e,"FIELD_NAMES",[]));n.addClosingListener(BX.delegate(this.onSynchronizationEditorClose,this));n.show();return}this.layout();this.run()},run:function(){if(this._isRunning){return}this._isRunning=true;this._progress.setParams({GRID_ID:this._gridId,CONFIG:this._config});this._progress.run();BX.addCustomEvent(this._progress,"ON_AUTORUN_PROCESS_STATE_CHANGE",this._progressChangeHandler);BX.bind(window,"beforeunload",this._documentUnloadHandler)},stop:function(){if(!this._isRunning){return}this._isRunning=false;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"STOP_BATCH_CONVERSION",PARAMS:{GRID_ID:this._gridId}},onsuccess:function(t){this.reset()}.bind(this)})},reset:function(){this._progress.reset();BX.removeCustomEvent(this._progress,"ON_AUTORUN_PROCESS_STATE_CHANGE",this._progressChangeHandler);BX.unbind(window,"beforeunload",this._documentUnloadHandler);if(this._succeededItemCount>0||this._failedItemCount>0){BX.Main.gridManager.reload(this._gridId)}this._succeededItemCount=this._failedItemCount=0;this._isRunning=false;if(this._hasLayout){window.setTimeout(BX.delegate(this.clearLayout,this),0)}this._errors=[]},getSucceededItemCount:function(){return this._succeededItemCount},getFailedItemCount:function(){return this._failedItemCount},getErrors:function(){return this._errors},onDocumentUnload:function(t){return t.returnValue=this.getMessage("windowCloseConfirm")},onSynchronizationEditorClose:function(t,e){if(BX.prop.getBoolean(e,"isCanceled",false)){this.clearLayout();return}this._config=t.getConfig();this.run()},onProgress:function(t){var e=this._progress.getState();if(e===BX.AutoRunProcessState.stopped){this.stop();return}var s=this._progress.getError();if(s===""){this._succeededItemCount++}else{var r={message:s};var i=this._progress.getErrorExtras();if(i){r["info"]=BX.prop.getObject(i,"INFO",null)}this._errors.push(r);this._failedItemCount++}if(e===BX.AutoRunProcessState.completed){BX.Crm.BatchConversionPanel.create(this._id,{container:this._containerId,manager:this}).layout();this.reset()}}};if(typeof BX.Crm.BatchConversionManager.messages==="undefined"){BX.Crm.BatchConversionManager.messages={}}BX.Crm.BatchConversionManager.items={};BX.Crm.BatchConversionManager.getItem=function(t){return BX.prop.get(this.items,t,null)};BX.Crm.BatchConversionManager.create=function(t,e){var s=new BX.Crm.BatchConversionManager;s.initialize(t,e);this.items[s.getId()]=s;return s}}if(typeof BX.Crm.BatchConversionPanel==="undefined"){BX.Crm.BatchConversionPanel=function(){this._id="";this._settings={};this._manager=null;this._container=null;this._wrapper=null};BX.Crm.BatchConversionPanel.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._container=BX(BX.prop.getString(this._settings,"container"));if(!BX.type.isElementNode(this._container)){throw"BatchConversionPanel: Could not find container."}this._manager=BX.prop.get(this._settings,"manager")},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.BatchConversionPanel.messages,t,t)},layout:function(){if(this._hasLayout){return}this._wrapper=BX.create("DIV",{attrs:{className:"crm-view-progress"}});BX.addClass(this._wrapper,this._isHidden?"crm-view-progress-hide":"crm-view-progress-show");BX.addClass(this._wrapper,"crm-view-progress-row-hidden");this._container.appendChild(this._wrapper);var t=[BX.create("span",{text:this.getMessage("summaryCaption")})];var e=this._manager.getSucceededItemCount();if(e>0){t.push(BX.create("span",{attrs:{className:"crm-view-progress-text"},text:this.getMessage("summarySucceeded").replace(/#number_leads#/gi,e)}))}var s=this._manager.getFailedItemCount();if(s>0){t.push(BX.create("span",{attrs:{className:"crm-view-progress-link crm-view-progress-text-button"},text:this.getMessage("summaryFailed").replace(/#number_leads#/gi,s),events:{click:BX.delegate(this.onToggleErrorButtonClick,this)}}))}var r=[];r.push(BX.create("DIV",{attrs:{className:"crm-view-progress-info"},children:t}));r.push(BX.create("a",{attrs:{className:"crm-view-progress-link",href:"#"},text:BX.message("JS_CORE_WINDOW_CLOSE"),events:{click:BX.delegate(this.onCloseButtonClick,this)}}));this._wrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-view-progress-row"},children:r}));var i=this._manager.getErrors();for(var n=0,a=i.length;n<a;n++){var o=i[n];var h=[];var c=BX.prop.getObject(o,"info",null);if(c){var g=BX.prop.getString(c,"TITLE","");var u=BX.prop.getString(c,"SHOW_URL","");if(g!==""&&u!==""){h.push(BX.create("a",{props:{className:"crm-view-progress-link",href:u,target:"_blank"},text:g+":"}))}}h.push(BX.create("span",{attrs:{className:"crm-view-progress-text"},text:o["message"]}));this._wrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-view-progress-row"},children:[BX.create("DIV",{attrs:{className:"crm-view-progress-info"},children:h})]}))}this._hasLayout=true},hasLayout:function(){return this._hasLayout},isHidden:function(){return this._isHidden},show:function(){if(!this._isHidden){return}if(!this._hasLayout){return}BX.removeClass(this._wrapper,"crm-view-progress-hide");BX.addClass(this._wrapper,"crm-view-progress-show");this._isHidden=false},hide:function(){if(this._isHidden){return}if(!this._hasLayout){return}BX.removeClass(this._wrapper,"crm-view-progress-show");BX.addClass(this._wrapper,"crm-view-progress-hide");this._isHidden=true},clearLayout:function(){if(!this._hasLayout){return}BX.remove(this._wrapper);this._wrapper=null;this._hasLayout=false},onCloseButtonClick:function(t){this.clearLayout();return BX.eventReturnFalse(t)},onToggleErrorButtonClick:function(){BX.toggleClass(this._wrapper,"crm-view-progress-row-hidden")}};if(typeof BX.Crm.BatchConversionPanel.messages==="undefined"){BX.Crm.BatchConversionPanel.messages={}}BX.Crm.BatchConversionPanel.create=function(t,e){var s=new BX.Crm.BatchConversionPanel;s.initialize(t,e);return s}}