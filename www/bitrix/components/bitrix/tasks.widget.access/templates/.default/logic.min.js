"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetRights!="undefined"){return}BX.Tasks.Component.TasksWidgetAccess=BX.Tasks.Component.extend({sys:{code:"rights"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);var e=null;BX.Tasks.each(this.option("levels"),function(t){e=t;return false});this.vars.firstLevel=e;this.vars.addedUsersIds=[];this.getManager()},getManager:function(){return this.subInstance("items",function(){return new this.constructor.ItemManager({scope:this.scope(),preRendered:true,data:this.option("data"),parent:this})})}}});BX.Tasks.Component.TasksWidgetAccess.ItemManager=BX.Tasks.Util.ItemSet.extend({sys:{code:"rights-is"},options:{controlBind:"class",useSmartCodeNaming:true},methods:{bindItemActions:function(){this.callMethod(BX.Tasks.Util.ItemSet,"bindItemActions");this.bindOnItemEx("i-operation-title","click",this.onItemOperationClick.bind(this))},onItemOperationClick:function(e,t){var s=[];BX.Tasks.each(this.optionP("levels"),function(t){s.push({enabled:true,text:t.TITLE,onclick:this.passCtx(this.doMenuAction),itemRef:e,levelId:t.ID,levelTitle:t.TITLE})}.bind(this));BX.PopupMenu.show(this.id()+"-op-popup-"+e.value(),t,s,{angle:true,position:"right",offsetLeft:40,offsetTop:0})},doMenuAction:function(e,t,s){e.popupWindow.close();this.setItemOperation(s.itemRef,s.levelId,s.levelTitle)},setItemOperation:function(e,t,s){e.data().TASK_ID=t;e.control("operation-title").innerHTML=s;e.control("operation").value=t},extractItemValue:function(e){if("VALUE"in e){return e.VALUE}e.VALUE=this.getRandomHash();return e.VALUE},prepareData:function(e){var t=this.parent().vars.firstLevel;this.setField("ID",e,"");this.setField("TITLE",e,t.TITLE);this.setField("TASK_ID",e,t.ID);this.setField("MEMBER_ID",e,e.id);this.setField("DISPLAY",e,function(e){if("nameFormatted"in e){return BX.util.htmlspecialcharsback(e.nameFormatted)}var t=this.option("nameTemplate");if(t){var s=BX.formatName(e,t,"Y");if(s=="Noname"){s=e.LOGIN||e.login}return s}return e.LOGIN});e.ITEM_SET_INVISIBLE="";return e},openAddForm:function(){this.getSelector().open()},getSelector:function(){return this.subInstance("socnet",function(){var e=new BX.Tasks.Integration.Socialnetwork.NetworkSelector({scope:this.control("open-form"),id:this.id()+"socnet-sel",mode:"user",query:this.parent().getQuery(),useSearch:true,useAdd:false,controlBind:this.option("controlBind"),parent:this,popupOffsetTop:5,popupOffsetLeft:40,lastSelectedContext:"TASKS_RIGHTS"});e.bindEvent("item-selected",this.onSelectorItemSelected.bind(this));return e})},addItem:function(e){var t=e.MEMBER_ID.toString();if(!this.isUserAdded(t)){this.callMethod(BX.Tasks.Util.ItemSet,"addItem",arguments);this.addToAddedUsers(t)}},deleteItem:function(e){var t=this.getItem(e.value());var s=t.opts.data.MEMBER_ID.toString();this.callMethod(BX.Tasks.Util.ItemSet,"deleteItem",arguments);this.deleteFromAddedUsers(s)},onSelectorItemSelected:function(e){e.MEMBER_ID=e.id;delete e.id;this.addItem(e);this.getSelector().close();this.getSelector().deselectItem(e.MEMBER_ID)},isUserAdded:function(e){return this.parent().vars.addedUsersIds.includes(e)},addToAddedUsers:function(e){this.parent().vars.addedUsersIds.push(e)},deleteFromAddedUsers:function(e){var t=this.parent().vars.addedUsersIds.indexOf(e);this.parent().vars.addedUsersIds.splice(t,1)}}})}).call(this);