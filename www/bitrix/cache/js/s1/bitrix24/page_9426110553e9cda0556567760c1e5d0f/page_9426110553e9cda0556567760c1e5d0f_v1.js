
; /* Start:"a:4:{s:4:"full";s:97:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?154412738440309";s:6:"source";s:77:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Main");if(typeof BX.Main.interfaceButtons==="undefined"){BX.Main.interfaceButtons=function(t,e){this.classItem="main-buttons-item";this.classItemSublink="main-buttons-item-sublink";this.classItemText="main-buttons-item-text";this.classItemCounter="main-buttons-item-counter";this.classItemIcon="main-buttons-item-icon";this.classItemMore="main-buttons-item-more";this.classOnDrag="main-buttons-drag";this.classDropzone="main-buttons-submenu-dropzone";this.classSeporator="main-buttons-submenu-separator";this.classHiddenLabel="main-buttons-hidden-label";this.classSubmenuItem="main-buttons-submenu-item";this.classItemDisabled="main-buttons-disabled";this.classItemOver="over";this.classItemActive="main-buttons-item-active";this.classSubmenu="main-buttons-submenu";this.classSecret="secret";this.classItemLocked="locked";this.submenuIdPrefix="main_buttons_popup_";this.childMenuIdPrefix="main_buttons_popup_child_";this.submenuWindowIdPrefix="menu-popup-";this.classSettingMenuItem="main-buttons-submenu-setting";this.classEditState="main-buttons-edit";this.classEditItemButton="main-buttons-item-edit-button";this.classDragItemButton="main-buttons-item-drag-button";this.classSettingsApplyButton="main-buttons-submenu-settings-apply";this.classSettingsResetButton="main-buttons-submenu-settings-reset";this.classSetHome="main-buttons-set-home";this.classSetHide="main-buttons-set-hide";this.classManage="main-buttons-manage";this.classContainer="main-buttons";this.classSubmenuNoHiddenItem="main-buttons-submenu-item-no-hidden";this.classDefaultSubmenuItem="menu-popup-item";this.classInner="main-buttons-inner-container";this.listContainer=null;this.pinContainer=null;this.dragItem=null;this.overItem=null;this.moreButton=null;this.messages=null;this.licenseParams=null;this.isSubmenuShown=false;this.isSubmenuShownOnDragStart=false;this.isSettingsEnabled=true;this.containerId=e.containerId;this.tmp={};this.init(t,e);return{getItemById:BX.delegate(this.getItemById,this),getAllItems:BX.delegate(this.getAllItems,this),getHiddenItems:BX.delegate(this.getHiddenItems,this),getVisibleItems:BX.delegate(this.getVisibleItems,this),getDisabledItems:BX.delegate(this.getDisabledItems,this),getMoreButton:BX.delegate(this.getMoreButton,this),adjustMoreButtonPosition:BX.delegate(this.adjustMoreButtonPosition,this),showSubmenu:BX.delegate(this.showSubmenu,this),closeSubmenu:BX.delegate(this.closeSubmenu,this),refreshSubmenu:BX.delegate(this.refreshSubmenu,this),getCurrentSettings:BX.delegate(this.getCurrentSettings,this),saveSettings:BX.delegate(this.saveSettings,this),setCounterValueByItemId:BX.delegate(this.setCounterValueByItemId,this),getCounterValueByItemId:BX.delegate(this.getCounterValueByItemId,this),updateCounter:BX.delegate(this.updateCounter,this),getActive:BX.delegate(this.getActive,this),isEditEnabled:BX.delegate(this.isEditEnabled,this),isActiveInMoreMenu:BX.delegate(this.isActiveInMoreMenu,this),isSettingsEnabled:this.isSettingsEnabled,classes:{item:this.classItem,itemText:this.classItemText,itemCounter:this.classItemCounter,itemIcon:this.classItemIcon,itemDisabled:this.classItemDisabled,itemOver:this.classItemOver,itemActive:this.classItemActive,itemLocked:this.classItemLocked,submenu:this.classSubmenu,submenuItem:this.classSubmenuItem,containerOnDrag:this.classOnDrag,classSettingMenuItem:this.classSettingMenuItem},itemsContainer:this.listContainer,itemsContainerId:this.listContainer.id}};BX.Main.interfaceButtons.prototype={init:function(t,e){this.listContainer=BX(this.getId());if(!BX.type.isPlainObject(e)){throw"BX.MainButtons: params is not Object"}if(!("containerId"in e)||!BX.type.isNotEmptyString(e.containerId)){throw"BX.MainButtons: containerId not set in params"}if(!BX.type.isDomNode(this.listContainer)){throw"BX.MainButtons: #"+e.containerId+" is not dom node"}if("classes"in e&&BX.type.isPlainObject(e.classes)){this.setCustomClasses(e.classes)}if("messages"in e&&BX.type.isPlainObject(e.messages)){this.setMessages(e.messages)}if("licenseWindow"in e&&BX.type.isPlainObject(e.licenseWindow)){this.setLicenseWindowParams(e.licenseWindow)}if("disableSettings"in e&&e.disableSettings==="true"){this.isSettingsEnabled=false;this.visibleControlMoreButton()}this.moreButton=this.getMoreButton();this.listChildItems={};if(this.isSettingsEnabled){this.dragAndDropInit()}this.adjustMoreButtonPosition();this.bindOnClickOnMoreButton();this.bindOnScrollWindow();this.setContainerHeight();BX.bind(this.getContainer(),"click",BX.delegate(this._onDocumentClick,this));BX.addCustomEvent("onPullEvent-main",BX.delegate(this._onPush,this));this.updateMoreButtonCounter();if(this.isActiveInMoreMenu()){this.activateItem(this.moreButton)}var i=this.getVisibleItems();var s=BX.type.isArray(i)&&i.length>0?i[0]:null;var n=BX.Buttons.Utils.getByTag(s,"a");if(!BX.type.isDomNode(n)){return}var a=n.getAttribute("href");if(a.charAt(0)==="?"){a=n.pathname+n.search}if(!this.lastHomeLink){this.lastHomeLink=a}this.bindOnResizeFrame()},_onDocumentClick:function(t){var e=this.getItem(t);var i,s,n,a,o,u;if(this.isDragButton(t.target)){t.preventDefault();t.stopPropagation()}if(BX.type.isDomNode(e)){if(this.isSettings(e)){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton());return false}if(this.isApplySettingsButton(e)){t.preventDefault();t.stopPropagation();this.disableEdit();BX.show(this.getSettingsButton());BX.hide(this.getSettingsApplyButton());return false}if(this.isResetSettingsButton(e)){this.resetSettings();return false}if(this.isLocked(e)){t.preventDefault();this.showLicenseWindow();return false}if(this.isEditButton(t.target)){var r,h;t.preventDefault();t.stopPropagation();if(this.isSubmenuItem(e)){e=this.getItemAlias(e)}try{r=JSON.parse(BX.data(e,"item"))}catch(t){}h=this.getItemEditMenu();if(h&&h.popupWindow.isShown()&&this.lastEditNode===e){h.popupWindow.close()}else{this.showItemEditMenu(r,t.target)}this.lastEditNode=e;return false}if(this.isSetHide(e)){o=this.getVisibleItems();u=BX.type.isArray(o)?o.length:null;a=this.editItemData.ID.replace(this.listContainer.id+"_","");s=this.getItemById(a);n=this.getItemAlias(s);s=this.isVisibleItem(s)?s:n;if(this.isDisabled(n)){this.enableItem(n)}else if(!this.isDisabled(n)&&u>2){this.disableItem(n)}if(u===2){BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[s,this])}this.refreshSubmenu();this.saveSettings();this.adjustMoreButtonPosition();if(this.isEditEnabled()){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton())}this.editMenu.popupWindow.close();return false}if(this.isSetHome(e)){a=this.editItemData.ID.replace(this.listContainer.id+"_","");s=this.getItemById(a);n=this.getItemAlias(s);if(this.isDisabled(n)){this.enableItem(n)}this.listContainer.insertBefore(s,BX.firstChild(this.listContainer));this.adjustMoreButtonPosition();this.refreshSubmenu();this.saveSettings();if(this.isEditEnabled()){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton())}this.editMenu.popupWindow.close();return false}if(!this.isSublink(t.target)){i=this.dataValue(e,"onclick");if(BX.type.isNotEmptyString(i)){t.preventDefault();this.execScript(i)}}}if(this.isEditEnabled()){this.getSubmenu().popupWindow.setAutoHide(false)}},isActiveInMoreMenu:function(){var t=this.getHiddenItems();var e=this.getDisabledItems();var i=t.concat(e);return i.some(function(t){var e;try{e=JSON.parse(BX.data(t,"item"))}catch(t){}return BX.type.isPlainObject(e)&&("IS_ACTIVE"in e&&e.IS_ACTIVE===true||e.IS_ACTIVE==="true"||e.IS_ACTIVE==="Y")},this)},_onPush:function(t,e){if(t==="user_counter"&&e&&BX.message("SITE_ID")in e){var i=e[BX.message("SITE_ID")];for(var s in i){if(i.hasOwnProperty(s)){this.updateCounter(s,i[s])}}}},bindOnScrollWindow:function(){BX.bind(window,"scroll",BX.delegate(this._onScroll,this))},getActive:function(){var t=this.getAllItems();var e,i;var s=null;if(BX.type.isArray(t)){t.forEach(function(t){try{e=JSON.parse(BX.data(t,"item"))}catch(t){e=null}if(BX.type.isPlainObject(e)&&"IS_ACTIVE"in e&&(e.IS_ACTIVE===true||e.IS_ACTIVE==="true"||e.IS_ACTIVE==="Y")){s=e}},this)}if(BX.type.isPlainObject(s)){i=BX(s.ID);if(BX.type.isDomNode(i)){s.NODE=i}else{s.NODE=null}}return s},isSetHome:function(t){return BX.hasClass(t,this.classSetHome)},isSetHide:function(t){return BX.hasClass(t,this.classSetHide)},getSettingsButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingMenuItem)},getSettingsApplyButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingsApplyButton)},isApplySettingsButton:function(t){return BX.hasClass(t,this.classSettingsApplyButton)},enableEdit:function(){var t=this.getSubmenu();if(t&&"popupWindow"in t){t.popupWindow.setAutoHide(false)}BX.addClass(this.listContainer,this.classEditState);BX.addClass(this.getSubmenuContainer(),this.classEditState);this.isEditEnabledState=true},disableEdit:function(){var t=this.getSubmenu();if(t&&"popupWindow"in t){t.popupWindow.setAutoHide(true)}BX.removeClass(this.listContainer,this.classEditState);BX.removeClass(this.getSubmenuContainer(),this.classEditState);this.isEditEnabledState=false},isEditEnabled:function(){return this.isEditEnabledState},showItemEditMenu:function(t,e){if(BX.type.isPlainObject(t)&&"ID"in t){var i=[this.listContainer.id,"_edit_item"].join("");var s=BX.PopupMenu.getMenuById(i);if(s){BX.PopupMenu.destroy(i)}s=this.createItemEditMenu(t,i,e);s.popupWindow.show()}},getContainer:function(){if(!BX.type.isDomNode(this.container)){this.container=BX(this.containerId).parentNode}return this.container},getItemEditMenu:function(){return BX.PopupMenu.getMenuById([this.listContainer.id,"_edit_item"].join(""))},createItemEditMenu:function(t,e,i){var s;var n=[{text:this.message("MIB_SET_HOME"),className:"main-buttons-set-home menu-popup-no-icon"}];var a=t.ID.replace(this.listContainer.id+"_","");var o=this.getItemById(a);if(this.isDisabled(o)){n.push({text:this.message("MIB_SET_SHOW"),className:"main-buttons-set-hide menu-popup-no-icon"})}else{n.push({text:this.message("MIB_SET_HIDE"),className:"main-buttons-set-hide menu-popup-no-icon"})}var u=BX.pos(i);var r={menuId:e,anchor:i,menuItems:n,settings:{autoHide:true,offsetTop:0,offsetLeft:u.width/2,zIndex:20,angle:{position:"top",offset:u.width/2}}};s=BX.PopupMenu.create(r.menuId,r.anchor,r.menuItems,r.settings);if(this.isVisibleItem(o)){t.NODE=o}else{t.NODE=this.getItemAlias(o)}this.editItemData=t;if("menuItems"in s&&BX.type.isArray(s.menuItems)){s.menuItems.forEach(function(t){BX.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))},this)}BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onBeforeCreateEditMenu",[s,t,this]);this.editMenu=s;return s},setHome:function(){var t=this.getVisibleItems();var e=BX.type.isArray(t)&&t.length>0?t[0]:null;var i=BX.Buttons.Utils.getByTag(e,"a");if(!BX.type.isDomNode(i)){return}var s=i.getAttribute("href");if(s.charAt(0)==="?"){s=i.pathname+i.search}if(!this.lastHomeLink){this.lastHomeLink=s}if(this.lastHomeLink!==s){BX.userOptions.save("ui",this.listContainer.id,"firstPageLink",s);BX.onCustomEvent("BX.Main.InterfaceButtons:onFirstItemChange",[s,e])}this.lastHomeLink=s},isEditButton:function(t){return BX.hasClass(t,this.classEditItemButton)},isDragButton:function(t){return BX.hasClass(t,this.classDragItemButton)},isResetSettingsButton:function(t){return BX.hasClass(t,this.classSettingsResetButton)},getContainerHeight:function(){var t=this.getAllItems().map(function(t){var e=getComputedStyle(t);return BX.height(t)+parseInt(e.marginTop)+parseInt(e.marginBottom)});return Math.max.apply(Math,t)},setContainerHeight:function(){var t=this.getContainerHeight();var e=8;BX.height(this.listContainer,t-e)},setLicenseWindowParams:function(t){this.licenseParams=t||{}},message:function(t){var e;try{e=this.messages[t]}catch(t){e=""}return e},setCustomClasses:function(t){if(!BX.type.isPlainObject(t)){return}this.classItem=t.item||this.classItem;this.classItemSublink=t.itemSublink||this.classItemSublink;this.classItemText=t.itemText||this.classItemText;this.classItemCounter=t.itemCounter||this.classItemCounter;this.classItemIcon=t.itemIcon||this.classItemIcon;this.classItemMore=t.itemMore||this.classItemMore;this.classItemOver=t.itemOver||this.classItemOver;this.classItemActive=t.itemActive||this.classItemActive;this.classItemDisabled=t.itemDisabled||this.classItemDisabled;this.classOnDrag=t.onDrag||this.classOnDrag;this.classDropzone=t.dropzone||this.classDropzone;this.classSeporator=t.separator||this.classSeporator;this.classSubmenuItem=t.submenuItem||this.classSubmenuItem;this.classSubmenu=t.submenu||this.classSubmenu;this.classSecret=t.secret||this.classSecret;this.classItemLocked=t.itemLocked||this.classItemLocked},setMessages:function(t){if(!BX.type.isPlainObject(t)){return}this.messages=t},makeFullItemId:function(t){if(!BX.type.isNotEmptyString(t)){return}return[this.listContainer.id,t.replace("-","_")].join("_")},getItemById:function(t){var e=null;var i;if(BX.type.isNotEmptyString(t)){i=this.makeFullItemId(t);e=BX.Buttons.Utils.getBySelector(this.listContainer,"#"+i)}return e},getItemCounterObject:function(t){var e=null;if(BX.type.isDomNode(t)){e=BX.Buttons.Utils.getByClass(t,this.classItemCounter)}return e},setCounterValue:function(t,e){var i=this.getItemCounterObject(t);if(BX.type.isDomNode(i)){i.innerText=e>99?"99+":e>0?e:"";t.dataset.counter=e}this.updateMoreButtonCounter()},updateCounter:function(t,e){if(t.indexOf("crm")===0&&e<0){return}var i,s,n;var a=null;var o=this.getAllItems();if(BX.type.isArray(o)){o.forEach(function(e){try{s=JSON.parse(BX.data(e,"item"))}catch(t){s={}}if(BX.type.isPlainObject(s)&&"COUNTER_ID"in s&&s.COUNTER_ID===t){a=e}},this)}i=this.getItemCounterObject(a);if(BX.type.isDomNode(i)){a=this.getItem(i);i.innerText=e>99?"99+":e>0?e:"";a.dataset.counter=e}n=this.getItemAlias(a);if(BX.type.isDomNode(n)){i=this.getItemCounterObject(n);if(BX.type.isDomNode(i)){i.innerText=e>99?"99+":e>0?e:"";n.dataset.counter=e}}this.updateMoreButtonCounter()},setCounterValueByItemId:function(t,e){var i=e!==null?parseFloat(e):null;var s,n;if(!BX.type.isNotEmptyString(t)){throw"Bad first arg. Need string as item id"}if(i!==null&&!BX.type.isNumber(i)){throw"Bad two arg. Need number counter value - Integer, Float or string with number"}s=this.getItemById(t);if(!BX.type.isDomNode(s)){console.info("Not found node with id #"+t);return}n=this.getItemAlias(s);this.setCounterValue(s,i);this.setCounterValue(n,i)},getCounterValueByItemId:function(t){var e,i;var s=NaN;if(!BX.type.isNotEmptyString(t)){throw"Bad first arg. Need string item id"}else{e=this.getItemById(t);s=this.dataValue(e,"counter");s=parseFloat(s);if(!BX.type.isNumber(s)){i=this.getItemCounterObject(e);s=parseFloat(i.innerText)}}return s},setMoreButtonCounter:function(t){var e=this.getItemCounterObject(this.moreButton);var i=t>99?"99+":t>0?t:"";i=parseInt(i);i=BX.type.isNumber(i)?i:"";e.innerText=i},bindOnClickOnMoreButton:function(){BX.bind(this.moreButton,"click",BX.delegate(this._onClickMoreButton,this))},bindOnResizeFrame:function(){window.frames["maininterfacebuttonstmpframe-"+this.getId()].onresize=BX.throttle(this._onResizeHandler,20,this)},getId:function(){return BX.Buttons.Utils.getByClass(this.getContainer(),this.classInner).id},getAllItems:function(){return BX.Buttons.Utils.getByClass(this.listContainer,this.classItem,true)},getVisibleItems:function(){var t=this.getAllItems();var e=this;var i=[];if(t&&t.length){i=t.filter(function(t){return e.isVisibleItem(t)&&!e.isDisabled(t)})}return i},getHiddenItems:function(){var t=this.getAllItems();var e=[];var i=this;if(t&&t.length){e=t.filter(function(t){return!i.isVisibleItem(t)&&!i.isDisabled(t)})}return e},getDisabledItems:function(){return this.getAllItems().filter(function(t){return this.isDisabled(t)},this)},getMoreButton:function(){var t=null;this.getAllItems().forEach(function(e){!t&&BX.hasClass(e,this.classItemMore)&&(t=e)},this);return t},getLastVisibleItem:function(){var t=this.getVisibleItems();var e=null;if(BX.type.isArray(t)&&t.length){e=t[t.length-1]}if(!BX.type.isDomNode(e)){e=null}return e},adjustMoreButtonPosition:function(){var t=this.getLastVisibleItem();var e=this.isMoreButton(t);if(!e){this.listContainer.insertBefore(this.moreButton,t)}this.updateMoreButtonCounter()},getSubmenuId:function(t){var e="";if(BX.type.isDomNode(this.listContainer)&&BX.type.isNotEmptyString(this.listContainer.id)){e=this.submenuIdPrefix+this.listContainer.id}if(t){e=this.submenuWindowIdPrefix+e}return e},getChildMenuId:function(){var t="";if(BX.type.isDomNode(this.listContainer)&&BX.type.isNotEmptyString(this.listContainer.id)){t=this.childMenuIdPrefix+this.listContainer.id}return t},getSubmenuItemText:function(t){var e,i,s;if(!BX.type.isDomNode(t)){return null}e=this.findChildrenByClassName(t,this.classItemText);i=this.findChildrenByClassName(t,this.classItemCounter);if(BX.type.isDomNode(i)&&BX.type.isDomNode(e)){i.dataset.counter=this.dataValue(t,"counter");s=e.outerHTML+i.outerHTML}else{e=this.dataValue(t,"text");i=this.dataValue(t,"counter");s=e}return s},getChildMenuItemText:function(t){var e,i,s;if(!BX.type.isDomNode(t)){return null}e=this.findChildrenByClassName(t,this.classItemText);i=this.findChildrenByClassName(t,this.classItemCounter);if(BX.type.isDomNode(i)&&BX.type.isDomNode(e)){i.dataset.counter=this.dataValue(t,"counter");s=e.outerHTML+i.outerHTML}else{e=this.dataValue(t,"text");s=e}return s},getLockedClass:function(t){var e="";if(BX.type.isDomNode(t)&&this.isLocked(t)){e=this.classItemLocked}return e},getSubmenuItems:function(){var t=this.getAllItems();var e=this.getHiddenItems();var i=this.getDisabledItems();var s=[];var n,a;if(t.length){t.forEach(function(t){if(e.indexOf(t)===-1&&i.indexOf(t)===-1){s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:[this.classSubmenuItem,this.getIconClass(t),this.classSecret,this.getAliasLink(t),this.getLockedClass(t)].join(" ")})}},this)}if(e.length){e.forEach(function(t){try{n=JSON.parse(this.dataValue(t,"item"))}catch(t){n=null}a=[this.classSubmenuItem,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(BX.type.isPlainObject(n)&&("IS_ACTIVE"in n&&n.IS_ACTIVE===true||n.IS_ACTIVE==="true"||n.IS_ACTIVE==="Y")){a.push(this.classItemActive)}s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:a.join(" "),items:this.getChildMenuItems(t)})},this)}if(this.isSettingsEnabled){s.push({text:"<span>"+this.message("MIB_HIDDEN")+"</span>",className:[this.classSeporator,this.classSubmenuItem,this.classHiddenLabel].join(" ")});if(!i.length){s.push({text:"<span>"+this.message("MIB_NO_HIDDEN")+"</span>",className:[this.classSubmenuItem,this.classSubmenuNoHiddenItem].join(" ")})}if(i.length){i.forEach(function(t){try{n=JSON.parse(this.dataValue(t,"item"))}catch(t){n=null}a=[this.classSubmenuItem,this.classItemDisabled,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(BX.type.isPlainObject(n)&&("IS_ACTIVE"in n&&n.IS_ACTIVE===true||n.IS_ACTIVE==="true"||n.IS_ACTIVE==="Y")){a.push(this.classItemActive)}s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:a.join(" "),items:this.getChildMenuItems(t)})},this)}s.push({text:"<span>"+this.message("MIB_MANAGE")+"</span>",className:[this.classSeporator,this.classSubmenuItem,this.classHiddenLabel,this.classManage].join(" ")});s.push({text:this.message("MIB_SETTING_MENU_ITEM"),className:[this.classSettingMenuItem,this.classSubmenuItem].join(" ")});s.push({text:this.message("MIB_APPLY_SETTING_MENU_ITEM"),className:[this.classSettingsApplyButton,this.classSubmenuItem].join(" ")});s.push({text:this.message("MIB_RESET_SETTINGS"),className:[this.classSettingsResetButton,this.classSubmenuItem].join(" ")})}return s},getChildMenuItems:function(t){var e;try{e=JSON.parse(this.dataValue(t,"item"))}catch(t){e=null}if(!BX.type.isPlainObject(e)){return[]}if(!BX.type.isArray(this.listChildItems[t.id])){var i={};this.setListAllItems(i,e);var s=this.getListItems(i,"");if(s.length){this.listChildItems[t.id]=BX.type.isArray(s[0].items)?s[0].items:[]}}return this.listChildItems[t.id]},setListAllItems:function(t,e){var i=[];if(BX.type.isPlainObject(e)){i.push(e)}else{i=e}i.forEach(function(e){t[e["ID"].replace(this.containerId+"_","")]=e;if(BX.type.isArray(e["ITEMS"])){this.setListAllItems(t,e["ITEMS"])}},this)},getListItems:function(t,e){var i=[];for(var s in t){if(!t.hasOwnProperty(s)){continue}var n=t[s];if(n["PARENT_ID"]===e){var a,o={text:n["TEXT"],href:n["URL"],onclick:n["ON_CLICK"],title:n["TITLE"]};a=this.getListItems(t,s);if(a.length){o.items=a}i.push(o);delete t[s]}}return i},getSubmenuArgs:function(){var t=this.getSubmenuId();var e=this.moreButton;var i=BX.pos(e);var s=this.getSubmenuItems();var n={autoHide:true,offsetLeft:i.width/2-80,angle:{position:"top",offset:100},zIndex:0,events:{onPopupClose:BX.delegate(this._onSubmenuClose,this)}};return[t,e,s,n]},getChildMenuArgs:function(t){var e=this.getChildMenuId();var i=this.getChildMenuItems(t);if(!i||BX.type.isArray(i)&&!i.length){return[]}var s={autoHide:true,angle:true,offsetLeft:t.getBoundingClientRect().width/2};return[e,t,i,s]},visibleControlMoreButton:function(){var t=this.getHiddenItems();if(!t.length||t.length===1&&this.isMoreButton(t[0])){this.getMoreButton().style.display="none"}else{this.getMoreButton().style.display=""}},createSubmenu:function(){var t=BX.PopupMenu.create.apply(BX.PopupMenu,this.getSubmenuArgs());if(this.isSettingsEnabled){this.dragAndDropInitInSubmenu()}t.menuItems.forEach(function(t){BX.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))},this);return t},createChildMenu:function(t){return BX.PopupMenu.create.apply(BX.PopupMenu,this.getChildMenuArgs(t))},showSubmenu:function(){var t=this.getSubmenu();if(t!==null){t.popupWindow.show()}else{this.destroySubmenu();t=this.createSubmenu();t.popupWindow.show()}this.setSubmenuShown(true);this.activateItem(this.moreButton);if(this.isEditEnabled()){t.popupWindow.setAutoHide(false)}},showChildMenu:function(t){var e=BX.PopupMenu.getMenuById(this.getChildMenuId()),i=null;if(e&&e.bindElement){if(e.bindElement.id!==t.id){this.destroyChildMenu(t);i=this.createChildMenu(t);i.popupWindow.show()}else{e.popupWindow.show()}}else{this.destroyChildMenu(t);i=this.createChildMenu(t);i.popupWindow.show()}},closeSubmenu:function(){var t=this.getSubmenu();if(t===null){return}t.popupWindow.close();if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}this.setSubmenuShown(false)},closeChildMenu:function(t){var e=this.getChildMenu(t);if(e===null){return}e.popupWindow.close()},getSubmenu:function(){return BX.PopupMenu.getMenuById(this.getSubmenuId())},getChildMenu:function(){return BX.PopupMenu.getMenuById(this.getChildMenuId())},destroySubmenu:function(){BX.PopupMenu.destroy(this.getSubmenuId())},destroyChildMenu:function(){BX.PopupMenu.destroy(this.getChildMenuId())},refreshSubmenu:function(){var t=this.getSubmenu();var e;if(t===null){return}e=this.getSubmenuArgs();if(BX.type.isArray(e)){this.destroySubmenu();this.createSubmenu();this.showSubmenu()}},setSubmenuShown:function(t){this.isSubmenuShown=false;if(BX.type.isBoolean(t)){this.isSubmenuShown=t}},activateItem:function(t){if(!BX.type.isDomNode(t)){return}if(!BX.hasClass(t,this.classItemActive)){BX.addClass(t,this.classItemActive)}},deactivateItem:function(t){if(!BX.type.isDomNode(t)){return}if(BX.hasClass(t,this.classItemActive)){BX.removeClass(t,this.classItemActive)}},getCurrentSettings:function(){var t={};this.getAllItems().forEach(function(e,i){t[e.id]={sort:i,isDisabled:this.isDisabled(e)}},this);return t},saveSettings:function(){var t=this.getCurrentSettings();var e="settings";var i;if(!BX.type.isPlainObject(t)){return}if(BX.type.isDomNode(this.listContainer)){if("id"in this.listContainer){i=this.listContainer.id;t=JSON.stringify(t);BX.userOptions.save("ui",i,e,t);this.setHome()}}},resetSettings:function(){var t=null;var e=BX.PopupWindowManager.create(this.listContainer.id+"_reset_popup",null,{content:this.message("MIB_RESET_ALERT"),autoHide:false,overlay:true,closeByEsc:true,closeIcon:true,draggable:{restrict:true},titleBar:this.message("MIB_RESET_SETTINGS"),buttons:[t=new BX.PopupWindowButton({text:this.message("MIB_RESET_BUTTON"),className:"popup-window-button-create",events:{click:function(){if(BX.hasClass(t.buttonNode,"popup-window-button-wait")){return}BX.addClass(t.buttonNode,"popup-window-button-wait");this.handleResetSettings(function(i){if(i){BX.removeClass(t.buttonNode,"popup-window-button-wait");e.setContent(i)}else{var s="settings";BX.userOptions.save("ui",this.listContainer.id,s,JSON.stringify({}));BX.userOptions.save("ui",this.listContainer.id,"firstPageLink","");window.location.reload()}}.bind(this))}.bind(this)}}),new BX.PopupWindowButtonLink({text:this.message("MIB_CANCEL_BUTTON"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});e.show()},handleResetSettings:function(t){var e=[];BX.onCustomEvent("BX.Main.InterfaceButtons:onBeforeResetMenu",[e,this]);var i=new BX.Promise;var s=i;for(var n=0;n<e.length;n++){i=i.then(e[n])}i.then(function(e){t(null,e)},function(e){t(e,null)});s.fulfill()},moveButtonAlias:function(t){var e,i;if(!t||!this.dragItem){return}e=this.getItemAlias(this.dragItem);i=this.getItemAlias(t);if(this.isListItem(e)){if(!i){this.listContainer.appendChild(e)}else{this.listContainer.insertBefore(e,i)}}},moveButton:function(t){var e;if(!BX.type.isDomNode(t)||!BX.type.isDomNode(this.dragItem)){return}if(this.isListItem(t)){if(this.isDisabled(this.dragItem)){this.dragItem.dataset.disabled="false"}if(BX.type.isDomNode(t)){this.listContainer.insertBefore(this.dragItem,t)}else{this.listContainer.appendChild(this.dragItem)}}if(this.isSubmenuItem(t)){if(this.isDisabled(this.dragItem)&&!this.isDisabled(t)){this.enableItem(this.dragItem)}e=this.getSubmenuContainer();e.insertBefore(this.dragItem,t)}},getSubmenuContainer:function(){var t=this.getSubmenu();var e=null;if(t!==null){e=t.itemsContainer}return e},findNextSiblingByClass:function(t,e){var i=t;for(;!!t;t=t.nextElementSibling){if(e){if(BX.hasClass(t,e)&&t!==i){return t}}else{return null}}},findParentByClassName:function(t,e){for(;t&&t!==document;t=t.parentNode){if(e){if(BX.hasClass(t,e)){return t}}else{return null}}},findChildrenByClassName:function(t,e){var i=null;if(BX.type.isDomNode(t)&&BX.type.isNotEmptyString(e)){i=BX.Buttons.Utils.getByClass(t,e)}return i},dragAndDropInit:function(){this.getAllItems().forEach(function(t,e){if(!this.isSeparator(t)&&!this.isSettings(t)&&!this.isApplySettingsButton(t)&&!this.isResetSettingsButton(t)){t.setAttribute("draggable","true");t.setAttribute("tabindex","-1");t.dataset.link="item"+e;BX.bind(t,"dragstart",BX.delegate(this._onDragStart,this));BX.bind(t,"dragend",BX.delegate(this._onDragEnd,this));BX.bind(t,"dragenter",BX.delegate(this._onDragEnter,this));BX.bind(t,"dragover",BX.delegate(this._onDragOver,this));BX.bind(t,"dragleave",BX.delegate(this._onDragLeave,this));BX.bind(t,"drop",BX.delegate(this._onDrop,this))}BX.bind(t,"mouseover",BX.delegate(this._onMouse,this));BX.bind(t,"mouseout",BX.delegate(this._onMouse,this))},this)},dragAndDropInitInSubmenu:function(){var t=this.getSubmenu();var e=t.menuItems;e.forEach(function(t){if(!this.isSeparator(t.layout.item)&&!this.isSettings(t.layout.item)&&!this.isApplySettingsButton(t.layout.item)&&!this.isResetSettingsButton(t.layout.item)){t.layout.item.draggable=true;t.layout.item.dataset.sortable=true;BX.bind(t.layout.item,"dragstart",BX.delegate(this._onDragStart,this));BX.bind(t.layout.item,"dragenter",BX.delegate(this._onDragEnter,this));BX.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this));BX.bind(t.layout.item,"dragleave",BX.delegate(this._onDragLeave,this));BX.bind(t.layout.item,"dragend",BX.delegate(this._onDragEnd,this));BX.bind(t.layout.item,"drop",BX.delegate(this._onDrop,this))}if(BX.hasClass(t.layout.item,this.classHiddenLabel)&&!BX.hasClass(t.layout.item,this.classManage)){BX.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this))}},this)},getItem:function(t){if(!BX.type.isDomNode(t)){if(!t||!BX.type.isDomNode(t.target)){return null}}else{t={target:t}}var e=this.findParentByClassName(t.target,this.classItem);if(!BX.type.isDomNode(e)){e=this.findParentByClassName(t.target,this.classDefaultSubmenuItem)}return e},setOpacity:function(t){if(!BX.type.isDomNode(t)){return}BX.style(t,"opacity",".1")},unsetOpacity:function(t){if(!BX.type.isDomNode(t)){return}BX.style(t,"opacity","1")},setDragStyles:function(){BX.addClass(this.listContainer,this.classOnDrag);BX.addClass(BX(this.getSubmenuId(true)),this.classOnDrag);this.setOpacity(this.dragItem)},unsetDragStyles:function(){var t=this.getSubmenu();this.getAllItems().forEach(function(t){this.unsetOpacity(t);BX.removeClass(t,"over")},this);if(t&&"menuItems"in t&&BX.type.isArray(t.menuItems)&&t.menuItems.length){t.menuItems.forEach(function(t){this.unsetOpacity(t);BX.removeClass(t.layout.item,"over")},this)}BX.removeClass(this.listContainer,this.classOnDrag);BX.removeClass(BX(this.getSubmenuId(true)),this.classOnDrag)},getIconClass:function(t){var e="";if(BX.type.isDomNode(t)&&"dataset"in t&&"class"in t.dataset&&BX.type.isNotEmptyString(t.dataset.class)){e=t.dataset.class}return e},disableItem:function(t){var e=this.getItemAlias(t);if(t&&"dataset"in t){t.dataset.disabled="true";if(e){e.dataset.disabled="true"}}},enableItem:function(t){var e;if(!BX.type.isDomNode(t)){return}if(this.isSubmenuItem(t)){BX.removeClass(t,this.classItemDisabled);e=this.getItemAlias(t);if(BX.type.isDomNode(e)){e.dataset.disabled="false"}}},getAliasLink:function(t){return this.dataValue(t,"link")||""},getItemAlias:function(t){var e=null;if(!BX.type.isDomNode(t)){return e}var i=this.getAllItems();var s=this.isSubmenuItem(t);var n=this.isListItem(t);if(!s&&!n){return e}if(s){i.forEach(function(i){BX.hasClass(t,this.getAliasLink(i))&&(e=i)},this)}if(n){e=BX.Buttons.Utils.getByClass(document,this.getAliasLink(t))}return e},hideItem:function(t){!!t&&BX.addClass(t,this.classSecret)},showItem:function(t){!!t&&BX.removeClass(t,this.classSecret)},fakeDragItem:function(){var t=null;if(!BX.type.isDomNode(this.dragItem)||!BX.type.isDomNode(this.overItem)){return}if(this.isDragToSubmenu()){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.listContainer.appendChild(this.dragItem);this.dragItem=t;this.showItem(this.dragItem);this.adjustMoreButtonPosition();this.updateSubmenuItems();this.tmp.moved=false;this.tmp.movetToSubmenu=true;this.setOpacity(this.dragItem)}}if(this.isDragToList()&&!this.tmp.movetToSubmenu){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.hideItem(this.dragItem);this.dragItem=t;this.adjustMoreButtonPosition();this.updateSubmenuItems();this.setOpacity(this.dragItem)}}this.tmp.movetToSubmenu=false},updateSubmenuItems:function(){var t=this.getHiddenItems();var e=this.getDisabledItems();var i=this;var s=[];var n,a,o;n=this.getSubmenu();if(n===null){return}a=n.menuItems;if(!BX.type.isArray(a)||!a.length){return}s=e.concat(t);a.forEach(function(t){o=[].some.call(s,function(e){return BX.hasClass(t.layout.item,i.dataValue(e,"link"))||i.isDisabled(t.layout.item)||i.isSeparator(t.layout.item)||i.isDropzone(t.layout.item)});if(o||(i.isSettings(t.layout.item)||i.isApplySettingsButton(t.layout.item)||i.isResetSettingsButton(t.layout.item)||i.isNotHiddenItem(t.layout.item)||i.isSeparator(t.layout.item)||t.layout.item===i.dragItem)&&!i.isMoreButton(t.layout.item)){i.showItem(t.layout.item)}else{i.hideItem(t.layout.item)}})},isNotHiddenItem:function(t){return BX.hasClass(t,this.classSubmenuNoHiddenItem)},getNotHidden:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSubmenuNoHiddenItem)},setOverStyles:function(t){if(BX.type.isDomNode(t)&&!BX.hasClass(t,this.classItemOver)){BX.addClass(t,this.classItemOver)}},unsetOverStyles:function(t){if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItemOver)){BX.removeClass(t,this.classItemOver)}},dataValue:function(t,e){var i="";var s;if(BX.type.isDomNode(t)){s=BX.data(t,e);if(typeof s!=="undefined"){i=s}}return i},execScript:function(script){if(BX.type.isNotEmptyString(script)){eval(script)}},showLicenseWindow:function(){var t;if(!B24.licenseInfoPopup){return}t=B24.licenseInfoPopup;t.init({B24_LICENSE_BUTTON_TEXT:this.message("MIB_LICENSE_BUY_BUTTON"),B24_TRIAL_BUTTON_TEXT:this.message("MIB_LICENSE_TRIAL_BUTTON"),IS_FULL_DEMO_EXISTS:this.licenseParams.isFullDemoExists,HOST_NAME:this.licenseParams.hostname,AJAX_URL:this.licenseParams.ajaxUrl,LICENSE_ALL_PATH:this.licenseParams.licenseAllPath,LICENSE_DEMO_PATH:this.licenseParams.licenseDemoPath,FEATURE_GROUP_NAME:this.licenseParams.featureGroupName,AJAX_ACTIONS_URL:this.licenseParams.ajaxActionsUrl,B24_FEATURE_TRIAL_SUCCESS_TEXT:this.message("MIB_LICENSE_WINDOW_TRIAL_SUCCESS_TEXT")});t.show("main-buttons",this.message("MIB_LICENSE_WINDOW_HEADER_TEXT"),this.message("MIB_LICENSE_WINDOW_TEXT"))},_onDragStart:function(t){var e=this.getVisibleItems();var i=BX.type.isArray(e)?e.length:null;this.dragItem=this.getItem(t);if(!BX.type.isDomNode(this.dragItem)){return}if(i===2&&this.isListItem(this.dragItem)){t.preventDefault();BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[this.dragItem,this]);return}if(this.isMoreButton(this.dragItem)||this.isSeparator(this.dragItem)||this.isNotHiddenItem(this.dragItem)){t.preventDefault();return}this.isSubmenuShownOnDragStart=!!this.isSubmenuShown;if(this.isListItem(this.dragItem)){this.showSubmenu()}this.setDragStyles();if(!this.isEditEnabled()){this.enableEdit()}},_onDragEnd:function(t){t.preventDefault();var e=this.getItem(t);var i,s;if(!BX.type.isDomNode(e)){return}this.unsetDragStyles();if(!this.isSubmenuShownOnDragStart){this.refreshSubmenu();if(!this.isEditEnabled()){this.closeSubmenu()}}else{this.refreshSubmenu()}i=BX.findNextSibling(this.dragItem,BX.delegate(function(t){return this.isVisibleItem(t)},this));s=BX.findPreviousSibling(this.dragItem,BX.delegate(function(t){return this.isVisibleItem(t)},this));if(BX.type.isDomNode(s)&&(BX.hasClass(s,this.classHiddenLabel)||this.isDisabled(s)&&this.isSubmenuItem(s))||(BX.type.isDomNode(i)&&BX.hasClass(i,this.classManage)||this.isDisabled(i)&&this.isSubmenuItem(i))){this.disableItem(this.dragItem);this.refreshSubmenu()}if(this.isEditEnabled()){this.enableEdit();BX.show(this.getSettingsApplyButton());BX.hide(this.getSettingsButton())}else{this.disableEdit();BX.hide(this.getSettingsApplyButton());BX.show(this.getSettingsButton())}this.updateMoreButtonCounter();this.saveSettings();this.dragItem=null;this.overItem=null;this.tmp.moved=false},updateMoreButtonCounter:function(){var t,e,i,s;t=this.getHiddenItems();s=this.getDisabledItems();t=t.concat(s);e=0;if(BX.type.isArray(t)){t.forEach(function(t){e+=parseInt(this.dataValue(t,"counter"))||0},this)}if(BX.type.isNumber(e)){this.setMoreButtonCounter(e)}},_onDragEnter:function(t){var e=this.getItem(t);if(BX.type.isDomNode(e)&&this.isNotHiddenItem(e)){this.setOverStyles(e)}},_onDragOver:function(t){t.preventDefault();var e=null;this.overItem=this.getItem(t);if(!BX.type.isDomNode(this.overItem)||!BX.type.isDomNode(this.dragItem)||this.overItem===this.dragItem||this.isNotHiddenItem(this.overItem)){return}this.fakeDragItem();if(this.isNext(t)&&this.isGoodPosition(t)&&!this.isMoreButton(this.overItem)){e=this.findNextSiblingByClass(this.overItem,this.classItem);if(this.isMoreButton(e)&&!this.tmp.moved){e=e.previousElementSibling;this.tmp.moved=true}if(!BX.type.isDomNode(e)){e=this.findNextSiblingByClass(this.overItem,this.classSubmenuItem)}if(BX.type.isDomNode(e)){this.moveButton(e);this.moveButtonAlias(e);this.adjustMoreButtonPosition();this.updateSubmenuItems()}}if(!this.isNext(t)&&this.isGoodPosition(t)&&!this.isMoreButton(this.overItem)||!this.isGoodPosition(t)&&this.isMoreButton(this.overItem)&&this.getVisibleItems().length===1){this.moveButton(this.overItem);this.moveButtonAlias(this.overItem);this.adjustMoreButtonPosition();this.updateSubmenuItems()}},_onDragLeave:function(t){var e=this.getItem(t);if(BX.type.isDomNode(e)){this.unsetOverStyles(t.target)}},_onDrop:function(t){var e=this.getItem(t);if(!BX.type.isDomNode(e)){return}if(this.isNotHiddenItem(e)||this.isDisabled(e)){this.disableItem(this.dragItem);this.adjustMoreButtonPosition()}this.unsetDragStyles();t.preventDefault()},getIndex:function(t,e){return[].indexOf.call(t||[],e)},_onSubmenuClose:function(){this.setSubmenuShown(false);if(this.isEditEnabled()){this.activateItem(this.moreButton)}else{if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}}},_onResizeHandler:function(){this.adjustMoreButtonPosition();this.updateSubmenuItems();if(!this.isSettingsEnabled){this.visibleControlMoreButton()}},_onClickMoreButton:function(t){t.preventDefault();this.showSubmenu()},_onMouse:function(t){var e=this.getItem(t);if(t.type==="mouseover"&&!BX.hasClass(e,this.classItemOver)){if(!BX.hasClass(e,this.classItemMore)){this.showChildMenu(e)}BX.addClass(e,this.classItemOver)}if(t.type==="mouseout"&&BX.hasClass(e,this.classItemOver)){BX.removeClass(e,this.classItemOver)}},getSettingsResetButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingsResetButton)},_onScroll:function(){if(BX.style(this.pinContainer,"position")==="fixed"){this.closeSubmenu()}},isDisabled:function(t){var e=false;if(BX.type.isDomNode(t)){e=this.dataValue(t,"disabled")==="true"||BX.hasClass(t,this.classItemDisabled)}return e},isSettings:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classSettingMenuItem)}return e},isLocked:function(t){var e=false;if(BX.type.isDomNode(t)){e=this.dataValue(t,"locked")==="true"||BX.hasClass(t,this.classItemLocked)}return e},isDropzone:function(t){return BX.hasClass(t,this.classDropzone)},isNext:function(t){var e=this.dragItem.getBoundingClientRect();var i=this.overItem.getBoundingClientRect();var s=getComputedStyle(this.dragItem);var n=parseInt(s.marginRight.replace("px",""));var a=null;if(this.isListItem(this.overItem)){a=t.clientX>i.left-n&&t.clientX>e.right}if(this.isSubmenuItem(this.overItem)){a=t.clientY>e.top}return a},isGoodPosition:function(t){var e=this.overItem;var i,s;if(!BX.type.isDomNode(e)){return false}i=e.getBoundingClientRect();if(this.isListItem(e)){s=this.isNext(t)&&t.clientX>=i.left+i.width/2||!this.isNext(t)&&t.clientX<=i.left+i.width/2}if(this.isSubmenuItem(e)){s=this.isNext(t)&&t.clientY>=i.top+i.height/2||!this.isNext(t)&&t.clientY<=i.top+i.height/2}return s},isSubmenuItem:function(t){return BX.hasClass(t,this.classSubmenuItem)},isVisibleItem:function(t){if(!BX.type.isDomNode(t)){return false}return t.offsetTop===0},isMoreButton:function(t){var e=false;if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItemMore)){e=true}return e},isListItem:function(t){var e=false;if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItem)){e=true}return e},isSublink:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classItemSublink)}return e},isSeparator:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classSeporator)}return e},isDragToSubmenu:function(){return!this.isSubmenuItem(this.dragItem)&&this.isSubmenuItem(this.overItem)},isDragToList:function(){return this.isSubmenuItem(this.dragItem)&&!this.isSubmenuItem(this.overItem)}}}if(typeof BX.Main.interfaceButtonsManager==="undefined"){BX.Main.interfaceButtonsManager={data:{},init:function(t){var e=null;if(!BX.type.isPlainObject(t)||!("containerId"in t)){throw"BX.Main.interfaceButtonsManager: containerId not set in params Object"}e=BX(t.containerId);if(BX.type.isDomNode(e)){this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)}else{BX(BX.delegate(function(){e=BX(t.containerId);if(!BX.type.isDomNode(e)){throw"BX.Main.interfaceButtonsManager: container is not dom node"}this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)},this))}},getById:function(t){var e=null;if(BX.type.isString(t)&&BX.type.isNotEmptyString(t)){try{e=this.data[t]}catch(t){}}return e},getObjects:function(){return this.data}}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:94:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js?1544127384575";s:6:"source";s:76:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js";s:3:"min";s:80:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js";s:3:"map";s:80:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Buttons");BX.Buttons.Utils={getByClass:function(e,t,l){var n=[];if(t){n=(e||document.body).getElementsByClassName(t);if(!l){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getByTag:function(e,t,l){var n=[];if(t){n=(e||document.body).getElementsByTagName(t);if(!l){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getBySelector:function(e,t,l){var n=[];if(t){if(!l){n=(e||document.body).querySelector(t)}else{n=(e||document.body).querySelectorAll(t);n=[].slice.call(n)}}return n}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:85:"/bitrix/components/bitrix/crm.invoice.menu/templates/.default/script.js?1544127401455";s:6:"source";s:71:"/bitrix/components/bitrix/crm.invoice.menu/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/

function invoice_delete(title, message, btnTitle, path)
{
	var d;
	d = new BX.CDialog({
		title: title,
		head: '',
		content: message,
		resizable: false,
		draggable: true,
		height: 70,
		width: 300
	});
	
	var _BTN = [	
		{
			title: btnTitle,
			id: 'crmOk',
			'action': function () 
			{
				window.location.href = path;
				BX.WindowManager.Get().Close();
			}
		},
		BX.CDialog.btnCancel
	];	
	d.ClearButtons();
	d.SetButtons(_BTN);
	d.Show();
}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:99:"/bitrix/components/bitrix/crm.interface.form.recurring/templates/edit/script.min.js?154412740118511";s:6:"source";s:79:"/bitrix/components/bitrix/crm.interface.form.recurring/templates/edit/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("Crm.Component");if(typeof BX.Crm.Component.FormRecurring==="undefined"){BX.Crm.Component.FormRecurring=function(){this.prevPeriod=null;this.selectorMail=null;this.context=null;this.templateUrl=null;this.typeId=null;this.existUserMail=null;this.ajaxUrl=null;this.lastExecution=null;this.constants={C_CRM_OWNER_TYPE_INVOICE:5,MANAGER_SINGLE_EXECUTION:1,MANAGER_MULTIPLY_EXECUTION:2,PERIOD_DAILY:1,PERIOD_WEEKLY:2,PERIOD_MONTHLY:3,PERIOD_YEARLY:4,REPEAT_TILL_ENDLESS:"N",REPEAT_TILL_TIMES:"T",REPEAT_TILL_DATE:"D",MONDAY:1,TUESDAY:2,THURSDAY:4,SUNDAY:7};this.construct=function(e){if(BX.type.isElementNode(BX("datepicker-display-start"))){BX.CrmDateLinkField.create(BX("datepicker-display-start"),null,{showTime:false,setFocusOnShow:false});BX("datepicker-display-start").setAttribute("readonly","readonly")}if(BX.type.isElementNode(BX("datepicker-display-end"))){BX.CrmDateLinkField.create(BX("datepicker-display-end"),null,{showTime:false,setFocusOnShow:false});BX("datepicker-display-end").setAttribute("readonly","readonly")}if(BX.type.isElementNode(BX("deal-datepicker-before"))){BX.CrmDateLinkField.create(BX("deal-datepicker-before"),null,{showTime:false,setFocusOnShow:false});BX("deal-datepicker-before").setAttribute("readonly","readonly")}this.ajaxUrl=e.AJAX_URL||"";this.existUserMail=e.ALLOW_SEND_BILL=="Y";this.context=e.CONTEXT||"";this.templateUrl=e.TEMPLATE_URL||"";this.entityTypeId=e.ENTITY_TYPE_ID||this.constants.C_CRM_OWNER_TYPE_INVOICE;this.entityTypeName=e.ENTITY_TYPE_NAME||"Invoice";this.lastExecution=e.LAST_EXECUTION||"";if(e.EMAILS[0]!==undefined){this.createEmailSelection(e.EMAILS)}this.prevPeriod=this.getValueString("period");this.onUpdateHint();this.bindEvents();this.onPeriodChange()};this.createEmailSelection=function(e){var t=BX("crm-recur-email-change");this.selectorMail=BX.CmrSelectorMenu.create("selector_recurring_email",{container:t,items:e});this.selectorMail.addOnSelectListener(BX.delegate(this.onTypeSelect,this));BX.bind(t,"click",BX.delegate(function(){this.selectorMail.open(t)},this))};this.toggleMailSender=function(){if(!this.existUserMail){BX("crm-recurring-email").checked="";BX("crm-recurring-email").disabled="disabled";BX("crm-recurring-email").classList.add("crm-recur-checkbox-blocked");BX("crm-recurring-empty-owner-email").classList.add("crm-recurring-empty-owner-email")}else{BX("crm-recurring-email").disabled="";BX("crm-recurring-email").classList.remove("crm-recur-checkbox-blocked");BX("crm-recurring-empty-owner-email").innerHTML="";BX("crm-recurring-empty-owner-email").classList.remove("crm-recurring-empty-owner-email")}};this.changeClientData=function(e,t){var i=[];var a=[];if(e.getId()==="UF_MYCOMPANY_ID"){a=t.primaryEntityInfo.getMultiFieldsByType("EMAIL");this.existUserMail=t.primaryEntityInfo&&a[0]!==undefined;this.toggleMailSender()}else if(e.getId()==="CLIENT"){if(t.primaryEntityInfo){var n=t.primaryEntityInfo.getMultiFieldsByType("EMAIL");if(n[0]!==undefined){a=a.concat(n)}}if(t.entityInfos instanceof Array){t.entityInfos.forEach(function(e){var t=e.getMultiFieldsByType("EMAIL");if(t[0]!==undefined){a=a.concat(t)}})}if(a.length>0){var s=[];for(var r in a){if(BX.type.isPlainObject(a[r])&&BX.type.isNotEmptyString(a[r].VALUE)&&s.indexOf(a[r].VALUE)<0){var l=a[r].ENTITY_ID?a[r].ENTITY_ID:a[r].ID;i.push({text:a[r].VALUE,value:l});s.push(a[r].VALUE)}}}if(i.length>0){this.createEmailSelection(i);if(i[0]!==undefined){BX.removeClass(BX("crm-recur-email-block"),"crm-recur-invisible");BX("crm-recur-client-email-value").innerHTML=i[0].text;BX("crm-recur-client-email-input").value=i[0].value}else{BX.addClass(BX("crm-recur-email-block"),"crm-recur-invisible");BX("crm-recurring-email").checked=""}}else{BX.addClass(BX("crm-recur-email-block"),"crm-recur-invisible");BX("crm-recurring-email").checked=""}}};this.onTypeSelect=function(e,t){BX("crm-recur-client-email-value").innerHTML=t.getText();BX("crm-recur-client-email-input").value=t.getValue()};this.bindInstantChange=function(e,t,i){if(!BX.type.isElementNode(e)){return BX.DoNothing}i=i||e;var a=e.value;var n=BX.debounce(function(n){if(e.value.toString()!=a.toString()){t.apply(i,arguments);a=e.value}},3,i);BX.bind(e,"input",n);BX.bind(e,"keyup",n);BX.bind(e,"change",n)};this.bindEvents=function(){var e=BX.delegate(this.onUpdateHint,this);var t=BX.delegate(this.onChangeNumDay,this);var i=BX.delegate(this.moreNullValue,this);if(this.entityTypeId==this.constants.C_CRM_OWNER_TYPE_INVOICE){this.bindInvoiceEvents()}else{this.bindDealEvents()}BX.bind(BX("crm-recurring-flag"),"click",BX.delegate(function(e){if(e.target.checked){BX.removeClass(BX("crm-recur-edit-recurring-panel"),"crm-recur-invisible")}else{BX.addClass(BX("crm-recur-edit-recurring-panel"),"crm-recur-invisible")}},this));BX.bindDelegate(BX("crm-recur-edit-replication-block"),"change",{tag:"select"},e);BX.bindDelegate(BX("crm-recur-edit-replication-block"),"change",{tag:"input",attr:{type:"checkbox"}},e);BX.bindDelegate(BX("crm-recur-edit-replication-block"),"change",{tag:"input",attr:{type:"radio"}},e);this.bindInstantChange(BX("daily-interval-day"),e);this.bindInstantChange(BX("daily-interval-month"),e);this.bindInstantChange(BX("weekly-interval-week"),e);BX.bind(BX("monthly-day-num"),"change",t);this.bindInstantChange(BX("monthly-day-num"),e);this.bindInstantChange(BX("monthly-month-num-1"),e);this.bindInstantChange(BX("monthly-month-num-2"),e);this.bindInstantChange(BX("yearly-day-num"),e);BX.bind(BX("yearly-interval-day"),"change",t);BX.bind(BX("yearly-month-1"),"change",t);this.bindInstantChange(BX("yearly-interval-day"),e);this.bindInstantChange(BX("deal-count-before"),e);this.bindInstantChange(BX("deal-datepicker-before"),e);BX.bind(BX("daily-interval-day"),"change",BX.delegate(i,this));BX.bind(BX("monthly-month-num-1"),"change",BX.delegate(i,this));BX.bind(BX("monthly-month-num-2"),"change",BX.delegate(i,this));BX.bind(BX("weekly-interval-week"),"change",BX.delegate(i,this));this.bindInstantChange(BX("end-times"),e);this.bindInstantChange(BX("datepicker-display-start"),e);this.bindInstantChange(BX("datepicker-display-end"),e)};this.bindInvoiceEvents=function(){BX.addCustomEvent("RecurringInvoiceClientDataList",BX.delegate(function(e,t){this.changeClientData(e,t)},this));BX.bind(BX("crm-recur-create-mail-template-link"),"click",BX.delegate(function(){this.onMailTemplateCreateClick()},this));BX.bind(BX("crm-recurring-email").parentNode,"click",BX.delegate(function(){if(!this.existUserMail){BX("crm-recurring-empty-owner-email").innerHTML=BX.message("CRM_RECURRING_EMPTY_OWNER_EMAIL1")}else if(BX("crm-recurring-empty-owner-email").innerHTML!=""){BX("crm-recurring-empty-owner-email").innerHTML=""}},this));BX.bindDelegate(BX("period-type-selector"),"click",{className:"period-type-option"},BX.proxy(function(e){this.onSetPeriodValue(e.target)},this));this.toggleMailSender()};this.bindDealEvents=function(){};this.onMailTemplateCreateClick=function(){var e=this.templateUrl;var t=(this.context+"_"+BX.util.getRandomString(6)).toLowerCase();if(e===""||t===""){return}t=(t+"_"+BX.util.getRandomString(6)).toLowerCase();var i={ENTITY_TYPE_ID:this.entityTypeId,external_context:t};e=BX.util.add_url_param(e,i);if(!this._externalRequestData){this._externalRequestData={}}this._externalRequestData[t]={context:t};BX.SidePanel.Instance.open(e,{cacheable:false,width:1080});if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}};this.onExternalEvent=function(e){if(this._readOnly){return}var t=BX.type.isNotEmptyString(e["key"])?e["key"]:"";var i=BX.type.isPlainObject(e["value"])?e["value"]:{};var a=BX.type.isNotEmptyString(i["context"])?i["context"]:"";if(t==="onCrmMailTemplateCreate"&&this._externalRequestData&&BX.type.isPlainObject(this._externalRequestData[a])){if(i.templateId>0&&(i.entityType>0?i.entityType==this.entityTypeId:true)){var n=BX.create("option",{props:{value:i.templateId,text:i.templateTitle}});BX("email_template").appendChild(n);BX("email_template").selectedIndex=BX("email_template").options.length-1;if(BX("email_template").disabled){BX("email_template").removeAttribute("disabled");BX("email_template").parentNode.classList.remove("disabled")}}delete this._externalRequestData[a]}};this.getCurrentPeriod=function(){return this.getValueString("period")};this.moreNullValue=function(e){e.target.value=e.target.value>0?parseInt(e.target.value):1};this.onSetPeriodValue=function(e){var t=BX.data(e,"type");if(BX.util.in_array(t,[this.constants.PERIOD_DAILY,this.constants.PERIOD_WEEKLY,this.constants.PERIOD_MONTHLY,this.constants.PERIOD_YEARLY])){var i=BX.findChildrenByClassName(e.parentNode,"active-recur");if(i[0]){BX.removeClass(i[0],"active-recur")}BX.addClass(e,"active-recur");BX("period").value=t;this.onPeriodChange()}};this.getDays=function(e){return e===2?28:30+(e>7?e+1:e)%2};this.onChangeNumDay=function(){var e=this.getCurrentPeriod();if(e==3){t=31;target=BX("monthly-day-num")}else if(e==4){month=this.getValueInt("yearly-month-1");var t=this.getDays(month);target=BX("yearly-interval-day")}var i=parseInt(target.value);if(i<=0||isNaN(i)){target.value=1}else if(i>t){target.value=t}else{target.value=i}};this.setConstraintPanelHeight=function(e){var t=BX("panel-"+e);if(t){var i=BX.pos(t).height;BX("panel").style.height=i+"px"}};this.onPeriodChange=function(){var e=this.getCurrentPeriod();if(this.prevPeriod!=e){var t=BX("panel-period-"+this.prevPeriod);var i=BX("panel-period-"+e);if(t&&i){this.setConstraintPanelHeight(this.prevPeriod);BX.addClass(t,"nodisplay");BX.removeClass(i,"nodisplay");this.setConstraintPanelHeight(e);this.prevPeriod=e}}this.onUpdateHint()};this.onUpdateHint=function(){if(this.entityTypeId==this.constants.C_CRM_OWNER_TYPE_INVOICE){var e={PERIOD:this.getValueString("period"),DAILY_INTERVAL_DAY:this.getValueInt("daily-interval-day"),DAILY_WORKDAY_ONLY:this.getSelectedControlValues("workday-only-select")[0],DAILY_MONTH_INTERVAL:this.getValueInt("daily-interval-month"),WEEKLY_INTERVAL_WEEK:this.getValueInt("weekly-interval-week"),WEEKLY_WEEK_DAYS:this.getWeekDays(),MONTHLY_INTERVAL_DAY:this.getValueInt("monthly-day-num"),MONTHLY_MONTH_NUM_1:this.getValueInt("monthly-month-num-1"),MONTHLY_WORKDAY_ONLY:this.getSelectedControlValues("monthly-only-select")[0],MONTHLY_TYPE:this.getSelectedControlValues("monthly-type")[0],MONTHLY_WEEKDAY_NUM:this.getValueInt("monthly-week-day-num"),MONTHLY_WEEK_DAY:this.getValueInt("monthly-week-day"),MONTHLY_MONTH_NUM_2:this.getValueInt("monthly-month-num-2"),YEARLY_TYPE:this.getSelectedControlValues("yearly-type")[0],YEARLY_INTERVAL_DAY:this.getValueInt("yearly-interval-day"),YEARLY_MONTH_NUM_1:this.getValueInt("yearly-month-1"),YEARLY_WEEK_DAY_NUM:this.getValueInt("yearly-week-day-num"),YEARLY_WORKDAY_ONLY:this.getSelectedControlValues("yearly-only-select")[0],YEARLY_WEEK_DAY:this.getValueInt("yearly-week-day"),YEARLY_MONTH_NUM_2:this.getValueInt("yearly-month-2"),START_DATE:this.getValueString("datepicker-display-start"),END_DATE:this.getValueString("datepicker-display-end"),TIMES:this.getValueInt("end-times"),REPEAT_TILL:this.getRepeatTill()}}else{var e={EXECUTION_TYPE:this.getSelectedControlValues("selected-deal-type")[0],PERIOD_DEAL:this.getSelectedControlValues("period-deal-select")[0],DEAL_COUNT_BEFORE:this.getValueInt("deal-count-before"),DEAL_DATEPICKER_BEFORE:this.getValueString("deal-datepicker-before"),DEAL_TYPE_BEFORE:this.getSelectedControlValues("deal-type-before-select")[0],START_DATE:this.getValueString("datepicker-display-start"),END_DATE:this.getValueString("datepicker-display-end"),TIMES:this.getValueInt("end-times"),REPEAT_TILL:this.getRepeatTill()}}var t=BX("hint");if(t){t.innerHTML=this.makeHintText(e)}this.updateExecutionHint(e)};this.updateExecutionHint=function(e){BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{START_DATE:this.getValueString("datepicker-display-start"),PARAMS:e,ENTITY_TYPE:this.entityTypeId,LAST_EXECUTION:this.lastExecution},onsuccess:BX.delegate(this.setExecutionHTML,this)})};this.setExecutionHTML=function(e){if(e.RESULT.NEXT_DATE!==undefined){BX("next-data-hint").innerHTML=BX.message("NEXT_EXECUTION_"+this.entityTypeName+"_HINT").replace("#DATE_EXECUTION#",e.RESULT.NEXT_DATE)}};this.makeInvoiceHintMessage=function(e){var t=null;var i="";var a=BX.message("LANGUAGE_ID");var n="";var s="";if(e.PERIOD==this.constants.PERIOD_DAILY){var r=e.DAILY_INTERVAL_DAY>1?e.DAILY_INTERVAL_DAY+" ":"";if(e.DAILY_WORKDAY_ONLY=="Y"){i=BX.message("CRM_RECURRING_HINT_ELEMENT_DAY_MASK_WORK").replace("#DAY_NUMBER#",r)}else{i=BX.message("CRM_RECURRING_HINT_ELEMENT_DAY_MASK").replace("#DAY_NUMBER#",r)}}else if(e.PERIOD==this.constants.PERIOD_WEEKLY){t=e.WEEKLY_INTERVAL_WEEK>1?e.WEEKLY_INTERVAL_WEEK+" ":"";if(e.WEEKLY_WEEK_DAYS.length==7){weekdays=BX.message("CRM_RECURRING_HINT_WEEKDAY_EVERY_DAY")}else{var l=[];for(var E=0;E<e.WEEKLY_WEEK_DAYS.length;E++){l.push(BX.message("CRM_RECURRING_HINT_WEEKDAY_WD_"+e.WEEKLY_WEEK_DAYS[E]))}weekdays=l.join(", ")}i=BX.message("CRM_RECURRING_HINT_ELEMENT_WEEKDAY_MASK").replace("#WEEK_NUMBER#",t).replace("#LIST_WEEKDAY_NAMES#",weekdays)}else if(e.PERIOD==this.constants.PERIOD_MONTHLY){var _=null;var c="";if(e.MONTHLY_TYPE==1){t=parseInt(e.MONTHLY_INTERVAL_DAY)>0?parseInt(e.MONTHLY_INTERVAL_DAY):1;_=e.MONTHLY_MONTH_NUM_1;if(e.MONTHLY_WORKDAY_ONLY=="Y")i=BX.message("CRM_RECURRING_HINT_ELEMENT_MONTH_MASK_1_WORK").replace("#DAY_NUMBER#",t).replace("#MONTH_NUMBER#",_>1?_+" ":"");else i=BX.message("CRM_RECURRING_HINT_ELEMENT_MONTH_MASK_1").replace("#DAY_NUMBER#",t).replace("#MONTH_NUMBER#",_>1?_+" ":"")}else{if(a=="ru"||a=="ua"){s=this.getWeekDayGender(e.MONTHLY_WEEK_DAY)}n=this.getWeekDayName(e.MONTHLY_WEEK_DAY);t=BX.message("CRM_RECURRING_HINT_WEEKDAY_NUMBER_"+e.MONTHLY_WEEKDAY_NUM+s);c=BX.message("CRM_RECURRING_HINT_EACH"+s);_=e.MONTHLY_MONTH_NUM_2;i=BX.message("CRM_RECURRING_HINT_MONTHLY_EXT_TYPE_2").replace("#EACH#",c).replace("#WEEKDAY_NUMBER#",t).replace("#WEEKDAY_NAME#",n).replace("#MONTH_NUMBER#",_>1?_+" ":"")}}else{var o="";if(e.YEARLY_TYPE==1){t=parseInt(e.YEARLY_INTERVAL_DAY)>0?parseInt(e.YEARLY_INTERVAL_DAY):1;o=BX.message("CRM_RECURRING_HINT_MONTH_"+e.YEARLY_MONTH_NUM_1);if(e.YEARLY_WORKDAY_ONLY=="Y")i=BX.message("CRM_RECURRING_HINT_YEARLY_EXT_TYPE_1_WORKDAY").replace("#DAY_NUMBER#",t).replace("#MONTH_NAME#",o);else i=BX.message("CRM_RECURRING_HINT_YEARLY_EXT_TYPE_1").replace("#DAY_NUMBER#",t).replace("#MONTH_NAME#",o)}else{if(a=="ru"||a=="ua"){s=this.getWeekDayGender(e.YEARLY_WEEK_DAY)}n=this.getWeekDayName(e.YEARLY_WEEK_DAY);t=BX.message("CRM_RECURRING_HINT_WEEKDAY_NUMBER_"+e.YEARLY_WEEK_DAY_NUM+s);c=BX.message("CRM_RECURRING_HINT_EACH"+s);o=BX.message("CRM_RECURRING_HINT_MONTH_"+e.YEARLY_MONTH_NUM_2);i=BX.message("CRM_RECURRING_HINT_YEARLY_EXT_TYPE_2").replace("#EACH#",c).replace("#WEEKDAY_NUMBER#",t).replace("#WEEKDAY_NAME#",n).replace("#MONTH_NAME#",o)}}return i};this.makeDealHintMessage=function(e){var t="";if(e.EXECUTION_TYPE==this.constants.MANAGER_SINGLE_EXECUTION){var i=parseInt(e.DEAL_COUNT_BEFORE);if(i===0){t=e.DEAL_DATEPICKER_BEFORE||BX.message("CRM_RECURRING_HINT_TODAY")}else if(e.DEAL_DATEPICKER_BEFORE==""){t=BX.message("CRM_RECURRING_HINT_TODAY")}else{var a=e.DEAL_TYPE_BEFORE;var n=this.getMessagePlural(i,"CRM_RECURRING_HINT_"+a);var s=e.DEAL_DATEPICKER_BEFORE||"";if(s.length>0){dateMessage=BX.message("CRM_RECURRING_HINT_BEFORE_DATE").replace("#DATE#",e.DEAL_DATEPICKER_BEFORE||"")}else{dateMessage=""}t=BX.message("CRM_RECURRING_HINT_A_FEW_DAYS_BEFORE_DATE").replace("#COUNT_ELEMENT#",i).replace("#TYPE_ELEMENT#",n).replace("#BEFORE_DATE#",dateMessage)}}else{t=BX.message("CRM_RECURRING_HINT_EVERY_DEAL_"+parseInt(e.PERIOD_DEAL))}return t};this.makeHintText=function(e){var t="";var i="";var a="";if(this.entityTypeId==this.constants.C_CRM_OWNER_TYPE_INVOICE){t=this.makeInvoiceHintMessage(e)}else{t=this.makeDealHintMessage(e)}var n=e.TIMES;if(e.EXECUTION_TYPE==this.constants.MANAGER_SINGLE_EXECUTION){a=""}else if(e.START_DATE!=""){var s=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")),BX.parseDate(e.START_DATE,true),false,true);a=BX.message("CRM_RECURRING_HINT_START_DATE").replace("#DATETIME#",s)}else{a=BX.message("CRM_RECURRING_HINT_START_EMPTY")}var r=this.getRepeatTill();if(e.EXECUTION_TYPE==this.constants.MANAGER_SINGLE_EXECUTION){i=""}else if(e.END_DATE!=""&&r==this.constants.REPEAT_TILL_DATE){i=BX.message("CRM_RECURRING_HINT_END").replace("#DATETIME#",e.END_DATE)}else if(n>0&&r==this.constants.REPEAT_TILL_TIMES){i=BX.message("CRM_RECURRING_HINT_END_TIMES").replace("#TIMES#",n).replace("#TIMES_PLURAL#",this.getMessagePlural(n,"CRM_RECURRING_HINT_END_CONSTRAINT_TIMES"))}else{i=BX.message("CRM_RECURRING_HINT_END_NONE")}return BX.message("CRM_RECURRING_"+this.entityTypeName+"_HINT_BASE").replace("#ELEMENT#",t).replace("#START#",a).replace("#END#",i)};this.getWeekDayName=function(e){var t="";if(BX.message("LANGUAGE_ID")=="ru"||BX.message("LANGUAGE_ID")=="ua"){t=this.getWeekDayGender(e)}return BX.message("CRM_RECURRING_HINT_WEEKDAY_WD_"+e+(t=="_F"?"_ALT":""))};this.getValueString=function(e){var t=BX(e);if(BX.type.isElementNode(t)){return BX.util.htmlspecialchars(t.value.toString())}return""};this.getValueInt=function(e){var t=BX(e);if(BX.type.isElementNode(t)){var i=parseInt(t.value.toString());if(isNaN(i)){return 0}return i}return 0};this.getMessagePlural=function(e,t){var i,a;a=BX.message("LANGUAGE_ID");e=parseInt(e);if(e<0){e=-1*e}if(a){switch(a){case"de":case"en":i=e!==1?1:0;break;case"ru":case"ua":i=e%10===1&&e%100!==11?0:e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?1:2;break;default:i=1;break}}else{i=1}if(BX.type.isArray(t)){return t[i]}return BX.message(t+"_PLURAL_"+i)};this.getSelectedControlValues=function(e){var t=[];var i=document.getElementsByClassName(e);for(var a in i){if(i[a].checked||i[a].selected){if(t.indexOf(i[a].value)===-1)t.push(i[a].value)}}return t};this.getRepeatTill=function(){var e=this.getSelectedControlValues("selected-end");if(typeof e[0]=="undefined"){return this.constants.REPEAT_TILL_ENDLESS}return e[0]};this.getWeekDays=function(){var e=this.getSelectedControlValues("weekly-week-days");if(e.length==0){e.push(this.constants.MONDAY);document.getElementsByClassName("weekly-week-days")[0].checked=true}else{for(var t=0;t<e.length;t++){e[t]=parseInt(e[t])}}return e};this.getWeekDayGender=function(e){if(e==this.constants.MONDAY||e==this.constants.TUESDAY||e==this.constants.THURSDAY){return"_M"}if(e==this.constants.SUNDAY){return""}return"_F"}}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:96:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/script.min.js?1544127401100018";s:6:"source";s:75:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Crm");if(typeof BX.setSelectValue==="undefined"){BX.setSelectValue=function(t,e){var i,s;var n=false;var r=!!t.getAttribute("multiple");if(!(e instanceof Array))e=[e];for(i=0;i<t.options.length;i++){for(s in e){if(t.options[i].value==e[s]){if(!n){n=true;t.selectedIndex=i}t.options[i].selected=true;break}}if(!r&&n)break}}}if(typeof BX.setTextContent==="undefined"){BX.setTextContent=function(t,e){if(t){if(t.textContent!==undefined)t.textContent=e;else t.innerText=e}}}if(typeof BX.CrmProductEditor==="undefined"){BX.CrmDiscountType={undefined:0,monetary:1,percentage:2};BX.CrmProductEditor=function(){this._id="";this._settings={};this._serviceUrl="";this._currencyId="";this._currencyFormat="# ?";this._clientTypeName="";this._products=[];this._dlgId="";this._addedProduct=null;this._deletedProduct=null;this._lastRowNumber=0;this._productCreateDialog=null;this._calculateTotalsTimer=null;this._locationID=0;this._topButtons=[];this._modeButton=null;this._discountExists=false;this._taxExists=false;this._viewMode=true;this._form=null;this._placeHolder=null;this._dragContainer=null;this._choiceBtnEnabled=false;this._overlay=null;this._hasLayout=false};BX.CrmProductEditor.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"CrmProductEditor: could not find service URL."}var i=this.isReadOnly();this._viewMode=!this.getSetting("initEditable",false)||i;this._locationID=this.isLDTaxAllowed()?this.getSetting("locationID",0):0;if(this.isLDTaxAllowed())BX.addCustomEvent("CrmProductRowSetLocation",BX.delegate(this._handleChangeLocation,this));var s=typeof this._settings["items"]!="undefined"?this._settings["items"]:[];for(var n=0;n<s.length;n++){var r=s[n];var a=r["rowID"];var o=r["settings"];o["readOnly"]=i;o["fields"]=this.getSetting("productFields",[]);this.getNextRowNumber();this._products.push(BX.CrmProduct.create(o,document.getElementById(a),this))}var l=document.getElementById(this.getSetting("choiceBtnID",""));if(l){this._topButtons.push(l);BX.bind(l,"click",BX.delegate(this.handleChoiceProductButtonClick,this));this._choiceBtnEnabled=true}var h=this.getSetting("addBtnID",""),d=BX(h);if(d){BX.bind(d,"click",BX.delegate(this._handleAddBtnClick,this));this._topButtons.push(d)}var u=document.getElementById(this.getSetting("modeBtnID",""));if(u){this._modeButton=u;BX.bind(u,"click",BX.delegate(this.handleSwitchModeButtonClick,this))}this._currencyId=this.getSetting("currencyID","");this._currencyFormat=this.getSetting("currencyFormat","# ?");this._clientSelectorId=this.getSetting("clientSelectorId","CLIENT");this._clientTypeName=this.getSetting("clientTypeName","");BX.addCustomEvent("CrmClientSelectorChange",BX.delegate(this._handleEntitySelectorChangeValue,this));var c=this.getSetting("formID","");var _=BX.type.isNotEmptyString(c)?BX("form_"+c):null;if(_){this.setForm(_)}var T=BX(this.getSetting("addRowBtnID",""));if(T){BX.bind(T,"click",BX.delegate(this.handleProductRowAdd,this))}BX.addCustomEvent("CrmHandleShowProductEditor",BX.delegate(this._onSelectTab,this));BX.addCustomEvent("CrmProductSearchDialog_SelectProduct",BX.delegate(this.handleProductChoiceById,this));BX.addCustomEvent("InitiateInvoiceSumTotalChange",BX.delegate(this._handleRequestFromInvoiceOwner,this));BX.addCustomEvent("InvoiceAjaxSubmitResponse",BX.delegate(this._handleInvoiceAjaxSubmitResponse,this));this._discountExists=this.getSetting("_discountExistsInit",false);this._taxExists=this.getSetting("_taxExistsInit",false);this._dragContainer=BX.CrmProdoctRowListDragContainer.create(this.getId(),{editor:this,node:this.getTable()});this._dragContainer.addDragFinishListener(BX.delegate(this._onItemDrop,this));if(BX.prop.getBoolean(this._settings,"initLayout",true)){this.layout()}BX.onCustomEvent(window,"ProductRowEditorCreated",[this])},_handleAddBtnClick:function(){var t,e;t=BX.clone(this._settings["productCreateDialogSettings"]);t["initialControl"]=BX(this.getSetting("addBtnID",""));t["productAdditionHandler"]=BX.delegate(this.handleProductAdd,this);e=new BX.CrmProductCreateDialog(t);e.show()},_handleRequestFromInvoiceOwner:function(){BX.onCustomEvent("InvoiceSumTotalChange",[this])},_handleInvoiceAjaxSubmitResponse:function(t){if(t){var e=t["ob"];var i=t["info"];if(e&&e===this&&i){if(typeof i["TOTALS"]!="undefined"){this.refreshTotals(i["TOTALS"])}if(typeof i["TAX_LIST"]!="undefined"){this.setSetting("LDTaxes",i["TAX_LIST"]);this.refreshTaxList()}}}},getNextRowNumber:function(){return++this._lastRowNumber},getId:function(){return this._id},isReadOnly:function(){return this.getSetting("readOnly",false)},setReadOnly:function(t){var e=this.getSetting("readOnly",false);if(t!==e){this.setSetting("readOnly",t);if(t!==this._viewMode)this.toggleMode();this.layout()}},isInvoiceMode:function(){return this.getSetting("invoiceMode",false)},isViewMode:function(){return this._viewMode},getForm:function(){return this._form},setForm:function(t){if(this._form===t){return}this._form=t;if(!this._form){return}var e=this.getSetting("dataFieldName","PRODUCT_ROW_DATA");var i=BX.findChild(this._form,{tagName:"input",attr:{name:e}},true,false);if(!i){this._form.appendChild(BX.create("input",{attrs:{type:"hidden",name:e}}))}var s=e+"_SETTINGS";var n=BX.findChild(t,{tagName:"input",attr:{name:s}},true,false);if(!n){this._form.appendChild(BX.create("input",{attrs:{type:"hidden",name:s}}))}BX.bind(this._form,"submit",BX.delegate(this.handleFormSubmit,this))},getTable:function(){var t=this.getSetting("productContainerID","");return BX.type.isNotEmptyString(t)?BX(t):null},getCurrencyElement:function(){var t=this.getForm();return t?BX.findChild(t,{tag:"select",attr:{name:"CURRENCY_ID"}},true,false):null},getExchRateElement:function(){var t=this.getForm();return t?BX.findChild(t,{tag:"input",attr:{name:"EXCH_RATE"}},true,false):null},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},handleBeforeSearch:function(t){if(t["entityType"]=="product"){t["postData"]["ENABLE_SEARCH_BY_ID"]="N";if(this._currencyId!==""){t["postData"]["CURRENCY_ID"]=this._currencyId}var e=this.getExchRateElement();if(e){var i=e.value;t["postData"]["EXCH_RATE"]=BX.type.isNotEmptyString(i)?parseFloat(i):0}t["postData"]["ENABLE_RAW_PRICES"]=!!this.getSetting("enableRawCatalogPricing",true)?"Y":"N"}},productsToJson:function(){var t="";if(this._products.length>0){for(var e=0;e<this._products.length;e++){t+=(t.length>0?", ":"")+this._products[e].toJson()}t="["+t+"]"}return t},handleFormSubmit:function(){if(!this._form){return}var t=this.getSetting("dataFieldName","PRODUCT_ROW_DATA");var e=BX.findChild(this._form,{tagName:"input",attr:{name:t}},true,false);var i=BX.findChild(this._form,{tagName:"input",attr:{name:t+"_SETTINGS"}},true,false);if(!e){return}if(!this._hasLayout&&!this.getSetting("enableSubmitWithoutLayout",true)){e.value="";if(i){i.value=""}this._form.appendChild(BX.create("input",{props:{type:"hidden",name:t+"_INVALIDATE",value:"Y"}}));return}BX.remove(BX.findChild(this._form,{tagName:"input",attr:{name:t+"_INVALIDATE"}},true,false));if(this._hasLayout){this.cleanProductRows();this.resortProducts()}e.value=this.productsToJson();if(i){i.value='{"ENABLE_DISCOUNT": "'+(this.isDiscountEnabled()?"Y":"N")+'",'+'"ENABLE_TAX": "'+(this.isTaxEnabled()?"Y":"N")+'"}'}},handleChoiceProductButtonClick:function(t){if(!this._choiceBtnEnabled)return;this._choiceBtnEnabled=false;this.createOverlay(995);var e=document.getElementById(this.getSetting("choiceBtnID",""));if(e)BX.addClass(e,"webform-small-button-wait");var i="crm_productrow_list";var s=this.getSetting("jsEventsManagerId","");var n=BX.CrmProductSearchDialogWindow.create({content_url:"/bitrix/components/bitrix/crm.product_row.list/product_choice_dialog.php"+"?caller="+i+"&JS_EVENTS_MANAGER_ID="+BX.util.urlencode(s)+"&sessid="+BX.bitrix_sessid(),closeWindowHandler:BX.delegate(this.handleChoiceProductDialogClose,this),showWindowHandler:BX.delegate(this.handleChoiceProductDialogShow,this),jsEventsManagerId:s,height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),minHeight:500,minWidth:800,draggable:true,resizable:true});n.show()},handleChoiceProductDialogClose:function(){this._choiceBtnEnabled=true},handleChoiceProductDialogShow:function(){var t=document.getElementById(this.getSetting("choiceBtnID",""));if(t)BX.removeClass(t,"webform-small-button-wait");this.removeOverlay()},createOverlay:function(t){t=parseInt(t);if(!this._overlay){var e=BX.GetWindowScrollSize();this._overlay=document.body.appendChild(BX.create("DIV",{style:{position:"absolute",top:"0px",left:"0px",zIndex:t||parseInt(this.DIV.style.zIndex)-2,width:e.scrollWidth+"px",height:e.scrollHeight+"px"}}));BX.unbind(window,"resize",BX.proxy(this._resizeOverlay,this));BX.bind(window,"resize",BX.proxy(this._resizeOverlay,this))}},removeOverlay:function(){if(this._overlay&&this._overlay.parentNode){this._overlay.parentNode.removeChild(this._overlay);BX.unbind(window,"resize",BX.proxy(this._resizeOverlay,this));this._overlay=null}},_resizeOverlay:function(){var t=BX.GetWindowScrollSize();this._overlay.style.width=t.scrollWidth+"px"},handleSwitchModeButtonClick:function(){if(!this._viewMode){BX.showWait(this.getSetting("containerID",""),BX.CrmProductEditorMessages.saving);this.cleanProductRows();this.resortProducts();this.saveProductRows()}else{this.toggleMode();if(this.getProductCount()===0)this.productRowAdd()}},handleProductChoice:function(t,e){e=!!e;var i=typeof t["product"]!="undefined"&&typeof t["product"][0]!="undefined"?t["product"][0]:null;if(!i){return}var s=typeof i["customData"]!=="undefined"?i["customData"]:{};var n=typeof s["measure"]!=="undefined"?s["measure"]:{};var r={id:i["id"],name:i["title"],quantity:1,price:typeof s["price"]!="undefined"?parseFloat(s["price"]):0,customized:false,measureCode:typeof n["code"]!=="undefined"?parseInt(n["code"]):0,measureName:typeof n["name"]!=="undefined"?n["name"]:"",tax:typeof s["tax"]!=="undefined"?s["tax"]:{}};if(this._viewMode)this.toggleMode();this._addItem(r,true);if(!e)this.focusLastRow();obCrm[this._dlgId].ClearSelectItems()},handleProductChoiceById:function(t){t=parseInt(t);if(t<=0){return}var e=this.getCurrencyId();var i=this.getSetting("productSearchUrl","");BX.ajax({url:i,method:"POST",dataType:"json",data:{MODE:"SEARCH",RESULT_WITH_VALUE:"Y",CURRENCY_ID:e,ENABLE_RAW_PRICES:"Y",ENABLE_SEARCH_BY_ID:"N",MULTI:"N",VALUE:"["+t+"]",LIMIT:1},onsuccess:BX.delegate(this.onProductChoiceByIdSuccess,this),onfailure:BX.delegate(this.onProductChoiceByIdFailure,this)})},onProductChoiceByIdSuccess:function(t){var e;if(t&&t["data"]){e=t["data"];if(e[0]){e={product:[e[0]]};this.handleProductChoice(e,true)}}},onProductChoiceByIdFailure:function(t){},handleProductSearchSelect:function(t,e){if(!t||!e){return}var i=typeof e["customData"]!=="undefined"?e["customData"]:{};var s=typeof i["measure"]!=="undefined"?i["measure"]:{};var n={id:e["id"],name:e["title"],quantity:1,price:typeof i["price"]!="undefined"?parseFloat(i["price"]):0,customized:false,measureCode:typeof s["code"]!=="undefined"?parseInt(s["code"]):0,measureName:typeof s["name"]!=="undefined"?s["name"]:"",tax:typeof i["tax"]!=="undefined"?i["tax"]:{}};this._setItem(t,n)},handleProductDeletion:function(t){if(!window.confirm(BX.CrmProductEditorMessages["deletionConfirm"])){return false}this._deleteProduct(t);this.calculateTotalsDelayed();return true},_onDeleteItemRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(this._deletedProduct){this._deleteProduct(this._deletedProduct);this._deletedProduct=null}this.calculateTotalsDelayed()},_ondeleteItemRequestFailure:function(t){this._processAjaxError(t)},handleProductAdd:function(t){var e=typeof t["product"]!="undefined"&&typeof t["product"][0]!="undefined"?t["product"][0]:null;if(!e){return}var i=typeof e["customData"]!=="undefined"?e["customData"]:{};var s=typeof i["measure"]!=="undefined"?i["measure"]:{};var n={id:e["id"],name:e["title"],quantity:1,price:typeof i["price"]!="undefined"?parseFloat(i["price"]):0,customized:false,measureCode:typeof s["code"]!=="undefined"?parseInt(s["code"]):0,measureName:typeof s["name"]!=="undefined"?s["name"]:"",tax:typeof i["tax"]!=="undefined"?i["tax"]:{}};if(this._viewMode)this.toggleMode();this._addItem(n,true);this.focusLastRow()},handleProductRowAdd:function(t){this.productRowAdd();return BX.PreventDefault(t)},productRowAdd:function(){var t={id:0,name:"",quantity:1,price:0,customized:true};if(this._viewMode)this.toggleMode();this._addItem(t,false);this.focusLastRow()},handleProductFocusChange:function(t,e){BX.onCustomEvent("onProductEditorFocusChange",[this,e])},focusLastRow:function(){var t=this._products.length,e,i,s;if(t>0){e=this._products[t-1];this.focusProductRow(e)}},focusProductRow:function(t){if(t){var e=t._container;if(e){var i=BX(e.id+"_PRODUCT_NAME");if(i){i.focus()}}}},getProducts:function(){return this._products},createPlaceHolder:function(t){var e=t["id"];var i=t["index"];var s=this.getTable();if(i<0){i=this._products.length}if(this._placeHolder){if(this._placeHolder.getProductIndex()===i){return this._placeHolder}s.deleteRow(this._placeHolder.getNode().rowIndex);this._placeHolder=null}this._placeHolder=BX.CrmProductRowListPlaceholder.create({editor:this,node:s.insertRow(i+1),productId:e,productIndex:i});this._placeHolder.layout();return this._placeHolder},getPlaceHolder:function(){return this._placeHolder},removePlaceHolder:function(){if(this._placeHolder){var t=this.getTable();t.deleteRow(this._placeHolder.getNode().rowIndex);this._placeHolder=null}},processDraggedItemDrop:function(t){if(this._viewMode){return}var e=t.getContextData();var i=BX.type.isNotEmptyString(e["contextId"])?e["contextId"]:"";if(i!==BX.CrmProdoctRowListDragItem.contextId){return}var s=typeof e["product"]!=="undefined"?e["product"]:null;if(!s){return}var n=this.getTable();var r=this.getPlaceHolder();if(r){n.tBodies[0].insertBefore(s.getContainer(),r.getNode())}else{n.tBodies[0].appendChild(s.getContainer())}var a=this.getProductIndex(s);var o=r.getProductIndex();if(a>=0&&o>=0&&a!==o){this._products.splice(a,1);if(a<o){o--}this._products.splice(o,0,s)}this._renumProducts(0);this.resortProducts()},_onItemDrop:function(t,e,i,s){this.processDraggedItemDrop(e)},_prepareProductSettings:function(t,e){e=e&&e instanceof BX.CrmProduct?e:null;var i=this._products.length;var s=parseInt(t["id"]);if(isNaN(s)){s=0}var n=BX.type.isNotEmptyString(t["name"])?t["name"]:"";var r=parseFloat(t["quantity"]);if(isNaN(r)){r=1}var a=parseFloat(t["price"]);if(isNaN(a)){a=0}var o=parseInt(t["measureCode"]);var l=BX.type.isNotEmptyString(t["measureName"])?t["measureName"]:"";if(isNaN(o)||o<0||l===""){var h=this.getSetting("defaultMeasure",null);if(h){o=h["CODE"];l=h["SYMBOL"]}else{o=0;l=""}}var d=typeof t["discount"]!=="undefined"?t["discount"]:null;if(d){var u=typeof d["discountType"]!=="undefined"?parseInt(d["discountType"]):BX.CrmDiscountType.percentage;if(u!==BX.CrmDiscountType.percentage&&u!==BX.CrmDiscountType.monetary){u=BX.CrmDiscountType.percentage}var c=typeof d["discountRate"]!=="undefined"?BX.CrmProduct.round(parseFloat(d["discountRate"]),2):0;var _=typeof d["discountSum"]!=="undefined"?BX.CrmProduct.round(parseFloat(d["discountSum"]),2):0}var T={PRODUCT_ID:s,PRODUCT_NAME:n,QUANTITY:r,MEASURE_CODE:o,MEASURE_NAME:l,PRICE:a,PRICE_EXCLUSIVE:a};if(d){T["DISCOUNT_TYPE_ID"]=u;T["DISCOUNT_RATE"]=c;T["DISCOUNT_SUM"]=_}var g=!!t["customized"];if(this.isTaxAllowed()){var f=typeof t["tax"]!=="undefined"?t["tax"]:{};var C=typeof f["id"]!=="undefined"?parseInt(f["id"]):0;var p=C>0?this.getTaxById(C):null;if(!p){p=this.getSetting("defaultTax",null)}T["TAX_RATE"]=p?BX.CrmProduct.round(parseFloat(p["VALUE"]),2):0;var E=typeof f["included"]!=="undefined"?!!f["included"]:false;if(E){T["PRICE_EXCLUSIVE"]=BX.CrmProduct.round(BX.CrmProduct.calculateExclusivePrice(T["PRICE"],T["TAX_RATE"]),2)}else{T["PRICE"]=BX.CrmProduct.round(BX.CrmProduct.calculateInclusivePrice(T["PRICE"],T["TAX_RATE"]),2)}if(i>0&&this.getSetting("taxUniform",true)){var I=this._products[i-1];if(I!==e||i>1){if(I===e)I=this._products[i-2];var m=I.isTaxIncluded();if(m!==E){E=m;g=true}}}T["TAX_INCLUDED"]=E}else{T["TAX_RATE"]=0;T["TAX_INCLUDED"]=false}T["CUSTOMIZED"]=g;var S=0;if(e){S=e.getSort()}else{for(var D=0;D<i;D++){var N=this._products[D].getSort();if(S<N)S=N}S+=10}T["SORT"]=S;T["readOnly"]=this.isReadOnly();T["fields"]=this.getSetting("productFields",[]);return T},_addItem:function(t,e){if(!!e)this._removeLonelyEmptyRow();var i=this.getTable();var s=this.getSetting("rowIdPrefix","");var n=BX(s+"#N#");var r=BX.clone(n,true);var a=this.getSetting("productFields",[]);var o=this._products.length;var l,h;l=this.getNextRowNumber();h=l-1;r.id=r.id.replace("#N#",h);r.className=l%2===0?"crm-items-table-even-row":"crm-items-table-odd-row";BX.findChildren(r,function(t){if(t&&BX.type.isElementNode(t)){if(t.id){var e=t.id;if(e&&e.indexOf("#N#")>=0)t.id=e.replace("#N#",h)}if(t.className==="crm-item-num")BX.setTextContent(t,(o+1).toString()+".")}},true);r.style.display="";i.tBodies[0].appendChild(r);var d=this._prepareProductSettings(t);var u=BX.CrmProduct.create(d,r,this);this._products[o++]=u;if(o===1)this.layout();else u.layout();BX.onCustomEvent(this,"productAdd",[{product:u}]);this.calculateTotalsDelayed()},_setItem:function(t,e){var i=this._prepareProductSettings(e,t);t.setSettings(i);t.layout();BX.onCustomEvent(this,"productSet",[{product:t}]);this.calculateTotalsDelayed()},_onAddItemRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(this._addedProduct){if(typeof t["PRODUCT_ROW"]!="undefined"){var e=t["PRODUCT_ROW"];if(typeof e["ID"]!="undefined"){this._addedProduct.setId(e["ID"])}}this._addedProduct=null}this.calculateTotalsDelayed()},_onAddItemRequestFailure:function(t){this._processAjaxError(t)},_removeLonelyEmptyRow:function(){var t,e;if(!this._viewMode){if(this._products.length===1&&this._products[0]instanceof BX.CrmProduct){e=BX.util.trim(this._products[0].getProductName());if(e===""){this._products[0].clean();this._deleteProduct(this._products[0])}}}},_deleteProduct:function(t){for(var e=0;e<this._products.length;e++){if(this._products[e]==t){this._products.splice(e,1);break}}if(this._products.length===0){BX.onCustomEvent(this,"sumTotalChange",["0.00",{TOTAL_SUM_FORMATTED:"",TOTAL_SUM_FORMATTED_SHORT:"",TOTAL_SUM:"0"}]);if(this.getSetting("initEditable",false)&&this.getSetting("hideModeButton",false))this.layoutElements(this._viewMode)}this._renumProducts(e);BX.onCustomEvent(this,"productRemove",[{product:t}])},_renumProducts:function(t){t=t?parseInt(t):0;for(var e=t;e<this._products.length;e++)this._products[e].setNumber(e+1)},_onSelectTab:function(t){if(t===this)BX.CrmProductEditor.arrangeColumns(this,true)},_onUpdateItemRequestSuccess:function(t){if(this._processAjaxError(t)){return}this.calculateTotalsDelayed()},_onUpdateItemRequestFailure:function(t){this._processAjaxError(t)},_onSaveProductsRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(BX.type.isArray(t["PRODUCT_ROW_IDS"])){var e=t["PRODUCT_ROW_IDS"];if(e.length===this._products.length){for(var i=0,s=e.length;i<s;i++){this._products[i].setId(e[i])}}}if(!this._viewMode)this.toggleMode();BX.closeWait();this.calculateTotalsDelayed()},_onSaveProductsRequestFailure:function(t){BX.closeWait();this._processAjaxError(t)},refreshTaxList:function(){var t=this.getSetting("LDTaxes",[]);var e=this.getSetting("taxValueID","total_tax");if(e){var i=BX(e);i=i&&i.parentNode?i.parentNode:null;i=i&&i.parentNode?i.parentNode:null;if(i){var s;var n=i.parentNode;if(n){if(t&&typeof t==="object"&&t.length>0){while(s=BX.findNextSibling(i,{tag:"tr",class:"crm-tax-value"})){r=s.sibling;n.removeChild(s)}var r=i.nextSibling;i.style.display="none";var a,o,l=!this.getSetting("hideAllTaxes",false)&&(this.isLDTaxAllowed()||this.isTaxAllowed()&&this.isTaxEnabled())?"":"none";for(var h=0;h<t.length;h++){a=BX.create("TR",{attrs:{class:"crm-view-table-total-value crm-tax-value"},children:[BX.create("TD",{children:[BX.create("NOBR",{text:BX.util.htmlspecialchars(t[h]["TAX_NAME"]+":")})]}),BX.create("TD",{children:[o=BX.create("STRONG",{attrs:{class:"crm-view-table-total-value"},html:t[h]["TAX_VALUE"]})]})]});if(a){if(l!=="")a.style.display=l;if(h===0){n.removeChild(i);o.setAttribute("id",e)}if(r)n.insertBefore(a,r);else n.appendChild(a)}}}}}}},calculateTotals:function(){var t=[];for(var e=0;e<this._products.length;e++){var i=this._products[e];i.saveSettings();var s=i.getProductId();var n={PRODUCT_ID:s,PRODUCT_NAME:i.getProductName(),QUANTITY:i.getQuantity(),DISCOUNT_TYPE_ID:i.getDiscountTypeId(),DISCOUNT_RATE:i.getDiscountRate(),DISCOUNT_SUM:i.getDiscountSum(),TAX_RATE:i.getTaxRate(),TAX_INCLUDED:i.isTaxIncluded()?"Y":"N",PRICE_EXCLUSIVE:i.getExclusivePrice(),PRICE:i.getPrice(),CUSTOMIZED:"Y"};t.push(n)}BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"CALCULATE_TOTALS",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),PRODUCTS:t,CURRENCY_ID:this._currencyId,CLIENT_TYPE_NAME:this.getClientTypeName(),SITE_ID:this.getSetting("siteId",""),LOCATION_ID:this._locationID,ALLOW_LD_TAX:this.isLDTaxAllowed()?"Y":"N",LD_TAX_PRECISION:this.getSetting("taxListPercentPrecision",2)},onsuccess:BX.delegate(this._onCalculateTotalsRequestSuccess,this),onfailure:BX.delegate(this._onCalculateTotalsRequestFailure,this)})},calculateTotalsDelayed:function(){if(this._calculateTotalsTimer)clearTimeout(this._calculateTotalsTimer);this._calculateTotalsTimer=setTimeout(BX.delegate(this._handleCalculateTotalsTimer,this),1e3)},_handleChangeLocation:function(t){var e=0,i=document.getElementsByName(t)[0];if(i&&BX.type.isElementNode(i)){e=i.value;this._locationID=e;this.calculateTotalsDelayed()}},_handleEntitySelectorChangeValue:function(t,e){var i=e["target"];if(i!=="primaryEntity"){return}var s=null;if(BX.type.isPlainObject(e["selectorInfo"])&&BX.type.isNotEmptyString(e["selectorInfo"]["id"])){s=e["selectorInfo"]["id"]}if(s!==this._clientSelectorId){return}var n=BX.type.isPlainObject(e["data"])?e["data"]:{};var r=BX.type.isNotEmptyString(n["primaryEntityTypeName"])?n["primaryEntityTypeName"]:"";var a=n["primaryEntityInfo"]instanceof BX.CrmEntityInfo?n["primaryEntityInfo"].getId():0;var o=this.getClientTypeName();var l=o;if(o===BX.CrmEntityType.names.company){if(r===BX.CrmEntityType.names.company&&a==0)l=BX.CrmEntityType.names.contact}else{if(r===BX.CrmEntityType.names.company&&a>0)l=BX.CrmEntityType.names.company;else l=BX.CrmEntityType.names.contact}if(o!==l){this.setClientTypeName(l);if(this.isLDTaxAllowed())this.calculateTotalsDelayed()}},_handleCalculateTotalsTimer:function(){this.calculateTotals()},_onCalculateTotalsRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(typeof t["TOTALS"]!="undefined"){this.refreshTotals(t["TOTALS"])}if(typeof t["LD_TAXES"]!="undefined"){this.setSetting("LDTaxes",t["LD_TAXES"]);this.refreshTaxList()}},refreshTotals:function(t){var e,i,s;s=BX(this.getSetting("TOTAL_BEFORE_DISCOUNT_ID","total_before_discount"));if(s){i=BX.type.isNotEmptyString(t["TOTAL_BEFORE_DISCOUNT_FORMATTED"])?t["TOTAL_BEFORE_DISCOUNT_FORMATTED"]:"";e=typeof t["TOTAL_BEFORE_DISCOUNT"]!="undefined"?parseFloat(t["TOTAL_BEFORE_DISCOUNT"]).toFixed(2):"0.00";s.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}s=BX(this.getSetting("TOTAL_DISCOUNT_ID","total_discount"));if(s){i=BX.type.isNotEmptyString(t["TOTAL_DISCOUNT_FORMATTED"])?t["TOTAL_DISCOUNT_FORMATTED"]:"";e=typeof t["TOTAL_DISCOUNT"]!="undefined"?parseFloat(t["TOTAL_DISCOUNT"]).toFixed(2):"0.00";this._discountExists=parseFloat(e)!==0;s.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}s=BX(this.getSetting("TOTAL_BEFORE_TAX_ID","total_before_tax"));if(s){i=BX.type.isNotEmptyString(t["TOTAL_BEFORE_TAX_FORMATTED"])?t["TOTAL_BEFORE_TAX_FORMATTED"]:"";e=typeof t["TOTAL_BEFORE_TAX"]!="undefined"?parseFloat(t["TOTAL_BEFORE_TAX"]).toFixed(2):"0.00";s.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}s=BX(this.getSetting("taxValueID","total_tax"));if(s){i=BX.type.isNotEmptyString(t["TOTAL_TAX_FORMATTED"])?t["TOTAL_TAX_FORMATTED"]:"";e=typeof t["TOTAL_TAX"]!="undefined"?parseFloat(t["TOTAL_TAX"]).toFixed(2):"0.00";this._taxExists=parseFloat(e)!==0;s.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}s=BX(this.getSetting("SUM_TOTAL_ID","sum_total"));if(s){i=BX.type.isNotEmptyString(t["TOTAL_SUM_FORMATTED"])?t["TOTAL_SUM_FORMATTED"]:"";e=typeof t["TOTAL_SUM"]!="undefined"?parseFloat(t["TOTAL_SUM"]).toFixed(2):"0.00";s.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e);BX.onCustomEvent(this,"sumTotalChange",[e,t])}this.switchTotalElements()},_onCalculateTotalsRequestFailure:function(t){self._processAjaxError(t)},registerProductDialogId:function(t){this._dlgId=t},getCurrencyId:function(){return this._currencyId},setCurrencyId:function(t){if(this._currencyId===t){return}if(this._settings["productCreateDialogSettings"])this._settings["productCreateDialogSettings"]["ownerCurrencyId"]=t;this.calculateProductPrices(t)},getClientTypeName:function(){return this._clientTypeName},setClientTypeName:function(t){if(this._clientTypeName===t){return}this._clientTypeName=t},getProductCount:function(){return this._products.length},convertMoney:function(t,e,i,s){var n=this;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"CONVERT_MONEY",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),DATA:{SRC_SUM:t,SRC_CURRENCY_ID:e,DST_CURRENCY_ID:i},SITE_ID:this.getSetting("siteId","")},onsuccess:function(t){if(t["SUM"]){if(n._processAjaxError(t)){return}try{s(parseFloat(t["SUM"]))}catch(t){}}},onfailure:function(t){n._processAjaxError(t)}})},setCurrencyFormat:function(t){if(typeof t!=="string"||t.length<=0)t="# ?";this._currencyFormat=t;var e=BX.util.trim(t.replace("#",""));var i=this.getSetting("discountTypeText",[]);if(i[BX.CrmDiscountType.monetary])i[BX.CrmDiscountType.monetary]=e;var s=BX(this.getSetting("priceTitleId",""));if(s){var n=BX.CrmProductEditorMessages["priceTitleText"];n=n.replace("#CURRENCY#"," ("+e+")");s.innerHTML=n}},calculateProductPrices:function(t){var e=this._currencyId;this._currencyId=t;var i=this.getExchRateElement();var s=[];var n=this.isTaxAllowed();var r,a;for(var o=0;o<this._products.length;o++){var l=this._products[o];r=l.getDiscountTypeId();a=l.isTaxIncluded();s.push({ID:l.getSetting("PRODUCT_ID","0"),PRICE:l.getSetting(n&&!a?"PRICE_NETTO":"PRICE_BRUTTO","0.0"),DISCOUNT_TYPE_ID:r,DISCOUNT_VALUE:r===BX.CrmDiscountType.percentage?l.getDiscountRate():l.getDiscountSum()})}var h=this;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"CALC_PRODUCT_PRICES",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),DATA:{SRC_CURRENCY_ID:e,SRC_EXCH_RATE:i?parseFloat(i.value):0,DST_CURRENCY_ID:t,PRODUCTS:s},SITE_ID:this.getSetting("siteId","")},onsuccess:function(t){if(typeof t["EXCH_RATE"]&&i){i.value=parseFloat(t["EXCH_RATE"])}if(t["PRODUCTS"]){if(h._processAjaxError(t)){return}var e=h.isTaxAllowed();var s,n;h.setCurrencyFormat(t["CURRENCY_FORMAT"]?t["CURRENCY_FORMAT"]:"# ?");for(var r=0;r<t["PRODUCTS"].length;r++){var a=t["PRODUCTS"][r];var o=h._products[r];s=parseInt(a["DISCOUNT_TYPE_ID"]);if(s!==BX.CrmDiscountType.percentage&&s!==BX.CrmDiscountType.monetary){s=BX.CrmDiscountType.percentage}n=o.isTaxIncluded();o.setFieldValue(e&&!n?"PRICE_NETTO":"PRICE_BRUTTO",parseFloat(a["PRICE"]).toFixed(2),true);if(s===BX.CrmDiscountType.monetary){o.refreshCurrencyText();o.setFieldValue("DISCOUNT_SUM",parseFloat(a["DISCOUNT_VALUE"]).toFixed(2),true)}}}if(t["PRODUCT_POPUP_ITEMS"]&&h._dlgId.length>0){obCrm[h._dlgId].SetPopupItems("product",t["PRODUCT_POPUP_ITEMS"])}},onfailure:function(t){h._processAjaxError(t)}})},getMeasures:function(){return this.getSetting("measures",[])},prepareMeasureOptionData:function(){var t=[];var e=this.getSetting("measures",[]);for(var i=0;i<e.length;i++){t.push({text:e[i]["SYMBOL"],value:e[i]["CODE"]})}return t},isTaxAllowed:function(){return this.getSetting("allowTax",false)},isLDTaxAllowed:function(){return this.getSetting("allowLDTax",false)},isTaxEnabled:function(){return this.getSetting("enableTax",false)},isDiscountEnabled:function(){return this.getSetting("enableDiscount",false)},getTaxes:function(){return this.getSetting("taxes",[])},prepareTaxOptionData:function(){var t=[];var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){t.push({text:e[i]["NAME"],value:e[i]["VALUE"]})}return t},getTaxById:function(t){t=parseInt(t);var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){var s=e[i];if(parseInt(s["ID"])==t){return s}}return null},getTaxNameByValue:function(t){var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){var s=e[i];if(parseFloat(s["VALUE"])==t){return e[i]["NAME"]}}return t+"%"},getTaxIdByValue:function(t){var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){var s=e[i];if(parseFloat(s["VALUE"])==t){return parseInt(e[i]["ID"])}}return 0},_processAjaxError:function(t){if(typeof t["ERROR"]=="undefined"){return false}var e=t["ERROR"];if(typeof BX.CrmProductEditorErrors[e]!="undefined"){e=BX.CrmProductEditorErrors[e]}else if(e=="OWNER_TYPE_NOT_FOUND"||e=="OWNER_ID_NOT_FOUND"||e=="SOURCE_DATA_NOT_FOUND"||e=="ID_NOT_FOUND"||e=="PRODUCT_ID_NOT_FOUND"||e=="PRODUCT_ROWS_SAVING_ERROR"){e=BX.CrmProductEditorErrors["INVALID_REQUEST_ERROR"]}this.showError(e);return true},showError:function(t){alert(t)},layoutElements:function(t){t=!!t;var e=this.getSetting("readOnly",false),i=this.getTable(),s=this._products.length;var n=this._topButtons;for(o=0;o<n.length;o++)n[o].style.display=e||t?"none":"";var r=BX(this.getSetting("addRowBtnID",""));if(r)r.style.display=e||t?"none":"";this.setModeBtnStyle();var a=[];a.push(i);a.push(BX("crm-top-sale-tab"));a.push(BX("crm-top-spacer"));a.push(BX("crm-top-tax-tab"));a.push(BX(this.getSetting("productTotalContainerID","")));for(var o=0;o<a.length;o++){if(a[o])a[o].style.display=s>0?"":"none"}},toggleMode:function(){var t=this._products;this.layoutElements(!this._viewMode);for(var e=0;e<t.length;e++)t[e].toggleMode();this._viewMode=!this._viewMode;this.setModeBtnStyle()},layout:function(){var t,e=this._products.length;this.layoutElements(this._viewMode);for(t=0;t<e;t++)this._products[t].layout();BX.CrmProductEditor.arrangeColumns(this,true);this._hasLayout=true},hasLayout:function(){return this._hasLayout},cleanProductRows:function(){if(!this._hasLayout){return}var t,e,i=-1;var s=this._products.length;for(e=s-1;e>=0;e--){t=this._products[e];t.saveSettings();if(BX.util.trim(t.getProductName())===""){t.clean();this._products.splice(e,1);i=e}}if(this._products.length===0&&s>0){BX.onCustomEvent(this,"sumTotalChange",["0.00",{TOTAL_SUM_FORMATTED:"",TOTAL_SUM_FORMATTED_SHORT:"",TOTAL_SUM:"0.00"}])}if(i>=0)this._renumProducts(i)},resortProducts:function(){var t;for(t=0;t<this._products.length;t++)this._products[t].setSort((t+1)*10)},saveProductRows:function(){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"SAVE_PRODUCTS",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),PRODUCT_ROW_DATA:this.productsToJson(),PRODUCT_ROW_SETTINGS:{ENABLE_DISCOUNT:this.isDiscountEnabled()?"Y":"N",ENABLE_TAX:this.isTaxEnabled()?"Y":"N"},SITE_ID:this.getSetting("siteId","")},onsuccess:BX.delegate(this._onSaveProductsRequestSuccess,this),onfailure:BX.delegate(this._onSaveProductsRequestFailure,this)})},getProductIndex:function(t){for(var e=0;e<this._products.length;e++){if(this._products[e]===t){return e}}return-1},getProductIndexByContainer:function(t){if(!BX.type.isDomNode(t)){return null}for(var e=0;e<this._products.length;e++){var i=this._products[e];if(i.getContainer()===t){return e}}return-1},switchTotalElements:function(){var t=this._discountExists,e=this._taxExists,i="crm-tax-value",s,n,r,a=this.isDiscountEnabled()||t?"":"none",o=e||!this.getSetting("hideAllTaxes",false)&&(this.isLDTaxAllowed()||this.isTaxAllowed()&&this.isTaxEnabled())?"":"none";var l=[{id:"TOTAL_BEFORE_DISCOUNT_ID",type:"discount"},{id:"TOTAL_DISCOUNT_ID",type:"discount"},{id:"TOTAL_BEFORE_TAX_ID",type:"tax"},{id:"taxValueID",type:"tax"}];for(s=0;s<l.length;s++){n=BX(this.getSetting(l[s]["id"],""));if(BX.type.isElementNode(n)){n=n.parentNode.parentNode;if(BX.type.isElementNode(n)){switch(l[s]["type"]){case"discount":n.style.display=a;break;case"tax":n.style.display=o;if(l[s]["id"]==="taxValueID"){r=n;while(r){r.style.display=o;r=BX.findNextSibling(r,{class:i})}}break}}}}},changeTaxIncludedUniform:function(t,e){var i,s=this._products;for(i=0;i<s.length;i++){if(s[i]!==t)s[i]._emulateTaxIncludedElementChange(e)}},getPathToProductShow:function(){return this.getSetting("pathToProductShow","")},setModeBtnStyle:function(){if(this._modeButton){var t=this.getSetting("readOnly",false),e=this.getSetting("hideModeButton",false),i=this._modeButton.parentNode,s=this._products.length,n=this._viewMode?s?"crmProductRowBtnEdit":"crmProductRowBtnAdd":"crmProductRowBtnEditF",r=BX.findChild(this._modeButton,{attr:{class:"webform-small-button-text"}});this._modeButton.style.display=t||e?"none":"";if(r)BX.setTextContent(r,BX.CrmProductEditorMessages[n]);if(this._viewMode&&s===0){i.style.cssFloat="left"}else{i.style.cssFloat="right"}}},processProductChange:function(t){BX.onCustomEvent(this,"productChange",[{product:t}])}};BX.CrmProductEditor.items={};BX.CrmProductEditor.get=function(t){return typeof this.items[t]!="undefined"?this.items[t]:null};BX.CrmProductEditor.getDefault=function(){return typeof this.items["__default"]!="undefined"?this.items["__default"]:null};BX.CrmProductEditor.create=function(t,e){var i=new BX.CrmProductEditor;i.initialize(t,e);this.items[t]=i;if(typeof this.items["__default"]=="undefined"){this.items["__default"]=i}return i};BX.CrmProductEditor.arrangeColumns=function(t,e){if(!t||typeof t._settings!=="object"||!t._settings["containerID"]||!t._settings["productContainerID"])return;var i=t.isTaxAllowed(),s=t.getSetting("hideTaxIncludedColumn",false),n=null,r=BX("crm-top-sale-checkbox"),a=r.parentNode.parentNode.offsetWidth,o=BX(t._settings["containerID"]),l=BX(t._settings["productContainerID"]),h=l.offsetWidth,d=l.rows[0],u=d.cells.length,c=BX("crm-l-space"),_=BX("crm-top-spacer").offsetWidth,T=h/100,g,f=0,C=0,p=[0,0,0,0,0,0,0,0],E=[29,10,10,10,10,10,18,3],I=[0,0,0,0,0,0,0,0],m=[29,16,16,16,0,0,19,3];if(i){n=BX("crm-top-tax-checkbox");if(s){p=[26,13,13,13,0,0,.5,10,0,10,11,3];E=[24,8,8,8,14,10,.5,0,0,0,24,3];I=[24,8,8,8,9,8,.5,10,0,10,11,3];m=[27,15,15,15,0,0,.5,0,0,0,24,3]}else{p=[26,13,13,13,0,0,.5,7,7,7,10,3];E=[24,8,8,8,15,15,.5,0,0,0,18,3];I=[24,8,8,8,10,7,.5,7,7,7,10,3];m=[29,16,16,16,0,0,.5,0,0,0,19,3]}}if(!e){var S=null;if(n&&this===n){if(n.checked!==t.getSetting("enableTax",false)){t.setSetting("enableTax",n.checked);if(!S)S={};S["SHOW_TAX"]=n.checked?"Y":"N"}}if(this===r){if(r.checked!==t.isDiscountEnabled()){t.setSetting("enableDiscount",r.checked);if(!S)S={};S["SHOW_DISCOUNT"]=r.checked?"Y":"N"}}var D=t.getSetting("ownerType","");var N=parseInt(t.getSetting("ownerID",0));if(S&&D.length>0&&N>0){BX.ajax({url:t._serviceUrl,method:"POST",dataType:"json",data:{MODE:"SET_OPTION",OWNER_TYPE:D,OWNER_ID:N,DATA:S,SITE_ID:t.getSetting("siteId","")}})}}for(var R=0;R<u;R++){d.cells[R].style.width=Math.round(d.cells[R].offsetWidth)+"px";setTimeout(function(){BX.addClass(o,"crm-items-list-anim")},50)}function B(t,e,i){var s=c.offsetWidth;c.style.width=s+"px";for(var n=0;n<u;n++){d.cells[n].style.width=Math.round(d.cells[n].offsetWidth)+"px";f+=Math.round(t[n]*T);if(n==3&&!e){C=f-Math.round(s);g=Math.round(t[n]*T)-C;if(g<0)g=0;d.cells[n].style.width=g+"px";f-=C}else if(n==5&&!e&&!i){C=f-Math.round(s+a+_);g=Math.round(t[n]*T)-C;if(g<0)g=0;d.cells[n].style.width=g+"px";f-=C}else if(n==6&&e&&i){if(f!=Math.round(s+a+_)){C=f-Math.round(s+a+_);g=Math.round(t[n]*T)-C;if(g<0)g=0;d.cells[n].style.width=g+"px";f-=C}else{d.cells[n].style.width=Math.round(t[n]*T)+"px"}}else if(n==6&&!e&&i){d.cells[n].style.width=Math.round(_)+"px";f-=Math.round(t[n]*T);f+=Math.round(_)}else if(n==7&&!i){g=Math.round(t[n]*T)-(f-h);if(g<0)g=0;d.cells[n].style.width=g+"px"}else if(n==11&&i){g=Math.round(t[n]*T)-(f-h);if(g<0)g=0;d.cells[n].style.width=g+"px"}else{d.cells[n].style.width=Math.round(t[n]*T)+"px"}}c.style.width=""}function U(t){for(var e=0;e<u;e++){d.cells[e].style.width=Math.round(t[e]*T)+"px"}}if(n&&this==n){if(o.getAttribute("data-tabs")==""){BX.addClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","tax");setTimeout(function(){B(p,1,i)},70)}else if(o.getAttribute("data-tabs")=="sale"){BX.addClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","all");setTimeout(function(){B(I,0,i)},70)}else if(o.getAttribute("data-tabs")=="tax"){BX.removeClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","");setTimeout(function(){U(m)},70)}else if(o.getAttribute("data-tabs")=="all"){BX.removeClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","sale");setTimeout(function(){B(E,0,i)},70)}}else if(this==r){if(o.getAttribute("data-tabs")==""){BX.addClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","sale");setTimeout(function(){B(E,0,i)},70)}else if(o.getAttribute("data-tabs")=="tax"){BX.addClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","all");setTimeout(function(){B(I,0,i)},70)}else if(o.getAttribute("data-tabs")=="sale"){BX.removeClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","");setTimeout(function(){U(m)},70)}else if(o.getAttribute("data-tabs")=="all"){BX.removeClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","tax");setTimeout(function(){B(p,1,i)},70)}}else{if(o.getAttribute("data-tabs")=="")setTimeout(function(){U(m)},70);else if(o.getAttribute("data-tabs")=="tax")setTimeout(function(){B(p,1,i)},70);else if(o.getAttribute("data-tabs")=="sale")setTimeout(function(){B(E,0,i)},70);else if(o.getAttribute("data-tabs")=="all")setTimeout(function(){B(I,0,i)},70)}t.switchTotalElements()};if(typeof BX.CrmProductEditorMessages==="undefined"){BX.CrmProductEditorMessages={editButtonTitle:"Edit",deleteButtonTitle:"Delete",deletionConfirm:"Are you sure you want to delete this product?"}}}if(typeof BX.CrmProduct==="undefined"){BX.CrmProduct=function(){this._viewMode=true;this._settings={};this._container=this._editor=null;this._fields={};this._fieldValue={};this._elements={};this._isEventsBinds=false;this._discountTypeView=0;this._fixProductName=false;this._focusedField=null;this._productSearch=null;this._dragButton=null;this._sumValueAfterBlur=null;this._hasLayout=false};BX.CrmProduct.prototype={initialize:function(t,e,i){this._editor=i;this.setSettings(t);if(typeof this._settings["FIXED_PRODUCT_NAME"]==="string"&&this._settings["FIXED_PRODUCT_NAME"].length>0)this._fixProductName=true;this._container=e;this._viewMode=i._viewMode;this._discountTypeView=BX.CrmDiscountType.percentage;var s=BX.findChild(e,{tag:"span",class:"crm-item-del"},true,false);if(s){BX.bind(s,"click",BX.delegate(this._handleDeleteClick,this));s.setAttribute("title",BX.CrmProductEditorMessages["deleteButtonTitle"])}this._dragButton=BX.findChild(e,{tag:"span",class:"crm-item-move-btn"},true,false);var n=e.id;var r,a,o,l,h,d=[];var u=[];if(n){var c=this.getSetting("fields",[]);for(var _=0;_<c.length;_++){if(c[_]){a=n+"_"+c[_];o="crm-item-cell-text";l=false;if(c[_]==="PRODUCT_NAME"&&this._fixProductName){a+="_v";o="crm-item-cell-view";l=true}r=BX(a);if(r){h=r.parentNode;if(h){if(BX.hasClass(h,o)){d.push(h)}else{h=h.parentNode;if(h&&BX.hasClass(h,o))d.push(h)}if(h&&this._viewMode&&!l)h.style.display="none"}}o="crm-item-cell-view";l=c[_]==="PRODUCT_NAME"&&this._fixProductName;r=BX(n+"_"+c[_]+"_v");if(r){h=r.parentNode;if(h){if(BX.hasClass(h,o)){u.push(h)}else{h=h.parentNode;if(h&&BX.hasClass(h,o))u.push(h)}if(h&&!this._viewMode&&!l)h.style.display="none"}}}}}this._viewBlocks=u;this._editBlocks=d;var T=BX.findChild(this._container,{attr:{class:"crm-item-del"}},true);if(T)T.style.display=this._viewMode?"none":"";if(!this._productSearch){var g=BX(this._container.id+"_PRODUCT_NAME");var f=g.parentNode;f.id=g.id+"_c";this._productSearch=BX.CrmProductSearch.create({AJAX_PAGE:this._editor.getSetting("productSearchUrl",""),CONTAINER_ID:f.id,INPUT_ID:this._container.id+"_PRODUCT_NAME",MIN_QUERY_LEN:3},this)}},initializeDragDropAbilities:function(){if(this._dragItem){return}if(!this._dragButton){throw"CrmProduct: Could not find drag button."}this._dragItem=BX.CrmProdoctRowListDragItem.create(this.getId(),{product:this,node:this._dragButton,container:this._editor.getTable(),showInDragMode:false,ghostOffset:{x:-12,y:-12}})},releaseDragDropAbilities:function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}},getRowNumber:function(){return this._container.rowIndex},setNumber:function(t){var e=[];e[0]=BX(this._container.id+"_NUM");e[1]=BX(this._container.id+"_NUM_v");for(var i=0;i<e.length;i++){if(e[i])BX.setTextContent(e[i],parseInt(t).toString()+".")}this._container.className=t%2===0?"crm-items-table-even-row":"crm-items-table-odd-row"},getMeasureNameByCode:function(t){var e=this._editor.getSetting("measures",[]),i="-",s,n;if(e){for(n=0;n<e.length;n++){if(e[n]&&typeof e[n]==="object"){s=e[n];if(s.hasOwnProperty("CODE")&&parseInt(s["CODE"])===parseInt(t)){if(s.hasOwnProperty("SYMBOL")&&s["SYMBOL"].length>0){i=s["SYMBOL"];break}}}}}return i},getMeasureIdByCode:function(t){var e=this._editor.getSetting("measures",[]),i=0,s,n;if(e){for(n=0;n<e.length;n++){if(e[n]&&typeof e[n]==="object"){s=e[n];if(s.hasOwnProperty("CODE")&&parseInt(s["CODE"])===parseInt(t)){if(s.hasOwnProperty("ID")&&s["ID"].length>0){i=s["ID"];break}}}}}return i},setFieldView:function(t,e){var i,s=false;var n=this._editor.isTaxAllowed();var r=this.isTaxIncluded();if(t==="PRICE_NETTO"||t==="PRICE_BRUTTO")s=true;e=t==="TAX_INCLUDED"?!!e:e.toString();switch(t){case"PRICE_NETTO":case"PRICE_BRUTTO":i="PRICE";break;case"MEASURE_CODE":i="MEASURE";break;case"DISCOUNT_RATE":case"DISCOUNT_SUM":case"DISCOUNT_TYPE_ID":i="DISCOUNT";break;default:i=t}var a=0,o=this._discountTypeView;switch(i){case"PRICE":case"DISCOUNT_SUM":case"DISCOUNT_SUBTOTAL":case"SUM":a=2;break;case"DISCOUNT":if(o===BX.CrmDiscountType.monetary)a=2;break}if(a>0)e=this._parseFloat(e,a,0).toFixed(a);var l=this._container,h=BX(l.id+"_"+i+"_v"),d;var u,c;switch(t){case"PRODUCT_NAME":case"QUANTITY":case"SUM":if(h)BX.setTextContent(h,e);break;case"PRICE_NETTO":if(n&&!r){if(h)BX.setTextContent(h,e)}break;case"PRICE_BRUTTO":if(!n||r){if(h)BX.setTextContent(h,e)}break;case"MEASURE_CODE":var _=this.getMeasureNameByCode(e);if(h)BX.setTextContent(h,_);break;case"DISCOUNT_TYPE_ID":break;case"DISCOUNT_RATE":if(o===BX.CrmDiscountType.percentage){if(h)BX.setTextContent(h,e)}break;case"DISCOUNT_SUM":if(o===BX.CrmDiscountType.monetary){if(h)BX.setTextContent(h,e)}break;case"DISCOUNT_SUBTOTAL":if(h)BX.setTextContent(h,e);break;case"TAX_RATE":if(h)BX.setTextContent(h,e+"%");break;case"TAX_INCLUDED":if(h)BX.setTextContent(h,e?BX.CrmProductEditorMessages["yes"]:BX.CrmProductEditorMessages["no"]);break;case"TAX_SUM":if(h)BX.setTextContent(h,this._parseFloat(e,2,0).toFixed(2));break}},setFieldValue:function(t,e,i){var s,n=false;var r=this._editor.isTaxAllowed();var a=this.isTaxIncluded();if(t==="PRICE_NETTO"||t==="PRICE_BRUTTO")n=true;e=t==="TAX_INCLUDED"?!!e:e.toString();if(this._fieldValue.hasOwnProperty(t)&&this._fieldValue[t]===e&&!n)return;this._fieldValue[t]=e;switch(t){case"PRICE_NETTO":case"PRICE_BRUTTO":s="PRICE";break;case"MEASURE_CODE":s="MEASURE";break;case"DISCOUNT_RATE":case"DISCOUNT_SUM":s="DISCOUNT";break;default:s=t}var o=this._container,l=BX(o.id+"_"+s),h=BX(o.id+"_"+s+"_v"),d;var u,c,_,T,g=this._discountTypeView;switch(t){case"PRODUCT_NAME":case"QUANTITY":case"DISCOUNT_SUBTOTAL":case"SUM":if(l)l.value=e;if(h)BX.setTextContent(h,e);break;case"PRICE_NETTO":if(r&&!a){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"PRICE_BRUTTO":if(!r||a){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"MEASURE_CODE":if(l)BX.setSelectValue(l,e);var f=this.getMeasureNameByCode(e);this._fieldValue["MEASURE_NAME"]=f;if(h)BX.setTextContent(h,f);break;case"DISCOUNT_TYPE_ID":u=parseInt(e);if(u!==BX.CrmDiscountType.percentage&&u!==BX.CrmDiscountType.monetary)u=BX.CrmDiscountType.percentage;if(parseInt(g)!==u){var C=this._editor.getSetting("discountTypeText",[]);g=u;this._discountTypeView=g;var p=C[g]?C[g]:"?";var E=g===BX.CrmDiscountType.percentage?"DISCOUNT_RATE":"DISCOUNT_SUM";l=BX(o.id+"_DISCOUNT");var I=[];var m=this._parseFloat(this._fieldValue[E],2,0).toFixed(2);if(l){I[0]=BX.findChild(l.parentNode,{attr:{class:"crm-item-sale-text"}},true);l.value=g===BX.CrmDiscountType.percentage?this._fieldValue[E]:m}h=BX(o.id+"_DISCOUNT_v");if(h){I[1]=BX.findChild(h.parentNode,{attr:{class:"crm-item-sale-text"}},true);BX.setTextContent(h,g===BX.CrmDiscountType.percentage?this._fieldValue[E]:m)}{for(d=0;d<I.length;d++){if(I[d]){I[d].innerHTML=p}}}}break;case"DISCOUNT_RATE":if(g===BX.CrmDiscountType.percentage){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"DISCOUNT_SUM":if(g===BX.CrmDiscountType.monetary){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"TAX_RATE":if(l){var S=false;for(d=0;d<l.options.length;d++){if(l.options[d].value===e){l.selectedIndex=d;S=true;break}}if(!S){var D=document.createElement("option");D.value=e;D.innerHTML=BX.util.htmlspecialchars(e+"%");l.appendChild(D);l.selectedIndex=d}}if(h)BX.setTextContent(h,e+"%");break;case"TAX_INCLUDED":if(l)l.checked=e;if(h)BX.setTextContent(h,e?BX.CrmProductEditorMessages["yes"]:BX.CrmProductEditorMessages["no"]);break;case"TAX_SUM":if(l)BX.setTextContent(l,this._parseFloat(e,2,0).toFixed(2));if(h)BX.setTextContent(h,this._parseFloat(e,2,0).toFixed(2));break}i=typeof i==="undefined"?false:!!i;if(i)this.processFieldValueChange(t)},layout:function(){var t=this._container;var e=this._editor.getSetting("readOnly",false);var i=this.getSetting("PRODUCT_ID",0);var s=this.getSetting("PRODUCT_NAME","");var n=this.getSetting("PRICE",0);var r=this.getSetting("QUANTITY",0);var a=this._editor.isTaxAllowed();var o=this._editor.isTaxEnabled();var l,h,d,u,c,_;this.setFieldValue("PRODUCT_NAME",s);var T=this.getSetting("PRICE_NETTO",0);this.setFieldValue("PRICE_NETTO",T.toFixed(2));var g=this.getSetting("PRICE_BRUTTO",0);this.setFieldValue("PRICE_BRUTTO",g.toFixed(2));var f=this.getSetting("QUANTITY",0);this.setFieldValue("QUANTITY",f);var C="";var p=this._editor.getSetting("defaultMeasure",null);if(p){if(p.hasOwnProperty("CODE"))C=p["CODE"]}this.setFieldValue("MEASURE_CODE",this.getSetting("MEASURE_CODE",C));var E=this.getDiscountTypeId();this.setFieldValue("DISCOUNT_TYPE_ID",E);var I=this.getSetting("DISCOUNT_RATE",0);this.setFieldValue("DISCOUNT_RATE",I);var m=this.getSetting("DISCOUNT_SUM",0);this.setFieldValue("DISCOUNT_SUM",m.toFixed(2));var S=f*m;this.setFieldValue("DISCOUNT_SUBTOTAL",S.toFixed(2));var D="0";var N="0%";if(a){var R=this._editor.getSetting("defaultTax",null);if(R){if(R.hasOwnProperty("VALUE")){D=R["VALUE"];N=R["VALUE"]+"%"}}}this.setFieldValue("TAX_RATE",this.getSetting("TAX_RATE",D));this.setFieldValue("TAX_INCLUDED",this.isTaxIncluded());this.setFieldValue("TAX_SUM",this._round(this.getSetting("TAX_SUM",0),2));this.setFieldValue("SUM",this._calculateSumTotal());this._handleProductNameChange(s);this._bindEventsHandlers();this.initializeDragDropAbilities();this._hasLayout=true},clean:function(){if(this._container){this._container.parentNode.removeChild(this._container);this.releaseDragDropAbilities()}this._hasLayout=false},hasLayout:function(){return this._hasLayout},isReadOnly:function(){return this.getSetting("readOnly",false)},getContainer:function(){return this._container},toggleMode:function(){var t,e;var i=this._viewMode?this._viewBlocks:this._editBlocks;var s=this._viewMode?this._editBlocks:this._viewBlocks;for(t=0;t<i.length;t++)i[t].style.display="none";for(t=0;t<s.length;t++)s[t].style.display="";e=BX.findChild(this._container,{attr:{class:"crm-item-del"}},true);if(e)e.style.display=this._viewMode?"":"none";if(!this._viewMode){this.saveSettings()}this._viewMode=!this._viewMode},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},saveSettings:function(){if(!this._hasLayout||this._viewMode){return}this._settings["PRODUCT_NAME"]=BX.util.trim(BX.prop.getString(this._fieldValue,"PRODUCT_NAME"));this._settings["QUANTITY"]=this._parseFloat(this._fieldValue["QUANTITY"],4,0);this._settings["DISCOUNT_TYPE_ID"]=this._parseInt(this._fieldValue["DISCOUNT_TYPE_ID"],this.getDiscountTypeId());this._settings["DISCOUNT_RATE"]=this._parseFloat(this._fieldValue["DISCOUNT_RATE"],2,0);this._settings["DISCOUNT_SUM"]=this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this._settings["TAX_INCLUDED"]=this._fieldValue["TAX_INCLUDED"];this._settings["TAX_RATE"]=this._parseFloat(this._fieldValue["TAX_RATE"],2,0);this._settings["TAX_SUM"]=this._parseFloat(this._fieldValue["TAX_SUM"],2,0);this._settings["MEASURE_CODE"]=parseInt(this._fieldValue["MEASURE_CODE"]);this._settings["MEASURE_NAME"]=BX.prop.getString(this._fieldValue,"MEASURE_NAME")},getSettings:function(){return this._settings},setSettings:function(t){this._settings=t?t:{};this._settings["PRODUCT_ID"]=parseInt(this.getSetting("PRODUCT_ID",0));this._settings["PRODUCT_NAME"]=this.getSetting("PRODUCT_NAME","");this._settings["QUANTITY"]=this._round(parseFloat(this.getSetting("QUANTITY",0)),4);this._settings["MEASURE_CODE"]=parseInt(this.getSetting("MEASURE_CODE",0));this._settings["MEASURE_NAME"]=this.getSetting("MEASURE_NAME","");this._settings["DISCOUNT_TYPE_ID"]=parseInt(this.getDiscountTypeId());if(this._editor.isInvoiceMode())this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this._settings["DISCOUNT_RATE"]=this._round(parseFloat(this.getSetting("DISCOUNT_RATE",0)),2);this._settings["DISCOUNT_SUM"]=this._round(parseFloat(this.getSetting("DISCOUNT_SUM",0)),2);this._settings["DISCOUNT_SUBTOTAL"]=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this._settings["TAX_RATE"]=this._round(parseFloat(this.getSetting("TAX_RATE",0)),2);this._settings["TAX_INCLUDED"]=this.isTaxIncluded();this._settings["PRICE"]=this._round(parseFloat(this.getSetting("PRICE",0)),2);this._settings["PRICE_EXCLUSIVE"]=this._round(parseFloat(this.getSetting("PRICE_EXCLUSIVE",0)),2);if(typeof this._settings["PRICE_NETTO"]!=="undefined"){this._settings["PRICE_NETTO"]=this._round(parseFloat(this.getSetting("PRICE_NETTO",0)),2)}else{var e=this._settings["PRICE_EXCLUSIVE"];if(this._settings["DISCOUNT_TYPE_ID"]===BX.CrmDiscountType.monetary){this._settings["PRICE_NETTO"]=e+this._settings["DISCOUNT_SUM"]}else{var i=this._settings["DISCOUNT_RATE"];var s=i<100?this._round(this._calculateDiscountByDiscountPrice(e,i),2):this._settings["DISCOUNT_SUM"];this._settings["PRICE_NETTO"]=e+s}}if(typeof this._settings["PRICE_BRUTTO"]!=="undefined"){this._settings["PRICE_BRUTTO"]=this._round(parseFloat(this.getSetting("PRICE_BRUTTO",0)),2)}else{if(this._settings["DISCOUNT_SUM"]==0){this._settings["PRICE_BRUTTO"]=this._settings["PRICE"]}else{this._settings["PRICE_BRUTTO"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]),2)}}this._settings["TAX_SUM"]=this.getTaxSum();this._settings["CUSTOMIZED"]=!!this.getSetting("CUSTOMIZED",false);this._settings["SORT"]=parseInt(this.getSetting("SORT",0))},getId:function(){return parseInt(this.getSetting("ID",0))},setId:function(t){this._settings["ID"]=parseInt(t)},setProductId:function(t){return this.setSetting("PRODUCT_ID",parseInt(t))},getProductId:function(){return this.getSetting("PRODUCT_ID",0)},getProductName:function(){return this.getSetting("PRODUCT_NAME","")},getQuantity:function(){return this.getSetting("QUANTITY",0)},getMeasureCode:function(){return this.getSetting("MEASURE_CODE",0)},getMeasureName:function(){return this.getSetting("MEASURE_NAME","")},getPrice:function(){return this.getSetting("PRICE",0)},getExclusivePrice:function(){return this.getSetting("PRICE_EXCLUSIVE",0)},getPriceNetto:function(){return this.getSetting("PRICE_NETTO",0)},getPriceBrutto:function(){return this.getSetting("PRICE_BRUTTO",0)},getDiscountTypeId:function(){var t=parseInt(this.getSetting("DISCOUNT_TYPE_ID",BX.CrmDiscountType.percentage));if(t!==BX.CrmDiscountType.percentage&&t!==BX.CrmDiscountType.monetary){t=BX.CrmDiscountType.percentage}return t},getDiscountRate:function(){return this.getSetting("DISCOUNT_RATE",0)},getDiscountSum:function(){return this.getSetting("DISCOUNT_SUM",0)},getDiscountSubtotal:function(){return this.getSetting("DISCOUNT_SUBTOTAL",0)},getTaxRate:function(){return this.getSetting("TAX_RATE",0)},isTaxIncluded:function(){return this.getSetting("TAX_INCLUDED",false)},isCustomized:function(){return this.getSetting("CUSTOMIZED",false)},getSort:function(){return this.getSetting("SORT",0)},setSort:function(t){return this.setSetting("SORT",t)},isViewMode:function(){return this._viewMode},toJson:function(){var t="";var e={};if(this._hasLayout&&!this._viewMode){this.saveSettings()}e["ID"]=this.getId();e["PRODUCT_NAME"]=this.getSetting(this._fixProductName?"FIXED_PRODUCT_NAME":"PRODUCT_NAME","");e["PRODUCT_ID"]=this.getSetting("PRODUCT_ID",0);e["QUANTITY"]=this.getSetting("QUANTITY",0).toFixed(4);e["MEASURE_CODE"]=this.getSetting("MEASURE_CODE",0);e["MEASURE_NAME"]=this.getSetting("MEASURE_NAME","");e["PRICE"]=this.getSetting("PRICE",0).toFixed(2);e["PRICE_EXCLUSIVE"]=this.getSetting("PRICE_EXCLUSIVE",0).toFixed(2);e["PRICE_NETTO"]=this.getSetting("PRICE_NETTO",0).toFixed(2);e["PRICE_BRUTTO"]=this.getSetting("PRICE_BRUTTO",0).toFixed(2);e["DISCOUNT_TYPE_ID"]=this.getDiscountTypeId();var i=this.getSetting("DISCOUNT_RATE",null);if(i!==null){e["DISCOUNT_RATE"]=i.toFixed(2)}var s=this.getSetting("DISCOUNT_SUM",null);if(s!==null){e["DISCOUNT_SUM"]=s.toFixed(2)}e["TAX_RATE"]=this.getSetting("TAX_RATE",0).toFixed(2);e["TAX_INCLUDED"]=this.getSetting("TAX_INCLUDED",false)?"Y":"N";e["CUSTOMIZED"]="Y";e["SORT"]=parseInt(this.getSetting("SORT",0));return JSON.stringify(e)},processFieldValueChange:function(t){var e,i,s,n,r,a,o;var l=this.getDiscountTypeId();if(t!=="DISCOUNT_SUM"&&t!=="DISCOUNT_RATE"&&t!=="DISCOUNT_SUBTOTAL"&&t!=="DISCOUNT_TYPE_ID"&&t!=="TAX_RATE"&&t!=="TAX_INCLUDED"&&t!=="PRICE_BRUTTO"&&t!=="PRICE_NETTO"&&t!=="QUANTITY"&&t!=="MEASURE_CODE"&&t!=="SUM"){return}if(t==="DISCOUNT_TYPE_ID"){this._settings["DISCOUNT_TYPE_ID"]=parseInt(this._fieldValue["DISCOUNT_TYPE_ID"]);if(parseInt(this._fieldValue[t])===BX.CrmDiscountType.monetary){n=this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"];this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);this._settings["DISCOUNT_SUM"]=this._round(this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]),2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"].toFixed(2));this._settings["DISCOUNT_SUBTOTAL"]=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this.setFieldValue("DISCOUNT_SUBTOTAL",this._settings["DISCOUNT_SUBTOTAL"].toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else{n=this._round(this._calculatePrice(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"],BX.CrmDiscountType.percentage),2);this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_SUM"]=this._round(this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]),2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"].toFixed(2));s=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}}if(t==="QUANTITY"){this._settings["QUANTITY"]=this._parseFloat(this._fieldValue[t],4,0);s=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum())}else if(t==="MEASURE_CODE"){this._settings["MEASURE_CODE"]=parseInt(this._fieldValue[t]);this._settings["MEASURE_NAME"]=this._fieldValue["MEASURE_NAME"]=this.getMeasureNameByCode(this._settings["MEASURE_CODE"])}else if(t==="PRICE_BRUTTO"||t==="PRICE_NETTO"){if(t==="PRICE_BRUTTO"){this._settings["PRICE_BRUTTO"]=this._parseFloat(this._fieldValue[t],2,0);this._settings["PRICE_NETTO"]=this._round(BX.CrmProduct.calculateExclusivePrice(this._settings["PRICE_BRUTTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"])}else{this._settings["PRICE_NETTO"]=this._parseFloat(this._fieldValue[t],2,0);this._settings["PRICE_BRUTTO"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"])}if(this._settings["DISCOUNT_TYPE_ID"]===BX.CrmDiscountType.percentage){if(this._settings["DISCOUNT_RATE"]==0){this._settings["PRICE_EXCLUSIVE"]=this._settings["PRICE_NETTO"];this._settings["PRICE"]=this._settings["PRICE_BRUTTO"];i=0}else{n=this._round(this._calculatePrice(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"],BX.CrmDiscountType.percentage),2);this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);i=this._settings["PRICE_NETTO"]-n}this.setFieldValue("DISCOUNT_SUM",i.toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2))}else if(this._settings["DISCOUNT_TYPE_ID"]===BX.CrmDiscountType.monetary){if(this._settings["DISCOUNT_SUM"]==0){this._settings["PRICE_EXCLUSIVE"]=this._settings["PRICE_NETTO"];this._settings["PRICE"]=this._settings["PRICE_BRUTTO"];this.setFieldValue("DISCOUNT_RATE",0)}else{i=this._settings["DISCOUNT_SUM"];n=this._settings["PRICE_NETTO"]-i;this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this.setFieldValue("DISCOUNT_RATE",this._calculateDiscountRate(this._settings["PRICE_NETTO"],n))}}this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="DISCOUNT_RATE"){this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.percentage;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_RATE"]=this._parseFloat(this._fieldValue[t],2,0);n=this._calculatePrice(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"],BX.CrmDiscountType.percentage);this._settings["PRICE_EXCLUSIVE"]=this._round(n,2);this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this.setFieldValue("DISCOUNT_SUM",this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]).toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="DISCOUNT_SUM"){this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_SUM"]=this._parseFloat(this._fieldValue[t],2,0);n=this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"];this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="TAX_RATE"){if(this._editor.isTaxAllowed()){r=this._settings["TAX_INCLUDED"];this._settings["TAX_RATE"]=this._parseFloat(this._fieldValue[t],2,0);if(r){a=BX.CrmProduct.calculateExclusivePrice(this._settings["PRICE_BRUTTO"],this._settings["TAX_RATE"]);this._settings["PRICE_NETTO"]=this._round(a,2)}else{a=this._settings["PRICE_NETTO"];o=BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]);this._settings["PRICE_BRUTTO"]=this._round(o,2)}e=l===BX.CrmDiscountType.percentage?this._settings["DISCOUNT_RATE"]:this._settings["DISCOUNT_SUM"];n=this._calculatePrice(a,e,l);this._settings["PRICE_EXCLUSIVE"]=this._round(n,2);this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);if(r){if(l===BX.CrmDiscountType.percentage){this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"].toFixed(2));this.setFieldValue("DISCOUNT_SUM",this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]).toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2))}else{this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2))}}else{this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"].toFixed(2))}this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}}else if(t==="TAX_INCLUDED"){if(this._editor.isTaxAllowed()){r=this._settings["TAX_INCLUDED"]=!!this._fieldValue[t];if(!r){this._settings["PRICE_NETTO"]=this._settings["PRICE_BRUTTO"];this._settings["PRICE_BRUTTO"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"].toFixed(2),true)}else{this._settings["PRICE_BRUTTO"]=this._settings["PRICE_NETTO"];this._settings["PRICE_NETTO"]=this._round(BX.CrmProduct.calculateExclusivePrice(this._settings["PRICE_BRUTTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"].toFixed(2),true)}}}else if(t==="DISCOUNT_SUBTOTAL"){this._settings["DISCOUNT_SUBTOTAL"]=this._parseFloat(this._fieldValue[t],2,0);if(this._round(parseFloat(this._settings["QUANTITY"]),4)===0){this._settings["QUANTITY"]=1;this.setFieldValue("QUANTITY",1)}this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_SUM"]=this._round(this._settings["DISCOUNT_SUBTOTAL"]/this._settings["QUANTITY"],2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"].toFixed(2));n=this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"];this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],n),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);this._settings["DISCOUNT_SUBTOTAL"]=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this._fieldValue["DISCOUNT_SUBTOTAL"]=this._settings["DISCOUNT_SUBTOTAL"].toFixed(2);this.setFieldView("DISCOUNT_SUBTOTAL",this._fieldValue["DISCOUNT_SUBTOTAL"]);this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="SUM"){this._settings["SUM"]=this._parseFloat(this._fieldValue[t],2,0);if(this._round(parseFloat(this._settings["QUANTITY"]),4)===0){this._settings["QUANTITY"]=1;this.setFieldValue("QUANTITY",1)}i=this._settings["PRICE_NETTO"]-this._settings["SUM"]/(this._settings["QUANTITY"]*(1+this._settings["TAX_RATE"]/100));i=this._round(i,2);this._settings["PRICE_EXCLUSIVE"]=this._round(this._settings["PRICE_NETTO"]-i,2);this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_EXCLUSIVE"],this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_SUM"]=this._round(i,2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"]);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_EXCLUSIVE"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"].toFixed(2));this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"].toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this._sumValueAfterBlur=this._calculateSumTotal();this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}if(t!=="SUM"){if(this._settings["TAX_INCLUDED"]){this.setFieldValue("SUM",(this._settings["PRICE"]*this._settings["QUANTITY"]).toFixed(2))}else{this.setFieldValue("SUM",this._calculateSumTotal())}}this._editor.calculateTotalsDelayed()},_bindEventsHandlers:function(){var t=this,e=this._container,i=this.getSetting("fields",[]),s,n,r,a,o,l="crm-item-inp-btn";if(this._isEventsBinds)return;for(r=0;r<i.length;r++){s=i[r];n=BX(e.id+"_"+s);if(n){switch(s){case"PRODUCT_NAME":case"QUANTITY":if(s==="PRODUCT_NAME"){o=BX.findNextSibling(n,{class:l});if(o){BX.bind(o,"click",function(e){t._onProductNameButtonClick.apply(t,[this,e])})}}if(s!=="PRODUCT_NAME"||!this._fixProductName){BX.bind(n,"keyup",function(e){t._onElementKeyUp.apply(t,[this,e])});BX.bind(n,"input",function(e){t._onElementChange.apply(t,[this,e])});BX.bind(n,"focus",function(e){t._onElementFocus.apply(t,[this,e])});BX.bind(n,"blur",function(e){t._onElementBlur.apply(t,[this,e])})}break;case"DISCOUNT":var h=[];if(n)h[0]=BX.findChild(n.parentNode,{attr:{class:"crm-item-sale-text"}},true);var d=BX(e.id+"_"+s+"_v");if(d)h[1]=BX.findChild(d.parentNode,{attr:{class:"crm-item-sale-text"}},true);for(a=0;a<h.length;a++){if(h[a])BX.bind(h[a],"click",function(e){t._handleChangeDiscountTypeView.apply(t,[this,e])})}BX.bind(n,"keyup",function(e){t._onElementKeyUp.apply(t,[this,e])});BX.bind(n,"input",function(e){t._onElementChange.apply(t,[this,e])});BX.bind(n,"focus",function(e){t._onElementFocus.apply(t,[this,e])});BX.bind(n,"blur",function(e){t._onElementBlur.apply(t,[this,e])});break;case"MEASURE":case"TAX_RATE":BX.bind(n,"change",function(e){t._onElementChange.apply(t,[this,e])});break;case"TAX_INCLUDED":BX.bind(n,"click",function(e){t._onElementChange.apply(t,[this,e])});break;case"PRICE":case"DISCOUNT_SUBTOTAL":case"SUM":BX.bind(n,"keyup",function(e){t._onElementKeyUp.apply(t,[this,e])});BX.bind(n,"input",function(e){t._onElementChange.apply(t,[this,e])});BX.bind(n,"focus",function(e){t._onElementFocus.apply(t,[this,e])});BX.bind(n,"blur",function(e){t._onElementBlur.apply(t,[this,e])});break}}}this._isEventsBinds=true},_handleDeleteClick:function(t){if(this.isReadOnly()){return}if(this._editor.handleProductDeletion(this)){this.clean();BX.PreventDefault(t)}},refreshCurrencyText:function(){var t,e,i,s,n,r,a;e=this._discountTypeView;if(e===BX.CrmDiscountType.monetary){t=this._container;i=this._editor.getSetting("discountTypeText",[]);s=i[e]?i[e]:"?";n=[];if(r=BX(t.id+"_DISCOUNT"))n[0]=BX.findChild(r.parentNode,{attr:{class:"crm-item-sale-text"}},true);if(a=BX(t.id+"_"+"_DISCOUNT_v"))n[1]=BX.findChild(a.parentNode,{attr:{class:"crm-item-sale-text"}},true);for(var o=0;o<n.length;o++){if(n[o]){n[o].innerHTML=s}}}},createGhostNode:function(){var t=BX.create("DIV",{attrs:{className:"crm-items-table-draggable-item"}});var e=BX.create("DIV",{attrs:{className:"crm-items-table-drag-inner"}});e.style.width=BX.pos(this._container).width+"px";t.appendChild(e);var i=BX.create("TABLE",{attrs:{className:"crm-items-table"}});e.appendChild(i);var s=i.insertRow(-1);s.className="crm-items-table-even-row";var n=s.insertCell(-1);n.className="crm-item-cell crm-item-name";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-view"},children:[BX.create("SPAN",{attrs:{className:"crm-table-name-left"},children:[BX.create("SPAN",{attrs:{className:"crm-item-move-btn"}}),BX.create("SPAN",{attrs:{className:"crm-item-num"},text:this.getRowNumber().toString()+"."})]}),BX.create("SPAN",{attrs:{className:"crm-item-txt-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-item-name-txt"},text:this.getProductName()})]})]}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-price";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-qua";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-unit";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-sale";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-total";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-move";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));return t},_handleChangeDiscountTypeView:function(t,e){if(t&&!this._editor.isInvoiceMode()){var i=this.getDiscountTypeId();if(i===BX.CrmDiscountType.percentage)i=BX.CrmDiscountType.monetary;else i=BX.CrmDiscountType.percentage;if(!this._viewMode)this.setFieldValue("DISCOUNT_TYPE_ID",i,true);if(e)BX.PreventDefault(e)}},_parseFloat:function(t,e,i){if(typeof e==="undefined"){e=2}if(typeof i==="undefined"){i=0}if(!BX.type.isNotEmptyString(t)){return i}t=t.replace(/^\s+|\s+$/g,"");var s=t.indexOf(".");var n=t.indexOf(",");var r=t.indexOf("-")===0;if(s<0&&n>=0){var a=t.substr(0,n);var o=t.length-n-1;if(o>0){a+="."+t.substr(n+1,o)}t=a}t=t.replace(/[^\d\.]+/g,"");var l=parseFloat(t);if(isNaN(l)){l=i}if(r){l=-l}if(e>=0){l=this._round(l,e)}return l},_parseInt:function(t,e){if(typeof e==="undefined"){e=0}if(!BX.type.isNotEmptyString(t)){return e}t=t.replace(/^\s+|\s+$/g,"");var i=t.indexOf("-")===0;var s=parseInt(t.replace(/[^\d]/g,""));if(isNaN(s)){s=e}if(i){s=-s}return s},_round:function(t,e){return BX.CrmProduct.round(t,e)},_calculateDiscountRate:function(t,e){if(t===0){return 0}if(e===0){return t>0?100:-100}return this._round(100*(t-e)/t,2)},_calculateDiscount:function(t,e){return t*e/100},_calculateDiscountByDiscountPrice:function(t,e,i){return 100*t/(100-e)-t},_calculatePrice:function(t,e,i){if(i===BX.CrmDiscountType.percentage){return t-t*e/100}if(i===BX.CrmDiscountType.monetary){return t-e}return 0},_calculateSumTotal:function(){var t=this._settings["TAX_INCLUDED"]?this._settings["PRICE"]*this._settings["QUANTITY"]:BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_EXCLUSIVE"]*this._settings["QUANTITY"],this._settings["TAX_RATE"]);return this._round(t,2)},getTaxSum:function(){var t=this._settings["TAX_INCLUDED"]?this._settings["PRICE"]*this._settings["QUANTITY"]*(1-1/(1+this._settings["TAX_RATE"]/100)):this._settings["PRICE_EXCLUSIVE"]*this._settings["QUANTITY"]*this._settings["TAX_RATE"]/100;return this._round(t,2)},fieldNameByElement:function(t){var e="",i=this._container.id,s=i.length;if(BX.type.isElementNode(t)&&t.id&&s>0&&t.id.length>s+1){e=t.id.substring(s+1)}return e},clearZeroValue:function(t,e){if(t&&BX.type.isElementNode(e)){var i=-1;switch(t){case"PRICE":case"DISCOUNT":case"DISCOUNT_SUBTOTAL":case"SUM":i=2;break;case"QUANTITY":i=4;break}if(i>0){var s=this._parseFloat(e.value,i,0);if(s===0){e.value=""}}}},formatElementValue:function(t,e){if(t&&BX.type.isElementNode(e)){var i=-1;var s=-1;switch(t){case"PRICE":case"DISCOUNT_SUBTOTAL":case"SUM":s=i=2;break;case"QUANTITY":i=4;break;case"DISCOUNT":i=2;if(this._discountTypeView===BX.CrmDiscountType.monetary)s=2;break}if(i>0){var n;if(t==="DISCOUNT_SUBTOTAL")n=this._parseFloat(this._fieldValue["DISCOUNT_SUBTOTAL"],i,0);else n=this._parseFloat(e.value,i,0);if(s>=0)e.value=n.toFixed(s);else e.value=n.toString()}}},_onElementKeyUp:function(t,e){var i=this.fieldNameByElement(t),s;if(i){var n=e.keyCode;if(n===13||n===27||n>=37&&n<=40||n>=112&&n<=123)return;var r=this._editor.isTaxAllowed();var a=i==="TAX_INCLUDED"?!!t.checked:!!this._fieldValue["TAX_INCLUDED"];var o=this._discountTypeView;switch(i){case"PRICE":if(r&&!a)s="PRICE_NETTO";else s="PRICE_BRUTTO";break;case"MEASURE":s="MEASURE_CODE";break;case"DISCOUNT":if(o===BX.CrmDiscountType.percentage)s="DISCOUNT_RATE";else s="DISCOUNT_SUM";break;default:s=i}var l=t.type==="checkbox"?t.checked:t.value;if(this._fieldValue[s]===l)return;this._fieldValue[s]=l;this.setFieldView(s,l);if(i==="PRODUCT_NAME")this._handleProductNameChange(l);this.processFieldValueChange(s)}},_onElementChange:function(t,e){var i=this.fieldNameByElement(t),s;if(i){var n=this._editor.isTaxAllowed();var r=i==="TAX_INCLUDED"?!!t.checked:!!this._fieldValue["TAX_INCLUDED"];var a=this._discountTypeView;switch(i){case"PRICE":if(n&&!r)s="PRICE_NETTO";else s="PRICE_BRUTTO";break;case"MEASURE":s="MEASURE_CODE";break;case"DISCOUNT":if(a===BX.CrmDiscountType.percentage)s="DISCOUNT_RATE";else s="DISCOUNT_SUM";break;default:s=i}var o=t.type==="checkbox"?t.checked:t.value;if(this._fieldValue[s]===o)return;this._fieldValue[s]=o;this.setFieldView(s,o);if(i==="PRODUCT_NAME")this._handleProductNameChange(o);this.processFieldValueChange(s);if(i==="TAX_INCLUDED"&&this._editor.getSetting("taxUniform",true)===true)this._editor.changeTaxIncludedUniform(this,o);this._editor.processProductChange(this)}},_handleProductNameChange:function(t){var e=this._container,i=e?BX(e.id+"_PRODUCT_NAME"):null,s,n,r,a="crm-item-inp-btn",o="crm-item-inp-plus",l="crm-item-inp-arrow",h="34px";if(i){r=BX.findNextSibling(i,{class:a});if(r){n=this.getProductId();s=BX.util.trim(String(t));if(s.length>0){if(n>0){BX.removeClass(r,o);BX.addClass(r,l);r.setAttribute("title",BX.CrmProductEditorMessages["openProductCard"]);r.parentNode.style.paddingRight=h}else{BX.removeClass(r,l);if(this._editor.getSetting("canAddProduct",false)){BX.addClass(r,o);r.setAttribute("title",BX.CrmProductEditorMessages["createProduct"]);r.parentNode.style.paddingRight=h}else{r.setAttribute("title","");r.parentNode.style.paddingRight=0}}}else{this.setProductId(0);BX.removeClass(r,l+" "+o);r.setAttribute("title","");r.parentNode.style.paddingRight=0}}}},_emulateTaxIncludedElementChange:function(t){var e="TAX_INCLUDED",i=this._container,s=BX(i.id+"_"+e);if(s){t=!!t;if(s.checked!==t){s.checked=t;this._fieldValue[e]=t;this.setFieldView(e,t);this.processFieldValueChange(e)}}},_onElementFocus:function(t,e){var i=this.fieldNameByElement(t);if(i){this._focusedField=i;if(i==="PRODUCT_NAME"||i==="PRICE"||i==="QUANTITY"||i==="DISCOUNT"||i==="DISCOUNT_SUBTOTAL"||i==="SUM"){this._editor.handleProductFocusChange(this,true)}this.clearZeroValue(i,t)}},_onElementBlur:function(t,e){var i=this.fieldNameByElement(t);if(i){if(this._focusedField===i)this._focusedField=null;if(i==="PRODUCT_NAME"||i==="PRICE"||i==="QUANTITY"||i==="DISCOUNT"||i==="DISCOUNT_SUBTOTAL"||i==="SUM"){if(i==="SUM"&&this._sumValueAfterBlur!==null){this.setFieldValue("SUM",this._sumValueAfterBlur);this._sumValueAfterBlur=null}this._editor.handleProductFocusChange(this,false)}this.formatElementValue(i,t)}},_onProductNameButtonClick:function(t,e){if(BX.hasClass(t,"crm-item-inp-arrow")){var i=this._getProductShowUrl();if(i)window.open(i)}else if(BX.hasClass(t,"crm-item-inp-plus")){this.createInCatalogViaDialog(BX.type.isDomNode(t)?t:null)}},_getProductShowUrl:function(){var t=null,e,i;if(this._editor){e=this._editor.getPathToProductShow();if(e&&typeof e==="string"&&e.length>0){i=parseInt(this.getProductId());if(i>0){t=e.replace("#product_id#",i)}}}return t},createInCatalog:function(){var t,e;var i,s,n;var r,a,o;this.saveSettings();s=0;n=this._editor.getSetting("defaultMeasure",null);if(n){if(n.hasOwnProperty("ID"))s=n["ID"]}i=this.getMeasureIdByCode(this.getMeasureCode());if(i===0)i=s;a=0;o="N";if(this._editor.isTaxAllowed()){r=parseFloat(this.getTaxRate());a=this._editor.getTaxIdByValue(r);o=a!==0&&this.getSetting("TAX_INCLUDED",false)?"Y":"N"}t={NAME:this.getSetting(this._fixProductName?"FIXED_PRODUCT_NAME":"PRODUCT_NAME",""),DESCRIPTION:"",ACTIVE:"Y",CURRENCY:this._editor.getCurrencyId(),PRICE:o==="Y"?this.getSetting("PRICE_BRUTTO",0).toFixed(2):this.getSetting("PRICE_NETTO",0).toFixed(2),MEASURE:i,VAT_ID:a,VAT_INCLUDED:o,SECTION_ID:0,SORT:100,sessid:this._editor.getSetting("sessid",""),ajax:"Y"};e=String(this._editor.getSetting("pathToProductEdit","")).replace("#product_id#","0");BX.ajax({url:e,method:"POST",dataType:"json",data:t,onsuccess:BX.delegate(this.onCreateInCatalogSuccess,this),onfailure:BX.delegate(this.onCreateInCatalogFailure,this)})},onCreateInCatalogSuccess:function(t){var e=0,i="",s,n,r,a="crm-item-inp-btn",o="crm-item-inp-plus",l="crm-item-inp-arrow",h="34px";BX.closeWait();i=t["err"]!==""?t["err"]:"";e=parseInt(t["productId"])>0?parseInt(t["productId"]):0;if(e>0){this.setProductId(e);s=this._container;n=s?BX(s.id+"_PRODUCT_NAME"):null;if(n){r=BX.findNextSibling(n,{class:a});if(r){BX.removeClass(r,o);BX.addClass(r,l);r.setAttribute("title",BX.CrmProductEditorMessages["openProductCard"]);r.parentNode.style.paddingRight=h}}}},onCreateInCatalogFailure:function(t){},createInCatalogViaDialog:function(t){var e,i,s;var n,r,a;var o,l,h;this.saveSettings();r=0;a=this._editor.getSetting("defaultMeasure",null);if(a){if(a.hasOwnProperty("ID"))r=a["ID"]}n=this.getMeasureIdByCode(this.getMeasureCode());if(n===0)n=r;l=0;h="N";if(this._editor.isTaxAllowed()){o=parseFloat(this.getTaxRate());l=this._editor.getTaxIdByValue(o);h=l!==0&&this.getSetting("TAX_INCLUDED",false)?"Y":"N"}s={NAME:this.getSetting(this._fixProductName?"FIXED_PRODUCT_NAME":"PRODUCT_NAME",""),CURRENCY:this._editor.getCurrencyId(),PRICE:h==="Y"?this.getSetting("PRICE_BRUTTO",0).toFixed(2):this.getSetting("PRICE_NETTO",0).toFixed(2),MEASURE:n,VAT_ID:l,VAT_INCLUDED:h};i=BX.clone(this._editor._settings["productCreateDialogSettings"]);i["initialControl"]=t;i["productAdditionHandler"]=BX.delegate(this.handleSetProductFromDialog,this);i["customValues"]=s;e=new BX.CrmProductCreateDialog(i);e.show()},handleSetProductFromDialog:function(t){var e=typeof t["product"]!="undefined"&&typeof t["product"][0]!="undefined"?t["product"][0]:null;if(!e)return;this.saveSettings();var i=this._editor;var s=this.getQuantity();var n=this.getDiscountTypeId();var r=n===BX.CrmDiscountType.percentage?this.getDiscountRate():this.getDiscountSum();i.handleProductSearchSelect(this,e);this.setFieldValue("DISCOUNT_TYPE_ID",parseInt(n));if(n===BX.CrmDiscountType.percentage)this.setFieldValue("DISCOUNT_RATE",this._round(parseFloat(r),2),true);else this.setFieldValue("DISCOUNT_SUM",parseFloat(r).toFixed(2),true);this.setFieldValue("QUANTITY",s,true)}};BX.CrmProduct.calculateExclusivePrice=function(t,e){return t/(1+e/100)};BX.CrmProduct.calculateInclusivePrice=function(t,e){return t*(1+e/100)};BX.CrmProduct.round=function(t,e){if(!BX.type.isNumber(e)){e=2}var i=Math.pow(10,e);return Math.round(t*i)/i};BX.CrmProduct.create=function(t,e,i){var s=new BX.CrmProduct;s.initialize(t,e,i);return s}}if(typeof BX.CrmProductSearch==="undefined"){BX.CrmProductSearch=function(){this._product=null;this._settings={};this.cache=[];this.cache_key=null;this._data=[];this.currentValue="";this.currentRow=-1;this.RESULT=null;this.CONTAINER=null;this.INPUT=null;this.WAIT=null;this._handleOnChange=true;this._onChangeTimer=null;this.focused=false};BX.CrmProductSearch.prototype={initialize:function(t,e){this._product=e;this._settings={AJAX_PAGE:t["AJAX_PAGE"],CONTAINER_ID:t["CONTAINER_ID"],INPUT_ID:t["INPUT_ID"],MIN_QUERY_LEN:parseInt(t["MIN_QUERY_LEN"])};if(t["WAIT_IMAGE"])this._settings["WAIT_IMAGE"]=t["WAIT_IMAGE"];if(this._settings["MIN_QUERY_LEN"]<=0)this._settings["MIN_QUERY_LEN"]=3;this.CONTAINER=document.getElementById(this._settings["CONTAINER_ID"]);this.RESULT=document.body.appendChild(document.createElement("DIV"));this.RESULT.className="title-search-result";this.INPUT=document.getElementById(this._settings["INPUT_ID"]);this.currentValue=this.oldValue=this.INPUT.value;BX.bind(this.INPUT,"focus",BX.delegate(this.onFocusGain,this));BX.bind(this.INPUT,"blur",BX.delegate(this.onFocusLost,this));BX.bind();this.INPUT.onkeydown=BX.delegate(this.onKeyDown,this);if(this._settings["WAIT_IMAGE"]){this.WAIT=document.body.appendChild(document.createElement("DIV"));this.WAIT.style.backgroundImage="url('"+this._settings["WAIT_IMAGE"]+"')";if(!BX.browser.IsIE())this.WAIT.style.backgroundRepeat="none";this.WAIT.style.display="none";this.WAIT.style.position="absolute";this.WAIT.style.zIndex="1100"}BX.bind(this.INPUT,"bxchange",BX.delegate(this.onChangeDelayed,this))},showResult:function(t){var e=BX.pos(this.CONTAINER);e.width=e.right-e.left;this.RESULT.style.position="absolute";this.RESULT.style.top=e.bottom+2+"px";this.RESULT.style.left=e.left+"px";this.RESULT.style.width=e.width+"px";if(t!=null)this.RESULT.innerHTML=t;if(this.RESULT.innerHTML.length>0&&this.INPUT.value!==this.currentValue&&this.focused)this.RESULT.style.display="block";else this.RESULT.style.display="none";var i;var s=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);if(s)i=BX.findChild(s,{tag:"th"},true);if(i){var n=BX.pos(s);n.width=n.right-n.left;var r=BX.pos(i);r.width=r.right-r.left;i.style.width=r.width+"px";this.RESULT.style.width=e.width+r.width+"px";this.RESULT.style.left=e.left-r.width-1+"px";if(n.width-r.width>e.width)this.RESULT.style.width=e.width+r.width-1+"px";n=BX.pos(s);var a=BX.pos(this.RESULT);if(a.right>n.right){this.RESULT.style.width=n.right-n.left+"px"}}var o;if(s)o=BX.findChild(this.RESULT,{class:"title-search-fader"},true);if(o&&i){a=BX.pos(this.RESULT);o.style.left=a.right-a.left-18+"px";o.style.width=18+"px";o.style.top=0+"px";o.style.height=a.bottom-a.top+"px";o.style.display="block"}},onKeyPress:function(t){var e=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);if(!e)return false;var i=e.rows.length,s;switch(t){case 27:this.RESULT.style.display="none";this.currentRow=-1;this.unselectAll();this.currentValue=this.INPUT.oldValue=this.INPUT.value;return true;case 40:if(this.RESULT.style.display=="none")this.RESULT.style.display="block";var n=-1;for(s=0;s<i;s++){if(!BX.findChild(e.rows[s],{class:"title-search-separator"},true)){if(n==-1)n=s;if(this.currentRow<s){this.currentRow=s;break}else if(e.rows[s].className=="title-search-selected"){e.rows[s].className=""}}}if(s==i&&this.currentRow!=s)this.currentRow=n;e.rows[this.currentRow].className="title-search-selected";return true;case 38:if(this.RESULT.style.display=="none")this.RESULT.style.display="block";var r=-1;for(s=i-1;s>=0;s--){if(!BX.findChild(e.rows[s],{class:"title-search-separator"},true)){if(r==-1)r=s;if(this.currentRow>s){this.currentRow=s;break}else if(e.rows[s].className=="title-search-selected"){e.rows[s].className=""}}}if(s<0&&this.currentRow!=s)this.currentRow=r;e.rows[this.currentRow].className="title-search-selected";return true;case 13:if(this.RESULT.style.display=="block"){for(s=0;s<i;s++){if(this.currentRow==s){this.RESULT.style.display="none";this.currentRow=-1;this.unselectAll();this.handleSelectItem(s)}}}return true}return false},onTimeout:function(){this.onChange(function(){setTimeout(BX.delegate(this.onTimeout,this),500)})},onChangeDelayed:function(){if(this._handleOnChange&&this.INPUT.value!=this.oldValue){this.RESULT.style.display="none";this.RESULT.innerHTML="";if(this.INPUT.value.length>=this._settings["MIN_QUERY_LEN"]){this.cache_key=this._settings["INPUT_ID"]+"|"+this.INPUT.value;if(this.cache[this.cache_key]==null){if(this._onChangeTimer)clearTimeout(this._onChangeTimer);this._onChangeTimer=setTimeout(BX.delegate(this.onChange,this),500);return}}this.onChange()}},onChange:function(){if(this._handleOnChange&&this.INPUT.value!=this.oldValue){this.RESULT.style.display="none";this.RESULT.innerHTML="";this.currentValue=null;this.oldValue=this.INPUT.value;if(this.INPUT.value.length>=this._settings["MIN_QUERY_LEN"]){this.cache_key=this._settings["INPUT_ID"]+"|"+this.INPUT.value;if(this.cache[this.cache_key]==null){if(this.WAIT){var t=BX.pos(this.INPUT);var e=t.bottom-t.top-2;this.WAIT.style.top=t.top+1+"px";this.WAIT.style.height=e+"px";this.WAIT.style.width=e+"px";this.WAIT.style.left=t.right-e+2+"px";this.WAIT.style.display="block"}var i=this._product._editor.getCurrencyId();BX.ajax({url:this._settings["AJAX_PAGE"],method:"POST",dataType:"json",data:{MODE:"SEARCH",RESULT_WITH_VALUE:"Y",CURRENCY_ID:i,ENABLE_RAW_PRICES:"Y",ENABLE_SEARCH_BY_ID:"N",MULTI:"N",VALUE:this.INPUT.value,LIMIT:5},onsuccess:BX.delegate(this.onProductSearchResponseSuccess,this),onfailure:BX.delegate(this.onProductSearchResponseFailure,this)})}else{var s=this.makeHtmlFromResult(this.cache[this.cache_key]);this.showResult(s);this.currentRow=-1;this.enableMouseEvents()}}else{this.RESULT.style.display="none";this.currentRow=-1;this.unselectAll();this.cache=[]}}},onProductSearchResponseSuccess:function(t){var e,i=t["data"];this.cache_key=this._settings["INPUT_ID"]+"|"+t["searchValue"];this.cache[this.cache_key]=i;if(this.INPUT.value===t["searchValue"]){e=this.makeHtmlFromResult(i);this.showResult(e)}this.currentRow=-1;this.enableMouseEvents();if(this.WAIT)this.WAIT.style.display="none"},onProductSearchResponseFailure:function(t){},makeHtmlFromResult:function(t){var e="",i,s;this._data=[];if(BX.type.isArray(t)&&t.length>0){e+='<table class="title-search-result">';for(s=0;s<t.length;s++){i=t[s];if(i&&i.hasOwnProperty("title")){e+='<tr id="row_'+s+'">';e+='<td class="title-search-item">'+i["title"]+"</td>";e+="</tr>";this._data[s]=i}}e+="</table>"}return e},unselectAll:function(){var t=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);if(t){var e=t.rows.length;for(var i=0;i<e;i++)t.rows[i].className=""}},enableMouseEvents:function(){var t=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);var e=this;if(t){var i=t.rows.length;for(var s=0;s<i;s++)if(!BX.findChild(t.rows[s],{class:"title-search-separator"},true)){t.rows[s].id="row_"+s;t.rows[s].onmouseover=function(t){BX.delegate(e.onMouseOver,e)(this,t)};t.rows[s].onmouseout=function(t){BX.delegate(e.onMouseOut,e)(this,t)};BX.bind(t.rows[s],"click",function(){BX.delegate(e.handleSelectItem,e)(this.id.substr(4))})}}},onMouseOver:function(t,e){if(this.currentRow!=t.id.substr(4)){this.unselectAll();t.className="title-search-selected";this.currentRow=t.id.substr(4)}},onMouseOut:function(t,e){t.className="";this.currentRow=-1},onFocusGain:function(){this.focused=true},onFocusLost:function(){this.focused=false;setTimeout(BX.delegate(this.handleFocusLostTimer,this),250);this.currentValue=this.INPUT.value},handleFocusLostTimer:function(){this.RESULT.style.display="none"},onKeyDown:function(t){if(!t)t=window.event;if(this.RESULT.style.display=="block"){if(this.onKeyPress(t.keyCode))return BX.PreventDefault(t)}},handleSelectItem:function(t){if(this._product&&this._product._editor){var e=this._product._editor;this.disableOnChangeHandler();this.currentValue=this.oldValue=this._data[t]["title"];e.handleProductSearchSelect(this._product,this._data[t]);this.enableOnChangeHandler()}},enableOnChangeHandler:function(){this._handleOnChange=true},disableOnChangeHandler:function(){this._handleOnChange=false}};BX.CrmProductSearch.create=function(t,e){var i=new BX.CrmProductSearch;i.initialize(t,e);return i}}if(typeof BX.CrmProductRowListPlaceholder==="undefined"){BX.CrmProductRowListPlaceholder=function(){this._settings=null;this._node=null;this._editor=null;this._productId="";this._productIndex=-1};BX.CrmProductRowListPlaceholder.prototype={initialize:function(t){this._settings=t?t:{};this._node=this.getSetting("node",null);this._editor=this.getSetting("editor",null);this._productId=this.getSetting("productId","");this._productIndex=parseInt(this.getSetting("productIndex",-1))},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getNode:function(){return this._node},setNode:function(t){this._node=t},getProductId:function(){return this._productId},getProductIndex:function(){return this._productIndex},layout:function(){if(!this._node){throw"CrmProductRowListPlaceholder: The 'node' is not assigned."}var t=this._node;t.height="30px";var e=t.insertCell(-1);e.className="crm-item-cell";e.colSpan=8}};BX.CrmProductRowListPlaceholder.create=function(t){var e=new BX.CrmProductRowListPlaceholder;e.initialize(t);return e}}if(typeof BX.CrmProdoctRowListDragItem==="undefined"){BX.CrmProdoctRowListDragItem=function(){BX.CrmProdoctRowListDragItem.superclass.constructor.apply(this);this._product=null;this._container=null;this._showInDragMode=true;this._ghostWidth=0;this._ghostHeight=0};BX.extend(BX.CrmProdoctRowListDragItem,BX.CrmCustomDragItem);BX.CrmProdoctRowListDragItem.prototype.doInitialize=function(){this._product=this.getSetting("product");if(!this._product){throw"CrmProdoctRowListDragItem: The 'product' parameter is not defined in settings or empty."}this._container=this.getSetting("container");if(!this._container){throw"CrmProdoctRowListDragItem: The 'container' parameter is not defined in settings or empty."}this._showInDragMode=this.getSetting("showInDragMode",true)};BX.CrmProdoctRowListDragItem.prototype.getProduct=function(){return this._product};BX.CrmProdoctRowListDragItem.prototype.createGhostNode=function(){if(this._ghostNode){return this._ghostNode}this._ghostNode=this._product.createGhostNode();document.body.appendChild(this._ghostNode);var t=BX.pos(this._ghostNode);this._ghostWidth=t.width;this._ghostHeight=t.height};BX.CrmProdoctRowListDragItem.prototype.removeGhostNode=function(){if(this._ghostNode){document.body.removeChild(this._ghostNode);this._ghostNode=null}};BX.CrmProdoctRowListDragItem.prototype.getContextId=function(){return BX.CrmProdoctRowListDragItem.contextId};BX.CrmProdoctRowListDragItem.prototype.getContextData=function(){return{contextId:BX.CrmProdoctRowListDragItem.contextId,product:this._product}};BX.CrmProdoctRowListDragItem.prototype.processDragStart=function(){if(!this._showInDragMode){this._product.getContainer().style.display="none";BX.CrmProdoctRowListDragContainer.refresh()}};BX.CrmProdoctRowListDragItem.prototype._onDrag=function(t,e){if(!this._isInDragMode){return}if(this._ghostNode){t+=this._ghostOffset.x;e+=this._ghostOffset.y;var i=BX.pos(this._container);if(t<i.left||t+this._ghostWidth>i.right){t=i.left}if(e<i.top){e=i.top}else if(e>i.bottom){e=i.bottom}this._ghostNode.style.top=e+"px";this._ghostNode.style.left=t+"px"}this._dragNotifier.notify([t,e])};BX.CrmProdoctRowListDragItem.prototype.processDragStop=function(){if(!this._showInDragMode){this._product.getContainer().style.display="";BX.CrmProdoctRowListDragContainer.refresh()}};BX.CrmProdoctRowListDragItem.contextId="product_row_list_item";BX.CrmProdoctRowListDragItem.create=function(t,e){var i=new BX.CrmProdoctRowListDragItem;i.initialize(t,e);return i}}if(typeof BX.CrmProdoctRowListDragContainer==="undefined"){BX.CrmProdoctRowListDragContainer=function(){BX.CrmProdoctRowListDragContainer.superclass.constructor.apply(this);this._editor=null};BX.extend(BX.CrmProdoctRowListDragContainer,BX.CrmCustomDragContainer);BX.CrmProdoctRowListDragContainer.prototype.doInitialize=function(){this._editor=this.getSetting("editor");if(!this._editor){throw"CrmProdoctRowListDragContainer: The 'editor' parameter is not defined in settings or empty."}};BX.CrmProdoctRowListDragContainer.prototype.getEditor=function(){return this._editor};BX.CrmProdoctRowListDragContainer.prototype.createPlaceHolder=function(t){var e;var i=this._editor.getPlaceHolder();if(i){e=BX.pos(i.getNode());if(t.y>=e.top&&t.y<=e.bottom){return}}var s="";var n=-1;var r=this._editor.getProducts();for(var a=0;a<r.length;a++){var o=r[a];e=BX.pos(o.getContainer());if(t.y>=e.top&&t.y<=e.bottom){if(e.top+e.height/2-t.y>=0){s=o.getId();n=a}else if(a<r.length-1){s=r[a+1].getId();n=a+1}break}}this._editor.createPlaceHolder({id:s,index:n})};BX.CrmProdoctRowListDragContainer.prototype.removePlaceHolder=function(){this._editor.removePlaceHolder()};BX.CrmProdoctRowListDragContainer.prototype.isAllowedContext=function(t){return t===BX.CrmProdoctRowListDragItem.contextId};BX.CrmProdoctRowListDragContainer.enable=function(t,e){e=parseInt(e);if(e>0){window.setTimeout(function(){BX.CrmProdoctRowListDragContainer.enable(t,0)});return}for(var i in this.items){if(this.items.hasOwnProperty(i)){this.items[i].enable(t)}}};BX.CrmProdoctRowListDragContainer.refresh=function(){for(var t in this.items){if(this.items.hasOwnProperty(t)){this.items[t].refresh()}}};BX.CrmProdoctRowListDragContainer.items={};BX.CrmProdoctRowListDragContainer.create=function(t,e){var i=new BX.CrmProdoctRowListDragContainer;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmProductSearchDialogWindow==="undefined"){BX.CrmProductSearchDialogWindow=function(){this._settings={};this.popup=null;this.random="";this.contentContainer=null;this.zIndex=996;this.jsEventsManager=null;this.pos=null;this.height=0;this.width=0;this.resizeCorner=null};BX.CrmProductSearchDialogWindow.prototype={initialize:function(t){this.random=Math.random().toString().substring(2);this._settings=t?t:{};var e=BX.CrmProductSearchDialogWindow.size;this._settings.width=e.width||this._settings.width||1100;this._settings.height=e.height||this._settings.height||530;this._settings.minWidth=this._settings.minWidth||500;this._settings.minHeight=this._settings.minHeight||800;this._settings.draggable=!!this._settings.draggable||true;this._settings.resizable=!!this._settings.resizable||true;if(typeof this._settings.closeWindowHandler!=="function")this._settings.closeWindowHandler=null;if(typeof this._settings.showWindowHandler!=="function")this._settings.showWindowHandler=null;this.jsEventsManager=BX.Crm[this._settings.jsEventsManagerId]||null;this.contentContainer=BX.create("DIV",{attrs:{className:"crm-catalog",style:"display: block; background-color: #f3f6f7; height: "+this._settings.height+"px; overflow: hidden; width: "+this._settings.width+"px;"}})},_handleCloseDialog:function(t){if(t)t.destroy();this.popup=null;if(this.jsEventsManager){this.jsEventsManager.unregisterEventHandlers("CrmProduct_SelectSection")}if(typeof this._settings.closeWindowHandler==="function")this._settings.closeWindowHandler()},_handleAfterShowDialog:function(t){t.popupContainer.style.position="fixed";t.popupContainer.style.top=parseInt(t.popupContainer.style.top)-BX.GetWindowScrollPos().scrollTop+"px";if(typeof this._settings.showWindowHandler==="function")this._settings.showWindowHandler()},setContent:function(t){if(BX.type.isString(t)&&BX.type.isDomNode(this.contentContainer))this.contentContainer.innerHTML=t},show:function(){BX.ajax({method:"GET",dataType:"html",url:this._settings.content_url,data:{},skipAuthCheck:true,onsuccess:BX.delegate(function(t){this.setContent(t||"&nbsp;");this.showWindow()},this),onfailure:BX.delegate(function(){if(typeof this._settings.showWindowHandler==="function")this._settings.showWindowHandler()},this)})},showWindow:function(){this.popup=new BX.PopupWindow("CrmProductSearchDialogWindow_"+this.random,null,{overlay:{opacity:82},autoHide:false,draggable:this._settings.draggable,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},bindOnResize:false,zIndex:this.zIndex-1100,closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:BX.CrmProductEditorMessages["productSearchDialogTitle"],events:{onPopupClose:BX.delegate(this._handleCloseDialog,this),onAfterPopupShow:BX.delegate(this._handleAfterShowDialog,this)},content:this.contentContainer});if(this.popup.popupContainer){this.resizeCorner=BX.create("SPAN",{attrs:{className:"bx-crm-dialog-resize"},events:{mousedown:BX.delegate(this.resizeWindowStart,this)}});this.popup.popupContainer.appendChild(this.resizeCorner);if(!this._settings.resizable)this.resizeCorner.style.display="none"}this.popup.show()},setResizable:function(t){t=!!t;if(this._settings.resizable!==t){this._settings.resizable=t;if(this.resizeCorner){if(t)this.resizeCorner.style.display="inline-block";else this.resizeCorner.style.display="none"}}},resizeWindowStart:function(t){if(!this._settings.resizable)return;t=t||window.event;BX.PreventDefault(t);this.pos=BX.pos(this.contentContainer);BX.bind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.bind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));if(document.body.setCapture)document.body.setCapture();try{document.onmousedown=false}catch(t){}try{document.body.onselectstart=false}catch(t){}try{document.body.ondragstart=false}catch(t){}try{document.body.style.MozUserSelect="none"}catch(t){}try{document.body.style.cursor="nwse-resize"}catch(t){}},resizeWindowMove:function(t){var e=BX.GetWindowScrollPos();var i=t.clientX+e.scrollLeft;var s=t.clientY+e.scrollTop;BX.CrmProductSearchDialogWindow.size.height=this.height=Math.max(s-this.pos.top,this._settings.minHeight);BX.CrmProductSearchDialogWindow.size.width=this.width=Math.max(i-this.pos.left,this._settings.minWidth);this.contentContainer.style.height=this.height+"px";this.contentContainer.style.width=this.width+"px"},resizeWindowStop:function(t){if(document.body.releaseCapture)document.body.releaseCapture();BX.unbind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.unbind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));try{document.onmousedown=null}catch(t){}try{document.body.onselectstart=null}catch(t){}try{document.body.ondragstart=null}catch(t){}try{document.body.style.MozUserSelect=""}catch(t){}try{document.body.style.cursor="auto"}catch(t){}}};BX.CrmProductSearchDialogWindow.create=function(t){var e=new BX.CrmProductSearchDialogWindow;e.initialize(t);return e};BX.CrmProductSearchDialogWindow.loadCSS=function(t){BX.ajax({method:"GET",dataType:"html",url:t.content_url,data:{},skipAuthCheck:true})};BX.CrmProductSearchDialogWindow.size={width:0,height:0}}if(typeof BX.Crm.PageEventsManagerClass==="undefined"){BX.Crm.PageEventsManagerClass=function(){this._settings={}};BX.Crm.PageEventsManagerClass.prototype={initialize:function(t){this._settings=t?t:{};this.eventHandlers={}},registerEventHandler:function(t,e){if(!this.eventHandlers[t])this.eventHandlers[t]=[];this.eventHandlers[t].push(e);BX.addCustomEvent(this,t,e)},fireEvent:function(t,e){BX.onCustomEvent(this,t,e)},unregisterEventHandlers:function(t){if(this.eventHandlers[t]){for(var e=0;e<this.eventHandlers[t].length;e++){BX.removeCustomEvent(this,t,this.eventHandlers[t][e]);delete this.eventHandlers[t][e]}}}};BX.Crm.PageEventsManagerClass.create=function(t){var e=new BX.Crm.PageEventsManagerClass;e.initialize(t);return e}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:102:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/product_create.min.js?15441274018298";s:6:"source";s:83:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/product_create.js";s:3:"min";s:87:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/product_create.min.js";s:3:"map";s:87:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/product_create.map.js";}"*/
if(typeof BX.CrmProductCreateDialog==="undefined"){BX.CrmProductCreateDialog=function(e){this.settings=e;this.messages=e["messages"];this.random=Math.random().toString().substring(2);this.popupContentId="";this.errorContainerId="";this.popup=null;this.initialControl=this.settings["initialControl"]};BX.CrmProductCreateDialog.prototype={show:function(){var e=this;var t=996;var i=BX.create("TABLE",{attrs:{id:this.random+"_table",cellspacing:"7"}});var r=this.settings["fields"];var a=this.settings["messages"];var s,n,o,l,d,c,p,u,f;var h=[],m,g;f={};u=this.settings["customValues"]&&typeof this.settings["customValues"]==="object";if(u){f=this.settings["customValues"]}m=0;for(var x=0;x<r.length;x++){p=r[x]["value"];if(u&&f.hasOwnProperty(r[x]["textCode"]))p=f[r[x]["textCode"]];if(r[x]["skip"]==="Y")continue;o=r[x]["type"];c=parseInt(r[x]["maxLength"]);l=40;d=4;switch(o){case"select":var b={};if(r[x]["params"]&&typeof r[x]["params"]==="object"){var v=r[x]["params"];for(var B in v){if(v.hasOwnProperty(B))b[B]=v[B]}}b["id"]=this.random+"_"+x;b["className"]="bx-crm-dialog-quick-create-field-select";b["name"]=r[x]["textCode"];s=BX.create("SELECT",{style:{marginLeft:"10px"},attrs:b});this.rebuildSelect(s,r[x]["items"],p);break;case"checkbox":s=BX.create("INPUT",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,type:o,name:r[x]["textCode"]}});s.checked=p==="Y";break;case"textarea":s=BX.create("TEXTAREA",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,className:"bx-crm-dialog-quick-create-field-text-input",type:o,name:r[x]["textCode"],text:BX.util.htmlspecialchars(p),cols:l,rows:d,maxlength:c>0?c:7500}});break;case"custom":var C=BX.processHTML(p);s=BX.create("DIV",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,className:"bx-crm-dialog-quick-create-field-custom"},html:p});var X=[],I=0;for(I=0;I<C["SCRIPT"].length;I++){X[I]={TYPE:C["SCRIPT"][I].isInternal?"SCRIPT":"SCRIPT_EXT",DATA:C["SCRIPT"][I].JS}}g={scripts:X,styles:C["STYLE"]};h[m++]=g;break;default:s=BX.create("INPUT",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,className:"bx-crm-dialog-quick-create-field-text-input",type:o,name:r[x]["textCode"],value:p,size:l,maxlength:c>0?c:255}});break}var T=BX.create("TD");if("Y"===r[x]["required"])T.appendChild(BX.create("SPAN",{attrs:{style:"position: absolute; left: 18px; color: red;"},text:"*"}));T.appendChild(BX.create("SPAN",{text:a[r[x]["textCode"]]+":"}));i.appendChild(BX.create("TR",{children:[T,BX.create("TD",{children:[s]})]}))}var y=BX.create("DIV",{attrs:{id:this.random+"_error",className:"bx-crm-dialog-quick-create-error-wrap"}});var w=BX.create("DIV",{style:{marginLeft:"12px",marginTop:"12px",marginRight:"12px",marginBottom:"12px",minWidth:"600px"},attrs:{id:this.random+"_content"},children:[y,i]});var P=this.settings["url"]?BX.util.trim(this.settings["url"].toString()):"/crm/product/edit/0/";var k=BX.create("FORM",{attrs:{id:this.settings["formId"],name:this.settings["formId"],method:"POST",action:P,enctype:"multipart/form-data"}});var A=BX.create("INPUT",{attrs:{type:"hidden",name:"sessid",value:this.settings["sessid"]}});if(A)k.appendChild(A);A=BX.create("INPUT",{attrs:{type:"hidden",name:"ajaxSubmit",value:"Y"}});if(A)k.appendChild(A);A=BX.create("INPUT",{attrs:{type:"hidden",name:"currencyTo",value:this.settings["ownerCurrencyId"]}});if(A)k.appendChild(A);A=null;k.appendChild(w);var E=new BX.PopupWindow("CrmProductCreateDialog_"+this.random,this.initialControl,{overlay:{opacity:10},autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,zIndex:t-1100,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:this.messages["dialogTitle"],events:{onPopupClose:function(){if(E){E.destroy()}}},content:k,buttons:[new BX.PopupWindowButton({text:this.messages["buttonCreateTitle"],className:"popup-window-button-accept",events:{click:function(){if(E){if(w){e.popupContentId=w.id;e.errorContainerId=y.id;e.popup=E;e.createProduct()}}}}}),new BX.PopupWindowButtonLink({text:this.messages["buttonCancelTitle"],className:"popup-window-button-link-cancel",events:{click:function(){if(E)E.close()}}})]});for(m=0;m<h.length;m++){if(h[m]["scripts"].length>0)BX.evalPack(h[m]["scripts"]);if(h[m]["styles"].length>0)BX.loadCSS(h[m]["styles"])}E.show();if(E.popupContainer)BX.scrollToNode(E.popupContainer)},createProduct:function(){var e=BX(this.settings["formId"]);BX.ajax.submitAjax(e,{method:"POST",processData:false,onsuccess:BX.delegate(function(e){if(e===""){BX.closeWait();this.showAjaxError("")}var t=BX.parseJSON(e,{});if(!t){BX.closeWait();this.showAjaxError("")}var i=0,r="";BX.closeWait();r=t["err"]!==""?t["err"]:"";i=parseInt(t["productId"])>0?parseInt(t["productId"]):0;if(i>0){if(this.popup){this.popup.close();this.popup=null}if(typeof t["productData"]!=="undefined"){var a=t["productData"];if(typeof a["NAME"]!=="undefined"&&typeof a["PRICE"]!=="undefined"&&typeof(this.settings["productAdditionHandler"]==="function")){var s=this.settings["productAdditionHandler"];var n={product:[{id:i,title:a["NAME"],customData:{price:a["PRICE"],tax:{}}}]};if(typeof a["VAT_ID"]!=="undefined")n["product"][0]["customData"]["tax"]["id"]=a["VAT_ID"];if(typeof a["VAT_INCLUDED"]!=="undefined")n["product"][0]["customData"]["tax"]["included"]=a["VAT_INCLUDED"]==="Y";if(t["measureData"]&&typeof t["measureData"]==="object"){var o=t["measureData"];if(o["code"]&&parseInt(o["code"])>0&&o["name"]){n["product"][0]["customData"]["measure"]={code:o["code"],name:o["name"]}}}s(n)}}}else{this.showAjaxError(r)}},this),onfailure:BX.delegate(function(e){BX.closeWait();this.showAjaxError("")},this)})},showAjaxError:function(e){if(e==="")e=this.messages["ajaxError"];var t=BX(this.errorContainerId);if(t){t.innerHTML=e}if(this.popup.popupContainer)BX.scrollToNode(this.popup.popupContainer)},setSelectValue:function(e,t){var i,r;var a=false;var s=!!e.getAttribute("multiple");if(!(t instanceof Array))t=[t];for(i=0;i<e.options.length;i++){for(r in t){if(e.options[i].value==t[r]){if(!a){a=true;e.selectedIndex=i}e.options[i].selected=true;break}}if(!s&&a)break}},rebuildSelect:function(e,t,i){var r,a,s,n;var o=false;var l;if(!(i instanceof Array))i=[i];if(e){l=!!e.getAttribute("multiple");while(r=e.lastChild)e.removeChild(r);for(s=0;s<t.length;s++){a=document.createElement("option");a.value=t[s]["id"];a.innerHTML=BX.util.htmlspecialchars(t[s]["title"]);try{e.add(a,e.options[null])}catch(d){a=document.createElement("option");a.text=t[s]["title"];e.add(a,null)}if(!o||l){for(n=0;n<i.length;n++){if(t[s]["id"]==i[n]){a.selected=true;if(!o){o=true;e.selectedIndex=s}break}}}}}}}}if(typeof addNewTableRow==="undefined"){function addNewTableRow(e,t){var i=document.getElementById(e);var r=i.rows.length;if(t==null)t=r-1;var a=i.rows[t].cells[0].innerHTML;var s=i.insertRow(t+1);var n=s.insertCell(0);var o,l,d,c;c=0;while(true){o=a.indexOf("[n",c);if(o<0)break;l=a.indexOf("]",o);if(l<0)break;d=parseInt(a.substr(o+2,l-o));a=a.substr(0,o)+"[n"+ ++d+"]"+a.substr(l+1);c=o+1}c=0;while(true){o=a.indexOf("__n",c);if(o<0)break;l=a.indexOf("_",o+2);if(l<0)break;d=parseInt(a.substr(o+3,l-o));a=a.substr(0,o)+"__n"+ ++d+"_"+a.substr(l+1);c=l+1}c=0;while(true){o=a.indexOf("__N",c);if(o<0)break;l=a.indexOf("__",o+2);if(l<0)break;d=parseInt(a.substr(o+3,l-o));a=a.substr(0,o)+"__N"+ ++d+"__"+a.substr(l+2);c=l+2}c=0;while(true){o=a.indexOf("xxn",c);if(o<0)break;l=a.indexOf("xx",o+2);if(l<0)break;d=parseInt(a.substr(o+3,l-o));a=a.substr(0,o)+"xxn"+ ++d+"xx"+a.substr(l+2);c=l+2}c=0;while(true){o=a.indexOf("%5Bn",c);if(o<0)break;l=a.indexOf("%5D",o+3);if(l<0)break;d=parseInt(a.substr(o+4,l-o));a=a.substr(0,o)+"%5Bn"+ ++d+"%5D"+a.substr(l+3);c=l+3}var p={html:a};BX.onCustomEvent(window,"onAddNewRowBeforeInner",[p]);a=p.html;n.innerHTML=a;var u=new RegExp("<"+"script"+">[^\x00]*?<"+"/"+"script"+">","ig");var f=a.match(u);if(f){for(var h=0;h<f.length;h++){if(f[h]!=""){o=f[h].substring(8,f[h].length-9);jsUtils.EvalGlobal(o)}}}if(BX&&BX.adminPanel){BX.adminPanel.modifyFormElements(s);BX.onCustomEvent("onAdminTabsChange")}setTimeout(function(){var e=BX.findChildren(n,{tag:/^(input|select|textarea)$/i});if(e&&e.length>0){for(var t=0,i=e.length;t<i;t++){if(e[t].form&&e[t].form.BXAUTOSAVE)e[t].form.BXAUTOSAVE.RegisterInput(e[t]);else break}}},10)}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:136:"/bitrix/components/bitrix/crm.interface.form.tactile/templates/.default/bitrix/main.interface.form/tactile/script.min.js?154412740191254";s:6:"source";s:116:"/bitrix/components/bitrix/crm.interface.form.tactile/templates/.default/bitrix/main.interface.form/tactile/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
if(typeof BX.CrmFormMode==="undefined"){BX.CrmFormMode={undefined:0,view:1,edit:2}}if(typeof BX.CrmEditFormManager==="undefined"){BX.CrmEditFormManager=function(){this._id="";this._settings=null;this._form=null;this._formId="";this._tabId="";this._mode=BX.CrmFormMode.edit;this._prefix="";this._isModal=false;this._dragPriority=-1;this._inShortListOptionEnabled=false;this._settingsManager=null;this._userFieldManager=null};BX.CrmEditFormManager.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(8);this._settings=t?t:{};this._form=this.getSetting("form",null);this._formId=this.getSetting("formId","");this._tabId=this.getSetting("tabId","");if(!BX.type.isNotEmptyString(this._tabId)){this._tabId="tab_1"}if(!BX.type.isNotEmptyString(this._formId)){throw"Error: The 'formId' parameter is not defined in settings or empty."}this._mode=this.getSetting("mode",BX.CrmFormMode.edit);this._prefix=this.getSetting("prefix","");this._isModal=this.getSetting("isModal",false)===true;this._dragPriority=parseInt(this.getSetting("dragPriority",-1));this._inShortListOptionEnabled=this.getSetting("enableInShortListOption",false)===true;this._settingsManager=BX.CrmFormSettingManager.create(this._id,{formId:this._formId,manager:this,form:this._form,prefix:this._prefix,sectionWrapperId:this.getSetting("sectionWrapperId",""),undoContainerId:this.getSetting("undoContainerId",""),tabId:this._tabId,metaData:this.getSetting("metaData",{}),hiddenMetaData:this.getSetting("hiddenMetaData",{}),isSettingsApplied:this.getSetting("isSettingsApplied",false),canCreateUserField:this.getSetting("canCreateUserField",false),canCreateSection:this.getSetting("canCreateSection",false),canSaveSettingsForAll:this.getSetting("canSaveSettingsForAll",false),inShortListOptionEnabled:this._inShortListOptionEnabled,isModal:this._isModal,enableFieldDrag:this.getSetting("enableFieldDrag",true),enableSectionDrag:this.getSetting("enableSectionDrag",true),dragPriority:this._dragPriority});var i=this.getSetting("userFieldEntityId","");if(BX.type.isNotEmptyString(i)){this._userFieldManager=BX.CrmFormUserFieldManager.create(this._id,{manager:this,serviceUrl:this.getSetting("userFieldServiceUrl"),serverTime:this.getSetting("serverTime"),entityId:i,canCreate:this.getSetting("canCreateUserField",false),addFieldButton:this._formId+"_add_field"})}BX.addCustomEvent(window,"CrmQuickPanelViewExpanded",BX.delegate(this._onQuickPanelViewExpand,this));var n=["saveAndView","saveAndAdd","save","apply","continue"];for(var r=0,s=n.length;r<s;r++){BX.bind(BX(this._formId+"_"+n[r]),"click",BX.delegate(this._onSubmit,this))}},release:function(e){this._settingsManager.release(e);if(this._userFieldManager.getManager()===this){this._userFieldManager.release()}},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getId:function(){return this._id},getMode:function(){return this._mode},getSettingsManager:function(){return this._settingsManager},getUserFieldManager:function(){return this._userFieldManager},_onQuickPanelViewExpand:function(e,t){this._settingsManager.setViewModeVisibility(t)},_onSubmit:function(e){var t=BX.getEventTarget(e);if(t){window.setTimeout(function(){t.disabled=true},0)}}};BX.CrmEditFormManager.items={};BX.CrmEditFormManager.create=function(e,t){var i=new BX.CrmEditFormManager;i.initialize(e,t);this.items[i.getId()]=i;return i}}if(typeof BX.CrmFormSettingManager==="undefined"){BX.CrmFormSettingManager=function(){this._id="";this._settings=null;this._manager=null;this._form=null;this._formId="";this._prefix="";this._sectionWrapperId="";this._undoContainerId="";this._menuButton=null;this._menu=null;this._menuId="";this._isMenuShown=false;this._tabId="";this._metaData=null;this._hiddenMetaData=null;this._editData=null;this._isSettingsApplied=false;this._isModal=false;this._dragPriority=-1;this._inShortListOptionEnabled=false;this._enableSectionDrag=true;this._enableFieldDrag=true;this._draggableFieldContextId="";this._draggableSectionContextId="";this._dragDropUndoData=null;this._sectionSettings={};this._fieldSettings={};this._temporaryFields={};this._temporaryFieldCounter=0;this._temporarySection=null;this._placeHolder=null;this._dragContainer=null;this._canCreateUserField=false;this._canCreateSection=false;this._needToReload=false;this._fieldDropHandler=BX.delegate(this._onFieldDrop,this);this._sectionDropHandler=BX.delegate(this._onSectionDrop,this)};BX.CrmFormSettingManager.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(8);this._settings=t?t:{};this._form=this.getSetting("form",null);this._formId=this.getSetting("formId","");if(!BX.type.isNotEmptyString(this._formId)){throw"Error: The 'formId' parameter is not defined in settings or empty."}this._prefix=this.getSetting("prefix","");this._menuButton=BX(this._formId+"_menu");if(this._menuButton){BX.bind(this._menuButton,"click",BX.delegate(this._onMenuButtonClick,this))}this._menuId=this._id.toLowerCase()+"_main_menu";this._sectionWrapperId=this.getSetting("sectionWrapperId","");this._undoContainerId=this.getSetting("undoContainerId","");this._tabId=this.getSetting("tabId","");if(!BX.type.isNotEmptyString(this._tabId)){this._tabId="tab_1"}this._metaData=this.getSetting("metaData",null);if(!BX.type.isPlainObject(this._metaData)){throw"Error: The 'metaData' parameter is not defined in settings or empty."}this._hiddenMetaData=this.getSetting("hiddenMetaData",null);if(BX.type.isArray(this._hiddenMetaData)){this._hiddenMetaData={}}else if(!BX.type.isPlainObject(this._hiddenMetaData)){throw"Error: The 'hiddenMetaData' parameter is not defined in settings or empty."}this._manager=this.getSetting("manager",null);this._canCreateUserField=this.getSetting("canCreateUserField",false);this._canCreateSection=this.getSetting("canCreateSection",false);this._inShortListOptionEnabled=this.getSetting("inShortListOptionEnabled",false)===true;this._dragPriority=parseInt(this.getSetting("dragPriority",-1));this._isModal=this.getSetting("isModal",false)===true;if(this._isModal&&this._dragPriority===-1){this._dragPriority=1}this._isSettingsApplied=this.getSetting("isSettingsApplied",false);var i=this.getFormId().toLowerCase()+"_";this._draggableFieldContextId=i+BX.CrmFormFieldDragItem.contextId;this._draggableSectionContextId=i+BX.CrmFormSectionDragItem.contextId;this._enableSectionDrag=this.getSetting("enableSectionDrag",true);this._enableFieldDrag=this.getSetting("enableFieldDrag",true);this._initializeFromMetaData();this._dragContainer=BX.CrmFormSectionDragContainer.create(this._id,{manager:this,node:BX(this._sectionWrapperId),contextId:this._draggableSectionContextId});this._dragContainer.addDragFinishListener(this._sectionDropHandler);BX.onCustomEvent(window,"CrmFormSettingManagerCreate",[this]);if(!this._isModal){var n=BX.CrmDragDropBin.getInstance();BX.addCustomEvent(n,"CrmDragDropBinItemDrop",BX.delegate(this._onDragDropBinItemDrop,this))}},_initializeFromMetaData:function(){this._editData=[];for(var e in this._metaData){if(!this._metaData.hasOwnProperty(e)){continue}var t=BX.clone(this._metaData[e]);var i=[];var n=BX.type.isPlainObject(this._metaData[e]["fields"])?this._metaData[e]["fields"]:{};for(var r in n){if(n.hasOwnProperty(r)){i.push(BX.clone(n[r]))}}t["fields"]=i;this._editData.push(t)}var s=this._metaData.hasOwnProperty(this._tabId)?this._metaData[this._tabId]:null;if(!(s&&typeof s==="object")){throw"Error: Could not find '"+this._tabId+"' in metaData."}var o=s["fields"];if(BX.type.isPlainObject(o)){var a=!this._isModal;for(var d in o){if(!o.hasOwnProperty(d)){continue}var l=o[d];var h=BX.type.isNotEmptyString(l["type"])?l["type"]:"";if(h==="section"){if(!this.getSectionNode(d)){continue}this._sectionSettings[d]=BX.CrmFormSectionSetting.create(d,{manager:this,data:l,draggableFieldContextId:this._draggableFieldContextId,draggableSectionContextId:this._draggableSectionContextId,enableDrag:this._enableSectionDrag,enableDragDropBin:a})}else{if(!this.getFieldNode(d)){continue}this._fieldSettings[d]=BX.CrmFormFieldSetting.create(d,{manager:this,data:l,draggableContextId:this._draggableFieldContextId,enableDrag:this._enableFieldDrag,enableDragDropBin:a,inShortListOptionEnabled:this._inShortListOptionEnabled})}}}if(!this.hasSections()){this.createTemporarySection()}},release:function(e){e=!!e;for(var t in this._fieldSettings){if(this._fieldSettings.hasOwnProperty(t)){this._fieldSettings[t].release(e)}}this._fieldSettings={};for(var i in this._sectionSettings){if(this._sectionSettings.hasOwnProperty(i)){this._sectionSettings[i].release(e)}}this._sectionSettings={}},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getId:function(){return this._id},getFormId:function(){return this._formId},getFormNodeId:function(){return"form_"+this._formId},getForm:function(){return BX(this.getFormNodeId())},getFormMode:function(){return this._manager.getMode()},getTabId:function(){return this._tabId},getManager:function(){return this._manager},hasHiddenFields:function(){for(var e in this._hiddenMetaData){if(!this._hiddenMetaData.hasOwnProperty(e)){continue}var t=this._hiddenMetaData[e];var i=BX.type.isNotEmptyString(t["type"])?t["type"]:"";if(i!=="section"){return true}}return false},getHiddenFieldInfos:function(){var e=[];for(var t in this._hiddenMetaData){if(!this._hiddenMetaData.hasOwnProperty(t)){continue}var i=this._hiddenMetaData[t];var n=BX.type.isNotEmptyString(i["type"])?i["type"]:"";if(n==="section"){continue}e.push(i)}return e},canCreateUserField:function(){return this._canCreateUserField},createTemporaryField:function(e,t){this._temporaryFieldCounter++;var i=this.getMessage("newFieldName")+" "+this._temporaryFieldCounter.toString();var n=this._manager.getUserFieldManager().createTemporaryField({type:e,label:i});var r=t.getContentsNode();var s=r.rows.length-1;var o=n.getFieldName();var a="text";if(e==="boolean"){a="checkbox"}else if(e==="datetime"){a="date"}var d=BX.CrmFormFieldSetting.create(o,{manager:this,data:{id:o,type:a,userFieldType:e,name:i,isRQ:this._inShortListOptionEnabled?true:false},draggableContextId:this._draggableFieldContextId,inShortListOptionEnabled:this._inShortListOptionEnabled,isTemporary:true,editMode:true,node:BX.CrmFormFieldRenderer.renderUserFieldRow(n,r,{index:s,prefix:this._prefix,enableDrag:this._enableFieldDrag})});this._temporaryFields[o]={field:d,section:t}},canCreateSection:function(){return this._canCreateSection},createSection:function(e){var t=0;if(this._temporarySection!==e){var i=this.getSectionLocation(e.getId());t=i.index;if(t<0){return}t+=i.length+1}var n="section_"+BX.util.getRandomString(8).toLocaleLowerCase();var r={type:"section",id:n,name:this.getMessage("newSectionName")};var s=this._editData.length;for(var o=0;o<s;o++){var a=this._editData[o];if(a["id"]!==this._tabId){continue}var d=a["fields"];if(!BX.type.isArray(d)){return}if(t>=d.length){d.push(r)}else{d.splice(t,0,r)}}var l=BX.CrmFormFieldRenderer.renderSectionTable(r,{canCreateSection:this.canCreateSection(),canCreateUserField:this.canCreateUserField(),containerNode:BX(this._sectionWrapperId),index:this._temporarySection!==e?this.getSectionRootIndex(e.getId())+1:0,prefix:this._prefix});this._sectionSettings[n]=BX.CrmFormSectionSetting.create(n,{manager:this,data:r,draggableFieldContextId:this._draggableFieldContextId,draggableSectionContextId:this._draggableSectionContextId,editMode:true});var h=l.rows[0];h.draggable=true;h.setAttribute("data-dragdrop-id",n);h.setAttribute("data-dragdrop-context","field");var u=this.save(false);if(u&&this._temporarySection){this._temporarySection.release(true);this._temporarySection=null}return u},createTemporarySection:function(){if(!this.canCreateSection()){return}var e="section_"+BX.util.getRandomString(8).toLocaleLowerCase();var t={type:"section",id:e};BX.CrmFormFieldRenderer.renderSectionTable(t,{canCreateSection:true,canCreateUserField:false,canRestoreField:false,containerNode:BX(this._sectionWrapperId),index:0,prefix:this._prefix});this._temporarySection=BX.CrmFormSectionSetting.create(e,{manager:this,data:t,draggableFieldContextId:this._draggableFieldContextId,draggableSectionContextId:this._draggableSectionContextId,isTemporary:true})},createDragEffectNode:function(e){var t=e.getId();var i=BX.findChild(e.getNode(),{tagName:"SPAN",className:"crm-offer-info-label"},true,false);if(i){t=i.innerHTML.replace(/:\s*$/,"")}return BX.create("DIV",{attrs:{className:"crm-offer-draggable-item"},children:[BX.create("SPAN",{attrs:{className:"crm-offer-drg-btn"}}),BX.create("SPAN",{attrs:{className:"crm-offer-title-text"},html:t})]})},getTabFields:function(){var e=this._editData.length;for(var t=0;t<e;t++){var i=this._editData[t];if(i["id"]!==this._tabId){continue}return i["fields"]}return null},getFields:function(){return this._fieldSettings},getField:function(e){return this._fieldSettings.hasOwnProperty(e)?this._fieldSettings[e]:null},getFieldSection:function(e){if(!BX.type.isNotEmptyString(e)){return null}var t=this._editData.length;for(var i=0;i<t;i++){var n=this._editData[i];if(n["id"]!==this._tabId){continue}var r=n["fields"];if(!BX.type.isArray(r)){return-1}var s=r.length;var o="";for(var a=0;a<s;a++){var d=r[a];if(d["type"]==="section"){o=d["id"];continue}if(d["id"]===e){return this._sectionSettings.hasOwnProperty(o)?this._sectionSettings[o]:null}}}return null},getFieldIndex:function(e){if(!BX.type.isNotEmptyString(e)){return-1}var t=this._editData.length;for(var i=0;i<t;i++){var n=this._editData[i];if(n["id"]!==this._tabId){continue}var r=n["fields"];if(!BX.type.isArray(r)){return-1}var s=r.length;for(var o=0;o<s;o++){var a=r[o];if(a["id"]===e){return o}}}return-1},setFieldIndex:function(e,t,i){if(!BX.type.isNotEmptyString(e)||!BX.type.isNumber(t)||t<0){return false}i=parseInt(i);if(isNaN(i)||i<0){i=this.getFieldIndex(e)}if(i<0){return false}if(t===i){return true}var n=this._editData.length;for(var r=0;r<n;r++){var s=this._editData[r];if(s["id"]!==this._tabId){continue}var o=s["fields"];if(!BX.type.isArray(o)){return false}var a=o[i];o.splice(i,1);if(t-i>1){t--}if(t>=o.length){o.push(a)}else{o.splice(t,0,a)}}return this.save(false)},hasField:function(e){return this._fieldSettings.hasOwnProperty(e)},hasSection:function(e){return this._sectionSettings.hasOwnProperty(e)},removeField:function(e){var t=this._removeField(e)&&this.save(false);if(t){this._dragDropUndoData=null;BX.cleanNode(BX(this._undoContainerId),false)}return t},restoreField:function(e,t){if(!BX.type.isNotEmptyString(e)){return false}if(!BX.type.isNotEmptyString(t)){return false}if(!this._hiddenMetaData.hasOwnProperty(e)){return false}var i=this._hiddenMetaData[e];var n=this.getSectionLocation(t);var r=n.index;if(r<0){return false}r+=n.length+1;var s=this._editData.length;for(var o=0;o<s;o++){var a=this._editData[o];if(a["id"]!==this._tabId){continue}var d=a["fields"];if(!BX.type.isArray(d)){return false}if(r>=d.length){d.push(i)}else{d.splice(r,0,i)}}this._needToReload=true;this.save(false);return true},getSectionLocation:function(e){if(!BX.type.isNotEmptyString(e)){return{index:-1,length:0,fields:[]}}var t=this._editData.length;for(var i=0;i<t;i++){var n=this._editData[i];if(n["id"]!==this._tabId){continue}var r=n["fields"];if(!BX.type.isArray(r)){return{index:-1,length:0,fields:[]}}var s=[];var o=-1;var a=0;var d=r.length;for(var l=0;l<d;l++){var h=r[l];if(h["type"]==="section"){if(o>=0){break}else if(h["id"]===e){o=l}}else if(o>=0){s.push(h["id"]);a++}}return{index:o,length:a,fields:s}}return{index:-1,length:0,fields:[]}},getSectionIndex:function(e){var t=this.getSectionLocation(e);return t.index},setSectionIndex:function(e,t,i){if(!BX.type.isNotEmptyString(e)){return false}if(!BX.type.isNumber(t)||t<0){return false}if(!i){i=this.getSectionLocation(e)}var n=i.index;if(n<0){return false}if(t===n){return true}var r=this._editData.length;for(var s=0;s<r;s++){var o=this._editData[s];if(o["id"]!==this._tabId){continue}var a=o["fields"];if(!BX.type.isArray(a)){return false}var d=a[n];var l=[];var h=i.length;if(h>0){var u=n+h;for(var c=n+1;c<=u;c++){l.push(a[c])}a.splice(n+1,h)}a.splice(n,1);if(t>=n){t-=i.length+1}if(t>=a.length){a.push(d);for(var f=0;f<l.length;f++){a.push(l[f])}}else{a.splice(t,0,d);for(var _=0;_<l.length;_++){a.splice(t+_+1,0,l[_])}}}return this.save(false)},getSectionFieldIds:function(e){var t=this.getSectionLocation(e);return t.fields},getSectionRootIndex:function(e){var t=this._editData.length;var i=0;for(var n=0;n<t;n++){var r=this._editData[n];if(r["id"]!==this._tabId){continue}var s=r["fields"];if(!BX.type.isArray(s)){return-1}var o=s.length;for(var a=0;a<o;a++){var d=s[a];if(d["type"]!=="section"){continue}if(d["id"]===e){return i}i++}}return-1},getSectionIds:function(){var e=[];var t=this._editData.length;for(var i=0;i<t;i++){var n=this._editData[i];if(n["id"]!==this._tabId){continue}var r=n["fields"];if(!BX.type.isArray(r)){return e}var s=r.length;for(var o=0;o<s;o++){var a=r[o];if(a["type"]!=="section"){continue}e.push(a["id"])}}return e},getSections:function(){var e=[];var t=this.getSectionIds();for(var i=0;i<t.length;i++){var n=t[i];var r=this._sectionSettings.hasOwnProperty(n)?this._sectionSettings[n]:null;if(r){e.push(r)}}return e},hasSections:function(){for(var e in this._sectionSettings){if(this._sectionSettings.hasOwnProperty(e)){return true}}return false},setupField:function(e,t){var i=this.getFieldIndex(e);if(i<0){return false}var n=this.getTabFields();if(!BX.type.isArray(n)){return false}n[i]=t;return this.save(false)},save:function(e){if(!this._form){return false}BX.showWait();this._form.aTabsEdit=BX.clone(this._editData);var t=BX.clone(this._editData);var i={cancel:false,data:t};BX.onCustomEvent(this,"CrmFormSettingManagerSave",[this,i]);if(i["cancel"]){return}t=i["data"];if(!BX.type.isArray(t)){return false}this._form.aTabsEdit=t;var n={callback:BX.delegate(this._onSettingsSave,this)};if(!!e&&this.getSetting("canSaveSettingsForAll",false)){n["setDefaultSettings"]=true;n["deleteUserSettings"]=true}this._form.SaveSettings(n);return true},reset:function(){this._needToReload=true;this._form.EnableSettings(false,BX.delegate(this._onSettingsDisable,this))},setViewModeVisibility:function(e){this._form.SetViewModeVisibility(e)},processFieldEditStart:function(e){},processFieldEditEnd:function(e){var t=e.getId();if(!e.isTemporary()){this.setupField(t,e.getData());return true}this._manager.getUserFieldManager().createField({type:e.getUserFieldType(),name:e.getName()},t,BX.delegate(this._onUserFieldCreate,this));return false},processFieldEditCancelation:function(e){if(!e.isTemporary()){return true}var t=e.getNode();BX.findParent(t,{tagName:"TABLE"}).deleteRow(t.rowIndex);e.release(false);delete this._temporaryFields[e.getId()];return false},processSectionEditStart:function(e){var t={section:e,cancel:false};BX.onCustomEvent(this,"CrmFormSettingManagerSectionEditStart",[this,t]);return!t.cancel},processSectionEditEnd:function(e){var t={section:e,cancel:false};BX.onCustomEvent(this,"CrmFormSettingManagerSectionEditEnd",[this,t]);if(!t.cancel){var i=e.getId();this.setupField(i,e.getData())}return true},processSectionRemove:function(e){var t={section:e,cancel:false};BX.onCustomEvent(this,"CrmFormSettingManagerSectionRemove",[this,t]);if(t.cancel===true){return false}var i=e.getId();var n=this.getSectionLocation(i);if(n.index<0){return false}var r=n.fields;var s,o,a;for(a=0;a<r.length;a++){s=r[a];if(typeof this._fieldSettings[s]==="undefined"){continue}o=this._fieldSettings[s];if(o.isRequired()||o.isPersistent()){BX.NotificationPopup.show("form_setting_section_has_required_fields",{messages:[this.getMessage("sectionHasRequiredFields")]});return false}}for(a=0;a<r.length;a++){s=r[a];if(typeof this._fieldSettings[s]==="undefined"){continue}o=this._fieldSettings[s];delete this._fieldSettings[s];var d=o.getNode();BX.findParent(d,{tagName:"TABLE"}).deleteRow(d.rowIndex);o.release(false);this._removeField(s)}delete this._sectionSettings[i];var l=e.getContentsNode();BX.findParent(l,{tagName:"DIV",className:"crm-offer-main-wrap"}).removeChild(l);e.release(false);var h=this._removeField(i)&&this.save(false);if(h&&!this.hasSections()){this.createTemporarySection()}return h},processFieldRemove:function(e){var t=e.getId();delete this._fieldSettings[t];var i=e.getNode();BX.findParent(i,{tagName:"TABLE"}).deleteRow(i.rowIndex);e.release(false);this.removeField(t);for(var n in this._sectionSettings){if(this._sectionSettings.hasOwnProperty(n)){this._sectionSettings[n].processFieldRemove(e)}}return true},getMessage:function(e){var t=BX.CrmFormSettingManager.messages;return t.hasOwnProperty(e)?t[e]:e},isModal:function(){return this._isModal},getDragPriority:function(){return this._dragPriority},resolveFieldNodeId:function(e){return this.resolveNodeId(e,"wrap")},getFieldNode:function(e){return BX(this.resolveNodeId(e,"wrap"))},resolveSectionNodeId:function(e){return this.resolveNodeId(e,"contents")},getSectionNode:function(e){return BX(this.resolveNodeId(e,"contents"))},getSectionButtonWrapperNode:function(e){return BX(this.resolveNodeId(e,"buttons"))},getSectionButtonNode:function(e,t){return BX(this.resolveNodeId(e,t))},resolveNodeId:function(e,t){var i=e.toLowerCase()+"_"+t;if(this._prefix!==""){i=this._prefix+"_"+i}return i},_findNextDragDropFieldNode:function(e){return BX.findNextSibling(e,{tagName:"TR",className:"crm-offer-row"})},_findNextDragDropSectionNode:function(e){return BX.findNextSibling(e,{tagName:"TABLE",className:"crm-offer-info-table"})},_moveDragDropFieldNode:function(e,t,i){if(!BX.type.isDomNode(i)){i=t.rows[t.rows.length-1]}t.tBodies[0].insertBefore(e,i)},_moveDragDropSectionNode:function(e,t){var i=BX(this._sectionWrapperId);if(BX.type.isDomNode(t)){i.insertBefore(e,t)}else{i.appendChild(e)}},_removeField:function(e){if(!BX.type.isNotEmptyString(e)){return false}var t=this.getFieldIndex(e);if(t<0){return false}var i=this._editData.length;for(var n=0;n<i;n++){var r=this._editData[n];if(r["id"]!==this._tabId){continue}var s=r["fields"];if(!BX.type.isArray(s)){return false}this._hiddenMetaData[e]=s[t];s.splice(t,1)}return true},_onUserFieldCreate:function(e,t,i){if(!BX.type.isNotEmptyString(t)){return}if(typeof this._temporaryFields[t]==="undefined"){return}var n=this._temporaryFields[t]["field"];var r=this._temporaryFields[t]["section"];var s=n.getData();var o=r.getId();var a=s["id"]=i.getFieldName();var d=this.getSectionLocation(o);if(d.index<0){throw"Error: Could not find '"+o+"' section location."}var l=d.index+d.length+1;var h=r.getContentsNode();n.release(false);h.deleteRow(n.getNode().rowIndex);var u=this._editData.length;for(var c=0;c<u;c++){var f=this._editData[c];if(f["id"]!==this._tabId){continue}var _=f["fields"];if(!BX.type.isArray(_)){return}if(l>=_.length){_.push(s)}else{_.splice(l,0,s)}break}var g=BX.CrmFormFieldRenderer.renderUserFieldRow(i,h,{index:h.rows.length-1,prefix:this._prefix,enableDrag:this._enableFieldDrag});this._fieldSettings[a]=BX.CrmFormFieldSetting.create(a,{manager:this,data:s,draggableContextId:this._draggableFieldContextId,inShortListOptionEnabled:this._inShortListOptionEnabled,node:g});g.draggable=true;g.setAttribute("data-dragdrop-id",a);g.setAttribute("data-dragdrop-context","field");this.save(false)},_onDragDropBinItemDrop:function(e,t){if(t instanceof BX.CrmFormFieldDragItem){var i=t.getField();if(i&&this.hasField(i.getId())){i.remove()}}else if(t instanceof BX.CrmFormSectionDragItem){var n=t.getSection();if(n&&this.hasSection(n.getId())){n.remove()}}},getDraggableFieldContextId:function(){return this._draggableFieldContextId},resolveDraggableFieldId:function(e){var t=BX.type.isNotEmptyString(e["contextId"])?e["contextId"]:"";if(t!==this._draggableFieldContextId){return""}var i=typeof e["field"]!=="undefined"?e["field"]:null;return i?i.getId():""},processDraggedFieldDrop:function(e,t){var i=e.getSection();var n=t.getContextData();var r=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(r!==this._draggableFieldContextId){return}var s=typeof n["field"]!=="undefined"?n["field"]:null;if(!s){return}var o=this.getSectionLocation(i.getId());if(o.index<0){throw"Error: Could not get section layout info."}var a=s.getId();var d=s.getNode();var l=this.getFieldSection(a);var h=this._findNextDragDropFieldNode(d);var u=i.getContentsNode();var c=i.getPlaceHolder();this._moveDragDropFieldNode(d,u,c?c.getNode():null);var f=-1;var _=c?c.getFieldId():"";if(_!==""){f=this.getFieldIndex(_)}if(f<0){f=o.index+o.length+1}var g=this.getFieldIndex(a);if(g>=0&&this.setFieldIndex(a,f,g)){f=this.getFieldIndex(a);if(f<=g){g++}this._dragDropUndoData={type:"field",id:a,node:d,contentsNode:l?l.getContentsNode():null,anchorNode:h,oldIndex:g,newIndex:f};var p=BX(this._undoContainerId);if(p){BX.cleanNode(p,false);p.appendChild(BX.create("DIV",{props:{className:"crm-view-message"},children:[BX.create("SPAN",{text:this.getMessage("saved")+" "}),BX.create("A",{props:{href:"#"},events:{click:BX.delegate(this._onSettingsChangeUndo,this)},text:this.getMessage("undo")})]}))}}},processDraggedSectionDrop:function(e){var t=e.getContextData();var i=BX.type.isNotEmptyString(t["contextId"])?t["contextId"]:"";if(i!==this._draggableSectionContextId){return}var n=typeof t["section"]!=="undefined"?t["section"]:null;if(!n){return}var r=n.getId();var s=n.getContentsNode();var o=this._findNextDragDropSectionNode(s);var a=this.getPlaceHolder();this._moveDragDropSectionNode(s,a?a.getNode():null);var d=this.getSectionLocation(r);var l=-1;var h=a?a.getSectionId():"";if(h!==""){l=this.getFieldIndex(h)}if(l<0){var u=this.getSectionIds();if(u.length>0){var c=this.getSectionLocation(u[u.length-1]);l=c.index+c.length+1}else{l=d.index}}var f=d.index;if(f>=0&&this.setSectionIndex(r,l,d)){d=this.getSectionLocation(r);l=d.index;if(l<=f){f+=d.length+1}this._dragDropUndoData={type:"section",id:r,node:s,anchorNode:o,oldIndex:f,newIndex:l};var _=BX(this._undoContainerId);if(_){BX.cleanNode(_,false);_.appendChild(BX.create("DIV",{props:{className:"crm-view-message"},children:[BX.create("SPAN",{text:this.getMessage("saved")+" "}),BX.create("A",{props:{href:"#"},events:{click:BX.delegate(this._onSettingsChangeUndo,this)},text:this.getMessage("undo")})]}))}}},getFieldDropCallback:function(){return this._fieldDropHandler},getSectionDropCallback:function(){return this._sectionDropHandler},createPlaceHolder:function(e){var t=e["id"];var i=e["index"];var n=t!==""&&this._sectionSettings.hasOwnProperty(t)?this._sectionSettings[t]:null;var r=BX(this._sectionWrapperId);if(this._placeHolder){if(this._placeHolder.getSectionIndex()===i){return this._placeHolder}r.removeChild(this._placeHolder.getNode());this._placeHolder=null}var s=BX.create("TABLE",{attrs:{className:"crm-offer-info-table"}});if(n){r.insertBefore(s,n.getContentsNode())}else{r.appendChild(s)}this._placeHolder=BX.CrmFormSectionPlaceholder.create({manager:this,node:s,sectionId:t,sectionIndex:i});this._placeHolder.layout();return this._placeHolder},getPlaceHolder:function(){return this._placeHolder},removePlaceHolder:function(){if(this._placeHolder){var e=BX(this._sectionWrapperId);e.removeChild(this._placeHolder.getNode());this._placeHolder=null}},reloadForm:function(){var e={cancel:false};BX.onCustomEvent(this,"CrmFormSettingManagerReloadForm",[this,e]);if(e["cancel"]){return}if(this._form!==null){this._form.Reload()}},_onFieldDrop:function(e,t,i,n){this.processDraggedFieldDrop(e,t)},_onSectionDrop:function(e,t,i,n){this.processDraggedSectionDrop(t)},_onSettingsSave:function(){if(this._isSettingsApplied){BX.closeWait();if(this._needToReload){this.reloadForm()}return}this._form.EnableSettings(true,BX.delegate(this._onSettingsApply,this))},_onSettingsApply:function(){BX.closeWait();this._isSettingsApplied=true;if(this._needToReload){this.reloadForm()}},_onSettingsDisable:function(){BX.closeWait();this._isSettingsApplied=false;if(this._needToReload){this.reloadForm()}},_onResetMenuItemClick:function(){this._closeMenu();this.reset()},_onSaveForAllMenuItemClick:function(){this._closeMenu();this.save(true)},_onMenuButtonClick:function(e){if(!e){e=window.event}this._openMenu();return BX.PreventDefault(e)},_openMenu:function(){if(this._isMenuShown){return}var e=[{id:"reset",text:this.getMessage("resetMenuItem"),onclick:BX.delegate(this._onResetMenuItemClick,this)}];if(this.getSetting("canSaveSettingsForAll",false)){e.push({id:"saveForAll",text:this.getMessage("saveForAllMenuItem"),onclick:BX.delegate(this._onSaveForAllMenuItemClick,this)})}if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){BX.PopupMenu.Data[this._menuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._menuId]}this._menu=BX.PopupMenu.create(this._menuId,this._menuButton,e,{autoHide:true,offsetTop:0,offsetLeft:0,angle:{position:"top",offset:10},events:{onPopupClose:BX.delegate(this._onMenuClose,this)}});this._menu.popupWindow.show();this._isMenuShown=true},_closeMenu:function(){if(this._menu&&this._menu.popupWindow){this._menu.popupWindow.close()}},_onMenuClose:function(){this._menu=null;if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){BX.PopupMenu.Data[this._menuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._menuId]}this._isMenuShown=false},_onSettingsChangeUndo:function(e){if(this._dragDropUndoData!==null){var t=this._dragDropUndoData["item"];var i,n,r,s,o;if(this._dragDropUndoData["type"]==="field"){i=this._dragDropUndoData["id"];n=this._dragDropUndoData["oldIndex"];r=this._dragDropUndoData["newIndex"];s=this._dragDropUndoData["node"];o=this._dragDropUndoData["anchorNode"];var a=this._dragDropUndoData["contentsNode"];this._moveDragDropFieldNode(s,a,o);this.setFieldIndex(i,n,r)}else if(this._dragDropUndoData["type"]==="section"){i=this._dragDropUndoData["id"];n=this._dragDropUndoData["oldIndex"];r=this._dragDropUndoData["newIndex"];s=this._dragDropUndoData["node"];o=this._dragDropUndoData["anchorNode"];this._moveDragDropSectionNode(s,o);this.setSectionIndex(i,n)}this._dragDropUndoData=null}BX.cleanNode(BX(this._undoContainerId),false);return BX.PreventDefault(e)}};BX.CrmFormSettingManager.replaceIdentity=function(e,t){for(var i=0;i<e.length;i++){for(var n=0;n<e[i]["fields"].length;n++){if(BX.type.isNotEmptyString(e[i]["fields"][n][t])){e[i]["fields"][n]["id"]=e[i]["fields"][n][t];delete e[i]["fields"][n][t]}}}};if(typeof BX.CrmFormSettingManager.messages==="undefined"){BX.CrmFormSettingManager.messages={}}BX.CrmFormSettingManager.items={};BX.CrmFormSettingManager.getItemById=function(e,t){e=BX.type.isNotEmptyString(e)?e:"";if(e===""){throw"CrmFormSettingManager: argument 'id' must be not empty string."}if(typeof this.items[e]!=="undefined"){return this.items[e]}t=!!t;if(t){e=e.toUpperCase();if(typeof this.items[e]!=="undefined"){return this.items[e]}e=e.toLowerCase();if(typeof this.items[e]!=="undefined"){return this.items[e]}}return null};BX.CrmFormSettingManager.create=function(e,t){var i=new BX.CrmFormSettingManager;i.initialize(e,t);this.items[i.getId()]=i;return i}}if(typeof BX.CrmFormFieldSetting==="undefined"){BX.CrmFormFieldSetting=function(){this._id="";this._settings=null;this._manager=null;this._data=null;this._type="";this._userFieldType="";this._isRQ=false;this._node=null;this._dragButton=null;this._editButton=null;this._delButton=null;this._labelWrapper=null;this._dataWrapper=null;this._nameInput=null;this._buttonWrapper=null;this._inShortListOptionWrapper=null;this._inShortListOptionEnabled=false;this._saveButton=null;this._cancelButton=null;this._cover=null;this._enableDrag=true;this._enableDragDropBin=true;this._draggableContextId="";this._dragItem=null;this._editMode=false;this._isTemporary=false;this._editButtonClickHandler=BX.delegate(this._onEditButtonClick,this);this._deleteButtonClickHandler=BX.delegate(this._onDeleteButtonClick,this);this._saveButtonClickHandler=BX.delegate(this._onSaveButtonClick,this);this._cancelButtonClickHandler=BX.delegate(this._onCancelButtonClick,this);this._contextMenuHandler=BX.delegate(this._onContextMenu,this);this._nameKeyPressHandler=null;this._contextMenuId="form_field_setting";this._isContextMenuShown=false};BX.CrmFormFieldSetting.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(8);this._settings=t?t:{};this._manager=this.getSetting("manager");if(!(this._manager instanceof BX.CrmFormSettingManager)){throw"Error: The 'manager' argument must be CrmFormSettingManager instance."}this._data=this.getSetting("data");if(!BX.type.isPlainObject(this._data)){throw"Error: The 'data' parameter is not found in settings."}this._type=BX.type.isNotEmptyString(this._data["type"])?this._data["type"]:"text";this._userFieldType=BX.type.isNotEmptyString(this._data["userFieldType"])?this._data["userFieldType"]:"";this._isRQ=this._data["isRQ"]===true;this._inShortList=this._data["inShortList"]===true;this._inShortListOptionEnabled=this.getSetting("inShortListOptionEnabled",false)===true&&this._isRQ;this._inShortListOptionWrapper=null;this._inShortListOptionCheckbox=null;this._node=this._manager.getFieldNode(e);if(!BX.type.isElementNode(this._node)){throw"Error: Could not find field node."}var i=cssQuery("span.crm-offer-drg-btn",this._node);if(i.length>0){this._dragButton=i[0];BX.bind(this._dragButton,"contextmenu",this._contextMenuHandler)}if(this._type==="vertical_container"||this._type==="lhe"){i=cssQuery("span.crm-offer-edit-btn-wrap",this._node);if(i.length>0){var n=i[0];i=cssQuery("span.crm-offer-item-del",n);if(i.length>0){this._delButton=i[0]}i=cssQuery("span.crm-offer-item-edit",n);if(i.length>0){this._editButton=i[0]}}}else{i=cssQuery("span.crm-offer-item-del",this._node);if(i.length>0){this._delButton=i[0]}i=cssQuery("span.crm-offer-item-edit",this._node);if(i.length>0){this._editButton=i[0]}i=cssQuery("div.crm-offer-info-label-wrap",this._node);if(i.length>0){this._labelWrapper=i[0]}}this._enableEdit=!!this._editButton;i=cssQuery("div.crm-offer-info-data-wrap",this._node);if(i.length===0){throw"Error: Could not find data wrapper."}this._dataWrapper=i[0];this._enableDrag=this.getSetting("enableDrag",true);this._enableDragDropBin=this.getSetting("enableDragDropBin",true);this._draggableContextId=this.getSetting("draggableContextId","");this.initializeDragDropAbilities();this._bindEvents();this._isTemporary=this.getSetting("isTemporary",false);this._editMode=this.getSetting("editMode",false);if(this._editMode){this.enableEditMode(true,true);this._manager.processFieldEditStart(this)}this._isVisible=this._node.style.display!=="none"},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getId:function(){return this._id},getType:function(){return this._type},getUserFieldType:function(){return this._userFieldType},getName:function(){return BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id},getManager:function(){return this._manager},isInEditMode:function(){return this._editMode},isTemporary:function(){return this._isTemporary},isRequired:function(){return BX.type.isBoolean(this._data["required"])&&this._data["required"]},isPersistent:function(){return BX.type.isBoolean(this._data["persistent"])&&this._data["persistent"]},getNode:function(){return this._node},getData:function(){return this._data},enableEditMode:function(e,t){e=!!e;t=!!t;if(this._editMode===e&&!t){return}this._editMode=e;if(this._type==="vertical_checkbox"||this._type==="checkbox"){this._processBooleanFieldModeChange()}else if(this._type==="vertical_container"||this._type==="lhe"){this._processContainerFieldModeChange()}else if(this._type==="address"||this._type==="multiple_address"){this._processAddressFieldModeChange()}else{this._processTextFieldModeChange()}},release:function(e){this.releaseDragDropAbilities();this._unbindEvents();if(this._nameKeyPressHandler){BX.unbind(this._nameInput,"keydown",this._nameKeyPressHandler);this._nameKeyPressHandler=null}this._dragButton=null;this._editButton=null;this._delButton=null;this._saveButton=null;this._cancelButton=null;if(e&&this._node){this._node=BX.remove(this._node)}},remove:function(){var e=new BX.CDialog({title:this.getMessage("fieldDeleteDlgTitle"),head:"",content:this.getMessage("fieldDeleteDlgContent"),resizable:false,draggable:true,height:70,width:300});e.ClearButtons();e.SetButtons([{title:this.getMessage("deleteButton"),id:"delete",action:BX.delegate(this._onDeleteConfirmationButtonClick,this)},BX.CDialog.btnCancel]);e.Show()},getMessage:function(e){var t=BX.CrmFormFieldSetting.messages;return t.hasOwnProperty(e)?t[e]:e},createGhostNode:function(){var e=BX.create("DIV",{attrs:{className:"crm-offer-draggable-item"}});e.appendChild(BX.create("SPAN",{attrs:{className:"crm-offer-drg-btn"}}));e.appendChild(BX.create("SPAN",{attrs:{className:"crm-offer-title-text"},text:this.getName()}));return e},initializeDragDropAbilities:function(){if(this._dragItem||!this._enableDrag){return}if(!this._dragButton){throw"CrmFormFieldSetting: Could not find drag button."}this._dragItem=BX.CrmFormFieldDragItem.create(this.getId(),{field:this,node:this._dragButton,contextId:this._draggableContextId,enableBin:this._enableDragDropBin,showFieldInDragMode:false,ghostOffset:{x:-8,y:-8}})},releaseDragDropAbilities:function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}},isVisible:function(){return this._isVisible},setVisible:function(e){e=!!e;if(this._isVisible===e){return}this._isVisible=e;this._node.style.display=e?"":"none"},tryCompleteEdit:function(e){if(!this._editMode){return}if(!!e){var t=BX.util.trim(this._nameInput.value);if(t!==""){this._data["name"]=t}if(this._inShortListOptionEnabled){if(this._inShortListOptionCheckbox){this._data["inShortList"]=this._inShortList=this._inShortListOptionCheckbox.checked===true}}}if(this._manager.processFieldEditEnd(this)){this.enableEditMode(false)}},tryCancelEdit:function(){if(this._manager.processFieldEditCancelation(this)){this.enableEditMode(false)}},_bindEvents:function(){if(this._editButton){BX.bind(this._editButton,"click",this._editButtonClickHandler)}if(this._delButton){BX.bind(this._delButton,"click",this._deleteButtonClickHandler)}},_unbindEvents:function(){if(this._editButton){BX.unbind(this._editButton,"click",this._editButtonClickHandler)}if(this._delButton){BX.unbind(this._delButton,"click",this._deleteButtonClickHandler)}if(this._saveButton){BX.unbind(this._saveButton,"click",this._saveButtonClickHandler)}if(this._cancelButton){BX.unbind(this._cancelButton,"click",this._cancelButtonClickHandler)}},_processBooleanFieldModeChange:function(){if(this._editMode){BX.addClass(this._node,"crm-offer-new-item");this._dataWrapper.style.display="none";if(this._nameInput){this._nameInput.style.display=""}else{this._nameInput=BX.create("INPUT",{props:{type:"text",className:"crm-offer-item-inp crm-offer-label-inp",placeholder:this.getMessage("fieldNamePlaceHolder")}});this._dataWrapper.parentNode.insertBefore(this._nameInput,this._dataWrapper)}this._nameInput.value=BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id;this._displayInShortListOption();this._ensureEditButtonsCreated();if(this._buttonWrapper.style.display!==""){this._buttonWrapper.style.display=""}this._nameInput.focus();this._nameInput.setSelectionRange(0,this._nameInput.value.length);this._nameKeyPressHandler=BX.delegate(this._onNameKeyPress,this);BX.bind(this._nameInput,"keydown",this._nameKeyPressHandler)}else{BX.removeClass(this._node,"crm-offer-new-item");this._nameInput.style.display="none";this._buttonWrapper.style.display="none";this._dataWrapper.style.display="";this._hideInShortListOption();var e=cssQuery("label.crm-offer-label",this._dataWrapper);if(e.length>0){e[0].innerHTML=BX.util.htmlspecialchars(BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id)}BX.unbind(this._nameInput,"keydown",this._nameKeyPressHandler);this._nameKeyPressHandler=null}},_processAddressFieldModeChange:function(){var e=cssQuery("div.crm-offer-address-title",this._node);if(e.length===0){throw"Error: Could not find title container."}var t=e[0];e=cssQuery("div.crm-offer-addres-title-contents-wrapper",t);if(e.length===0){throw"Error: Could not find title wrapper."}var i=e[0];if(this._editMode){BX.addClass(this._node,"crm-offer-new-item");i.style.display="none";if(this._nameInput){this._nameInput.style.display=""}else{this._nameInput=BX.create("INPUT",{props:{type:"text",className:"crm-offer-item-inp",placeholder:this.getMessage("fieldNamePlaceHolder")}});t.appendChild(this._nameInput)}this._nameInput.value=BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id;this._displayInShortListOption();this._ensureEditButtonsCreated();if(this._buttonWrapper.style.display!==""){this._buttonWrapper.style.display=""}this._nameInput.focus();this._nameInput.setSelectionRange(0,this._nameInput.value.length);if(this._manager.getFormMode()===BX.CrmFormMode.edit){if(this._cover){this._cover.style.display=""}else{this._cover=BX.create("DIV",{props:{className:"crm-offer-disable-cover"}});this._dataWrapper.appendChild(this._cover)}}}else{this._cover.style.display="none";BX.removeClass(this._node,"crm-offer-new-item");this._nameInput.style.display="none";this._buttonWrapper.style.display="none";i.style.display="";this._hideInShortListOption();e=cssQuery("span.crm-offer-address-title-contents",i);if(e.length===0){throw"Error: Could not find title content."}e[0].innerHTML=BX.util.htmlspecialchars(BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id)}},_processContainerFieldModeChange:function(){var e=cssQuery("div.crm-offer-editor-title",this._node);if(e.length===0){throw"Error: Could not find title container."}var t=e[0];e=cssQuery("div.crm-offer-editor-title-contents-wapper",t);if(e.length===0){throw"Error: Could not find title wrapper."}var i=e[0];if(this._editMode){BX.addClass(this._node,"crm-offer-new-item");i.style.display="none";if(this._nameInput){this._nameInput.style.display=""}else{this._nameInput=BX.create("INPUT",{props:{type:"text",className:"crm-offer-item-inp",placeholder:this.getMessage("fieldNamePlaceHolder")}});t.appendChild(this._nameInput)}this._nameInput.value=BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id;this._displayInShortListOption();this._ensureEditButtonsCreated();if(this._buttonWrapper.style.display!==""){this._buttonWrapper.style.display=""}this._nameInput.focus();this._nameInput.setSelectionRange(0,this._nameInput.value.length);if(this._manager.getFormMode()===BX.CrmFormMode.edit){if(this._cover){this._cover.style.display=""}else{this._cover=BX.create("DIV",{props:{className:"crm-offer-disable-cover"}});this._dataWrapper.appendChild(this._cover)}}}else{this._cover.style.display="none";BX.removeClass(this._node,"crm-offer-new-item");this._nameInput.style.display="none";this._buttonWrapper.style.display="none";i.style.display="";this._hideInShortListOption();e=cssQuery("span.crm-offer-editor-title-contents",i);if(e.length===0){throw"Error: Could not find title content."}e[0].innerHTML=BX.util.htmlspecialchars(BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id)}},_processTextFieldModeChange:function(){if(this._editMode){BX.addClass(this._node,"crm-offer-new-item");this._labelWrapper.style.display="none";if(this._nameInput){this._nameInput.style.display=""}else{this._nameInput=BX.create("INPUT",{props:{type:"text",className:"crm-offer-item-inp",placeholder:this.getMessage("fieldNamePlaceHolder")}});this._labelWrapper.parentNode.insertBefore(this._nameInput,this._labelWrapper)}this._nameInput.value=BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id;this._displayInShortListOption();this._ensureEditButtonsCreated();if(this._buttonWrapper.style.display!==""){this._buttonWrapper.style.display=""}this._nameInput.focus();this._nameInput.setSelectionRange(0,this._nameInput.value.length);if(this._manager.getFormMode()===BX.CrmFormMode.edit){if(this._cover){this._cover.style.display=""}else{this._cover=BX.create("DIV",{props:{className:"crm-offer-disable-cover"}});this._dataWrapper.appendChild(this._cover)}}this._nameKeyPressHandler=BX.delegate(this._onNameKeyPress,this);BX.bind(this._nameInput,"keydown",this._nameKeyPressHandler)}else{if(this._cover){this._cover.style.display="none"}BX.removeClass(this._node,"crm-offer-new-item");this._nameInput.style.display="none";this._buttonWrapper.style.display="none";this._labelWrapper.style.display="";this._hideInShortListOption();var e=cssQuery("span.crm-offer-info-label",this._labelWrapper);if(e.length>0){e[0].innerHTML=BX.util.htmlspecialchars(BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id)}BX.unbind(this._nameInput,"keydown",this._nameKeyPressHandler);this._nameKeyPressHandler=null}},_ensureEditButtonsCreated:function(){if(this._buttonWrapper){return}this._saveButton=BX.create("SPAN",{props:{className:"webform-small-button"},children:[BX.create("SPAN",{props:{className:"webform-small-button-left"}}),BX.create("SPAN",{props:{className:"webform-small-button-text"},text:this.getMessage("saveButton")}),BX.create("SPAN",{props:{className:"webform-small-button-right"}})]});BX.bind(this._saveButton,"click",this._saveButtonClickHandler);this._cancelButton=BX.create("SPAN",{props:{className:"crm-offer-cancel-link"},text:this.getMessage("cancelButton")});BX.bind(this._cancelButton,"click",this._cancelButtonClickHandler);this._buttonWrapper=BX.create("DIV",{props:{className:"crm-offer-item-btn-wrap"},children:[this._saveButton,this._cancelButton]});this._dataWrapper.parentNode.appendChild(this._buttonWrapper)},_displayInShortListOption:function(){if(!this._inShortListOptionEnabled)return;if(!this._inShortListOptionWrapper){var e=this._id+"_inShortListCheckbox";this._inShortListOptionWrapper=BX.create("DIV",{children:[this._inShortListOptionCheckbox=BX.create("INPUT",{attrs:{id:e,type:"checkbox"},props:{checked:this._inShortList}}),BX.create("LABEL",{attrs:{for:e},html:BX.util.htmlspecialchars(this.getMessage("inShortListOptionTitle"))})]});this._dataWrapper.parentNode.appendChild(this._inShortListOptionWrapper)}if(this._inShortListOptionWrapper.style.display!==""){this._inShortListOptionWrapper.style.display=""}},_hideInShortListOption:function(){if(this._inShortListOptionEnabled){if(this._inShortListOptionWrapper)this._inShortListOptionWrapper.style.display="none";if(this._inShortListOptionCheckbox)this._inShortListOptionCheckbox.checked=this._inShortList}},_onEditButtonClick:function(e){this.enableEditMode(true);this._manager.processFieldEditStart(this)},_onEditMenuItemClick:function(e){this._closeContextMenu();this.enableEditMode(true);this._manager.processFieldEditStart(this)},_onDeleteButtonClick:function(e){this.remove()},_onDeleteMenuItemClick:function(e){this._closeContextMenu();this.remove()},_onDeleteConfirmationButtonClick:function(e){BX.WindowManager.Get().Close();this._manager.processFieldRemove(this)},_onSaveButtonClick:function(e){this.tryCompleteEdit(true)},_onCancelButtonClick:function(e){this.tryCancelEdit()},_onNameKeyPress:function(e){if(!e){e=window.event}if(e.keyCode==13){this.tryCompleteEdit(true);return BX.eventReturnFalse(e)}else if(e.keyCode==27){this.tryCancelEdit();return BX.eventReturnFalse(e)}return true},_onContextMenu:function(e){this._openContextMenu();return BX.eventReturnFalse(e)},_openContextMenu:function(){if(this._isContextMenuShown){return}var e=BX.PopupMenu.getMenuById(this._contextMenuId);if(e){e.popupWindow.close()}var t=[];if(this._enableEdit){t.push({id:"edit",text:this.getMessage("editMenuItem"),onclick:BX.delegate(this._onEditMenuItemClick,this)})}t.push({id:"delete",text:this.getMessage("deleteMenuItem"),onclick:BX.delegate(this._onDeleteMenuItemClick,this)});this._contextMenu=BX.PopupMenu.create(this._contextMenuId,this._dragButton,t,{autoHide:true,offsetTop:0,offsetLeft:0,angle:{position:"top",offset:10},events:{onPopupClose:BX.delegate(this._onContextMenuClose,this)}});this._contextMenu.popupWindow.show();this._isContextMenuShown=true},_closeContextMenu:function(){if(this._contextMenu&&this._contextMenu.popupWindow){this._contextMenu.popupWindow.close()}},_onContextMenuClose:function(){this._contextMenu=null;if(typeof BX.PopupMenu.Data[this._contextMenuId]!=="undefined"){BX.PopupMenu.Data[this._contextMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._contextMenuId]}this._isContextMenuShown=false}};if(typeof BX.CrmFormFieldSetting.messages==="undefined"){BX.CrmFormFieldSetting.messages={}}BX.CrmFormFieldSetting.create=function(e,t){var i=new BX.CrmFormFieldSetting;i.initialize(e,t);return i}}if(typeof BX.CrmFormSectionSetting==="undefined"){BX.CrmFormSectionSetting=function(){this._id="";this._settings=null;this._manager=null;this._data=null;this._titleNode=null;this._contentsNode=null;this._buttonsNode=null;this._addSectionButton=null;this._addFieldButton=null;this._restoreFieldButton=null;this._addFieldMenuId="";this._restoreFieldMenuId="";this._enableDrag=true;this._enableDragDropBin=true;this._draggableFieldContextId="";this._draggableSectionContextId="";this._dragButton=null;this._editButton=null;this._editMode=false;this._titleLabel=null;this._titleInput=null;this._nodeMouseOverHandler=BX.delegate(this._onNodeMouseOver,this);this._nodeMouseOutHandler=BX.delegate(this._onNodeMouseOut,this);this._addSectionButtonClickHandler=BX.delegate(this._onAddSectionButtonClick,this);this._addFieldButtonClickHandler=BX.delegate(this._onAddFieldButtonClick,this);this._restoreFieldButtonClickHandler=BX.delegate(this._onRestoreFieldButtonClick,this);this._editButtonClickHandler=BX.delegate(this._onEditButtonClick,this);this._deleteButtonClickHandler=BX.delegate(this._onDeleteButtonClick,this);this._documentClickHandler=BX.delegate(this._onDocumentClick,this);this._titleKeyPressHandler=BX.delegate(this._onTitleKeyPress,this);this._addFieldMenu=null;this._isAddFieldMenuShown=false;this._restoreFieldMenu=null;this._isRestoreFieldMenuShown=false;this._mouseTimeoutId=0;this._isMouseOver=false;this._isVisible=true;this._isFieldsVisible=true;this._isButtonsVisible=true;this._placeHolder=null;this._dragContainer=null;this._dragItem=null;this._contextMenuHandler=BX.delegate(this._onContextMenu,this);this._contextMenuId="";this._isContextMenuShown=false;this._isTemporary=false;this._canCreateSection=false;this._canCreateUserField=false;this._canRestoreField=false};BX.CrmFormSectionSetting.prototype={initialize:function(e,t){if(!BX.type.isNotEmptyString(e)){throw"Error: The 'id' argument is not defined or empty."}this._id=e;this._settings=t?t:{};this._isTemporary=this.getSetting("isTemporary",false);this._manager=this.getSetting("manager");if(!(this._manager instanceof BX.CrmFormSettingManager)){throw"Error: The 'manager' argument must be CrmFormSettingManager instance."}this._data=this.getSetting("data");if(!BX.type.isPlainObject(this._data)){throw"Error: The 'data' parameter is not found in settings."}this._contentsNode=this._manager.getSectionNode(e);if(!BX.type.isElementNode(this._contentsNode)){throw"Error: Could not find section contents node."}var i=cssQuery("div.crm-offer-title",this._contentsNode);if(i.length>0){this._titleNode=i[0]}else{throw"Error: Could not find section title node."}if(this._isTemporary){this._titleNode.style.display="none"}this._canCreateSection=this.getSetting("canCreateSection",this._manager.canCreateSection());this._canCreateUserField=!this._isTemporary&&this.getSetting("canCreateUserField",this._manager.canCreateUserField());this._canRestoreField=!this._isTemporary&&this.getSetting("canRestoreField",this._manager.hasHiddenFields());this._buttonsNode=this._manager.getSectionButtonWrapperNode(e);if(!BX.type.isElementNode(this._buttonsNode)){throw"Error: Could not find section buttons node."}this._addSectionButton=this._manager.getSectionButtonNode(e,"add_section");if(this._canCreateSection&&!BX.type.isElementNode(this._addSectionButton)){throw"Error: Could not find section 'Add Section' button."}this._addFieldButton=this._manager.getSectionButtonNode(e,"add_field");if(this._canCreateUserField&&!BX.type.isElementNode(this._addFieldButton)){throw"Error: Could not find section 'Add Field' button."}this._restoreFieldButton=this._manager.getSectionButtonNode(e,"restore_field");if(this._canRestoreField&&!BX.type.isElementNode(this._restoreFieldButton)){throw"Error: Could not find section 'Show Field' button."}this._addFieldMenuId=this._manager.resolveNodeId(e,"add_field_menu");this._restoreFieldMenuId=this._manager.resolveNodeId(e,"restore_field_menu");i=cssQuery("span.crm-offer-drg-btn",this._contentsNode);if(i.length>0){this._dragButton=i[0];this._contextMenuId=this._id.toLowerCase()+"_context_menu";BX.bind(this._dragButton,"contextmenu",this._contextMenuHandler)}if(!BX.type.isElementNode(this._dragButton)){throw"Error: Could not find section 'Drag' button."}this._editButton=this._manager.getSectionButtonNode(e,"edit");this._enableEdit=!!this._editButton;this._deleteButton=this._manager.getSectionButtonNode(e,"delete");if(!BX.type.isElementNode(this._deleteButton)){throw"Error: Could not find section 'Delete' button."}i=cssQuery("span.crm-offer-title-text",this._titleNode);if(i.length===0){throw"Error: Could not find title label."}this._titleLabel=i[0];this._enableDrag=this.getSetting("enableDrag",true);this._enableDragDropBin=this.getSetting("enableDragDropBin",true);this._draggableFieldContextId=this.getSetting("draggableFieldContextId","");this._draggableSectionContextId=this.getSetting("draggableSectionContextId","");this.initializeDragDropAbilities();this._bindEvents();this._editMode=!this._isTemporary&&this.getSetting("editMode",false);if(this._editMode){if(this._editMode=this._manager.processSectionEditStart(this)){this.enableEditMode(true,true)}}},release:function(e){this._unbindEvents();if(this._editMode){this._enableDocumentClick(false);BX.unbind(this._titleInput,"keydown",this._titleKeyPressHandler)}if(e&&this._contentsNode){this._contentsNode=BX.remove(this._contentsNode)}},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getId:function(){return this._id},getName:function(){return BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id},getManager:function(){return this._manager},getTitleNode:function(){return this._titleNode},getContentsNode:function(){return this._contentsNode},getData:function(){return this._data},getAssociatedField:function(){return BX.type.isPlainObject(this._data["associatedField"])?this._data["associatedField"]:null},getMessage:function(e){var t=BX.CrmFormSectionSetting.messages;return t.hasOwnProperty(e)?t[e]:e},isTemporary:function(){return this._isTemporary},enableEditMode:function(e,t){if(this._isTemporary){return}e=!!e;t=!!t;if(this._editMode===e&&!t){return}this._editMode=e;if(this._editMode){this._titleLabel.style.display="none";if(this._titleInput){this._titleInput.style.display=""}else{this._titleInput=BX.create("INPUT",{props:{type:"text",className:"crm-item-table-inp",placeholder:this.getMessage("sectionTitlePlaceHolder")}});this._titleInput.value=BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:this._id;this._titleNode.insertBefore(this._titleInput,this._titleLabel)}this._titleInput.focus();this._titleInput.setSelectionRange(0,this._titleInput.value.length);this._enableDocumentClick(true);BX.bind(this._titleInput,"keydown",this._titleKeyPressHandler)}else{var i=BX.type.isNotEmptyString(this._data["name"])?this._data["name"]:"";if(this._titleInput.value!==i){this._titleInput.value=i}this._titleLabel.innerHTML=BX.util.htmlspecialchars(i!==""?i:this._id);this._titleInput.style.display="none";this._titleLabel.style.display="";this._enableDocumentClick(false);BX.unbind(this._titleInput,"keydown",this._titleKeyPressHandler)}},getFields:function(){var e=[];var t=this._manager.getSectionFieldIds(this._id);for(var i=0;i<t.length;i++){var n=this._manager.getField(t[i]);if(n){e.push(n)}}return e},setVisible:function(e){e=!!e;if(this._isVisible===e){return}this._isVisible=e;this._contentsNode.style.display=e?"":"none"},setFieldsVisible:function(e){e=!!e;if(this._isFieldsVisible===e){return}this._isFieldsVisible=e;var t=this._manager.getSectionFieldIds(this._id);for(var i=0;i<t.length;i++){var n=this._manager.getField(t[i]);if(n){n.setVisible(e)}}},setButtonsVisible:function(e){e=!!e;if(this._isButtonsVisible===e){return}this._isButtonsVisible=e;this._buttonsNode.style.display=e?"":"none"},processFieldRemove:function(e){if(!this._isTemporary){this._canRestoreField=this.getSetting("canRestoreField",this._manager.hasHiddenFields())}},createGhostNode:function(){var e=BX.create("DIV",{attrs:{className:"crm-offer-draggable-item"}});e.appendChild(BX.create("SPAN",{attrs:{className:"crm-offer-drg-btn"}}));e.appendChild(BX.create("SPAN",{attrs:{className:"crm-offer-title-text"},text:this.getName()}));return e},initializeDragDropAbilities:function(){if(!this._dragContainer){this._dragContainer=BX.CrmFormFieldDragContainer.create(this.getId(),{section:this,node:this._contentsNode,contextId:this._draggableFieldContextId,priority:this._manager.getDragPriority()});this._dragContainer.addDragFinishListener(this._manager.getFieldDropCallback())}if(this._enableDrag&&!this._dragItem){this._dragItem=BX.CrmFormSectionDragItem.create(this.getId(),{section:this,node:this._dragButton,contextId:this._draggableSectionContextId,enableBin:this._enableDragDropBin,showSectionInDragMode:false,showFieldsInDragMode:false})}},releaseDragDropAbilities:function(){if(this._dragContainer){this._dragContainer.removeDragFinishListener(this._itemDropHandler);this._dragContainer.release();this._dragContainer=null}if(this._dragItem){this._dragItem.release();this._dragItem=null}},createPlaceHolder:function(e){var t=e["fields"];var i=e["id"];var n=e["index"];var r=t.length;var s=n;if(n>=0){s=n+1}else{s=r+1}if(this._placeHolder){if(this._placeHolder.getFieldIndex()===n){return this._placeHolder}this._contentsNode.deleteRow(this._placeHolder.getNode().rowIndex);this._placeHolder=null}this._placeHolder=BX.CrmFormFieldPlaceholder.create({section:this,node:this._contentsNode.insertRow(s),fieldId:i,fieldIndex:n});this._placeHolder.layout();return this._placeHolder},getPlaceHolder:function(){return this._placeHolder},removePlaceHolder:function(){if(this._placeHolder){this._contentsNode.deleteRow(this._placeHolder.getNode().rowIndex);this._placeHolder=null}},remove:function(){var e=new BX.CDialog({title:this.getMessage("sectionDeleteDlgTitle"),head:"",content:this.getMessage("sectionDeleteDlgContent"),resizable:false,draggable:true,height:70,width:300});e.ClearButtons();e.SetButtons([{title:this.getMessage("deleteButton"),id:"delete",action:BX.delegate(this._onDeleteConfirmationButtonClick,this)},BX.CDialog.btnCancel]);e.Show()},_bindEvents:function(){BX.bind(this._titleNode,"mouseover",this._nodeMouseOverHandler);BX.bind(this._titleNode,"mouseout",this._nodeMouseOutHandler);BX.bind(this._contentsNode,"mouseover",this._nodeMouseOverHandler);BX.bind(this._contentsNode,"mouseout",this._nodeMouseOutHandler);if(this._addSectionButton){BX.bind(this._addSectionButton,"click",this._addSectionButtonClickHandler)}if(this._addFieldButton){BX.bind(this._addFieldButton,"click",this._addFieldButtonClickHandler)}if(this._restoreFieldButton){BX.bind(this._restoreFieldButton,"click",this._restoreFieldButtonClickHandler)}BX.bind(this._editButton,"click",this._editButtonClickHandler);BX.bind(this._deleteButton,"click",this._deleteButtonClickHandler)},_unbindEvents:function(){BX.unbind(this._titleNode,"mouseover",this._nodeMouseOverHandler);BX.unbind(this._titleNode,"mouseout",this._nodeMouseOutHandler);BX.unbind(this._contentsNode,"mouseover",this._nodeMouseOverHandler);BX.unbind(this._contentsNode,"mouseout",this._nodeMouseOutHandler);if(this._addSectionButton){BX.unbind(this._addSectionButton,"click",this._addSectionButtonClickHandler)}if(this._addFieldButton){BX.unbind(this._addFieldButton,"click",this._addFieldButtonClickHandler)}if(this._restoreFieldButton){BX.unbind(this._restoreFieldButton,"click",this._restoreFieldButtonClickHandler)}BX.unbind(this._editButton,"click",this._editButtonClickHandler);BX.unbind(this._deleteButton,"click",this._deleteButtonClickHandler)},_enableDocumentClick:function(e){if(e){var t=this;window.setTimeout(function(){BX.bind(document,"click",t._documentClickHandler)},0)}else{BX.unbind(document,"click",this._documentClickHandler)}},_onAddFieldMenuItemClick:function(e,t){this._closeAddFieldMenu();var i=BX.type.isNotEmptyString(t["id"])?t["id"]:"";if(i==="addSection"){this._manager.createSection(this);return}var n="string";if(i==="addDoubleField"){n="double"}else if(i==="addBooleanField"){n="boolean"}else if(i==="addDatetimeField"){n="datetime"}this._manager.createTemporaryField(n,this)},_openAddFieldMenu:function(){if(this._isAddFieldMenuShown){return}var e=this._manager.canCreateUserField();if(!e){return}var t=BX.delegate(this._onAddFieldMenuItemClick,this);var i=[];i.push({id:"addStringField",className:"crm-offer-popup-item menu-popup-no-icon",text:this.getMessage("createTextFiledMenuItem"),onclick:t});i.push({id:"addDoubleField",className:"crm-offer-popup-item menu-popup-no-icon",text:this.getMessage("createDoubleFiledMenuItem"),onclick:t});i.push({id:"addBooleanField",className:"crm-offer-popup-item menu-popup-no-icon",text:this.getMessage("createBooleanFiledMenuItem"),onclick:t});i.push({id:"addDatetimeField",className:"crm-offer-popup-item menu-popup-no-icon",text:this.getMessage("createDatetimeFiledMenuItem"),onclick:t});i.push({id:"addDatetimeField",className:"crm-offer-popup-item menu-popup-no-icon",text:this.getMessage("createDatetimeFiledMenuItem"),onclick:t});if(typeof BX.PopupMenu.Data[this._addFieldMenuId]!=="undefined"){BX.PopupMenu.Data[this._addFieldMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._addFieldMenuId]}if(typeof BX.PopupMenu.Data[this._restoreFieldMenuId]!=="undefined"){BX.PopupMenu.Data[this._restoreFieldMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._restoreFieldMenuId];this._restoreFieldMenu=null;this._isRestoreFieldMenuShown=false}this._addFieldMenu=BX.PopupMenu.currentItem=BX.PopupMenu.create(this._addFieldMenuId,this._addFieldButton,i,{closeByEsc:true,autoHide:true,offsetTop:0,offsetLeft:0,angle:{position:"top",offset:10},events:{onPopupClose:BX.delegate(this._onAddFieldMenuClose,this)}});this._addFieldMenu.popupWindow.show();this._isAddFieldMenuShown=true},_closeAddFieldMenu:function(){if(this._addFieldMenu&&this._addFieldMenu.popupWindow){this._addFieldMenu.popupWindow.close()}},_openRestoreFieldMenu:function(){if(this._isRestoreFieldMenuShown){return}var e=[];var t=this._manager.getHiddenFieldInfos();if(t.length===0){return}for(var i=0;i<t.length;i++){var n=t[i];e.push({id:n["id"],className:"crm-offer-popup-item menu-popup-no-icon",text:n["name"],onclick:BX.delegate(this._onRestoreFieldMenuItemClick,this)})}if(typeof BX.PopupMenu.Data[this._addFieldMenuId]!=="undefined"){BX.PopupMenu.Data[this._addFieldMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._addFieldMenuId];this._addFieldMenu=null;this._isAddFieldMenuShown=false}if(typeof BX.PopupMenu.Data[this._restoreFieldMenuId]!=="undefined"){BX.PopupMenu.Data[this._restoreFieldMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._restoreFieldMenuId]}var r=BX.PopupMenu.getCurrentMenu();if(r){BX.PopupMenu.destroy(r.id)}this._restoreFieldMenu=BX.PopupMenu.currentItem=BX.PopupMenu.create(this._restoreFieldMenuId,this._restoreFieldButton,e,{offsetTop:0,offsetLeft:0,angle:{position:"top",offset:10},events:{onPopupClose:BX.delegate(this._onRestoreFieldMenuClose,this)}});this._restoreFieldMenu.popupWindow.show();this._isRestoreFieldMenuShown=true},_onNodeMouseOver:function(e){this._isMouseOver=true;if(this._mouseTimeoutId!==null){window.clearInterval(this._mouseTimeoutId);this._mouseTimeoutId=null}var t=this._canCreateSection||this._canCreateUserField;var i=this._canRestoreField;if(!t&&!i){return}if(this._addFieldButton){this._addFieldButton.style.display=t?"":"none"}if(this._restoreFieldButton){this._restoreFieldButton.style.display=i?"":"none"}var n=this;this._mouseTimeoutId=window.setTimeout(function(){if(n._mouseTimeoutId!=null){n._mouseTimeoutId=null;var e=n._buttonsNode;if(e.style.visibility!=="visible"){e.style.visibility="visible"}}},300)},_onNodeMouseOut:function(e){this._isMouseOver=false;if(this._isAddFieldMenuShown||this._isRestoreFieldMenuShown){return}if(this._mouseTimeoutId!==null){window.clearInterval(this._mouseTimeoutId);this._mouseTimeoutId=null}var t=this;this._mouseTimeoutId=window.setTimeout(function(){if(t._mouseTimeoutId!=null){t._mouseTimeoutId=null;var e=t._buttonsNode;if(e.style.visibility!=="hidden"){e.style.visibility="hidden"}}},300)},_onDocumentClick:function(e){if(!e){e=window.event}var t=BX.getEventTarget(e);if(t&&this._titleInput===t){return}if(!this._editMode){BX.unbind(document,"click",this._documentClickHandler)}else{this.tryCompleteEdit(true)}},tryCompleteEdit:function(e){if(!this._editMode){return}if(!!e){var t=BX.util.trim(this._titleInput.value);if(t!==""){this._data["name"]=t}}if(this._manager.processSectionEditEnd(this)){this.enableEditMode(false)}},_onTitleKeyPress:function(e){if(!e){e=window.event}if(e.keyCode==13){this.tryCompleteEdit(true);return BX.eventReturnFalse(e)}else if(e.keyCode==27){this.tryCompleteEdit(false);return BX.eventReturnFalse(e)}return true},_onEditButtonClick:function(e){if(!this._editMode&&this._manager.processSectionEditStart(this)){this.enableEditMode(true)}},_onEditMenuItemClick:function(e){this._closeContextMenu();this.enableEditMode(true);this._manager.processFieldEditStart(this)},_onDeleteButtonClick:function(e){this.remove()},_onDeleteMenuItemClick:function(e){this._closeContextMenu();this.remove()},_onDeleteConfirmationButtonClick:function(e){BX.WindowManager.Get().Close();this._manager.processSectionRemove(this)},_onAddSectionButtonClick:function(e){if(!e){e=window.event}this._manager.createSection(this);return BX.PreventDefault(e)},_onAddFieldButtonClick:function(e){if(!e){e=window.event}this._openAddFieldMenu();return BX.PreventDefault(e)},_onRestoreFieldButtonClick:function(e){if(!e){e=window.event}this._openRestoreFieldMenu();return BX.PreventDefault(e)},_onAddFieldMenuClose:function(){this._addFieldMenu=null;if(typeof BX.PopupMenu.Data[this._addFieldMenuId]!=="undefined"){BX.PopupMenu.Data[this._addFieldMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._addFieldMenuId]}this._isAddFieldMenuShown=false;if(!this._isMouseOver&&this._buttonsNode.style.visibility!=="hidden"){this._buttonsNode.style.visibility="hidden"}},_onRestoreFieldMenuItemClick:function(e,t){var i=BX.type.isNotEmptyString(t["id"])?t["id"]:"";if(i!==""){this._restoreFieldMenu.popupWindow.close();this._manager.restoreField(i,this._id)}},_onRestoreFieldMenuClose:function(){this._restoreFieldMenu=null;if(typeof BX.PopupMenu.Data[this._restoreFieldMenuId]!=="undefined"){BX.PopupMenu.Data[this._restoreFieldMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._restoreFieldMenuId]}this._isRestoreFieldMenuShown=false;if(!this._isMouseOver&&this._buttonsNode.style.visibility!=="hidden"){this._buttonsNode.style.visibility="hidden"}},_onContextMenu:function(e){this._openContextMenu();return BX.eventReturnFalse(e)},_openContextMenu:function(){if(this._isContextMenuShown){return}var e=[];if(this._enableEdit){e.push({id:"edit",text:this.getMessage("editMenuItem"),onclick:BX.delegate(this._onEditMenuItemClick,this)})}e.push({id:"delete",text:this.getMessage("deleteMenuItem"),onclick:BX.delegate(this._onDeleteMenuItemClick,this)});this._contextMenu=BX.PopupMenu.create(this._contextMenuId,this._dragButton,e,{autoHide:true,offsetTop:0,offsetLeft:0,angle:{position:"top",offset:10},events:{onPopupClose:BX.delegate(this._onContextMenuClose,this)}});this._contextMenu.popupWindow.show();this._isContextMenuShown=true},_closeContextMenu:function(){if(this._contextMenu&&this._contextMenu.popupWindow){this._contextMenu.popupWindow.close()}},_onContextMenuClose:function(){this._contextMenu=null;if(typeof BX.PopupMenu.Data[this._contextMenuId]!=="undefined"){BX.PopupMenu.Data[this._contextMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._contextMenuId]}this._isContextMenuShown=false}};if(typeof BX.CrmFormSectionSetting.messages==="undefined"){BX.CrmFormSectionSetting.messages={}}BX.CrmFormSectionSetting.create=function(e,t){var i=new BX.CrmFormSectionSetting;i.initialize(e,t);return i}}if(typeof BX.CrmFormUserFieldManager==="undefined"){BX.CrmFormUserFieldManager=function(){this._id="";this._settings=null;this._canCreate=false;this._entityId="";this._manager=null;this._pendingData=null;this._data={};this._fields={}};BX.CrmFormUserFieldManager.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(8);this._settings=t?t:{};this._entityId=this.getSetting("entityId","");if(!BX.type.isNotEmptyString(this._entityId)){throw"Error: The 'entityId' parameter is not defined in settings or empty."}this._canCreate=this.getSetting("canCreate",false);this._manager=this.getSetting("manager",null)},release:function(){},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getId:function(){return this._id},canCreate:function(){return this._canCreate},createField:function(e,t,i){if(!this._canCreate){throw"Error: User is not authorized to create user fields."}if(!BX.type.isPlainObject(e)){throw"Error: The 'params' argument must be a plain object."}var n=BX.type.isNotEmptyString(e["name"])?e["name"]:"";if(n===""){throw"Error: The 'name' parameter is not defined in params or empty."}var r=BX.type.isNotEmptyString(e["type"])?e["type"]:"";if(r===""){r="string"}else if(r!=="string"&&r!=="double"&&r!=="boolean"&&r!=="datetime"){throw"Error: Type '"+r+"' is not supported in current context."}var s={USER_TYPE_ID:r,ENTITY_ID:this._entityId,MULTIPLE:"N",MANDATORY:"N",SHOW_FILTER:"Y",EDIT_FORM_LABEL:n};this._pendingData={fieldData:s,temporaryId:BX.type.isNotEmptyString(t)?t:"",callback:BX.type.isFunction(i)?i:null};this._beginCreateField()},createTemporaryField:function(e){if(!BX.type.isPlainObject(e)){throw"Error: The 'params' argument must be a plain object."}var t=BX.util.getRandomString(8);e["name"]=t;var i=this._prepareFieldData(e);return BX.CrmFormUserField.create(t,{manager:this,fieldData:i})},getImagePath:function(){return this.getSetting("imagePath","/bitrix/js/main/core/images/")},getServerTime:function(){return this.getSetting("serverTime","")},getManager:function(){return this._manager},_prepareFieldData:function(e){if(!BX.type.isPlainObject(e)){throw"Error: The 'params' argument must be a plain object."}var t=BX.type.isNotEmptyString(e["type"])?e["type"]:"";if(t===""){t="string"}else if(t!=="string"&&t!=="double"&&t!=="boolean"&&t!=="datetime"){throw"Error: Type '"+t+"' is not supported in current context."}var i=BX.type.isNotEmptyString(e["name"])?e["name"]:"";if(i===""){throw"Error: The 'name' parameter is not defined in params or empty."}var n=BX.type.isNotEmptyString(e["label"])?e["label"]:"";if(n===""){throw"Error: The 'label' parameter is not defined in params or empty."}return{FIELD_NAME:i,USER_TYPE_ID:t,ENTITY_ID:this._entityId,MULTIPLE:"N",MANDATORY:"N",SHOW_FILTER:"Y",EDIT_FORM_LABEL:n}},_beginCreateField:function(){var e=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(e)){throw"Error: Could not find 'serviceUrl' parameter in settings."}BX.ajax({url:e,method:"POST",dataType:"json",data:{ACTION:"ADD_FIELD",DATA:this._pendingData["fieldData"]},onsuccess:BX.delegate(this._onCreateFieldRequestSuccess,this),onfailure:BX.delegate(this._onCreateFieldRequestFailure,this)})},_onCreateFieldRequestSuccess:function(e){var t=BX.type.isNotEmptyString(e["ERROR"])?e["ERROR"]:"";if(t!==""){alert(t);return}var i=BX.type.isPlainObject(e["RESULT"])?e["RESULT"]:{};var n=this._pendingData["fieldData"];var r=n["ID"]=BX.type.isNotEmptyString(i["ID"])?i["ID"]:"";if(!BX.type.isNotEmptyString(r)){throw"Error: Could not find 'ID' in action result."}var s=n["FIELD_NAME"]=BX.type.isNotEmptyString(i["FIELD_NAME"])?i["FIELD_NAME"]:"";if(!BX.type.isNotEmptyString(s)){throw"Error: Could not find 'FIELD_NAME' in action result."}this._data[s]=n;var o=BX.CrmFormUserField.create(s,{manager:this,fieldData:n});this._fields[s]=o;if(this._pendingData["callback"]){this._pendingData["callback"](this,this._pendingData["temporaryId"],o)}this._pendingData=null},_onCreateFieldRequestFailure:function(e){this._pendingData=null;alert("Could not create user field.")}};BX.CrmFormUserFieldManager.items={};BX.CrmFormUserFieldManager.create=function(e,t){var i=new BX.CrmFormUserFieldManager;i.initialize(e,t);this.items[i.getId()]=i;return i}}if(typeof BX.CrmFormUserField==="undefined"){BX.CrmFormUserField=function(){this._id="";this._fieldData=null;this._settings=null;this._manager=this;this._userTypeId="";this._fieldName="";this._label="";this._elements={}};BX.CrmFormUserField.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(8);this._settings=t?t:{};this._fieldData=this.getSetting("fieldData",null);if(!BX.type.isPlainObject(this._fieldData)){throw"Error: The 'fieldData' parameter is not found in settings."}this._userTypeId=this.getParam("USER_TYPE_ID");if(!BX.type.isNotEmptyString(this._userTypeId)){throw"Error: The 'USER_TYPE_ID' parameter is not found in field data."}this._fieldName=this.getParam("FIELD_NAME");if(!BX.type.isNotEmptyString(this._fieldName)){throw"Error: The 'FIELD_NAME' parameter is not found in field data."}this._label=this.getParam("EDIT_FORM_LABEL");if(!BX.type.isNotEmptyString(this._label)){this._label=this._fieldName}this._manager=this.getSetting("manager",null);if(!this._manager){throw"Error: The 'manager' parameter is not found in settings."}},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getId:function(){return this._id},getParam:function(e){return BX.type.isNotEmptyString(this._fieldData[e])?this._fieldData[e]:""},getUserTypeId:function(){return this._userTypeId},getFieldName:function(){return this._fieldName},getFieldLabel:function(){return this._label},isNeedTitle:function(){return this._userTypeId!=="boolean"},prepareLayout:function(){if(this._userTypeId==="string"){return this._prepareStringFieldLayout()}else if(this._userTypeId==="double"){return this._prepareDoubleFieldLayout()}else if(this._userTypeId==="boolean"){return this._prepareBooleanFieldLayout()}else if(this._userTypeId==="datetime"){return this._prepareDatetimeFieldLayout()}return null},_prepareStringFieldLayout:function(){this._elements["value"]=BX.create("INPUT",{props:{className:"crm-offer-item-inp",type:"text",name:this._fieldName,size:30,value:""}});return[this._elements["value"]]},_prepareDoubleFieldLayout:function(){this._elements["value"]=BX.create("INPUT",{props:{className:"crm-offer-item-inp",type:"text",name:this._fieldName,size:30,value:""}});return[this._elements["value"]]},_prepareBooleanFieldLayout:function(){this._elements["value"]=BX.create("INPUT",{props:{type:"hidden",name:this._fieldName,value:"N"}});var e=this._fieldName.toLowerCase()+"_chbx";this._elements["checkbox"]=BX.create("INPUT",{props:{id:e,name:this._fieldName,type:"checkbox",className:"crm-offer-checkbox",value:"Y"}});this._elements["label"]=BX.create("LABEL",{props:{className:"crm-offer-label"},attrs:{for:e},text:this._label});return[this._elements["value"],this._elements["checkbox"],this._elements["label"]]},_prepareDatetimeFieldLayout:function(){this._elements["value"]=BX.create("INPUT",{props:{className:"crm-offer-item-inp crm-item-table-date",type:"text",id:this._fieldName,name:this._fieldName,value:""}});BX.bind(this._elements["value"],"click",BX.delegate(this._onDateTimeIconClick,this));return[this._elements["value"]]},_onDateTimeIconClick:function(e){BX.calendar({node:this._elements["value"],field:this._fieldName,bTime:true,serverTime:this._manager.getServerTime(),bHideTimebar:false})}};BX.CrmFormUserField.create=function(e,t){var i=new BX.CrmFormUserField;i.initialize(e,t);return i}}if(typeof BX.CrmFormFieldRenderer==="undefined"){BX.CrmFormFieldRenderer=function(){};BX.CrmFormFieldRenderer.renderUserFieldRow=function(e,t,i){if(!BX.type.isElementNode(t)){throw"Error: The 'table' argument must be DOM element."}var n=BX.type.isNotEmptyString(i["prefix"])?i["prefix"]:"";var r=BX.type.isNumber(i["index"])&&i["index"]>0?i["index"]:-1;var s=BX.type.isBoolean(i["enableDrag"])?i["enableDrag"]:true;var o=e.getFieldName();if(n!==""){n+="_"}n+=o.toLowerCase();var a=t.insertRow(r);a.id=n+"_wrap";a.className="crm-offer-row";var d=a.insertCell(-1);d.className="crm-offer-info-drg-btn";if(!s){d.style.display="none"}d.appendChild(BX.create("SPAN",{props:{className:"crm-offer-drg-btn"}}));d=a.insertCell(-1);d.className="crm-offer-info-left";d.appendChild(BX.create("DIV",{props:{className:"crm-offer-info-label-wrap"},children:[BX.create("SPAN",{props:{className:"crm-offer-info-label-alignment"}}),BX.create("SPAN",{props:{className:"crm-offer-info-label"},text:e.isNeedTitle()?e.getFieldLabel()+":":""})]}));d=a.insertCell(-1);d.className="crm-offer-info-right";d.appendChild(BX.create("DIV",{props:{className:"crm-offer-info-data-wrap"},children:e.prepareLayout()}));d=a.insertCell(-1);d.className="crm-offer-info-right-btn";d.appendChild(BX.create("SPAN",{props:{className:"crm-offer-item-del"}}));d.appendChild(BX.create("SPAN",{props:{className:"crm-offer-item-edit"}}));d=a.insertCell(-1);d.className="crm-offer-last-td";return a};BX.CrmFormFieldRenderer.renderSectionTable=function(e,t){var i=BX.type.isBoolean(t["canCreateSection"])?t["canCreateSection"]:false;var n=BX.type.isBoolean(t["canCreateUserField"])?t["canCreateUserField"]:false;var r=BX.type.isBoolean(t["canRestoreField"])?t["canRestoreField"]:true;var s=BX.type.isNotEmptyString(t["prefix"])?t["prefix"]:"";var o=e["id"];if(s!==""){s+="_"}s+=o.toLowerCase();var a=e["name"];var d=[];var l=BX.create("TABLE",{props:{id:s+"_contents",className:"crm-offer-info-table"}});var h=l.insertRow(-1);h.id=o;var u=h.insertCell(-1);u.setAttribute("colspan","5");u.appendChild(BX.create("DIV",{props:{className:"crm-offer-title"},children:[BX.create("SPAN",{props:{className:"crm-offer-drg-btn"}}),BX.create("SPAN",{props:{className:"crm-offer-title-text"},text:a}),BX.create("SPAN",{props:{className:"crm-offer-title-set-wrap"},text:a,children:[BX.create("SPAN",{props:{id:s+"_edit",className:"crm-offer-title-edit"}}),BX.create("SPAN",{props:{id:s+"_delete",className:"crm-offer-title-del"}})]})]}));h=l.insertRow(-1);h.id=s+"_buttons";h.style.visibility="hidden";u=h.insertCell(-1);u.className="crm-offer-info-drg-btn";u=h.insertCell(-1);u.className="crm-offer-info-left";u=h.insertCell(-1);u.className="crm-offer-info-right";if(n){d.push(BX.create("SPAN",{props:{id:s+"_add_field",className:"crm-offer-info-link"},text:this.getMessage("addFieldButton")}))}if(i){d.push(BX.create("SPAN",{props:{id:s+"_add_section",className:"crm-offer-info-link"},text:this.getMessage("addSectionButton")}))}if(r){d.push(BX.create("SPAN",{props:{id:s+"_restore_field",className:"crm-offer-info-link"},text:this.getMessage("restoreFieldButton")}))}u.appendChild(BX.create("DIV",{props:{className:"crm-offer-item-link-wrap"},children:d}));u=h.insertCell(-1);u.className="crm-offer-info-right-btn";u=h.insertCell(-1);u.className="crm-offer-last-td";var c=BX.type.isElementNode(t["anchorNode"])?t["anchorNode"]:null;var f=BX.type.isElementNode(t["containerNode"])?t["containerNode"]:null;var _=BX.type.isNumber(t["index"])&&t["index"]>0?t["index"]:-1;if(c){var g=BX.findNextSibling(c,{tagName:"TABLE",className:"crm-offer-info-table"});if(g){g.parentNode.insertBefore(l,g)}else{c.parentNode.appendChild(l)}}else if(f){if(_<0){f.appendChild(l)}else{f.insertBefore(l,f.children[_])}}else{throw"CrmFormFieldRenderer: Container node is not defined."}return l};BX.CrmFormFieldRenderer.getMessage=function(e){var t=BX.CrmFormFieldRenderer.messages;return t.hasOwnProperty(e)?t[e]:e};if(typeof BX.CrmFormFieldRenderer.messages==="undefined"){BX.CrmFormFieldRenderer.messages={}}}if(typeof BX.CrmFormFieldPlaceholder==="undefined"){BX.CrmFormFieldPlaceholder=function(){this._settings=null;this._node=null;this._section=null;this._fieldId="";this._fieldIndex=-1};BX.CrmFormFieldPlaceholder.prototype={initialize:function(e){this._settings=e?e:{};this._node=this.getSetting("node",null);this._section=this.getSetting("section",null);this._fieldId=this.getSetting("fieldId","");this._fieldIndex=parseInt(this.getSetting("fieldIndex",-1))},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getNode:function(){return this._node},setNode:function(e){this._node=e},getFieldId:function(){return this._fieldId},getFieldIndex:function(){return this._fieldIndex},layout:function(){if(!this._node){throw"CrmFormFieldPlaceholder: The 'node' is not assigned."}var e=this._node;var t=e.insertCell(-1);t.className="crm-offer-table-cap crm-offer-target-place";t.colSpan=5}};BX.CrmFormFieldPlaceholder.create=function(e){var t=new BX.CrmFormFieldPlaceholder;t.initialize(e);return t}}if(typeof BX.CrmFormSectionPlaceholder==="undefined"){BX.CrmFormSectionPlaceholder=function(){this._settings=null;this._node=null;this._manager=null;this._sectionId="";this._sectionIndex=-1};BX.CrmFormSectionPlaceholder.prototype={initialize:function(e){this._settings=e?e:{};this._node=this.getSetting("node",null);this._manager=this.getSetting("manager",null);this._sectionId=this.getSetting("sectionId","");this._sectionIndex=parseInt(this.getSetting("sectionIndex",-1))},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getNode:function(){return this._node},setNode:function(e){this._node=e},getSectionId:function(){return this._sectionId},getSectionIndex:function(){return this._sectionIndex},layout:function(){if(!this._node){throw"CrmFormSectionPlaceholder: The 'node' is not assigned."}var e=this._node;var t=e.insertRow(-1);var i=t.insertCell(-1);i.className="crm-offer-table-cap crm-offer-target-place";i.colSpan=5}};BX.CrmFormSectionPlaceholder.create=function(e){var t=new BX.CrmFormSectionPlaceholder;t.initialize(e);return t}}if(typeof BX.CrmFormFieldDragItem==="undefined"){BX.CrmFormFieldDragItem=function(){BX.CrmFormFieldDragItem.superclass.constructor.apply(this);this._field=null;this._showFieldInDragMode=true;this._contextId="";this._enableBin=true};BX.extend(BX.CrmFormFieldDragItem,BX.CrmCustomDragItem);BX.CrmFormFieldDragItem.prototype.doInitialize=function(){this._field=this.getSetting("field");if(!this._field){throw"CrmFormFieldDragItem: The 'field' parameter is not defined in settings or empty."}this._showFieldInDragMode=this.getSetting("showFieldInDragMode",true);var e=this.getSetting("contextId","");this._contextId=e!==""?e:BX.CrmFormFieldDragItem.contextId;this._enableBin=this.getSetting("enableBin",true)};BX.CrmFormFieldDragItem.prototype.getField=function(){return this._field};BX.CrmFormFieldDragItem.prototype.createGhostNode=function(){if(this._ghostNode){return this._ghostNode}this._ghostNode=this._field.createGhostNode();document.body.appendChild(this._ghostNode)};BX.CrmFormFieldDragItem.prototype.removeGhostNode=function(){if(this._ghostNode){document.body.removeChild(this._ghostNode);this._ghostNode=null}};BX.CrmFormFieldDragItem.prototype.getContextId=function(){return this._contextId};BX.CrmFormFieldDragItem.prototype.getContextData=function(){return{contextId:this._contextId,field:this._field}};BX.CrmFormFieldDragItem.prototype.processDragStart=function(){BX.CrmFormSectionDragContainer.enable(false);if(!this._showFieldInDragMode){this._field.getNode().style.display="none"}BX.CrmFormFieldDragContainer.refresh()};BX.CrmFormFieldDragItem.prototype.processDragStop=function(){BX.CrmFormSectionDragContainer.enableAfter(true,300);if(!this._showFieldInDragMode){this._field.getNode().style.display=""}BX.CrmFormFieldDragContainer.refreshAfter(300)};BX.CrmFormFieldDragItem.prototype.isDragDropBinEnabled=function(){return this._enableBin};BX.CrmFormFieldDragItem.contextId="form_field_item";BX.CrmFormFieldDragItem.create=function(e,t){var i=new BX.CrmFormFieldDragItem;i.initialize(e,t);return i}}if(typeof BX.CrmFormSectionDragItem==="undefined"){BX.CrmFormSectionDragItem=function(){BX.CrmFormSectionDragItem.superclass.constructor.apply(this);this._section=null;this._showSectionInDragMode=true;this._showFieldsInDragMode=true;this._contextId="";this._enableBin=true};BX.extend(BX.CrmFormSectionDragItem,BX.CrmCustomDragItem);BX.CrmFormSectionDragItem.prototype.doInitialize=function(){this._section=this.getSetting("section");if(!this._section){throw"CrmFormSectionDragItem: The 'section' parameter is not defined in settings or empty."}this._showSectionInDragMode=this.getSetting("showSectionInDragMode",true);this._showFieldsInDragMode=this.getSetting("showFieldsInDragMode",true);var e=this.getSetting("contextId","");this._contextId=e!==""?e:BX.CrmFormSectionDragItem.contextId;this._enableBin=this.getSetting("enableBin",true)};BX.CrmFormSectionDragItem.prototype.getSection=function(){return this._section};BX.CrmFormSectionDragItem.prototype.createGhostNode=function(){if(this._ghostNode){return this._ghostNode}this._ghostNode=this._section.createGhostNode();document.body.appendChild(this._ghostNode)};BX.CrmFormSectionDragItem.prototype.removeGhostNode=function(){if(this._ghostNode){document.body.removeChild(this._ghostNode);this._ghostNode=null}};BX.CrmFormSectionDragItem.prototype.getContextId=function(){return this._contextId};BX.CrmFormSectionDragItem.prototype.getContextData=function(){return{contextId:this._contextId,section:this._section}};BX.CrmFormSectionDragItem.prototype.processDragStart=function(){BX.CrmFormFieldDragContainer.enable(false);if(!this._showSectionInDragMode){this._section.setVisible(false)}if(!this._showFieldsInDragMode){var e=this._section._manager.getSections();for(var t=0;t<e.length;t++){var i=e[t];i.setFieldsVisible(false);i.setButtonsVisible(false)}}BX.CrmFormSectionDragContainer.refresh()};BX.CrmFormSectionDragItem.prototype.processDragStop=function(){BX.CrmFormFieldDragContainer.enableAfter(true,300);if(!this._showSectionInDragMode){this._section.setVisible(true)}if(!this._showFieldsInDragMode){if(!this._showFieldsInDragMode){var e=this._section._manager.getSections();for(var t=0;t<e.length;t++){var i=e[t];i.setFieldsVisible(true);i.setButtonsVisible(true)}}}BX.CrmFormSectionDragContainer.refreshAfter(300)};BX.CrmFormSectionDragItem.prototype.isDragDropBinEnabled=function(){return this._enableBin};BX.CrmFormSectionDragItem.contextId="form_section_item";BX.CrmFormSectionDragItem.create=function(e,t){var i=new BX.CrmFormSectionDragItem;i.initialize(e,t);return i}}if(typeof BX.CrmFormFieldDragContainer==="undefined"){BX.CrmFormFieldDragContainer=function(){BX.CrmFormFieldDragContainer.superclass.constructor.apply(this);this._section=null;this._contextId="";this._priority=-1};BX.extend(BX.CrmFormFieldDragContainer,BX.CrmCustomDragContainer);BX.CrmFormFieldDragContainer.prototype.doInitialize=function(){this._section=this.getSetting("section");if(!this._section){throw"CrmFormFieldDragContainer: The 'section' parameter is not defined in settings or empty."}var e=this.getSetting("contextId","");this._contextId=e!==""?e:BX.CrmFormFieldDragItem.contextId;var t=parseInt(this.getSetting("priority",-1));this._priority=t>0?t:BX.CrmCustomDragContainer.defaultPriority};BX.CrmFormFieldDragContainer.prototype.getSection=function(){return this._section};BX.CrmFormFieldDragContainer.prototype.getPriority=function(){return this._priority};BX.CrmFormFieldDragContainer.prototype.createPlaceHolder=function(e){var t;var i=this._section.getPlaceHolder();if(i){t=BX.pos(i.getNode());if(e.y>=t.top&&e.y<=t.bottom){return}}var n="";var r=-1;var s=this._section.getFields();for(var o=0;o<s.length;o++){var a=s[o];t=BX.pos(a.getNode());if(e.y>=t.top&&e.y<=t.bottom){if(t.top+t.height/2-e.y>=0){n=a.getId();r=o}else if(o<s.length-1){n=s[o+1].getId();r=o+1}break}}this._section.createPlaceHolder({id:n,index:r,fields:s})};BX.CrmFormFieldDragContainer.prototype.removePlaceHolder=function(){this._section.removePlaceHolder()};BX.CrmFormFieldDragContainer.prototype.isAllowedContext=function(e){return e===this._contextId};BX.CrmFormFieldDragContainer.enable=function(e){for(var t in this.items){if(this.items.hasOwnProperty(t)){this.items[t].enable(e)}}};BX.CrmFormFieldDragContainer.enableAfter=function(e,t){t=parseInt(t);if(t>0){window.setTimeout(function(){BX.CrmFormFieldDragContainer.enable(e)})}else{this.enable(e)}};BX.CrmFormFieldDragContainer.refresh=function(){for(var e in this.items){if(this.items.hasOwnProperty(e)){this.items[e].refresh()}}};BX.CrmFormFieldDragContainer.refreshAfter=function(e){e=parseInt(e);if(e>0){window.setTimeout(function(){BX.CrmFormFieldDragContainer.refresh()},e)}else{this.refresh()}};BX.CrmFormFieldDragContainer.items={};BX.CrmFormFieldDragContainer.create=function(e,t){var i=new BX.CrmFormFieldDragContainer;i.initialize(e,t);this.items[i.getId()]=i;return i}}if(typeof BX.CrmFormSectionDragContainer==="undefined"){BX.CrmFormSectionDragContainer=function(){BX.CrmFormSectionDragContainer.superclass.constructor.apply(this);this._manager=null;this._contextId=""};BX.extend(BX.CrmFormSectionDragContainer,BX.CrmCustomDragContainer);BX.CrmFormSectionDragContainer.prototype.doInitialize=function(){this._manager=this.getSetting("manager");if(!this._manager){throw"CrmFormSectionDragContainer: The 'manager' parameter is not defined in settings or empty."}var e=this.getSetting("contextId","");this._contextId=e!==""?e:BX.CrmFormSectionDragItem.contextId};BX.CrmFormSectionDragContainer.prototype.getManager=function(){return this._manager};BX.CrmFormSectionDragContainer.prototype.createPlaceHolder=function(e){var t;var i=this._manager.getPlaceHolder();if(i){t=BX.pos(i.getNode());if(e.y>=t.top&&e.y<=t.bottom){return}}var n="";var r=-1;var s=this._manager.getSections();for(var o=0;o<s.length;o++){var a=s[o];t=BX.pos(a.getContentsNode());if(e.y>=t.top&&e.y<=t.bottom){if(t.top+t.height/2-e.y>=0){n=a.getId();r=o}else if(o<s.length-1){n=s[o+1].getId();r=o+1}break}}this._manager.createPlaceHolder({id:n,index:r,sections:s})};BX.CrmFormSectionDragContainer.prototype.removePlaceHolder=function(){this._manager.removePlaceHolder()};BX.CrmFormSectionDragContainer.prototype.isAllowedContext=function(e){return e===this._contextId};BX.CrmFormSectionDragContainer.enable=function(e){for(var t in this.items){if(this.items.hasOwnProperty(t)){this.items[t].enable(e)}}};BX.CrmFormSectionDragContainer.enableAfter=function(e,t){t=parseInt(t);if(t>0){window.setTimeout(function(){BX.CrmFormSectionDragContainer.enable(e)})}else{this.enable(e)}};BX.CrmFormSectionDragContainer.refresh=function(){for(var e in this.items){if(this.items.hasOwnProperty(e)){this.items[e].refresh()}}};BX.CrmFormSectionDragContainer.refreshAfter=function(e){e=parseInt(e);if(e>0){window.setTimeout(function(){BX.CrmFormSectionDragContainer.refresh()},e)}else{this.refresh()}};BX.CrmFormSectionDragContainer.items={};BX.CrmFormSectionDragContainer.create=function(e,t){var i=new BX.CrmFormSectionDragContainer;i.initialize(e,t);this.items[i.getId()]=i;return i}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:100:"/bitrix/components/bitrix/intranet.user.selector.new/templates/.default/users.min.js?154412742413982";s:6:"source";s:80:"/bitrix/components/bitrix/intranet.user.selector.new/templates/.default/users.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){if(window.IntranetUsers)return;window.IntranetUsers=function(e,t,a){this.name=e;this.multiple=t;this.arSelected=[];this.arFixed=[];this.bSubordinateOnly=a;this.ajaxUrl="";this.lastSearchTime=0};IntranetUsers.arStructure={};IntranetUsers.bSectionsOnly=false;IntranetUsers.arEmployees={group:{}};IntranetUsers.arEmployeesData={};IntranetUsers.ajaxUrl="";IntranetUsers.prototype.loadGroup=function(e){var t=BX(this.name+"_group_section_"+e);function a(t){IntranetUsers.arEmployees["group"][e]=t;this.show(e,t,"g")}e=parseInt(e);if(IntranetUsers.arEmployees["group"][e]!=null){this.show(e,IntranetUsers.arEmployees["group"][e],"g")}else{var s=this.getAjaxUrl()+"&MODE=EMPLOYEES&GROUP_ID="+e;BX.ajax.loadJSON(s,BX.proxy(a,this))}BX.toggleClass(t,"company-department-opened");BX.toggleClass(BX(this.name+"_gchildren_"+e),"company-department-children-opened")};IntranetUsers.prototype.load=function(e,t,a,s){this.bSectionsOnly=s;function n(t){IntranetUsers.arStructure[e]=t.STRUCTURE;IntranetUsers.arEmployees[e]=t.USERS;this.show(e,false,"",this.bSectionsOnly)}if(null==t)t=false;if(null==a)a=false;if(null==s)s=false;if(e!="extranet")e=parseInt(e);var r=BX(this.name+"_employee_section_"+e);if(!r.BX_LOADED){if(IntranetUsers.arEmployees[e]!=null){this.show(e,false,"",this.bSectionsOnly)}else{var i=this.getAjaxUrl()+"&MODE=EMPLOYEES&SECTION_ID="+e;BX.ajax.loadJSON(i,BX.proxy(n,this))}}if(a){BX(this.name+"_employee_search_layout").scrollTop=r.offsetTop-40}BX.toggleClass(r,"company-department-opened");BX.toggleClass(BX(this.name+"_children_"+e),"company-department-children-opened")};IntranetUsers.prototype.show=function(e,t,a,s){s=!!s;a=a||"";var n=BX(this.name+"_"+a+"employee_section_"+e);var r=t||IntranetUsers.arEmployees[e];if(n!==null){n.BX_LOADED=true}var i=BX(this.name+"_"+a+"employees_"+e);if(i){if(IntranetUsers.arStructure[e]!=null&&!a){var l=IntranetUsers.arStructure[e];var o=BX(this.name+"_"+a+"children_"+e);if(o){for(var c=0;c<l.length;c++){obSectionRow1=BX.create("div",{props:{className:"company-department"},children:[s?BX.create("span",{props:{className:"company-department-inner",id:this.name+"_employee_section_"+l[c].ID},children:[BX.create("div",{props:{className:"company-department-arrow"},attrs:{onclick:"O_"+this.name+".load("+l[c].ID+", false, false, true)"}}),BX.create("div",{props:{className:"company-department-text"},attrs:{"data-section-id":l[c].ID,onclick:"O_"+this.name+".selectSection("+this.name+"_employee_section_"+l[c].ID+")"},text:l[c].NAME})]}):BX.create("span",{props:{className:"company-department-inner",id:this.name+"_employee_section_"+l[c].ID},attrs:{onclick:"O_"+this.name+".load("+l[c].ID+")"},children:[BX.create("div",{props:{className:"company-department-arrow"}}),BX.create("div",{props:{className:"company-department-text"},text:l[c].NAME})]})]});obSectionRow2=BX.create("div",{props:{className:"company-department-children",id:this.name+"_children_"+l[c].ID},children:[BX.create("div",{props:{className:"company-department-employees",id:this.name+"_employees_"+l[c].ID},children:[BX.create("span",{props:{className:"company-department-employees-loading"},text:BX.message("INTRANET_EMP_WAIT")})]})]});o.appendChild(obSectionRow1);o.appendChild(obSectionRow2)}o.appendChild(i)}}i.innerHTML="";for(var c=0;c<r.length;c++){var p;var d=false;IntranetUsers.arEmployeesData[r[c].ID]={id:r[c].ID,name:r[c].NAME,sub:r[c].SUBORDINATE=="Y"?true:false,sup:r[c].SUPERORDINATE=="Y"?true:false,position:r[c].WORK_POSITION,photo:r[c].PHOTO};var m=BX.create("input",{props:{className:"intranet-hidden-input"}});if(this.multiple){m.name=this.name+"[]";m.type="checkbox"}else{m.name=this.name;m.type="radio"}var h=document.getElementsByName(m.name);var u=0;while(!d&&u<h.length){if(h[u].value==r[c].ID&&h[u].checked){d=true}u++}m.value=r[c].ID;p=BX.create("div",{props:{className:"company-department-employee"+(d?" company-department-employee-selected":"")},events:{click:BX.proxy(this.select,this)},children:[m,BX.create("div",{props:{className:"company-department-employee-avatar"},style:{background:r[c].PHOTO?"url('"+r[c].PHOTO+"') no-repeat center center":"",backgroundSize:r[c].PHOTO?"cover":""}}),BX.create("div",{props:{className:"company-department-employee-icon"}}),BX.create("div",{props:{className:"company-department-employee-info"},children:[BX.create("div",{props:{className:"company-department-employee-name"},text:r[c].NAME}),BX.create("div",{props:{className:"company-department-employee-position"},html:!r[c].HEAD&&!r[c].WORK_POSITION?"&nbsp;":BX.util.htmlspecialchars(r[c].WORK_POSITION)+(r[c].HEAD&&r[c].WORK_POSITION?", ":"")+(r[c].HEAD?BX.message("INTRANET_EMP_HEAD"):"")})]})]});i.appendChild(p)}}};IntranetUsers.prototype.select=function(e){var t;var a=0;var s=e.target||e.srcElement;if(e.currentTarget){t=e.currentTarget}else{t=s;while(!BX.hasClass(t,"finder-box-item")&&!BX.hasClass(t,"company-department-employee")){t=t.parentNode}}var n=BX.findChild(t,{tag:"input"});if(!this.multiple){var r=document.getElementsByName(this.name);for(var a=0;a<r.length;a++){if(r[a].value!=n.value){BX.removeClass(r[a].parentNode,BX.hasClass(r[a].parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}else{BX.addClass(r[a].parentNode,BX.hasClass(r[a].parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}}n.checked=true;BX.addClass(t,BX.hasClass(t,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected");this.searchInput.value=IntranetUsers.arEmployeesData[n.value].name;this.arSelected=[];this.arSelected[n.value]={id:n.value,name:IntranetUsers.arEmployeesData[n.value].name,sub:IntranetUsers.arEmployeesData[n.value].sub,sup:IntranetUsers.arEmployeesData[n.value].sup,position:IntranetUsers.arEmployeesData[n.value].position,photo:IntranetUsers.arEmployeesData[n.value].photo}}else{var r=document.getElementsByName(this.name+"[]");if(!BX.util.in_array(n,r)&&!BX.util.in_array(n.value,this.arFixed)){n.checked=false;BX.toggleClass(n.parentNode,BX.hasClass(n.parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}for(var a=0;a<r.length;a++){if(r[a].value==n.value&&!BX.util.in_array(n.value,this.arFixed)){r[a].checked=false;BX.toggleClass(r[a].parentNode,BX.hasClass(r[a].parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}}if(BX.hasClass(n.parentNode,"finder-box-item-selected")||BX.hasClass(n.parentNode,"company-department-employee-selected")){n.checked=true}if(n.checked){var i=BX.findChild(BX(this.name+"_selected_users"),{className:"finder-box-selected-items"});if(!BX(this.name+"_employee_selected_"+n.value)){var l=BX.create("DIV");l.id=this.name+"_employee_selected_"+n.value;l.className="finder-box-selected-item";var o=BX.findChild(t,{tag:"DIV",className:"finder-box-item-text"},true)||BX.findChild(t,{tag:"DIV",className:"company-department-employee-name"},true);l.innerHTML='<div class="finder-box-selected-item-icon" id="'+this.name+"-user-selector-unselect-"+n.value+'" onclick="O_'+this.name+".unselect("+n.value+', this);"></div><span class="finder-box-selected-item-text">'+o.innerHTML+"</span>";i.appendChild(l);var c=BX(this.name+"_current_count");c.innerHTML=parseInt(c.innerHTML)+1;this.arSelected[n.value]={id:n.value,name:IntranetUsers.arEmployeesData[n.value].name,sub:IntranetUsers.arEmployeesData[n.value].sub,sup:IntranetUsers.arEmployeesData[n.value].sup,position:IntranetUsers.arEmployeesData[n.value].position,photo:IntranetUsers.arEmployeesData[n.value].photo}}}else{BX.remove(BX(this.name+"_employee_selected_"+n.value));var c=BX(this.name+"_current_count");c.innerHTML=parseInt(c.innerHTML)-1;this.arSelected[n.value]=null}}var p=BX.util.array_search(n.value,IntranetUsers.lastUsers);if(p>=0)IntranetUsers.lastUsers.splice(p,1);IntranetUsers.lastUsers.unshift(n.value);BX.userOptions.save("intranet","user_search","last_selected",IntranetUsers.lastUsers.slice(0,10));if(this.onSelect){var d=this.arSelected.pop();this.arSelected.push(d);this.onSelect(d)}BX.onCustomEvent(this,"on-change",[this.toObject(this.arSelected)]);if(this.onChange){this.onChange(this.arSelected)}};IntranetUsers.prototype.toObject=function(e){var t={};for(var a in e){a=parseInt(a);if(typeof a=="number"&&e[a]!==null){t[a]=BX.clone(e[a])}}return t};IntranetUsers.prototype.selectSection=function(e){var t=BX(e);if(!t){return false}else{var a=BX.findChild(t,{tag:"div",className:"company-department-text"});if(a){if(this.onSectionSelect){this.onSectionSelect({id:a.getAttribute("data-section-id"),name:a.innerHTML})}}}};IntranetUsers.prototype.unselect=function(e){var t=BX(this.name+"-user-selector-unselect-"+e);var a=document.getElementsByName(this.name+(this.multiple?"[]":""));for(var s=0;s<a.length;s++){if(a[s].value==e){a[s].checked=false;BX.removeClass(a[s].parentNode,BX.hasClass(a[s].parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}}if(this.multiple){if(t){BX.remove(t.parentNode)}var n=BX(this.name+"_current_count");n.innerHTML=parseInt(n.innerHTML)-1}this.arSelected[e]=null;BX.onCustomEvent(this,"on-change",[this.toObject(this.arSelected)]);if(this.onChange){this.onChange(this.arSelected)}};IntranetUsers.prototype.getSelected=function(){return this.arSelected};IntranetUsers.prototype.setSelected=function(e){for(var t=0,a=this.arSelected.length;t<a;t++){if(this.arSelected[t]&&this.arSelected[t].id)this.unselect(this.arSelected[t].id)}if(!this.multiple){e=[e[0]]}this.arSelected=[];for(var t=0,a=e.length;t<a;t++){this.arSelected[e[t].id]=e[t];var s=BX.create("input",{props:{className:"intranet-hidden-input",value:e[t].id,checked:"checked",name:this.name+(this.multiple?"[]":"")}});BX(this.name+"_last").appendChild(s);if(this.multiple){var n=BX.findChild(BX(this.name+"_selected_users"),{className:"finder-box-selected-items"});var r=BX.create("div",{props:{className:"finder-box-selected-item",id:this.name+"_employee_selected_"+e[t].id},html:'<div class="finder-box-selected-item-icon" id="'+this.name+"-user-selector-unselect-"+e[t].id+'" onclick="O_'+this.name+".unselect("+e[t].id+', this);"></div><span class="finder-box-selected-item-text">'+BX.util.htmlspecialchars(e[t].name)+"</span>"});n.appendChild(r)}var i=document.getElementsByName(this.name+(this.multiple?"[]":""));for(var l=0;l<i.length;l++){if(i[l].value==e[t].id){BX.toggleClass(i[l].parentNode,BX.hasClass(i[l].parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}}}if(this.multiple){BX.adjust(BX(this.name+"_current_count"),{text:e.length})}};IntranetUsers.prototype.setFixed=function(e){if(typeof e!="object")e=[];this.arFixed=e;var t=BX.findChildren(BX(this.name+"_selected_users"),{className:"finder-box-selected-item-icon"},true);for(i=0;i<t.length;i++){var a=t[i].id.replace(this.name+"-user-selector-unselect-","");BX.adjust(t[i],{style:{visibility:BX.util.in_array(a,this.arFixed)?"hidden":"visible"}})}};IntranetUsers.prototype.search=function(e){this.searchRqstTmt=clearTimeout(this.searchRqstTmt);if(typeof this.searchRqst=="object"){this.searchRqst.abort();this.searchRqst=false}if(!e)e=window.event;if(this.searchInput.value.length>0){this.displayTab("search");var t=this.getAjaxUrl()+"&MODE=SEARCH&SEARCH_STRING="+encodeURIComponent(this.searchInput.value);if(this.bSubordinateOnly)t+="&S_ONLY=Y";var a=this;this.searchRqstTmt=setTimeout(function(){var e=(new Date).getTime();a.lastSearchTime=e;a.searchRqst=BX.ajax.loadJSON(t,BX.proxy(function(t){if(a.lastSearchTime==e)a.showResults(t)},a))},400)}};IntranetUsers.prototype.showResults=function(e){var t=e;var a=BX(this.name+"_search");var s=a.getElementsByTagName("input");var n=null;for(n=0,count=s.length;n<count;n++){if(s[n].checked){BX(this.name+"_last").appendChild(s[n])}}if(a){a.innerHTML="";var r=BX.create("table",{props:{className:"finder-box-tab-columns",cellspacing:"0"},children:[BX.create("tbody")]});var i=BX.create("tr");r.firstChild.appendChild(i);var l=BX.create("td");i.appendChild(l);a.appendChild(r);for(n=0;n<t.length;n++){var o;var c=false;IntranetUsers.arEmployeesData[t[n].ID]={id:t[n].ID,name:t[n].NAME,sub:t[n].SUBORDINATE=="Y"?true:false,sup:t[n].SUPERORDINATE=="Y"?true:false,position:t[n].WORK_POSITION,photo:t[n].PHOTO};var p=BX.create("input",{props:{className:"intranet-hidden-input"}});if(this.multiple){p.name=this.name+"[]";p.type="checkbox"}else{p.name=this.name;p.type="radio"}s=document.getElementsByName(p.name);var d=0;while(!c&&d<s.length){if(s[d].value==t[n].ID&&s[d].checked){c=true}d++}p.value=t[n].ID;var m=t[n].NAME;o=BX.create("div",{props:{className:"finder-box-item"+(c?" finder-box-item-selected":"")},events:{click:BX.proxy(this.select,this)},children:[p,BX.create("div",{props:{className:"finder-box-item-text"},attrs:{"bx-tooltip-user-id":t[n].ID,"bx-tooltip-classname":"intrantet-user-selector-tooltip"},text:m}),BX.create("div",{props:{className:"finder-box-item-icon"}})]});l.appendChild(o);if(n==Math.ceil(t.length/2)-1){l=BX.create("td");r.firstChild.appendChild(l)}}}};IntranetUsers.prototype.displayTab=function(e){BX.removeClass(BX(this.name+"_last"),"finder-box-tab-content-selected");BX.removeClass(BX(this.name+"_search"),"finder-box-tab-content-selected");BX.removeClass(BX(this.name+"_structure"),"finder-box-tab-content-selected");BX.removeClass(BX(this.name+"_groups"),"finder-box-tab-content-selected");BX.addClass(BX(this.name+"_"+e),"finder-box-tab-content-selected");BX.removeClass(BX(this.name+"_tab_last"),"finder-box-tab-selected");BX.removeClass(BX(this.name+"_tab_search"),"finder-box-tab-selected");BX.removeClass(BX(this.name+"_tab_structure"),"finder-box-tab-selected");BX.removeClass(BX(this.name+"_tab_groups"),"finder-box-tab-selected");BX.addClass(BX(this.name+"_tab_"+e),"finder-box-tab-selected")};IntranetUsers.prototype._onFocus=function(){this.searchInput.value=""};IntranetUsers.prototype.getAjaxUrl=function(){return this.ajaxUrl||IntranetUsers.ajaxUrl}})();
/* End */
;; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?154412738440309*/
; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js?1544127384575*/
; /* /bitrix/components/bitrix/crm.invoice.menu/templates/.default/script.js?1544127401455*/
; /* /bitrix/components/bitrix/crm.interface.form.recurring/templates/edit/script.min.js?154412740118511*/
; /* /bitrix/components/bitrix/crm.product_row.list/templates/.default/script.min.js?1544127401100018*/
; /* /bitrix/components/bitrix/crm.product_row.list/templates/.default/product_create.min.js?15441274018298*/
; /* /bitrix/components/bitrix/crm.interface.form.tactile/templates/.default/bitrix/main.interface.form/tactile/script.min.js?154412740191254*/
; /* /bitrix/components/bitrix/intranet.user.selector.new/templates/.default/users.min.js?154412742413982*/

//# sourceMappingURL=page_9426110553e9cda0556567760c1e5d0f.map.js