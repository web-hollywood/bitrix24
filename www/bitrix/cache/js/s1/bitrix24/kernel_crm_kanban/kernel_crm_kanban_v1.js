; /* /bitrix/js/crm/kanban/actions.min.js?15441274014520*/
; /* /bitrix/js/crm/kanban/grid.min.js?154412740123459*/
; /* /bitrix/js/crm/kanban/item.min.js?154412740115604*/
; /* /bitrix/js/crm/kanban/column.min.js?154412740110448*/

; /* Start:"a:4:{s:4:"full";s:51:"/bitrix/js/crm/kanban/actions.min.js?15441274014520";s:6:"source";s:32:"/bitrix/js/crm/kanban/actions.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Actions={startCallList:function(e,t){if(typeof BX.CrmCallListHelper==="undefined"){return}if(typeof t==="undefined"){t=true}var i=e.getData();BX.CrmCallListHelper.createCallList({entityType:i.entityType,entityIds:e.getChecked(),createActivity:t},function(e){if(!BX.type.isPlainObject(e)){return}if(!e.SUCCESS&&e.ERRORS){var i=e.ERRORS.join(". \n");BX.Kanban.Utils.showErrorDialog(i)}else if(e.SUCCESS&&e.DATA){var n=e.DATA;if(n.RESTRICTION){if(B24.licenseInfoPopup){B24.licenseInfoPopup.show("ivr-limit-popup",n.RESTRICTION.HEADER,n.RESTRICTION.CONTENT)}}else{var a=n.ID;if(t&&BXIM){BXIM.startCallList(a,{})}else{(new BX.Crm.Activity.Planner).showEdit({PROVIDER_ID:"CALL_LIST",PROVIDER_TYPE_ID:"CALL_LIST",ASSOCIATED_ENTITY_ID:a})}}}})},notifySimpleAction:function(e,t){if(e==="DEAL_CHANGECATEGORY"){e="DEAL_CHANGECATEGORY_LINK"}e="CRM_KANBAN_NOTIFY_"+e;if(typeof BX.message[e]!=="undefined"){var i=BX.message[e];if(BX.type.isPlainObject(t)){for(var n in t){i=i.replace("#"+n+"#",t[n])}}BX.UI.Notification.Center.notify({content:i})}},simpleAction:function(e,t,i){if(t.action==="delete"){var n=e.getChecked();for(var a=0,o=n.length;a<o;a++){e.hideItem(n[a])}}e.ajax(t,function(n){var a=e.getData();if(n&&!n.error){if(t.action!=="delete"){e.onApplyFilter()}e.stopActionPanel();var o=a.entityType;if(t.action==="delete"&&t.ignore==="Y"){o+="_IGNORE"}else{o+="_"+t.action.toUpperCase()}if(i!==true){this.notifySimpleAction(o,t)}}else if(n){if(t.action==="status"){e.stopActionPanel();e.onApplyFilter();if(a.entityType==="LEAD"||a.entityType==="DEAL"){BX.Kanban.Utils.showErrorDialog(BX.message("CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_"+a.entityType))}else{BX.Kanban.Utils.showErrorDialog(n.error,n.fatal)}}else{BX.Kanban.Utils.showErrorDialog(n.error,n.fatal)}}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true)}.bind(this))},setAssigned:function(e,t){this.simpleAction(e,{action:"setAssigned",ids:e.getChecked(),assignedId:t.entityId,assignedName:t.name},false)},changeCategory:function(e,t){var i=e.getData();var n="";if(i.linksPath&&i.linksPath.dealCategory&&i.linksPath.dealCategory.url){n=i.linksPath.dealCategory.url;n=n.replace("#category_id#",t.ID)}this.simpleAction(e,{action:"changeCategory",id:e.getChecked(),category:t.ID,categoryName:BX.util.htmlspecialchars(t.NAME),categoryLink:n},false)},changeColumn:function(e,t){var i=e.getData();this.simpleAction(e,{action:"status",entity_id:e.getChecked(),status:t.id,statusName:BX.util.htmlspecialchars(t.name),entity_type:i.entityType},false)},delete:function(e,t){this.simpleAction(e,{action:"delete",id:t},true)},deleteAll:function(e){this.confirm(BX.message("CRM_KANBAN_PANEL_ACTION_CONFIRM"),function(){this.simpleAction(e,{action:"delete",id:e.getChecked()},false)}.bind(this))},open:function(e,t){if(typeof t==="undefined"){t=false}this.simpleAction(e,{action:"open",id:e.getChecked(),flag:t?"Y":"N"},false)},ignore:function(e,t){this.confirm(BX.message("CRM_KANBAN_PANEL_ACTION_CONFIRM"),function(){this.simpleAction(e,{action:"delete",ignore:"Y",id:e.getChecked()},false)}.bind(this))},refreshaccount:function(e){this.simpleAction(e,{action:"refreshAccount",id:e.getChecked()},false)},email:function(e){if(BX.CrmActivityEditor&&BX.CrmActivityProvider&&BX.CrmActivityEditor.items["kanban_activity_editor"]){var t=e.getData();var i=[];var n=e.getChecked();for(var a=0,o=n.length;a<o;a++){i.push({type:"EMAIL",entityId:n[a],entityType:t.entityType})}BX.CrmActivityEditor.items["kanban_activity_editor"].addEmail({communications:i,communicationsLoaded:true})}},task:function(e){if(typeof window["taskIFramePopup"]!=="undefined"){var t=e.getData();var i="";var n=e.getChecked();for(var a=0,o=n.length;a<o;a++){i+=BX.CrmOwnerTypeAbbr.resolve(t.entityType)+"_"+n[a]+";"}window["taskIFramePopup"].add({UF_CRM_TASK:i,TITLE:"CRM: ",TAGS:"crm"})}},confirm:function(e,t){var i=BX.PopupWindowManager.create("crm-kanban-confirm-dialog",null,{titleBar:BX.message("CRM_KANBAN_CONFIRM_TITLE"),content:"",width:400,autoHide:false,overlay:true,closeByEsc:true,closeIcon:true,draggable:{restrict:true}});i.setContent(e);i.setButtons([,new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_CONFIRM_Y"),className:"popup-window-button-accept",events:{click:function(){t();this.popupWindow.close()}}}),new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_CONFIRM_N"),className:"popup-window-button-cancel",events:{click:function(){this.popupWindow.close()}}})]);i.show();return i}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:49:"/bitrix/js/crm/kanban/grid.min.js?154412740123459";s:6:"source";s:29:"/bitrix/js/crm/kanban/grid.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Grid=function(t){BX.Kanban.Grid.apply(this,arguments);BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemCaptured",BX.delegate(this.onBeforeItemCaptured,this));BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemRestored",BX.delegate(this.onBeforeItemRestored,this));BX.addCustomEvent(this,"Kanban.Grid:onBeforeItemMoved",BX.delegate(this.onBeforeItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onItemMoved",BX.delegate(this.onItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnAddedAsync",BX.delegate(this.onColumnAddedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnUpdated",BX.delegate(this.onColumnUpdated,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnMoved",BX.delegate(this.onColumnMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnRemovedAsync",BX.delegate(this.onColumnRemovedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnLoadAsync",BX.delegate(this.onColumnLoadAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.onItemDragStartHandler,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.setKanbanDragMode,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStop",BX.delegate(this.unSetKanbanDragMode,this));BX.addCustomEvent("BX.Main.Filter:apply",BX.delegate(this.onApplyFilter,this));BX.addCustomEvent("BX.CrmEntityCounterPanel:applyFilter",BX.delegate(this.onApplyFilterCounter,this));BX.addCustomEvent("Crm.PartialEditorDialog.Close",BX.delegate(this.onPartialEditorClose,this));BX.addCustomEvent("onPullEvent-crm",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onPullEvent-im",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onCrmActivityTodoChecked",BX.proxy(this.onCrmActivityTodoChecked,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.onSliderClose,this));BX.addCustomEvent("BX.CRM.Kanban.Item.select",BX.proxy(this.setMultiSelectMode,this));BX.addCustomEvent("BX.CRM.Kanban.Item.select",BX.proxy(this.startActionPanel,this));BX.addCustomEvent("BX.CRM.Kanban.Item.select",BX.proxy(this.onMultiSelectMode,this));BX.addCustomEvent("BX.CRM.Kanban.Item.select",BX.proxy(this.calculateTotalCheckItems,this));BX.addCustomEvent("BX.CRM.Kanban.Item.unSelect",BX.proxy(this.calculateTotalCheckItems,this));BX.addCustomEvent("BX.CRM.Kanban.Item.unSelect",BX.proxy(this.resetMultiSelectMode,this));BX.addCustomEvent("onPopupShow",BX.proxy(this.onPopupShow,this));setInterval(BX.proxy(this.loadNew,this),this.loadNewInterval*1e3);this.bindEvents()};BX.CRM.Kanban.Grid.prototype={__proto__:BX.Kanban.Grid.prototype,constructor:BX.CRM.Kanban.Grid,accessNotifyDialog:null,loadNewInterval:25,ajaxParams:{},customFieldsPopup:null,customFieldsContainer:null,actionPanel:null,currentNode:null,itemMoving:null,progressBarEditor:null,ccItem:null,getChecked:function(){var t=[];var e=this.getItems();for(var i in e){var n=e[i];if(n.isChecked()){t.push(n.getId())}}return t},bindEvents:function(){BX.addCustomEvent("BX.UI.ActionPanel:hidePanel",this.resetSelectItems.bind(this));BX.bind(window,"click",function(t){this.isItKanban(t.target)?this.currentNode=t.target:this.currentNode=null;if(!BX.findParent(t.target,{className:"main-kanban-item"})&&!BX.findParent(t.target,{className:"ui-action-panel"})){this.resetSelectItems()}if(this.getChecked().length<=0){this.stopActionPanel()}}.bind(this));BX.bind(window,"keydown",function(t){if(t.code==="Escape"){this.resetSelectItems();this.stopActionPanel()}}.bind(this))},isItKanban:function(t){if(BX.findParent(t,{className:"main-kanban"})){return true}},setKanbanDragMode:function(){BX.addClass(document.body,"crm-kanban-drag-mode")},unSetKanbanDragMode:function(){BX.removeClass(document.body,"crm-kanban-drag-mode")},renderLayout:function(){var t=this.getData();BX.Kanban.Grid.prototype.renderLayout.apply(this,arguments);this.setDropareaFirstItemWidth();if(this.ccItem&&!t.contactCenterShow){this.hideItem(this.ccItem)}},setDropareaFirstItemWidth:function(){var t=document.head;var e=BX.create("style",{attrs:{type:"text/css"}});var i=document.createTextNode(".main-kanban-dropzone:first-child, main-kanban-dropzone:last-child {"+"max-width: "+(this.layout.gridContainer.firstChild.offsetWidth+3)+"px; "+"min-width: "+(this.layout.gridContainer.firstChild.offsetWidth+3)+"px;}");e.appendChild(i);t.appendChild(e)},getAjaxHandlerPath:function(){var t=this.getData();return BX.type.isNotEmptyString(t.ajaxHandlerPath)?t.ajaxHandlerPath:"/bitrix/components/bitrix/crm.kanban/ajax.php"},setAjaxParams:function(t){this.ajaxParams=t},ajax:function(t,e,i,n){var a=this.getData();var o=this.getAjaxHandlerPath();if(typeof n==="undefined"){n="json"}t.sessid=BX.bitrix_sessid();t.extra=a.params;t.entity_type=a.entityType;t.version=2;t.ajaxParams=this.ajaxParams;if(t.action!=="undefined"){o+=o.indexOf("?")===-1?"?":"&";o+="action="+t.action}BX.ajax({method:"POST",dataType:n,url:o,data:t,onsuccess:e,onfailure:i})},accessNotify:function(){if(typeof BX.Intranet!=="undefined"&&typeof BX.Intranet.NotifyDialog!=="undefined"){if(this.accessNotifyDialog===null){var t=this.getData();this.accessNotifyDialog=new BX.Intranet.NotifyDialog({listUserData:[],notificationHandlerUrl:this.getAjaxHandlerPath()+"?action=notifyAdmin&version=2&entity_type="+t.entityType,popupTexts:{sendButton:BX.message("CRM_KANBAN_NOTIFY_BUTTON"),title:BX.message("CRM_KANBAN_NOTIFY_TITLE"),header:BX.message("CRM_KANBAN_NOTIFY_HEADER"),description:BX.message("CRM_KANBAN_NOTIFY_TEXT")}})}this.accessNotifyDialog.setUsersForNotify(this.getData().admins);this.accessNotifyDialog.show()}},addStage:function(t){var e=new BX.Promise;var i=this.getPreviousColumnSibling(t);var n=i?i.getId():0;this.ajax({action:"modifyStage",columnName:t.getName(),columnColor:t.getColor(),afterColumnId:n},function(t){if(t&&!t.error){this.resetActionPanel();e.fulfill(t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},removeStage:function(t){var e=new BX.Promise;this.ajax({action:"modifyStage",columnId:t.getId(),delete:1},function(t){if(t&&!t.error){this.resetActionPanel();e.fulfill()}else if(t){e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},getColumnItems:function(t){var e=new BX.Promise;this.ajax({action:"page",page:t.getPagination().getPage()+1,column:t.getId()},function(t){if(t&&(BX.type.isArray(t)||BX.type.isArray(t.items))&&!t.error){e.fulfill(BX.type.isArray(t)?t:t.items)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}if(this.ccItem){var i=this.getData();if(!i.contactCenterShow){this.hideItem(this.ccItem)}}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},addItemTop:function(t){var e=this.getColumn(t.columnId);var i=e?e.getItems():[];if(i.length>0){t.targetId=i[0].getId()}e.incPrice(t.data.price);this.addItem(t)},loadNew:function(t,e){var i=this.getData();var n=typeof t!=="undefined"?t:0;if(document.hidden){return}this.ajax(n?{action:"get",entity_id:n,force:e===true?"Y":"N"}:{action:"get",min_entity_id:i.lastId,force:e===true?"Y":"N"},function(t){if(t&&t.items){if(t.items.length>0){var e={};for(var a=t.items.length-1;a>=0;a--){var o=t.items[a];var r=this.getItem(o.id);if(o.id<=0){continue}if(r){var s=r.getData();var l=r.getColumn();var d=this.getColumn(o.columnId);l.decPrice(parseFloat(s.price));e[l.getId()]=l;if(d){d.incPrice(parseFloat(o.data.price));this.updateItem(o.id,o);e[d.getId()]=d}else{this.removeItem(o.id)}}else if(o.id){this.addItemTop(o)}if(!n){i.lastId=o.id;this.setData(i)}}for(var c in e){e[c].renderSubTitle()}}else if(n){var o=this.getItem(n);if(o){var u=o.getData();var m=o.getColumn();m.decPrice(u.price);this.removeItem(n)}}}}.bind(this),function(t){}.bind(this))},onItemDragStart:function(t){this.setDragMode(BX.Kanban.DragMode.ITEM);var e=this.getData();var i=this.getItems();var n=t.getColumn().getData();var a=t.getColumnId();if(parseInt(t.getId())<0){return}if(e.entityType==="LEAD"&&n.type==="WIN"){for(var o in i){var r=i[o].getColumnId();if(r===a){i[o].enableDropping()}}return}BX.Kanban.Grid.prototype.onItemDragStart.apply(this,arguments);if(this.progressBarEditor){this.progressBarEditor.close()}},onItemDragStartHandler:function(t){t.setLastPosition()},onColumnLoadAsync:function(t){t.push(BX.delegate(this.getColumnItems,this))},onColumnRemovedAsync:function(t){t.push(BX.delegate(this.removeStage,this))},onColumnAddedAsync:function(t){t.push(BX.delegate(this.addStage,this))},onBeforeItemCaptured:function(t){BX.onCustomEvent("Crm.Kanban.Grid:onBeforeItemCapturedStart",[this,t]);if(t.isActionAllowed()){var e=t.getItem();var i=e.getColumn();var n=t.getDropZone();this.itemMoving={item:e,price:parseFloat(e.getData().price),oldColumn:i,oldNextSiblingId:i.getNextItemSibling(e),newColumn:null,newNextSibling:null,dropEvent:t};i.decPrice(this.itemMoving.price);this.onItemMoved(e,n,null,true);if(n.getId()==="DELETED"){setTimeout(function(){if(!e.isVisible()){BX.CRM.Kanban.Actions.delete(this,e.getId())}}.bind(this),n.getDropZoneArea().getDropZoneTimeout())}}},onBeforeItemRestored:function(t){var e=t.getItem();var i=e.getColumn();var n=parseFloat(e.getData().price);i.incPrice(n);this.onItemMoved(e,i)},onBeforeItemMoved:function(t){var e=t.getItem();var i=e.getColumn();this.itemMoving={item:e,price:parseFloat(e.getData().price),oldColumn:i,oldNextSiblingId:i.getNextItemSibling(e),newColumn:null,newNextSibling:null}},onItemMoved:function(t,e,i,n){var a=t.getData();var o=e.getId();var r=this.getData();var s=e instanceof BX.Kanban.DropZone;if(a.required&&a.required[o]&&a.required[o].length>0&&this.itemMoving.oldColumn.getId()!==e.getId()){if(a.required_fm){var l=[];for(var d=0,c=a.required[o].length;d<c;d++){var u=a.required[o][d];if(typeof a.required_fm[u]==="undefined"||a.required_fm[u]===true){l.push(a.required[o][d])}}a.required[o]=l}if(a.required[o].length>0){this.itemMoving.newColumn=e;this.itemMoving.newNextSibling=i;if(!s){this.moveItem(this.itemMoving.item,this.itemMoving.oldColumn,this.itemMoving.oldNextSiblingId)}else{this.itemMoving.dropEvent.denyAction()}this.progressBarEditor=BX.Crm.PartialEditorDialog.create("progressbar-entity-editor",{entityTypeId:r.entityTypeInt,entityId:t.getId(),fieldNames:a.required[o],title:BX.message("CRM_KANBAN_REQUIRED_FIELDS_TITLE_"+r.entityType)});this.progressBarEditor.open();BX.addClass(t.layout.container,"main-kanban-item-waiting");return}}if(!s){if(this.itemMoving.item.getData().runtimePrice!==true){this.itemMoving.oldColumn.decPrice(this.itemMoving.price)}e.incPrice(this.itemMoving.price);e.renderSubTitle();this.itemMoving.oldColumn.renderSubTitle()}else if(this.itemMoving.item.getData().runtimePrice===true){this.itemMoving.oldColumn.incPrice(this.itemMoving.price)}this.itemMoving.item.setDataKey("runtimePrice",false);if(n!==true){var m={grid:this,item:t,targetColumn:e,beforeItem:i,skip:false};BX.onCustomEvent("Crm.Kanban.Grid:onItemMovedFinal",[m]);if(m.skip===true){return}}var h=0;var g=t.getId();var f=e?e.getId():0;if(e instanceof BX.Kanban.DropZone){h=0}else{var p=e.getPreviousItemSibling(t);if(p){h=p.getId()}}BX.removeClass(t.layout.container,"main-kanban-item-waiting");this.ajax({action:"status",entity_id:g,prev_entity_id:h,status:f},function(e){if(e&&!e.error){if(e.items&&e.items.length>0){this.updateItem(g,e.items[0])}else{t.setDataKey("columnId",f)}}else if(e){BX.Kanban.Utils.showErrorDialog(e.error,true)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onColumnUpdated:function(t){var e=t.getId();var i=t.getName();var n=t.getColor();this.ajax({action:"modifyStage",columnId:e,columnName:i,columnColor:n},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}else{this.resetActionPanel()}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onColumnMoved:function(t,e){var i=t.getId();var n=this.getPreviousColumnSibling(t);var a=n?n.getId():0;this.ajax({action:"modifyStage",columnId:i,afterColumnId:a},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,true)}else{this.resetActionPanel()}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onApplyFilter:function(t,e,i,n,a){this.fadeOut();if(typeof a!=="undefined"){a.autoResolve=false}this.ajax({action:"get"},function(t){var e=[],i=null;var a=this.getColumns();for(var o=0,r=a.length;o<r;o++){i=a[o].getId();e.push(i);this.removeColumn(i)}this.removeItems();this.loadData(t);var s=this.getDropZoneArea();var l=this.getDropZoneArea().getDropZones();for(var o=0,r=l.length;o<r;o++){s.removeDropZone(l[o])}if(t.dropzones){for(var o=0,r=t.dropzones.length;o<r;o++){s.addDropZone(t.dropzones[o])}}var d=null;a=this.getColumns();for(var o=0,r=a.length;o<r;o++){i=a[o].getId();if(!BX.util.in_array(i,e)){d=a[o]}}if(d!==null){this.addClassEar()}this.fadeIn();if(typeof n!=="undefined"){n.fulfill()}}.bind(this),function(t){if(typeof n!=="undefined"){n.reject()}this.fadeIn()}.bind(this))},addClassEar:function(){var t=document.querySelector(".main-kanban-ear-right");t.classList.contains("crm-kanban-ear-animate")?BX.removeClass("crm-kanban-ear-animate"):null;BX.addClass(t,"crm-kanban-ear-animate")},toggleCC:function(){var t=BX.PopupMenu.getCurrentMenu();if(t){t.close()}if(this.ccItem){var e=this.getData();if(e.contactCenterShow){this.hideItem(this.ccItem)}else{this.unhideItem(this.ccItem)}e.contactCenterShow=!e.contactCenterShow}this.ajax({action:"toggleCC"},function(){}.bind(this),function(t){}.bind(this))},addMenuToggleCS:function(t){var e=this.getData();var i=BX.PopupMenu.getCurrentMenu(t);if(i){i.addMenuItem({text:"",delimiter:true},null);i.addMenuItem({text:e.contactCenterShow?BX.message("CRM_KANBAN_HIDE_CC"):BX.message("CRM_KANBAN_SHOW_CC"),onclick:function(t,e){this.toggleCC()}.bind(this)},null)}},addMenuCustomFieldsPopup:function(t){var e=this.getData();var i=e.entityType.toLowerCase();var n=BX.PopupMenu.getCurrentMenu(t);if(n){var a=n.getMenuItems();n.addMenuItem({text:BX.message("CRM_KANBAN_CUSTOM_FIELDS"),onclick:function(){if(!this.customFieldsPopup){this.customFieldsPopup=new BX.PopupWindow("kanban_custom_fields",window.body,{closeIcon:true,offsetLeft:0,lightShadow:true,overlay:true,titleBar:{content:BX.create("span",{html:""})},draggable:true,contentColor:"white",closeByEsc:true,buttons:[new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_POPUP_SAVE"),className:"popup-window-button-accept",events:{click:function(){var t={};var e=BX.findChild(this.customFieldsContainer,{tagName:"input"},false,true);for(var i=0,n=e.length;i<n;i++){if(e[i].checked){t[e[i].getAttribute("name")]=BX.data(e[i],"label")}}this.ajax({action:"saveFields",fields:t},function(t){this.onApplyFilter()}.bind(this),function(t){}.bind(this));this.customFieldsPopup.close()}.bind(this)}}),new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_POPUP_CANCEL"),className:"popup-window-button-decline",events:{click:function(){this.customFieldsPopup.close()}.bind(this)}})]});this.customFieldsPopup.setContent("wait...");this.customFieldsPopup.setTitleBar(BX.message("CRM_KANBAN_CUSTOM_FIELDS"));BX.ajax({method:"GET",dataType:"json",url:"/bitrix/components/bitrix/crm.lead.list/filter.ajax.php"+"?filter_id="+e.gridId+"&siteID="+BX.message("SITE_ID")+"&sessid="+BX.bitrix_sessid(),onsuccess:function(t){var i=[];for(var n=0,a=t.length;n<a;n++){i.push(BX.create("input",{props:{id:"cf_"+t[n].ID,type:"checkbox",name:t[n].NAME,checked:BX.util.in_array(t[n].NAME,e.customFields)},dataset:{label:t[n].LABEL}}));i.push(BX.create("label",{attrs:{for:"cf_"+t[n].ID},text:t[n].LABEL}));i.push(BX.create("br"))}this.customFieldsContainer=BX.create("div",{children:i});this.customFieldsPopup.setContent(this.customFieldsContainer);this.customFieldsPopup.adjustPosition()}.bind(this)})}this.customFieldsPopup.show()}.bind(this)},a.length>0?a[0].id:null)}},onApplyFilterCounter:function(t,e){setTimeout(BX.delegate(function(){var t=this.getData();var i={ASSIGNED_BY_ID:{0:e["userId"]},ASSIGNED_BY_ID_label:[e["userName"]],ACTIVITY_COUNTER:{0:e["counterTypeId"]}};var n=BX.Main.filterManager.getById(t.gridId);var a=n.getApi();a.setFields(i);a.apply()},this),0);e["cancel"]=true},onPartialEditorClose:function(t,e){BX.removeClass(this.itemMoving.item.layout.container,"main-kanban-item-waiting");if(e.isCancelled){return}var i=false;if(e.entityData){var n=this.itemMoving.item.getData();var a=this.itemMoving.newColumn.getId();if(n.required&&n.required[a]){var o=n.required[a];var r=false;var s={};for(var l in n.required_fm){if(e.entityData[l]){n.required_fm[l]=false;s[l]=true}}var d=[];for(var c=0,u=o.length;c<u;c++){var m=o[c];if(s[m]){r=false}else if(e.entityData[m]&&(typeof e.entityData[m]==="object"&&e.entityData[m].IS_EMPTY===false||typeof e.entityData[m]!=="object"&&e.entityData[m]!=="")){r=false}else if(m==="OPPORTUNITY_WITH_CURRENCY"&&parseFloat(e.entityData["OPPORTUNITY"])>0){this.itemMoving.item.setDataKey("runtimePrice",true);r=false}else if(m==="CLIENT"&&(parseInt(e.entityData["CONTACT_ID"])>0||parseInt(e.entityData["COMPANY_ID"])>0)){r=false}else{r=true}if(!r){for(var h in n.required){var g=n.required[h];for(var f=0,p=g.length;f<p;f++){if(g[f]===m){g=BX.util.deleteFromArray(g,f);break}}n.required[h]=g}}else{i=true}}this.itemMoving.item.setDataKey("required",n.required);this.itemMoving.item.setDataKey("required_fm",n.required_fm);if(e.entityData["OPPORTUNITY"]){this.itemMoving.price=parseFloat(e.entityData["OPPORTUNITY"]);this.itemMoving.item.setDataKey("price",this.itemMoving.price);this.itemMoving.item.setDataKey("price_formatted",e.entityData["FORMATTED_OPPORTUNITY_WITH_CURRENCY"])}}}if(this.itemMoving.newColumn instanceof BX.Kanban.DropZone){this.itemMoving.newColumn.captureItem(this.itemMoving.item)}else{this.onItemMoved(this.itemMoving.item,this.itemMoving.newColumn,this.itemMoving.newNextSibling);if(!i){this.moveItem(this.itemMoving.item,this.itemMoving.newColumn,this.itemMoving.newNextSibling)}}},onPullEventHandlerCrm:function(t,e){var i=this.getData();if(t==="activity_add"&&e.COMPLETED!=="Y"&&e.OWNER_TYPE_NAME===i.entityType){var n=this.getItem(e.OWNER_ID);if(n){this.loadNew(n.getId())}}if(t==="notify"){var a=e.originalTag.match(new RegExp("CRM\\|"+i.entityType+"_RESPONSIBLE\\|([\\d]+)"));if(a&&a[1]){this.loadNew(a[1])}if(i.entityType==="INVOICE"&&e.settingName==="crm|invoice_responsible_changed"){var a=e.originalTag.match(new RegExp("CRM\\|"+i.entityType+"\\|([\\d]+)"));if(a&&a[1]){this.loadNew(a[1])}}}},onCrmActivityTodoChecked:function(t,e,i,n){var a=this.getItem(e);if(a){if(n){var o=a.getDataKey("activityErrorTotal");o--;a.setDataKey("activityErrorTotal",o)}var r=a.getDataKey("activityProgress");r--;a.setDataKey("activityProgress",r);a.switchPlanner()}},onSliderClose:function(t){var e=this.getData();var i=e.entityPath;var n=t.slider.getUrl();i=i.replace(/\#([^\#]+)\#/,"([\\d]+)");var a=n.match(new RegExp(i));if(a&&a[1]){this.loadNew(a[1])}},onPopupShow:function(t){if(t.uniquePopupId=="menu-popup-toolbar_lead_list_menu"||t.uniquePopupId=="menu-popup-toolbar_deal_list_menu"){this.addMenuToggleCS(t.uniquePopupId.substr(11))}},setMultiSelectMode:function(){this.multiSelectMode=true;this.setKanbanDragMode()},initActionPanel:function(){var t=this.getData();this.actionPanel=new BX.UI.ActionPanel({renderTo:document.querySelector(".pagetitle-wrap"),removeLeftPosition:true,maxHeight:56,parentPosition:"bottom"});this.actionPanel.draw();this.actionPanel.appendItem({id:"kanban_delete",text:BX.message("CRM_KANBAN_PANEL_DELETE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-delete.svg",onclick:function(){BX.CRM.Kanban.Actions.deleteAll(this)}.bind(this)});if(t.entityType==="LEAD"||t.entityType==="DEAL"){this.actionPanel.appendItem({id:"kanban_ignore",text:BX.message("CRM_KANBAN_PANEL_IGNORE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-ignore.svg",onclick:function(){BX.CRM.Kanban.Actions.ignore(this)}.bind(this)})}if(t.entityType==="LEAD"||t.entityType==="DEAL"||t.entityType==="QUOTE"){var e=[],i=[],n=this.getColumns(),a=this.getDropZoneArea().getDropZones();for(var o=0,r=n.length;o<r;o++){i.push({id:n[o].id,name:n[o].name})}for(var o=0,r=a.length;o<r;o++){var s=a[o].getData();if(t.entityType==="LEAD"&&s.type==="LOOSE"||t.entityType==="DEAL"&&s.type||t.entityType==="QUOTE"&&s.type){i.push({id:a[o].id,name:a[o].name})}}for(var o=0,r=i.length;o<r;o++){e.push({id:"kanban_column_"+i[o].id,column:i[o],text:BX.util.htmlspecialchars(i[o].name),onclick:function(t,e){e.menuWindow.close();BX.CRM.Kanban.Actions.changeColumn(this,e.column)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_column",text:t.entityType==="DEAL"?BX.message("CRM_KANBAN_PANEL_STAGE"):BX.message("CRM_KANBAN_PANEL_STATUS"),items:e,icon:t.entityType==="DEAL"?"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-stage.svg":"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-status.svg"})}if(t.entityType==="DEAL"){var e=[],i=t.categories;for(var o=0,r=i.length;o<r;o++){e.push({id:"kanban_category_"+i[o].ID,category:i[o],text:BX.util.htmlspecialchars(i[o].NAME),onclick:function(t,e){e.menuWindow.close();BX.CRM.Kanban.Actions.changeCategory(this,e.category)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_category",text:BX.message("CRM_KANBAN_PANEL_CATEGORY"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-fulling.svg",items:e})}if(typeof BX.Crm.EntityEditorUserSelector!=="undefined"){this.actionPanel.appendItem({id:"kanban_assigned",text:BX.message("CRM_KANBAN_PANEL_ASSIGNED"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-responsible.svg",onclick:function(t,e){setTimeout(function(){var t=BX.Crm.EntityEditorUserSelector.create("selector_assigned",{callback:function(e,i){BX.CRM.Kanban.Actions.setAssigned(this,i);t.close()}.bind(this)});t.open(e.layout.container)}.bind(this),100)}.bind(this)})}if(t.entityType==="LEAD"||t.entityType==="DEAL"){this.actionPanel.appendItem({id:"kanban_task",text:BX.message("CRM_KANBAN_PANEL_TASK"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-create.svg",onclick:function(){BX.CRM.Kanban.Actions.task(this)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_calllist",text:BX.message("CRM_KANBAN_PANEL_CALLLIST"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-call.svg",onclick:function(){BX.CRM.Kanban.Actions.startCallList(this,false)}.bind(this)})},startActionPanel:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.showPanel()},stopActionPanel:function(){if(!this.actionPanel){return}this.actionPanel.hidePanel()},resetActionPanel:function(){if(this.actionPanel){this.actionPanel.removeItems();this.actionPanel=null}},calculateTotalCheckItems:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.setTotalSelectedItems(this.getChecked().length)},resetSelectItems:function(){var t=this.getItems();for(var e in t){if(t[e].isChecked()){t[e].unSelectItem()}}},onMultiSelectMode:function(){if(BX.hasClass(this.layout.gridContainer,"crm-kanban-multi-select-mode"))return;BX.addClass(this.layout.gridContainer,"crm-kanban-multi-select-mode")},resetMultiSelectMode:function(){if(this.getChecked().length>0)return;BX.removeClass(this.layout.gridContainer,"crm-kanban-multi-select-mode");this.unSetKanbanDragMode()}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:49:"/bitrix/js/crm/kanban/item.min.js?154412740115604";s:6:"source";s:29:"/bitrix/js/crm/kanban/item.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Item=function(t){BX.Kanban.Item.apply(this,arguments);this.container=null;this.timer=null;this.popupTooltip=null;this.plannerCurrent=null};BX.CRM.Kanban.Item.prototype={__proto__:BX.Kanban.Item.prototype,constructor:BX.CRM.Kanban.Item,lastPosition:{columnId:null,targetId:null},checked:false,clipTitle:function(t){var e=t;var a=e.split(" ");var n="<span>"+a[a.length-1]+"</span>";a.splice(a.length-1);e=a.join(" ")+" "+n;return e},setDataKey:function(t,e){var a=this.getData();a[t]=e;this.setData(a)},getDataKey:function(t){var e=this.getData();return e[t]},switchClass:function(t,e,a){if(a){BX.addClass(t,e)}else{BX.removeClass(t,e)}},switchVisible:function(t,e){if(e){t.style.display=""}else{BX.hide(t)}},getLastPosition:function(){return this.lastPosition},setLastPosition:function(){var t=this.getColumn();var e=t.getNextItemSibling(this);this.lastPosition={columnId:t.getId(),targetId:e?e.getId():0}},render:function(){var t=null;var e=this.getData();if(e.special_type==="import"){t=this.getStartLayout();BX.onCustomEvent("Crm.Kanban.Grid:onSpecialItemDraw",[this,t]);this.grid.ccItem=this;return t}if(!this.container){this.createLayout()}var a=this.getColumn();var n=a.getColor();var i=BX.util.hex2rgb(n);var s="rgba("+i.r+","+i.g+","+i.b+","+".7)";BX.style(this.container,"border-left","3px solid "+s);this.link.innerHTML=this.clipTitle(e.name);this.link.setAttribute("href",e.link);if(this.totalPrice){this.totalPrice.innerHTML=e.price_formatted}this.date.textContent=e.date;if(e.contactId&&e.contactName){this.contactName.textContent=BX.util.htmlspecialcharsback(e.contactName);this.contactName.setAttribute("href",e.contactLink);this.switchVisible(this.contactName,true)}else{this.switchVisible(this.contactName,false)}if(this.planner){this.switchPlanner()}var c=["Phone","Email","Im"];for(var r=0,o=c.length;r<o;r++){var l=c[r];var h="crm-kanban-item-contact-"+l.toLowerCase()+"-disabled";BX.unbindAll(this["contact"+l]);if(e[l.toLowerCase()]){BX.bind(this["contact"+l],"click",BX.delegate(this.clickContact,this));this.switchClass(this["contact"+l],h,false)}else{BX.bind(this["contact"+l],"mouseover",BX.delegate(function(){var t=BX.data(BX.proxy_context,"type");this.showTooltip(BX.message("CRM_KANBAN_NO_"+t.toUpperCase()),BX.proxy_context)},this));BX.bind(this["contact"+l],"mouseout",BX.delegate(this.hideTooltip,this));this.switchClass(this["contact"+l],h,true)}}t=this.container;return t},getCloseStartLayout:function(){return BX.create("div",{props:{className:"crm-kanban-item-contact-center-close"},events:{click:function(t){this.grid.toggleCC();t.stopPropagation(t)}.bind(this)}})},getStartLayout:function(){this.getCloseStartLayout();var t=this.getGridData();return BX.create("div",{props:{className:"crm-kanban-item-contact-center"},children:[BX.create("div",{dataset:{url:"contact_center"},props:{className:"crm-kanban-sidepanel"},children:[this.getCloseStartLayout(),BX.create("div",{props:{className:"crm-kanban-item-contact-center-title"},children:[BX.create("div",{props:{className:"crm-kanban-item-contact-center-title-item"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_TITLE")}),BX.create("div",{props:{className:"crm-kanban-item-contact-center-title-item"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_TEXT")})]}),BX.create("div",{props:{className:"crm-kanban-item-contact-center-action"},children:[BX.create("div",{props:{className:"crm-kanban-item-contact-center-action-section"},children:[BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-chat"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_CHAT"),dataset:{url:"ol_chat"}}),BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-crm-forms"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_FORMS"),dataset:{url:"ol_forms"}}),BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-viber"},text:"Viber",dataset:{url:"ol_viber"}})]}),BX.create("div",{props:{className:"crm-kanban-item-contact-center-action-section"},children:[BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-call"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_PHONES"),dataset:{url:"telephony"}}),BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-mail"},text:BX.message("CRM_KANBAN_EMPTY_CARD_CT_EMAIL"),dataset:{url:"email"}}),BX.create("a",{attrs:{href:"#"},props:{className:"crm-kanban-sidepanel crm-kanban-item-contact-center-action-item "+"crm-kanban-item-contact-center-action-item-facebook"},text:"Facebook",dataset:{url:"ol_facebook"}})]})]})]}),t.rights.canImport?BX.create("div",{children:[BX.create("div",{props:{className:"crm-kanban-item-contact-center-title crm-kanban-item-contact-center-title-import"},html:BX.message("CRM_KANBAN_EMPTY_CARD_IMPORT")})]}):null]})},selectItem:function(){this.checked=true;BX.onCustomEvent("BX.CRM.Kanban.Item.select",[this]);BX.addClass(this.checkedButton,"crm-kanban-item-checkbox-checked");BX.addClass(this.container,"crm-kanban-item-selected")},unSelectItem:function(){this.checked=!this.checked;BX.onCustomEvent("BX.CRM.Kanban.Item.unSelect",[this]);BX.removeClass(this.checkedButton,"crm-kanban-item-checkbox-checked");BX.removeClass(this.container,"crm-kanban-item-selected")},createLayout:function(){var t=this.getGridData();this.container=BX.create("div",{props:{className:t.entityType==="INVOICE"||t.entityType==="QUOTE"?"crm-kanban-item crm-kanban-item-invoice":"crm-kanban-item"},events:{click:function(t){if(t.target!==this.container)return;this.checked?this.unSelectItem():this.selectItem()}.bind(this),dblclick:function(){BX.fireEvent(this.link,"click")}.bind(this),mouseleave:function(){this.removeHoverClass(this.container)}.bind(this)}});BX.bind(this.container,"animationend",function(){BX.removeClass(this.layout.container,"main-kanban-item-new")}.bind(this));this.link=BX.create("a",{props:{className:"crm-kanban-item-title"}});this.container.appendChild(this.link);this.repeated=BX.create("div",{props:{className:"crm-kanban-item-repeated"},text:BX.message("CRM_KANBAN_REPEATED_LEAD")});this.options.data.return?this.container.appendChild(this.repeated):null;if(t.entityType!=="LEAD"){this.totalPrice=BX.create("div",{props:{className:"crm-kanban-item-total-price"}});this.total=BX.create("div",{props:{className:"crm-kanban-item-total"},children:[this.totalPrice]});this.container.appendChild(this.total)}this.contactName=BX.create("a",{props:{className:"crm-kanban-item-contact"}});this.container.appendChild(this.contactName);this.date=BX.create("div",{props:{className:"crm-kanban-item-date"}});this.container.appendChild(this.date);this.checkedButton=BX.create("div",{props:{className:"crm-kanban-item-checkbox"},events:{click:function(){this.checked=!this.checked;this.checked?BX.addClass(this.checkedButton,"crm-kanban-item-checkbox-checked"):BX.removeClass(this.checkedButton,"crm-kanban-item-checkbox-checked")}.bind(this)}});this.container.appendChild(this.checkedButton);if(t.showActivity){this.activityExist=BX.create("span",{props:{className:"crm-kanban-item-activity"},events:{click:BX.delegate(this.showCurrentPlan,this)}});this.activityEmpty=BX.create("span",{props:{className:"crm-kanban-item-activity"},events:{click:BX.delegate(function(){this.showTooltip(this.getActivityMessage(t.entityType),BX.proxy_context,true)},this)}});this.activityPlan=BX.create("span",{props:{className:"crm-kanban-item-plan"},text:"+ "+BX.message("CRM_KANBAN_ACTIVITY_TO_PLAN"),events:{click:BX.delegate(this.showPlannerMenu,this)}});this.planner=BX.create("span",{props:{className:"crm-kanban-item-planner"},children:[this.activityEmpty,this.activityExist,this.activityPlan]});this.container.appendChild(this.planner)}this.contactPhone=BX.create("span",{props:{className:"crm-kanban-item-contact-phone crm-kanban-item-contact-phone-disabled"},attrs:{"data-type":"phone"}});this.contactEmail=BX.create("span",{props:{className:"crm-kanban-item-contact-email crm-kanban-item-contact-email-disabled"},attrs:{"data-type":"email"}});this.contactIm=BX.create("span",{props:{className:"crm-kanban-item-contact-im crm-kanban-item-contact-im-disabled"},attrs:{"data-type":"im"}});this.contactBlock=BX.create("div",{props:{className:"crm-kanban-item-connect"},children:[this.contactPhone,this.contactEmail,this.contactIm]});this.container.appendChild(this.contactBlock);this.container.appendChild(this.createShadow())},isChecked:function(){return this.checked},getActivityMessage:function(t){var e=BX.create("span");e.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_CHANGE_"+t);var a=e.querySelector(".crm-kanban-item-activity-link");BX.bind(a,"click",function(){this.showPlannerMenu(this.activityPlan);this.popupTooltip.destroy()}.bind(this));return e},getPreloader:function(){return'<div class="crm-kanban-preloader-wapper">\n\t\t\t\t\t\t\t\t<div class="crm-kanban-preloader">\n\t\t\t\t\t\t\t\t\t<svg class="crm-kanban-circular" viewBox="25 25 50 50">\n\t\t\t\t\t\t\t\t\t\t<circle class="crm-kanban-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/>\n\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>'},loadCurrentPlan:function(){this.getGrid().ajax({action:"activities",entity_id:this.getId()},function(t){this.plannerCurrent.setContent(t);this.plannerCurrent.adjustPosition()}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this),"html")},showCurrentPlan:function(){this.plannerCurrent=BX.PopupWindowManager.create("kanban_planner_current",BX.proxy_context,{closeIcon:false,autoHide:true,className:"crm-kanban-popup-plan",closeByEsc:true,contentColor:"white",angle:true,offsetLeft:15,overlay:{backgroundColor:"transparent",opacity:"0"},events:{onAfterPopupShow:BX.delegate(this.loadCurrentPlan,this),onPopupClose:function(){this.plannerCurrent.destroy();BX.removeClass(this.container,"crm-kanban-item-hover");BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this))}.bind(this)}});this.plannerCurrent.setContent(this.getPreloader());this.plannerCurrent.show();BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this))},clickContact:function(){var t=BX.data(BX.proxy_context,"type");var e=this.getData();var a=e[t];if(typeof a==="undefined"){return}if(Array.isArray(a)&&a.length>1){var n=[];for(var i=0,s=a.length;i<s;i++){n.push({value:a[i]["value"],type:t,text:a[i]["value"]+" ("+a[i]["title"]+")",onclick:BX.proxy(this.clickContactItem,this)})}BX.PopupMenu.show("kanban_contact_menu_"+t+this.getId(),BX.proxy_context,n,{autoHide:true,zIndex:1200,offsetLeft:20,angle:true,closeByEsc:true,events:{onPopupClose:function(){BX.removeClass(this.container,"crm-kanban-item-hover");BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this))}.bind(this)}});BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this))}else{if(!Array.isArray(a)){a=[a]}this.clickContactItem(0,{value:a[0]["value"],type:t})}},clickContactItem:function(t,e){var a=this.getData();if(e.type==="phone"&&typeof BXIM!=="undefined"){BXIM.phoneTo(e.value,{ENTITY_TYPE:a.contactType,ENTITY_ID:a.contactId})}else if(e.type==="im"&&typeof BXIM!=="undefined"){BXIM.openMessengerSlider(e.value,{RECENT:"N",MENU:"N"})}else if(e.type==="email"){var n=BX.CrmActivityEditor&&BX.CrmActivityEditor.items["kanban_activity_editor"];var i=top.BX.Bitrix24&&top.BX.Bitrix24.Slider;if(n&&BX.CrmActivityProvider&&i){var s=this.getGridData();BX.CrmActivityEditor.items["kanban_activity_editor"].addEmail({ownerType:s.entityType,ownerID:a.id,communications:[{type:"EMAIL",value:e.value,entityId:a.id,entityType:s.entityType,entityTitle:a.name}],communicationsLoaded:true})}else{top.location.href="mailto:"+e.value}}},selectPlannerMenu:function(t,e){BX.onCustomEvent("Crm.Kanban:selectPlannerMenu");var a=this.getGridData();if(e.type==="meeting"||e.type==="call"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType[e.type],OWNER_TYPE:a.entityType,OWNER_ID:this.getId()})}else if(e.type==="task"){if(typeof window["taskIFramePopup"]!=="undefined"){var n={UF_CRM_TASK:[BX.CrmOwnerTypeAbbr.resolve(a.entityType)+"_"+this.getId()],TITLE:"CRM: ",TAGS:"crm"};window["taskIFramePopup"].add(n)}}else if(e.type==="visit"){var i=a.visitParams;i.OWNER_TYPE=a.entityType;i.OWNER_ID=this.getId();BX.CrmActivityVisit.create(i).showEdit()}var s=BX.PopupMenu.getCurrentMenu();if(s){s.close()}},getPlannerMenu:function(){var t=this.getGrid().getData();return[{type:"call",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_CALL"),onclick:BX.delegate(this.selectPlannerMenu,this)},{type:"meeting",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_MEETING"),onclick:BX.delegate(this.selectPlannerMenu,this)},t.rights.canUseVisit?{type:"visit",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_VISIT"),onclick:BX.delegate(this.selectPlannerMenu,this)}:null,{type:"task",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_TASK"),onclick:BX.delegate(this.selectPlannerMenu,this)}]},showPlannerMenu:function(t){var e=BX.PopupMenu.create("kanban_planner_menu_"+this.getId(),t.isNode?t:this.activityPlan,this.getPlannerMenu(),{className:"crm-kanban-planner-popup-window",autoHide:true,offsetLeft:50,angle:true,overlay:{backgroundColor:"transparent",opacity:"0"},events:{onPopupClose:function(){BX.removeClass(this.container,"crm-kanban-item-hover");BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this));e.destroy()}.bind(this)}});BX.addCustomEvent(window,"Crm.Kanban:selectPlannerMenu",function(){e.destroy()});e.show();BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this))},switchPlanner:function(){var t=this.getData();var e=this.getColumn();var a=e.getData();if(t.activityProgress>0){this.switchVisible(this.activityExist,true);this.switchVisible(this.activityEmpty,false);this.activityExist.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_MY")+(t.activityErrorTotal&&a.type==="PROGRESS"?" <span>"+t.activityErrorTotal+"</span>":"")}else{var n=this.getGrid().getData();this.switchVisible(this.activityExist,false);this.switchVisible(this.activityPlan,true);this.switchVisible(this.activityEmpty,true);if(n.reckonActivitylessItems&&n.userId==t.assignedBy){this.activityEmpty.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_MY")+(a.type==="PROGRESS"?" <span>1</span>":"")}else{this.activityEmpty.innerHTML=BX.message("CRM_KANBAN_ACTIVITY_MY")}}},showTooltip:function(t,e,a){this.popupTooltip=new BX.PopupWindow("kanban_tooltip",BX.proxy_context,{className:a?"crm-kanban-without-tooltip crm-kanban-without-tooltip-white":"crm-kanban-without-tooltip crm-kanban-tooltip-animate",offsetLeft:14,darkMode:a?false:true,overlay:a?{background:"black",opacity:0}:null,closeByEsc:true,angle:true,autoHide:true,content:t,events:{onPopupClose:function(){BX.unbind(window,"scroll",BX.proxy(this.adjustPopup,this))}.bind(this)}});BX.bind(window,"scroll",BX.proxy(this.adjustPopup,this));this.popupTooltip.show()},hideTooltip:function(){this.popupTooltip.destroy()},createShadow:function(){return BX.create("div",{props:{className:"crm-kanban-item-shadow"}})},removeHoverClass:function(t){BX.removeClass(t,"crm-kanban-item-event");BX.removeClass(t,"crm-kanban-item-hover")},adjustPopup:function(){var t=BX.PopupWindowManager.getCurrentPopup();if(!t){if(e){var e=BX.PopupMenu.getCurrentMenu();t=e.getPopupWindow()}}if(t){t.adjustPosition()}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:51:"/bitrix/js/crm/kanban/column.min.js?154412740110448";s:6:"source";s:31:"/bitrix/js/crm/kanban/column.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Column=function(t){BX.Kanban.Column.apply(this,arguments)};BX.CRM.Kanban.Column.prototype={__proto__:BX.Kanban.Column.prototype,constructor:BX.CRM.Kanban.Column,renderSubtitleTime:6,subtitleNode:null,pathToAdd:null,editorNodeTransition:200,editorNodeWaiting:null,editorNodeIsBlock:null,editorNodeIsVissible:false,editorNode:null,editorNodeContainer:null,editorNodeCreate:null,editorLoaded:false,quickFormSaveButton:null,quickFormCancelButton:null,editorId:null,editor:null,loader:null,currencyFormat:function(t,i,e){var o="",n;if(typeof BX.Currency==="undefined"){return t}e=!!e;n=BX.Currency.getCurrencyFormat(i);if(!!n&&typeof n==="object"){n.CURRENT_DECIMALS=n.DECIMALS;n.HIDE_ZERO="Y";if(n.HIDE_ZERO==="Y"&&t==parseInt(t,10)){n.CURRENT_DECIMALS=0}o=BX.util.number_format(t,n.CURRENT_DECIMALS,n.DEC_POINT,n.THOUSANDS_SEP);if(e){o=n.FORMAT_STRING.replace(/(^|[^&])#/,"$1"+o)}}return o},decPrice:function(t){var i=this.getData();i.sum=parseFloat(i.sum)-t;this.setData(i)},incPrice:function(t){var i=this.getData();i.sum=parseFloat(i.sum)+t;this.setData(i)},getAddColumnButton:function(){var t=this.getData();if(t.type==="WIN"){this.layout.info.style.marginRight="0";return BX.create("div")}else{return BX.Kanban.Column.prototype.getAddColumnButton.apply(this,arguments)}},getAddPath:function(){if(this.pathToAdd!==null){return this.pathToAdd}var t=this.getGridData();var i=t.entityType.toLowerCase();var e,o;if(i==="invoice"){e="crm_invoice_toolbar"}else{e="toolbar_"+i+"_list"}if(BX(e)){o=BX(e).querySelector("a");this.pathToAdd=o.getAttribute("href");this.pathToAdd+=this.pathToAdd.indexOf("?")===-1?"?":"&"}return this.pathToAdd},processQuickEditor:function(){this.editor.save();this.getLoader().show();BX.addClass(this.quickFormSaveButton,"ui-btn-wait");this.resetQuickEditor()},resetQuickEditor:function(){this.editorNodeContainer.style.height=this.editorNodeContainer.offsetHeight+"px";this.editorNodeContainer.innerHTML=""},showQuickEditor:function(t){if(t!==true){this.animateShowQuickEditor();this.getLoader().show()}var i=this.getGridData();var e=i.entityType;this.editorId="quick_editor_"+this.getId()+"_"+e.toLowerCase();if(typeof i.quickEditorPath[e.toLowerCase()]==="undefined"){return}var o={PARAMS:i.params};o[e==="DEAL"?"STAGE_ID":"STATUS_ID"]=this.getId();if(!this.editorNodeContainer.innerHTML){BX.ajax.post(i.quickEditorPath[e.toLowerCase()],{ACTION:"PREPARE_EDITOR_HTML",ACTION_ENTITY_TYPE_NAME:e,ACTION_ENTITY_ID:0,GUID:this.editorId,IS_EMBEDDED:"Y",ENABLE_REQUIRED_USER_FIELD_CHECK:"N",FIELDS:e==="DEAL"?["TITLE","OPPORTUNITY_WITH_CURRENCY","CLIENT"]:["TITLE","CLIENT"],CONTEXT:o},function(i){this.editorNodeContainer.innerHTML=i;this.editorNodeContainer.appendChild(this.editorNodeCreate);if(t){return}BX.removeClass(this.quickFormSaveButton,"ui-btn-wait");this.getLoader().hide();this.animateShowQuickEditor();this.editorNodeWaiting=setTimeout(function(){this.setHeightAuto()}.bind(this),this.editorNodeTransition)}.bind(this))}else{this.getLoader().hide();this.animateShowQuickEditor();BX.removeClass(this.quickFormSaveButton,"ui-btn-wait");setTimeout(function(){this.setHeightAuto()}.bind(this),this.editorNodeTransition)}if(!this.editorLoaded){BX.addCustomEvent(window,"BX.Crm.EntityEditor:onInit",function(t,i){if(t.getId()===this.editorId){this.editor=t}}.bind(this));BX.addCustomEvent(window,"onCrmEntityCreate",function(t){var i=t.sender.getContext();var o=e==="DEAL"?"STAGE_ID":"STATUS_ID";if(i[o]===this.getId()){this.getGrid().loadNew(t.entityId,true)}}.bind(this));BX.bind(window,"keydown",function(t){if(!this.editorNodeIsVissible){return}if(t.key==="Enter"&&this.editorNodeIsVissible){this.processQuickEditor();return}if(t.key==="Escape"&&!this.editorNodeIsBlock){this.hideQuickFormEditor();this.enabledAddButton()}}.bind(this));BX.bind(window,"click",function(t){if(this.isQuickFormPopup(t.target)||this.isQuickFormEditor(t.target)){return}this.hideQuickFormEditor();this.enabledAddButton()}.bind(this));BX.addCustomEvent(window,"BX.CRM.Kanban.Item.select",this.hideQuickFormEditor.bind(this));BX.addCustomEvent(window,"BX.CRM.Kanban.Item.select",this.enabledAddButton.bind(this));BX.addCustomEvent(window,"Kanban.Column:render",this.hideQuickFormEditor.bind(this));BX.addCustomEvent(window,"Kanban.Column:render",this.enabledAddButton.bind(this));BX.addCustomEvent(window,"Kanban.Grid:onItemDragStart",this.hideQuickFormEditor.bind(this));BX.addCustomEvent(window,"Kanban.Grid:onItemDragStart",this.enabledAddButton.bind(this))}this.editorLoaded=true;this.layout.items.insertBefore(this.editorNode,this.layout.items.firstChild)},hideQuickFormEditor:function(){BX.removeClass(this.editorNode,"crm-kanban-quick-form-show");this.editorNode.style.opacity="0";this.editorNode.style.height=this.editorNode.offsetHeight+"px";this.editorNode.style.marginBottom="0";setTimeout(function(){this.editorNode.style.height="0"}.bind(this));this.editorNodeIsBlock=true;setTimeout(function(){this.editorNodeIsBlock=false;this.editorNodeIsVissible=false}.bind(this),this.editorNodeTransition*2)},removeQuickFormEditor:function(){this.editorNode.parentNode.removeChild(this.editorNode)},disabledAddButton:function(t){BX.addClass(t,"crm-kanban-column-add-item-button-event")},enabledAddButton:function(){BX.removeClass(this.layout.subTitleAddButton,"crm-kanban-column-add-item-button-event")},animateShowQuickEditor:function(){BX.addClass(this.editorNode,"crm-kanban-quick-form-show");this.editorNode.style.opacity="1";this.editorNode.style.height="0px";this.editorNode.style.marginBottom="6px";setTimeout(function(){this.editorNode.style.height=this.getGridData().encodingType==="DEAL"?"358px":"285px"}.bind(this));this.editorNodeIsBlock=true;setTimeout(function(){this.editorNodeIsBlock=false;this.editorNodeIsVissible=true}.bind(this),this.editorNodeTransition*2)},setHeightAuto:function(){this.editorNode.style.height="auto"},isShowFormButton:function(t){var i=BX.findParent(t,{className:"crm-kanban-column-add-item-button"});return i===this.editorNode},isQuickFormPopup:function(t){return BX.findParent(t,{className:"popup-window"})},isQuickFormEditor:function(t){return BX.findParent(t,{className:"crm-kanban-quick-form"})},renderSubTitle:function(){var t=this.getData();var i=this.getGridData();if(i.entityType!=="LEAD"){if(!this.layout.subTitlePrice){this.layout.subTitlePriceText=BX.create("span",{attrs:{className:"crm-kanban-total-price-total"}});this.layout.subTitlePrice=BX.create("div",{attrs:{className:"crm-kanban-total-price"},children:[this.layout.subTitlePriceText]})}}else{this.layout.subTitlePrice=null}if(this.layout.subTitlePriceText){t.sum=parseFloat(t.sum);t.sum_old=t.sum_old?t.sum_old:t.sum_init;t.sum_init=t.sum;this.renderSubTitleAnimation(t.sum_old,t.sum,Math.abs(t.sum_old-t.sum)/20,this.layout.subTitlePriceText,function(e,o){e.innerHTML=this.currencyFormat(Math.round(o),i.currency,true);t.sum_old=t.sum}.bind(this));this.setData(t)}if(this.subtitleNode){return this.subtitleNode}var e="",o=true,n=false;if(t.sort===100&&(i.entityType==="LEAD"||i.entityType==="DEAL")){n=true;e=BX.message("CRM_KANBAN_PLUS_TITLE_"+i.entityType)}if(o){this.editorNode=BX.create("div",{props:{className:"crm-kanban-quick-form"},style:{transition:this.editorNodeTransition+"ms"},children:[this.editorNodeContainer=BX.create("div",{props:{className:"crm-kanban-quick-form-container"},style:{animationDelay:this.editorNodeTransition+"ms"}})]});BX.addCustomEvent(window,"CRM.Kanban.Column:clickAddButton",function(){this.hideQuickFormEditor();this.enabledAddButton()}.bind(this));this.editorNodeCreate=BX.create("div",{props:{className:"crm-kanban-qiuck-form-buttons"},children:[this.quickFormSaveButton=BX.create("input",{attrs:{type:"button",value:BX.message("CRM_KANBAN_POPUP_SAVE"),className:"ui-btn ui-btn-sm ui-btn-primary"},events:{click:function(t){this.processQuickEditor();BX.PreventDefault(t)}.bind(this)}}),this.quickFormCancelButton=BX.create("input",{attrs:{type:"button",value:BX.message("CRM_KANBAN_CONFIRM_N"),className:"ui-btn ui-btn-sm ui-btn-link"},events:{click:function(){this.enabledAddButton();this.hideQuickFormEditor()}.bind(this)}})]})}if(i.entityType==="LEAD"||i.entityType==="DEAL"){this.layout.subTitleAddButton=BX.create("div",{text:e,attrs:{className:"crm-kanban-column-add-item-button"},events:{click:o?function(t){if(document.getElementsByTagName("html")[0].classList.contains("bx-ie")){BX.SidePanel.Instance.open("/crm/lead/details/0/");return}if(BX.hasClass(this.layout.subTitleAddButton,"crm-kanban-column-add-item-button-event")||this.editorNodeIsVissible){BX.PreventDefault(t);return}BX.onCustomEvent(this,"CRM.Kanban.Column:clickAddButton");this.disabledAddButton(t.target);this.showQuickEditor();BX.PreventDefault(t)}.bind(this):null}})}else{this.layout.subTitleAddButton=this.getAddPath()?BX.create("a",{text:e,attrs:{className:"crm-kanban-column-add-item-button",href:this.getAddPath()+(i.entityType==="DEAL"?"stage_id=":"status_id=")+this.getId()}}):null}this.subtitleNode=BX.create("div",{children:[this.layout.subTitlePrice,o?this.layout.subTitleAddButton:this.getAddPath()?BX.create("a",{text:e,attrs:{className:"crm-kanban-column-add-item-button",href:this.getAddPath()+(i.entityType==="DEAL"?"stage_id=":"status_id=")+this.getId()}}):null,this.editorNode]});if(n){setTimeout(function(){this.showQuickEditor(true)}.bind(this))}return this.subtitleNode},getLoader:function(){if(!this.loader){this.loader=new BX.Loader({target:this.editorNode})}return this.loader},renderSubTitleAnimation:function(t,i,e,o,n){var s=+t;var d=parseFloat(i);var r=this.renderSubtitleTime;if(s<d){(function(){if(s<=d){setTimeout(arguments.callee,r);o.textContent=BX.util.number_format(s,0,","," ");s=s+e}else{if(typeof n==="function"){n(o,i)}}})()}else if(s>d){(function(){if(s>=d){setTimeout(arguments.callee,r);o.textContent=BX.util.number_format(s,0,","," ");s=s-e}else{if(typeof n==="function"){n(o,i)}}})()}else if(typeof n==="function"){n(o,i)}},handleAddColumnButtonClick:function(t){var i=this.getGridData();if(i.rights&&i.rights.canAddColumn){BX.Kanban.Column.prototype.handleAddColumnButtonClick.apply(this,arguments)}else if(typeof BX.Intranet!=="undefined"){this.getGrid().accessNotify()}},switchToEditMode:function(){var t=this.getGridData();if(t.rights&&t.rights.canAddColumn){BX.Kanban.Column.prototype.switchToEditMode.apply(this,arguments)}else if(typeof BX.Intranet!=="undefined"){this.getGrid().accessNotify()}}}})();
/* End */
;