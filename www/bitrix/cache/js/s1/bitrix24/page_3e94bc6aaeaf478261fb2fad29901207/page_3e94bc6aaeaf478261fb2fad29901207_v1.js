
; /* Start:"a:4:{s:4:"full";s:97:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?154412738440309";s:6:"source";s:77:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Main");if(typeof BX.Main.interfaceButtons==="undefined"){BX.Main.interfaceButtons=function(t,e){this.classItem="main-buttons-item";this.classItemSublink="main-buttons-item-sublink";this.classItemText="main-buttons-item-text";this.classItemCounter="main-buttons-item-counter";this.classItemIcon="main-buttons-item-icon";this.classItemMore="main-buttons-item-more";this.classOnDrag="main-buttons-drag";this.classDropzone="main-buttons-submenu-dropzone";this.classSeporator="main-buttons-submenu-separator";this.classHiddenLabel="main-buttons-hidden-label";this.classSubmenuItem="main-buttons-submenu-item";this.classItemDisabled="main-buttons-disabled";this.classItemOver="over";this.classItemActive="main-buttons-item-active";this.classSubmenu="main-buttons-submenu";this.classSecret="secret";this.classItemLocked="locked";this.submenuIdPrefix="main_buttons_popup_";this.childMenuIdPrefix="main_buttons_popup_child_";this.submenuWindowIdPrefix="menu-popup-";this.classSettingMenuItem="main-buttons-submenu-setting";this.classEditState="main-buttons-edit";this.classEditItemButton="main-buttons-item-edit-button";this.classDragItemButton="main-buttons-item-drag-button";this.classSettingsApplyButton="main-buttons-submenu-settings-apply";this.classSettingsResetButton="main-buttons-submenu-settings-reset";this.classSetHome="main-buttons-set-home";this.classSetHide="main-buttons-set-hide";this.classManage="main-buttons-manage";this.classContainer="main-buttons";this.classSubmenuNoHiddenItem="main-buttons-submenu-item-no-hidden";this.classDefaultSubmenuItem="menu-popup-item";this.classInner="main-buttons-inner-container";this.listContainer=null;this.pinContainer=null;this.dragItem=null;this.overItem=null;this.moreButton=null;this.messages=null;this.licenseParams=null;this.isSubmenuShown=false;this.isSubmenuShownOnDragStart=false;this.isSettingsEnabled=true;this.containerId=e.containerId;this.tmp={};this.init(t,e);return{getItemById:BX.delegate(this.getItemById,this),getAllItems:BX.delegate(this.getAllItems,this),getHiddenItems:BX.delegate(this.getHiddenItems,this),getVisibleItems:BX.delegate(this.getVisibleItems,this),getDisabledItems:BX.delegate(this.getDisabledItems,this),getMoreButton:BX.delegate(this.getMoreButton,this),adjustMoreButtonPosition:BX.delegate(this.adjustMoreButtonPosition,this),showSubmenu:BX.delegate(this.showSubmenu,this),closeSubmenu:BX.delegate(this.closeSubmenu,this),refreshSubmenu:BX.delegate(this.refreshSubmenu,this),getCurrentSettings:BX.delegate(this.getCurrentSettings,this),saveSettings:BX.delegate(this.saveSettings,this),setCounterValueByItemId:BX.delegate(this.setCounterValueByItemId,this),getCounterValueByItemId:BX.delegate(this.getCounterValueByItemId,this),updateCounter:BX.delegate(this.updateCounter,this),getActive:BX.delegate(this.getActive,this),isEditEnabled:BX.delegate(this.isEditEnabled,this),isActiveInMoreMenu:BX.delegate(this.isActiveInMoreMenu,this),isSettingsEnabled:this.isSettingsEnabled,classes:{item:this.classItem,itemText:this.classItemText,itemCounter:this.classItemCounter,itemIcon:this.classItemIcon,itemDisabled:this.classItemDisabled,itemOver:this.classItemOver,itemActive:this.classItemActive,itemLocked:this.classItemLocked,submenu:this.classSubmenu,submenuItem:this.classSubmenuItem,containerOnDrag:this.classOnDrag,classSettingMenuItem:this.classSettingMenuItem},itemsContainer:this.listContainer,itemsContainerId:this.listContainer.id}};BX.Main.interfaceButtons.prototype={init:function(t,e){this.listContainer=BX(this.getId());if(!BX.type.isPlainObject(e)){throw"BX.MainButtons: params is not Object"}if(!("containerId"in e)||!BX.type.isNotEmptyString(e.containerId)){throw"BX.MainButtons: containerId not set in params"}if(!BX.type.isDomNode(this.listContainer)){throw"BX.MainButtons: #"+e.containerId+" is not dom node"}if("classes"in e&&BX.type.isPlainObject(e.classes)){this.setCustomClasses(e.classes)}if("messages"in e&&BX.type.isPlainObject(e.messages)){this.setMessages(e.messages)}if("licenseWindow"in e&&BX.type.isPlainObject(e.licenseWindow)){this.setLicenseWindowParams(e.licenseWindow)}if("disableSettings"in e&&e.disableSettings==="true"){this.isSettingsEnabled=false;this.visibleControlMoreButton()}this.moreButton=this.getMoreButton();this.listChildItems={};if(this.isSettingsEnabled){this.dragAndDropInit()}this.adjustMoreButtonPosition();this.bindOnClickOnMoreButton();this.bindOnScrollWindow();this.setContainerHeight();BX.bind(this.getContainer(),"click",BX.delegate(this._onDocumentClick,this));BX.addCustomEvent("onPullEvent-main",BX.delegate(this._onPush,this));this.updateMoreButtonCounter();if(this.isActiveInMoreMenu()){this.activateItem(this.moreButton)}var i=this.getVisibleItems();var s=BX.type.isArray(i)&&i.length>0?i[0]:null;var n=BX.Buttons.Utils.getByTag(s,"a");if(!BX.type.isDomNode(n)){return}var a=n.getAttribute("href");if(a.charAt(0)==="?"){a=n.pathname+n.search}if(!this.lastHomeLink){this.lastHomeLink=a}this.bindOnResizeFrame()},_onDocumentClick:function(t){var e=this.getItem(t);var i,s,n,a,o,u;if(this.isDragButton(t.target)){t.preventDefault();t.stopPropagation()}if(BX.type.isDomNode(e)){if(this.isSettings(e)){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton());return false}if(this.isApplySettingsButton(e)){t.preventDefault();t.stopPropagation();this.disableEdit();BX.show(this.getSettingsButton());BX.hide(this.getSettingsApplyButton());return false}if(this.isResetSettingsButton(e)){this.resetSettings();return false}if(this.isLocked(e)){t.preventDefault();this.showLicenseWindow();return false}if(this.isEditButton(t.target)){var r,h;t.preventDefault();t.stopPropagation();if(this.isSubmenuItem(e)){e=this.getItemAlias(e)}try{r=JSON.parse(BX.data(e,"item"))}catch(t){}h=this.getItemEditMenu();if(h&&h.popupWindow.isShown()&&this.lastEditNode===e){h.popupWindow.close()}else{this.showItemEditMenu(r,t.target)}this.lastEditNode=e;return false}if(this.isSetHide(e)){o=this.getVisibleItems();u=BX.type.isArray(o)?o.length:null;a=this.editItemData.ID.replace(this.listContainer.id+"_","");s=this.getItemById(a);n=this.getItemAlias(s);s=this.isVisibleItem(s)?s:n;if(this.isDisabled(n)){this.enableItem(n)}else if(!this.isDisabled(n)&&u>2){this.disableItem(n)}if(u===2){BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[s,this])}this.refreshSubmenu();this.saveSettings();this.adjustMoreButtonPosition();if(this.isEditEnabled()){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton())}this.editMenu.popupWindow.close();return false}if(this.isSetHome(e)){a=this.editItemData.ID.replace(this.listContainer.id+"_","");s=this.getItemById(a);n=this.getItemAlias(s);if(this.isDisabled(n)){this.enableItem(n)}this.listContainer.insertBefore(s,BX.firstChild(this.listContainer));this.adjustMoreButtonPosition();this.refreshSubmenu();this.saveSettings();if(this.isEditEnabled()){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton())}this.editMenu.popupWindow.close();return false}if(!this.isSublink(t.target)){i=this.dataValue(e,"onclick");if(BX.type.isNotEmptyString(i)){t.preventDefault();this.execScript(i)}}}if(this.isEditEnabled()){this.getSubmenu().popupWindow.setAutoHide(false)}},isActiveInMoreMenu:function(){var t=this.getHiddenItems();var e=this.getDisabledItems();var i=t.concat(e);return i.some(function(t){var e;try{e=JSON.parse(BX.data(t,"item"))}catch(t){}return BX.type.isPlainObject(e)&&("IS_ACTIVE"in e&&e.IS_ACTIVE===true||e.IS_ACTIVE==="true"||e.IS_ACTIVE==="Y")},this)},_onPush:function(t,e){if(t==="user_counter"&&e&&BX.message("SITE_ID")in e){var i=e[BX.message("SITE_ID")];for(var s in i){if(i.hasOwnProperty(s)){this.updateCounter(s,i[s])}}}},bindOnScrollWindow:function(){BX.bind(window,"scroll",BX.delegate(this._onScroll,this))},getActive:function(){var t=this.getAllItems();var e,i;var s=null;if(BX.type.isArray(t)){t.forEach(function(t){try{e=JSON.parse(BX.data(t,"item"))}catch(t){e=null}if(BX.type.isPlainObject(e)&&"IS_ACTIVE"in e&&(e.IS_ACTIVE===true||e.IS_ACTIVE==="true"||e.IS_ACTIVE==="Y")){s=e}},this)}if(BX.type.isPlainObject(s)){i=BX(s.ID);if(BX.type.isDomNode(i)){s.NODE=i}else{s.NODE=null}}return s},isSetHome:function(t){return BX.hasClass(t,this.classSetHome)},isSetHide:function(t){return BX.hasClass(t,this.classSetHide)},getSettingsButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingMenuItem)},getSettingsApplyButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingsApplyButton)},isApplySettingsButton:function(t){return BX.hasClass(t,this.classSettingsApplyButton)},enableEdit:function(){var t=this.getSubmenu();if(t&&"popupWindow"in t){t.popupWindow.setAutoHide(false)}BX.addClass(this.listContainer,this.classEditState);BX.addClass(this.getSubmenuContainer(),this.classEditState);this.isEditEnabledState=true},disableEdit:function(){var t=this.getSubmenu();if(t&&"popupWindow"in t){t.popupWindow.setAutoHide(true)}BX.removeClass(this.listContainer,this.classEditState);BX.removeClass(this.getSubmenuContainer(),this.classEditState);this.isEditEnabledState=false},isEditEnabled:function(){return this.isEditEnabledState},showItemEditMenu:function(t,e){if(BX.type.isPlainObject(t)&&"ID"in t){var i=[this.listContainer.id,"_edit_item"].join("");var s=BX.PopupMenu.getMenuById(i);if(s){BX.PopupMenu.destroy(i)}s=this.createItemEditMenu(t,i,e);s.popupWindow.show()}},getContainer:function(){if(!BX.type.isDomNode(this.container)){this.container=BX(this.containerId).parentNode}return this.container},getItemEditMenu:function(){return BX.PopupMenu.getMenuById([this.listContainer.id,"_edit_item"].join(""))},createItemEditMenu:function(t,e,i){var s;var n=[{text:this.message("MIB_SET_HOME"),className:"main-buttons-set-home menu-popup-no-icon"}];var a=t.ID.replace(this.listContainer.id+"_","");var o=this.getItemById(a);if(this.isDisabled(o)){n.push({text:this.message("MIB_SET_SHOW"),className:"main-buttons-set-hide menu-popup-no-icon"})}else{n.push({text:this.message("MIB_SET_HIDE"),className:"main-buttons-set-hide menu-popup-no-icon"})}var u=BX.pos(i);var r={menuId:e,anchor:i,menuItems:n,settings:{autoHide:true,offsetTop:0,offsetLeft:u.width/2,zIndex:20,angle:{position:"top",offset:u.width/2}}};s=BX.PopupMenu.create(r.menuId,r.anchor,r.menuItems,r.settings);if(this.isVisibleItem(o)){t.NODE=o}else{t.NODE=this.getItemAlias(o)}this.editItemData=t;if("menuItems"in s&&BX.type.isArray(s.menuItems)){s.menuItems.forEach(function(t){BX.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))},this)}BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onBeforeCreateEditMenu",[s,t,this]);this.editMenu=s;return s},setHome:function(){var t=this.getVisibleItems();var e=BX.type.isArray(t)&&t.length>0?t[0]:null;var i=BX.Buttons.Utils.getByTag(e,"a");if(!BX.type.isDomNode(i)){return}var s=i.getAttribute("href");if(s.charAt(0)==="?"){s=i.pathname+i.search}if(!this.lastHomeLink){this.lastHomeLink=s}if(this.lastHomeLink!==s){BX.userOptions.save("ui",this.listContainer.id,"firstPageLink",s);BX.onCustomEvent("BX.Main.InterfaceButtons:onFirstItemChange",[s,e])}this.lastHomeLink=s},isEditButton:function(t){return BX.hasClass(t,this.classEditItemButton)},isDragButton:function(t){return BX.hasClass(t,this.classDragItemButton)},isResetSettingsButton:function(t){return BX.hasClass(t,this.classSettingsResetButton)},getContainerHeight:function(){var t=this.getAllItems().map(function(t){var e=getComputedStyle(t);return BX.height(t)+parseInt(e.marginTop)+parseInt(e.marginBottom)});return Math.max.apply(Math,t)},setContainerHeight:function(){var t=this.getContainerHeight();var e=8;BX.height(this.listContainer,t-e)},setLicenseWindowParams:function(t){this.licenseParams=t||{}},message:function(t){var e;try{e=this.messages[t]}catch(t){e=""}return e},setCustomClasses:function(t){if(!BX.type.isPlainObject(t)){return}this.classItem=t.item||this.classItem;this.classItemSublink=t.itemSublink||this.classItemSublink;this.classItemText=t.itemText||this.classItemText;this.classItemCounter=t.itemCounter||this.classItemCounter;this.classItemIcon=t.itemIcon||this.classItemIcon;this.classItemMore=t.itemMore||this.classItemMore;this.classItemOver=t.itemOver||this.classItemOver;this.classItemActive=t.itemActive||this.classItemActive;this.classItemDisabled=t.itemDisabled||this.classItemDisabled;this.classOnDrag=t.onDrag||this.classOnDrag;this.classDropzone=t.dropzone||this.classDropzone;this.classSeporator=t.separator||this.classSeporator;this.classSubmenuItem=t.submenuItem||this.classSubmenuItem;this.classSubmenu=t.submenu||this.classSubmenu;this.classSecret=t.secret||this.classSecret;this.classItemLocked=t.itemLocked||this.classItemLocked},setMessages:function(t){if(!BX.type.isPlainObject(t)){return}this.messages=t},makeFullItemId:function(t){if(!BX.type.isNotEmptyString(t)){return}return[this.listContainer.id,t.replace("-","_")].join("_")},getItemById:function(t){var e=null;var i;if(BX.type.isNotEmptyString(t)){i=this.makeFullItemId(t);e=BX.Buttons.Utils.getBySelector(this.listContainer,"#"+i)}return e},getItemCounterObject:function(t){var e=null;if(BX.type.isDomNode(t)){e=BX.Buttons.Utils.getByClass(t,this.classItemCounter)}return e},setCounterValue:function(t,e){var i=this.getItemCounterObject(t);if(BX.type.isDomNode(i)){i.innerText=e>99?"99+":e>0?e:"";t.dataset.counter=e}this.updateMoreButtonCounter()},updateCounter:function(t,e){if(t.indexOf("crm")===0&&e<0){return}var i,s,n;var a=null;var o=this.getAllItems();if(BX.type.isArray(o)){o.forEach(function(e){try{s=JSON.parse(BX.data(e,"item"))}catch(t){s={}}if(BX.type.isPlainObject(s)&&"COUNTER_ID"in s&&s.COUNTER_ID===t){a=e}},this)}i=this.getItemCounterObject(a);if(BX.type.isDomNode(i)){a=this.getItem(i);i.innerText=e>99?"99+":e>0?e:"";a.dataset.counter=e}n=this.getItemAlias(a);if(BX.type.isDomNode(n)){i=this.getItemCounterObject(n);if(BX.type.isDomNode(i)){i.innerText=e>99?"99+":e>0?e:"";n.dataset.counter=e}}this.updateMoreButtonCounter()},setCounterValueByItemId:function(t,e){var i=e!==null?parseFloat(e):null;var s,n;if(!BX.type.isNotEmptyString(t)){throw"Bad first arg. Need string as item id"}if(i!==null&&!BX.type.isNumber(i)){throw"Bad two arg. Need number counter value - Integer, Float or string with number"}s=this.getItemById(t);if(!BX.type.isDomNode(s)){console.info("Not found node with id #"+t);return}n=this.getItemAlias(s);this.setCounterValue(s,i);this.setCounterValue(n,i)},getCounterValueByItemId:function(t){var e,i;var s=NaN;if(!BX.type.isNotEmptyString(t)){throw"Bad first arg. Need string item id"}else{e=this.getItemById(t);s=this.dataValue(e,"counter");s=parseFloat(s);if(!BX.type.isNumber(s)){i=this.getItemCounterObject(e);s=parseFloat(i.innerText)}}return s},setMoreButtonCounter:function(t){var e=this.getItemCounterObject(this.moreButton);var i=t>99?"99+":t>0?t:"";i=parseInt(i);i=BX.type.isNumber(i)?i:"";e.innerText=i},bindOnClickOnMoreButton:function(){BX.bind(this.moreButton,"click",BX.delegate(this._onClickMoreButton,this))},bindOnResizeFrame:function(){window.frames["maininterfacebuttonstmpframe-"+this.getId()].onresize=BX.throttle(this._onResizeHandler,20,this)},getId:function(){return BX.Buttons.Utils.getByClass(this.getContainer(),this.classInner).id},getAllItems:function(){return BX.Buttons.Utils.getByClass(this.listContainer,this.classItem,true)},getVisibleItems:function(){var t=this.getAllItems();var e=this;var i=[];if(t&&t.length){i=t.filter(function(t){return e.isVisibleItem(t)&&!e.isDisabled(t)})}return i},getHiddenItems:function(){var t=this.getAllItems();var e=[];var i=this;if(t&&t.length){e=t.filter(function(t){return!i.isVisibleItem(t)&&!i.isDisabled(t)})}return e},getDisabledItems:function(){return this.getAllItems().filter(function(t){return this.isDisabled(t)},this)},getMoreButton:function(){var t=null;this.getAllItems().forEach(function(e){!t&&BX.hasClass(e,this.classItemMore)&&(t=e)},this);return t},getLastVisibleItem:function(){var t=this.getVisibleItems();var e=null;if(BX.type.isArray(t)&&t.length){e=t[t.length-1]}if(!BX.type.isDomNode(e)){e=null}return e},adjustMoreButtonPosition:function(){var t=this.getLastVisibleItem();var e=this.isMoreButton(t);if(!e){this.listContainer.insertBefore(this.moreButton,t)}this.updateMoreButtonCounter()},getSubmenuId:function(t){var e="";if(BX.type.isDomNode(this.listContainer)&&BX.type.isNotEmptyString(this.listContainer.id)){e=this.submenuIdPrefix+this.listContainer.id}if(t){e=this.submenuWindowIdPrefix+e}return e},getChildMenuId:function(){var t="";if(BX.type.isDomNode(this.listContainer)&&BX.type.isNotEmptyString(this.listContainer.id)){t=this.childMenuIdPrefix+this.listContainer.id}return t},getSubmenuItemText:function(t){var e,i,s;if(!BX.type.isDomNode(t)){return null}e=this.findChildrenByClassName(t,this.classItemText);i=this.findChildrenByClassName(t,this.classItemCounter);if(BX.type.isDomNode(i)&&BX.type.isDomNode(e)){i.dataset.counter=this.dataValue(t,"counter");s=e.outerHTML+i.outerHTML}else{e=this.dataValue(t,"text");i=this.dataValue(t,"counter");s=e}return s},getChildMenuItemText:function(t){var e,i,s;if(!BX.type.isDomNode(t)){return null}e=this.findChildrenByClassName(t,this.classItemText);i=this.findChildrenByClassName(t,this.classItemCounter);if(BX.type.isDomNode(i)&&BX.type.isDomNode(e)){i.dataset.counter=this.dataValue(t,"counter");s=e.outerHTML+i.outerHTML}else{e=this.dataValue(t,"text");s=e}return s},getLockedClass:function(t){var e="";if(BX.type.isDomNode(t)&&this.isLocked(t)){e=this.classItemLocked}return e},getSubmenuItems:function(){var t=this.getAllItems();var e=this.getHiddenItems();var i=this.getDisabledItems();var s=[];var n,a;if(t.length){t.forEach(function(t){if(e.indexOf(t)===-1&&i.indexOf(t)===-1){s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:[this.classSubmenuItem,this.getIconClass(t),this.classSecret,this.getAliasLink(t),this.getLockedClass(t)].join(" ")})}},this)}if(e.length){e.forEach(function(t){try{n=JSON.parse(this.dataValue(t,"item"))}catch(t){n=null}a=[this.classSubmenuItem,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(BX.type.isPlainObject(n)&&("IS_ACTIVE"in n&&n.IS_ACTIVE===true||n.IS_ACTIVE==="true"||n.IS_ACTIVE==="Y")){a.push(this.classItemActive)}s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:a.join(" "),items:this.getChildMenuItems(t)})},this)}if(this.isSettingsEnabled){s.push({text:"<span>"+this.message("MIB_HIDDEN")+"</span>",className:[this.classSeporator,this.classSubmenuItem,this.classHiddenLabel].join(" ")});if(!i.length){s.push({text:"<span>"+this.message("MIB_NO_HIDDEN")+"</span>",className:[this.classSubmenuItem,this.classSubmenuNoHiddenItem].join(" ")})}if(i.length){i.forEach(function(t){try{n=JSON.parse(this.dataValue(t,"item"))}catch(t){n=null}a=[this.classSubmenuItem,this.classItemDisabled,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(BX.type.isPlainObject(n)&&("IS_ACTIVE"in n&&n.IS_ACTIVE===true||n.IS_ACTIVE==="true"||n.IS_ACTIVE==="Y")){a.push(this.classItemActive)}s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:a.join(" "),items:this.getChildMenuItems(t)})},this)}s.push({text:"<span>"+this.message("MIB_MANAGE")+"</span>",className:[this.classSeporator,this.classSubmenuItem,this.classHiddenLabel,this.classManage].join(" ")});s.push({text:this.message("MIB_SETTING_MENU_ITEM"),className:[this.classSettingMenuItem,this.classSubmenuItem].join(" ")});s.push({text:this.message("MIB_APPLY_SETTING_MENU_ITEM"),className:[this.classSettingsApplyButton,this.classSubmenuItem].join(" ")});s.push({text:this.message("MIB_RESET_SETTINGS"),className:[this.classSettingsResetButton,this.classSubmenuItem].join(" ")})}return s},getChildMenuItems:function(t){var e;try{e=JSON.parse(this.dataValue(t,"item"))}catch(t){e=null}if(!BX.type.isPlainObject(e)){return[]}if(!BX.type.isArray(this.listChildItems[t.id])){var i={};this.setListAllItems(i,e);var s=this.getListItems(i,"");if(s.length){this.listChildItems[t.id]=BX.type.isArray(s[0].items)?s[0].items:[]}}return this.listChildItems[t.id]},setListAllItems:function(t,e){var i=[];if(BX.type.isPlainObject(e)){i.push(e)}else{i=e}i.forEach(function(e){t[e["ID"].replace(this.containerId+"_","")]=e;if(BX.type.isArray(e["ITEMS"])){this.setListAllItems(t,e["ITEMS"])}},this)},getListItems:function(t,e){var i=[];for(var s in t){if(!t.hasOwnProperty(s)){continue}var n=t[s];if(n["PARENT_ID"]===e){var a,o={text:n["TEXT"],href:n["URL"],onclick:n["ON_CLICK"],title:n["TITLE"]};a=this.getListItems(t,s);if(a.length){o.items=a}i.push(o);delete t[s]}}return i},getSubmenuArgs:function(){var t=this.getSubmenuId();var e=this.moreButton;var i=BX.pos(e);var s=this.getSubmenuItems();var n={autoHide:true,offsetLeft:i.width/2-80,angle:{position:"top",offset:100},zIndex:0,events:{onPopupClose:BX.delegate(this._onSubmenuClose,this)}};return[t,e,s,n]},getChildMenuArgs:function(t){var e=this.getChildMenuId();var i=this.getChildMenuItems(t);if(!i||BX.type.isArray(i)&&!i.length){return[]}var s={autoHide:true,angle:true,offsetLeft:t.getBoundingClientRect().width/2};return[e,t,i,s]},visibleControlMoreButton:function(){var t=this.getHiddenItems();if(!t.length||t.length===1&&this.isMoreButton(t[0])){this.getMoreButton().style.display="none"}else{this.getMoreButton().style.display=""}},createSubmenu:function(){var t=BX.PopupMenu.create.apply(BX.PopupMenu,this.getSubmenuArgs());if(this.isSettingsEnabled){this.dragAndDropInitInSubmenu()}t.menuItems.forEach(function(t){BX.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))},this);return t},createChildMenu:function(t){return BX.PopupMenu.create.apply(BX.PopupMenu,this.getChildMenuArgs(t))},showSubmenu:function(){var t=this.getSubmenu();if(t!==null){t.popupWindow.show()}else{this.destroySubmenu();t=this.createSubmenu();t.popupWindow.show()}this.setSubmenuShown(true);this.activateItem(this.moreButton);if(this.isEditEnabled()){t.popupWindow.setAutoHide(false)}},showChildMenu:function(t){var e=BX.PopupMenu.getMenuById(this.getChildMenuId()),i=null;if(e&&e.bindElement){if(e.bindElement.id!==t.id){this.destroyChildMenu(t);i=this.createChildMenu(t);i.popupWindow.show()}else{e.popupWindow.show()}}else{this.destroyChildMenu(t);i=this.createChildMenu(t);i.popupWindow.show()}},closeSubmenu:function(){var t=this.getSubmenu();if(t===null){return}t.popupWindow.close();if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}this.setSubmenuShown(false)},closeChildMenu:function(t){var e=this.getChildMenu(t);if(e===null){return}e.popupWindow.close()},getSubmenu:function(){return BX.PopupMenu.getMenuById(this.getSubmenuId())},getChildMenu:function(){return BX.PopupMenu.getMenuById(this.getChildMenuId())},destroySubmenu:function(){BX.PopupMenu.destroy(this.getSubmenuId())},destroyChildMenu:function(){BX.PopupMenu.destroy(this.getChildMenuId())},refreshSubmenu:function(){var t=this.getSubmenu();var e;if(t===null){return}e=this.getSubmenuArgs();if(BX.type.isArray(e)){this.destroySubmenu();this.createSubmenu();this.showSubmenu()}},setSubmenuShown:function(t){this.isSubmenuShown=false;if(BX.type.isBoolean(t)){this.isSubmenuShown=t}},activateItem:function(t){if(!BX.type.isDomNode(t)){return}if(!BX.hasClass(t,this.classItemActive)){BX.addClass(t,this.classItemActive)}},deactivateItem:function(t){if(!BX.type.isDomNode(t)){return}if(BX.hasClass(t,this.classItemActive)){BX.removeClass(t,this.classItemActive)}},getCurrentSettings:function(){var t={};this.getAllItems().forEach(function(e,i){t[e.id]={sort:i,isDisabled:this.isDisabled(e)}},this);return t},saveSettings:function(){var t=this.getCurrentSettings();var e="settings";var i;if(!BX.type.isPlainObject(t)){return}if(BX.type.isDomNode(this.listContainer)){if("id"in this.listContainer){i=this.listContainer.id;t=JSON.stringify(t);BX.userOptions.save("ui",i,e,t);this.setHome()}}},resetSettings:function(){var t=null;var e=BX.PopupWindowManager.create(this.listContainer.id+"_reset_popup",null,{content:this.message("MIB_RESET_ALERT"),autoHide:false,overlay:true,closeByEsc:true,closeIcon:true,draggable:{restrict:true},titleBar:this.message("MIB_RESET_SETTINGS"),buttons:[t=new BX.PopupWindowButton({text:this.message("MIB_RESET_BUTTON"),className:"popup-window-button-create",events:{click:function(){if(BX.hasClass(t.buttonNode,"popup-window-button-wait")){return}BX.addClass(t.buttonNode,"popup-window-button-wait");this.handleResetSettings(function(i){if(i){BX.removeClass(t.buttonNode,"popup-window-button-wait");e.setContent(i)}else{var s="settings";BX.userOptions.save("ui",this.listContainer.id,s,JSON.stringify({}));BX.userOptions.save("ui",this.listContainer.id,"firstPageLink","");window.location.reload()}}.bind(this))}.bind(this)}}),new BX.PopupWindowButtonLink({text:this.message("MIB_CANCEL_BUTTON"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});e.show()},handleResetSettings:function(t){var e=[];BX.onCustomEvent("BX.Main.InterfaceButtons:onBeforeResetMenu",[e,this]);var i=new BX.Promise;var s=i;for(var n=0;n<e.length;n++){i=i.then(e[n])}i.then(function(e){t(null,e)},function(e){t(e,null)});s.fulfill()},moveButtonAlias:function(t){var e,i;if(!t||!this.dragItem){return}e=this.getItemAlias(this.dragItem);i=this.getItemAlias(t);if(this.isListItem(e)){if(!i){this.listContainer.appendChild(e)}else{this.listContainer.insertBefore(e,i)}}},moveButton:function(t){var e;if(!BX.type.isDomNode(t)||!BX.type.isDomNode(this.dragItem)){return}if(this.isListItem(t)){if(this.isDisabled(this.dragItem)){this.dragItem.dataset.disabled="false"}if(BX.type.isDomNode(t)){this.listContainer.insertBefore(this.dragItem,t)}else{this.listContainer.appendChild(this.dragItem)}}if(this.isSubmenuItem(t)){if(this.isDisabled(this.dragItem)&&!this.isDisabled(t)){this.enableItem(this.dragItem)}e=this.getSubmenuContainer();e.insertBefore(this.dragItem,t)}},getSubmenuContainer:function(){var t=this.getSubmenu();var e=null;if(t!==null){e=t.itemsContainer}return e},findNextSiblingByClass:function(t,e){var i=t;for(;!!t;t=t.nextElementSibling){if(e){if(BX.hasClass(t,e)&&t!==i){return t}}else{return null}}},findParentByClassName:function(t,e){for(;t&&t!==document;t=t.parentNode){if(e){if(BX.hasClass(t,e)){return t}}else{return null}}},findChildrenByClassName:function(t,e){var i=null;if(BX.type.isDomNode(t)&&BX.type.isNotEmptyString(e)){i=BX.Buttons.Utils.getByClass(t,e)}return i},dragAndDropInit:function(){this.getAllItems().forEach(function(t,e){if(!this.isSeparator(t)&&!this.isSettings(t)&&!this.isApplySettingsButton(t)&&!this.isResetSettingsButton(t)){t.setAttribute("draggable","true");t.setAttribute("tabindex","-1");t.dataset.link="item"+e;BX.bind(t,"dragstart",BX.delegate(this._onDragStart,this));BX.bind(t,"dragend",BX.delegate(this._onDragEnd,this));BX.bind(t,"dragenter",BX.delegate(this._onDragEnter,this));BX.bind(t,"dragover",BX.delegate(this._onDragOver,this));BX.bind(t,"dragleave",BX.delegate(this._onDragLeave,this));BX.bind(t,"drop",BX.delegate(this._onDrop,this))}BX.bind(t,"mouseover",BX.delegate(this._onMouse,this));BX.bind(t,"mouseout",BX.delegate(this._onMouse,this))},this)},dragAndDropInitInSubmenu:function(){var t=this.getSubmenu();var e=t.menuItems;e.forEach(function(t){if(!this.isSeparator(t.layout.item)&&!this.isSettings(t.layout.item)&&!this.isApplySettingsButton(t.layout.item)&&!this.isResetSettingsButton(t.layout.item)){t.layout.item.draggable=true;t.layout.item.dataset.sortable=true;BX.bind(t.layout.item,"dragstart",BX.delegate(this._onDragStart,this));BX.bind(t.layout.item,"dragenter",BX.delegate(this._onDragEnter,this));BX.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this));BX.bind(t.layout.item,"dragleave",BX.delegate(this._onDragLeave,this));BX.bind(t.layout.item,"dragend",BX.delegate(this._onDragEnd,this));BX.bind(t.layout.item,"drop",BX.delegate(this._onDrop,this))}if(BX.hasClass(t.layout.item,this.classHiddenLabel)&&!BX.hasClass(t.layout.item,this.classManage)){BX.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this))}},this)},getItem:function(t){if(!BX.type.isDomNode(t)){if(!t||!BX.type.isDomNode(t.target)){return null}}else{t={target:t}}var e=this.findParentByClassName(t.target,this.classItem);if(!BX.type.isDomNode(e)){e=this.findParentByClassName(t.target,this.classDefaultSubmenuItem)}return e},setOpacity:function(t){if(!BX.type.isDomNode(t)){return}BX.style(t,"opacity",".1")},unsetOpacity:function(t){if(!BX.type.isDomNode(t)){return}BX.style(t,"opacity","1")},setDragStyles:function(){BX.addClass(this.listContainer,this.classOnDrag);BX.addClass(BX(this.getSubmenuId(true)),this.classOnDrag);this.setOpacity(this.dragItem)},unsetDragStyles:function(){var t=this.getSubmenu();this.getAllItems().forEach(function(t){this.unsetOpacity(t);BX.removeClass(t,"over")},this);if(t&&"menuItems"in t&&BX.type.isArray(t.menuItems)&&t.menuItems.length){t.menuItems.forEach(function(t){this.unsetOpacity(t);BX.removeClass(t.layout.item,"over")},this)}BX.removeClass(this.listContainer,this.classOnDrag);BX.removeClass(BX(this.getSubmenuId(true)),this.classOnDrag)},getIconClass:function(t){var e="";if(BX.type.isDomNode(t)&&"dataset"in t&&"class"in t.dataset&&BX.type.isNotEmptyString(t.dataset.class)){e=t.dataset.class}return e},disableItem:function(t){var e=this.getItemAlias(t);if(t&&"dataset"in t){t.dataset.disabled="true";if(e){e.dataset.disabled="true"}}},enableItem:function(t){var e;if(!BX.type.isDomNode(t)){return}if(this.isSubmenuItem(t)){BX.removeClass(t,this.classItemDisabled);e=this.getItemAlias(t);if(BX.type.isDomNode(e)){e.dataset.disabled="false"}}},getAliasLink:function(t){return this.dataValue(t,"link")||""},getItemAlias:function(t){var e=null;if(!BX.type.isDomNode(t)){return e}var i=this.getAllItems();var s=this.isSubmenuItem(t);var n=this.isListItem(t);if(!s&&!n){return e}if(s){i.forEach(function(i){BX.hasClass(t,this.getAliasLink(i))&&(e=i)},this)}if(n){e=BX.Buttons.Utils.getByClass(document,this.getAliasLink(t))}return e},hideItem:function(t){!!t&&BX.addClass(t,this.classSecret)},showItem:function(t){!!t&&BX.removeClass(t,this.classSecret)},fakeDragItem:function(){var t=null;if(!BX.type.isDomNode(this.dragItem)||!BX.type.isDomNode(this.overItem)){return}if(this.isDragToSubmenu()){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.listContainer.appendChild(this.dragItem);this.dragItem=t;this.showItem(this.dragItem);this.adjustMoreButtonPosition();this.updateSubmenuItems();this.tmp.moved=false;this.tmp.movetToSubmenu=true;this.setOpacity(this.dragItem)}}if(this.isDragToList()&&!this.tmp.movetToSubmenu){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.hideItem(this.dragItem);this.dragItem=t;this.adjustMoreButtonPosition();this.updateSubmenuItems();this.setOpacity(this.dragItem)}}this.tmp.movetToSubmenu=false},updateSubmenuItems:function(){var t=this.getHiddenItems();var e=this.getDisabledItems();var i=this;var s=[];var n,a,o;n=this.getSubmenu();if(n===null){return}a=n.menuItems;if(!BX.type.isArray(a)||!a.length){return}s=e.concat(t);a.forEach(function(t){o=[].some.call(s,function(e){return BX.hasClass(t.layout.item,i.dataValue(e,"link"))||i.isDisabled(t.layout.item)||i.isSeparator(t.layout.item)||i.isDropzone(t.layout.item)});if(o||(i.isSettings(t.layout.item)||i.isApplySettingsButton(t.layout.item)||i.isResetSettingsButton(t.layout.item)||i.isNotHiddenItem(t.layout.item)||i.isSeparator(t.layout.item)||t.layout.item===i.dragItem)&&!i.isMoreButton(t.layout.item)){i.showItem(t.layout.item)}else{i.hideItem(t.layout.item)}})},isNotHiddenItem:function(t){return BX.hasClass(t,this.classSubmenuNoHiddenItem)},getNotHidden:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSubmenuNoHiddenItem)},setOverStyles:function(t){if(BX.type.isDomNode(t)&&!BX.hasClass(t,this.classItemOver)){BX.addClass(t,this.classItemOver)}},unsetOverStyles:function(t){if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItemOver)){BX.removeClass(t,this.classItemOver)}},dataValue:function(t,e){var i="";var s;if(BX.type.isDomNode(t)){s=BX.data(t,e);if(typeof s!=="undefined"){i=s}}return i},execScript:function(script){if(BX.type.isNotEmptyString(script)){eval(script)}},showLicenseWindow:function(){var t;if(!B24.licenseInfoPopup){return}t=B24.licenseInfoPopup;t.init({B24_LICENSE_BUTTON_TEXT:this.message("MIB_LICENSE_BUY_BUTTON"),B24_TRIAL_BUTTON_TEXT:this.message("MIB_LICENSE_TRIAL_BUTTON"),IS_FULL_DEMO_EXISTS:this.licenseParams.isFullDemoExists,HOST_NAME:this.licenseParams.hostname,AJAX_URL:this.licenseParams.ajaxUrl,LICENSE_ALL_PATH:this.licenseParams.licenseAllPath,LICENSE_DEMO_PATH:this.licenseParams.licenseDemoPath,FEATURE_GROUP_NAME:this.licenseParams.featureGroupName,AJAX_ACTIONS_URL:this.licenseParams.ajaxActionsUrl,B24_FEATURE_TRIAL_SUCCESS_TEXT:this.message("MIB_LICENSE_WINDOW_TRIAL_SUCCESS_TEXT")});t.show("main-buttons",this.message("MIB_LICENSE_WINDOW_HEADER_TEXT"),this.message("MIB_LICENSE_WINDOW_TEXT"))},_onDragStart:function(t){var e=this.getVisibleItems();var i=BX.type.isArray(e)?e.length:null;this.dragItem=this.getItem(t);if(!BX.type.isDomNode(this.dragItem)){return}if(i===2&&this.isListItem(this.dragItem)){t.preventDefault();BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[this.dragItem,this]);return}if(this.isMoreButton(this.dragItem)||this.isSeparator(this.dragItem)||this.isNotHiddenItem(this.dragItem)){t.preventDefault();return}this.isSubmenuShownOnDragStart=!!this.isSubmenuShown;if(this.isListItem(this.dragItem)){this.showSubmenu()}this.setDragStyles();if(!this.isEditEnabled()){this.enableEdit()}},_onDragEnd:function(t){t.preventDefault();var e=this.getItem(t);var i,s;if(!BX.type.isDomNode(e)){return}this.unsetDragStyles();if(!this.isSubmenuShownOnDragStart){this.refreshSubmenu();if(!this.isEditEnabled()){this.closeSubmenu()}}else{this.refreshSubmenu()}i=BX.findNextSibling(this.dragItem,BX.delegate(function(t){return this.isVisibleItem(t)},this));s=BX.findPreviousSibling(this.dragItem,BX.delegate(function(t){return this.isVisibleItem(t)},this));if(BX.type.isDomNode(s)&&(BX.hasClass(s,this.classHiddenLabel)||this.isDisabled(s)&&this.isSubmenuItem(s))||(BX.type.isDomNode(i)&&BX.hasClass(i,this.classManage)||this.isDisabled(i)&&this.isSubmenuItem(i))){this.disableItem(this.dragItem);this.refreshSubmenu()}if(this.isEditEnabled()){this.enableEdit();BX.show(this.getSettingsApplyButton());BX.hide(this.getSettingsButton())}else{this.disableEdit();BX.hide(this.getSettingsApplyButton());BX.show(this.getSettingsButton())}this.updateMoreButtonCounter();this.saveSettings();this.dragItem=null;this.overItem=null;this.tmp.moved=false},updateMoreButtonCounter:function(){var t,e,i,s;t=this.getHiddenItems();s=this.getDisabledItems();t=t.concat(s);e=0;if(BX.type.isArray(t)){t.forEach(function(t){e+=parseInt(this.dataValue(t,"counter"))||0},this)}if(BX.type.isNumber(e)){this.setMoreButtonCounter(e)}},_onDragEnter:function(t){var e=this.getItem(t);if(BX.type.isDomNode(e)&&this.isNotHiddenItem(e)){this.setOverStyles(e)}},_onDragOver:function(t){t.preventDefault();var e=null;this.overItem=this.getItem(t);if(!BX.type.isDomNode(this.overItem)||!BX.type.isDomNode(this.dragItem)||this.overItem===this.dragItem||this.isNotHiddenItem(this.overItem)){return}this.fakeDragItem();if(this.isNext(t)&&this.isGoodPosition(t)&&!this.isMoreButton(this.overItem)){e=this.findNextSiblingByClass(this.overItem,this.classItem);if(this.isMoreButton(e)&&!this.tmp.moved){e=e.previousElementSibling;this.tmp.moved=true}if(!BX.type.isDomNode(e)){e=this.findNextSiblingByClass(this.overItem,this.classSubmenuItem)}if(BX.type.isDomNode(e)){this.moveButton(e);this.moveButtonAlias(e);this.adjustMoreButtonPosition();this.updateSubmenuItems()}}if(!this.isNext(t)&&this.isGoodPosition(t)&&!this.isMoreButton(this.overItem)||!this.isGoodPosition(t)&&this.isMoreButton(this.overItem)&&this.getVisibleItems().length===1){this.moveButton(this.overItem);this.moveButtonAlias(this.overItem);this.adjustMoreButtonPosition();this.updateSubmenuItems()}},_onDragLeave:function(t){var e=this.getItem(t);if(BX.type.isDomNode(e)){this.unsetOverStyles(t.target)}},_onDrop:function(t){var e=this.getItem(t);if(!BX.type.isDomNode(e)){return}if(this.isNotHiddenItem(e)||this.isDisabled(e)){this.disableItem(this.dragItem);this.adjustMoreButtonPosition()}this.unsetDragStyles();t.preventDefault()},getIndex:function(t,e){return[].indexOf.call(t||[],e)},_onSubmenuClose:function(){this.setSubmenuShown(false);if(this.isEditEnabled()){this.activateItem(this.moreButton)}else{if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}}},_onResizeHandler:function(){this.adjustMoreButtonPosition();this.updateSubmenuItems();if(!this.isSettingsEnabled){this.visibleControlMoreButton()}},_onClickMoreButton:function(t){t.preventDefault();this.showSubmenu()},_onMouse:function(t){var e=this.getItem(t);if(t.type==="mouseover"&&!BX.hasClass(e,this.classItemOver)){if(!BX.hasClass(e,this.classItemMore)){this.showChildMenu(e)}BX.addClass(e,this.classItemOver)}if(t.type==="mouseout"&&BX.hasClass(e,this.classItemOver)){BX.removeClass(e,this.classItemOver)}},getSettingsResetButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingsResetButton)},_onScroll:function(){if(BX.style(this.pinContainer,"position")==="fixed"){this.closeSubmenu()}},isDisabled:function(t){var e=false;if(BX.type.isDomNode(t)){e=this.dataValue(t,"disabled")==="true"||BX.hasClass(t,this.classItemDisabled)}return e},isSettings:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classSettingMenuItem)}return e},isLocked:function(t){var e=false;if(BX.type.isDomNode(t)){e=this.dataValue(t,"locked")==="true"||BX.hasClass(t,this.classItemLocked)}return e},isDropzone:function(t){return BX.hasClass(t,this.classDropzone)},isNext:function(t){var e=this.dragItem.getBoundingClientRect();var i=this.overItem.getBoundingClientRect();var s=getComputedStyle(this.dragItem);var n=parseInt(s.marginRight.replace("px",""));var a=null;if(this.isListItem(this.overItem)){a=t.clientX>i.left-n&&t.clientX>e.right}if(this.isSubmenuItem(this.overItem)){a=t.clientY>e.top}return a},isGoodPosition:function(t){var e=this.overItem;var i,s;if(!BX.type.isDomNode(e)){return false}i=e.getBoundingClientRect();if(this.isListItem(e)){s=this.isNext(t)&&t.clientX>=i.left+i.width/2||!this.isNext(t)&&t.clientX<=i.left+i.width/2}if(this.isSubmenuItem(e)){s=this.isNext(t)&&t.clientY>=i.top+i.height/2||!this.isNext(t)&&t.clientY<=i.top+i.height/2}return s},isSubmenuItem:function(t){return BX.hasClass(t,this.classSubmenuItem)},isVisibleItem:function(t){if(!BX.type.isDomNode(t)){return false}return t.offsetTop===0},isMoreButton:function(t){var e=false;if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItemMore)){e=true}return e},isListItem:function(t){var e=false;if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItem)){e=true}return e},isSublink:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classItemSublink)}return e},isSeparator:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classSeporator)}return e},isDragToSubmenu:function(){return!this.isSubmenuItem(this.dragItem)&&this.isSubmenuItem(this.overItem)},isDragToList:function(){return this.isSubmenuItem(this.dragItem)&&!this.isSubmenuItem(this.overItem)}}}if(typeof BX.Main.interfaceButtonsManager==="undefined"){BX.Main.interfaceButtonsManager={data:{},init:function(t){var e=null;if(!BX.type.isPlainObject(t)||!("containerId"in t)){throw"BX.Main.interfaceButtonsManager: containerId not set in params Object"}e=BX(t.containerId);if(BX.type.isDomNode(e)){this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)}else{BX(BX.delegate(function(){e=BX(t.containerId);if(!BX.type.isDomNode(e)){throw"BX.Main.interfaceButtonsManager: container is not dom node"}this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)},this))}},getById:function(t){var e=null;if(BX.type.isString(t)&&BX.type.isNotEmptyString(t)){try{e=this.data[t]}catch(t){}}return e},getObjects:function(){return this.data}}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:94:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js?1544127384575";s:6:"source";s:76:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js";s:3:"min";s:80:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js";s:3:"map";s:80:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Buttons");BX.Buttons.Utils={getByClass:function(e,t,l){var n=[];if(t){n=(e||document.body).getElementsByClassName(t);if(!l){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getByTag:function(e,t,l){var n=[];if(t){n=(e||document.body).getElementsByTagName(t);if(!l){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getBySelector:function(e,t,l){var n=[];if(t){if(!l){n=(e||document.body).querySelector(t)}else{n=(e||document.body).querySelectorAll(t);n=[].slice.call(n)}}return n}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:96:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/script.min.js?1544127401100018";s:6:"source";s:75:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Crm");if(typeof BX.setSelectValue==="undefined"){BX.setSelectValue=function(t,e){var i,s;var n=false;var r=!!t.getAttribute("multiple");if(!(e instanceof Array))e=[e];for(i=0;i<t.options.length;i++){for(s in e){if(t.options[i].value==e[s]){if(!n){n=true;t.selectedIndex=i}t.options[i].selected=true;break}}if(!r&&n)break}}}if(typeof BX.setTextContent==="undefined"){BX.setTextContent=function(t,e){if(t){if(t.textContent!==undefined)t.textContent=e;else t.innerText=e}}}if(typeof BX.CrmProductEditor==="undefined"){BX.CrmDiscountType={undefined:0,monetary:1,percentage:2};BX.CrmProductEditor=function(){this._id="";this._settings={};this._serviceUrl="";this._currencyId="";this._currencyFormat="# ?";this._clientTypeName="";this._products=[];this._dlgId="";this._addedProduct=null;this._deletedProduct=null;this._lastRowNumber=0;this._productCreateDialog=null;this._calculateTotalsTimer=null;this._locationID=0;this._topButtons=[];this._modeButton=null;this._discountExists=false;this._taxExists=false;this._viewMode=true;this._form=null;this._placeHolder=null;this._dragContainer=null;this._choiceBtnEnabled=false;this._overlay=null;this._hasLayout=false};BX.CrmProductEditor.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"CrmProductEditor: could not find service URL."}var i=this.isReadOnly();this._viewMode=!this.getSetting("initEditable",false)||i;this._locationID=this.isLDTaxAllowed()?this.getSetting("locationID",0):0;if(this.isLDTaxAllowed())BX.addCustomEvent("CrmProductRowSetLocation",BX.delegate(this._handleChangeLocation,this));var s=typeof this._settings["items"]!="undefined"?this._settings["items"]:[];for(var n=0;n<s.length;n++){var r=s[n];var a=r["rowID"];var o=r["settings"];o["readOnly"]=i;o["fields"]=this.getSetting("productFields",[]);this.getNextRowNumber();this._products.push(BX.CrmProduct.create(o,document.getElementById(a),this))}var l=document.getElementById(this.getSetting("choiceBtnID",""));if(l){this._topButtons.push(l);BX.bind(l,"click",BX.delegate(this.handleChoiceProductButtonClick,this));this._choiceBtnEnabled=true}var h=this.getSetting("addBtnID",""),d=BX(h);if(d){BX.bind(d,"click",BX.delegate(this._handleAddBtnClick,this));this._topButtons.push(d)}var u=document.getElementById(this.getSetting("modeBtnID",""));if(u){this._modeButton=u;BX.bind(u,"click",BX.delegate(this.handleSwitchModeButtonClick,this))}this._currencyId=this.getSetting("currencyID","");this._currencyFormat=this.getSetting("currencyFormat","# ?");this._clientSelectorId=this.getSetting("clientSelectorId","CLIENT");this._clientTypeName=this.getSetting("clientTypeName","");BX.addCustomEvent("CrmClientSelectorChange",BX.delegate(this._handleEntitySelectorChangeValue,this));var c=this.getSetting("formID","");var _=BX.type.isNotEmptyString(c)?BX("form_"+c):null;if(_){this.setForm(_)}var T=BX(this.getSetting("addRowBtnID",""));if(T){BX.bind(T,"click",BX.delegate(this.handleProductRowAdd,this))}BX.addCustomEvent("CrmHandleShowProductEditor",BX.delegate(this._onSelectTab,this));BX.addCustomEvent("CrmProductSearchDialog_SelectProduct",BX.delegate(this.handleProductChoiceById,this));BX.addCustomEvent("InitiateInvoiceSumTotalChange",BX.delegate(this._handleRequestFromInvoiceOwner,this));BX.addCustomEvent("InvoiceAjaxSubmitResponse",BX.delegate(this._handleInvoiceAjaxSubmitResponse,this));this._discountExists=this.getSetting("_discountExistsInit",false);this._taxExists=this.getSetting("_taxExistsInit",false);this._dragContainer=BX.CrmProdoctRowListDragContainer.create(this.getId(),{editor:this,node:this.getTable()});this._dragContainer.addDragFinishListener(BX.delegate(this._onItemDrop,this));if(BX.prop.getBoolean(this._settings,"initLayout",true)){this.layout()}BX.onCustomEvent(window,"ProductRowEditorCreated",[this])},_handleAddBtnClick:function(){var t,e;t=BX.clone(this._settings["productCreateDialogSettings"]);t["initialControl"]=BX(this.getSetting("addBtnID",""));t["productAdditionHandler"]=BX.delegate(this.handleProductAdd,this);e=new BX.CrmProductCreateDialog(t);e.show()},_handleRequestFromInvoiceOwner:function(){BX.onCustomEvent("InvoiceSumTotalChange",[this])},_handleInvoiceAjaxSubmitResponse:function(t){if(t){var e=t["ob"];var i=t["info"];if(e&&e===this&&i){if(typeof i["TOTALS"]!="undefined"){this.refreshTotals(i["TOTALS"])}if(typeof i["TAX_LIST"]!="undefined"){this.setSetting("LDTaxes",i["TAX_LIST"]);this.refreshTaxList()}}}},getNextRowNumber:function(){return++this._lastRowNumber},getId:function(){return this._id},isReadOnly:function(){return this.getSetting("readOnly",false)},setReadOnly:function(t){var e=this.getSetting("readOnly",false);if(t!==e){this.setSetting("readOnly",t);if(t!==this._viewMode)this.toggleMode();this.layout()}},isInvoiceMode:function(){return this.getSetting("invoiceMode",false)},isViewMode:function(){return this._viewMode},getForm:function(){return this._form},setForm:function(t){if(this._form===t){return}this._form=t;if(!this._form){return}var e=this.getSetting("dataFieldName","PRODUCT_ROW_DATA");var i=BX.findChild(this._form,{tagName:"input",attr:{name:e}},true,false);if(!i){this._form.appendChild(BX.create("input",{attrs:{type:"hidden",name:e}}))}var s=e+"_SETTINGS";var n=BX.findChild(t,{tagName:"input",attr:{name:s}},true,false);if(!n){this._form.appendChild(BX.create("input",{attrs:{type:"hidden",name:s}}))}BX.bind(this._form,"submit",BX.delegate(this.handleFormSubmit,this))},getTable:function(){var t=this.getSetting("productContainerID","");return BX.type.isNotEmptyString(t)?BX(t):null},getCurrencyElement:function(){var t=this.getForm();return t?BX.findChild(t,{tag:"select",attr:{name:"CURRENCY_ID"}},true,false):null},getExchRateElement:function(){var t=this.getForm();return t?BX.findChild(t,{tag:"input",attr:{name:"EXCH_RATE"}},true,false):null},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},handleBeforeSearch:function(t){if(t["entityType"]=="product"){t["postData"]["ENABLE_SEARCH_BY_ID"]="N";if(this._currencyId!==""){t["postData"]["CURRENCY_ID"]=this._currencyId}var e=this.getExchRateElement();if(e){var i=e.value;t["postData"]["EXCH_RATE"]=BX.type.isNotEmptyString(i)?parseFloat(i):0}t["postData"]["ENABLE_RAW_PRICES"]=!!this.getSetting("enableRawCatalogPricing",true)?"Y":"N"}},productsToJson:function(){var t="";if(this._products.length>0){for(var e=0;e<this._products.length;e++){t+=(t.length>0?", ":"")+this._products[e].toJson()}t="["+t+"]"}return t},handleFormSubmit:function(){if(!this._form){return}var t=this.getSetting("dataFieldName","PRODUCT_ROW_DATA");var e=BX.findChild(this._form,{tagName:"input",attr:{name:t}},true,false);var i=BX.findChild(this._form,{tagName:"input",attr:{name:t+"_SETTINGS"}},true,false);if(!e){return}if(!this._hasLayout&&!this.getSetting("enableSubmitWithoutLayout",true)){e.value="";if(i){i.value=""}this._form.appendChild(BX.create("input",{props:{type:"hidden",name:t+"_INVALIDATE",value:"Y"}}));return}BX.remove(BX.findChild(this._form,{tagName:"input",attr:{name:t+"_INVALIDATE"}},true,false));if(this._hasLayout){this.cleanProductRows();this.resortProducts()}e.value=this.productsToJson();if(i){i.value='{"ENABLE_DISCOUNT": "'+(this.isDiscountEnabled()?"Y":"N")+'",'+'"ENABLE_TAX": "'+(this.isTaxEnabled()?"Y":"N")+'"}'}},handleChoiceProductButtonClick:function(t){if(!this._choiceBtnEnabled)return;this._choiceBtnEnabled=false;this.createOverlay(995);var e=document.getElementById(this.getSetting("choiceBtnID",""));if(e)BX.addClass(e,"webform-small-button-wait");var i="crm_productrow_list";var s=this.getSetting("jsEventsManagerId","");var n=BX.CrmProductSearchDialogWindow.create({content_url:"/bitrix/components/bitrix/crm.product_row.list/product_choice_dialog.php"+"?caller="+i+"&JS_EVENTS_MANAGER_ID="+BX.util.urlencode(s)+"&sessid="+BX.bitrix_sessid(),closeWindowHandler:BX.delegate(this.handleChoiceProductDialogClose,this),showWindowHandler:BX.delegate(this.handleChoiceProductDialogShow,this),jsEventsManagerId:s,height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),minHeight:500,minWidth:800,draggable:true,resizable:true});n.show()},handleChoiceProductDialogClose:function(){this._choiceBtnEnabled=true},handleChoiceProductDialogShow:function(){var t=document.getElementById(this.getSetting("choiceBtnID",""));if(t)BX.removeClass(t,"webform-small-button-wait");this.removeOverlay()},createOverlay:function(t){t=parseInt(t);if(!this._overlay){var e=BX.GetWindowScrollSize();this._overlay=document.body.appendChild(BX.create("DIV",{style:{position:"absolute",top:"0px",left:"0px",zIndex:t||parseInt(this.DIV.style.zIndex)-2,width:e.scrollWidth+"px",height:e.scrollHeight+"px"}}));BX.unbind(window,"resize",BX.proxy(this._resizeOverlay,this));BX.bind(window,"resize",BX.proxy(this._resizeOverlay,this))}},removeOverlay:function(){if(this._overlay&&this._overlay.parentNode){this._overlay.parentNode.removeChild(this._overlay);BX.unbind(window,"resize",BX.proxy(this._resizeOverlay,this));this._overlay=null}},_resizeOverlay:function(){var t=BX.GetWindowScrollSize();this._overlay.style.width=t.scrollWidth+"px"},handleSwitchModeButtonClick:function(){if(!this._viewMode){BX.showWait(this.getSetting("containerID",""),BX.CrmProductEditorMessages.saving);this.cleanProductRows();this.resortProducts();this.saveProductRows()}else{this.toggleMode();if(this.getProductCount()===0)this.productRowAdd()}},handleProductChoice:function(t,e){e=!!e;var i=typeof t["product"]!="undefined"&&typeof t["product"][0]!="undefined"?t["product"][0]:null;if(!i){return}var s=typeof i["customData"]!=="undefined"?i["customData"]:{};var n=typeof s["measure"]!=="undefined"?s["measure"]:{};var r={id:i["id"],name:i["title"],quantity:1,price:typeof s["price"]!="undefined"?parseFloat(s["price"]):0,customized:false,measureCode:typeof n["code"]!=="undefined"?parseInt(n["code"]):0,measureName:typeof n["name"]!=="undefined"?n["name"]:"",tax:typeof s["tax"]!=="undefined"?s["tax"]:{}};if(this._viewMode)this.toggleMode();this._addItem(r,true);if(!e)this.focusLastRow();obCrm[this._dlgId].ClearSelectItems()},handleProductChoiceById:function(t){t=parseInt(t);if(t<=0){return}var e=this.getCurrencyId();var i=this.getSetting("productSearchUrl","");BX.ajax({url:i,method:"POST",dataType:"json",data:{MODE:"SEARCH",RESULT_WITH_VALUE:"Y",CURRENCY_ID:e,ENABLE_RAW_PRICES:"Y",ENABLE_SEARCH_BY_ID:"N",MULTI:"N",VALUE:"["+t+"]",LIMIT:1},onsuccess:BX.delegate(this.onProductChoiceByIdSuccess,this),onfailure:BX.delegate(this.onProductChoiceByIdFailure,this)})},onProductChoiceByIdSuccess:function(t){var e;if(t&&t["data"]){e=t["data"];if(e[0]){e={product:[e[0]]};this.handleProductChoice(e,true)}}},onProductChoiceByIdFailure:function(t){},handleProductSearchSelect:function(t,e){if(!t||!e){return}var i=typeof e["customData"]!=="undefined"?e["customData"]:{};var s=typeof i["measure"]!=="undefined"?i["measure"]:{};var n={id:e["id"],name:e["title"],quantity:1,price:typeof i["price"]!="undefined"?parseFloat(i["price"]):0,customized:false,measureCode:typeof s["code"]!=="undefined"?parseInt(s["code"]):0,measureName:typeof s["name"]!=="undefined"?s["name"]:"",tax:typeof i["tax"]!=="undefined"?i["tax"]:{}};this._setItem(t,n)},handleProductDeletion:function(t){if(!window.confirm(BX.CrmProductEditorMessages["deletionConfirm"])){return false}this._deleteProduct(t);this.calculateTotalsDelayed();return true},_onDeleteItemRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(this._deletedProduct){this._deleteProduct(this._deletedProduct);this._deletedProduct=null}this.calculateTotalsDelayed()},_ondeleteItemRequestFailure:function(t){this._processAjaxError(t)},handleProductAdd:function(t){var e=typeof t["product"]!="undefined"&&typeof t["product"][0]!="undefined"?t["product"][0]:null;if(!e){return}var i=typeof e["customData"]!=="undefined"?e["customData"]:{};var s=typeof i["measure"]!=="undefined"?i["measure"]:{};var n={id:e["id"],name:e["title"],quantity:1,price:typeof i["price"]!="undefined"?parseFloat(i["price"]):0,customized:false,measureCode:typeof s["code"]!=="undefined"?parseInt(s["code"]):0,measureName:typeof s["name"]!=="undefined"?s["name"]:"",tax:typeof i["tax"]!=="undefined"?i["tax"]:{}};if(this._viewMode)this.toggleMode();this._addItem(n,true);this.focusLastRow()},handleProductRowAdd:function(t){this.productRowAdd();return BX.PreventDefault(t)},productRowAdd:function(){var t={id:0,name:"",quantity:1,price:0,customized:true};if(this._viewMode)this.toggleMode();this._addItem(t,false);this.focusLastRow()},handleProductFocusChange:function(t,e){BX.onCustomEvent("onProductEditorFocusChange",[this,e])},focusLastRow:function(){var t=this._products.length,e,i,s;if(t>0){e=this._products[t-1];this.focusProductRow(e)}},focusProductRow:function(t){if(t){var e=t._container;if(e){var i=BX(e.id+"_PRODUCT_NAME");if(i){i.focus()}}}},getProducts:function(){return this._products},createPlaceHolder:function(t){var e=t["id"];var i=t["index"];var s=this.getTable();if(i<0){i=this._products.length}if(this._placeHolder){if(this._placeHolder.getProductIndex()===i){return this._placeHolder}s.deleteRow(this._placeHolder.getNode().rowIndex);this._placeHolder=null}this._placeHolder=BX.CrmProductRowListPlaceholder.create({editor:this,node:s.insertRow(i+1),productId:e,productIndex:i});this._placeHolder.layout();return this._placeHolder},getPlaceHolder:function(){return this._placeHolder},removePlaceHolder:function(){if(this._placeHolder){var t=this.getTable();t.deleteRow(this._placeHolder.getNode().rowIndex);this._placeHolder=null}},processDraggedItemDrop:function(t){if(this._viewMode){return}var e=t.getContextData();var i=BX.type.isNotEmptyString(e["contextId"])?e["contextId"]:"";if(i!==BX.CrmProdoctRowListDragItem.contextId){return}var s=typeof e["product"]!=="undefined"?e["product"]:null;if(!s){return}var n=this.getTable();var r=this.getPlaceHolder();if(r){n.tBodies[0].insertBefore(s.getContainer(),r.getNode())}else{n.tBodies[0].appendChild(s.getContainer())}var a=this.getProductIndex(s);var o=r.getProductIndex();if(a>=0&&o>=0&&a!==o){this._products.splice(a,1);if(a<o){o--}this._products.splice(o,0,s)}this._renumProducts(0);this.resortProducts()},_onItemDrop:function(t,e,i,s){this.processDraggedItemDrop(e)},_prepareProductSettings:function(t,e){e=e&&e instanceof BX.CrmProduct?e:null;var i=this._products.length;var s=parseInt(t["id"]);if(isNaN(s)){s=0}var n=BX.type.isNotEmptyString(t["name"])?t["name"]:"";var r=parseFloat(t["quantity"]);if(isNaN(r)){r=1}var a=parseFloat(t["price"]);if(isNaN(a)){a=0}var o=parseInt(t["measureCode"]);var l=BX.type.isNotEmptyString(t["measureName"])?t["measureName"]:"";if(isNaN(o)||o<0||l===""){var h=this.getSetting("defaultMeasure",null);if(h){o=h["CODE"];l=h["SYMBOL"]}else{o=0;l=""}}var d=typeof t["discount"]!=="undefined"?t["discount"]:null;if(d){var u=typeof d["discountType"]!=="undefined"?parseInt(d["discountType"]):BX.CrmDiscountType.percentage;if(u!==BX.CrmDiscountType.percentage&&u!==BX.CrmDiscountType.monetary){u=BX.CrmDiscountType.percentage}var c=typeof d["discountRate"]!=="undefined"?BX.CrmProduct.round(parseFloat(d["discountRate"]),2):0;var _=typeof d["discountSum"]!=="undefined"?BX.CrmProduct.round(parseFloat(d["discountSum"]),2):0}var T={PRODUCT_ID:s,PRODUCT_NAME:n,QUANTITY:r,MEASURE_CODE:o,MEASURE_NAME:l,PRICE:a,PRICE_EXCLUSIVE:a};if(d){T["DISCOUNT_TYPE_ID"]=u;T["DISCOUNT_RATE"]=c;T["DISCOUNT_SUM"]=_}var g=!!t["customized"];if(this.isTaxAllowed()){var f=typeof t["tax"]!=="undefined"?t["tax"]:{};var C=typeof f["id"]!=="undefined"?parseInt(f["id"]):0;var p=C>0?this.getTaxById(C):null;if(!p){p=this.getSetting("defaultTax",null)}T["TAX_RATE"]=p?BX.CrmProduct.round(parseFloat(p["VALUE"]),2):0;var E=typeof f["included"]!=="undefined"?!!f["included"]:false;if(E){T["PRICE_EXCLUSIVE"]=BX.CrmProduct.round(BX.CrmProduct.calculateExclusivePrice(T["PRICE"],T["TAX_RATE"]),2)}else{T["PRICE"]=BX.CrmProduct.round(BX.CrmProduct.calculateInclusivePrice(T["PRICE"],T["TAX_RATE"]),2)}if(i>0&&this.getSetting("taxUniform",true)){var I=this._products[i-1];if(I!==e||i>1){if(I===e)I=this._products[i-2];var m=I.isTaxIncluded();if(m!==E){E=m;g=true}}}T["TAX_INCLUDED"]=E}else{T["TAX_RATE"]=0;T["TAX_INCLUDED"]=false}T["CUSTOMIZED"]=g;var S=0;if(e){S=e.getSort()}else{for(var D=0;D<i;D++){var N=this._products[D].getSort();if(S<N)S=N}S+=10}T["SORT"]=S;T["readOnly"]=this.isReadOnly();T["fields"]=this.getSetting("productFields",[]);return T},_addItem:function(t,e){if(!!e)this._removeLonelyEmptyRow();var i=this.getTable();var s=this.getSetting("rowIdPrefix","");var n=BX(s+"#N#");var r=BX.clone(n,true);var a=this.getSetting("productFields",[]);var o=this._products.length;var l,h;l=this.getNextRowNumber();h=l-1;r.id=r.id.replace("#N#",h);r.className=l%2===0?"crm-items-table-even-row":"crm-items-table-odd-row";BX.findChildren(r,function(t){if(t&&BX.type.isElementNode(t)){if(t.id){var e=t.id;if(e&&e.indexOf("#N#")>=0)t.id=e.replace("#N#",h)}if(t.className==="crm-item-num")BX.setTextContent(t,(o+1).toString()+".")}},true);r.style.display="";i.tBodies[0].appendChild(r);var d=this._prepareProductSettings(t);var u=BX.CrmProduct.create(d,r,this);this._products[o++]=u;if(o===1)this.layout();else u.layout();BX.onCustomEvent(this,"productAdd",[{product:u}]);this.calculateTotalsDelayed()},_setItem:function(t,e){var i=this._prepareProductSettings(e,t);t.setSettings(i);t.layout();BX.onCustomEvent(this,"productSet",[{product:t}]);this.calculateTotalsDelayed()},_onAddItemRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(this._addedProduct){if(typeof t["PRODUCT_ROW"]!="undefined"){var e=t["PRODUCT_ROW"];if(typeof e["ID"]!="undefined"){this._addedProduct.setId(e["ID"])}}this._addedProduct=null}this.calculateTotalsDelayed()},_onAddItemRequestFailure:function(t){this._processAjaxError(t)},_removeLonelyEmptyRow:function(){var t,e;if(!this._viewMode){if(this._products.length===1&&this._products[0]instanceof BX.CrmProduct){e=BX.util.trim(this._products[0].getProductName());if(e===""){this._products[0].clean();this._deleteProduct(this._products[0])}}}},_deleteProduct:function(t){for(var e=0;e<this._products.length;e++){if(this._products[e]==t){this._products.splice(e,1);break}}if(this._products.length===0){BX.onCustomEvent(this,"sumTotalChange",["0.00",{TOTAL_SUM_FORMATTED:"",TOTAL_SUM_FORMATTED_SHORT:"",TOTAL_SUM:"0"}]);if(this.getSetting("initEditable",false)&&this.getSetting("hideModeButton",false))this.layoutElements(this._viewMode)}this._renumProducts(e);BX.onCustomEvent(this,"productRemove",[{product:t}])},_renumProducts:function(t){t=t?parseInt(t):0;for(var e=t;e<this._products.length;e++)this._products[e].setNumber(e+1)},_onSelectTab:function(t){if(t===this)BX.CrmProductEditor.arrangeColumns(this,true)},_onUpdateItemRequestSuccess:function(t){if(this._processAjaxError(t)){return}this.calculateTotalsDelayed()},_onUpdateItemRequestFailure:function(t){this._processAjaxError(t)},_onSaveProductsRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(BX.type.isArray(t["PRODUCT_ROW_IDS"])){var e=t["PRODUCT_ROW_IDS"];if(e.length===this._products.length){for(var i=0,s=e.length;i<s;i++){this._products[i].setId(e[i])}}}if(!this._viewMode)this.toggleMode();BX.closeWait();this.calculateTotalsDelayed()},_onSaveProductsRequestFailure:function(t){BX.closeWait();this._processAjaxError(t)},refreshTaxList:function(){var t=this.getSetting("LDTaxes",[]);var e=this.getSetting("taxValueID","total_tax");if(e){var i=BX(e);i=i&&i.parentNode?i.parentNode:null;i=i&&i.parentNode?i.parentNode:null;if(i){var s;var n=i.parentNode;if(n){if(t&&typeof t==="object"&&t.length>0){while(s=BX.findNextSibling(i,{tag:"tr",class:"crm-tax-value"})){r=s.sibling;n.removeChild(s)}var r=i.nextSibling;i.style.display="none";var a,o,l=!this.getSetting("hideAllTaxes",false)&&(this.isLDTaxAllowed()||this.isTaxAllowed()&&this.isTaxEnabled())?"":"none";for(var h=0;h<t.length;h++){a=BX.create("TR",{attrs:{class:"crm-view-table-total-value crm-tax-value"},children:[BX.create("TD",{children:[BX.create("NOBR",{text:BX.util.htmlspecialchars(t[h]["TAX_NAME"]+":")})]}),BX.create("TD",{children:[o=BX.create("STRONG",{attrs:{class:"crm-view-table-total-value"},html:t[h]["TAX_VALUE"]})]})]});if(a){if(l!=="")a.style.display=l;if(h===0){n.removeChild(i);o.setAttribute("id",e)}if(r)n.insertBefore(a,r);else n.appendChild(a)}}}}}}},calculateTotals:function(){var t=[];for(var e=0;e<this._products.length;e++){var i=this._products[e];i.saveSettings();var s=i.getProductId();var n={PRODUCT_ID:s,PRODUCT_NAME:i.getProductName(),QUANTITY:i.getQuantity(),DISCOUNT_TYPE_ID:i.getDiscountTypeId(),DISCOUNT_RATE:i.getDiscountRate(),DISCOUNT_SUM:i.getDiscountSum(),TAX_RATE:i.getTaxRate(),TAX_INCLUDED:i.isTaxIncluded()?"Y":"N",PRICE_EXCLUSIVE:i.getExclusivePrice(),PRICE:i.getPrice(),CUSTOMIZED:"Y"};t.push(n)}BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"CALCULATE_TOTALS",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),PRODUCTS:t,CURRENCY_ID:this._currencyId,CLIENT_TYPE_NAME:this.getClientTypeName(),SITE_ID:this.getSetting("siteId",""),LOCATION_ID:this._locationID,ALLOW_LD_TAX:this.isLDTaxAllowed()?"Y":"N",LD_TAX_PRECISION:this.getSetting("taxListPercentPrecision",2)},onsuccess:BX.delegate(this._onCalculateTotalsRequestSuccess,this),onfailure:BX.delegate(this._onCalculateTotalsRequestFailure,this)})},calculateTotalsDelayed:function(){if(this._calculateTotalsTimer)clearTimeout(this._calculateTotalsTimer);this._calculateTotalsTimer=setTimeout(BX.delegate(this._handleCalculateTotalsTimer,this),1e3)},_handleChangeLocation:function(t){var e=0,i=document.getElementsByName(t)[0];if(i&&BX.type.isElementNode(i)){e=i.value;this._locationID=e;this.calculateTotalsDelayed()}},_handleEntitySelectorChangeValue:function(t,e){var i=e["target"];if(i!=="primaryEntity"){return}var s=null;if(BX.type.isPlainObject(e["selectorInfo"])&&BX.type.isNotEmptyString(e["selectorInfo"]["id"])){s=e["selectorInfo"]["id"]}if(s!==this._clientSelectorId){return}var n=BX.type.isPlainObject(e["data"])?e["data"]:{};var r=BX.type.isNotEmptyString(n["primaryEntityTypeName"])?n["primaryEntityTypeName"]:"";var a=n["primaryEntityInfo"]instanceof BX.CrmEntityInfo?n["primaryEntityInfo"].getId():0;var o=this.getClientTypeName();var l=o;if(o===BX.CrmEntityType.names.company){if(r===BX.CrmEntityType.names.company&&a==0)l=BX.CrmEntityType.names.contact}else{if(r===BX.CrmEntityType.names.company&&a>0)l=BX.CrmEntityType.names.company;else l=BX.CrmEntityType.names.contact}if(o!==l){this.setClientTypeName(l);if(this.isLDTaxAllowed())this.calculateTotalsDelayed()}},_handleCalculateTotalsTimer:function(){this.calculateTotals()},_onCalculateTotalsRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(typeof t["TOTALS"]!="undefined"){this.refreshTotals(t["TOTALS"])}if(typeof t["LD_TAXES"]!="undefined"){this.setSetting("LDTaxes",t["LD_TAXES"]);this.refreshTaxList()}},refreshTotals:function(t){var e,i,s;s=BX(this.getSetting("TOTAL_BEFORE_DISCOUNT_ID","total_before_discount"));if(s){i=BX.type.isNotEmptyString(t["TOTAL_BEFORE_DISCOUNT_FORMATTED"])?t["TOTAL_BEFORE_DISCOUNT_FORMATTED"]:"";e=typeof t["TOTAL_BEFORE_DISCOUNT"]!="undefined"?parseFloat(t["TOTAL_BEFORE_DISCOUNT"]).toFixed(2):"0.00";s.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}s=BX(this.getSetting("TOTAL_DISCOUNT_ID","total_discount"));if(s){i=BX.type.isNotEmptyString(t["TOTAL_DISCOUNT_FORMATTED"])?t["TOTAL_DISCOUNT_FORMATTED"]:"";e=typeof t["TOTAL_DISCOUNT"]!="undefined"?parseFloat(t["TOTAL_DISCOUNT"]).toFixed(2):"0.00";this._discountExists=parseFloat(e)!==0;s.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}s=BX(this.getSetting("TOTAL_BEFORE_TAX_ID","total_before_tax"));if(s){i=BX.type.isNotEmptyString(t["TOTAL_BEFORE_TAX_FORMATTED"])?t["TOTAL_BEFORE_TAX_FORMATTED"]:"";e=typeof t["TOTAL_BEFORE_TAX"]!="undefined"?parseFloat(t["TOTAL_BEFORE_TAX"]).toFixed(2):"0.00";s.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}s=BX(this.getSetting("taxValueID","total_tax"));if(s){i=BX.type.isNotEmptyString(t["TOTAL_TAX_FORMATTED"])?t["TOTAL_TAX_FORMATTED"]:"";e=typeof t["TOTAL_TAX"]!="undefined"?parseFloat(t["TOTAL_TAX"]).toFixed(2):"0.00";this._taxExists=parseFloat(e)!==0;s.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}s=BX(this.getSetting("SUM_TOTAL_ID","sum_total"));if(s){i=BX.type.isNotEmptyString(t["TOTAL_SUM_FORMATTED"])?t["TOTAL_SUM_FORMATTED"]:"";e=typeof t["TOTAL_SUM"]!="undefined"?parseFloat(t["TOTAL_SUM"]).toFixed(2):"0.00";s.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e);BX.onCustomEvent(this,"sumTotalChange",[e,t])}this.switchTotalElements()},_onCalculateTotalsRequestFailure:function(t){self._processAjaxError(t)},registerProductDialogId:function(t){this._dlgId=t},getCurrencyId:function(){return this._currencyId},setCurrencyId:function(t){if(this._currencyId===t){return}if(this._settings["productCreateDialogSettings"])this._settings["productCreateDialogSettings"]["ownerCurrencyId"]=t;this.calculateProductPrices(t)},getClientTypeName:function(){return this._clientTypeName},setClientTypeName:function(t){if(this._clientTypeName===t){return}this._clientTypeName=t},getProductCount:function(){return this._products.length},convertMoney:function(t,e,i,s){var n=this;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"CONVERT_MONEY",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),DATA:{SRC_SUM:t,SRC_CURRENCY_ID:e,DST_CURRENCY_ID:i},SITE_ID:this.getSetting("siteId","")},onsuccess:function(t){if(t["SUM"]){if(n._processAjaxError(t)){return}try{s(parseFloat(t["SUM"]))}catch(t){}}},onfailure:function(t){n._processAjaxError(t)}})},setCurrencyFormat:function(t){if(typeof t!=="string"||t.length<=0)t="# ?";this._currencyFormat=t;var e=BX.util.trim(t.replace("#",""));var i=this.getSetting("discountTypeText",[]);if(i[BX.CrmDiscountType.monetary])i[BX.CrmDiscountType.monetary]=e;var s=BX(this.getSetting("priceTitleId",""));if(s){var n=BX.CrmProductEditorMessages["priceTitleText"];n=n.replace("#CURRENCY#"," ("+e+")");s.innerHTML=n}},calculateProductPrices:function(t){var e=this._currencyId;this._currencyId=t;var i=this.getExchRateElement();var s=[];var n=this.isTaxAllowed();var r,a;for(var o=0;o<this._products.length;o++){var l=this._products[o];r=l.getDiscountTypeId();a=l.isTaxIncluded();s.push({ID:l.getSetting("PRODUCT_ID","0"),PRICE:l.getSetting(n&&!a?"PRICE_NETTO":"PRICE_BRUTTO","0.0"),DISCOUNT_TYPE_ID:r,DISCOUNT_VALUE:r===BX.CrmDiscountType.percentage?l.getDiscountRate():l.getDiscountSum()})}var h=this;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"CALC_PRODUCT_PRICES",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),DATA:{SRC_CURRENCY_ID:e,SRC_EXCH_RATE:i?parseFloat(i.value):0,DST_CURRENCY_ID:t,PRODUCTS:s},SITE_ID:this.getSetting("siteId","")},onsuccess:function(t){if(typeof t["EXCH_RATE"]&&i){i.value=parseFloat(t["EXCH_RATE"])}if(t["PRODUCTS"]){if(h._processAjaxError(t)){return}var e=h.isTaxAllowed();var s,n;h.setCurrencyFormat(t["CURRENCY_FORMAT"]?t["CURRENCY_FORMAT"]:"# ?");for(var r=0;r<t["PRODUCTS"].length;r++){var a=t["PRODUCTS"][r];var o=h._products[r];s=parseInt(a["DISCOUNT_TYPE_ID"]);if(s!==BX.CrmDiscountType.percentage&&s!==BX.CrmDiscountType.monetary){s=BX.CrmDiscountType.percentage}n=o.isTaxIncluded();o.setFieldValue(e&&!n?"PRICE_NETTO":"PRICE_BRUTTO",parseFloat(a["PRICE"]).toFixed(2),true);if(s===BX.CrmDiscountType.monetary){o.refreshCurrencyText();o.setFieldValue("DISCOUNT_SUM",parseFloat(a["DISCOUNT_VALUE"]).toFixed(2),true)}}}if(t["PRODUCT_POPUP_ITEMS"]&&h._dlgId.length>0){obCrm[h._dlgId].SetPopupItems("product",t["PRODUCT_POPUP_ITEMS"])}},onfailure:function(t){h._processAjaxError(t)}})},getMeasures:function(){return this.getSetting("measures",[])},prepareMeasureOptionData:function(){var t=[];var e=this.getSetting("measures",[]);for(var i=0;i<e.length;i++){t.push({text:e[i]["SYMBOL"],value:e[i]["CODE"]})}return t},isTaxAllowed:function(){return this.getSetting("allowTax",false)},isLDTaxAllowed:function(){return this.getSetting("allowLDTax",false)},isTaxEnabled:function(){return this.getSetting("enableTax",false)},isDiscountEnabled:function(){return this.getSetting("enableDiscount",false)},getTaxes:function(){return this.getSetting("taxes",[])},prepareTaxOptionData:function(){var t=[];var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){t.push({text:e[i]["NAME"],value:e[i]["VALUE"]})}return t},getTaxById:function(t){t=parseInt(t);var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){var s=e[i];if(parseInt(s["ID"])==t){return s}}return null},getTaxNameByValue:function(t){var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){var s=e[i];if(parseFloat(s["VALUE"])==t){return e[i]["NAME"]}}return t+"%"},getTaxIdByValue:function(t){var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){var s=e[i];if(parseFloat(s["VALUE"])==t){return parseInt(e[i]["ID"])}}return 0},_processAjaxError:function(t){if(typeof t["ERROR"]=="undefined"){return false}var e=t["ERROR"];if(typeof BX.CrmProductEditorErrors[e]!="undefined"){e=BX.CrmProductEditorErrors[e]}else if(e=="OWNER_TYPE_NOT_FOUND"||e=="OWNER_ID_NOT_FOUND"||e=="SOURCE_DATA_NOT_FOUND"||e=="ID_NOT_FOUND"||e=="PRODUCT_ID_NOT_FOUND"||e=="PRODUCT_ROWS_SAVING_ERROR"){e=BX.CrmProductEditorErrors["INVALID_REQUEST_ERROR"]}this.showError(e);return true},showError:function(t){alert(t)},layoutElements:function(t){t=!!t;var e=this.getSetting("readOnly",false),i=this.getTable(),s=this._products.length;var n=this._topButtons;for(o=0;o<n.length;o++)n[o].style.display=e||t?"none":"";var r=BX(this.getSetting("addRowBtnID",""));if(r)r.style.display=e||t?"none":"";this.setModeBtnStyle();var a=[];a.push(i);a.push(BX("crm-top-sale-tab"));a.push(BX("crm-top-spacer"));a.push(BX("crm-top-tax-tab"));a.push(BX(this.getSetting("productTotalContainerID","")));for(var o=0;o<a.length;o++){if(a[o])a[o].style.display=s>0?"":"none"}},toggleMode:function(){var t=this._products;this.layoutElements(!this._viewMode);for(var e=0;e<t.length;e++)t[e].toggleMode();this._viewMode=!this._viewMode;this.setModeBtnStyle()},layout:function(){var t,e=this._products.length;this.layoutElements(this._viewMode);for(t=0;t<e;t++)this._products[t].layout();BX.CrmProductEditor.arrangeColumns(this,true);this._hasLayout=true},hasLayout:function(){return this._hasLayout},cleanProductRows:function(){if(!this._hasLayout){return}var t,e,i=-1;var s=this._products.length;for(e=s-1;e>=0;e--){t=this._products[e];t.saveSettings();if(BX.util.trim(t.getProductName())===""){t.clean();this._products.splice(e,1);i=e}}if(this._products.length===0&&s>0){BX.onCustomEvent(this,"sumTotalChange",["0.00",{TOTAL_SUM_FORMATTED:"",TOTAL_SUM_FORMATTED_SHORT:"",TOTAL_SUM:"0.00"}])}if(i>=0)this._renumProducts(i)},resortProducts:function(){var t;for(t=0;t<this._products.length;t++)this._products[t].setSort((t+1)*10)},saveProductRows:function(){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"SAVE_PRODUCTS",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),PRODUCT_ROW_DATA:this.productsToJson(),PRODUCT_ROW_SETTINGS:{ENABLE_DISCOUNT:this.isDiscountEnabled()?"Y":"N",ENABLE_TAX:this.isTaxEnabled()?"Y":"N"},SITE_ID:this.getSetting("siteId","")},onsuccess:BX.delegate(this._onSaveProductsRequestSuccess,this),onfailure:BX.delegate(this._onSaveProductsRequestFailure,this)})},getProductIndex:function(t){for(var e=0;e<this._products.length;e++){if(this._products[e]===t){return e}}return-1},getProductIndexByContainer:function(t){if(!BX.type.isDomNode(t)){return null}for(var e=0;e<this._products.length;e++){var i=this._products[e];if(i.getContainer()===t){return e}}return-1},switchTotalElements:function(){var t=this._discountExists,e=this._taxExists,i="crm-tax-value",s,n,r,a=this.isDiscountEnabled()||t?"":"none",o=e||!this.getSetting("hideAllTaxes",false)&&(this.isLDTaxAllowed()||this.isTaxAllowed()&&this.isTaxEnabled())?"":"none";var l=[{id:"TOTAL_BEFORE_DISCOUNT_ID",type:"discount"},{id:"TOTAL_DISCOUNT_ID",type:"discount"},{id:"TOTAL_BEFORE_TAX_ID",type:"tax"},{id:"taxValueID",type:"tax"}];for(s=0;s<l.length;s++){n=BX(this.getSetting(l[s]["id"],""));if(BX.type.isElementNode(n)){n=n.parentNode.parentNode;if(BX.type.isElementNode(n)){switch(l[s]["type"]){case"discount":n.style.display=a;break;case"tax":n.style.display=o;if(l[s]["id"]==="taxValueID"){r=n;while(r){r.style.display=o;r=BX.findNextSibling(r,{class:i})}}break}}}}},changeTaxIncludedUniform:function(t,e){var i,s=this._products;for(i=0;i<s.length;i++){if(s[i]!==t)s[i]._emulateTaxIncludedElementChange(e)}},getPathToProductShow:function(){return this.getSetting("pathToProductShow","")},setModeBtnStyle:function(){if(this._modeButton){var t=this.getSetting("readOnly",false),e=this.getSetting("hideModeButton",false),i=this._modeButton.parentNode,s=this._products.length,n=this._viewMode?s?"crmProductRowBtnEdit":"crmProductRowBtnAdd":"crmProductRowBtnEditF",r=BX.findChild(this._modeButton,{attr:{class:"webform-small-button-text"}});this._modeButton.style.display=t||e?"none":"";if(r)BX.setTextContent(r,BX.CrmProductEditorMessages[n]);if(this._viewMode&&s===0){i.style.cssFloat="left"}else{i.style.cssFloat="right"}}},processProductChange:function(t){BX.onCustomEvent(this,"productChange",[{product:t}])}};BX.CrmProductEditor.items={};BX.CrmProductEditor.get=function(t){return typeof this.items[t]!="undefined"?this.items[t]:null};BX.CrmProductEditor.getDefault=function(){return typeof this.items["__default"]!="undefined"?this.items["__default"]:null};BX.CrmProductEditor.create=function(t,e){var i=new BX.CrmProductEditor;i.initialize(t,e);this.items[t]=i;if(typeof this.items["__default"]=="undefined"){this.items["__default"]=i}return i};BX.CrmProductEditor.arrangeColumns=function(t,e){if(!t||typeof t._settings!=="object"||!t._settings["containerID"]||!t._settings["productContainerID"])return;var i=t.isTaxAllowed(),s=t.getSetting("hideTaxIncludedColumn",false),n=null,r=BX("crm-top-sale-checkbox"),a=r.parentNode.parentNode.offsetWidth,o=BX(t._settings["containerID"]),l=BX(t._settings["productContainerID"]),h=l.offsetWidth,d=l.rows[0],u=d.cells.length,c=BX("crm-l-space"),_=BX("crm-top-spacer").offsetWidth,T=h/100,g,f=0,C=0,p=[0,0,0,0,0,0,0,0],E=[29,10,10,10,10,10,18,3],I=[0,0,0,0,0,0,0,0],m=[29,16,16,16,0,0,19,3];if(i){n=BX("crm-top-tax-checkbox");if(s){p=[26,13,13,13,0,0,.5,10,0,10,11,3];E=[24,8,8,8,14,10,.5,0,0,0,24,3];I=[24,8,8,8,9,8,.5,10,0,10,11,3];m=[27,15,15,15,0,0,.5,0,0,0,24,3]}else{p=[26,13,13,13,0,0,.5,7,7,7,10,3];E=[24,8,8,8,15,15,.5,0,0,0,18,3];I=[24,8,8,8,10,7,.5,7,7,7,10,3];m=[29,16,16,16,0,0,.5,0,0,0,19,3]}}if(!e){var S=null;if(n&&this===n){if(n.checked!==t.getSetting("enableTax",false)){t.setSetting("enableTax",n.checked);if(!S)S={};S["SHOW_TAX"]=n.checked?"Y":"N"}}if(this===r){if(r.checked!==t.isDiscountEnabled()){t.setSetting("enableDiscount",r.checked);if(!S)S={};S["SHOW_DISCOUNT"]=r.checked?"Y":"N"}}var D=t.getSetting("ownerType","");var N=parseInt(t.getSetting("ownerID",0));if(S&&D.length>0&&N>0){BX.ajax({url:t._serviceUrl,method:"POST",dataType:"json",data:{MODE:"SET_OPTION",OWNER_TYPE:D,OWNER_ID:N,DATA:S,SITE_ID:t.getSetting("siteId","")}})}}for(var R=0;R<u;R++){d.cells[R].style.width=Math.round(d.cells[R].offsetWidth)+"px";setTimeout(function(){BX.addClass(o,"crm-items-list-anim")},50)}function B(t,e,i){var s=c.offsetWidth;c.style.width=s+"px";for(var n=0;n<u;n++){d.cells[n].style.width=Math.round(d.cells[n].offsetWidth)+"px";f+=Math.round(t[n]*T);if(n==3&&!e){C=f-Math.round(s);g=Math.round(t[n]*T)-C;if(g<0)g=0;d.cells[n].style.width=g+"px";f-=C}else if(n==5&&!e&&!i){C=f-Math.round(s+a+_);g=Math.round(t[n]*T)-C;if(g<0)g=0;d.cells[n].style.width=g+"px";f-=C}else if(n==6&&e&&i){if(f!=Math.round(s+a+_)){C=f-Math.round(s+a+_);g=Math.round(t[n]*T)-C;if(g<0)g=0;d.cells[n].style.width=g+"px";f-=C}else{d.cells[n].style.width=Math.round(t[n]*T)+"px"}}else if(n==6&&!e&&i){d.cells[n].style.width=Math.round(_)+"px";f-=Math.round(t[n]*T);f+=Math.round(_)}else if(n==7&&!i){g=Math.round(t[n]*T)-(f-h);if(g<0)g=0;d.cells[n].style.width=g+"px"}else if(n==11&&i){g=Math.round(t[n]*T)-(f-h);if(g<0)g=0;d.cells[n].style.width=g+"px"}else{d.cells[n].style.width=Math.round(t[n]*T)+"px"}}c.style.width=""}function U(t){for(var e=0;e<u;e++){d.cells[e].style.width=Math.round(t[e]*T)+"px"}}if(n&&this==n){if(o.getAttribute("data-tabs")==""){BX.addClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","tax");setTimeout(function(){B(p,1,i)},70)}else if(o.getAttribute("data-tabs")=="sale"){BX.addClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","all");setTimeout(function(){B(I,0,i)},70)}else if(o.getAttribute("data-tabs")=="tax"){BX.removeClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","");setTimeout(function(){U(m)},70)}else if(o.getAttribute("data-tabs")=="all"){BX.removeClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","sale");setTimeout(function(){B(E,0,i)},70)}}else if(this==r){if(o.getAttribute("data-tabs")==""){BX.addClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","sale");setTimeout(function(){B(E,0,i)},70)}else if(o.getAttribute("data-tabs")=="tax"){BX.addClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","all");setTimeout(function(){B(I,0,i)},70)}else if(o.getAttribute("data-tabs")=="sale"){BX.removeClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","");setTimeout(function(){U(m)},70)}else if(o.getAttribute("data-tabs")=="all"){BX.removeClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","tax");setTimeout(function(){B(p,1,i)},70)}}else{if(o.getAttribute("data-tabs")=="")setTimeout(function(){U(m)},70);else if(o.getAttribute("data-tabs")=="tax")setTimeout(function(){B(p,1,i)},70);else if(o.getAttribute("data-tabs")=="sale")setTimeout(function(){B(E,0,i)},70);else if(o.getAttribute("data-tabs")=="all")setTimeout(function(){B(I,0,i)},70)}t.switchTotalElements()};if(typeof BX.CrmProductEditorMessages==="undefined"){BX.CrmProductEditorMessages={editButtonTitle:"Edit",deleteButtonTitle:"Delete",deletionConfirm:"Are you sure you want to delete this product?"}}}if(typeof BX.CrmProduct==="undefined"){BX.CrmProduct=function(){this._viewMode=true;this._settings={};this._container=this._editor=null;this._fields={};this._fieldValue={};this._elements={};this._isEventsBinds=false;this._discountTypeView=0;this._fixProductName=false;this._focusedField=null;this._productSearch=null;this._dragButton=null;this._sumValueAfterBlur=null;this._hasLayout=false};BX.CrmProduct.prototype={initialize:function(t,e,i){this._editor=i;this.setSettings(t);if(typeof this._settings["FIXED_PRODUCT_NAME"]==="string"&&this._settings["FIXED_PRODUCT_NAME"].length>0)this._fixProductName=true;this._container=e;this._viewMode=i._viewMode;this._discountTypeView=BX.CrmDiscountType.percentage;var s=BX.findChild(e,{tag:"span",class:"crm-item-del"},true,false);if(s){BX.bind(s,"click",BX.delegate(this._handleDeleteClick,this));s.setAttribute("title",BX.CrmProductEditorMessages["deleteButtonTitle"])}this._dragButton=BX.findChild(e,{tag:"span",class:"crm-item-move-btn"},true,false);var n=e.id;var r,a,o,l,h,d=[];var u=[];if(n){var c=this.getSetting("fields",[]);for(var _=0;_<c.length;_++){if(c[_]){a=n+"_"+c[_];o="crm-item-cell-text";l=false;if(c[_]==="PRODUCT_NAME"&&this._fixProductName){a+="_v";o="crm-item-cell-view";l=true}r=BX(a);if(r){h=r.parentNode;if(h){if(BX.hasClass(h,o)){d.push(h)}else{h=h.parentNode;if(h&&BX.hasClass(h,o))d.push(h)}if(h&&this._viewMode&&!l)h.style.display="none"}}o="crm-item-cell-view";l=c[_]==="PRODUCT_NAME"&&this._fixProductName;r=BX(n+"_"+c[_]+"_v");if(r){h=r.parentNode;if(h){if(BX.hasClass(h,o)){u.push(h)}else{h=h.parentNode;if(h&&BX.hasClass(h,o))u.push(h)}if(h&&!this._viewMode&&!l)h.style.display="none"}}}}}this._viewBlocks=u;this._editBlocks=d;var T=BX.findChild(this._container,{attr:{class:"crm-item-del"}},true);if(T)T.style.display=this._viewMode?"none":"";if(!this._productSearch){var g=BX(this._container.id+"_PRODUCT_NAME");var f=g.parentNode;f.id=g.id+"_c";this._productSearch=BX.CrmProductSearch.create({AJAX_PAGE:this._editor.getSetting("productSearchUrl",""),CONTAINER_ID:f.id,INPUT_ID:this._container.id+"_PRODUCT_NAME",MIN_QUERY_LEN:3},this)}},initializeDragDropAbilities:function(){if(this._dragItem){return}if(!this._dragButton){throw"CrmProduct: Could not find drag button."}this._dragItem=BX.CrmProdoctRowListDragItem.create(this.getId(),{product:this,node:this._dragButton,container:this._editor.getTable(),showInDragMode:false,ghostOffset:{x:-12,y:-12}})},releaseDragDropAbilities:function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}},getRowNumber:function(){return this._container.rowIndex},setNumber:function(t){var e=[];e[0]=BX(this._container.id+"_NUM");e[1]=BX(this._container.id+"_NUM_v");for(var i=0;i<e.length;i++){if(e[i])BX.setTextContent(e[i],parseInt(t).toString()+".")}this._container.className=t%2===0?"crm-items-table-even-row":"crm-items-table-odd-row"},getMeasureNameByCode:function(t){var e=this._editor.getSetting("measures",[]),i="-",s,n;if(e){for(n=0;n<e.length;n++){if(e[n]&&typeof e[n]==="object"){s=e[n];if(s.hasOwnProperty("CODE")&&parseInt(s["CODE"])===parseInt(t)){if(s.hasOwnProperty("SYMBOL")&&s["SYMBOL"].length>0){i=s["SYMBOL"];break}}}}}return i},getMeasureIdByCode:function(t){var e=this._editor.getSetting("measures",[]),i=0,s,n;if(e){for(n=0;n<e.length;n++){if(e[n]&&typeof e[n]==="object"){s=e[n];if(s.hasOwnProperty("CODE")&&parseInt(s["CODE"])===parseInt(t)){if(s.hasOwnProperty("ID")&&s["ID"].length>0){i=s["ID"];break}}}}}return i},setFieldView:function(t,e){var i,s=false;var n=this._editor.isTaxAllowed();var r=this.isTaxIncluded();if(t==="PRICE_NETTO"||t==="PRICE_BRUTTO")s=true;e=t==="TAX_INCLUDED"?!!e:e.toString();switch(t){case"PRICE_NETTO":case"PRICE_BRUTTO":i="PRICE";break;case"MEASURE_CODE":i="MEASURE";break;case"DISCOUNT_RATE":case"DISCOUNT_SUM":case"DISCOUNT_TYPE_ID":i="DISCOUNT";break;default:i=t}var a=0,o=this._discountTypeView;switch(i){case"PRICE":case"DISCOUNT_SUM":case"DISCOUNT_SUBTOTAL":case"SUM":a=2;break;case"DISCOUNT":if(o===BX.CrmDiscountType.monetary)a=2;break}if(a>0)e=this._parseFloat(e,a,0).toFixed(a);var l=this._container,h=BX(l.id+"_"+i+"_v"),d;var u,c;switch(t){case"PRODUCT_NAME":case"QUANTITY":case"SUM":if(h)BX.setTextContent(h,e);break;case"PRICE_NETTO":if(n&&!r){if(h)BX.setTextContent(h,e)}break;case"PRICE_BRUTTO":if(!n||r){if(h)BX.setTextContent(h,e)}break;case"MEASURE_CODE":var _=this.getMeasureNameByCode(e);if(h)BX.setTextContent(h,_);break;case"DISCOUNT_TYPE_ID":break;case"DISCOUNT_RATE":if(o===BX.CrmDiscountType.percentage){if(h)BX.setTextContent(h,e)}break;case"DISCOUNT_SUM":if(o===BX.CrmDiscountType.monetary){if(h)BX.setTextContent(h,e)}break;case"DISCOUNT_SUBTOTAL":if(h)BX.setTextContent(h,e);break;case"TAX_RATE":if(h)BX.setTextContent(h,e+"%");break;case"TAX_INCLUDED":if(h)BX.setTextContent(h,e?BX.CrmProductEditorMessages["yes"]:BX.CrmProductEditorMessages["no"]);break;case"TAX_SUM":if(h)BX.setTextContent(h,this._parseFloat(e,2,0).toFixed(2));break}},setFieldValue:function(t,e,i){var s,n=false;var r=this._editor.isTaxAllowed();var a=this.isTaxIncluded();if(t==="PRICE_NETTO"||t==="PRICE_BRUTTO")n=true;e=t==="TAX_INCLUDED"?!!e:e.toString();if(this._fieldValue.hasOwnProperty(t)&&this._fieldValue[t]===e&&!n)return;this._fieldValue[t]=e;switch(t){case"PRICE_NETTO":case"PRICE_BRUTTO":s="PRICE";break;case"MEASURE_CODE":s="MEASURE";break;case"DISCOUNT_RATE":case"DISCOUNT_SUM":s="DISCOUNT";break;default:s=t}var o=this._container,l=BX(o.id+"_"+s),h=BX(o.id+"_"+s+"_v"),d;var u,c,_,T,g=this._discountTypeView;switch(t){case"PRODUCT_NAME":case"QUANTITY":case"DISCOUNT_SUBTOTAL":case"SUM":if(l)l.value=e;if(h)BX.setTextContent(h,e);break;case"PRICE_NETTO":if(r&&!a){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"PRICE_BRUTTO":if(!r||a){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"MEASURE_CODE":if(l)BX.setSelectValue(l,e);var f=this.getMeasureNameByCode(e);this._fieldValue["MEASURE_NAME"]=f;if(h)BX.setTextContent(h,f);break;case"DISCOUNT_TYPE_ID":u=parseInt(e);if(u!==BX.CrmDiscountType.percentage&&u!==BX.CrmDiscountType.monetary)u=BX.CrmDiscountType.percentage;if(parseInt(g)!==u){var C=this._editor.getSetting("discountTypeText",[]);g=u;this._discountTypeView=g;var p=C[g]?C[g]:"?";var E=g===BX.CrmDiscountType.percentage?"DISCOUNT_RATE":"DISCOUNT_SUM";l=BX(o.id+"_DISCOUNT");var I=[];var m=this._parseFloat(this._fieldValue[E],2,0).toFixed(2);if(l){I[0]=BX.findChild(l.parentNode,{attr:{class:"crm-item-sale-text"}},true);l.value=g===BX.CrmDiscountType.percentage?this._fieldValue[E]:m}h=BX(o.id+"_DISCOUNT_v");if(h){I[1]=BX.findChild(h.parentNode,{attr:{class:"crm-item-sale-text"}},true);BX.setTextContent(h,g===BX.CrmDiscountType.percentage?this._fieldValue[E]:m)}{for(d=0;d<I.length;d++){if(I[d]){I[d].innerHTML=p}}}}break;case"DISCOUNT_RATE":if(g===BX.CrmDiscountType.percentage){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"DISCOUNT_SUM":if(g===BX.CrmDiscountType.monetary){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"TAX_RATE":if(l){var S=false;for(d=0;d<l.options.length;d++){if(l.options[d].value===e){l.selectedIndex=d;S=true;break}}if(!S){var D=document.createElement("option");D.value=e;D.innerHTML=BX.util.htmlspecialchars(e+"%");l.appendChild(D);l.selectedIndex=d}}if(h)BX.setTextContent(h,e+"%");break;case"TAX_INCLUDED":if(l)l.checked=e;if(h)BX.setTextContent(h,e?BX.CrmProductEditorMessages["yes"]:BX.CrmProductEditorMessages["no"]);break;case"TAX_SUM":if(l)BX.setTextContent(l,this._parseFloat(e,2,0).toFixed(2));if(h)BX.setTextContent(h,this._parseFloat(e,2,0).toFixed(2));break}i=typeof i==="undefined"?false:!!i;if(i)this.processFieldValueChange(t)},layout:function(){var t=this._container;var e=this._editor.getSetting("readOnly",false);var i=this.getSetting("PRODUCT_ID",0);var s=this.getSetting("PRODUCT_NAME","");var n=this.getSetting("PRICE",0);var r=this.getSetting("QUANTITY",0);var a=this._editor.isTaxAllowed();var o=this._editor.isTaxEnabled();var l,h,d,u,c,_;this.setFieldValue("PRODUCT_NAME",s);var T=this.getSetting("PRICE_NETTO",0);this.setFieldValue("PRICE_NETTO",T.toFixed(2));var g=this.getSetting("PRICE_BRUTTO",0);this.setFieldValue("PRICE_BRUTTO",g.toFixed(2));var f=this.getSetting("QUANTITY",0);this.setFieldValue("QUANTITY",f);var C="";var p=this._editor.getSetting("defaultMeasure",null);if(p){if(p.hasOwnProperty("CODE"))C=p["CODE"]}this.setFieldValue("MEASURE_CODE",this.getSetting("MEASURE_CODE",C));var E=this.getDiscountTypeId();this.setFieldValue("DISCOUNT_TYPE_ID",E);var I=this.getSetting("DISCOUNT_RATE",0);this.setFieldValue("DISCOUNT_RATE",I);var m=this.getSetting("DISCOUNT_SUM",0);this.setFieldValue("DISCOUNT_SUM",m.toFixed(2));var S=f*m;this.setFieldValue("DISCOUNT_SUBTOTAL",S.toFixed(2));var D="0";var N="0%";if(a){var R=this._editor.getSetting("defaultTax",null);if(R){if(R.hasOwnProperty("VALUE")){D=R["VALUE"];N=R["VALUE"]+"%"}}}this.setFieldValue("TAX_RATE",this.getSetting("TAX_RATE",D));this.setFieldValue("TAX_INCLUDED",this.isTaxIncluded());this.setFieldValue("TAX_SUM",this._round(this.getSetting("TAX_SUM",0),2));this.setFieldValue("SUM",this._calculateSumTotal());this._handleProductNameChange(s);this._bindEventsHandlers();this.initializeDragDropAbilities();this._hasLayout=true},clean:function(){if(this._container){this._container.parentNode.removeChild(this._container);this.releaseDragDropAbilities()}this._hasLayout=false},hasLayout:function(){return this._hasLayout},isReadOnly:function(){return this.getSetting("readOnly",false)},getContainer:function(){return this._container},toggleMode:function(){var t,e;var i=this._viewMode?this._viewBlocks:this._editBlocks;var s=this._viewMode?this._editBlocks:this._viewBlocks;for(t=0;t<i.length;t++)i[t].style.display="none";for(t=0;t<s.length;t++)s[t].style.display="";e=BX.findChild(this._container,{attr:{class:"crm-item-del"}},true);if(e)e.style.display=this._viewMode?"":"none";if(!this._viewMode){this.saveSettings()}this._viewMode=!this._viewMode},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},saveSettings:function(){if(!this._hasLayout||this._viewMode){return}this._settings["PRODUCT_NAME"]=BX.util.trim(BX.prop.getString(this._fieldValue,"PRODUCT_NAME"));this._settings["QUANTITY"]=this._parseFloat(this._fieldValue["QUANTITY"],4,0);this._settings["DISCOUNT_TYPE_ID"]=this._parseInt(this._fieldValue["DISCOUNT_TYPE_ID"],this.getDiscountTypeId());this._settings["DISCOUNT_RATE"]=this._parseFloat(this._fieldValue["DISCOUNT_RATE"],2,0);this._settings["DISCOUNT_SUM"]=this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this._settings["TAX_INCLUDED"]=this._fieldValue["TAX_INCLUDED"];this._settings["TAX_RATE"]=this._parseFloat(this._fieldValue["TAX_RATE"],2,0);this._settings["TAX_SUM"]=this._parseFloat(this._fieldValue["TAX_SUM"],2,0);this._settings["MEASURE_CODE"]=parseInt(this._fieldValue["MEASURE_CODE"]);this._settings["MEASURE_NAME"]=BX.prop.getString(this._fieldValue,"MEASURE_NAME")},getSettings:function(){return this._settings},setSettings:function(t){this._settings=t?t:{};this._settings["PRODUCT_ID"]=parseInt(this.getSetting("PRODUCT_ID",0));this._settings["PRODUCT_NAME"]=this.getSetting("PRODUCT_NAME","");this._settings["QUANTITY"]=this._round(parseFloat(this.getSetting("QUANTITY",0)),4);this._settings["MEASURE_CODE"]=parseInt(this.getSetting("MEASURE_CODE",0));this._settings["MEASURE_NAME"]=this.getSetting("MEASURE_NAME","");this._settings["DISCOUNT_TYPE_ID"]=parseInt(this.getDiscountTypeId());if(this._editor.isInvoiceMode())this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this._settings["DISCOUNT_RATE"]=this._round(parseFloat(this.getSetting("DISCOUNT_RATE",0)),2);this._settings["DISCOUNT_SUM"]=this._round(parseFloat(this.getSetting("DISCOUNT_SUM",0)),2);this._settings["DISCOUNT_SUBTOTAL"]=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this._settings["TAX_RATE"]=this._round(parseFloat(this.getSetting("TAX_RATE",0)),2);this._settings["TAX_INCLUDED"]=this.isTaxIncluded();this._settings["PRICE"]=this._round(parseFloat(this.getSetting("PRICE",0)),2);this._settings["PRICE_EXCLUSIVE"]=this._round(parseFloat(this.getSetting("PRICE_EXCLUSIVE",0)),2);if(typeof this._settings["PRICE_NETTO"]!=="undefined"){this._settings["PRICE_NETTO"]=this._round(parseFloat(this.getSetting("PRICE_NETTO",0)),2)}else{var e=this._settings["PRICE_EXCLUSIVE"];if(this._settings["DISCOUNT_TYPE_ID"]===BX.CrmDiscountType.monetary){this._settings["PRICE_NETTO"]=e+this._settings["DISCOUNT_SUM"]}else{var i=this._settings["DISCOUNT_RATE"];var s=i<100?this._round(this._calculateDiscountByDiscountPrice(e,i),2):this._settings["DISCOUNT_SUM"];this._settings["PRICE_NETTO"]=e+s}}if(typeof this._settings["PRICE_BRUTTO"]!=="undefined"){this._settings["PRICE_BRUTTO"]=this._round(parseFloat(this.getSetting("PRICE_BRUTTO",0)),2)}else{if(this._settings["DISCOUNT_SUM"]==0){this._settings["PRICE_BRUTTO"]=this._settings["PRICE"]}else{this._settings["PRICE_BRUTTO"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]),2)}}this._settings["TAX_SUM"]=this.getTaxSum();this._settings["CUSTOMIZED"]=!!this.getSetting("CUSTOMIZED",false);this._settings["SORT"]=parseInt(this.getSetting("SORT",0))},getId:function(){return parseInt(this.getSetting("ID",0))},setId:function(t){this._settings["ID"]=parseInt(t)},setProductId:function(t){return this.setSetting("PRODUCT_ID",parseInt(t))},getProductId:function(){return this.getSetting("PRODUCT_ID",0)},getProductName:function(){return this.getSetting("PRODUCT_NAME","")},getQuantity:function(){return this.getSetting("QUANTITY",0)},getMeasureCode:function(){return this.getSetting("MEASURE_CODE",0)},getMeasureName:function(){return this.getSetting("MEASURE_NAME","")},getPrice:function(){return this.getSetting("PRICE",0)},getExclusivePrice:function(){return this.getSetting("PRICE_EXCLUSIVE",0)},getPriceNetto:function(){return this.getSetting("PRICE_NETTO",0)},getPriceBrutto:function(){return this.getSetting("PRICE_BRUTTO",0)},getDiscountTypeId:function(){var t=parseInt(this.getSetting("DISCOUNT_TYPE_ID",BX.CrmDiscountType.percentage));if(t!==BX.CrmDiscountType.percentage&&t!==BX.CrmDiscountType.monetary){t=BX.CrmDiscountType.percentage}return t},getDiscountRate:function(){return this.getSetting("DISCOUNT_RATE",0)},getDiscountSum:function(){return this.getSetting("DISCOUNT_SUM",0)},getDiscountSubtotal:function(){return this.getSetting("DISCOUNT_SUBTOTAL",0)},getTaxRate:function(){return this.getSetting("TAX_RATE",0)},isTaxIncluded:function(){return this.getSetting("TAX_INCLUDED",false)},isCustomized:function(){return this.getSetting("CUSTOMIZED",false)},getSort:function(){return this.getSetting("SORT",0)},setSort:function(t){return this.setSetting("SORT",t)},isViewMode:function(){return this._viewMode},toJson:function(){var t="";var e={};if(this._hasLayout&&!this._viewMode){this.saveSettings()}e["ID"]=this.getId();e["PRODUCT_NAME"]=this.getSetting(this._fixProductName?"FIXED_PRODUCT_NAME":"PRODUCT_NAME","");e["PRODUCT_ID"]=this.getSetting("PRODUCT_ID",0);e["QUANTITY"]=this.getSetting("QUANTITY",0).toFixed(4);e["MEASURE_CODE"]=this.getSetting("MEASURE_CODE",0);e["MEASURE_NAME"]=this.getSetting("MEASURE_NAME","");e["PRICE"]=this.getSetting("PRICE",0).toFixed(2);e["PRICE_EXCLUSIVE"]=this.getSetting("PRICE_EXCLUSIVE",0).toFixed(2);e["PRICE_NETTO"]=this.getSetting("PRICE_NETTO",0).toFixed(2);e["PRICE_BRUTTO"]=this.getSetting("PRICE_BRUTTO",0).toFixed(2);e["DISCOUNT_TYPE_ID"]=this.getDiscountTypeId();var i=this.getSetting("DISCOUNT_RATE",null);if(i!==null){e["DISCOUNT_RATE"]=i.toFixed(2)}var s=this.getSetting("DISCOUNT_SUM",null);if(s!==null){e["DISCOUNT_SUM"]=s.toFixed(2)}e["TAX_RATE"]=this.getSetting("TAX_RATE",0).toFixed(2);e["TAX_INCLUDED"]=this.getSetting("TAX_INCLUDED",false)?"Y":"N";e["CUSTOMIZED"]="Y";e["SORT"]=parseInt(this.getSetting("SORT",0));return JSON.stringify(e)},processFieldValueChange:function(t){var e,i,s,n,r,a,o;var l=this.getDiscountTypeId();if(t!=="DISCOUNT_SUM"&&t!=="DISCOUNT_RATE"&&t!=="DISCOUNT_SUBTOTAL"&&t!=="DISCOUNT_TYPE_ID"&&t!=="TAX_RATE"&&t!=="TAX_INCLUDED"&&t!=="PRICE_BRUTTO"&&t!=="PRICE_NETTO"&&t!=="QUANTITY"&&t!=="MEASURE_CODE"&&t!=="SUM"){return}if(t==="DISCOUNT_TYPE_ID"){this._settings["DISCOUNT_TYPE_ID"]=parseInt(this._fieldValue["DISCOUNT_TYPE_ID"]);if(parseInt(this._fieldValue[t])===BX.CrmDiscountType.monetary){n=this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"];this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);this._settings["DISCOUNT_SUM"]=this._round(this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]),2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"].toFixed(2));this._settings["DISCOUNT_SUBTOTAL"]=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this.setFieldValue("DISCOUNT_SUBTOTAL",this._settings["DISCOUNT_SUBTOTAL"].toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else{n=this._round(this._calculatePrice(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"],BX.CrmDiscountType.percentage),2);this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_SUM"]=this._round(this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]),2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"].toFixed(2));s=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}}if(t==="QUANTITY"){this._settings["QUANTITY"]=this._parseFloat(this._fieldValue[t],4,0);s=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum())}else if(t==="MEASURE_CODE"){this._settings["MEASURE_CODE"]=parseInt(this._fieldValue[t]);this._settings["MEASURE_NAME"]=this._fieldValue["MEASURE_NAME"]=this.getMeasureNameByCode(this._settings["MEASURE_CODE"])}else if(t==="PRICE_BRUTTO"||t==="PRICE_NETTO"){if(t==="PRICE_BRUTTO"){this._settings["PRICE_BRUTTO"]=this._parseFloat(this._fieldValue[t],2,0);this._settings["PRICE_NETTO"]=this._round(BX.CrmProduct.calculateExclusivePrice(this._settings["PRICE_BRUTTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"])}else{this._settings["PRICE_NETTO"]=this._parseFloat(this._fieldValue[t],2,0);this._settings["PRICE_BRUTTO"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"])}if(this._settings["DISCOUNT_TYPE_ID"]===BX.CrmDiscountType.percentage){if(this._settings["DISCOUNT_RATE"]==0){this._settings["PRICE_EXCLUSIVE"]=this._settings["PRICE_NETTO"];this._settings["PRICE"]=this._settings["PRICE_BRUTTO"];i=0}else{n=this._round(this._calculatePrice(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"],BX.CrmDiscountType.percentage),2);this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);i=this._settings["PRICE_NETTO"]-n}this.setFieldValue("DISCOUNT_SUM",i.toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2))}else if(this._settings["DISCOUNT_TYPE_ID"]===BX.CrmDiscountType.monetary){if(this._settings["DISCOUNT_SUM"]==0){this._settings["PRICE_EXCLUSIVE"]=this._settings["PRICE_NETTO"];this._settings["PRICE"]=this._settings["PRICE_BRUTTO"];this.setFieldValue("DISCOUNT_RATE",0)}else{i=this._settings["DISCOUNT_SUM"];n=this._settings["PRICE_NETTO"]-i;this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this.setFieldValue("DISCOUNT_RATE",this._calculateDiscountRate(this._settings["PRICE_NETTO"],n))}}this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="DISCOUNT_RATE"){this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.percentage;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_RATE"]=this._parseFloat(this._fieldValue[t],2,0);n=this._calculatePrice(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"],BX.CrmDiscountType.percentage);this._settings["PRICE_EXCLUSIVE"]=this._round(n,2);this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this.setFieldValue("DISCOUNT_SUM",this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]).toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="DISCOUNT_SUM"){this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_SUM"]=this._parseFloat(this._fieldValue[t],2,0);n=this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"];this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="TAX_RATE"){if(this._editor.isTaxAllowed()){r=this._settings["TAX_INCLUDED"];this._settings["TAX_RATE"]=this._parseFloat(this._fieldValue[t],2,0);if(r){a=BX.CrmProduct.calculateExclusivePrice(this._settings["PRICE_BRUTTO"],this._settings["TAX_RATE"]);this._settings["PRICE_NETTO"]=this._round(a,2)}else{a=this._settings["PRICE_NETTO"];o=BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]);this._settings["PRICE_BRUTTO"]=this._round(o,2)}e=l===BX.CrmDiscountType.percentage?this._settings["DISCOUNT_RATE"]:this._settings["DISCOUNT_SUM"];n=this._calculatePrice(a,e,l);this._settings["PRICE_EXCLUSIVE"]=this._round(n,2);this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);if(r){if(l===BX.CrmDiscountType.percentage){this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"].toFixed(2));this.setFieldValue("DISCOUNT_SUM",this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]).toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2))}else{this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2))}}else{this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"].toFixed(2))}this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}}else if(t==="TAX_INCLUDED"){if(this._editor.isTaxAllowed()){r=this._settings["TAX_INCLUDED"]=!!this._fieldValue[t];if(!r){this._settings["PRICE_NETTO"]=this._settings["PRICE_BRUTTO"];this._settings["PRICE_BRUTTO"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"].toFixed(2),true)}else{this._settings["PRICE_BRUTTO"]=this._settings["PRICE_NETTO"];this._settings["PRICE_NETTO"]=this._round(BX.CrmProduct.calculateExclusivePrice(this._settings["PRICE_BRUTTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"].toFixed(2),true)}}}else if(t==="DISCOUNT_SUBTOTAL"){this._settings["DISCOUNT_SUBTOTAL"]=this._parseFloat(this._fieldValue[t],2,0);if(this._round(parseFloat(this._settings["QUANTITY"]),4)===0){this._settings["QUANTITY"]=1;this.setFieldValue("QUANTITY",1)}this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_SUM"]=this._round(this._settings["DISCOUNT_SUBTOTAL"]/this._settings["QUANTITY"],2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"].toFixed(2));n=this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"];this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],n),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);this._settings["DISCOUNT_SUBTOTAL"]=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this._fieldValue["DISCOUNT_SUBTOTAL"]=this._settings["DISCOUNT_SUBTOTAL"].toFixed(2);this.setFieldView("DISCOUNT_SUBTOTAL",this._fieldValue["DISCOUNT_SUBTOTAL"]);this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="SUM"){this._settings["SUM"]=this._parseFloat(this._fieldValue[t],2,0);if(this._round(parseFloat(this._settings["QUANTITY"]),4)===0){this._settings["QUANTITY"]=1;this.setFieldValue("QUANTITY",1)}i=this._settings["PRICE_NETTO"]-this._settings["SUM"]/(this._settings["QUANTITY"]*(1+this._settings["TAX_RATE"]/100));i=this._round(i,2);this._settings["PRICE_EXCLUSIVE"]=this._round(this._settings["PRICE_NETTO"]-i,2);this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_EXCLUSIVE"],this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_SUM"]=this._round(i,2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"]);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_EXCLUSIVE"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"].toFixed(2));this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"].toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this._sumValueAfterBlur=this._calculateSumTotal();this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}if(t!=="SUM"){if(this._settings["TAX_INCLUDED"]){this.setFieldValue("SUM",(this._settings["PRICE"]*this._settings["QUANTITY"]).toFixed(2))}else{this.setFieldValue("SUM",this._calculateSumTotal())}}this._editor.calculateTotalsDelayed()},_bindEventsHandlers:function(){var t=this,e=this._container,i=this.getSetting("fields",[]),s,n,r,a,o,l="crm-item-inp-btn";if(this._isEventsBinds)return;for(r=0;r<i.length;r++){s=i[r];n=BX(e.id+"_"+s);if(n){switch(s){case"PRODUCT_NAME":case"QUANTITY":if(s==="PRODUCT_NAME"){o=BX.findNextSibling(n,{class:l});if(o){BX.bind(o,"click",function(e){t._onProductNameButtonClick.apply(t,[this,e])})}}if(s!=="PRODUCT_NAME"||!this._fixProductName){BX.bind(n,"keyup",function(e){t._onElementKeyUp.apply(t,[this,e])});BX.bind(n,"input",function(e){t._onElementChange.apply(t,[this,e])});BX.bind(n,"focus",function(e){t._onElementFocus.apply(t,[this,e])});BX.bind(n,"blur",function(e){t._onElementBlur.apply(t,[this,e])})}break;case"DISCOUNT":var h=[];if(n)h[0]=BX.findChild(n.parentNode,{attr:{class:"crm-item-sale-text"}},true);var d=BX(e.id+"_"+s+"_v");if(d)h[1]=BX.findChild(d.parentNode,{attr:{class:"crm-item-sale-text"}},true);for(a=0;a<h.length;a++){if(h[a])BX.bind(h[a],"click",function(e){t._handleChangeDiscountTypeView.apply(t,[this,e])})}BX.bind(n,"keyup",function(e){t._onElementKeyUp.apply(t,[this,e])});BX.bind(n,"input",function(e){t._onElementChange.apply(t,[this,e])});BX.bind(n,"focus",function(e){t._onElementFocus.apply(t,[this,e])});BX.bind(n,"blur",function(e){t._onElementBlur.apply(t,[this,e])});break;case"MEASURE":case"TAX_RATE":BX.bind(n,"change",function(e){t._onElementChange.apply(t,[this,e])});break;case"TAX_INCLUDED":BX.bind(n,"click",function(e){t._onElementChange.apply(t,[this,e])});break;case"PRICE":case"DISCOUNT_SUBTOTAL":case"SUM":BX.bind(n,"keyup",function(e){t._onElementKeyUp.apply(t,[this,e])});BX.bind(n,"input",function(e){t._onElementChange.apply(t,[this,e])});BX.bind(n,"focus",function(e){t._onElementFocus.apply(t,[this,e])});BX.bind(n,"blur",function(e){t._onElementBlur.apply(t,[this,e])});break}}}this._isEventsBinds=true},_handleDeleteClick:function(t){if(this.isReadOnly()){return}if(this._editor.handleProductDeletion(this)){this.clean();BX.PreventDefault(t)}},refreshCurrencyText:function(){var t,e,i,s,n,r,a;e=this._discountTypeView;if(e===BX.CrmDiscountType.monetary){t=this._container;i=this._editor.getSetting("discountTypeText",[]);s=i[e]?i[e]:"?";n=[];if(r=BX(t.id+"_DISCOUNT"))n[0]=BX.findChild(r.parentNode,{attr:{class:"crm-item-sale-text"}},true);if(a=BX(t.id+"_"+"_DISCOUNT_v"))n[1]=BX.findChild(a.parentNode,{attr:{class:"crm-item-sale-text"}},true);for(var o=0;o<n.length;o++){if(n[o]){n[o].innerHTML=s}}}},createGhostNode:function(){var t=BX.create("DIV",{attrs:{className:"crm-items-table-draggable-item"}});var e=BX.create("DIV",{attrs:{className:"crm-items-table-drag-inner"}});e.style.width=BX.pos(this._container).width+"px";t.appendChild(e);var i=BX.create("TABLE",{attrs:{className:"crm-items-table"}});e.appendChild(i);var s=i.insertRow(-1);s.className="crm-items-table-even-row";var n=s.insertCell(-1);n.className="crm-item-cell crm-item-name";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-view"},children:[BX.create("SPAN",{attrs:{className:"crm-table-name-left"},children:[BX.create("SPAN",{attrs:{className:"crm-item-move-btn"}}),BX.create("SPAN",{attrs:{className:"crm-item-num"},text:this.getRowNumber().toString()+"."})]}),BX.create("SPAN",{attrs:{className:"crm-item-txt-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-item-name-txt"},text:this.getProductName()})]})]}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-price";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-qua";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-unit";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-sale";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-total";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-move";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));return t},_handleChangeDiscountTypeView:function(t,e){if(t&&!this._editor.isInvoiceMode()){var i=this.getDiscountTypeId();if(i===BX.CrmDiscountType.percentage)i=BX.CrmDiscountType.monetary;else i=BX.CrmDiscountType.percentage;if(!this._viewMode)this.setFieldValue("DISCOUNT_TYPE_ID",i,true);if(e)BX.PreventDefault(e)}},_parseFloat:function(t,e,i){if(typeof e==="undefined"){e=2}if(typeof i==="undefined"){i=0}if(!BX.type.isNotEmptyString(t)){return i}t=t.replace(/^\s+|\s+$/g,"");var s=t.indexOf(".");var n=t.indexOf(",");var r=t.indexOf("-")===0;if(s<0&&n>=0){var a=t.substr(0,n);var o=t.length-n-1;if(o>0){a+="."+t.substr(n+1,o)}t=a}t=t.replace(/[^\d\.]+/g,"");var l=parseFloat(t);if(isNaN(l)){l=i}if(r){l=-l}if(e>=0){l=this._round(l,e)}return l},_parseInt:function(t,e){if(typeof e==="undefined"){e=0}if(!BX.type.isNotEmptyString(t)){return e}t=t.replace(/^\s+|\s+$/g,"");var i=t.indexOf("-")===0;var s=parseInt(t.replace(/[^\d]/g,""));if(isNaN(s)){s=e}if(i){s=-s}return s},_round:function(t,e){return BX.CrmProduct.round(t,e)},_calculateDiscountRate:function(t,e){if(t===0){return 0}if(e===0){return t>0?100:-100}return this._round(100*(t-e)/t,2)},_calculateDiscount:function(t,e){return t*e/100},_calculateDiscountByDiscountPrice:function(t,e,i){return 100*t/(100-e)-t},_calculatePrice:function(t,e,i){if(i===BX.CrmDiscountType.percentage){return t-t*e/100}if(i===BX.CrmDiscountType.monetary){return t-e}return 0},_calculateSumTotal:function(){var t=this._settings["TAX_INCLUDED"]?this._settings["PRICE"]*this._settings["QUANTITY"]:BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_EXCLUSIVE"]*this._settings["QUANTITY"],this._settings["TAX_RATE"]);return this._round(t,2)},getTaxSum:function(){var t=this._settings["TAX_INCLUDED"]?this._settings["PRICE"]*this._settings["QUANTITY"]*(1-1/(1+this._settings["TAX_RATE"]/100)):this._settings["PRICE_EXCLUSIVE"]*this._settings["QUANTITY"]*this._settings["TAX_RATE"]/100;return this._round(t,2)},fieldNameByElement:function(t){var e="",i=this._container.id,s=i.length;if(BX.type.isElementNode(t)&&t.id&&s>0&&t.id.length>s+1){e=t.id.substring(s+1)}return e},clearZeroValue:function(t,e){if(t&&BX.type.isElementNode(e)){var i=-1;switch(t){case"PRICE":case"DISCOUNT":case"DISCOUNT_SUBTOTAL":case"SUM":i=2;break;case"QUANTITY":i=4;break}if(i>0){var s=this._parseFloat(e.value,i,0);if(s===0){e.value=""}}}},formatElementValue:function(t,e){if(t&&BX.type.isElementNode(e)){var i=-1;var s=-1;switch(t){case"PRICE":case"DISCOUNT_SUBTOTAL":case"SUM":s=i=2;break;case"QUANTITY":i=4;break;case"DISCOUNT":i=2;if(this._discountTypeView===BX.CrmDiscountType.monetary)s=2;break}if(i>0){var n;if(t==="DISCOUNT_SUBTOTAL")n=this._parseFloat(this._fieldValue["DISCOUNT_SUBTOTAL"],i,0);else n=this._parseFloat(e.value,i,0);if(s>=0)e.value=n.toFixed(s);else e.value=n.toString()}}},_onElementKeyUp:function(t,e){var i=this.fieldNameByElement(t),s;if(i){var n=e.keyCode;if(n===13||n===27||n>=37&&n<=40||n>=112&&n<=123)return;var r=this._editor.isTaxAllowed();var a=i==="TAX_INCLUDED"?!!t.checked:!!this._fieldValue["TAX_INCLUDED"];var o=this._discountTypeView;switch(i){case"PRICE":if(r&&!a)s="PRICE_NETTO";else s="PRICE_BRUTTO";break;case"MEASURE":s="MEASURE_CODE";break;case"DISCOUNT":if(o===BX.CrmDiscountType.percentage)s="DISCOUNT_RATE";else s="DISCOUNT_SUM";break;default:s=i}var l=t.type==="checkbox"?t.checked:t.value;if(this._fieldValue[s]===l)return;this._fieldValue[s]=l;this.setFieldView(s,l);if(i==="PRODUCT_NAME")this._handleProductNameChange(l);this.processFieldValueChange(s)}},_onElementChange:function(t,e){var i=this.fieldNameByElement(t),s;if(i){var n=this._editor.isTaxAllowed();var r=i==="TAX_INCLUDED"?!!t.checked:!!this._fieldValue["TAX_INCLUDED"];var a=this._discountTypeView;switch(i){case"PRICE":if(n&&!r)s="PRICE_NETTO";else s="PRICE_BRUTTO";break;case"MEASURE":s="MEASURE_CODE";break;case"DISCOUNT":if(a===BX.CrmDiscountType.percentage)s="DISCOUNT_RATE";else s="DISCOUNT_SUM";break;default:s=i}var o=t.type==="checkbox"?t.checked:t.value;if(this._fieldValue[s]===o)return;this._fieldValue[s]=o;this.setFieldView(s,o);if(i==="PRODUCT_NAME")this._handleProductNameChange(o);this.processFieldValueChange(s);if(i==="TAX_INCLUDED"&&this._editor.getSetting("taxUniform",true)===true)this._editor.changeTaxIncludedUniform(this,o);this._editor.processProductChange(this)}},_handleProductNameChange:function(t){var e=this._container,i=e?BX(e.id+"_PRODUCT_NAME"):null,s,n,r,a="crm-item-inp-btn",o="crm-item-inp-plus",l="crm-item-inp-arrow",h="34px";if(i){r=BX.findNextSibling(i,{class:a});if(r){n=this.getProductId();s=BX.util.trim(String(t));if(s.length>0){if(n>0){BX.removeClass(r,o);BX.addClass(r,l);r.setAttribute("title",BX.CrmProductEditorMessages["openProductCard"]);r.parentNode.style.paddingRight=h}else{BX.removeClass(r,l);if(this._editor.getSetting("canAddProduct",false)){BX.addClass(r,o);r.setAttribute("title",BX.CrmProductEditorMessages["createProduct"]);r.parentNode.style.paddingRight=h}else{r.setAttribute("title","");r.parentNode.style.paddingRight=0}}}else{this.setProductId(0);BX.removeClass(r,l+" "+o);r.setAttribute("title","");r.parentNode.style.paddingRight=0}}}},_emulateTaxIncludedElementChange:function(t){var e="TAX_INCLUDED",i=this._container,s=BX(i.id+"_"+e);if(s){t=!!t;if(s.checked!==t){s.checked=t;this._fieldValue[e]=t;this.setFieldView(e,t);this.processFieldValueChange(e)}}},_onElementFocus:function(t,e){var i=this.fieldNameByElement(t);if(i){this._focusedField=i;if(i==="PRODUCT_NAME"||i==="PRICE"||i==="QUANTITY"||i==="DISCOUNT"||i==="DISCOUNT_SUBTOTAL"||i==="SUM"){this._editor.handleProductFocusChange(this,true)}this.clearZeroValue(i,t)}},_onElementBlur:function(t,e){var i=this.fieldNameByElement(t);if(i){if(this._focusedField===i)this._focusedField=null;if(i==="PRODUCT_NAME"||i==="PRICE"||i==="QUANTITY"||i==="DISCOUNT"||i==="DISCOUNT_SUBTOTAL"||i==="SUM"){if(i==="SUM"&&this._sumValueAfterBlur!==null){this.setFieldValue("SUM",this._sumValueAfterBlur);this._sumValueAfterBlur=null}this._editor.handleProductFocusChange(this,false)}this.formatElementValue(i,t)}},_onProductNameButtonClick:function(t,e){if(BX.hasClass(t,"crm-item-inp-arrow")){var i=this._getProductShowUrl();if(i)window.open(i)}else if(BX.hasClass(t,"crm-item-inp-plus")){this.createInCatalogViaDialog(BX.type.isDomNode(t)?t:null)}},_getProductShowUrl:function(){var t=null,e,i;if(this._editor){e=this._editor.getPathToProductShow();if(e&&typeof e==="string"&&e.length>0){i=parseInt(this.getProductId());if(i>0){t=e.replace("#product_id#",i)}}}return t},createInCatalog:function(){var t,e;var i,s,n;var r,a,o;this.saveSettings();s=0;n=this._editor.getSetting("defaultMeasure",null);if(n){if(n.hasOwnProperty("ID"))s=n["ID"]}i=this.getMeasureIdByCode(this.getMeasureCode());if(i===0)i=s;a=0;o="N";if(this._editor.isTaxAllowed()){r=parseFloat(this.getTaxRate());a=this._editor.getTaxIdByValue(r);o=a!==0&&this.getSetting("TAX_INCLUDED",false)?"Y":"N"}t={NAME:this.getSetting(this._fixProductName?"FIXED_PRODUCT_NAME":"PRODUCT_NAME",""),DESCRIPTION:"",ACTIVE:"Y",CURRENCY:this._editor.getCurrencyId(),PRICE:o==="Y"?this.getSetting("PRICE_BRUTTO",0).toFixed(2):this.getSetting("PRICE_NETTO",0).toFixed(2),MEASURE:i,VAT_ID:a,VAT_INCLUDED:o,SECTION_ID:0,SORT:100,sessid:this._editor.getSetting("sessid",""),ajax:"Y"};e=String(this._editor.getSetting("pathToProductEdit","")).replace("#product_id#","0");BX.ajax({url:e,method:"POST",dataType:"json",data:t,onsuccess:BX.delegate(this.onCreateInCatalogSuccess,this),onfailure:BX.delegate(this.onCreateInCatalogFailure,this)})},onCreateInCatalogSuccess:function(t){var e=0,i="",s,n,r,a="crm-item-inp-btn",o="crm-item-inp-plus",l="crm-item-inp-arrow",h="34px";BX.closeWait();i=t["err"]!==""?t["err"]:"";e=parseInt(t["productId"])>0?parseInt(t["productId"]):0;if(e>0){this.setProductId(e);s=this._container;n=s?BX(s.id+"_PRODUCT_NAME"):null;if(n){r=BX.findNextSibling(n,{class:a});if(r){BX.removeClass(r,o);BX.addClass(r,l);r.setAttribute("title",BX.CrmProductEditorMessages["openProductCard"]);r.parentNode.style.paddingRight=h}}}},onCreateInCatalogFailure:function(t){},createInCatalogViaDialog:function(t){var e,i,s;var n,r,a;var o,l,h;this.saveSettings();r=0;a=this._editor.getSetting("defaultMeasure",null);if(a){if(a.hasOwnProperty("ID"))r=a["ID"]}n=this.getMeasureIdByCode(this.getMeasureCode());if(n===0)n=r;l=0;h="N";if(this._editor.isTaxAllowed()){o=parseFloat(this.getTaxRate());l=this._editor.getTaxIdByValue(o);h=l!==0&&this.getSetting("TAX_INCLUDED",false)?"Y":"N"}s={NAME:this.getSetting(this._fixProductName?"FIXED_PRODUCT_NAME":"PRODUCT_NAME",""),CURRENCY:this._editor.getCurrencyId(),PRICE:h==="Y"?this.getSetting("PRICE_BRUTTO",0).toFixed(2):this.getSetting("PRICE_NETTO",0).toFixed(2),MEASURE:n,VAT_ID:l,VAT_INCLUDED:h};i=BX.clone(this._editor._settings["productCreateDialogSettings"]);i["initialControl"]=t;i["productAdditionHandler"]=BX.delegate(this.handleSetProductFromDialog,this);i["customValues"]=s;e=new BX.CrmProductCreateDialog(i);e.show()},handleSetProductFromDialog:function(t){var e=typeof t["product"]!="undefined"&&typeof t["product"][0]!="undefined"?t["product"][0]:null;if(!e)return;this.saveSettings();var i=this._editor;var s=this.getQuantity();var n=this.getDiscountTypeId();var r=n===BX.CrmDiscountType.percentage?this.getDiscountRate():this.getDiscountSum();i.handleProductSearchSelect(this,e);this.setFieldValue("DISCOUNT_TYPE_ID",parseInt(n));if(n===BX.CrmDiscountType.percentage)this.setFieldValue("DISCOUNT_RATE",this._round(parseFloat(r),2),true);else this.setFieldValue("DISCOUNT_SUM",parseFloat(r).toFixed(2),true);this.setFieldValue("QUANTITY",s,true)}};BX.CrmProduct.calculateExclusivePrice=function(t,e){return t/(1+e/100)};BX.CrmProduct.calculateInclusivePrice=function(t,e){return t*(1+e/100)};BX.CrmProduct.round=function(t,e){if(!BX.type.isNumber(e)){e=2}var i=Math.pow(10,e);return Math.round(t*i)/i};BX.CrmProduct.create=function(t,e,i){var s=new BX.CrmProduct;s.initialize(t,e,i);return s}}if(typeof BX.CrmProductSearch==="undefined"){BX.CrmProductSearch=function(){this._product=null;this._settings={};this.cache=[];this.cache_key=null;this._data=[];this.currentValue="";this.currentRow=-1;this.RESULT=null;this.CONTAINER=null;this.INPUT=null;this.WAIT=null;this._handleOnChange=true;this._onChangeTimer=null;this.focused=false};BX.CrmProductSearch.prototype={initialize:function(t,e){this._product=e;this._settings={AJAX_PAGE:t["AJAX_PAGE"],CONTAINER_ID:t["CONTAINER_ID"],INPUT_ID:t["INPUT_ID"],MIN_QUERY_LEN:parseInt(t["MIN_QUERY_LEN"])};if(t["WAIT_IMAGE"])this._settings["WAIT_IMAGE"]=t["WAIT_IMAGE"];if(this._settings["MIN_QUERY_LEN"]<=0)this._settings["MIN_QUERY_LEN"]=3;this.CONTAINER=document.getElementById(this._settings["CONTAINER_ID"]);this.RESULT=document.body.appendChild(document.createElement("DIV"));this.RESULT.className="title-search-result";this.INPUT=document.getElementById(this._settings["INPUT_ID"]);this.currentValue=this.oldValue=this.INPUT.value;BX.bind(this.INPUT,"focus",BX.delegate(this.onFocusGain,this));BX.bind(this.INPUT,"blur",BX.delegate(this.onFocusLost,this));BX.bind();this.INPUT.onkeydown=BX.delegate(this.onKeyDown,this);if(this._settings["WAIT_IMAGE"]){this.WAIT=document.body.appendChild(document.createElement("DIV"));this.WAIT.style.backgroundImage="url('"+this._settings["WAIT_IMAGE"]+"')";if(!BX.browser.IsIE())this.WAIT.style.backgroundRepeat="none";this.WAIT.style.display="none";this.WAIT.style.position="absolute";this.WAIT.style.zIndex="1100"}BX.bind(this.INPUT,"bxchange",BX.delegate(this.onChangeDelayed,this))},showResult:function(t){var e=BX.pos(this.CONTAINER);e.width=e.right-e.left;this.RESULT.style.position="absolute";this.RESULT.style.top=e.bottom+2+"px";this.RESULT.style.left=e.left+"px";this.RESULT.style.width=e.width+"px";if(t!=null)this.RESULT.innerHTML=t;if(this.RESULT.innerHTML.length>0&&this.INPUT.value!==this.currentValue&&this.focused)this.RESULT.style.display="block";else this.RESULT.style.display="none";var i;var s=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);if(s)i=BX.findChild(s,{tag:"th"},true);if(i){var n=BX.pos(s);n.width=n.right-n.left;var r=BX.pos(i);r.width=r.right-r.left;i.style.width=r.width+"px";this.RESULT.style.width=e.width+r.width+"px";this.RESULT.style.left=e.left-r.width-1+"px";if(n.width-r.width>e.width)this.RESULT.style.width=e.width+r.width-1+"px";n=BX.pos(s);var a=BX.pos(this.RESULT);if(a.right>n.right){this.RESULT.style.width=n.right-n.left+"px"}}var o;if(s)o=BX.findChild(this.RESULT,{class:"title-search-fader"},true);if(o&&i){a=BX.pos(this.RESULT);o.style.left=a.right-a.left-18+"px";o.style.width=18+"px";o.style.top=0+"px";o.style.height=a.bottom-a.top+"px";o.style.display="block"}},onKeyPress:function(t){var e=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);if(!e)return false;var i=e.rows.length,s;switch(t){case 27:this.RESULT.style.display="none";this.currentRow=-1;this.unselectAll();this.currentValue=this.INPUT.oldValue=this.INPUT.value;return true;case 40:if(this.RESULT.style.display=="none")this.RESULT.style.display="block";var n=-1;for(s=0;s<i;s++){if(!BX.findChild(e.rows[s],{class:"title-search-separator"},true)){if(n==-1)n=s;if(this.currentRow<s){this.currentRow=s;break}else if(e.rows[s].className=="title-search-selected"){e.rows[s].className=""}}}if(s==i&&this.currentRow!=s)this.currentRow=n;e.rows[this.currentRow].className="title-search-selected";return true;case 38:if(this.RESULT.style.display=="none")this.RESULT.style.display="block";var r=-1;for(s=i-1;s>=0;s--){if(!BX.findChild(e.rows[s],{class:"title-search-separator"},true)){if(r==-1)r=s;if(this.currentRow>s){this.currentRow=s;break}else if(e.rows[s].className=="title-search-selected"){e.rows[s].className=""}}}if(s<0&&this.currentRow!=s)this.currentRow=r;e.rows[this.currentRow].className="title-search-selected";return true;case 13:if(this.RESULT.style.display=="block"){for(s=0;s<i;s++){if(this.currentRow==s){this.RESULT.style.display="none";this.currentRow=-1;this.unselectAll();this.handleSelectItem(s)}}}return true}return false},onTimeout:function(){this.onChange(function(){setTimeout(BX.delegate(this.onTimeout,this),500)})},onChangeDelayed:function(){if(this._handleOnChange&&this.INPUT.value!=this.oldValue){this.RESULT.style.display="none";this.RESULT.innerHTML="";if(this.INPUT.value.length>=this._settings["MIN_QUERY_LEN"]){this.cache_key=this._settings["INPUT_ID"]+"|"+this.INPUT.value;if(this.cache[this.cache_key]==null){if(this._onChangeTimer)clearTimeout(this._onChangeTimer);this._onChangeTimer=setTimeout(BX.delegate(this.onChange,this),500);return}}this.onChange()}},onChange:function(){if(this._handleOnChange&&this.INPUT.value!=this.oldValue){this.RESULT.style.display="none";this.RESULT.innerHTML="";this.currentValue=null;this.oldValue=this.INPUT.value;if(this.INPUT.value.length>=this._settings["MIN_QUERY_LEN"]){this.cache_key=this._settings["INPUT_ID"]+"|"+this.INPUT.value;if(this.cache[this.cache_key]==null){if(this.WAIT){var t=BX.pos(this.INPUT);var e=t.bottom-t.top-2;this.WAIT.style.top=t.top+1+"px";this.WAIT.style.height=e+"px";this.WAIT.style.width=e+"px";this.WAIT.style.left=t.right-e+2+"px";this.WAIT.style.display="block"}var i=this._product._editor.getCurrencyId();BX.ajax({url:this._settings["AJAX_PAGE"],method:"POST",dataType:"json",data:{MODE:"SEARCH",RESULT_WITH_VALUE:"Y",CURRENCY_ID:i,ENABLE_RAW_PRICES:"Y",ENABLE_SEARCH_BY_ID:"N",MULTI:"N",VALUE:this.INPUT.value,LIMIT:5},onsuccess:BX.delegate(this.onProductSearchResponseSuccess,this),onfailure:BX.delegate(this.onProductSearchResponseFailure,this)})}else{var s=this.makeHtmlFromResult(this.cache[this.cache_key]);this.showResult(s);this.currentRow=-1;this.enableMouseEvents()}}else{this.RESULT.style.display="none";this.currentRow=-1;this.unselectAll();this.cache=[]}}},onProductSearchResponseSuccess:function(t){var e,i=t["data"];this.cache_key=this._settings["INPUT_ID"]+"|"+t["searchValue"];this.cache[this.cache_key]=i;if(this.INPUT.value===t["searchValue"]){e=this.makeHtmlFromResult(i);this.showResult(e)}this.currentRow=-1;this.enableMouseEvents();if(this.WAIT)this.WAIT.style.display="none"},onProductSearchResponseFailure:function(t){},makeHtmlFromResult:function(t){var e="",i,s;this._data=[];if(BX.type.isArray(t)&&t.length>0){e+='<table class="title-search-result">';for(s=0;s<t.length;s++){i=t[s];if(i&&i.hasOwnProperty("title")){e+='<tr id="row_'+s+'">';e+='<td class="title-search-item">'+i["title"]+"</td>";e+="</tr>";this._data[s]=i}}e+="</table>"}return e},unselectAll:function(){var t=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);if(t){var e=t.rows.length;for(var i=0;i<e;i++)t.rows[i].className=""}},enableMouseEvents:function(){var t=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);var e=this;if(t){var i=t.rows.length;for(var s=0;s<i;s++)if(!BX.findChild(t.rows[s],{class:"title-search-separator"},true)){t.rows[s].id="row_"+s;t.rows[s].onmouseover=function(t){BX.delegate(e.onMouseOver,e)(this,t)};t.rows[s].onmouseout=function(t){BX.delegate(e.onMouseOut,e)(this,t)};BX.bind(t.rows[s],"click",function(){BX.delegate(e.handleSelectItem,e)(this.id.substr(4))})}}},onMouseOver:function(t,e){if(this.currentRow!=t.id.substr(4)){this.unselectAll();t.className="title-search-selected";this.currentRow=t.id.substr(4)}},onMouseOut:function(t,e){t.className="";this.currentRow=-1},onFocusGain:function(){this.focused=true},onFocusLost:function(){this.focused=false;setTimeout(BX.delegate(this.handleFocusLostTimer,this),250);this.currentValue=this.INPUT.value},handleFocusLostTimer:function(){this.RESULT.style.display="none"},onKeyDown:function(t){if(!t)t=window.event;if(this.RESULT.style.display=="block"){if(this.onKeyPress(t.keyCode))return BX.PreventDefault(t)}},handleSelectItem:function(t){if(this._product&&this._product._editor){var e=this._product._editor;this.disableOnChangeHandler();this.currentValue=this.oldValue=this._data[t]["title"];e.handleProductSearchSelect(this._product,this._data[t]);this.enableOnChangeHandler()}},enableOnChangeHandler:function(){this._handleOnChange=true},disableOnChangeHandler:function(){this._handleOnChange=false}};BX.CrmProductSearch.create=function(t,e){var i=new BX.CrmProductSearch;i.initialize(t,e);return i}}if(typeof BX.CrmProductRowListPlaceholder==="undefined"){BX.CrmProductRowListPlaceholder=function(){this._settings=null;this._node=null;this._editor=null;this._productId="";this._productIndex=-1};BX.CrmProductRowListPlaceholder.prototype={initialize:function(t){this._settings=t?t:{};this._node=this.getSetting("node",null);this._editor=this.getSetting("editor",null);this._productId=this.getSetting("productId","");this._productIndex=parseInt(this.getSetting("productIndex",-1))},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getNode:function(){return this._node},setNode:function(t){this._node=t},getProductId:function(){return this._productId},getProductIndex:function(){return this._productIndex},layout:function(){if(!this._node){throw"CrmProductRowListPlaceholder: The 'node' is not assigned."}var t=this._node;t.height="30px";var e=t.insertCell(-1);e.className="crm-item-cell";e.colSpan=8}};BX.CrmProductRowListPlaceholder.create=function(t){var e=new BX.CrmProductRowListPlaceholder;e.initialize(t);return e}}if(typeof BX.CrmProdoctRowListDragItem==="undefined"){BX.CrmProdoctRowListDragItem=function(){BX.CrmProdoctRowListDragItem.superclass.constructor.apply(this);this._product=null;this._container=null;this._showInDragMode=true;this._ghostWidth=0;this._ghostHeight=0};BX.extend(BX.CrmProdoctRowListDragItem,BX.CrmCustomDragItem);BX.CrmProdoctRowListDragItem.prototype.doInitialize=function(){this._product=this.getSetting("product");if(!this._product){throw"CrmProdoctRowListDragItem: The 'product' parameter is not defined in settings or empty."}this._container=this.getSetting("container");if(!this._container){throw"CrmProdoctRowListDragItem: The 'container' parameter is not defined in settings or empty."}this._showInDragMode=this.getSetting("showInDragMode",true)};BX.CrmProdoctRowListDragItem.prototype.getProduct=function(){return this._product};BX.CrmProdoctRowListDragItem.prototype.createGhostNode=function(){if(this._ghostNode){return this._ghostNode}this._ghostNode=this._product.createGhostNode();document.body.appendChild(this._ghostNode);var t=BX.pos(this._ghostNode);this._ghostWidth=t.width;this._ghostHeight=t.height};BX.CrmProdoctRowListDragItem.prototype.removeGhostNode=function(){if(this._ghostNode){document.body.removeChild(this._ghostNode);this._ghostNode=null}};BX.CrmProdoctRowListDragItem.prototype.getContextId=function(){return BX.CrmProdoctRowListDragItem.contextId};BX.CrmProdoctRowListDragItem.prototype.getContextData=function(){return{contextId:BX.CrmProdoctRowListDragItem.contextId,product:this._product}};BX.CrmProdoctRowListDragItem.prototype.processDragStart=function(){if(!this._showInDragMode){this._product.getContainer().style.display="none";BX.CrmProdoctRowListDragContainer.refresh()}};BX.CrmProdoctRowListDragItem.prototype._onDrag=function(t,e){if(!this._isInDragMode){return}if(this._ghostNode){t+=this._ghostOffset.x;e+=this._ghostOffset.y;var i=BX.pos(this._container);if(t<i.left||t+this._ghostWidth>i.right){t=i.left}if(e<i.top){e=i.top}else if(e>i.bottom){e=i.bottom}this._ghostNode.style.top=e+"px";this._ghostNode.style.left=t+"px"}this._dragNotifier.notify([t,e])};BX.CrmProdoctRowListDragItem.prototype.processDragStop=function(){if(!this._showInDragMode){this._product.getContainer().style.display="";BX.CrmProdoctRowListDragContainer.refresh()}};BX.CrmProdoctRowListDragItem.contextId="product_row_list_item";BX.CrmProdoctRowListDragItem.create=function(t,e){var i=new BX.CrmProdoctRowListDragItem;i.initialize(t,e);return i}}if(typeof BX.CrmProdoctRowListDragContainer==="undefined"){BX.CrmProdoctRowListDragContainer=function(){BX.CrmProdoctRowListDragContainer.superclass.constructor.apply(this);this._editor=null};BX.extend(BX.CrmProdoctRowListDragContainer,BX.CrmCustomDragContainer);BX.CrmProdoctRowListDragContainer.prototype.doInitialize=function(){this._editor=this.getSetting("editor");if(!this._editor){throw"CrmProdoctRowListDragContainer: The 'editor' parameter is not defined in settings or empty."}};BX.CrmProdoctRowListDragContainer.prototype.getEditor=function(){return this._editor};BX.CrmProdoctRowListDragContainer.prototype.createPlaceHolder=function(t){var e;var i=this._editor.getPlaceHolder();if(i){e=BX.pos(i.getNode());if(t.y>=e.top&&t.y<=e.bottom){return}}var s="";var n=-1;var r=this._editor.getProducts();for(var a=0;a<r.length;a++){var o=r[a];e=BX.pos(o.getContainer());if(t.y>=e.top&&t.y<=e.bottom){if(e.top+e.height/2-t.y>=0){s=o.getId();n=a}else if(a<r.length-1){s=r[a+1].getId();n=a+1}break}}this._editor.createPlaceHolder({id:s,index:n})};BX.CrmProdoctRowListDragContainer.prototype.removePlaceHolder=function(){this._editor.removePlaceHolder()};BX.CrmProdoctRowListDragContainer.prototype.isAllowedContext=function(t){return t===BX.CrmProdoctRowListDragItem.contextId};BX.CrmProdoctRowListDragContainer.enable=function(t,e){e=parseInt(e);if(e>0){window.setTimeout(function(){BX.CrmProdoctRowListDragContainer.enable(t,0)});return}for(var i in this.items){if(this.items.hasOwnProperty(i)){this.items[i].enable(t)}}};BX.CrmProdoctRowListDragContainer.refresh=function(){for(var t in this.items){if(this.items.hasOwnProperty(t)){this.items[t].refresh()}}};BX.CrmProdoctRowListDragContainer.items={};BX.CrmProdoctRowListDragContainer.create=function(t,e){var i=new BX.CrmProdoctRowListDragContainer;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmProductSearchDialogWindow==="undefined"){BX.CrmProductSearchDialogWindow=function(){this._settings={};this.popup=null;this.random="";this.contentContainer=null;this.zIndex=996;this.jsEventsManager=null;this.pos=null;this.height=0;this.width=0;this.resizeCorner=null};BX.CrmProductSearchDialogWindow.prototype={initialize:function(t){this.random=Math.random().toString().substring(2);this._settings=t?t:{};var e=BX.CrmProductSearchDialogWindow.size;this._settings.width=e.width||this._settings.width||1100;this._settings.height=e.height||this._settings.height||530;this._settings.minWidth=this._settings.minWidth||500;this._settings.minHeight=this._settings.minHeight||800;this._settings.draggable=!!this._settings.draggable||true;this._settings.resizable=!!this._settings.resizable||true;if(typeof this._settings.closeWindowHandler!=="function")this._settings.closeWindowHandler=null;if(typeof this._settings.showWindowHandler!=="function")this._settings.showWindowHandler=null;this.jsEventsManager=BX.Crm[this._settings.jsEventsManagerId]||null;this.contentContainer=BX.create("DIV",{attrs:{className:"crm-catalog",style:"display: block; background-color: #f3f6f7; height: "+this._settings.height+"px; overflow: hidden; width: "+this._settings.width+"px;"}})},_handleCloseDialog:function(t){if(t)t.destroy();this.popup=null;if(this.jsEventsManager){this.jsEventsManager.unregisterEventHandlers("CrmProduct_SelectSection")}if(typeof this._settings.closeWindowHandler==="function")this._settings.closeWindowHandler()},_handleAfterShowDialog:function(t){t.popupContainer.style.position="fixed";t.popupContainer.style.top=parseInt(t.popupContainer.style.top)-BX.GetWindowScrollPos().scrollTop+"px";if(typeof this._settings.showWindowHandler==="function")this._settings.showWindowHandler()},setContent:function(t){if(BX.type.isString(t)&&BX.type.isDomNode(this.contentContainer))this.contentContainer.innerHTML=t},show:function(){BX.ajax({method:"GET",dataType:"html",url:this._settings.content_url,data:{},skipAuthCheck:true,onsuccess:BX.delegate(function(t){this.setContent(t||"&nbsp;");this.showWindow()},this),onfailure:BX.delegate(function(){if(typeof this._settings.showWindowHandler==="function")this._settings.showWindowHandler()},this)})},showWindow:function(){this.popup=new BX.PopupWindow("CrmProductSearchDialogWindow_"+this.random,null,{overlay:{opacity:82},autoHide:false,draggable:this._settings.draggable,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},bindOnResize:false,zIndex:this.zIndex-1100,closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:BX.CrmProductEditorMessages["productSearchDialogTitle"],events:{onPopupClose:BX.delegate(this._handleCloseDialog,this),onAfterPopupShow:BX.delegate(this._handleAfterShowDialog,this)},content:this.contentContainer});if(this.popup.popupContainer){this.resizeCorner=BX.create("SPAN",{attrs:{className:"bx-crm-dialog-resize"},events:{mousedown:BX.delegate(this.resizeWindowStart,this)}});this.popup.popupContainer.appendChild(this.resizeCorner);if(!this._settings.resizable)this.resizeCorner.style.display="none"}this.popup.show()},setResizable:function(t){t=!!t;if(this._settings.resizable!==t){this._settings.resizable=t;if(this.resizeCorner){if(t)this.resizeCorner.style.display="inline-block";else this.resizeCorner.style.display="none"}}},resizeWindowStart:function(t){if(!this._settings.resizable)return;t=t||window.event;BX.PreventDefault(t);this.pos=BX.pos(this.contentContainer);BX.bind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.bind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));if(document.body.setCapture)document.body.setCapture();try{document.onmousedown=false}catch(t){}try{document.body.onselectstart=false}catch(t){}try{document.body.ondragstart=false}catch(t){}try{document.body.style.MozUserSelect="none"}catch(t){}try{document.body.style.cursor="nwse-resize"}catch(t){}},resizeWindowMove:function(t){var e=BX.GetWindowScrollPos();var i=t.clientX+e.scrollLeft;var s=t.clientY+e.scrollTop;BX.CrmProductSearchDialogWindow.size.height=this.height=Math.max(s-this.pos.top,this._settings.minHeight);BX.CrmProductSearchDialogWindow.size.width=this.width=Math.max(i-this.pos.left,this._settings.minWidth);this.contentContainer.style.height=this.height+"px";this.contentContainer.style.width=this.width+"px"},resizeWindowStop:function(t){if(document.body.releaseCapture)document.body.releaseCapture();BX.unbind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.unbind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));try{document.onmousedown=null}catch(t){}try{document.body.onselectstart=null}catch(t){}try{document.body.ondragstart=null}catch(t){}try{document.body.style.MozUserSelect=""}catch(t){}try{document.body.style.cursor="auto"}catch(t){}}};BX.CrmProductSearchDialogWindow.create=function(t){var e=new BX.CrmProductSearchDialogWindow;e.initialize(t);return e};BX.CrmProductSearchDialogWindow.loadCSS=function(t){BX.ajax({method:"GET",dataType:"html",url:t.content_url,data:{},skipAuthCheck:true})};BX.CrmProductSearchDialogWindow.size={width:0,height:0}}if(typeof BX.Crm.PageEventsManagerClass==="undefined"){BX.Crm.PageEventsManagerClass=function(){this._settings={}};BX.Crm.PageEventsManagerClass.prototype={initialize:function(t){this._settings=t?t:{};this.eventHandlers={}},registerEventHandler:function(t,e){if(!this.eventHandlers[t])this.eventHandlers[t]=[];this.eventHandlers[t].push(e);BX.addCustomEvent(this,t,e)},fireEvent:function(t,e){BX.onCustomEvent(this,t,e)},unregisterEventHandlers:function(t){if(this.eventHandlers[t]){for(var e=0;e<this.eventHandlers[t].length;e++){BX.removeCustomEvent(this,t,this.eventHandlers[t][e]);delete this.eventHandlers[t][e]}}}};BX.Crm.PageEventsManagerClass.create=function(t){var e=new BX.Crm.PageEventsManagerClass;e.initialize(t);return e}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:102:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/product_create.min.js?15441274018298";s:6:"source";s:83:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/product_create.js";s:3:"min";s:87:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/product_create.min.js";s:3:"map";s:87:"/bitrix/components/bitrix/crm.product_row.list/templates/.default/product_create.map.js";}"*/
if(typeof BX.CrmProductCreateDialog==="undefined"){BX.CrmProductCreateDialog=function(e){this.settings=e;this.messages=e["messages"];this.random=Math.random().toString().substring(2);this.popupContentId="";this.errorContainerId="";this.popup=null;this.initialControl=this.settings["initialControl"]};BX.CrmProductCreateDialog.prototype={show:function(){var e=this;var t=996;var i=BX.create("TABLE",{attrs:{id:this.random+"_table",cellspacing:"7"}});var r=this.settings["fields"];var a=this.settings["messages"];var s,n,o,l,d,c,p,u,f;var h=[],m,g;f={};u=this.settings["customValues"]&&typeof this.settings["customValues"]==="object";if(u){f=this.settings["customValues"]}m=0;for(var x=0;x<r.length;x++){p=r[x]["value"];if(u&&f.hasOwnProperty(r[x]["textCode"]))p=f[r[x]["textCode"]];if(r[x]["skip"]==="Y")continue;o=r[x]["type"];c=parseInt(r[x]["maxLength"]);l=40;d=4;switch(o){case"select":var b={};if(r[x]["params"]&&typeof r[x]["params"]==="object"){var v=r[x]["params"];for(var B in v){if(v.hasOwnProperty(B))b[B]=v[B]}}b["id"]=this.random+"_"+x;b["className"]="bx-crm-dialog-quick-create-field-select";b["name"]=r[x]["textCode"];s=BX.create("SELECT",{style:{marginLeft:"10px"},attrs:b});this.rebuildSelect(s,r[x]["items"],p);break;case"checkbox":s=BX.create("INPUT",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,type:o,name:r[x]["textCode"]}});s.checked=p==="Y";break;case"textarea":s=BX.create("TEXTAREA",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,className:"bx-crm-dialog-quick-create-field-text-input",type:o,name:r[x]["textCode"],text:BX.util.htmlspecialchars(p),cols:l,rows:d,maxlength:c>0?c:7500}});break;case"custom":var C=BX.processHTML(p);s=BX.create("DIV",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,className:"bx-crm-dialog-quick-create-field-custom"},html:p});var X=[],I=0;for(I=0;I<C["SCRIPT"].length;I++){X[I]={TYPE:C["SCRIPT"][I].isInternal?"SCRIPT":"SCRIPT_EXT",DATA:C["SCRIPT"][I].JS}}g={scripts:X,styles:C["STYLE"]};h[m++]=g;break;default:s=BX.create("INPUT",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,className:"bx-crm-dialog-quick-create-field-text-input",type:o,name:r[x]["textCode"],value:p,size:l,maxlength:c>0?c:255}});break}var T=BX.create("TD");if("Y"===r[x]["required"])T.appendChild(BX.create("SPAN",{attrs:{style:"position: absolute; left: 18px; color: red;"},text:"*"}));T.appendChild(BX.create("SPAN",{text:a[r[x]["textCode"]]+":"}));i.appendChild(BX.create("TR",{children:[T,BX.create("TD",{children:[s]})]}))}var y=BX.create("DIV",{attrs:{id:this.random+"_error",className:"bx-crm-dialog-quick-create-error-wrap"}});var w=BX.create("DIV",{style:{marginLeft:"12px",marginTop:"12px",marginRight:"12px",marginBottom:"12px",minWidth:"600px"},attrs:{id:this.random+"_content"},children:[y,i]});var P=this.settings["url"]?BX.util.trim(this.settings["url"].toString()):"/crm/product/edit/0/";var k=BX.create("FORM",{attrs:{id:this.settings["formId"],name:this.settings["formId"],method:"POST",action:P,enctype:"multipart/form-data"}});var A=BX.create("INPUT",{attrs:{type:"hidden",name:"sessid",value:this.settings["sessid"]}});if(A)k.appendChild(A);A=BX.create("INPUT",{attrs:{type:"hidden",name:"ajaxSubmit",value:"Y"}});if(A)k.appendChild(A);A=BX.create("INPUT",{attrs:{type:"hidden",name:"currencyTo",value:this.settings["ownerCurrencyId"]}});if(A)k.appendChild(A);A=null;k.appendChild(w);var E=new BX.PopupWindow("CrmProductCreateDialog_"+this.random,this.initialControl,{overlay:{opacity:10},autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,zIndex:t-1100,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:this.messages["dialogTitle"],events:{onPopupClose:function(){if(E){E.destroy()}}},content:k,buttons:[new BX.PopupWindowButton({text:this.messages["buttonCreateTitle"],className:"popup-window-button-accept",events:{click:function(){if(E){if(w){e.popupContentId=w.id;e.errorContainerId=y.id;e.popup=E;e.createProduct()}}}}}),new BX.PopupWindowButtonLink({text:this.messages["buttonCancelTitle"],className:"popup-window-button-link-cancel",events:{click:function(){if(E)E.close()}}})]});for(m=0;m<h.length;m++){if(h[m]["scripts"].length>0)BX.evalPack(h[m]["scripts"]);if(h[m]["styles"].length>0)BX.loadCSS(h[m]["styles"])}E.show();if(E.popupContainer)BX.scrollToNode(E.popupContainer)},createProduct:function(){var e=BX(this.settings["formId"]);BX.ajax.submitAjax(e,{method:"POST",processData:false,onsuccess:BX.delegate(function(e){if(e===""){BX.closeWait();this.showAjaxError("")}var t=BX.parseJSON(e,{});if(!t){BX.closeWait();this.showAjaxError("")}var i=0,r="";BX.closeWait();r=t["err"]!==""?t["err"]:"";i=parseInt(t["productId"])>0?parseInt(t["productId"]):0;if(i>0){if(this.popup){this.popup.close();this.popup=null}if(typeof t["productData"]!=="undefined"){var a=t["productData"];if(typeof a["NAME"]!=="undefined"&&typeof a["PRICE"]!=="undefined"&&typeof(this.settings["productAdditionHandler"]==="function")){var s=this.settings["productAdditionHandler"];var n={product:[{id:i,title:a["NAME"],customData:{price:a["PRICE"],tax:{}}}]};if(typeof a["VAT_ID"]!=="undefined")n["product"][0]["customData"]["tax"]["id"]=a["VAT_ID"];if(typeof a["VAT_INCLUDED"]!=="undefined")n["product"][0]["customData"]["tax"]["included"]=a["VAT_INCLUDED"]==="Y";if(t["measureData"]&&typeof t["measureData"]==="object"){var o=t["measureData"];if(o["code"]&&parseInt(o["code"])>0&&o["name"]){n["product"][0]["customData"]["measure"]={code:o["code"],name:o["name"]}}}s(n)}}}else{this.showAjaxError(r)}},this),onfailure:BX.delegate(function(e){BX.closeWait();this.showAjaxError("")},this)})},showAjaxError:function(e){if(e==="")e=this.messages["ajaxError"];var t=BX(this.errorContainerId);if(t){t.innerHTML=e}if(this.popup.popupContainer)BX.scrollToNode(this.popup.popupContainer)},setSelectValue:function(e,t){var i,r;var a=false;var s=!!e.getAttribute("multiple");if(!(t instanceof Array))t=[t];for(i=0;i<e.options.length;i++){for(r in t){if(e.options[i].value==t[r]){if(!a){a=true;e.selectedIndex=i}e.options[i].selected=true;break}}if(!s&&a)break}},rebuildSelect:function(e,t,i){var r,a,s,n;var o=false;var l;if(!(i instanceof Array))i=[i];if(e){l=!!e.getAttribute("multiple");while(r=e.lastChild)e.removeChild(r);for(s=0;s<t.length;s++){a=document.createElement("option");a.value=t[s]["id"];a.innerHTML=BX.util.htmlspecialchars(t[s]["title"]);try{e.add(a,e.options[null])}catch(d){a=document.createElement("option");a.text=t[s]["title"];e.add(a,null)}if(!o||l){for(n=0;n<i.length;n++){if(t[s]["id"]==i[n]){a.selected=true;if(!o){o=true;e.selectedIndex=s}break}}}}}}}}if(typeof addNewTableRow==="undefined"){function addNewTableRow(e,t){var i=document.getElementById(e);var r=i.rows.length;if(t==null)t=r-1;var a=i.rows[t].cells[0].innerHTML;var s=i.insertRow(t+1);var n=s.insertCell(0);var o,l,d,c;c=0;while(true){o=a.indexOf("[n",c);if(o<0)break;l=a.indexOf("]",o);if(l<0)break;d=parseInt(a.substr(o+2,l-o));a=a.substr(0,o)+"[n"+ ++d+"]"+a.substr(l+1);c=o+1}c=0;while(true){o=a.indexOf("__n",c);if(o<0)break;l=a.indexOf("_",o+2);if(l<0)break;d=parseInt(a.substr(o+3,l-o));a=a.substr(0,o)+"__n"+ ++d+"_"+a.substr(l+1);c=l+1}c=0;while(true){o=a.indexOf("__N",c);if(o<0)break;l=a.indexOf("__",o+2);if(l<0)break;d=parseInt(a.substr(o+3,l-o));a=a.substr(0,o)+"__N"+ ++d+"__"+a.substr(l+2);c=l+2}c=0;while(true){o=a.indexOf("xxn",c);if(o<0)break;l=a.indexOf("xx",o+2);if(l<0)break;d=parseInt(a.substr(o+3,l-o));a=a.substr(0,o)+"xxn"+ ++d+"xx"+a.substr(l+2);c=l+2}c=0;while(true){o=a.indexOf("%5Bn",c);if(o<0)break;l=a.indexOf("%5D",o+3);if(l<0)break;d=parseInt(a.substr(o+4,l-o));a=a.substr(0,o)+"%5Bn"+ ++d+"%5D"+a.substr(l+3);c=l+3}var p={html:a};BX.onCustomEvent(window,"onAddNewRowBeforeInner",[p]);a=p.html;n.innerHTML=a;var u=new RegExp("<"+"script"+">[^\x00]*?<"+"/"+"script"+">","ig");var f=a.match(u);if(f){for(var h=0;h<f.length;h++){if(f[h]!=""){o=f[h].substring(8,f[h].length-9);jsUtils.EvalGlobal(o)}}}if(BX&&BX.adminPanel){BX.adminPanel.modifyFormElements(s);BX.onCustomEvent("onAdminTabsChange")}setTimeout(function(){var e=BX.findChildren(n,{tag:/^(input|select|textarea)$/i});if(e&&e.length>0){for(var t=0,i=e.length;t<i;t++){if(e[t].form&&e[t].form.BXAUTOSAVE)e[t].form.BXAUTOSAVE.RegisterInput(e[t]);else break}}},10)}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:82:"/bitrix/components/bitrix/crm.lead.menu/templates/.default/script.js?1544127401481";s:6:"source";s:68:"/bitrix/components/bitrix/crm.lead.menu/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/

function lead_delete(title, message, btnTitle, path)
{
	var d;
	d = new BX.CDialog({
		title: title,
		head: '',
		content: message,
		resizable: false,
		draggable: true,
		height: 70,
		width: 300
	});
	
	var _BTN = [	
		{
			title: btnTitle,
			id: 'crmOk',
			'action': function () 
			{
				window.location.href = path;
				BX.WindowManager.Get().Close();
			}
		},
		BX.CDialog.btnCancel
	];	
	d.ClearButtons();
	d.SetButtons(_BTN);
	d.Show();
}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:94:"/bitrix/components/bitrix/crm.interface.toolbar/templates/slider/script.min.js?154412740112549";s:6:"source";s:74:"/bitrix/components/bitrix/crm.interface.toolbar/templates/slider/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
if(typeof BX.InterfaceToolBar==="undefined"){BX.InterfaceToolBar=function(){this._id="";this._settings=null;this._container=null;this._menuButton=null;this._menuPopup=null;this._isMenuOpened=false};BX.InterfaceToolBar.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:BX.CrmParamBag.create(null);var n=this._container=BX(this.getSetting("containerId",""));if(n){var o=this.getSetting("menuButtonClassName");if(!BX.type.isNotEmptyString(o)){o=this.getSetting("moreButtonClassName","crm-setting-btn")}if(BX.type.isNotEmptyString(o)){this._menuButton=BX.findChild(n,{className:o},true,false);if(this._menuButton){BX.bind(this._menuButton,"click",BX.delegate(this.onMenuButtonClick,this))}}}},getId:function(){return this._id},getSetting:function(t,e){return this._settings.getParam(t,e)},prepareMenuItem:function(t){var e=/return\s+false(\s*;)?\s*$/;var n=/;\s*$/;var o=typeof t["SEPARATOR"]!=="undefined"?t["SEPARATOR"]:false;if(o){return{delimiter:true}}var i=typeof t["LINK"]!=="undefined"?t["LINK"]:"";var r=typeof t["ONCLICK"]!=="undefined"?t["ONCLICK"]:"";if(i!==""){var s='window.top.location.href = "'+i+'";';r=r!==""?s+" "+r:s}if(r!==""){if(!e.test(r)){if(!n.test(r)){r+=";"}r+=" return false;"}}var a={text:typeof t["TEXT"]!=="undefined"?t["TEXT"]:""};if(r!==""){a["onclick"]=r}if(BX.type.isArray(t["MENU"])){var u=[];for(var p=0,l=t["MENU"].length;p<l;p++){u.push(this.prepareMenuItem(t["MENU"][p]))}a["items"]=u}return a},openMenu:function(t){if(this._isMenuOpened){this.closeMenu();return}var e=this.getSetting("items",null);if(!BX.type.isArray(e)){return}var n=[];for(var o=0;o<e.length;o++){n.push(this.prepareMenuItem(e[o]))}BX.onCustomEvent(window,"Crm.InterfaceToolbar.MenuBuild",[this,{items:n}]);this._menuId=this._id.toLowerCase()+"_menu";BX.PopupMenu.show(this._menuId,this._menuButton,n,{autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:0,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._menuPopup=BX.PopupMenu.currentItem},closeMenu:function(){if(this._menuPopup){if(this._menuPopup.popupWindow){this._menuPopup.popupWindow.destroy()}}},onMenuButtonClick:function(t){this.openMenu()},onPopupShow:function(){this._isMenuOpened=true},onPopupClose:function(){this.closeMenu()},onPopupDestroy:function(){this._isMenuOpened=false;this._menuPopup=null;if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){delete BX.PopupMenu.Data[this._menuId]}},onEditorConfigReset:function(){var t=BX.Crm.EntityEditor.getDefault();if(t){t.resetConfig()}}};BX.InterfaceToolBar.create=function(t,e){var n=new BX.InterfaceToolBar;n.initialize(t,e);return n}}if(typeof BX.InterfaceToolBarCommunicationButton==="undefined"){BX.InterfaceToolBarCommunicationButton=function(){this._id="";this._settings=[];this._button=null;this._ownerInfo=null;this._isMenuOpened=false;this._menuPopup=null;this._menuId="";this._data=null;this._isEnabled=false};BX.InterfaceToolBarCommunicationButton.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._button=BX.prop.getElementNode(this._settings,"button");BX.bind(this._button,"click",BX.delegate(this.onButtonClick,this));this._ownerInfo=BX.prop.getObject(this._settings,"ownerInfo",{});this._data=BX.prop.getObject(this._settings,"data",{});this._isEnabled=this.hasData();BX.addCustomEvent(window,"onCrmEntityUpdate",BX.delegate(this.onCrmEntityUpdate,this))},getOwnerInfo:function(){return{ownerID:this._ownerInfo["ENTITY_ID"],ownerType:this._ownerInfo["ENTITY_TYPE_NAME"],ownerUrl:this._ownerInfo["SHOW_URL"],ownerTitle:this._ownerInfo["TITLE"]}},getOwnerTypeName:function(){return BX.prop.getString(this._ownerInfo,"ENTITY_TYPE_NAME","")},getOwnerId:function(){return BX.prop.getInteger(this._ownerInfo,"ENTITY_ID",0)},getMultifieldTypeName:function(){return""},hasData:function(){return BX.type.isPlainObject(this._data)&&Object.keys(this._data).length>0},isEnabled:function(){return this._isEnabled},enable:function(t){t=!!t;if(this._isEnabled===t){return}this._isEnabled=t;this.doEnable(this._isEnabled)},doEnable:function(t){},onButtonClick:function(t){},prepareMenuItem:function(t){},openMenu:function(){if(this._isMenuOpened){this.closeMenu();return}var t=[];for(var e in this._data){if(!this._data.hasOwnProperty(e)){continue}var n=this._data[e];for(var o=0;o<n.length;o++){t.push(this.prepareMenuItem(e,n[o]))}}this._menuId=this._id.toLowerCase()+"_menu";BX.PopupMenu.show(this._menuId,this._button,t,{offsetTop:0,offsetLeft:0,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._menuPopup=BX.PopupMenu.currentItem},closeMenu:function(){if(this._menuPopup){if(this._menuPopup.popupWindow){this._menuPopup.popupWindow.destroy()}}},onPopupShow:function(){this._isMenuOpened=true},onPopupClose:function(){this.closeMenu()},onPopupDestroy:function(){this._isMenuOpened=false;this._menuPopup=null;if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){delete BX.PopupMenu.Data[this._menuId]}},onCrmEntityUpdate:function(t){var e=BX.prop.getObject(t,"entityInfo",{});if(this.getOwnerTypeName()!==BX.prop.getString(e,"typeName","")||this.getOwnerId()!==BX.prop.getInteger(e,"id",0)){return}var n=BX.prop.getObject(t,"entityData",{});this._data=BX.prop.getObject(BX.prop.getObject(n,"MULTIFIELD_DATA",{}),this.getMultifieldTypeName(),{});this.enable(this.hasData());this.processDataChange()},processDataChange:function(){}}}if(typeof BX.InterfaceToolBarPhoneButton==="undefined"){BX.InterfaceToolBarPhoneButton=function(){BX.InterfaceToolBarPhoneButton.superclass.constructor.apply(this);this._menuItems=null};BX.extend(BX.InterfaceToolBarPhoneButton,BX.InterfaceToolBarCommunicationButton);BX.InterfaceToolBarPhoneButton.prototype.getMessage=function(t){var e=BX.InterfaceToolBarPhoneButton.messages;return e.hasOwnProperty(t)?e[t]:t};BX.InterfaceToolBarPhoneButton.prototype.onButtonClick=function(t){if(!this.isEnabled()){return}var e=Object.keys(this._data);if(e.length===1){var n=e[0];var o=this._data[n];if(o.length===1){var i=n.split("_");if(i.length>=2){this.addCall(n,o[0]);return}}}this._menuItems=[];this.openMenu()};BX.InterfaceToolBarPhoneButton.prototype.prepareMenuItem=function(t,e){var n;var o;if(BX.type.isPlainObject(e)){n=BX.prop.getString(e,"COMPLEX_NAME","")+": "+BX.prop.getString(e,"VALUE_FORMATTED","");o=BX.prop.getString(e,"VALUE","")}else{n=e;o=e}var i=BX.InterfaceToolBarPhoneMenuItem.create({owner:this,entityKey:t,value:o,text:n});this._menuItems.push(i);return i.createMenuItem()};BX.InterfaceToolBarPhoneButton.prototype.addCall=function(t,e){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("telephonyNotSupported"));return}var n=t.split("_");if(n.length<2){return}var o=BX.type.stringToInt(n[0]);var i=BX.type.stringToInt(n[1]);var r=BX.prop.getInteger(this._ownerInfo,"ENTITY_TYPE_ID",0);var s=BX.prop.getInteger(this._ownerInfo,"ENTITY_ID",0);var a=BX.type.isPlainObject(e)?e["VALUE"]:e;var u={ENTITY_TYPE_NAME:BX.CrmEntityType.resolveName(o),ENTITY_ID:i,AUTO_FOLD:true};if(r!==o||s!==i){u["BINDINGS"]=[{OWNER_TYPE_NAME:BX.CrmEntityType.resolveName(r),OWNER_ID:s}]}window.top["BXIM"].phoneTo(a,u)};BX.InterfaceToolBarPhoneButton.prototype.getMultifieldTypeName=function(){return"PHONE"};BX.InterfaceToolBarPhoneButton.prototype.doEnable=function(t){if(t){BX.removeClass(this._button,"crm-contact-menu-call-icon-not-available");BX.addClass(this._button,"crm-contact-menu-call-icon")}else{BX.removeClass(this._button,"crm-contact-menu-call-icon");BX.addClass(this._button,"crm-contact-menu-call-icon-not-available")}};if(typeof BX.InterfaceToolBarPhoneButton.messages==="undefined"){BX.InterfaceToolBarPhoneButton.messages={}}BX.InterfaceToolBarPhoneButton.create=function(t,e){var n=new BX.InterfaceToolBarPhoneButton;n.initialize(t,e);return n}}if(typeof BX.InterfaceToolBarPhoneMenuItem==="undefined"){BX.InterfaceToolBarPhoneMenuItem=function(){this._settings={};this._entityKey="";this._value="";this._text=""};BX.InterfaceToolBarPhoneMenuItem.prototype={initialize:function(t){this._settings=t?t:{};this._owner=BX.prop.get(this._settings,"owner");this._entityKey=BX.prop.getString(this._settings,"entityKey","");this._value=BX.prop.getString(this._settings,"value","");this._text=BX.prop.getString(this._settings,"text","")},onSelect:function(){this._owner.addCall(this._entityKey,this._value)},createMenuItem:function(){return{text:this._text,onclick:BX.delegate(this.onSelect,this)}}};BX.InterfaceToolBarPhoneMenuItem.create=function(t){var e=new BX.InterfaceToolBarPhoneMenuItem;e.initialize(t);return e}}if(typeof BX.InterfaceToolBarMessengerButton==="undefined"){BX.InterfaceToolBarMessengerButton=function(){BX.InterfaceToolBarMessengerButton.superclass.constructor.apply(this);this._menuItems=null};BX.extend(BX.InterfaceToolBarMessengerButton,BX.InterfaceToolBarCommunicationButton);BX.InterfaceToolBarMessengerButton.prototype.getMessage=function(t){var e=BX.InterfaceToolBarMessengerButton.messages;return e.hasOwnProperty(t)?e[t]:t};BX.InterfaceToolBarMessengerButton.prototype.onButtonClick=function(t){var e=Object.keys(this._data);if(e.length===1){var n=e[0];var o=this._data[n];if(o.length===1){var i=n.split("_");if(i.length>=2){this.openChat(n,o[0]);return}}}this._menuItems=[];this.openMenu()};BX.InterfaceToolBarMessengerButton.prototype.prepareMenuItem=function(t,e){var n;var o;if(BX.type.isPlainObject(e)){o=BX.prop.getString(e,"VALUE","");var i=BX.prop.getString(e,"VALUE_TYPE","");if(i==="OPENLINE"){n=BX.prop.getString(e,"COMPLEX_NAME","")}else{n=BX.prop.getString(e,"COMPLEX_NAME","")+": "+BX.prop.getString(e,"VALUE_FORMATTED","")}}else{n=e;o=e}var r=BX.InterfaceToolBarMessengerMenuItem.create({owner:this,entityKey:t,value:o,text:n});this._menuItems.push(r);return r.createMenuItem()};BX.InterfaceToolBarMessengerButton.prototype.openChat=function(t,e){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("messagingNotSupported"));return}var n=BX.type.isPlainObject(e)?e["VALUE"]:e;window.top["BXIM"].openMessengerSlider(n,{RECENT:"N",MENU:"N"})};BX.InterfaceToolBarMessengerButton.prototype.getMultifieldTypeName=function(){return"IM"};BX.InterfaceToolBarMessengerButton.prototype.doEnable=function(t){if(t){BX.removeClass(this._button,"crm-contact-menu-im-icon-not-available");BX.addClass(this._button,"crm-contact-menu-im-icon")}else{BX.removeClass(this._button,"crm-contact-menu-im-icon");BX.addClass(this._button,"crm-contact-menu-im-icon-not-available")}};if(typeof BX.InterfaceToolBarMessengerButton.messages==="undefined"){BX.InterfaceToolBarMessengerButton.messages={}}BX.InterfaceToolBarMessengerButton.create=function(t,e){var n=new BX.InterfaceToolBarMessengerButton;n.initialize(t,e);return n}}if(typeof BX.InterfaceToolBarMessengerMenuItem==="undefined"){BX.InterfaceToolBarMessengerMenuItem=function(){this._settings={};this._entityKey="";this._value="";this._text=""};BX.InterfaceToolBarMessengerMenuItem.prototype={initialize:function(t){this._settings=t?t:{};this._owner=BX.prop.get(this._settings,"owner");this._entityKey=BX.prop.getString(this._settings,"entityKey","");this._value=BX.prop.getString(this._settings,"value","");this._text=BX.prop.getString(this._settings,"text","")},onSelect:function(){this._owner.openChat(this._entityKey,this._value)},createMenuItem:function(){return{text:this._text,onclick:BX.delegate(this.onSelect,this)}}};BX.InterfaceToolBarMessengerMenuItem.create=function(t){var e=new BX.InterfaceToolBarMessengerMenuItem;e.initialize(t);return e}}if(typeof BX.InterfaceToolBarEmailButton==="undefined"){BX.InterfaceToolBarEmailButton=function(){BX.InterfaceToolBarEmailButton.superclass.constructor.apply(this)};BX.extend(BX.InterfaceToolBarEmailButton,BX.InterfaceToolBarCommunicationButton);BX.InterfaceToolBarEmailButton.prototype.onButtonClick=function(t){if(this.isEnabled()){BX.CrmActivityEditor.addEmail(this.getOwnerInfo())}};BX.InterfaceToolBarEmailButton.prototype.getMultifieldTypeName=function(){return"EMAIL"};BX.InterfaceToolBarEmailButton.prototype.doEnable=function(t){if(t){BX.removeClass(this._button,"crm-contact-menu-mail-icon-not-available");BX.addClass(this._button,"crm-contact-menu-mail-icon")}else{BX.removeClass(this._button,"crm-contact-menu-mail-icon");BX.addClass(this._button,"crm-contact-menu-mail-icon-not-available")}};BX.InterfaceToolBarEmailButton.create=function(t,e){var n=new BX.InterfaceToolBarEmailButton;n.initialize(t,e);return n}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:93:"/bitrix/components/bitrix/crm.entity.details/templates/.default/script.min.js?154412740123674";s:6:"source";s:73:"/bitrix/components/bitrix/crm.entity.details/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Crm");if(typeof BX.Crm.EntityDetailManager==="undefined"){BX.Crm.EntityDetailManager=function(){this._id="";this._settings={};this._container=null;this._entityTypeId=0;this._entityId=0;this._serviceUrl="";this._tabManager=null;this._overlay=null;this._pageUrlCopyButton=null;this._externalEventHandler=null;this._externalRequestData=null};BX.Crm.EntityDetailManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._container=BX(BX.prop.get(this._settings,"containerId"));this._tabManager=BX.Crm.EntityDetailTabManager.create(this._id,{container:BX(BX.prop.get(this._settings,"tabContainerId")),menuContainer:BX(BX.prop.get(this._settings,"tabMenuContainerId")),data:BX.prop.getArray(this._settings,"tabs")});if(this._entityId<=0){this._overlay=BX.create("div",{attrs:{className:"crm-entity-overlay"}});this._container.appendChild(this._overlay);if(window===window.top){this._overlay.style.position="absolute";this._overlay.style.top=this._overlay.style.left=this._overlay.style.right="-15px"}}this._pageUrlCopyButton=BX("page_url_copy_btn");if(this._pageUrlCopyButton){this._pageUrlCopyButton.title=this.getMessage("copyPageUrl");BX.bind(this._pageUrlCopyButton,"click",BX.delegate(this.onCopyCurrentPageUrl,this))}BX.addCustomEvent(window,"OpenEntityDetailTab",BX.delegate(this.onTabOpenRequest,this));this._externalRequestData={};this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler);this.doInitialize()},doInitialize:function(){},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityDetailManager.messages,t,t)},getEntityTypeId:function(){return this._entityTypeId},getEntityTypeName:function(){return BX.CrmEntityType.resolveName(this._entityTypeId)},getEntityId:function(){return this._entityId},getCurrentPageUrl:function(){return BX.util.remove_url_param(window.location.href,["IFRAME","IFRAME_TYPE"])},getEntityListUrl:function(t){return BX.prop.getString(BX.Crm.EntityDetailManager.entityListUrls,t,"")},getEntityCreateUrl:function(t){return BX.CrmEntityManager.getCurrent().getEntityCreateUrl(t)},prepareCreationUrlParams:function(t){},onCopyCurrentPageUrl:function(t){var e=this.getCurrentPageUrl();if(!BX.clipboard.copy(e)){return}var i=new BX.PopupWindow("crm_page_url_clipboard_copy",this._pageUrlCopyButton,{content:this.getMessage("pageUrlCopied"),darkMode:true,autoHide:true,zIndex:1e3,angle:true,offsetLeft:20,bindOptions:{position:"top"}});i.show();setTimeout(function(){i.close()},1500)},onTabOpenRequest:function(t){var e=this._tabManager.findItemById(t);if(e){this._tabManager.selectItem(e)}},processRemoval:function(){this._detetionConfirmDlgId="entity_details_deletion_confirm";var t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("deletionDialogTitle"),content:this.getMessage("deletionConfirmDialogContent")})}t.open().then(BX.delegate(this.onRemovalConfirm,this))},remove:function(){if(this._serviceUrl===""){throw"Crm.EntityDetailManager: The 'serviceUrl' parameter is not defined or empty."}BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"DELETE",ACTION_ENTITY_TYPE_ID:this._entityTypeId,ACTION_ENTITY_ID:this._entityId},onsuccess:BX.delegate(this.onRemovalRequestSuccess,this)})},exclude:function(){if(this._serviceUrl===""){throw"Crm.EntityDetailManager: The 'serviceUrl' parameter is not defined or empty."}BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"EXCLUDE",ACTION_ENTITY_TYPE_ID:this._entityTypeId,ACTION_ENTITY_ID:this._entityId},onsuccess:BX.delegate(this.onExclusionRequestSuccess,this)})},processExclusion:function(){this._exclusionConfirmDlgId="entity_details_exclusion_confirm";var t=BX.Crm.ConfirmationDialog.get(this._exclusionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._exclusionConfirmDlgId,{title:this.getMessage("exclusionDialogTitle"),content:this.getMessage("exclusionConfirmDialogContent")})}t.open().then(BX.delegate(this.onExclusionConfirm,this))},createEntity:function(t,e){var i=("details_"+this.getEntityTypeName()+"_"+this.getEntityId()+"_"+BX.util.getRandomString(12)).toLowerCase();var n={external_context:i};this.prepareCreationUrlParams(n);var r=BX.prop.getObject(e,"urlParams",null);if(r){n=BX.mergeEx(n,r)}BX.CrmEntityManager.createEntity(t,{urlParams:n}).then(function(t){this._externalRequestData[i]={context:i,wnd:BX.prop.get(t,"wnd",null)}}.bind(this))},createQuote:function(){this.createEntity(BX.CrmEntityType.names.quote)},createOrder:function(){this.createEntity(BX.CrmEntityType.names.order)},createInvoice:function(){this.createEntity(BX.CrmEntityType.names.invoice)},createDeal:function(){this.createEntity(BX.CrmEntityType.names.deal)},onRemovalConfirm:function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.remove()},onRemovalRequestSuccess:function(t){var e=BX.prop.getString(t,"ERROR","");if(e!==""){var i=BX.Crm.NotificationDialog.create("entity_details_deletion_error",{title:this.getMessage("deletionDialogTitle"),content:e});i.open();return}var n=BX.Crm.Page.getTopSlider();var r=null;if(n){r={sliderUrl:n.getUrl()}}BX.Crm.EntityEvent.fireDelete(this._entityTypeId,this._entityId,"",r);r["id"]=this._entityId;BX.onCustomEvent(window,BX.Crm.EntityEvent.names.delete,[r]);if(n){window.setTimeout(function(){n.close(true)},100)}else{var a=this.getEntityListUrl(BX.CrmEntityType.resolveName(this._entityTypeId));if(a!==""){window.location.href=a}}},onExclusionConfirm:function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.exclude()},onExclusionRequestSuccess:function(t){var e=BX.prop.getString(t,"ERROR","");if(e!==""){var i=BX.Crm.NotificationDialog.create("entity_details_exclusion_error",{title:this.getMessage("exclusionDialogTitle"),content:e});i.open();return}var n=BX.Crm.Page.getTopSlider();var r=null;if(n){r={sliderUrl:n.getUrl()}}BX.Crm.EntityEvent.fireDelete(this._entityTypeId,this._entityId,"",r);if(n){window.setTimeout(function(){n.close(true)},100)}else{var a=this.getEntityListUrl(BX.CrmEntityType.resolveName(this._entityTypeId));if(a!==""){window.location.href=a}}},onExternalEvent:function(t){var e=BX.prop.getString(t,"key","");var i=BX.prop.getObject(t,"value",{});this.processExternalEvent(e,i);if(e===BX.Crm.EntityEvent.names.invalidate){var n=BX.prop.getInteger(i,"entityId",0);var r=BX.prop.getInteger(i,"entityTypeId",0);if(r===this.getEntityTypeId()&&n===this.getEntityId()){window.location.reload(true)}return}if(e!=="onCrmEntityCreate"){return}var a=BX.prop.getString(i,"context","");var o=BX.prop.getObject(this._externalRequestData,a,null);if(!o){return}delete this._externalRequestData[a];var s=BX.prop.get(o,"wnd",null);if(s){s.close()}},processExternalEvent:function(t,e){return false}};BX.Crm.EntityDetailManager.items={};BX.Crm.EntityDetailManager.get=function(t){return this._items.hasOwnProperty(t)?this._items[t]:null};if(typeof BX.Crm.EntityDetailManager.entityListUrls==="undefined"){BX.Crm.EntityDetailManager.entityListUrls={}}if(typeof BX.Crm.EntityDetailManager.messages==="undefined"){BX.Crm.EntityDetailManager.messages={}}BX.Crm.EntityDetailManager.create=function(t,e){var i=new BX.Crm.EntityDetailManager;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.LeadDetailManager==="undefined"){BX.Crm.LeadDetailManager=function(){BX.Crm.LeadDetailManager.superclass.constructor.apply(this)};BX.extend(BX.Crm.LeadDetailManager,BX.Crm.EntityDetailManager);BX.Crm.LeadDetailManager.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityConverter.Converted",BX.delegate(this.onConversionComplete,this));BX.addCustomEvent(window,"Crm.EntityProgress.Saved",BX.delegate(this.onProgressSave,this));BX.addCustomEvent(window,"CrmCreateQuoteFromLead",BX.delegate(this.onCreateQuote,this));BX.addCustomEvent(window,"CrmCreateOrderFromLead",BX.delegate(this.onCreateOrder,this))};BX.Crm.LeadDetailManager.prototype.processConversionCompletion=function(t){if(window.top!==window){window.setTimeout(function(){window.location.reload(true)},0);return}var e=BX.prop.getString(t,"redirectUrl","");if(e!==""&&!BX.prop.getBoolean(t,"isRedirected",false)){window.setTimeout(function(){window.location.replace(e)},0);t["isRedirected"]=true}};BX.Crm.LeadDetailManager.prototype.processStatusSave=function(t){var e=BX.prop.getString(t,"currentSemantics","");var i=BX.prop.getString(t,"previousSemantics","");if(i===e){return}if(i==="success"||e==="success"){window.setTimeout(function(){window.location.reload(true)},0)}};BX.Crm.LeadDetailManager.prototype.processExternalEvent=function(t,e){if(t!=="onCrmEntityConvert"){return false}if(BX.prop.getInteger(e,"entityTypeId",0)!==BX.CrmEntityType.enumeration.lead||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return false}this.processConversionCompletion(e);return true};BX.Crm.LeadDetailManager.prototype.onConversionComplete=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==BX.CrmEntityType.enumeration.lead||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}this.processConversionCompletion(e)};BX.Crm.LeadDetailManager.prototype.onProgressSave=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==BX.CrmEntityType.enumeration.lead||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}this.processStatusSave(e)};BX.Crm.LeadDetailManager.prototype.onCreateQuote=function(){this.createQuote()};BX.Crm.LeadDetailManager.prototype.onCreateOrder=function(){this.createOrder()};BX.Crm.LeadDetailManager.prototype.prepareCreationUrlParams=function(t){t["lead_id"]=this.getEntityId()};BX.Crm.LeadDetailManager.create=function(t,e){var i=new BX.Crm.LeadDetailManager;i.initialize(t,e);BX.Crm.EntityDetailManager.items[i.getId()]=i;return i}}if(typeof BX.Crm.ContactDetailManager==="undefined"){BX.Crm.ContactDetailManager=function(){BX.Crm.ContactDetailManager.superclass.constructor.apply(this)};BX.extend(BX.Crm.ContactDetailManager,BX.Crm.EntityDetailManager);BX.Crm.ContactDetailManager.prototype.doInitialize=function(){BX.addCustomEvent(window,"CrmCreateQuoteFromContact",BX.delegate(this.onCreateQuote,this));BX.addCustomEvent(window,"CrmCreateInvoiceFromContact",BX.delegate(this.onCreateInvoice,this));BX.addCustomEvent(window,"CrmCreateDealFromContact",BX.delegate(this.onCreateDeal,this));BX.addCustomEvent(window,"CrmCreateOrderFromContact",BX.delegate(this.onCreateOrder,this))};BX.Crm.ContactDetailManager.prototype.onCreateQuote=function(){this.createQuote()};BX.Crm.ContactDetailManager.prototype.onCreateOrder=function(){this.createOrder()};BX.Crm.ContactDetailManager.prototype.onCreateInvoice=function(){this.createInvoice()};BX.Crm.ContactDetailManager.prototype.onCreateDeal=function(){this.createDeal()};BX.Crm.ContactDetailManager.prototype.prepareCreationUrlParams=function(t){t["contact_id"]=this.getEntityId()};BX.Crm.ContactDetailManager.create=function(t,e){var i=new BX.Crm.ContactDetailManager;i.initialize(t,e);BX.Crm.EntityDetailManager.items[i.getId()]=i;return i}}if(typeof BX.Crm.CompanyDetailManager==="undefined"){BX.Crm.CompanyDetailManager=function(){BX.Crm.CompanyDetailManager.superclass.constructor.apply(this)};BX.extend(BX.Crm.CompanyDetailManager,BX.Crm.EntityDetailManager);BX.Crm.CompanyDetailManager.prototype.doInitialize=function(){BX.addCustomEvent(window,"CrmCreateQuoteFromCompany",BX.delegate(this.onCreateQuote,this));BX.addCustomEvent(window,"CrmCreateInvoiceFromCompany",BX.delegate(this.onCreateInvoice,this));BX.addCustomEvent(window,"CrmCreateDealFromCompany",BX.delegate(this.onCreateDeal,this));BX.addCustomEvent(window,"CrmCreateOrderFromCompany",BX.delegate(this.onCreateOrder,this))};BX.Crm.CompanyDetailManager.prototype.onCreateQuote=function(){this.createQuote()};BX.Crm.CompanyDetailManager.prototype.onCreateOrder=function(){this.createOrder()};BX.Crm.CompanyDetailManager.prototype.onCreateInvoice=function(){this.createInvoice()};BX.Crm.CompanyDetailManager.prototype.onCreateDeal=function(){this.createDeal()};BX.Crm.CompanyDetailManager.prototype.prepareCreationUrlParams=function(t){t["company_id"]=this.getEntityId()};BX.Crm.CompanyDetailManager.create=function(t,e){var i=new BX.Crm.CompanyDetailManager;i.initialize(t,e);BX.Crm.EntityDetailManager.items[i.getId()]=i;return i}}if(typeof BX.Crm.DealRecurringDetailManager==="undefined"){BX.Crm.DealRecurringDetailManager=function(){BX.Crm.DealRecurringDetailManager.superclass.constructor.apply(this)};BX.extend(BX.Crm.DealRecurringDetailManager,BX.Crm.EntityDetailManager);BX.Crm.DealRecurringDetailManager.prototype.doInitialize=function(){BX.addCustomEvent(window,"CrmDealRecurringExpose",BX.delegate(this.onExposeDeal,this))};BX.Crm.DealRecurringDetailManager.prototype.onExposeDeal=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==BX.CrmEntityType.enumeration.dealrecurring||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}window.setTimeout(function(){window.location.reload(true)},0)};BX.Crm.DealRecurringDetailManager.create=function(t,e){var i=new BX.Crm.DealRecurringDetailManager;i.initialize(t,e);BX.Crm.EntityDetailManager.items[i.getId()]=i;return i}}if(typeof BX.Crm.DealDetailManager==="undefined"){BX.Crm.DealDetailManager=function(){BX.Crm.DealDetailManager.superclass.constructor.apply(this)};BX.extend(BX.Crm.DealDetailManager,BX.Crm.EntityDetailManager);BX.Crm.DealDetailManager.prototype.doInitialize=function(){};BX.Crm.DealDetailManager.prototype.prepareCreationUrlParams=function(t){t["deal_id"]=this.getEntityId()};BX.Crm.DealDetailManager.create=function(t,e){var i=new BX.Crm.DealDetailManager;i.initialize(t,e);BX.Crm.EntityDetailManager.items[i.getId()]=i;return i}}if(typeof BX.Crm.OrderDetailManager==="undefined"){BX.Crm.OrderDetailManager=function(){BX.Crm.OrderDetailManager.superclass.constructor.apply(this)};BX.extend(BX.Crm.OrderDetailManager,BX.Crm.EntityDetailManager);BX.Crm.OrderDetailManager.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Saved",BX.delegate(this.onProgressSave,this));BX.addCustomEvent(window,"Crm.EntityProgress.onSaveBefore",BX.delegate(this.onProgressSaveBefore,this));BX.addCustomEvent(window,"BX.Crm.EntityEditor:onFailedValidation",BX.delegate(this.onFailedValidation,this));this._cancelReason=""};BX.Crm.OrderDetailManager.prototype.onProgressSave=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==BX.CrmEntityType.enumeration.order||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var i=BX.prop.getObject(e,"requestData",{});var n=BX.prop.getString(i,"ERROR","");if(BX.type.isNotEmptyString(n)){var r=t.getStepById(BX.prop.getString(i,"STATUS_ID",""));if(r){var a=t.findStepInfoIndex(r.getId());if(a>=0){var o=t._stepInfos[a];t.adjustSteps(r.getIndex(),r.getBackgroundColor());t.setCurrentStep(o)}}var s=BX.Crm.NotificationDialog.create("entity_details_cancel_error",{title:BX.prop.getString(i,"ERROR_TITLE",""),content:n});s.open()}};BX.Crm.OrderDetailManager.prototype.onProgressSaveBefore=function(t,e){if(BX.prop.getString(e,"TYPE","")!==BX.CrmEntityType.names.order||BX.prop.getInteger(e,"ID",0)!==this.getEntityId()){return}var i=BX.CrmOrderStatusManager.current;if(BX.type.isPlainObject(i.saveParams)){var n=this.getEntityId();for(var r in i.saveParams){BX.CrmOrderStatusManager.statusInfoValues[n][r]=i.saveParams[r];e[r]=i.saveParams[r]}}e["STATE_SUCCESS"]=i.isSuccess?"Y":"N"};BX.Crm.OrderDetailManager.prototype.onFailedValidation=function(t,e){if(typeof BX.Crm.EntityEditor==="undefined"||!(t instanceof BX.Crm.EntityEditor)||t.getEntityTypeId()!==BX.CrmEntityType.enumeration.order||t.getEntityId()!==this.getEntityId()){return}var i=this._tabManager._items[0];if(i instanceof BX.Crm.EntityDetailTab&&!i.isActive()){i.setActive(true);for(var n=1,r=this._tabManager._items.length;n<r;n++){var a=this._tabManager._items[n];a.setActive(false)}var o=e.getTopmostField();if(o){setTimeout(function(){o.focus()},350)}}};BX.Crm.OrderDetailManager.prototype.getMessage=function(t){var e=BX.Crm.OrderDetailManager.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.OrderDetailManager.superclass.getMessage.apply(this,arguments)};BX.Crm.OrderDetailManager.create=function(t,e){var i=new BX.Crm.OrderDetailManager;i.initialize(t,e);BX.Crm.EntityDetailManager.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityDetailFactory==="undefined"){BX.Crm.EntityDetailFactory={create:function(t,e){var i=BX.prop.getInteger(e,"entityTypeId",BX.CrmEntityType.enumeration.undefined);if(i===BX.CrmEntityType.enumeration.lead){return BX.Crm.LeadDetailManager.create(t,e)}else if(i===BX.CrmEntityType.enumeration.dealrecurring){return BX.Crm.DealRecurringDetailManager.create(t,e)}else if(i===BX.CrmEntityType.enumeration.deal){return BX.Crm.DealDetailManager.create(t,e)}else if(i===BX.CrmEntityType.enumeration.contact){return BX.Crm.ContactDetailManager.create(t,e)}else if(i===BX.CrmEntityType.enumeration.company){return BX.Crm.CompanyDetailManager.create(t,e)}else if(i===BX.CrmEntityType.enumeration.order){return BX.Crm.OrderDetailManager.create(t,e)}return BX.Crm.EntityDetailManager.create(t,e)}}}if(typeof BX.Crm.EntityDetailTabManager==="undefined"){BX.Crm.EntityDetailTabManager=function(){this._id="";this._settings={};this._container=null;this._menuContainer=null;this._items=null};BX.Crm.EntityDetailTabManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container");this._menuContainer=BX.prop.getElementNode(this._settings,"menuContainer");this._items=[];var i=BX.prop.getArray(this._settings,"data");for(var n=0,r=i.length;n<r;n++){var a=i[n];var o=a["id"];var s=BX.Crm.EntityDetailTab.create(o,{manager:this,data:a,container:this._container.querySelector('[data-tab-id="'+o+'"]'),menuContainer:this._menuContainer.querySelector('[data-tab-id="'+o+'"]')});this._items.push(s)}},getId:function(){return this._id},findItemById:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getId()===t){return n}}return null},selectItem:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];n.setActive(n===t)}},processItemSelect:function(t){this.selectItem(t)}};BX.Crm.EntityDetailTabManager.items={};BX.Crm.EntityDetailTabManager.create=function(t,e){var i=new BX.Crm.EntityDetailTabManager;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityDetailTab==="undefined"){BX.Crm.EntityDetailTab=function(){this._id="";this._settings={};this._data={};this._manager=null;this._container=null;this._menuContainer=null;this._onMenuClickHandler=BX.delegate(this.onMenuClick,this);this._isActive=false;this._isEnabled=false;this._loader=null};BX.Crm.EntityDetailTab.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._data=BX.prop.getObject(this._settings,"data",{});this._manager=BX.prop.get(this._settings,"manager",null);this._container=BX.prop.getElementNode(this._settings,"container");this._menuContainer=BX.prop.getElementNode(this._settings,"menuContainer");this._isActive=BX.prop.getBoolean(this._data,"active",false);this._isEnabled=BX.prop.getBoolean(this._data,"enabled",true);var i=this._menuContainer.querySelector("a.crm-entity-section-tab-link");if(i){BX.bind(i,"click",this._onMenuClickHandler)}var n=BX.prop.getObject(this._data,"loader",null);if(n){n["tabId"]=this._id;n["container"]=this._container;this._loader=BX.Crm.EditorTabLazyLoader.create(this._id,n)}},getId:function(){return this._id},isEnabled:function(){return this._isEnabled},isActive:function(){return this._isActive},setActive:function(t){t=!!t;if(this._isActive===t){return}this._isActive=t;if(this._isActive){this.showTab()}else{this.hideTab()}},showTab:function(){BX.addClass(this._container,"crm-entity-section-tab-content-show");BX.removeClass(this._container,"crm-entity-section-tab-content-hide");BX.addClass(this._menuContainer,"crm-entity-section-tab-current");this._container.style.display="";this._container.style.position="absolute";this._container.style.top=0;this._container.style.left=0;this._container.style.width="100%";var t=new BX.easing({duration:350,start:{opacity:0,translateX:100},finish:{opacity:100,translateX:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.delegate(function(t){this._container.style.opacity=t.opacity/100;this._container.style.transform="translateX("+t.translateX+"%)"},this),complete:BX.delegate(function(){BX.removeClass(this._container,"crm-entity-section-tab-content-show");this._container.style.cssText="";BX.onCustomEvent(window,"onEntityDetailsTabShow",[this])},this)});t.animate()},hideTab:function(){BX.addClass(this._container,"crm-entity-section-tab-content-hide");BX.removeClass(this._container,"crm-entity-section-tab-content-show");BX.removeClass(this._menuContainer,"crm-entity-section-tab-current");var t=new BX.easing({duration:350,start:{opacity:100},finish:{opacity:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.delegate(function(t){this._container.style.opacity=t.opacity/100},this),complete:BX.delegate(function(){this._container.style.display="none";this._container.style.transform="translateX(100%)";this._container.style.opacity=0},this)});t.animate()},onMenuClick:function(t){if(!this._isEnabled){return BX.PreventDefault(t)}if(this._loader&&!this._loader.isLoaded()){this._loader.load()}this._manager.processItemSelect(this);return BX.PreventDefault(t)}};BX.Crm.EntityDetailTab.create=function(t,e){var i=new BX.Crm.EntityDetailTab;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorTabLazyLoader==="undefined"){BX.Crm.EditorTabLazyLoader=function(){this._id="";this._settings={};this._container=null;this._serviceUrl="";this._tabId="";this._params={};this._isRequestRunning=false;this._isLoaded=false};BX.Crm.EditorTabLazyLoader.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_lf_disp_"+Math.random().toString().substring(2);this._settings=e?e:{};this._container=BX(BX.prop.get(this._settings,"container",""));if(!this._container){throw"Error: Could not find container."}this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");if(this._serviceUrl===""){throw"Error. Could not find service url."}this._tabId=BX.prop.getString(this._settings,"tabId","");if(this._tabId===""){throw"Error: Could not find tab id."}this._params=BX.prop.getObject(this._settings,"componentData",{})},getId:function(){return this._id},isLoaded:function(){return this._isLoaded},load:function(){if(this._isLoaded){return}var t=this._params;t["TAB_ID"]=this._tabId;this._startRequest(t)},_startRequest:function(t){if(this._isRequestRunning){return false}this._isRequestRunning=true;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:{LOADER_ID:this._id,PARAMS:t},onsuccess:BX.delegate(this._onRequestSuccess,this),onfailure:BX.delegate(this._onRequestFailure,this)});return true},_onRequestSuccess:function(t){this._isRequestRunning=false;this._container.innerHTML=t;this._isLoaded=true},_onRequestFailure:function(t){this._isRequestRunning=false;this._isLoaded=true}};BX.Crm.EditorTabLazyLoader.items={};BX.Crm.EditorTabLazyLoader.create=function(t,e){var i=new BX.Crm.EditorTabLazyLoader;i.initialize(t,e);this.items[i.getId()]=i;return i}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:97:"/bitrix/components/bitrix/crm.entity.progressbar/templates/.default/script.min.js?154412740118911";s:6:"source";s:77:"/bitrix/components/bitrix/crm.entity.progressbar/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Crm");if(typeof BX.Crm.EntityDetailProgressControl==="undefined"){BX.Crm.EntityDetailProgressControl=function(){this._id="";this._settings={};this._container=null;this._entityId=0;this._entityTypeId=0;this._stepInfoTypeId="";this._currentStepId="";this._previousStepId="";this._currentSemantics="";this._previousSemantics="";this._manager=null;this._stepInfos=null;this._steps=[];this._terminationDlg=null;this._failureDlg=null;this._isReadOnly=false;this._terminationControl=null;this._entityEditorDialog=null;this._entityEditorDialogHandler=BX.delegate(this.onEntityEditorDialogClose,this)};BX.Crm.EntityDetailProgressControl.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX(BX.prop.getString(this._settings,"containerId",""));this._entityId=BX.prop.getNumber(this._settings,"entityId",0);this._entityTypeId=BX.prop.getNumber(this._settings,"entityTypeId",0);this._entityType=BX.CrmEntityType.resolveName(this._entityTypeId);this._currentStepId=BX.prop.getString(this._settings,"currentStepId","");this._currentSemantics=BX.prop.getString(this._settings,"currentSemantics","");this._stepInfoTypeId=BX.prop.getString(this._settings,"stepInfoTypeId","");this._isReadOnly=BX.prop.getBoolean(this._settings,"readOnly",false);if(this._entityTypeId===BX.CrmEntityType.enumeration.deal){this._manager=BX.CrmDealStageManager.current}else if(this._entityTypeId===BX.CrmEntityType.enumeration.dealrecurring){this._manager=BX.CrmDealRecurringStageManager.current}if(this._entityTypeId===BX.CrmEntityType.enumeration.quote){this._manager=BX.CrmQuoteStatusManager.current}else if(this._entityTypeId===BX.CrmEntityType.enumeration.lead){this._manager=BX.CrmLeadStatusManager.current;this._terminationControl=BX.CrmLeadTerminationControl.create(this._id,BX.CrmParamBag.create({entityId:this._entityId,typeId:BX.prop.getInteger(e,"conversionTypeId",BX.CrmLeadConversionType.general),canConvert:BX.prop.getBoolean(e,"canConvert",false),conversionScheme:BX.prop.get(e,"conversionScheme",null)}))}else if(this._entityTypeId===BX.CrmEntityType.enumeration.order){this._manager=BX.CrmOrderStatusManager.current}else if(this._entityTypeId===BX.CrmEntityType.enumeration.ordershipment){this._manager=BX.CrmOrderShipmentStatusManager.current}this._stepInfos=this._manager.getInfos(this._stepInfoTypeId);var i=this.findStepInfoIndex(this._currentStepId);var s=this._stepInfos[i];for(var n=0,r=this._stepInfos.length;n<r;n++){var o=this._stepInfos[n];var a=BX.prop.getString(o,"id","");var l=this.getStepContainer(a);if(!l){continue}var p=l.querySelector(".crm-entity-section-status-step-item-text");if(p.scrollWidth>l.clientWidth+10){BX.addClass(l,"crm-entity-section-status-step-hover");l.style.maxWidth=p.scrollWidth+20+"px"}this._steps.push(BX.Crm.EntityDetailProgressStep.create(a,{name:o["name"],hint:BX.prop.getString(o,"hint",""),sort:BX.prop.getNumber(o,"sort",0),semantics:BX.prop.getString(o,"semantics",""),index:n,isPassed:i>=0&&n<=i,isReadOnly:this._isReadOnly,isVisible:l.style.display!=="none",container:l,control:this}))}if(i>=0){this.adjustSteps(i,BX.Crm.EntityDetailProgressControl.getStepColor(s))}BX.addCustomEvent(window,"Crm.EntityModel.Change",BX.delegate(this.onEntityModelChange,this))},onEntityModelChange:function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this._entityTypeId||BX.prop.getInteger(e,"entityId",0)!==this._entityId){return}var i=BX.prop.getString(this._settings,"entityFieldName","");if(i===""){return}if(!BX.prop.getBoolean(e,"forAll",false)&&i!==BX.prop.getString(e,"fieldName","")){return}var s=t.getField(i,"");if(s===this._currentStepId){return}var n=this.findStepInfoIndex(s);if(n>=0){var r=this._stepInfos[n];this.setCurrentStep(r);this.adjustSteps(n,BX.Crm.EntityDetailProgressControl.getStepColor(r))}},getEntityId:function(){return this._entityId},getEntityTypeId:function(){return this._entityTypeId},getEntityTypeName:function(){return BX.CrmEntityType.resolveName(this._entityTypeId)},getCurrentStepId:function(){return this._currentStepId},getCurrentStepName:function(){var t=this.findStepInfoIndex(this._currentStepId);return t>=0?this._stepInfos[t]["name"]:"["+this._currentStepId+"]"},getCurrentSemantics:function(){return this._currentSemantics},getStepContainer:function(t){return this._container.querySelector('.crm-entity-section-status-step[data-id="'+t+'"]')},getTerminationStep:function(){return this._steps.length>0?this._steps[this._steps.length-1]:null},getStepById:function(t){for(var e=0,i=this._steps.length;e<i;e++){var s=this._steps[e];if(s.getId()===t){return s}}return null},findStepInfoIndex:function(t){for(var e=0,i=this._stepInfos.length;e<i;e++){if(this._stepInfos[e]["id"]===t){return e}}return-1},findStepInfoBySemantics:function(t){for(var e=0,i=this._stepInfos.length;e<i;e++){var s=this._stepInfos[e];var n=BX.type.isNotEmptyString(s["semantics"])?s["semantics"]:"";if(t===n){return s}}return null},findAllStepInfoBySemantics:function(t){var e=[];for(var i=0,s=this._stepInfos.length;i<s;i++){var n=this._stepInfos[i];var r=BX.prop.getString(n,"semantics","");if(t===r){e.push(n)}}return e},setCurrentStep:function(t,e){var i=t["id"];if(this._currentStepId===i){return false}if(BX.prop.getBoolean(e,"keepPreviousStep",true)){this._previousStepId=this._currentStepId;this._previousSemantics=this._currentSemantics}this._currentStepId=i;var s=t["semantics"];if(this._currentSemantics!==s){this._currentSemantics=s}this.adjustStepsVisibility();this.adjustFinalStepName();BX.onCustomEvent(window,"Crm.EntityProgress.Change",[this,{entityTypeId:this._entityTypeId,entityId:this._entityId,currentStepId:this._currentStepId,semantics:this._currentSemantics}]);return true},adjustFinalStepName:function(){var t=this.findStepInfoBySemantics("success");if(t){var e=this.findStepInfoIndex(t["id"]);if(e>=0){this._steps[e].setDisplayName(this._currentSemantics==="process"?BX.prop.getString(this._settings,"terminationTitle",""):"")}}},adjustStepsVisibility:function(){for(var t=0,e=this._steps.length;t<e;t++){var i=this._steps[t];var s=true;var n=i.getSemantics();if(this._currentSemantics==="process"||this._currentSemantics==="success"){s=n==="process"||n==="success"}else{if(n==="success"){s=false}else if(n==="failure"||n==="apology"){s=i.getId()===this._currentStepId}}i.setVisible(s)}},adjustSteps:function(t,e){if(t>=this._steps.length){t=this._steps.length-1}var i,s;for(i=t,s=this._steps.length;i<s;i++){this._steps[i].recoverColors();this._steps[i].saveStyles()}var n=BX.Crm.EntityDetailProgressStep.calculateTextColor(e);for(i=0,s=t;i<=s;i++){this._steps[i].setColor(n);this._steps[i].setBackgroundColor(e)}for(i=0,s=t;i<=s;i++){this._steps[i].saveStyles()}},setStepColorsBefore:function(t){var e=t.calculateTextColor();var i=t.getBackgroundColor();for(var s=0,n=t.getIndex();s<=n;s++){this._steps[s].setColor(e);this._steps[s].setBackgroundColor(i)}},recoverStepColorsBefore:function(t){for(var e=0,i=t.getIndex();e<=i;e++){this._steps[e].recoverStyles()}},save:function(){var t=BX.prop.getString(this._settings,"serviceUrl");var e=this.getCurrentStepId();var i=this.getEntityTypeName();var s=this.getEntityId();if(t===""||e===""||i===""||s<=0){return}var n={ACTION:"SAVE_PROGRESS",VALUE:e,TYPE:i,ID:s};BX.onCustomEvent(this,"Crm.EntityProgress.onSaveBefore",[this,n]);BX.ajax({url:t,method:"POST",dataType:"json",data:n,onsuccess:BX.delegate(this.onSaveRequestSuccess,this)})},onSaveRequestSuccess:function(t){var e=BX.prop.getObject(t,"CHECK_ERRORS",null);if(e){this.openEntityEditorDialog({title:this._manager.getMessage("checkErrorTitle"),fieldNames:Object.keys(e),initData:BX.prop.getObject(t,"EDITOR_INIT_DATA",null),context:BX.prop.getObject(t,"CONTEXT",null)});return}BX.onCustomEvent(window,"Crm.EntityProgress.Saved",[this,{entityTypeId:this._entityTypeId,entityId:this._entityId,currentStepId:this._currentStepId,currentSemantics:this._currentSemantics,previousStepId:this._previousStepId,previousSemantics:this._previousSemantics,requestData:t}])},openEntityEditorDialog:function(t){BX.Crm.PartialEditorDialog.close("progressbar-entity-editor");this._entityEditorDialog=BX.Crm.PartialEditorDialog.create("progressbar-entity-editor",{title:BX.prop.getString(t,"title","Please fill in all required fields"),entityTypeId:this._entityTypeId,entityId:this._entityId,fieldNames:BX.prop.getArray(t,"fieldNames",[]),initData:BX.prop.getObject(t,"initData",null),context:BX.prop.getObject(t,"context",null)});window.setTimeout(function(){this._entityEditorDialog.open();BX.addCustomEvent(window,"Crm.PartialEditorDialog.Close",this._entityEditorDialogHandler)}.bind(this),150)},onEntityEditorDialogClose:function(t,e){if(!(this._entityTypeId===BX.prop.getInteger(e,"entityTypeId",0)&&this._entityId===BX.prop.getInteger(e,"entityId",0))){return}this._entityEditorDialog=null;BX.removeCustomEvent(window,"Crm.PartialEditorDialog.Close",this._entityEditorDialogHandler);if(BX.prop.getBoolean(e,"isCancelled",true)&&this._previousStepId!==""){var i=this.findStepInfoIndex(this._previousStepId);var s=this._stepInfos[i];this.setCurrentStep(s);this.adjustSteps(i,BX.Crm.EntityDetailProgressControl.getStepColor(this._stepInfos[i]))}},openTerminationDialog:function(){if(this._terminationDlg){this._terminationDlg.close();this._terminationDlg=null}var t=this.findAllStepInfoBySemantics("apology");this._terminationDlg=BX.CrmProcessTerminationDialog.create(this._id+"_TERMINATION",BX.CrmParamBag.create({title:this._manager.getMessage("dialogTitle"),failureTitle:t.length>0?this._manager.getMessage("failureTitle"):"",success:this.findStepInfoBySemantics("success"),failure:this.findStepInfoBySemantics("failure"),apologies:t,callback:BX.delegate(this.onTerminationDialogClose,this),terminationControl:this._terminationControl}));this._terminationDlg.open()},closeTerminationDialog:function(){if(!this._terminationDlg){return}this._terminationDlg.close(false);this._terminationDlg=null},onTerminationDialogClose:function(dialog,params){if(this._terminationDlg!==dialog){return}this.closeTerminationDialog();var stepId=BX.type.isNotEmptyString(params["result"])?params["result"]:"";var stepIndex=this.findStepInfoIndex(stepId);if(stepIndex<0){var currentStepIndex=this.findStepInfoIndex(this._currentStepId);this.adjustSteps(currentStepIndex,BX.Crm.EntityDetailProgressControl.getStepColor(this._stepInfos[currentStepIndex]));return}var stepInfo=this._stepInfos[stepIndex];this.setCurrentStep(stepInfo);var openFailureDialog=false;var failure=this.findStepInfoBySemantics("failure");if(failure&&failure["id"]===stepId){openFailureDialog=true}else if(stepInfo["semantics"]==="success"){if(typeof stepInfo["hasParams"]!=="undefined"&&stepInfo["hasParams"]===true){openFailureDialog=true}else{var finalScript=BX.prop.getString(this._settings,"finalScript","");if(finalScript!==""){eval(finalScript);return}var finalUrl=BX.prop.getString(this._settings,"finalUrl","");if(finalUrl!==""){window.location=finalUrl;return}}}this.adjustSteps(stepIndex,BX.Crm.EntityDetailProgressControl.getStepColor(stepInfo));if(openFailureDialog){this.openFailureDialog();return}this.save()},openFailureDialog:function(){if(this._failureDlg){this._failureDlg.close();this._failureDlg=null}var t=this.findStepInfoIndex(this._currentStepId);var e=t>=0?this._stepInfos[t]:null;var i=e?e["id"]:"";var s=this.findAllStepInfoBySemantics("apology");this._failureDlg=BX.CrmProcessFailureDialog.create(this._id+"_FAILURE",BX.CrmParamBag.create({entityType:this._entityType,entityId:this._entityId,initValue:i,failureTitle:s.length>0?this._manager.getMessage("failureTitle"):"",selectorTitle:this._manager.getMessage("selectorTitle"),success:this.findStepInfoBySemantics("success"),failure:this.findStepInfoBySemantics("failure"),apologies:s,callback:BX.delegate(this.onFailureDialogClose,this)}));this._failureDlg.open()},closeFailureDialog:function(){if(!this._failureDlg){return}this._failureDlg.close(false);this._failureDlg=null},onFailureDialogClose:function(dialog,params){if(this._failureDlg!==dialog){return}var stepInfo,stepIndex;BX.onCustomEvent(this,"CrmProgressControlBeforeFailureDialogClose",[this,this._failureDlg]);this.closeFailureDialog();var bid=BX.type.isNotEmptyString(params["bid"])?params["bid"]:"";if(bid!=="accept"){if(this._previousStepId!==""){stepIndex=this.findStepInfoIndex(this._previousStepId);stepInfo=this._stepInfos[stepIndex];this.setCurrentStep(stepInfo);this.adjustSteps(stepIndex,BX.Crm.EntityDetailProgressControl.getStepColor(this._stepInfos[stepIndex]))}return}var id=BX.type.isNotEmptyString(params["result"])?params["result"]:"";stepIndex=this.findStepInfoIndex(id);if(stepIndex>=0){stepInfo=this._stepInfos[stepIndex];if(stepInfo["semantics"]==="success"){var finalScript=this.getSetting("finalScript","");if(finalScript!==""){eval(finalScript);return}var finalUrl=this.getSetting("finalUrl","");if(finalUrl!==""){window.location=finalUrl;return}var verboseMode=!!this.getSetting("verboseMode",false);if(verboseMode){this.openTerminationDialog();return}}this.setCurrentStep(stepInfo,{keepPreviousStep:false});this.adjustSteps(stepIndex,BX.Crm.EntityDetailProgressControl.getStepColor(stepInfo));this.save()}},processStepHover:function(t){if(t.getIndex()<this._steps.length-1){this.setStepColorsBefore(t)}},processStepLeave:function(t){if(t.getIndex()<this._steps.length-1){this.recoverStepColorsBefore(t)}},processStepSelect:function(t){if(this._isReadOnly){return}this.closeTerminationDialog();if(BX.type.isFunction(this._manager["admitChange"])){this._manager.admitChange(this._currentStepId,t.getId()).then(function(t){if(!BX.prop.getBoolean(t,"succeeded",false)){return}var e=this.getStepById(BX.prop.getString(t,"currentId",""));if(e){this.setupStep(e)}}.bind(this))}else{this.setupStep(t)}},setupStep:function(t){if(this._entityEditorDialog!==null){return}var e=this.findStepInfoIndex(t.getId());if(e<0){return}var i=this._stepInfos[e];var s=i["semantics"];if(s==="failure"||s==="apology"||s==="success"&&(this._terminationControl||this.findStepInfoBySemantics("failure"))){if(this._terminationControl&&!this._terminationControl.isEnabled()){return}this.adjustSteps(t.getIndex(),t.getBackgroundColor());this.openTerminationDialog()}else{this.adjustSteps(t.getIndex(),t.getBackgroundColor());if(this._currentStepId!==i["id"]&&this.setCurrentStep(i)){this.save()}}}};if(typeof BX.Crm.EntityDetailProgressControl.defaultColors==="undefined"){BX.Crm.EntityDetailProgressControl.defaultColors={}}BX.Crm.EntityDetailProgressControl.getStepColor=function(t){var e=BX.prop.getString(t,"color");if(e!==""){return e}var i=BX.prop.getString(t,"semantics");return BX.Crm.EntityDetailProgressControl.defaultColors[i]};BX.Crm.EntityDetailProgressControl.create=function(t,e){var i=new BX.Crm.EntityDetailProgressControl;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityDetailProgressStep==="undefined"){BX.Crm.EntityDetailProgressStep=function(){this._id="";this._settings={};this._control=null;this._container=null;this._element=null;this._clickHandler=BX.delegate(this.onClick,this);this._hoverHandler=BX.delegate(this.onMouseHover,this);this._leaveHandler=BX.delegate(this.onMouseLeave,this);this._isVisible=true;this._displayName=""};BX.Crm.EntityDetailProgressStep.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._control=BX.prop.get(this._settings,"control");this._container=BX.prop.getElementNode(this._settings,"container");this._element=this._container.querySelector(".crm-entity-section-status-step-item-text");BX.bind(this._container,"click",this._clickHandler);BX.bind(this._element,"mouseenter",this._hoverHandler);BX.bind(this._element,"mouseleave",this._leaveHandler);if(BX.prop.getBoolean(this._settings,"isPassed",false)){this._element.style.color=this.calculateTextColor()}this.saveStyles();this._isVisible=BX.prop.getBoolean(this._settings,"isVisible",true)},getId:function(){return this._id},getIndex:function(){return BX.prop.getNumber(this._settings,"index",0)},isVisible:function(){return this._isVisible},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;this._container.style.display=t?"":"none"},getSemantics:function(){return BX.prop.getString(this._settings,"semantics","")},getDisplayName:function(){return this._displayName},setDisplayName:function(t){this._displayName=t;if(this._element){this._element.innerHTML=BX.util.htmlspecialchars(this._displayName!==""?this._displayName:BX.prop.getString(this._settings,"name",this._id))}},onMouseHover:function(t){this._control.processStepHover(this)},onMouseLeave:function(t){this._control.processStepLeave(this)},onClick:function(t){this._control.processStepSelect(this)},calculateTextColor:function(){var t=this._element.getAttribute("data-base-color")?this._element.attributes["data-base-color"].value:getComputedStyle(this._element).borderBottomColor;return BX.Crm.EntityDetailProgressStep.calculateTextColor(t)},getBackgroundColor:function(){return this._element.getAttribute("data-base-color")?this._element.attributes["data-base-color"].value:getComputedStyle(this._element).borderBottomColor},setBackgroundColor:function(t){var e=encodeURIComponent(t);this._element.style.borderImage=BX.Crm.EntityDetailProgressStep.backgroundImageCss.replace(/#COLOR1#/gi,e).replace(/#COLOR2#/gi,e)},setColor:function(t){this._element.style.color=t},recoverColors:function(){var t=encodeURIComponent(BX.Crm.EntityDetailProgressStep.defaultBackgroundColor);if(this._element.getAttribute("data-base-color")){this._element.style.color="";var e=encodeURIComponent(this._element.getAttribute("data-base-color"));this._element.style.borderImage=BX.Crm.EntityDetailProgressStep.backgroundImageCss.replace(/#COLOR1#/gi,e).replace(/#COLOR2#/gi,t)}else{this._element.style.cssText=""}},saveStyles:function(){if(this._element.getAttribute("style")){BX.adjust(this._element,{attrs:{"data-style":this._element.getAttribute("style")}})}},recoverStyles:function(){this._element.style.cssText=this._element.getAttribute("data-style")?this._element.getAttribute("data-style"):""}};if(BX.Crm.EntityDetailProgressStep.backgroundImageCss==="undefined"){BX.Crm.EntityDetailProgressStep.backgroundImageCss=""}if(BX.Crm.EntityDetailProgressStep.defaultBackgroundColor==="undefined"){BX.Crm.EntityDetailProgressStep.defaultBackgroundColor=""}BX.Crm.EntityDetailProgressStep.calculateTextColor=function(t){var e,i,s;if(t>7){var n=t.split("(")[1].split(")")[0];n=n.split(",");e=parseInt(n[0]);i=parseInt(n[1]);s=parseInt(n[2])}else{if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t)){var r=t.substring(1).split("");if(r.length===3){r=[r[0],r[0],r[1],r[1],r[2],r[2]]}r="0x"+r.join("");e=r>>16&255;i=r>>8&255;s=r&255}}var o=.21*e+.72*i+.07*s;return o<145?"#fff":"#333"};BX.Crm.EntityDetailProgressStep.create=function(t,e){var i=new BX.Crm.EntityDetailProgressStep;i.initialize(t,e);return i}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:93:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/script.min.js?1544127401471392";s:6:"source";s:72:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Crm");if(typeof BX.Crm.EntityEditor==="undefined"){BX.Crm.EntityEditor=function(){this._id="";this._settings={};this._entityTypeId=0;this._entityId=0;this._userFieldManager=null;this._dupControlManager=null;this._bizprocManager=null;this._attributeManager=null;this._container=null;this._buttonContainer=null;this._createSectionButton=null;this._configMenuButton=null;this._configIcon=null;this._pageTitle=null;this._pageTitleInput=null;this._buttonWrapper=null;this._editPageTitleButton=null;this._copyPageUrlButton=null;this._formElement=null;this._ajaxForm=null;this._formSubmitHandler=BX.delegate(this.onFormSubmit,this);this._controllers=null;this._controls=null;this._activeControls=null;this._toolPanel=null;this._model=null;this._scheme=null;this._config=null;this._context=null;this._contextId="";this._externalContextId="";this._mode=BX.Crm.EntityEditorMode.intermediate;this._isNew=false;this._readOnly=false;this._enableRequiredUserFieldCheck=true;this._enableAjaxForm=true;this._enableSectionEdit=false;this._enableSectionCreation=false;this._enableModeToggle=true;this._enablePageTitleContols=true;this._enableToolPanel=true;this._enableBottomPanel=true;this._serviceUrl="";this._htmlEditorConfigs=null;this._areAvailableSchemeElementsChanged=false;this._availableSchemeElements=null;this._dragPlaceHolder=null;this._dragContainerController=null;this._dropHandler=BX.delegate(this.onDrop,this);this._pageTitleExternalClickHandler=BX.delegate(this.onPageTitleExternalClick,this);this._pageTitleKeyPressHandler=BX.delegate(this.onPageTitleKeyPress,this);this._modeChangeNotifier=null;this._controlChangeNotifier=null;this._validators=null;this._modeSwitch=null;this._delayedSaveHandle=0;this._isEmbedded=false;this._isRequestRunning=false;this._isConfigMenuShown=false;this._isReleased=false;this._enableCloseConfirmation=true;this._closeConfirmationHandler=BX.delegate(this.onCloseConfirmButtonClick,this);this._cancelConfirmationHandler=BX.delegate(this.onCancelConfirmButtonClick,this);this._sliderOpenHandler=BX.delegate(this.onSliderOpen,this);this._sliderCloseHandler=BX.delegate(this.onSliderClose,this);this._entityUpdateHandler=BX.delegate(this.onEntityUpdate,this);this._dragConfig={}};BX.Crm.EntityEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._model=BX.prop.get(this._settings,"model",null);this._scheme=BX.prop.get(this._settings,"scheme",null);this._config=BX.prop.get(this._settings,"config",null);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._isNew=this._entityId<=0;this._isEmbedded=BX.prop.getBoolean(this._settings,"isEmbedded",false);this._container=BX(BX.prop.get(this._settings,"containerId"));this._parentContainer=BX.findParent(this._container,{className:"crm-entity-section"},false);this._buttonContainer=BX(BX.prop.get(this._settings,"buttonContainerId"));this._createSectionButton=BX(BX.prop.get(this._settings,"createSectionButtonId"));this._configMenuButton=BX(BX.prop.get(this._settings,"configMenuButtonId"));this._configIcon=BX(BX.prop.get(this._settings,"configIconId"));this._enablePageTitleContols=BX.prop.getBoolean(this._settings,"enablePageTitleControls",true);if(this._enablePageTitleContols){this._pageTitle=BX("pagetitle");this._buttonWrapper=BX("pagetitle_btn_wrapper");this._editPageTitleButton=BX("pagetitle_edit");this._copyPageUrlButton=BX("page_url_copy_btn")}this.adjustSize();this.adjustTitle();this._formElement=BX.create("form",{props:{name:this._id+"_form"}});this._container.appendChild(this._formElement);this._enableRequiredUserFieldCheck=BX.prop.getBoolean(this._settings,"enableRequiredUserFieldCheck",true);this._enableAjaxForm=BX.prop.getBoolean(this._settings,"enableAjaxForm",true);if(this._enableAjaxForm){this.initializeAjaxForm()}var i=BX.prop.getObject(this._settings,"duplicateControl",{});if(this._ajaxForm){i["form"]=this._ajaxForm}this._dupControlManager=BX.Crm.EntityEditorDupManager.create(this._id.toLowerCase()+"_dup",i);this._context=BX.prop.getObject(this._settings,"context",{});this._contextId=BX.prop.getString(this._settings,"contextId","");this._externalContextId=BX.prop.getString(this._settings,"externalContextId","");this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);if(this._readOnly){this._enableSectionEdit=this._enableSectionCreation=false}else{this._enableSectionEdit=BX.prop.getBoolean(this._settings,"enableSectionEdit",false);this._enableSectionCreation=BX.prop.getBoolean(this._settings,"enableSectionCreation",false)}this._userFieldManager=BX.prop.get(this._settings,"userFieldManager",null);this._bizprocManager=BX.prop.get(this._settings,"bizprocManager",null);if(this._bizprocManager){this._bizprocManager._editor=this}this._restPlacementTabManager=BX.prop.get(this._settings,"restPlacementTabManager",null);if(this._restPlacementTabManager){this._restPlacementTabManager._editor=this}this._modeChangeNotifier=BX.CrmNotifier.create(this);this._controlChangeNotifier=BX.CrmNotifier.create(this);this._availableSchemeElements=this._scheme.getAvailableElements();this._controllers=[];this._controls=[];this._activeControls=[];this._modeSwitch=BX.Crm.EntityEditorModeSwitch.create(this._id,{editor:this});this._htmlEditorConfigs=BX.prop.getObject(this._settings,"htmlEditorConfigs",{});var n=this._scheme.getElements();var r=BX.Crm.EntityEditorMode.view;if(!this._readOnly){r=BX.Crm.EntityEditorMode.parse(BX.prop.getString(this._settings,"initialMode",""))}this._mode=r!==BX.Crm.EntityEditorMode.intermediate?r:BX.Crm.EntityEditorMode.view;this._enableModeToggle=false;if(!this._readOnly){this._enableModeToggle=BX.prop.getBoolean(this._settings,"enableModeToggle",true)}if(this._isNew&&!this._readOnly){this._mode=BX.Crm.EntityEditorMode.edit}var o,s;var a=BX.prop.getArray(this._settings,"controllers",[]);for(o=0,s=a.length;o<s;o++){var l=this.createController(a[o]);if(l){this._controllers.push(l)}}var d,h;for(o=0,s=n.length;o<s;o++){d=n[o];h=this.createControl(d.getType(),d.getName(),{schemeElement:d,mode:BX.Crm.EntityEditorMode.view});if(!h){continue}this._controls.push(h)}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._controls.length>0){for(o=0,s=this._controls.length;o<s;o++){h=this._controls[o];var p=h.getEditPriority();if(p===BX.Crm.EntityEditorPriority.high){h.setMode(BX.Crm.EntityEditorMode.edit,{notify:false})}}if(this.getActiveControlCount()===0){this._controls[0].setMode(BX.Crm.EntityEditorMode.edit,{notify:false})}}this._validators=[];var u=BX.prop.getArray(this._settings,"validators",[]);for(o=0,s=u.length;o<s;o++){var c=this.createValidator(u[o]);if(c){this._validators.push(c)}}this._modeChangeNotifier.notify([this]);this._enableToolPanel=BX.prop.getBoolean(this._settings,"enableToolPanel",true);if(this._enableToolPanel){this._toolPanel=BX.Crm.EntityEditorToolPanel.create(this._id,{container:this._formElement,editor:this,visible:false})}this._enableBottomPanel=BX.prop.getBoolean(this._settings,"enableBottomPanel",true);BX.addCustomEvent(window,"Crm.InterfaceToolbar.MenuBuild",BX.delegate(this.onInterfaceToolbarMenuBuild,this));var m={};m[BX.Crm.EntityEditorMode.names.view]=m[BX.Crm.EntityEditorMode.names.edit]=true;this._dragConfig={};this._dragConfig[BX.Crm.EditorDragObjectType.field]={scope:BX.Crm.EditorDragScope.form,modes:m};this._dragConfig[BX.Crm.EditorDragObjectType.section]={scope:BX.Crm.EditorDragScope.form,modes:m};if(this.canChangeScheme()){this._dragContainerController=BX.Crm.EditorDragContainerController.create("editor_"+this.getId(),{charge:BX.Crm.EditorSectionDragContainer.create({editor:this}),node:this._formElement});this._dragContainerController.addDragFinishListener(this._dropHandler)}this.layout();BX.bind(window,"resize",BX.debounce(BX.delegate(this.onResize,this),50));BX.addCustomEvent("SidePanel.Slider:onOpenComplete",this._sliderOpenHandler);BX.addCustomEvent("SidePanel.Slider:onClose",this._sliderCloseHandler);BX.addCustomEvent("onCrmEntityUpdate",this._entityUpdateHandler);var y={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onInit",[this,y])},release:function(){if(this._dragContainerController){this._dragContainerController.removeDragFinishListener(this._dropHandler);this._dragContainerController.release();this._dragContainerController=null}for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].clearLayout()}BX.removeCustomEvent("onCrmEntityUpdate",this._entityUpdateHandler);BX.removeCustomEvent("SidePanel.Slider:onOpenComplete",this._sliderOpenHandler);BX.removeCustomEvent("SidePanel.Slider:onClose",this._sliderCloseHandler);this.releaseAjaxForm();this._container=BX.remove(this._container);this._isReleased=true},onSliderOpen:function(t){this._enableCloseConfirmation=true;var e={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onOpen",[this,e])},onSliderClose:function(t){if(!this._enableCloseConfirmation){return}var e=top.BX.SidePanel.Instance.getSliderByWindow(window);if(e!==t.getSlider()){return}if(!e.isOpen()){return}if(!this.hasChangedControls()&&!this.hasChangedControllers()){return}t.denyAction();BX.Crm.EditorAuxiliaryDialog.create("close_confirmation",{title:BX.message("CRM_EDITOR_CONFIRMATION"),content:BX.message("CRM_EDITOR_CLOSE_CONFIRMATION"),buttons:[{id:"close",type:BX.Crm.DialogButtonType.accept,text:BX.message("JS_CORE_WINDOW_CLOSE"),callback:this._closeConfirmationHandler},{id:"cancel",type:BX.Crm.DialogButtonType.cancel,text:BX.message("JS_CORE_WINDOW_CANCEL"),callback:this._closeConfirmationHandler}]}).open()},onCloseConfirmButtonClick:function(t){t.getDialog().close();if(t.getId()==="close"){this._enableCloseConfirmation=false;top.BX.SidePanel.Instance.getSliderByWindow(window).close()}},onCancelConfirmButtonClick:function(t){t.getDialog().close();if(t.getId()==="yes"){this.innerCancel()}},onEntityUpdate:function(t){if(this._isReleased){return}if(this._entityTypeId===BX.prop.getInteger(t,"entityTypeId",0)&&this._entityId===BX.prop.getInteger(t,"entityId",0)&&this!==BX.prop.get(t,"sender",0)){var e=BX.prop.getObject(t,"entityData",null);if(e){this._model.setData(e,{enableNotification:false});this.adjustTitle();this.adjustSize();this.refreshLayout({reset:true})}}},initializeAjaxForm:function(){if(this._ajaxForm){return}this._ajaxForm=BX.Crm.AjaxForm.create(this._id,{elementNode:this._formElement,config:{url:this._serviceUrl,method:"POST",dataType:"json",processData:true,onsuccess:BX.delegate(this.onSaveSuccess,this),data:{ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId)),ENABLE_REQUIRED_USER_FIELD_CHECK:this._enableRequiredUserFieldCheck?"Y":"N"}}});BX.addCustomEvent(this._ajaxForm,"onAfterSubmit",this._formSubmitHandler)},releaseAjaxForm:function(){if(!this._ajaxForm){return}BX.removeCustomEvent(this._ajaxForm,"onAfterSubmit",this._formSubmitHandler);this._ajaxForm=null},getId:function(){return this._id},getEntityTypeId:function(){return this._entityTypeId},getEntityTypeName:function(){return BX.CrmEntityType.resolveName(this._entityTypeId)},getEntityId:function(){return this._entityId},getOwnerInfo:function(){return this._model.getOwnerInfo()},getMode:function(){return this._mode},getContextId:function(){return this._contextId},getContext:function(){return this._context},getExternalContextId:function(){return this._externalContextId},getScheme:function(){return this._scheme},isVisible:function(){return this._container.offsetParent!==null},isSectionEditEnabled:function(){return this._enableSectionEdit},isSectionCreationEnabled:function(){return this._enableSectionCreation},isModeToggleEnabled:function(){return this._enableModeToggle},isNew:function(){return this._isNew},isReadOnly:function(){return this._readOnly},isEditInViewEnabled:function(){return this._entityId>0},getEntityCreateUrl:function(t){if(t===BX.CrmEntityType.names.contact){return BX.prop.getString(this._settings,"contactCreateUrl","")}else if(t===BX.CrmEntityType.names.company){return BX.prop.getString(this._settings,"companyCreateUrl","")}return""},getEntityRequisiteSelectUrl:function(t,e){var i="";if(t===BX.CrmEntityType.names.contact){i=BX.prop.getString(this._settings,"contactRequisiteSelectUrl","").replace(/#contact_id#/gi,e)}else if(t===BX.CrmEntityType.names.company){i=BX.prop.getString(this._settings,"companyRequisiteSelectUrl","").replace(/#company_id#/gi,e)}return i},getRequisiteEditUrl:function(t){return BX.prop.getString(this._settings,"requisiteEditUrl","").replace(/#requisite_id#/gi,t)},getUserFieldManager:function(){return this._userFieldManager},getBizprocManager:function(){return this._bizprocManager},getAttributeManager:function(){if(!this._attributeManager){var t=this.getAttributeManagerSettings();if(t){this._attributeManager=BX.Crm.EntityFieldAttributeManager.create(this._id,{entityTypeId:this.getEntityTypeId(),entityScope:BX.prop.getString(t,"ENTITY_SCOPE",""),isPermitted:BX.prop.getBoolean(t,"IS_PERMITTED",true),lockScript:BX.prop.getString(t,"LOCK_SCRIPT",""),captions:BX.prop.getObject(t,"CAPTIONS",{})})}}return this._attributeManager},getHtmlEditorConfig:function(t){return BX.prop.getObject(this._htmlEditorConfigs,t,null)},createValidator:function(t){t["editor"]=this;return BX.Crm.EntityEditorValidatorFactory.create(BX.prop.getString(t,"type",""),t)},getControlByIndex:function(t){return t>=0&&t<this._controls.length?this._controls[t]:null},getControlIndex:function(t){for(var e=0,i=this._controls.length;e<i;e++){if(this._controls[e]===t){return e}}return-1},getControls:function(){return this._controls},getControlCount:function(){return this._controls.length},createControl:function(t,e,i){i["serviceUrl"]=this._serviceUrl;i["container"]=this._formElement;i["model"]=this._model;i["editor"]=this;return BX.Crm.EntityEditorControlFactory.create(t,e,i)},addControlAt:function(t,e){var i={};if(e<this._controls.length){i["anchor"]=this._controls[e].getWrapper();this._controls.splice(e,0,t)}else{this._controls.push(t)}t.layout(i)},moveControl:function(t,e){var i=this._controls.length;var n=i-1;if(e<0||e>i){e=n}var r=this.getControlIndex(t);if(r<0||r===e){return false}t.clearLayout();this._controls.splice(r,1);i--;var o=e<i?this._controls[e].getWrapper():null;if(e<i){this._controls.splice(e,0,t)}else{this._controls.push(t)}if(o){t.layout({anchor:o})}else{t.layout()}this._config.moveSchemeElement(t.getSchemeElement(),e)},removeControl:function(t){var e=this.getControlIndex(t);if(e<0){return false}this.processControlRemove(t);t.clearLayout();this._controls.splice(e,1)},getControlById:function(t){for(var e=0,i=this._controls.length;e<i;e++){var n=this._controls[e];if(n.getId()===t){return n}var r=n.getChildById(t);if(r){return r}}return null},getControlByIdRecursive:function(t,e){var i;if(!e){e=this.getControls()}for(var n=0;n<e.length;n++){if(!e[n]instanceof BX.Crm.EntityEditorControl){continue}if(e[n].getId()===t){return e[n]}else if(e[n]instanceof BX.Crm.EntityEditorSection){if(i=this.getControlByIdRecursive(t,e[n].getChildren())){return i}}}return null},getAllControls:function(t){var e=[],i;if(!t){t=this.getControls()}for(var n=0;n<t.length;n++){if(t[n]instanceof BX.Crm.EntityEditorControl){if(t[n]instanceof BX.Crm.EntityEditorSection){if(i=this.getAllControls(t[n].getChildren())){e=e.concat(i)}}else{e.push(t[n])}}}return e},getActiveControlCount:function(){return this._activeControls.length},getActiveControlIndex:function(t){var e=this._activeControls.length;if(e===0){return-1}for(var i=0;i<e;i++){if(this._activeControls[i]===t){return i}}return-1},getActiveControlById:function(t,e){e=!!e;var i=this._activeControls.length;if(i===0){return null}for(var n=0;n<i;n++){var r=this._activeControls[n];if(r.getId()===t){return r}if(e){var o=r.getChildById(t);if(o){return o}}}return null},getActiveControlByIndex:function(t){return t>=0&&t<this._activeControls.length?this._activeControls[t]:null},registerActiveControl:function(t){var e=this.getActiveControlIndex(t);if(e>=0){return}this._activeControls.push(t);t.setActive(true);if(this._mode!==BX.Crm.EntityEditorMode.edit){this._mode=BX.Crm.EntityEditorMode.edit;this._modeChangeNotifier.notify([this])}},unregisterActiveControl:function(t){var e=this.getActiveControlIndex(t);if(e<0){return}this._activeControls.splice(e,1);t.setActive(false);if(this._activeControls.length===0&&this._mode!==BX.Crm.EntityEditorMode.view){this._mode=BX.Crm.EntityEditorMode.view;this._modeChangeNotifier.notify([this])}},releaseActiveControls:function(t){var e={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onRelease",[this,e]);for(var i=0,n=this._activeControls.length;i<n;i++){var r=this._activeControls[i];r.setActive(false);r.toggleMode(false,t)}this._activeControls=[]},hasChangedControls:function(){for(var t=0,e=this._activeControls.length;t<e;t++){if(this._activeControls[t].isChanged()){return true}}return false},hasChangedControllers:function(){for(var t=0,e=this._controllers.length;t<e;t++){if(this._controllers[t].isChanged()){return true}}return false},processControlModeChange:function(t){if(t.getMode()===BX.Crm.EntityEditorMode.edit){this.registerActiveControl(t)}else{this.unregisterActiveControl(t)}if(this.getActiveControlCount()>0){this.showToolPanel()}else{this.hideToolPanel()}},processControlChange:function(t,e){this.showToolPanel();this._controlChangeNotifier.notify([e])},processControlAdd:function(t){this.removeAvailableSchemeElement(t.getSchemeElement())},processControlMove:function(t){},processControlRemove:function(t){if(t instanceof BX.Crm.EntityEditorField){this.addAvailableSchemeElement(t.getSchemeElement())}else if(t instanceof BX.Crm.EntityEditorSection){var e=t.getChildren();for(var i=0,n=e.length;i<n;i++){this.addAvailableSchemeElement(e[i].getSchemeElement())}}},getAvailableSchemeElements:function(){return this._availableSchemeElements},addAvailableSchemeElement:function(t){this._availableSchemeElements.push(t);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},removeAvailableSchemeElement:function(t){var e=this.getAvailableSchemeElementIndex(t);if(e<0){return}this._availableSchemeElements.splice(e,1);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},getAvailableSchemeElementIndex:function(t){var e=this._availableSchemeElements;for(var i=0,n=e.length;i<n;i++){if(e[i]===t){return i}}return-1},getAvailableSchemeElementByName:function(t){var e=this._availableSchemeElements;for(var i=0,n=e.length;i<n;i++){var r=e[i];if(r.getName()===t){return r}}return null},hasAvailableSchemeElements:function(){return this._availableSchemeElements.length>0},notifyAvailableSchemeElementsChanged:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].processAvailableSchemeElementsChange()}},createController:function(t){return BX.Crm.EntityEditorControllerFactory.create(BX.prop.getString(t,"type",""),BX.prop.getString(t,"name",""),{config:BX.prop.getObject(t,"config",{}),model:this._model,editor:this})},processControllerChange:function(t){this.showToolPanel()},getContainer:function(){return this._container},prepareContextDataLayout:function(t,e){for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=i;if(BX.type.isNotEmptyString(e)){r=e+"["+r+"]"}if(BX.type.isPlainObject(n)){this.prepareContextDataLayout(n,r)}else{this._formElement.appendChild(BX.create("input",{props:{type:"hidden",name:r,value:n}}))}}},layout:function(){this.prepareContextDataLayout(this._context,"");if(this._toolPanel){this._toolPanel.layout()}if(this._createSectionButton){if(this.isSectionCreationEnabled()&&this.canChangeScheme()){BX.bind(this._createSectionButton,"click",BX.delegate(this.onCreateSectionButtonClick,this))}else{this._createSectionButton.style.display="none"}}if(this._configMenuButton){BX.bind(this._configMenuButton,"click",BX.delegate(this.onConfigMenuButtonClick,this))}var t=BX.prop.getBoolean(this._settings,"enableInlineEditSpotlight",false);var e={edit:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.view,enableBatchMode:true,owner:this})};var i,n,r;for(i=0,n=this._controls.length;i<n;i++){r=this._controls[i];var o=r.getMode();var s={userFieldLoader:e[BX.Crm.EntityEditorMode.getName(o)]};if(i===0&&t&&o===BX.Crm.EntityEditorMode.view){s["lighting"]={id:BX.prop.getString(this._settings,"inlineEditSpotlightId",""),text:this.getMessage("inlineEditHint")}}r.layout(s);if(o===BX.Crm.EntityEditorMode.edit){this.registerActiveControl(r)}}for(var a in e){if(e.hasOwnProperty(a)){e[a].runBatch()}}if(this.getActiveControlCount()>0){this.showToolPanel()}if(this._model.isCaptionEditable()){BX.bind(this._pageTitle,"click",BX.delegate(this.onPageTileClick,this));if(this._editPageTitleButton){BX.bind(this._editPageTitleButton,"click",BX.delegate(this.onPageTileClick,this))}}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._dupControlManager.isEnabled()){this._dupControlManager.search()}if(this._enableBottomPanel&&this._buttonContainer){this._buttonContainer.style.display=""}},refreshLayout:function(t){var e={edit:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.view,enableBatchMode:true,owner:this})};if(!BX.type.isPlainObject(t)){t={}}for(var i=0,n=this._controls.length;i<n;i++){var r=this._controls[i];var o=r.getMode();var s=BX.mergeEx(t,{userFieldLoader:e[BX.Crm.EntityEditorMode.getName(o)]});r.refreshLayout(s)}for(var a in e){if(e.hasOwnProperty(a)){e[a].runBatch()}}},switchControlMode:function(t,e,i){if(!this.isModeToggleEnabled()){return}if(e===BX.Crm.EntityEditorMode.view){if(t.checkModeOption(BX.Crm.EntityEditorModeOptions.saveOnExit)){this._modeSwitch.getQueue().add(t,BX.Crm.EntityEditorMode.view);this._modeSwitch.run()}else{t.setMode(e,{options:i,notify:true});t.refreshLayout()}}else{if(!BX.Crm.EntityEditorModeOptions.check(i,BX.Crm.EntityEditorModeOptions.exclusive)){t.setMode(BX.Crm.EntityEditorMode.edit,{options:i,notify:true});t.refreshLayout()}else{var n=0;for(var r=0,o=this._activeControls.length;r<o;r++){var s=this._activeControls[r];if(s.checkModeOption(BX.Crm.EntityEditorModeOptions.saveOnExit)){this._modeSwitch.getQueue().add(s,BX.Crm.EntityEditorMode.view,i);n++}}if(n>0){this._modeSwitch.getQueue().add(t,BX.Crm.EntityEditorMode.edit,i);this._modeSwitch.run()}else{t.setMode(BX.Crm.EntityEditorMode.edit,{options:i,notify:true});t.refreshLayout()}}}},switchToViewMode:function(t){this.releaseActiveControls(t);this.hideToolPanel()},switchTitleMode:function(t){if(t===BX.Crm.EntityEditorMode.edit){this._pageTitle.style.display="none";if(this._buttonWrapper){this._buttonWrapper.style.display="none"}this._pageTitleInput=BX.create("input",{props:{type:"text",className:"pagetitle-item",value:this._model.getCaption()}});this._pageTitle.parentNode.insertBefore(this._pageTitleInput,this._pageTitle);this._pageTitleInput.focus();window.setTimeout(BX.delegate(function(){BX.bind(document,"click",this._pageTitleExternalClickHandler);BX.bind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler)},this),300)}else{if(this._pageTitleInput){this._pageTitleInput=BX.remove(this._pageTitleInput)}this._pageTitle.innerHTML=BX.util.htmlspecialchars(this._model.getCaption());this._pageTitle.style.display="";if(this._buttonWrapper){this._buttonWrapper.style.display=""}BX.unbind(document,"click",this._pageTitleExternalClickHandler);BX.unbind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler);this.adjustTitle()}},adjustTitle:function(){if(!this._enablePageTitleContols){return}if(!this._buttonWrapper){return}var t=this._model.getCaption().trim();var e="";var i=t.match(/\s+\S+\s*$/);if(i){e=t.substr(i["index"]);t=t.substr(0,i["index"])}else{e=t;t=""}BX.cleanNode(this._buttonWrapper);if(e!==""){this._buttonWrapper.appendChild(document.createTextNode(e))}if(this._editPageTitleButton){this._buttonWrapper.appendChild(this._editPageTitleButton)}if(this._copyPageUrlButton){this._buttonWrapper.appendChild(this._copyPageUrlButton)}this._pageTitle.innerHTML=BX.util.htmlspecialchars(t)},adjustSize:function(){if(!this._enablePageTitleContols){return}if(!this._pageTitle){return}var t=this._pageTitle.parentNode?this._pageTitle.parentNode:this._pageTitle;var e=t.offsetWidth<=480&&this._model.getCaption().length>=40;if(e&&!BX.hasClass(t,"pagetitle-narrow")){BX.addClass(t,"pagetitle-narrow")}else if(!e&&BX.hasClass(t,"pagetitle-narrow")){BX.removeClass(t,"pagetitle-narrow")}},showToolPanel:function(){if(!this._toolPanel||this._toolPanel.isVisible()){return}this._toolPanel.setVisible(true);if(this._parentContainer){this._parentContainer.style.paddingBottom="50px";document.body.style.paddingBottom="60px";document.body.style.height="auto"}},hideToolPanel:function(){if(!this._toolPanel||!this._toolPanel.isVisible()){return}this._toolPanel.setVisible(false);if(this._parentContainer){this._parentContainer.style.paddingBottom="";document.body.style.paddingBottom="";document.body.style.height=""}},addModeChangeListener:function(t){this._modeChangeNotifier.addListener(t)},removeModeChangeListener:function(t){this._modeChangeNotifier.removeListener(t)},addControlChangeListener:function(t){this._controlChangeNotifier.addListener(t)},removeControlChangeListener:function(t){this._controlChangeNotifier.removeListener(t)},getMessage:function(t){var e=BX.Crm.EntityEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getFormElement:function(){return this._formElement},isChanged:function(){return this._isNew||this.hasChangedControls()||this.hasChangedControllers()},savePageTitle:function(){if(!this._pageTitleInput){return}var t=BX.util.trim(this._pageTitleInput.value);if(t===""){return}this._model.setCaption(t);var e={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId)),PARAMS:BX.prop.getObject(this._context,"PARAMS",{})};this._model.prepareCaptionData(e);BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:e,onsuccess:BX.delegate(this.onSaveSuccess,this)})},saveChanged:function(){if(!this._isNew&&!this.hasChangedControls()&&!this.hasChangedControllers()){this._modeSwitch.reset();this.releaseActiveControls();this.refreshLayout({reset:true});this.hideToolPanel()}else{this._modeSwitch.reset();this._modeSwitch.getQueue().addBatch(this._activeControls,BX.Crm.EntityEditorMode.view);this._modeSwitch.run()}},saveDelayed:function(t){if(typeof t==="undefined"){t=0}if(this._delayedSaveHandle>0){window.clearTimeout(this._delayedSaveHandle)}this._delayedSaveHandle=window.setTimeout(BX.delegate(this.save,this),t)},save:function(){var t=BX.Crm.EntityValidationResult.create();this.validate(t).then(BX.delegate(function(){if(this._bizprocManager){return this._bizprocManager.onBeforeSave(t)}var e=new BX.Promise;window.setTimeout(function(){e.fulfill()},0);return e},this)).then(BX.delegate(function(){if(t.getStatus()){this.innerSave();if(this._bizprocManager){this._bizprocManager.onAfterSave()}}else{if(this.isVisible()){var e=t.getTopmostField();if(e){e.focus()}}BX.onCustomEvent(window,"BX.Crm.EntityEditor:onFailedValidation",[this,t])}},this));if(this._delayedSaveHandle>0){this._delayedSaveHandle=0}},saveControl:function(t){if(this._entityId<=0){return}var e=BX.Crm.EntityValidationResult.create();t.validate(e);if(!e.getStatus()){return}var i={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId))};i=BX.mergeEx(i,this._context);t.save();t.prepareSaveData(i);for(var n=0,r=this._controllers.length;n<r;n++){i=this._controllers[n].onBeforesSaveControl(i)}BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:i,onsuccess:BX.delegate(this.onSaveSuccess,this)})},saveData:function(t){if(this._entityId<=0){return}t=BX.mergeEx(t,this._context);t=BX.mergeEx(t,{ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId))});BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:t,onsuccess:BX.delegate(this.onSaveSuccess,this)})},validate:function(t){for(var e=0,i=this._activeControls.length;e<i;e++){this._activeControls[e].validate(t)}var n=new BX.Promise;this._userFieldManager.validate(t).then(BX.delegate(function(){n.fulfill()},this));return n},isRequestRunning:function(){return this._isRequestRunning},innerSave:function(){if(this._isRequestRunning){return}var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].onBeforeSubmit()}for(t=0,e=this._activeControls.length;t<e;t++){var i=this._activeControls[t];i.save();i.onBeforeSubmit();if(i.isSchemeChanged()){this._config.updateSchemeElement(i.getSchemeElement())}}if(this._areAvailableSchemeElementsChanged){this._scheme.setAvailableElements(this._availableSchemeElements);this._areAvailableSchemeElementsChanged=false}if(this._config&&this._config.isChanged()){this._config.save(false)}var n={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onSave",[this,n]);var r=BX.prop.getBoolean(n,"enableCloseConfirmation",null);if(BX.type.isBoolean(r)){this._enableCloseConfirmation=r}if(n["cancel"]){return}if(this._ajaxForm){this._ajaxForm.submit()}},cancel:function(){var t={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onCancel",[this,t]);var e=BX.prop.getBoolean(t,"enableCloseConfirmation",null);if(BX.type.isBoolean(e)){this._enableCloseConfirmation=e}if(t["cancel"]){return}if(this.hasChangedControls()||this.hasChangedControllers()){window.setTimeout(BX.delegate(this.openCancellationConfirmationDialog,this),250);return}this.innerCancel()},innerCancel:function(){var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].innerCancel()}this.rollback();if(this._isNew){this.refreshLayout();if(typeof top.BX.SidePanel!=="undefined"){this._enableCloseConfirmation=false;window.setTimeout(function(){var t=top.BX.SidePanel.Instance.getSliderByWindow(window);if(t&&t.isOpen()){t.close(false)}},250)}}else{this.switchToViewMode({refreshLayout:false});this.refreshLayout()}},openCancellationConfirmationDialog:function(){BX.Crm.EditorAuxiliaryDialog.create("cancel_confirmation",{title:BX.message("CRM_EDITOR_CONFIRMATION"),content:BX.message("CRM_EDITOR_CANCEL_CONFIRMATION"),buttons:[{id:"yes",type:BX.Crm.DialogButtonType.accept,text:BX.message("CRM_EDITOR_YES"),callback:this._cancelConfirmationHandler},{id:"no",type:BX.Crm.DialogButtonType.cancel,text:BX.message("CRM_EDITOR_NO"),callback:this._cancelConfirmationHandler}]}).open()},rollback:function(){this._model.rollback();var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].rollback()}for(t=0,e=this._activeControls.length;t<e;t++){this._activeControls[t].rollback()}if(this._areAvailableSchemeElementsChanged){this._availableSchemeElements=this._scheme.getAvailableElements();this._areAvailableSchemeElementsChanged=false}this._mode=BX.Crm.EntityEditorMode.view;this._modeChangeNotifier.notify([this])},addSchemeElementAt:function(t,e){if(this._config){this._config.addSchemeElementAt(t,e)}},updateSchemeElement:function(t){if(this._config){this._config.updateSchemeElement(t)}},removeSchemeElement:function(t){if(this._config){this._config.removeSchemeElement(t)}},canChangeScheme:function(){if(this._isEmbedded){return false}return this._config&&this._config.isChangeable()},isSchemeChanged:function(){return this._config&&this._config.isChanged()},saveScheme:function(){return this._config&&this._config.save(false)},saveSchemeChanges:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].commitSchemeChanges()}return this._config&&this._config.save(false)},onSaveSuccess:function(t){this._isRequestRunning=false;if(this._toolPanel){this._toolPanel.processSaveComplete();this._toolPanel.clearErrors()}var e=BX.prop.getObject(t,"EVENT_PARAMS",{});e["entityTypeId"]=this._entityTypeId;var i=BX.prop.getObject(t,"ENTITY_INFO",null);if(i){e["entityInfo"]=i}var n=BX.Crm.Page.getTopSlider();if(n){e["sliderUrl"]=n.getUrl()}var r=BX.prop.getObject(t,"CHECK_ERRORS",null);var o=BX.prop.getString(t,"ERROR","");if(r||o!==""){if(r){var s=null;var a=[];for(var l in r){if(!r.hasOwnProperty(l)){return}var d=this.getActiveControlById(l,true);if(d){d.showError(r[l]);if(!s){s=d}}else{a.push(r[l])}}if(s){s.scrollAnimate()}o=a.join("<br/>")}if(o!==""&&this._toolPanel){this._toolPanel.addError(o)}e["checkErrors"]=r;e["error"]=o;if(this._isNew){BX.onCustomEvent(window,"onCrmEntityCreateError",[e])}else{e["entityId"]=this._entityId;BX.onCustomEvent(window,"onCrmEntityUpdateError",[e])}this.releaseAjaxForm();this.initializeAjaxForm();return}var h=BX.prop.getObject(t,"ENTITY_DATA",null);e["entityData"]=h;if(this._isNew){this._entityId=BX.prop.getInteger(t,"ENTITY_ID",0);if(this._entityId<=0){if(this._toolPanel){this._toolPanel.addError(this.getMessage("couldNotFindEntityIdError"))}return}BX.Crm.EntityEvent.fireCreate(this._entityTypeId,this._entityId,this._externalContextId,e);e["sender"]=this;e["entityId"]=this._entityId;BX.onCustomEvent(window,"onCrmEntityCreate",[e]);this._isNew=false}else{BX.Crm.EntityEvent.fireUpdate(this._entityTypeId,this._entityId,this._externalContextId,e);e["sender"]=this;e["entityId"]=this._entityId;BX.onCustomEvent(window,"onCrmEntityUpdate",[e])}var p=BX.prop.getString(t,"REDIRECT_URL","");var u=BX.prop.getObject(t,"EVENT_PARAMS",null);if(u){var c=BX.prop.getString(u,"name","");var m=BX.prop.getObject(u,"args",null);if(c!==""&&m!==null){if(p!==""){m["redirectUrl"]=p}BX.localStorage.set(c,m,10)}}if(this._isReleased){return}if(p!==""&&!this._isEmbedded){window.location.replace(BX.util.add_url_param(p,{IFRAME:"Y",IFRAME_TYPE:"SIDE_SLIDER"}))}else{if(BX.type.isPlainObject(h)){this._model.setData(h,{enableNotification:false})}this.adjustTitle();this.adjustSize();this.releaseAjaxForm();this.initializeAjaxForm();for(var y=0,g=this._controllers.length;y<g;y++){this._controllers[y].onAfterSave()}if(this._modeSwitch.isRunning()){this._modeSwitch.complete()}else{this.switchToViewMode({refreshLayout:false})}this.refreshLayout({reset:true});this.hideToolPanel()}},formatMoney:function(t,e,i){BX.ajax({url:BX.prop.getString(this._settings,"serviceUrl",""),method:"POST",dataType:"json",data:{ACTION:"GET_FORMATTED_SUM",CURRENCY_ID:e,SUM:t},onsuccess:i})},findOption:function(t,e){for(var i=0,n=e.length;i<n;i++){if(t===e[i].VALUE){return e[i].NAME}}return t},prepareConfigMenuItems:function(){var t=[];var e=BX.delegate(this.onMenuItemClick,this);if(this._config.getScope()===BX.Crm.EntityConfigScope.common){t.push({id:"switchToPersonalConfig",text:this.getMessage("switchToPersonalConfig"),onclick:e})}else{t.push({id:"switchToCommonConfig",text:this.getMessage("switchToCommonConfig"),onclick:e})}if(this.canChangeScheme()){t.push({id:"resetConfig",text:this.getMessage("resetConfig"),onclick:e});if(BX.prop.getBoolean(this._settings,"enableSettingsForAll",false)){t.push({id:"forceCommonConfigForAllUsers",text:this.getMessage("forceCommonConfigForAllUsers"),onclick:e})}}return t},getServiceUrl:function(){return this._serviceUrl},loadCustomHtml:function(t,e,i){e["ACTION"]=t;e["ACTION_ENTITY_ID"]=this._entityId;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:e,onsuccess:i})},onFormSubmit:function(t,e){this._isRequestRunning=true;if(this._toolPanel){this._toolPanel.processSaveBegin()}},isDuplicateControlEnabled:function(){return this._dupControlManager.isEnabled()},getDuplicateManager:function(){return this._dupControlManager},onResize:function(t){this.adjustSize()},onPageTileClick:function(t){if(!this._readOnly){this.switchTitleMode(BX.Crm.EntityEditorMode.edit)}},onCreateSectionButtonClick:function(t){if(!this.isSectionCreationEnabled()){return}var e=this.getControlCount();var i="user_"+BX.util.getRandomString(8).toLowerCase();var n=BX.Crm.EntitySchemeElement.create({type:"section",name:i,title:this.getMessage("newSectionTitle")});this.addSchemeElementAt(n,e);var r=this.createControl("section",i,{schemeElement:n,model:this._model,container:this._formElement});this.addControlAt(r,e);this.saveScheme();r.setMode(BX.Crm.EntityEditorMode.edit,{notify:false});r.refreshLayout();r.setTitleMode(BX.Crm.EntityEditorMode.edit);this.registerActiveControl(r)},onConfigMenuButtonClick:function(t){if(this._isConfigMenuShown){return}var e=this.prepareConfigMenuItems();if(e.length>0){BX.PopupMenu.show(this._id+"_config_menu",this._configMenuButton,e,{angle:false,autoHide:true,closeByEsc:true,events:{onPopupShow:function(){this._isConfigMenuShown=true}.bind(this),onPopupClose:function(){this._isConfigMenuShown=false}.bind(this)}})}},onPageTitleExternalClick:function(t){var e=BX.getEventTarget(t);if(e!==this._pageTitleInput){this.savePageTitle();this.switchTitleMode(BX.Crm.EntityEditorMode.view)}},onPageTitleKeyPress:function(t){var e=t.keyCode;if(e===13){this.savePageTitle();this.switchTitleMode(BX.Crm.EntityEditorMode.view)}else if(e===27){this.switchTitleMode(BX.Crm.EntityEditorMode.view)}},onInterfaceToolbarMenuBuild:function(t,e){var i=BX.prop.getArray(e,"items",null);if(!i){return}var n=this.prepareConfigMenuItems();if(n.length>0){if(i.length>0){i.push({delimiter:true})}for(var r=0,o=n.length;r<o;r++){i.push(n[r])}}},onMenuItemClick:function(t,e){var i=BX.prop.getString(e,"id","");if(i==="resetConfig"){this.resetConfig()}else if(i==="switchToPersonalConfig"){this.setConfigScope(BX.Crm.EntityConfigScope.personal)}else if(i==="switchToCommonConfig"){this.setConfigScope(BX.Crm.EntityConfigScope.common)}else if(i==="forceCommonConfigForAllUsers"){this.forceCommonConfigScopeForAll()}if(e.menuWindow){e.menuWindow.close()}},setConfigScope:function(t){this._config.setScope(t).then(function(){window.location.reload(true)})},forceCommonConfigScopeForAll:function(){this._config.forceCommonScopeForAll().then(function(){if(this._config.getScope()===BX.Crm.EntityConfigScope.personal){window.location.reload(true)}}.bind(this))},resetConfig:function(){this._config.reset(false).then(function(){window.location.reload(true)})},getConfigOption:function(t,e){return this._config.getOption(t,e)},setConfigOption:function(t,e){return this._config.setOption(t,e)},getAttributeManagerSettings:function(){return BX.prop.getObject(this._settings,"attributeConfig",null)},getOption:function(t,e){return BX.prop.getString(this._settings["options"],t,e)},setOption:function(t,e){if(typeof e==="undefined"||e===null){return}if(BX.prop.getString(this._settings["options"],t,null)===e){return}this._settings["options"][t]=e},getDragConfig:function(t){return BX.prop.getObject(this._dragConfig,t,{})},hasPlaceHolder:function(){return!!this._dragPlaceHolder},createPlaceHolder:function(t){var e=this.getControlCount();if(t<0||t>e){t=e>0?e:0}if(this._dragPlaceHolder){if(this._dragPlaceHolder.getIndex()===t){return this._dragPlaceHolder}this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}this._dragPlaceHolder=BX.Crm.EditorDragSectionPlaceholder.create({container:this._formElement,anchor:t<e?this._controls[t].getWrapper():null,index:t});this._dragPlaceHolder.layout();return this._dragPlaceHolder},getPlaceHolder:function(){return this._dragPlaceHolder},removePlaceHolder:function(){if(this._dragPlaceHolder){this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}},processDraggedItemDrop:function(t,e){var i=t.getCharge();if(!(i instanceof BX.Crm.EditorSectionDragContainer&&i.getEditor()===this)){return}var n=e.getContextData();var r=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(r!==BX.Crm.EditorSectionDragItem.contextId){return}var o=typeof n["charge"]!=="undefined"?n["charge"]:null;if(!(o instanceof BX.Crm.EditorSectionDragItem)){return}var s=o.getControl();if(!s){return}var a=this.getControlIndex(s);if(a<0){return}var l=this.getPlaceHolder();var d=l?l.getIndex():-1;if(d<0){return}var h=d<=a?d:d-1;if(h!==a){this.moveControl(s,h);this.saveScheme()}},onDrop:function(t,e,i,n){this.processDraggedItemDrop(t,e)},canCreateContact:function(){return BX.prop.getBoolean(this._settings,"canCreateContact",false)},canCreateCompany:function(){return BX.prop.getBoolean(this._settings,"canCreateCompany",false)}};BX.Crm.EntityEditor.defaultInstance=null;BX.Crm.EntityEditor.items={};BX.Crm.EntityEditor.get=function(t){return this.items.hasOwnProperty(t)?this.items[t]:null};if(typeof BX.Crm.EntityEditor.messages==="undefined"){BX.Crm.EntityEditor.messages={}}BX.Crm.EntityEditor.setDefault=function(t){BX.Crm.EntityEditor.defaultInstance=t};BX.Crm.EntityEditor.getDefault=function(){return BX.Crm.EntityEditor.defaultInstance};BX.Crm.EntityEditor.create=function(t,e){var i=new BX.Crm.EntityEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityEditorModeQueue==="undefined"){BX.Crm.EntityEditorModeQueue=function(){this._id="";this._settings={};this._items=[]};BX.Crm.EntityEditorModeQueue.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{}},findIndex:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]["control"]===t){return e}}return-1},getLength:function(){return this._items.length},add:function(t,e,i){if(typeof i==="undefined"){i=BX.Crm.EntityEditorModeOptions.none}var n=this.findIndex(t);if(n>=0){this._items[n]={control:t,mode:e,options:i}}else{this._items.push({control:t,mode:e,options:i})}},addBatch:function(t,e,i){for(var n=0,r=t.length;n<r;n++){this.add(t[n],e,i)}},remove:function(t){var e=this.findIndex(t);if(e>=0){this._items.splice(e,1)}},clear:function(){this._items=[]},process:function(){var t=this._items.length;if(t===0){return 0}for(var e=0;e<t;e++){var i=this._items[e];i["control"].setMode(i["mode"],{options:i["options"],notify:true})}return t}};BX.Crm.EntityEditorModeQueue.create=function(t,e){var i=new BX.Crm.EntityEditorModeQueue;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorModeSwitch==="undefined"){BX.Crm.EntityEditorModeSwitch=function(){this._id="";this._settings={};this._queue=null;this._isRunning=false;this._runHandle=0};BX.Crm.EntityEditorModeSwitch.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._queue=BX.Crm.EntityEditorModeQueue.create(this._id,{})},getQueue:function(){return this._queue},reset:function(){this._queue.clear();this._isRunning=false},isRunning:function(){return this._isRunning},run:function(){if(this._isRunning){return}if(this._runHandle>0){window.clearTimeout(this._runHandle)}this._runHandle=window.setTimeout(BX.delegate(this.doRun,this),50)},doRun:function(){this._editor.saveDelayed();this._isRunning=true;this._runHandle=0},complete:function(){this._queue.process();this.reset()}};BX.Crm.EntityEditorModeSwitch.create=function(t,e){var i=new BX.Crm.EntityEditorModeSwitch;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMode==="undefined"){BX.Crm.EntityEditorMode={intermediate:0,edit:1,view:2,names:{view:"view",edit:"edit"},getName:function(t){if(t===this.edit){return this.names.edit}else if(t===this.view){return this.names.view}return""},parse:function(t){t=t.toLowerCase();if(t===this.names.edit){return this.edit}else if(t===this.names.view){return this.view}return this.intermediate}}}if(typeof BX.Crm.EntityEditorModeOptions==="undefined"){BX.Crm.EntityEditorModeOptions={none:0,exclusive:1,individual:2,saveOnExit:64,check:function(t,e){return(t&e)===e}}}if(typeof BX.Crm.EntityEditorControlOptions==="undefined"){BX.Crm.EntityEditorControlOptions={none:0,showAlways:1,check:function(t,e){return(t&e)===e}}}if(typeof BX.Crm.EntityEditorPriority==="undefined"){BX.Crm.EntityEditorPriority={undefined:0,normal:1,high:2}}if(typeof BX.Crm.EntityEditorModeSwitchType==="undefined"){BX.Crm.EntityEditorModeSwitchType={none:0,common:1,button:2,content:4,check:function(t,e){return(t&e)===e}}}if(typeof BX.Crm.EditorDialogButton==="undefined"){BX.Crm.EditorDialogButton=function(){this._id="";this._type=BX.Crm.DialogButtonType.undefined;this._settings={};this._dialog=null;this._keyPressHandler=BX.delegate(this.onKeyPress,this)};BX.Crm.EditorDialogButton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._type=BX.prop.getInteger(this._settings,"type",BX.Crm.DialogButtonType.undefined);this._dialog=BX.prop.get(this._settings,"dialog",null)},bind:function(){if(this._type===BX.Crm.DialogButtonType.accept){BX.bind(document,"keydown",this._keyPressHandler)}},unbind:function(){if(this._type===BX.Crm.DialogButtonType.accept){BX.unbind(document,"keydown",this._keyPressHandler)}},onKeyPress:function(t){if(this._type!==BX.Crm.DialogButtonType.accept){return}t=t||window.event;if(t.keyCode===13){this.onClick(t)}},getId:function(){return this._id},getDialog:function(){return this._dialog},prepareContent:function(){if(this._type===BX.Crm.DialogButtonType.accept){return new BX.PopupWindowButton({text:BX.prop.getString(this._settings,"text",this._id),className:"ui-btn ui-btn-success",events:{click:BX.delegate(this.onClick,this)}})}else if(this._type===BX.Crm.DialogButtonType.cancel){return new BX.PopupWindowButtonLink({text:BX.prop.getString(this._settings,"text",this._id),className:"ui-btn ui-btn-link",events:{click:BX.delegate(this.onClick,this)}})}else{return new BX.PopupWindowButton({text:BX.prop.getString(this._settings,"text",this._id),events:{click:BX.delegate(this.onClick,this)}})}},onClick:function(t){var e=BX.prop.getFunction(this._settings,"callback",null);if(e){e(this)}}};BX.Crm.EditorDialogButton.create=function(t,e){var i=new BX.Crm.EditorDialogButton;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorAuxiliaryDialog==="undefined"){BX.Crm.EditorAuxiliaryDialog=function(){this._id="";this._settings={};this._popup=null;this._buttons=null};BX.Crm.EditorAuxiliaryDialog.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{}},getSetting:function(t,e){return BX.prop.get(this._settings,t,e)},getId:function(){return this._id},open:function(){this._popup=new BX.PopupWindow(this._id,BX.prop.getElementNode(this._settings,"anchor",null),{autoHide:false,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:BX.prop.getInteger(this._settings,"zIndex",0),bindOptions:{forceBindPosition:true},titleBar:BX.prop.getString(this._settings,"title","No title"),content:BX.prop.getString(this._settings,"content",""),buttons:this.prepareButtons(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._popup.show()},close:function(){if(this._popup){this._popup.close()}},isOpen:function(){return this._popup&&this._popup.isShown()},prepareButtons:function(){var t=[];this._buttons=[];var e=BX.prop.getArray(this._settings,"buttons",[]);for(var i=0,n=e.length;i<n;i++){var r=e[i];r["dialog"]=this;var o=BX.Crm.EditorDialogButton.create(BX.prop.getString(r,"id",""),r);this._buttons.push(o);t.push(o.prepareContent())}return t},bind:function(){for(var t=0,e=this._buttons.length;t<e;t++){this._buttons[t].bind()}},unbind:function(){for(var t=0,e=this._buttons.length;t<e;t++){this._buttons[t].unbind()}},onPopupShow:function(){this.bind()},onPopupClose:function(){this.unbind();if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){if(this._popup){this._popup=null}delete BX.Crm.EditorAuxiliaryDialog.items[this.getId()]}};BX.Crm.EditorAuxiliaryDialog.items={};BX.Crm.EditorAuxiliaryDialog.hasOpenItems=function(){for(var t in this.items){if(!this.items.hasOwnProperty(t)){continue}if(this.items[t].isOpen()){return true}}return false};BX.Crm.EditorAuxiliaryDialog.create=function(t,e){var i=new BX.Crm.EditorAuxiliaryDialog;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EditorFileStorageType==="undefined"){BX.Crm.EditorFileStorageType={undefined:0,file:1,webdav:2,diskfile:3}}if(typeof BX.Crm.EntityValidator==="undefined"){BX.Crm.EntityValidator=function(){this._settings={};this._editor=null;this._data=null};BX.Crm.EntityValidator.prototype={initialize:function(t){this._settings=t?t:{};this._editor=BX.prop.get(this._settings,"editor",null);this._data=BX.prop.getObject(this._settings,"data",{});this.doInitialize()},doInitialize:function(){},release:function(){},getData:function(){return this._data},getDataStringParam:function(t,e){return BX.prop.getString(this._data,t,e)},getErrorMessage:function(){return BX.prop.getString(this._settings,"message","")},validate:function(t){return true},processControlChange:function(t){}}}if(typeof BX.Crm.EntityPersonValidator==="undefined"){BX.Crm.EntityPersonValidator=function(){BX.Crm.EntityPersonValidator.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityPersonValidator,BX.Crm.EntityValidator);BX.Crm.EntityPersonValidator.prototype.doInitialize=function(){this._nameField=this._editor.getControlById(this.getDataStringParam("nameField",""));if(this._nameField){this._nameField.addValidator(this)}this._lastNameField=this._editor.getControlById(this.getDataStringParam("lastNameField",""));if(this._lastNameField){this._lastNameField.addValidator(this)}};BX.Crm.EntityPersonValidator.prototype.release=function(){if(this._nameField){this._nameField.removeValidator(this)}if(this._lastNameField){this._lastNameField.removeValidator(this)}};BX.Crm.EntityPersonValidator.prototype.validate=function(t){var e=this._nameField.isActive();var i=this._lastNameField.isActive();if(!e&&!i){return true}var n=e?this._nameField.getRuntimeValue():this._nameField.getValue();var r=i?this._lastNameField.getRuntimeValue():this._lastNameField.getValue();if(n!==""||r!==""){return true}if(n===""&&e){t.addError(BX.Crm.EntityValidationError.create({field:this._nameField}));this._nameField.showError(this.getErrorMessage())}if(r===""&&i){t.addError(BX.Crm.EntityValidationError.create({field:this._lastNameField}));this._lastNameField.showError(this.getErrorMessage())}return false};BX.Crm.EntityPersonValidator.prototype.processFieldChange=function(t){if(t!==this._nameField&&t!==this._lastNameField){return}if(this._nameField){this._nameField.clearError()}if(this._lastNameField){this._lastNameField.clearError()}};BX.Crm.EntityPersonValidator.create=function(t){var e=new BX.Crm.EntityPersonValidator;e.initialize(t);return e}}if(typeof BX.Crm.EntityValidationError==="undefined"){BX.Crm.EntityValidationError=function(){this._settings={};this._field=null;this._message=""};BX.Crm.EntityValidationError.prototype={initialize:function(t){this._settings=t?t:{};this._field=BX.prop.get(this._settings,"field",null);this._message=BX.prop.getString(this._settings,"message","")},getField:function(){return this._field},getMessage:function(){return this._message}};BX.Crm.EntityValidationError.create=function(t){var e=new BX.Crm.EntityValidationError;e.initialize(t);return e}}if(typeof BX.Crm.EntityValidationResult==="undefined"){BX.Crm.EntityValidationResult=function(){this._settings={};this._errors=[]};BX.Crm.EntityValidationResult.prototype={initialize:function(t){this._settings=t?t:{}},getStatus:function(){return this._errors.length===0},addError:function(t){this._errors.push(t)},getErrors:function(){return this._errors},addResult:function(t){var e=t.getErrors();for(var i=0,n=e.length;i<n;i++){this._errors.push(e[i])}},getTopmostField:function(){var t=null;var e=null;for(var i=0,n=this._errors.length;i<n;i++){var r=this._errors[i].getField();if(!t){t=r;e=r.getPosition()["top"];continue}var o=r.getPosition();if(!o){continue}var s=r.getPosition()["top"];if(s<e){t=r;e=s}}return t}};BX.Crm.EntityValidationResult.create=function(t){var e=new BX.Crm.EntityValidationResult;e.initialize(t);return e}}if(typeof BX.Crm.EntityConfigScope==="undefined"){BX.Crm.EntityConfigScope={undefined:"",personal:"P",common:"C"};if(typeof BX.Crm.EntityConfigScope.captions==="undefined"){BX.Crm.EntityConfigScope.captions={}}BX.Crm.EntityConfigScope.setCaptions=function(t){if(BX.type.isPlainObject(t)){this.captions=t}};BX.Crm.EntityConfigScope.getCaption=function(t){return BX.prop.getString(this.captions,t,t)}}if(typeof BX.Crm.EntityConfig==="undefined"){BX.Crm.EntityConfig=function(){this._id="";this._settings={};this._scope=BX.Crm.EntityConfigScope.undefined;this._canUpdateConfiguration=false;this._data={};this._items=[];this._options={};this._userFieldManager=null;this._serviceUrl="";this._isChanged=false};BX.Crm.EntityConfig.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._scope=BX.prop.getString(this._settings,"scope",BX.Crm.EntityConfigScope.personal);this._canUpdateConfiguration=BX.prop.getBoolean(this._settings,"canUpdateConfiguration",false);this._data=BX.prop.getArray(this._settings,"data",[]);this._items=[];for(var i=0,n=this._data.length;i<n;i++){var r=this._data[i];var o=BX.prop.getString(r,"type","");if(o==="section"){this._items.push(BX.Crm.EntityConfigSection.create({data:r}))}else{this._items.push(BX.Crm.EntityConfigField.create({data:r}))}}this._options=BX.prop.getObject(this._settings,"options",{});this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._userFieldManager=BX.prop.get(this._settings,"userFieldManager",null)},findItemByName:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getName()===t){return n}}return null},findItemIndexByName:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getName()===t){return e}}return-1},toJSON:function(){var t=[];for(var e=0,i=this._items.length;e<i;e++){t.push(this._items[e].toJSON())}return t},addSchemeElementAt:function(t,e){var i=t.createConfigItem();var n=t.getType()==="section"?BX.Crm.EntityConfigSection.create({data:i}):BX.Crm.EntityConfigField.create({data:i});if(e>=0&&e<this._items.length){this._items.splice(e,0,n)}else{this._items.push(n)}this._isChanged=true},moveSchemeElement:function(t,e){var i=this._items.length;var n=i-1;if(e<0||e>i){e=n}var r=this.findItemIndexByName(t.getName());if(r<0||r===e){return}var o=this._items[r];this._items.splice(r,1);i--;if(e<i){this._items.splice(e,0,o)}else{this._items.push(o)}this._isChanged=true},updateSchemeElement:function(t){if(this._scope===BX.Crm.EntityConfigScope.common){this.updateSchemeElementCommonData(t)}var e;var i=t.getParent();if(i){var n=this.findItemByName(i.getName());if(n){e=n.findFieldIndexByName(t.getName());if(e>=0){n.setField(BX.Crm.EntityConfigField.create({data:t.createConfigItem()}),e);this._isChanged=true}}}else{e=this.findItemIndexByName(t.getName());if(e>=0){if(t.getType()==="section"){this._items[e]=BX.Crm.EntityConfigSection.create({data:t.createConfigItem()})}else{this._items[e]=BX.Crm.EntityConfigField.create({data:t.createConfigItem()})}this._isChanged=true}}},updateSchemeElementCommonData:function(t){if(this._scope!==BX.Crm.EntityConfigScope.common){return}var e,i;var n=[];if(t.getType()==="section"){var r=t.getElements();for(e=0,i=r.length;e<i;e++){if(r[e].getType()==="userField"){n.push(r[e])}}}else if(t.getType()==="userField"){n.push(t)}for(e=0,i=n.length;e<i;e++){var o=n[e];if(o.hasCustomizedTitle()){this._userFieldManager.setSharedLabel(o.getName(),o.getTitle());o.resetOriginalTitle()}}},removeSchemeElement:function(t){var e=this.findItemIndexByName(t.getName());if(e<0){return}this._items.splice(e,1);this._isChanged=true},isChangeable:function(){return this._canUpdateConfiguration||this._scope===BX.Crm.EntityConfigScope.personal},isChanged:function(){return this._isChanged},getScope:function(){return this._scope},setScope:function(t){if(this._scope===t){return}this._scope=t;this._data=[];this._items=[];var e=new BX.Promise;BX.ajax.post(this._serviceUrl,{guid:this._id,action:"setScope",scope:this._scope},function(){e.fulfill()});return e},registerField:function(t){var e=t.getParent();if(!e){return}var i=this.findItemByName(e.getName());if(!i){return}i.addField(BX.Crm.EntityConfigField.create({data:t.createConfigItem()}));this.save()},unregisterField:function(t){var e=t.getParent();if(!e){return}var i=this.findItemByName(e.getName());if(!i){return}var n=i.findFieldByName(t.getName());if(!n){return}i.removeFieldByIndex(n.getIndex());this.save()},save:function(t,e){t=!!t;e=!!e;var i=new BX.Promise;if(!this._isChanged&&!t){window.setTimeout(function(){i.fulfill()},0);return i}var n={guid:this._id,action:"save",scope:this._scope,config:this.toJSON()};if(e){n["options"]=this._options}if(this._scope===BX.Crm.EntityConfigScope.personal&&t){n["forAllUsers"]="Y";n["delete"]="Y"}BX.ajax.post(this._serviceUrl,n,function(){i.fulfill()});this._isChanged=false;return i},reset:function(t){var e={guid:this._id,action:"reset",scope:this._scope,config:this.toJSON()};if(t){e["forAllUsers"]="Y"}var i=new BX.Promise;BX.ajax.post(this._serviceUrl,e,function(){i.fulfill()});return i},forceCommonScopeForAll:function(){var t=new BX.Promise;BX.ajax.post(this._serviceUrl,{guid:this._id,action:"forceCommonScopeForAll"},function(){t.fulfill()});return t},getOption:function(t,e){return BX.prop.getString(this._options,t,e)},setOption:function(t,e){if(typeof e==="undefined"||e===null){return}if(BX.prop.getString(this._options,t,null)===e){return}this._options[t]=e;if(this._scope===BX.Crm.EntityConfigScope.common){BX.userOptions.save("crm.entity.editor",this._id+"_common_opts",t,e,true)}else{BX.userOptions.save("crm.entity.editor",this._id+"_opts",t,e,false)}}};BX.Crm.EntityConfig.create=function(t,e){var i=new BX.Crm.EntityConfig;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityConfigItem==="undefined"){BX.Crm.EntityConfigItem=function(){this._settings={};this._data={};this._name="";this._title=""};BX.Crm.EntityConfigItem.prototype={initialize:function(t){this._settings=t?t:{};this._data=BX.prop.getObject(this._settings,"data",[]);this._name=BX.prop.getString(this._data,"name","");this._title=BX.prop.getString(this._data,"title","");this.doInitialize()},doInitialize:function(){},getType:function(){return""},getName:function(){return this._name},getTitle:function(){return this._title},toJSON:function(){return{}}}}if(typeof BX.Crm.EntityConfigSection==="undefined"){BX.Crm.EntityConfigSection=function(){BX.Crm.EntityConfigSection.superclass.constructor.apply(this);this._fields=[]};BX.extend(BX.Crm.EntityConfigSection,BX.Crm.EntityConfigItem);BX.Crm.EntityConfigSection.prototype.doInitialize=function(){this._fields=[];var t=BX.prop.getArray(this._data,"elements",[]);for(var e=0,i=t.length;e<i;e++){var n=BX.Crm.EntityConfigField.create({data:t[e]});n.setIndex(e);this._fields.push(n)}};BX.Crm.EntityConfigSection.prototype.getType=function(){return"section"};BX.Crm.EntityConfigSection.prototype.getFields=function(){return this._fields};BX.Crm.EntityConfigSection.prototype.findFieldByName=function(t){var e=this.findFieldIndexByName(t);return e>=0?this._fields[e]:null};BX.Crm.EntityConfigSection.prototype.findFieldIndexByName=function(t){for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e];if(n.getName()===t){return e}}return-1};BX.Crm.EntityConfigSection.prototype.addField=function(t){this._fields.push(t)};BX.Crm.EntityConfigSection.prototype.setField=function(t,e){this._fields[e]=t};BX.Crm.EntityConfigSection.prototype.removeFieldByIndex=function(t){var e=this._fields.length;if(t<0||t>=e){return false}this._fields.splice(t,1);return true};BX.Crm.EntityConfigSection.prototype.toJSON=function(){var t={name:this._name,title:this._title,type:"section",elements:[]};for(var e=0,i=this._fields.length;e<i;e++){t.elements.push(this._fields[e].toJSON())}return t};BX.Crm.EntityConfigSection.create=function(t){var e=new BX.Crm.EntityConfigSection;e.initialize(t);return e}}if(typeof BX.Crm.EntityConfigField==="undefined"){BX.Crm.EntityConfigField=function(){BX.Crm.EntityConfigField.superclass.constructor.apply(this);this._index=-1;this._optionFlags=0};BX.extend(BX.Crm.EntityConfigField,BX.Crm.EntityConfigItem);BX.Crm.EntityConfigField.prototype.doInitialize=function(){this._optionFlags=BX.prop.getInteger(this._data,"optionFlags",0)};BX.Crm.EntityConfigField.prototype.toJSON=function(){var t={name:this._name};if(this._title!==""){t["title"]=this._title}if(this._optionFlags>0){t["optionFlags"]=this._optionFlags}return t};BX.Crm.EntityConfigField.prototype.getIndex=function(){return this._index};BX.Crm.EntityConfigField.prototype.setIndex=function(t){this._index=t};BX.Crm.EntityConfigField.create=function(t){var e=new BX.Crm.EntityConfigField;e.initialize(t);return e}}if(typeof BX.Crm.EntityScheme==="undefined"){BX.Crm.EntityScheme=function(){this._id="";this._settings={};this._elements=null;this._availableElements=null};BX.Crm.EntityScheme.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._elements=[];this._availableElements=[];var i,n;var r=BX.prop.getArray(this._settings,"current",[]);for(i=0,n=r.length;i<n;i++){this._elements.push(BX.Crm.EntitySchemeElement.create(r[i]))}var o=BX.prop.getArray(this._settings,"available",[]);for(i=0,n=o.length;i<n;i++){this._availableElements.push(BX.Crm.EntitySchemeElement.create(o[i]))}},getId:function(){return this._id},getElements:function(){return[].concat(this._elements)},getAvailableElements:function(){return[].concat(this._availableElements)},setAvailableElements:function(t){this._availableElements=BX.type.isArray(t)?t:[]}};BX.Crm.EntityScheme.create=function(t,e){var i=new BX.Crm.EntityScheme;i.initialize(t,e);return i}}if(typeof BX.Crm.EntitySchemeElement==="undefined"){BX.Crm.EntitySchemeElement=function(){this._settings={};this._name="";this._type="";this._title="";this._originalTitle="";this._optionFlags=0;this._isEditable=true;this._isTransferable=true;this._isContextMenuEnabled=true;this._isRequired=false;this._isRequiredConditionally=false;this._isHeading=false;this._visibilityPolicy=BX.Crm.EntityEditorVisibilityPolicy.always;this._data=null;this._elements=null;this._parent=null};BX.Crm.EntitySchemeElement.prototype={initialize:function(t){this._settings=t?t:{};this._name=BX.prop.getString(this._settings,"name","");this._type=BX.prop.getString(this._settings,"type","");this._isEditable=BX.prop.getBoolean(this._settings,"editable",true);this._isTransferable=BX.prop.getBoolean(this._settings,"transferable",true);this._isContextMenuEnabled=BX.prop.getBoolean(this._settings,"enabledMenu",true);this._isTitleEnabled=BX.prop.getBoolean(this._settings,"enableTitle",true);this._isDragEnabled=BX.prop.getBoolean(this._settings,"isDragEnabled",true);this._isRequired=BX.prop.getBoolean(this._settings,"required",false);this._isRequiredConditionally=BX.prop.getBoolean(this._settings,"requiredConditionally",false);this._isHeading=BX.prop.getBoolean(this._settings,"isHeading",false);this._visibilityPolicy=BX.Crm.EntityEditorVisibilityPolicy.parse(BX.prop.getString(this._settings,"visibilityPolicy",""));this._data=BX.prop.getObject(this._settings,"data",{});var e=BX.prop.getString(this._settings,"title","");var i=BX.prop.getString(this._settings,"originalTitle","");if(e!==""&&i===""){i=e}else if(i!==""&&e===""){e=i}this._title=e;this._originalTitle=i;this._optionFlags=BX.prop.getInteger(this._settings,"optionFlags",0);this._elements=[];var n=BX.prop.getArray(this._settings,"elements",[]);for(var r=0,o=n.length;r<o;r++){this._elements.push(BX.Crm.EntitySchemeElement.create(n[r]))}},mergeSettings:function(t){this.initialize(BX.mergeEx(this._settings,t))},getName:function(){return this._name},getType:function(){return this._type},getTitle:function(){return this._title},setTitle:function(t){this._title=this._settings["title"]=t},getOriginalTitle:function(){return this._originalTitle},hasCustomizedTitle:function(){return this._title!==""&&this._title!==this._originalTitle},resetOriginalTitle:function(){this._originalTitle=this._title},getOptionFlags:function(){return this._optionFlags},setOptionFlags:function(t){this._optionFlags=this._settings["optionFlags"]=t},areAttributesEnabled:function(){return BX.prop.getBoolean(this._settings,"enableAttributes",true)},isEditable:function(){return this._isEditable},isTransferable:function(){return this._isTransferable},isRequired:function(){return this._isRequired},isRequiredConditionally:function(){return this._isRequiredConditionally},isContextMenuEnabled:function(){return this._isContextMenuEnabled},isTitleEnabled:function(){return this._isTitleEnabled},isDragEnabled:function(){return this._isDragEnabled},isHeading:function(){return this._isHeading},getCreationPlaceholder:function(){return BX.prop.getString(BX.prop.getObject(this._settings,"placeholders",null),"creation","")},getVisibilityPolicy:function(){return this._visibilityPolicy},getData:function(){return this._data},setData:function(t){this._data=t},getDataParam:function(t,e){return BX.prop.get(this._data,t,e)},getDataStringParam:function(t,e){return BX.prop.getString(this._data,t,e)},getDataIntegerParam:function(t,e){return BX.prop.getInteger(this._data,t,e)},getDataBooleanParam:function(t,e){return BX.prop.getBoolean(this._data,t,e)},getDataObjectParam:function(t,e){return BX.prop.getObject(this._data,t,e)},getDataArrayParam:function(t,e){return BX.prop.getArray(this._data,t,e)},getElements:function(){return this._elements},setElements:function(t){this._elements=t},getAffectedFields:function(){var t=this.getDataArrayParam("affectedFields",[]);if(t.length===0){t.push(this._name)}return t},getParent:function(){return this._parent},setParent:function(t){this._parent=t instanceof BX.Crm.EntitySchemeElement?t:null},hasAttributeConfiguration:function(t){return!!this.getAttributeConfiguration(t)},getAttributeConfiguration:function(t){var e=this.getData();var i=BX.prop.getArray(e,"attrConfigs",null);if(!i){return null}for(var n=0,r=i.length;n<r;n++){var o=i[n];if(BX.prop.getInteger(o,"typeId",BX.Crm.EntityFieldAttributeType.undefined)===t){return BX.clone(o)}}return null},setAttributeConfiguration:function(t){var e=BX.prop.getInteger(t,"typeId",BX.Crm.EntityFieldAttributeType.undefined);if(typeof this._data["attrConfigs"]==="undefined"){this._data["attrConfigs"]=[]}var i=-1;for(var n=0,r=this._data["attrConfigs"].length;n<r;n++){if(BX.prop.getInteger(this._data["attrConfigs"][n],"typeId",BX.Crm.EntityFieldAttributeType.undefined)===e){i=n;break}}if(i>=0){this._data["attrConfigs"].splice(i,1,t)}else{this._data["attrConfigs"].push(t)}},removeAttributeConfiguration:function(t){if(typeof this._data["attrConfigs"]==="undefined"){return}for(var e=0,i=this._data["attrConfigs"].length;e<i;e++){if(BX.prop.getInteger(this._data["attrConfigs"][e],"typeId",BX.Crm.EntityFieldAttributeType.undefined)===t){this._data["attrConfigs"].splice(e,1);return}}},createConfigItem:function(){var t={name:this._name};if(this._type==="section"){t["type"]="section";if(this._title!==""){t["title"]=this._title}t["elements"]=[];for(var e=0,i=this._elements.length;e<i;e++){t["elements"].push(this._elements[e].createConfigItem())}}else{if(this._title!==""&&this._title!==this._originalTitle){t["title"]=this._title}if(this._optionFlags>0){t["optionFlags"]=this._optionFlags}}return t},clone:function(){return BX.Crm.EntitySchemeElement.create(BX.clone(this._settings))}};BX.Crm.EntitySchemeElement.create=function(t){var e=new BX.Crm.EntitySchemeElement;e.initialize(t);return e}}if(typeof BX.Crm.EntityEditorValidatorFactory==="undefined"){BX.Crm.EntityEditorValidatorFactory={create:function(t,e){if(t==="person"){return BX.Crm.EntityPersonValidator.create(e)}return null}}}if(typeof BX.Crm.EntityEditorControlFactory==="undefined"){BX.Crm.EntityEditorControlFactory={initialized:false,methods:{},isInitialized:function(){return this.initialized},initialize:function(){if(this.initialized){return}var t={methods:{}};BX.onCustomEvent(window,"BX.Crm.EntityEditorControlFactory:onInitialize",[this,t]);for(var e in t.methods){if(t.methods.hasOwnProperty(e)){this.registerFactoryMethod(e,t.methods[e])}}this.initialized=true},registerFactoryMethod:function(t,e){if(BX.type.isFunction(e)){this.methods[t]=e}},create:function(t,e,i){if(!this.initialized){this.initialize()}if(t==="section"){return BX.Crm.EntityEditorSection.create(e,i)}else if(t==="text"){return BX.Crm.EntityEditorText.create(e,i)}else if(t==="number"){return BX.Crm.EntityEditorNumber.create(e,i)}else if(t==="datetime"){return BX.Crm.EntityEditorDatetime.create(e,i)}else if(t==="boolean"){return BX.Crm.EntityEditorBoolean.create(e,i)}else if(t==="list"){return BX.Crm.EntityEditorList.create(e,i)}else if(t==="multilist"){return BX.Crm.EntityEditorMultiList.create(e,i)}else if(t==="html"){return BX.Crm.EntityEditorHtml.create(e,i)}else if(t==="money"){return BX.Crm.EntityEditorMoney.create(e,i)}else if(t==="image"){return BX.Crm.EntityEditorImage.create(e,i)}else if(t==="user"){return BX.Crm.EntityEditorUser.create(e,i)}else if(t==="address"){return BX.Crm.EntityEditorAddress.create(e,i)}else if(t==="crm_entity"){return BX.Crm.EntityEditorEntity.create(e,i)}else if(t==="file_storage"){return BX.Crm.EntityEditorFileStorage.create(e,i)}else if(t==="client"){return BX.Crm.EntityEditorClient.create(e,i)}else if(t==="client_light"){return BX.Crm.EntityEditorClientLight.create(e,i)}else if(t==="multifield"){return BX.Crm.EntityEditorMultifield.create(e,i)}else if(t==="product_row_summary"){return BX.Crm.EntityEditorProductRowSummary.create(e,i)}else if(t==="requisite_selector"){return BX.Crm.EntityEditorRequisiteSelector.create(e,i)}else if(t==="requisite_list"){return BX.Crm.EntityEditorRequisiteList.create(e,i)}else if(t==="userField"){return BX.Crm.EntityEditorUserField.create(e,i)}else if(t==="userFieldConfig"){return BX.Crm.EntityEditorUserFieldConfigurator.create(e,i)}else if(t==="recurring"){return BX.Crm.EntityEditorRecurring.create(e,i)}else if(t==="recurring_custom_row"){return BX.Crm.EntityEditorRecurringCustomRowField.create(e,i)}else if(t==="recurring_single_row"){return BX.Crm.EntityEditorRecurringSingleField.create(e,i)}else if(t==="custom"){return BX.Crm.EntityEditorCustom.create(e,i)}else if(t==="shipment"){return BX.Crm.EntityEditorShipment.create(e,i)}else if(t==="payment"){return BX.Crm.EntityEditorPayment.create(e,i)}else if(t==="payment_status"){return BX.Crm.EntityEditorPaymentStatus.create(e,i)}else if(t==="payment_check"){return BX.Crm.EntityEditorPaymentCheck.create(e,i)}else if(t==="order_subsection"){return BX.Crm.EntityEditorSubsection.create(e,i)}else if(t==="order_property_wrapper"){return BX.Crm.EntityEditorOrderPropertyWrapper.create(e,i)}else if(t==="order_property_subsection"){return BX.Crm.EntityEditorOrderPropertySubsection.create(e,i)}else if(t==="order_property_file"){return BX.Crm.EntityEditorOrderPropertyFile.create(e,i)}else if(t==="order_product_property"){return BX.Crm.EntityEditorOrderProductProperty.create(e,i)}else if(t==="order_person_type"){return BX.Crm.EntityEditorOrderPersonType.create(e,i)}else if(t==="order_quantity"){return BX.Crm.EntityEditorOrderQuantity.create(e,i)}else if(t==="order_user"){return BX.Crm.EntityEditorOrderUser.create(e,i)}else if(t==="order_client"){return BX.Crm.EntityEditorOrderClient.create(e,i)}else if(t==="hidden"){return BX.Crm.EntityEditorHidden.create(e,i)}else if(t==="delivery_selector"){return BX.Crm.EntityEditorDeliverySelector.create(e,i)}else if(t==="shipment_extra_services"){return BX.Crm.EntityEditorShipmentExtraServices.create(e,i)}for(var n in this.methods){if(!this.methods.hasOwnProperty(n)){continue}var r=this.methods[n](t,e,i);if(r){return r}}return null}}}if(typeof BX.Crm.EntityEditorControllerFactory==="undefined"){BX.Crm.EntityEditorControllerFactory={create:function(t,e,i){if(t==="product_row_proxy"){return BX.Crm.EntityEditorProductRowProxy.create(e,i)}else if(t==="order_controller"){return BX.Crm.EntityEditorOrderController.create(e,i)}else if(t==="order_shipment_controller"){return BX.Crm.EntityEditorOrderShipmentController.create(e,i)}else if(t==="order_payment_controller"){return BX.Crm.EntityEditorOrderPaymentController.create(e,i)}else if(t==="order_product_controller"){return BX.Crm.EntityEditorOrderProductController.create(e,i)}return null}}}if(typeof BX.Crm.EntityEditorModelFactory==="undefined"){BX.Crm.EntityEditorModelFactory={create:function(t,e,i){if(t===BX.CrmEntityType.enumeration.lead){return BX.Crm.LeadModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.contact){return BX.Crm.ContactModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.company){return BX.Crm.CompanyModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.deal){return BX.Crm.DealModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.dealrecurring){return BX.Crm.DealRecurringModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.quote){return BX.Crm.QuoteModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.order){return BX.Crm.OrderModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.orderpayment){return BX.Crm.OrderPaymentModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.ordershipment){return BX.Crm.OrderShipmentModel.create(e,i)}return BX.Crm.EntityModel.create(e,i)}}}if(typeof BX.Crm.EntityModel==="undefined"){BX.Crm.EntityModel=function(){this._id="";this._settings={};this._data=null;this._initData=null;this._lockedFields=null;this._changeNotifier=null;this._lockNotifier=null};BX.Crm.EntityModel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._data=BX.prop.getObject(this._settings,"data",{});this._initData=BX.clone(this._data);this._lockedFields={};this._changeNotifier=BX.CrmNotifier.create(this);this._lockNotifier=BX.CrmNotifier.create(this);this.doInitialize()},doInitialize:function(){},getEntityTypeId:function(){return BX.CrmEntityType.enumeration.undefined},getEntityId:function(){return BX.prop.getInteger(this._data,"ID",0)},getOwnerInfo:function(){return{ownerID:this.getEntityId(),ownerType:BX.CrmEntityType.resolveName(this.getEntityTypeId())}},getField:function(t,e){if(e===undefined){e=null}return BX.prop.get(this._data,t,e)},getStringField:function(t,e){if(e===undefined){e=null}return BX.prop.getString(this._data,t,e)},getIntegerField:function(t,e){if(e===undefined){e=null}return BX.prop.getInteger(this._data,t,e)},getNumberField:function(t,e){if(e===undefined){e=null}return BX.prop.getNumber(this._data,t,e)},getArrayField:function(t,e){if(e===undefined){e=null}return BX.prop.getArray(this._data,t,e)},setField:function(t,e,i){if(this._data.hasOwnProperty(t)&&this._data[t]===e){return}this._data[t]=e;if(!BX.type.isPlainObject(i)){i={}}if(BX.prop.getBoolean(i,"enableNotification",true)){this._changeNotifier.notify([{name:t,originator:BX.prop.get(i,"originator",null)}]);BX.onCustomEvent(window,"Crm.EntityModel.Change",[this,{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId(),fieldName:t}])}},getData:function(){return this._data},setData:function(t,e){this._data=BX.type.isPlainObject(t)?t:{};this._initData=BX.clone(this._data);if(BX.prop.getBoolean(e,"enableNotification",true)){this._changeNotifier.notify([{forAll:true,originator:BX.prop.get(e,"originator",null)}]);BX.onCustomEvent(window,"Crm.EntityModel.Change",[this,{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId(),forAll:true}])}},getSchemeField:function(t,e,i){return this.getField(t.getDataStringParam(e,""),i)},getMappedField:function(t,e,i){var n=BX.prop.getString(t,e,"");return n!==""?this.getField(n,i):i},setMappedField:function(t,e,i){var n=BX.prop.getString(t,e,"");if(n!==""){this.setField(n,i)}},save:function(){},rollback:function(){this._data=BX.clone(this._initData)},lockField:function(t){if(this._lockedFields.hasOwnProperty(t)){return}this._lockedFields[t]=true;this._lockNotifier.notify([{name:name,isLocked:true}])},unlockField:function(t){if(!this._lockedFields.hasOwnProperty(t)){return}delete this._lockedFields[t];this._lockNotifier.notify([{name:name,isLocked:false}])},isFieldLocked:function(t){return this._lockedFields.hasOwnProperty(t)},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},addLockListener:function(t){this._lockNotifier.addListener(t)},removeLockListener:function(t){this._lockNotifier.removeListener(t)},isCaptionEditable:function(){return false},getCaption:function(){return""},setCaption:function(t){},prepareCaptionData:function(t){}};BX.Crm.EntityModel.create=function(t,e){var i=new BX.Crm.EntityModel;i.initialize(t,e);return i}}if(typeof BX.Crm.LeadModel==="undefined"){BX.Crm.LeadModel=function(){BX.Crm.LeadModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.LeadModel,BX.Crm.EntityModel);BX.Crm.LeadModel.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this))};BX.Crm.LeadModel.prototype.onEntityProgressChange=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this.getEntityTypeId()||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var i=BX.prop.getString(e,"currentStepId","");if(i!==this.getField("STATUS_ID","")){this.setField("STATUS_ID",i)}};BX.Crm.LeadModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.lead};BX.Crm.LeadModel.prototype.isCaptionEditable=function(){return true};BX.Crm.LeadModel.prototype.getCaption=function(){var t=this.getField("TITLE");return BX.type.isString(t)?t:""};BX.Crm.LeadModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.LeadModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.LeadModel.create=function(t,e){var i=new BX.Crm.LeadModel;i.initialize(t,e);return i}}if(typeof BX.Crm.ContactModel==="undefined"){BX.Crm.ContactModel=function(){BX.Crm.ContactModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.ContactModel,BX.Crm.EntityModel);BX.Crm.ContactModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.contact};BX.Crm.ContactModel.prototype.getCaption=function(){return this.getField("FORMATTED_NAME","")};BX.Crm.ContactModel.create=function(t,e){var i=new BX.Crm.ContactModel;i.initialize(t,e);return i}}if(typeof BX.Crm.CompanyModel==="undefined"){BX.Crm.CompanyModel=function(){BX.Crm.CompanyModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.CompanyModel,BX.Crm.EntityModel);BX.Crm.CompanyModel.prototype.isCaptionEditable=function(){return true};BX.Crm.CompanyModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.company};BX.Crm.CompanyModel.prototype.getCaption=function(){return this.getField("TITLE","")};BX.Crm.CompanyModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.CompanyModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.CompanyModel.create=function(t,e){var i=new BX.Crm.CompanyModel;i.initialize(t,e);return i}}if(typeof BX.Crm.DealModel==="undefined"){BX.Crm.DealModel=function(){BX.Crm.DealModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.DealModel,BX.Crm.EntityModel);BX.Crm.DealModel.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Saved",BX.delegate(this.onEntityProgressSave,this))};BX.Crm.DealModel.prototype.onEntityProgressSave=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this.getEntityTypeId()||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var i=BX.prop.getString(e,"currentStepId","");if(i!==this.getField("STAGE_ID","")){this.setField("STAGE_ID",i)}};BX.Crm.DealModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.deal};BX.Crm.DealModel.prototype.isCaptionEditable=function(){return true};BX.Crm.DealModel.prototype.getCaption=function(){var t=this.getField("TITLE");return BX.type.isString(t)?t:""};BX.Crm.DealModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.DealModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.DealModel.create=function(t,e){var i=new BX.Crm.DealModel;i.initialize(t,e);return i}}if(typeof BX.Crm.DealRecurringModel==="undefined"){BX.Crm.DealRecurringModel=function(){BX.Crm.DealRecurringModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.DealRecurringModel,BX.Crm.DealModel);BX.Crm.DealRecurringModel.create=function(t,e){var i=new BX.Crm.DealRecurringModel;i.initialize(t,e);return i}}if(typeof BX.Crm.QuoteModel==="undefined"){BX.Crm.QuoteModel=function(){BX.Crm.QuoteModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.QuoteModel,BX.Crm.EntityModel);BX.Crm.QuoteModel.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this))};BX.Crm.QuoteModel.prototype.onEntityProgressChange=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this.getEntityTypeId()||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var i=BX.prop.getString(e,"currentStepId","");if(i!==this.getField("STATUS_ID","")){this.setField("STATUS_ID",i)}};BX.Crm.QuoteModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.quote};BX.Crm.QuoteModel.prototype.isCaptionEditable=function(){return true};BX.Crm.QuoteModel.prototype.getCaption=function(){var t=this.getField("TITLE");return BX.type.isString(t)?t:""};BX.Crm.QuoteModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.QuoteModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.QuoteModel.create=function(t,e){var i=new BX.Crm.QuoteModel;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorDragScope==="undefined"){BX.Crm.EditorDragScope={intermediate:0,parent:1,form:2,getDefault:function(){return this.form}}}if(typeof BX.Crm.EditorDragObjectType==="undefined"){BX.Crm.EditorDragObjectType={intermediate:"",field:"F",section:"S"}}if(typeof BX.Crm.EditorDragItem==="undefined"){BX.Crm.EditorDragItem=function(){};BX.Crm.EditorDragItem.prototype={getType:function(){return BX.Crm.EditorDragObjectType.intermediate},getContextId:function(){return""},createGhostNode:function(){return null},processDragStart:function(){},processDragPositionChange:function(t,e){},processDragStop:function(){}}}if(typeof BX.Crm.EditorFieldDragItem==="undefined"){BX.Crm.EditorFieldDragItem=function(){BX.Crm.EditorFieldDragItem.superclass.constructor.apply(this);this._scope=BX.Crm.EditorDragScope.undefined;this._control=null;this._contextId=""};BX.extend(BX.Crm.EditorFieldDragItem,BX.Crm.EditorDragItem);BX.Crm.EditorFieldDragItem.prototype.initialize=function(t){this._control=BX.prop.get(t,"control");if(!this._control){throw"Crm.EditorFieldDragItem: The 'control' parameter is not defined in settings or empty."}this._scope=BX.prop.getInteger(t,"scope",BX.Crm.EditorDragScope.getDefault());this._contextId=BX.prop.getString(t,"contextId","")};BX.Crm.EditorFieldDragItem.prototype.getType=function(){return BX.Crm.EditorDragObjectType.field};BX.Crm.EditorFieldDragItem.prototype.getControl=function(){return this._control};BX.Crm.EditorFieldDragItem.prototype.getContextId=function(){return this._contextId!==""?this._contextId:BX.Crm.EditorFieldDragItem.contextId};BX.Crm.EditorFieldDragItem.prototype.createGhostNode=function(){return this._control.createGhostNode()};BX.Crm.EditorFieldDragItem.prototype.processDragStart=function(){window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorFieldDragItem.contextId,true);BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorSectionDragItem.contextId,false);BX.Crm.EditorDragContainerController.refreshAll()});this._control.getWrapper().style.opacity="0.2"};BX.Crm.EditorFieldDragItem.prototype.processDragPositionChange=function(t,e){var i=this._scope===BX.Crm.EditorDragScope.parent?this._control.getParentPosition():this._control.getRootContainerPosition();if(t.y<i.top){t.y=i.top}if(t.y+e.height>i.bottom){t.y=i.bottom-e.height}if(t.x<i.left){t.x=i.left}if(t.x+e.width>i.right){t.x=i.right-e.width}};BX.Crm.EditorFieldDragItem.prototype.processDragStop=function(){window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorSectionDragItem.contextId,true);BX.Crm.EditorDragContainerController.refreshAll()});this._control.getWrapper().style.opacity="1"};BX.Crm.EditorFieldDragItem.contextId="editor_field";BX.Crm.EditorFieldDragItem.create=function(t){var e=new BX.Crm.EditorFieldDragItem;e.initialize(t);return e}}if(typeof BX.Crm.EditorSectionDragItem==="undefined"){BX.Crm.EditorSectionDragItem=function(){BX.Crm.EditorSectionDragItem.superclass.constructor.apply(this);this._control=null};BX.extend(BX.Crm.EditorSectionDragItem,BX.Crm.EditorDragItem);BX.Crm.EditorSectionDragItem.prototype.initialize=function(t){this._control=BX.prop.get(t,"control");if(!this._control){throw"Crm.EditorSectionDragItem: The 'control' parameter is not defined in settings or empty."}};BX.Crm.EditorSectionDragItem.prototype.getType=function(){return BX.Crm.EditorDragObjectType.section};BX.Crm.EditorSectionDragItem.prototype.getControl=function(){return this._control};BX.Crm.EditorSectionDragItem.prototype.getContextId=function(){return BX.Crm.EditorSectionDragItem.contextId};BX.Crm.EditorSectionDragItem.prototype.createGhostNode=function(){return this._control.createGhostNode()};BX.Crm.EditorSectionDragItem.prototype.processDragStart=function(){BX.addClass(document.body,"crm-entity-widgets-drag");var t=this._control;t.getWrapper().style.opacity="0.2";window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorSectionDragItem.contextId,true);BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorFieldDragItem.contextId,false);BX.Crm.EditorDragContainerController.refreshAll();window.setTimeout(function(){var e=t.getSiblingByIndex(0);if(e!==null&&e!==t){e.getWrapper().scrollIntoView()}},200)})};BX.Crm.EditorSectionDragItem.prototype.processDragStop=function(){BX.removeClass(document.body,"crm-entity-widgets-drag");window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorFieldDragItem.contextId,true);BX.Crm.EditorDragContainerController.refreshAll()});var t=this._control;t.getWrapper().style.opacity="1";window.setTimeout(function(){t.getWrapper().scrollIntoView()},150)};BX.Crm.EditorSectionDragItem.contextId="editor_section";BX.Crm.EditorSectionDragItem.create=function(t){var e=new BX.Crm.EditorSectionDragItem;e.initialize(t);return e}}if(typeof BX.Crm.EditorDragItemController==="undefined"){BX.Crm.EditorDragItemController=function(){BX.Crm.EditorDragItemController.superclass.constructor.apply(this);this._charge=null;this._preserveDocument=true};BX.extend(BX.Crm.EditorDragItemController,BX.CrmCustomDragItem);BX.Crm.EditorDragItemController.prototype.doInitialize=function(){this._charge=this.getSetting("charge");if(!this._charge){throw"Crm.EditorDragItemController: The 'charge' parameter is not defined in settings or empty."}this._startNotifier=BX.CrmNotifier.create(this);this._stopNotifier=BX.CrmNotifier.create(this);this._ghostOffset={x:0,y:-40}};BX.Crm.EditorDragItemController.prototype.addStartListener=function(t){this._startNotifier.addListener(t)};BX.Crm.EditorDragItemController.prototype.removeStartListener=function(t){this._startNotifier.removeListener(t)};BX.Crm.EditorDragItemController.prototype.addStopListener=function(t){this._stopNotifier.addListener(t)};BX.Crm.EditorDragItemController.prototype.removeStopListener=function(t){this._stopNotifier.removeListener(t)};BX.Crm.EditorDragItemController.prototype.getCharge=function(){return this._charge};BX.Crm.EditorDragItemController.prototype.createGhostNode=function(){if(this._ghostNode){return this._ghostNode}this._ghostNode=this._charge.createGhostNode();document.body.appendChild(this._ghostNode)};BX.Crm.EditorDragItemController.prototype.getGhostNode=function(){return this._ghostNode};BX.Crm.EditorDragItemController.prototype.removeGhostNode=function(){if(this._ghostNode){document.body.removeChild(this._ghostNode);this._ghostNode=null}};BX.Crm.EditorDragItemController.prototype.getContextId=function(){return this._charge.getContextId()};BX.Crm.EditorDragItemController.prototype.getContextData=function(){return{contextId:this._charge.getContextId(),charge:this._charge}};BX.Crm.EditorDragItemController.prototype.processDragStart=function(){BX.Crm.EditorDragItemController.current=this;this._charge.processDragStart();BX.Crm.EditorDragContainerController.refresh(this._charge.getContextId());this._startNotifier.notify([])};BX.Crm.EditorDragItemController.prototype.processDrag=function(t,e){};BX.Crm.EditorDragItemController.prototype.processDragPositionChange=function(t){this._charge.processDragPositionChange(t,BX.pos(this.getGhostNode()))};BX.Crm.EditorDragItemController.prototype.processDragStop=function(){BX.Crm.EditorDragItemController.current=null;this._charge.processDragStop();BX.Crm.EditorDragContainerController.refreshAfter(this._charge.getContextId(),300);this._stopNotifier.notify([])};BX.Crm.EditorDragItemController.current=null;BX.Crm.EditorDragItemController.create=function(t,e){var i=new BX.Crm.EditorDragItemController;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorDragContainer==="undefined"){BX.Crm.EditorDragContainer=function(){};BX.Crm.EditorDragContainer.prototype={getContextId:function(){return""},getPriority:function(){return 100},hasPlaceHolder:function(){return false},createPlaceHolder:function(t){return null},getPlaceHolder:function(){return null},removePlaceHolder:function(){},getChildNodes:function(){return[]},getChildNodeCount:function(){return 0}}}if(typeof BX.Crm.EditorFieldDragContainer==="undefined"){BX.Crm.EditorFieldDragContainer=function(){BX.Crm.EditorFieldDragContainer.superclass.constructor.apply(this);this._section=null;this._context=""};BX.extend(BX.Crm.EditorFieldDragContainer,BX.Crm.EditorDragContainer);BX.Crm.EditorFieldDragContainer.prototype.initialize=function(t){this._section=BX.prop.get(t,"section");if(!this._section){throw"Crm.EditorSectionDragContainer: The 'section' parameter is not defined in settings or empty."}this._context=BX.prop.getString(t,"context","")};BX.Crm.EditorFieldDragContainer.prototype.getSection=function(){return this._section};BX.Crm.EditorFieldDragContainer.prototype.getContextId=function(){return this._context!==""?this._context:BX.Crm.EditorFieldDragItem.contextId};BX.Crm.EditorFieldDragContainer.prototype.getPriority=function(){return 10};BX.Crm.EditorFieldDragContainer.prototype.hasPlaceHolder=function(){return this._section.hasPlaceHolder()};BX.Crm.EditorFieldDragContainer.prototype.createPlaceHolder=function(t){return this._section.createPlaceHolder(t)};BX.Crm.EditorFieldDragContainer.prototype.getPlaceHolder=function(){return this._section.getPlaceHolder()};BX.Crm.EditorFieldDragContainer.prototype.removePlaceHolder=function(){this._section.removePlaceHolder()};BX.Crm.EditorFieldDragContainer.prototype.getChildNodes=function(){var t=[];var e=this._section.getChildren();for(var i=0,n=e.length;i<n;i++){t.push(e[i].getWrapper())}return t};BX.Crm.EditorFieldDragContainer.prototype.getChildNodeCount=function(){return this._section.getChildCount()};BX.Crm.EditorFieldDragContainer.create=function(t){var e=new BX.Crm.EditorFieldDragContainer;e.initialize(t);return e}}if(typeof BX.Crm.EditorSectionDragContainer==="undefined"){BX.Crm.EditorSectionDragContainer=function(){BX.Crm.EditorSectionDragContainer.superclass.constructor.apply(this);this._editor=null};BX.extend(BX.Crm.EditorSectionDragContainer,BX.Crm.EditorDragContainer);BX.Crm.EditorSectionDragContainer.prototype.initialize=function(t){this._editor=BX.prop.get(t,"editor");if(!this._editor){throw"Crm.EditorSectionDragContainer: The 'editor' parameter is not defined in settings or empty."}};BX.Crm.EditorSectionDragContainer.prototype.getEditor=function(){return this._editor};BX.Crm.EditorSectionDragContainer.prototype.getContextId=function(){return BX.Crm.EditorSectionDragItem.contextId};BX.Crm.EditorSectionDragContainer.prototype.getPriority=function(){return 20};BX.Crm.EditorSectionDragContainer.prototype.hasPlaceHolder=function(){return this._editor.hasPlaceHolder()};BX.Crm.EditorSectionDragContainer.prototype.createPlaceHolder=function(t){return this._editor.createPlaceHolder(t)};BX.Crm.EditorSectionDragContainer.prototype.getPlaceHolder=function(){return this._editor.getPlaceHolder()};BX.Crm.EditorSectionDragContainer.prototype.removePlaceHolder=function(){this._editor.removePlaceHolder()};BX.Crm.EditorSectionDragContainer.prototype.getChildNodes=function(){var t=[];var e=this._editor.getControls();for(var i=0,n=e.length;i<n;i++){t.push(e[i].getWrapper())}return t};BX.Crm.EditorSectionDragContainer.prototype.getChildNodeCount=function(){return this._editor.getControlCount()};BX.Crm.EditorSectionDragContainer.create=function(t){var e=new BX.Crm.EditorSectionDragContainer;e.initialize(t);return e}}if(typeof BX.Crm.EditorDragContainerController==="undefined"){BX.Crm.EditorDragContainerController=function(){BX.Crm.EditorDragContainerController.superclass.constructor.apply(this);this._charge=null};BX.extend(BX.Crm.EditorDragContainerController,BX.CrmCustomDragContainer);BX.Crm.EditorDragContainerController.prototype.doInitialize=function(){this._charge=this.getSetting("charge");if(!this._charge){throw"Crm.EditorDragContainerController: The 'charge' parameter is not defined in settings or empty."}};BX.Crm.EditorDragContainerController.prototype.getCharge=function(){return this._charge};BX.Crm.EditorDragContainerController.prototype.createPlaceHolder=function(t){var e=BX.pos(BX.Crm.EditorDragItemController.current.getGhostNode());var i=e.top,n=e.top+40;var r=Math.floor((i+n)/2);var o,s;var a=this._charge.getPlaceHolder();if(a){o=a.getPosition();s=Math.floor((o.top+o.bottom)/2);if(i<=o.bottom&&i>=o.top||n>=o.top&&n<=o.bottom||Math.abs(r-s)<=8){if(!a.isActive()){a.setActive(true)}return}}var l=this._charge.getChildNodes();for(var d=0;d<l.length;d++){o=BX.pos(l[d]);s=Math.floor((o.top+o.bottom)/2);if(i<=o.bottom&&i>=o.top||n>=o.top&&n<=o.bottom||Math.abs(r-s)<=8){this._charge.createPlaceHolder(r-s<=0?d:d+1).setActive(true);return}}this._charge.createPlaceHolder(-1).setActive(true);this.refresh()};BX.Crm.EditorDragContainerController.prototype.removePlaceHolder=function(){if(!this._charge.hasPlaceHolder()){return}if(this._charge.getChildNodeCount()>0){this._charge.removePlaceHolder()}else{this._charge.getPlaceHolder().setActive(false)}this.refresh()};BX.Crm.EditorDragContainerController.prototype.getContextId=function(){return this._charge.getContextId()};BX.Crm.EditorDragContainerController.prototype.getPriority=function(){return this._charge.getPriority()};BX.Crm.EditorDragContainerController.prototype.isAllowedContext=function(t){return t===this._charge.getContextId()};BX.Crm.EditorDragContainerController.refresh=function(t){for(var e in this.items){if(!this.items.hasOwnProperty(e)){continue}var i=this.items[e];if(i.getContextId()===t){i.refresh()}}};BX.Crm.EditorDragContainerController.refreshAfter=function(t,e){e=parseInt(e);if(e>0){window.setTimeout(function(){BX.Crm.EditorDragContainerController.refresh(t)},e)}else{this.refresh(t)}};BX.Crm.EditorDragContainerController.refreshAll=function(){for(var t in this.items){if(!this.items.hasOwnProperty(t)){continue}this.items[t].refresh()}};BX.Crm.EditorDragContainerController.enable=function(t,e){for(var i in this.items){if(!this.items.hasOwnProperty(i)){continue}var n=this.items[i];if(n.getContextId()===t){n.enable(e)}}};BX.Crm.EditorDragContainerController.items={};BX.Crm.EditorDragContainerController.create=function(t,e){var i=new BX.Crm.EditorDragContainerController;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EditorDragPlaceholder==="undefined"){BX.Crm.EditorDragPlaceholder=function(){this._settings=null;this._container=null;this._node=null;this._isDragOver=false;this._isActive=false;this._index=-1;this._timeoutId=null};BX.Crm.EditorDragPlaceholder.prototype={initialize:function(t){this._settings=t?t:{};this._container=this.getSetting("container",null);this._isActive=this.getSetting("isActive",false);this._index=parseInt(this.getSetting("index",-1))},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isDragOver:function(){return this._isDragOver},isActive:function(){return this._isActive},setActive:function(t,e){if(this._timeoutId!==null){window.clearTimeout(this._timeoutId);this._timeoutId=null}e=parseInt(e);if(e>0){var i=this;window.setTimeout(function(){if(i._timeoutId===null)return;i._timeoutId=null;i.setActive(t,0)},e);return}t=!!t;if(this._isActive===t){return}this._isActive=t;if(this._node){}},getIndex:function(){return this._index},prepareNode:function(){return null},layout:function(){this._node=this.prepareNode();var t=this.getSetting("anchor",null);if(t){this._container.insertBefore(this._node,t)}else{this._container.appendChild(this._node)}BX.bind(this._node,"dragover",BX.delegate(this._onDragOver,this));BX.bind(this._node,"dragleave",BX.delegate(this._onDragLeave,this))},clearLayout:function(){if(this._node){this._node.style.height=0;setTimeout(BX.proxy(function(){this._node=BX.remove(this._node)},this),100)}},getPosition:function(){return BX.pos(this._node)},_onDragOver:function(t){t=t||window.event;this._isDragOver=true;return BX.eventReturnFalse(t)},_onDragLeave:function(t){t=t||window.event;this._isDragOver=false;return BX.eventReturnFalse(t)}}}if(typeof BX.Crm.EditorDragFieldPlaceholder==="undefined"){BX.Crm.EditorDragFieldPlaceholder=function(){};BX.extend(BX.Crm.EditorDragFieldPlaceholder,BX.Crm.EditorDragPlaceholder);BX.Crm.EditorDragFieldPlaceholder.prototype.prepareNode=function(){return BX.create("div",{attrs:{className:"crm-entity-widget-content-block-place"}})};BX.Crm.EditorDragFieldPlaceholder.create=function(t){var e=new BX.Crm.EditorDragFieldPlaceholder;e.initialize(t);return e}}if(typeof BX.Crm.EditorDragSectionPlaceholder==="undefined"){BX.Crm.EditorDragSectionPlaceholder=function(){};BX.extend(BX.Crm.EditorDragSectionPlaceholder,BX.Crm.EditorDragPlaceholder);BX.Crm.EditorDragSectionPlaceholder.prototype.prepareNode=function(){return BX.create("div",{attrs:{className:"crm-entity-card-widget crm-entity-card-widget-place"}})};BX.Crm.EditorDragSectionPlaceholder.create=function(t){var e=new BX.Crm.EditorDragSectionPlaceholder;e.initialize(t);return e}}if(typeof BX.Crm.EntityUserFieldType==="undefined"){BX.Crm.EntityUserFieldType={string:"string",integer:"integer",double:"double",boolean:"boolean",money:"money",date:"date",datetime:"datetime",enumeration:"enumeration",employee:"employee",crm:"crm",crmStatus:"crm_status",file:"file",url:"url"}}if(typeof BX.Crm.EntityUserFieldManager==="undefined"){BX.Crm.EntityUserFieldManager=function(){this._id="";this._settings={};this._entityId=0;this._fieldEntityId="";this._enableCreation=false;this._creationSignature="";this._creationUrl="";this._activeFields={};this._validationResult=null;this._validationPromise=null};BX.Crm.EntityUserFieldManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._fieldEntityId=BX.prop.getString(this._settings,"fieldEntityId","");this._enableCreation=BX.prop.getBoolean(this._settings,"enableCreation",false);this._creationSignature=BX.prop.getString(this._settings,"creationSignature","");this._creationPageUrl=BX.prop.getString(this._settings,"creationPageUrl","")},isCreationEnabled:function(){return this._enableCreation},isModificationEnabled:function(){return this._enableCreation},getDefaultFieldLabel:function(t){if(t==="string"){return this.getMessage("stringLabel")}else if(t==="double"){return this.getMessage("doubleLabel")}else if(t==="money"){return this.getMessage("moneyLabel")}else if(t==="datetime"){return this.getMessage("datetimeLabel")}else if(t==="enumeration"){return this.getMessage("enumerationLabel")}else if(t==="file"){return this.getMessage("fileLabel")}return this.getMessage("label")},getMessage:function(t){var e=BX.Crm.EntityUserFieldManager.messages;return e.hasOwnProperty(t)?e[t]:t},getAdditionalTypeList:function(){return BX.Crm.EntityUserFieldManager.additionalTypeList},getTypeInfos:function(){var t=[];t.push({name:"string",title:this.getMessage("stringTitle"),legend:this.getMessage("stringLegend")});t.push({name:"enumeration",title:this.getMessage("enumerationTitle"),legend:this.getMessage("enumerationLegend")});t.push({name:"datetime",title:this.getMessage("datetimeTitle"),legend:this.getMessage("datetimeLegend")});t.push({name:"address",title:this.getMessage("addressTitle"),legend:this.getMessage("addressLegend")});if(this._fieldEntityId==="CRM_LEAD"||this._fieldEntityId==="CRM_DEAL"){t.push({name:"resourcebooking",title:this.getMessage("resourcebookingTitle"),legend:this.getMessage("resourcebookingLegend")})}t.push({name:"url",title:this.getMessage("urlTitle"),legend:this.getMessage("urlLegend")});t.push({name:"file",title:this.getMessage("fileTitle"),legend:this.getMessage("fileLegend")});t.push({name:"money",title:this.getMessage("moneyTitle"),legend:this.getMessage("moneyLegend")});t.push({name:"boolean",title:this.getMessage("booleanTitle"),legend:this.getMessage("booleanLegend")});t.push({name:"double",title:this.getMessage("doubleTitle"),legend:this.getMessage("doubleLegend")});var e=this.getAdditionalTypeList();for(var i=0;i<e.length;i++){t.push({name:e[i].USER_TYPE_ID,title:e[i].TITLE,legend:e[i].LEGEND})}t.push({name:"custom",title:this.getMessage("customTitle"),legend:this.getMessage("customLegend")});return t},getCreationPageUrl:function(){return this._creationPageUrl},createField:function(t,e){if(!this._enableCreation){return}var i=BX.prop.getString(t,"USER_TYPE_ID","");if(i===""){i=BX.Crm.EntityUserFieldType.string}if(!BX.type.isNotEmptyString(t["EDIT_FORM_LABEL"])){t["EDIT_FORM_LABEL"]=this.getDefaultFieldLabel(i)}if(!BX.type.isNotEmptyString(t["LIST_COLUMN_LABEL"])){t["LIST_COLUMN_LABEL"]=t["EDIT_FORM_LABEL"]}if(!BX.type.isNotEmptyString(t["LIST_FILTER_LABEL"])){t["LIST_FILTER_LABEL"]=t["LIST_COLUMN_LABEL"]}this.addFieldLabel("EDIT_FORM_LABEL",t["EDIT_FORM_LABEL"],t);this.addFieldLabel("LIST_COLUMN_LABEL",t["LIST_COLUMN_LABEL"],t);this.addFieldLabel("LIST_FILTER_LABEL",t["LIST_FILTER_LABEL"],t);var n=new BX.Promise;var r=function(t){n.fulfill(t)};if(!BX.type.isNotEmptyString(t["FIELD"])){t["FIELD"]="UF_CRM_"+(new Date).getTime().toString()}t["ENTITY_ID"]=this._fieldEntityId;t["SIGNATURE"]=this._creationSignature;if(!BX.type.isNotEmptyString(t["MULTIPLE"])){t["MULTIPLE"]="N"}if(!BX.type.isNotEmptyString(t["MANDATORY"])){t["MANDATORY"]="N"}if(i===BX.Crm.EntityUserFieldType.file){t["SHOW_FILTER"]="N";t["SHOW_IN_LIST"]="N"}else{if(i===BX.Crm.EntityUserFieldType.employee||i===BX.Crm.EntityUserFieldType.crm||i===BX.Crm.EntityUserFieldType.crmStatus){t["SHOW_FILTER"]="I"}else{t["SHOW_FILTER"]="E"}t["SHOW_IN_LIST"]="Y"}if(i===BX.Crm.EntityUserFieldType.enumeration){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["DISPLAY"]="UI"}if(i===BX.Crm.EntityUserFieldType.boolean){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["LABEL_CHECKBOX"]=t["EDIT_FORM_LABEL"]}if(i===BX.Crm.EntityUserFieldType.double){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["PRECISION"]=2}if(e===BX.Crm.EntityEditorMode.view){BX.Main.UF.ViewManager.add({FIELDS:[t]},r)}else{BX.Main.UF.EditManager.add({FIELDS:[t]},r)}return n},updateField:function(t,e){t["ENTITY_ID"]=this._fieldEntityId;t["SIGNATURE"]=this._creationSignature;var i=new BX.Promise;var n=function(t){i.fulfill(t)};if(e===BX.Crm.EntityEditorMode.view){BX.Main.UF.ViewManager.update({FIELDS:[t]},n)}else{BX.Main.UF.EditManager.update({FIELDS:[t]},n)}return i},resolveFieldName:function(t){return BX.prop.getString(t,"FIELD","")},setSharedLabel:function(t,e){BX.ajax.runAction("crm.api.userField.setSharedLabel",{data:{userFieldEntityType:this._fieldEntityId,fieldName:t,label:e}})},synchronizeEnumeration:function(t){BX.ajax.runAction("crm.api.userField.synchronizeEnumeration",{data:{userFieldEntityType:this._fieldEntityId,fieldName:t}})},addFieldLabel:function(t,e,i){var n=BX.prop.getArray(this._settings,"languages",[]);if(n.length===0){i[t]=e;return}i[t]={};for(var r=0,o=n.length;r<o;r++){var s=n[r];i[t][s["LID"]]=e}},prepareSchemeElementSettings:function(t){var e=BX.prop.getString(t,"FIELD","");if(e===""){return null}if(BX.prop.getString(t,"USER_TYPE_ID","")===""){t["USER_TYPE_ID"]="string"}if(BX.prop.getString(t,"ENTITY_ID","")===""){t["ENTITY_ID"]=this._fieldEntityId}if(BX.prop.getInteger(t,"ENTITY_VALUE_ID",0)<=0){t["ENTITY_VALUE_ID"]=this._entityId}return{name:e,originalTitle:BX.prop.getString(t,"EDIT_FORM_LABEL",e),title:BX.prop.getString(t,"EDIT_FORM_LABEL",e),type:"userField",required:BX.prop.getString(t,"MANDATORY","N")==="Y",data:{fieldInfo:t}}},createSchemeElement:function(t){return BX.Crm.EntitySchemeElement.create(this.prepareSchemeElementSettings(t))},updateSchemeElement:function(t,e){var i=this.prepareSchemeElementSettings(e);i["title"]=t.getTitle();t.mergeSettings(i)},registerActiveField:function(t){var e=t.getName();this._activeFields[e]=t;BX.Main.UF.EditManager.registerField(e,t.getFieldInfo(),t.getFieldNode())},unregisterActiveField:function(t){var e=t.getName();if(this._activeFields.hasOwnProperty(e)){delete this._activeFields[e]}BX.Main.UF.EditManager.unRegisterField(e)},validate:function(t){var e=[];for(var i in this._activeFields){if(this._activeFields.hasOwnProperty(i)){e.push(i)}}if(e.length>0){this._validationResult=t;BX.Main.UF.EditManager.validate(e,BX.delegate(this.onValidationComplete,this))}else{window.setTimeout(BX.delegate(function(){if(this._validationPromise){this._validationPromise.fulfill();this._validationPromise=null}},this),0)}this._validationPromise=new BX.Promise;return this._validationPromise},onValidationComplete:function(t){var e;for(e in this._activeFields){if(this._activeFields.hasOwnProperty(e)){this._activeFields[e].clearError()}}for(e in t){if(!t.hasOwnProperty(e)){continue}if(this._activeFields.hasOwnProperty(e)){var i=this._activeFields[e];i.showError(t[e]);this._validationResult.addError(BX.Crm.EntityValidationError.create({field:i}))}}if(this._validationPromise){this._validationPromise.fulfill()}this._validationResult=null;this._validationPromise=null}};if(typeof BX.Crm.EntityUserFieldManager.messages==="undefined"){BX.Crm.EntityUserFieldManager.messages={}}BX.Crm.EntityUserFieldManager.items={};BX.Crm.EntityUserFieldManager.create=function(t,e){var i=new BX.Crm.EntityUserFieldManager;i.initialize(t,e);this.items[t]=i;return i}}if(typeof BX.Crm.EntityUserFieldLayoutLoader==="undefined"){BX.Crm.EntityUserFieldLayoutLoader=function(){this._id="";this._settings={};this._mode=BX.Crm.EntityEditorMode.view;this._enableBatchMode=true;this._owner=null;this._items=[]};BX.Crm.EntityUserFieldLayoutLoader.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);this._enableBatchMode=BX.prop.getBoolean(this._settings,"enableBatchMode",true);this._owner=BX.prop.get(this._settings,"owner",null)},getId:function(){return this._id},getOwner:function(){return this._owner},addItem:function(t){this._items.push(t)},run:function(){if(!this._enableBatchMode){this.startRequest()}},runBatch:function(){if(this._enableBatchMode){this.startRequest()}},startRequest:function(){if(this._items.length===0){return}var t=[];for(var e=0,i=this._items.length;e<i;e++){if(BX.prop.getString(this._items[e],"name","")!==""){t.push(BX.prop.getObject(this._items[e],"field",{}))}}if(t.length===0){return}var n={FIELDS:t,FORM:this._id,CONTEXT:"CRM_EDITOR"};if(this._mode===BX.Crm.EntityEditorMode.view){BX.Main.UF.Manager.getView(n,BX.delegate(this.onRequestComplete,this))}else{BX.Main.UF.Manager.getEdit(n,BX.delegate(this.onRequestComplete,this))}},onRequestComplete:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];var r=BX.prop.getString(n,"name","");var o=BX.prop.getFunction(n,"callback",null);if(r!==""&&o!==null){o(BX.prop.getObject(t,r,{}))}}}};BX.Crm.EntityUserFieldLayoutLoader.create=function(t,e){var i=new BX.Crm.EntityUserFieldLayoutLoader;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorDupManager==="undefined"){BX.Crm.EntityEditorDupManager=function(){this._id="";this._settings=null;this._groupInfos=null;this._isEnabled=false;this._serviceUrl="";this._entityTypeName="";this._form=null;this._controller=null};BX.Crm.EntityEditorDupManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._isEnabled=BX.prop.getBoolean(this._settings,"enabled","");if(!this._isEnabled){return}this._groupInfos=BX.prop.getObject(this._settings,"groups",{});this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","");this._form=BX.prop.get(this._settings,"form",null);this._controller=BX.CrmDupController.create(this._id,{serviceUrl:this._serviceUrl,entityTypeName:this._entityTypeName,form:this._form,searcSummaryPosition:"right"})},isEnabled:function(){return this._isEnabled},search:function(){this._controller.initialSearch()},getGroupInfo:function(t){return this._groupInfos.hasOwnProperty(t)?this._groupInfos[t]:null},getGroup:function(t){return this._isEnabled?this._controller.getGroup(t):null},ensureGroupRegistered:function(t){if(!this._isEnabled){return null}var e=this.getGroup(t);if(!e){e=this._controller.registerGroup(t,this.getGroupInfo(t))}return e},registerField:function(t){if(!this._isEnabled){return null}var e=BX.prop.getString(t,"groupId","");var i=BX.prop.getObject(t,"field",null);if(e===""||!i){return null}var n=this.ensureGroupRegistered(e);if(!n){return null}return n.registerField(i)},unregisterField:function(t){if(!this._isEnabled){return}var e=BX.prop.getString(t,"groupId","");var i=BX.prop.getObject(t,"field",null);if(e===""||!i){return}var n=this.getGroup(e);if(!n){return}n.unregisterField(i)}};BX.Crm.EntityEditorDupManager.create=function(t,e){var i=new BX.Crm.EntityEditorDupManager;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorTextHelper==="undefined"){BX.Crm.EditorTextHelper=function(){};BX.Crm.EditorTextHelper.prototype={selectAll:function(t){if(!(BX.type.isElementNode(t)&&t.value.length>0)){return}if(BX.type.isFunction(t.setSelectionRange)){t.setSelectionRange(0,t.value.length)}else{t.select()}},setPositionAtEnd:function(t){if(BX.type.isElementNode(t)&&t.value.length>0){BX.setCaretPosition(t,t.value.length)}}};BX.Crm.EditorTextHelper._current=null;BX.Crm.EditorTextHelper.getCurrent=function(){if(!this._current){this._current=new BX.Crm.EditorTextHelper}return this._current}}if(typeof BX.Crm.EntityEditorVisibilityPolicy==="undefined"){BX.Crm.EntityEditorVisibilityPolicy={always:0,view:1,edit:2,parse:function(t){t=t.toLowerCase();if(t==="view"){return this.view}else if(t==="edit"){return this.edit}return this.always},checkVisibility:function(t){var e=t.getMode();var i=t.getVisibilityPolicy();if(i===this.view){return e===BX.Crm.EntityEditorMode.view}else if(i===this.edit){return e===BX.Crm.EntityEditorMode.edit}return true}}}if(typeof BX.Crm.EntityEditorControl==="undefined"){BX.Crm.EntityEditorControl=function(){this._id="";this._settings={};this._editor=null;this._parent=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._modeOptions=BX.Crm.EntityEditorModeOptions.none;this._model=null;this._schemeElement=null;this._container=null;this._wrapper=null;this._dragButton=null;this._dragItem=null;this._hasLayout=false;this._isValidLayout=false;this._isVisible=true;this._isActive=false;this._isChanged=false;this._isSchemeChanged=false;this._changeHandler=BX.delegate(this.onChange,this);this._modeChangeNotifier=null;this._contextMenuButton=null;this._isContextMenuOpened=false;this._draggableContextId=""};BX.Crm.EntityEditorControl.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor",null);this._parent=BX.prop.get(this._settings,"parent",null);this._model=BX.prop.get(this._settings,"model",null);this._schemeElement=BX.prop.get(this._settings,"schemeElement",null);this._container=BX.prop.getElementNode(this._settings,"container",null);var i=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);if(i===BX.Crm.EntityEditorMode.edit&&this._schemeElement&&!this._schemeElement.isEditable()){i=BX.Crm.EntityEditorMode.view}this._mode=i;this.doInitialize();this.bindModel()},doInitialize:function(){},bindModel:function(){},unbindModel:function(){},getMessage:function(t){var e=BX.Crm.EntityEditorControl.messages;return e.hasOwnProperty(t)?e[t]:t},getId:function(){return this._id},getEditor:function(){return this._editor},setEditor:function(t){this._editor=t},getParentPosition:function(){var t=this.getParent();return t?t.getPosition():{top:0,right:0,bottom:0,left:0,width:0,height:0}},getParent:function(){return this._parent},setParent:function(t){this._parent=t},getSiblingByIndex:function(t){return this._editor?this._editor.getControlByIndex(t):null},getChildCount:function(){return 0},getChildById:function(t){return null},editChild:function(t){},removeChild:function(t){},getChildren:function(){return[]},editChildConfiguration:function(t){},areAttributesEnabled:function(){return this._schemeElement&&this._schemeElement.areAttributesEnabled()},getType:function(){return this._schemeElement?this._schemeElement.getType():""},getName:function(){return this._schemeElement?this._schemeElement.getName():""},getTitle:function(){if(!this._schemeElement){return""}var t=this._schemeElement.getTitle();if(t===""){t=this._schemeElement.getName()}return t},setTitle:function(t){if(!this._schemeElement){return}this._schemeElement.setTitle(t);this.refreshTitleLayout()},getOptionFlags:function(){return this._schemeElement?this._schemeElement.getOptionFlags():BX.Crm.EntityEditorControlOptions.none},setOptionFlags:function(t){if(this._schemeElement){this._schemeElement.setOptionFlags(t)}},toggleOptionFlag:function(t){var e=this.getOptionFlags();if(BX.Crm.EntityEditorControlOptions.check(e,t)){e&=~t}else{e|=t}this.setOptionFlags(e)},checkOptionFlag:function(t){return BX.Crm.EntityEditorControlOptions.check(this.getOptionFlags(),t)},getData:function(){return this._schemeElement?this._schemeElement.getData():{}},isVisible:function(){if(!this._isVisible){return false}if(this.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){return true}return BX.Crm.EntityEditorVisibilityPolicy.checkVisibility(this)},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;if(this._hasLayout){this._wrapper.style.display=this._isVisible?"":"none"}},isActive:function(){return this._isActive},setActive:function(t){t=!!t;if(this._isActive===t){return}this._isActive=t;this.doSetActive()},doSetActive:function(){},isEditable:function(){return this._schemeElement&&this._schemeElement.isEditable()},isRequired:function(){return this._schemeElement&&this._schemeElement.isRequired()},isRequiredConditionally:function(){return this._schemeElement&&this._schemeElement.isRequiredConditionally()},isHeading:function(){return this._schemeElement&&this._schemeElement.isHeading()},getCreationPlaceholder:function(){return this._schemeElement?this._schemeElement.getCreationPlaceholder():""},isReadOnly:function(){return this._editor&&this._editor.isReadOnly()},getVisibilityPolicy:function(){return this._schemeElement&&this._schemeElement.getVisibilityPolicy()},getEditPriority:function(){return BX.Crm.EntityEditorPriority.normal},getPosition:function(){return BX.pos(this._wrapper)},focus:function(){},save:function(){},validate:function(t){return true},rollback:function(){},isDragEnabled:function(){if(!this._editor){return false}if(!this._editor.canChangeScheme()){return false}return BX.prop.getBoolean(BX.prop.getObject(this._editor.getDragConfig(this.getDragObjectType()),"modes",{}),BX.Crm.EntityEditorMode.getName(this._mode),false)},isContextMenuEnabled:function(){if(this._editor&&!this._editor.canChangeScheme()){return false}return this._schemeElement.isContextMenuEnabled()},getMode:function(){return this._mode},setMode:function(t,e){if(!this.canChangeMode(t)){return}var i=BX.prop.getInteger(e,"options",BX.Crm.EntityEditorModeOptions.none);if(this._mode===t&&this._modeOptions===i){return}this.onBeforeModeChange();this._mode=t;this._modeOptions=i;this.doSetMode(this._mode);this.onAfterModeChange();if(BX.prop.getBoolean(e,"notify",false)){if(this._parent){this._parent.processChildControlModeChange(this)}else if(this._editor){this._editor.processControlModeChange(this)}}this._isSchemeChanged=false;this._isChanged=false;if(this._hasLayout){this._isValidLayout=false}},getModeChangeNotifier:function(){if(!this._modeChangeNotifier){this._modeChangeNotifier=BX.CrmNotifier.create(this)}return this._modeChangeNotifier},onBeforeModeChange:function(){},doSetMode:function(t){},onAfterModeChange:function(){if(this._modeChangeNotifier){this._modeChangeNotifier.notify()}},canChangeMode:function(t){if(t===BX.Crm.EntityEditorMode.edit){return this.isEditable()}return true},isModeToggleEnabled:function(){return this._editor.isModeToggleEnabled()},toggleMode:function(t,e){if(!this.isModeToggleEnabled()){return false}this.setMode(this._mode===BX.Crm.EntityEditorMode.view?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view,{notify:t});if(BX.prop.getBoolean(e,"refreshLayout",true)){this.refreshLayout()}return true},isEditInViewEnabled:function(){return this._editor&&this._editor.isEditInViewEnabled()&&this.getDataBooleanParam("enableEditInView",false)},isSingleEditEnabled:function(){return this.isModeToggleEnabled()&&this.isEditable()&&!this.getDataBooleanParam("enableEditInView",false)&&this.getDataBooleanParam("enableSingleEdit",true)},isInSingleEditMode:function(){return this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.exclusive)},isInEditMode:function(){return this._mode===BX.Crm.EntityEditorMode.edit},isInViewMode:function(){return this._mode===BX.Crm.EntityEditorMode.view},checkModeOption:function(t){return BX.Crm.EntityEditorModeOptions.check(this._modeOptions,t)},getContextId:function(){return this._editor?this._editor.getContextId():""},getExternalContextId:function(){return this._editor?this._editor.getExternalContextId():""},processAvailableSchemeElementsChange:function(){},processChildControlModeChange:function(t){},processChildControlChange:function(t,e){},isChanged:function(){return this._isChanged},markAsChanged:function(t){if(typeof t==="undefined"){t={}}var e=BX.prop.get(t,"control",null);if(!(e&&e instanceof BX.Crm.EntityEditorControl)){e=t["control"]=this}if(!e.isInEditMode()){return}if(!this._isChanged){this._isChanged=true}this.notifyChanged(t)},isSchemeChanged:function(){return this._isSchemeChanged},markSchemeAsChanged:function(){if(this._isSchemeChanged){return}this._isSchemeChanged=true},saveScheme:function(){if(!this._isSchemeChanged){return}this.commitSchemeChanges();return this._editor.saveScheme()},commitSchemeChanges:function(){if(!this._isSchemeChanged){return}this._editor.updateSchemeElement(this._schemeElement);this._isSchemeChanged=false},getRootContainer:function(){return this._editor?this._editor.getContainer():null},getRootContainerPosition:function(){return BX.pos(this.getRootContainer())},getContainer:function(){return this._container},setContainer:function(t){this._container=t;if(this._hasLayout){this._hasLayout=false}},getWrapper:function(){return this._wrapper},enablePointerEvents:function(t){if(this._wrapper){this._wrapper.style.pointerEvents=t?"":"none"}},getModel:function(){return this._model},getSchemeElement:function(){return this._schemeElement},hasScheme:function(){return!!this._schemeElement},getDataBooleanParam:function(t,e){return this._schemeElement?this._schemeElement.getDataBooleanParam(t,e):e},layout:function(t){},registerLayout:function(t){if(!this._wrapper){return}this._wrapper.setAttribute("data-cid",this.getId());if(this.isInViewMode()&&this._parent&&this._parent.isInEditMode()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-readonly")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-field-readonly")}if(typeof t==="undefined"){t={}}if(!BX.prop.getBoolean(t,"preservePosision",false)){var e=BX.prop.getElementNode(t,"anchor",null);if(e){BX.addClass(this._wrapper,"crm-entity-widget-content-hide");this._container.insertBefore(this._wrapper,e);setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-hide");BX.addClass(this._wrapper,"crm-entity-widget-content-show")},this),1);setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-show")},this),310)}else{this._container.appendChild(this._wrapper)}}this._isValidLayout=true;this.doRegisterLayout()},doRegisterLayout:function(){},refreshLayout:function(t){if(!this._hasLayout){return}this.closeContextMenu();this.clearLayout({preservePosision:true});if(!BX.type.isPlainObject(t)){t={}}t["preservePosision"]=true;this.layout(t)},clearLayout:function(t){},refreshTitleLayout:function(){},releaseLayout:function(){this._wrapper=null},release:function(){},reset:function(){},hide:function(){if(this.isRequired()||this.isRequiredConditionally()){return}if(this._parent){BX.addClass(this._wrapper,"crm-entity-widget-content-hide");setTimeout(BX.delegate(function(){this._parent.removeChild(this)},this),350)}else{this.clearLayout()}},showMessageDialog:function(t,e,i){var n=BX.Crm.EditorAuxiliaryDialog.create(t,{title:e,content:i,buttons:[{id:"continue",type:BX.Crm.DialogButtonType.accept,text:BX.message("CRM_EDITOR_CONTINUE"),callback:function(t){t.getDialog().close()}}]});n.open()},prepareSaveData:function(t){},onBeforeSubmit:function(){},onHideButtonClick:function(t){this.hide()},onContextButtonClick:function(t){if(!this._isContextMenuOpened){this.openContextMenu()}else{this.closeContextMenu()}},openContextMenu:function(){if(this._isContextMenuOpened){return}var t=this.prepareContextMenuItems();if(BX.type.isArray(t)&&t.length>0){var e=BX.delegate(this.onContextMenuItemSelect,this);for(var i=0,n=t.length;i<n;i++){if(typeof t[i]["onclick"]==="undefined"){t[i]["onclick"]=e}}BX.PopupMenu.show(this._id,this._contextMenuButton,t,{angle:false,events:{onPopupShow:BX.delegate(this.onContextMenuShow,this),onPopupClose:BX.delegate(this.onContextMenuClose,this)}})}},prepareContextMenuItems:function(){return[]},processContextMenuCommand:function(t,e){},closeContextMenu:function(){var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}},onContextMenuShow:function(){this._isContextMenuOpened=true},onContextMenuClose:function(){BX.PopupMenu.destroy(this._id);this._isContextMenuOpened=false},onContextMenuItemSelect:function(t,e){this.processContextMenuCommand(t,BX.prop.getString(e,"value"))},onChange:function(t){this.markAsChanged()},notifyChanged:function(t){if(typeof t==="undefined"){t={}}if(this._parent){this._parent.processChildControlChange(this,t)}else if(this._editor){this._editor.processControlChange(this,t)}},getDragObjectType:function(){return BX.Crm.EditorDragObjectType.intermediate},getChildDragObjectType:function(){return BX.Crm.EditorDragObjectType.intermediate},getDragScope:function(){if(this._parent){return this._parent.getChildDragScope()}if(!this._editor){return BX.Crm.EditorDragScope.getDefault()}return BX.prop.getInteger(this._editor.getDragConfig(this.getDragObjectType()),"scope",BX.Crm.EditorDragScope.getDefault())},getChildDragScope:function(){if(!this._editor){return BX.Crm.EditorDragScope.getDefault()}return BX.prop.getInteger(this._editor.getDragConfig(this.getChildDragObjectType()),"scope",BX.Crm.EditorDragScope.getDefault())},getDraggableContextId:function(){return this._draggableContextId},setDraggableContextId:function(t){this._draggableContextId=t},createDragButton:function(){return this._dragButton},createHideButton:function(){var t=!this.isRequired()&&!this.isRequiredConditionally();var e=BX.create("div",{props:{className:"crm-entity-widget-content-block-hide-btn",title:this.getHideButtonHint(t)}});if(t){BX.bind(e,"click",BX.delegate(this.onHideButtonClick,this))}return e},createContextMenuButton:function(){this._contextMenuButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-context-menu"},events:{click:BX.delegate(this.onContextButtonClick,this)}});return this._contextMenuButton},createGhostNode:function(){return null},getHideButtonHint:function(t){return""}};if(typeof BX.Crm.EntityEditorControl.messages==="undefined"){BX.Crm.EntityEditorControl.messages={}}}if(typeof BX.Crm.EntityEditorField==="undefined"){BX.Crm.EntityEditorField=function(){BX.Crm.EntityEditorField.superclass.constructor.apply(this);this._titleWrapper=null;this._singleEditButton=null;this._singleEditButtonHandler=BX.delegate(this.onSingleEditBtnClick,this);this._singleEditController=null;this._singleEditTimeoutHandle=0;this._viewController=null;this._validators=null;this._hasError=false;this._errorContainer=null;this._layoutAttributes=null;this._spotlight=null;this._dragObjectType=BX.Crm.EditorDragObjectType.field};BX.extend(BX.Crm.EntityEditorField,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorField.prototype.isNewEntity=function(){return this._editor&&this._editor.isNew()};BX.Crm.EntityEditorField.prototype.configure=function(){if(this._parent){this._parent.editChildConfiguration(this)}};BX.Crm.EntityEditorField.prototype.hasAttributeConfiguration=function(t){return this._schemeElement.hasAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.getAttributeConfiguration=function(t){return this._schemeElement.getAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.setAttributeConfiguration=function(t){return this._schemeElement.setAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.removeAttributeConfiguration=function(t){return this._schemeElement.removeAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.getDuplicateControlConfig=function(){return this._schemeElement?this._schemeElement.getDataObjectParam("duplicateControl",null):null};BX.Crm.EntityEditorField.prototype.markAsChanged=function(t){BX.Crm.EntityEditorField.superclass.markAsChanged.apply(this,arguments);if(this.hasError()){this.clearError()}var e=this.getValidators();for(var i=0,n=e.length;i<n;i++){e[i].processFieldChange(this)}};BX.Crm.EntityEditorField.prototype.bindModel=function(){this._model.addChangeListener(BX.delegate(this.onModelChange,this));this._model.addLockListener(BX.delegate(this.onModelLock,this))};BX.Crm.EntityEditorField.prototype.onBeforeModeChange=function(){this._layoutAttributes=null;if(this.isInEditMode()){this._layoutAttributes={animate:"show"}}};BX.Crm.EntityEditorField.prototype.onModelChange=function(t,e){this.processModelChange(e)};BX.Crm.EntityEditorField.prototype.onModelLock=function(t,e){this.processModelLock(e)};BX.Crm.EntityEditorField.prototype.processModelChange=function(t){};BX.Crm.EntityEditorField.prototype.processModelLock=function(t){};BX.Crm.EntityEditorField.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorField.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorField.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorField.prototype.hasContentWrapper=function(){return this.getContentWrapper()!==null};BX.Crm.EntityEditorField.prototype.getContentWrapper=function(){return null};BX.Crm.EntityEditorField.prototype.getHideButtonHint=function(t){return this.getMessage(t?"hideButtonHint":"hideButtonDisabledHint")};BX.Crm.EntityEditorField.prototype.getEditButton=function(){return this._singleEditButton};BX.Crm.EntityEditorField.prototype.ensureWrapperCreated=function(t){if(!this._wrapper){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}})}var e=BX.prop.getArray(t,"classNames",[]);for(var i=0,n=e.length;i<n;i++){BX.addClass(this._wrapper,e[i])}return this._wrapper};BX.Crm.EntityEditorField.prototype.adjustWrapper=function(){if(!this._wrapper){return}if(this.isInEditMode()&&(this.checkModeOption(BX.Crm.EntityEditorModeOptions.exclusive)||this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual))){BX.addClass(this._wrapper,"crm-entity-widget-content-block-edit")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-edit")}if(this._layoutAttributes){for(var t in this._layoutAttributes){if(this._layoutAttributes.hasOwnProperty(t)){this._wrapper.setAttribute("data-"+t,this._layoutAttributes[t])}}this._layoutAttributes=null}};BX.Crm.EntityEditorField.prototype.createTitleNode=function(t){this._titleWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-title"}});this.prepareTitleLayout(BX.type.isNotEmptyString(t)?t:this.getTitle());return this._titleWrapper};BX.Crm.EntityEditorField.prototype.prepareTitleLayout=function(t){if(!this._titleWrapper){return}this._titleWrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:t}));var e=this.createTitleMarker();if(e){this._titleWrapper.appendChild(e)}};BX.Crm.EntityEditorField.prototype.refreshTitleLayout=function(){if(!this._titleWrapper){return}BX.cleanNode(this._titleWrapper);this.prepareTitleLayout(this.getTitle())};BX.Crm.EntityEditorField.prototype.createTitleMarker=function(){if(this._mode===BX.Crm.EntityEditorMode.view){return null}if(this.isRequired()){return BX.create("span",{style:{color:"#f00"},text:"*"})}else if(this.isRequiredConditionally()){return BX.create("span",{text:"*"})}return null};BX.Crm.EntityEditorField.prototype.createEditButton=function(){if(!(this.isInViewMode()&&this.isSingleEditEnabled())){return null}if(!this._singleEditButton){this._singleEditButton=BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"}})}return this._singleEditButton};BX.Crm.EntityEditorField.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorField.prototype.createGhostNode=function(){if(!this._wrapper){return null}var t=BX.pos(this._wrapper);var e=this._wrapper.cloneNode(true);BX.addClass(e,"crm-entity-widget-content-block-drag");e.style.width=t.width+"px";e.style.height=t.height+"px";return e};BX.Crm.EntityEditorField.prototype.clearLayout=function(t){if(!this._hasLayout){return}this.releaseLightingAbilities();BX.Crm.EntityEditorField.superclass.clearLayout.apply(this,arguments);if(!BX.type.isPlainObject(t)){t={}}this.releaseDragDropAbilities();this.releaseSwitchingAbilities();if(!BX.prop.getBoolean(t,"preservePosision",false)){this._wrapper=BX.remove(this._wrapper)}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-click-editable");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-click-empty");this._wrapper=BX.cleanNode(this._wrapper);if(this.hasError()){this.clearError()}}if(this._singleEditButton){this._singleEditButton=null}this.doClearLayout(t);this._hasLayout=false};BX.Crm.EntityEditorField.prototype.doClearLayout=function(t){};BX.Crm.EntityEditorField.prototype.registerLayout=function(t){var e=this.isVisible();var i=this.isNeedToDisplay();this._wrapper.style.display=e&&i?"":"none";this.initializeSwitchingAbilities();if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)){window.setTimeout(BX.delegate(this.focus,this),0)}BX.Crm.EntityEditorField.superclass.registerLayout.apply(this,arguments);var n=BX.prop.getObject(t,"lighting",null);if(n){window.setTimeout(function(){this.initializeLightingAbilities(n)}.bind(this),1e3)}if(!i&&BX.prop.getBoolean(t,"notifyIfNotDisplayed",false)){BX.UI.Notification.Center.notify({content:this.getMessage("hiddenInViewMode").replace(/#TITLE#/gi,this.getTitle()),position:"top-center",autoHideDelay:5e3})}};BX.Crm.EntityEditorField.prototype.hasContentToDisplay=function(){return this.hasValue()};BX.Crm.EntityEditorField.prototype.isNeedToDisplay=function(){return this._mode===BX.Crm.EntityEditorMode.edit||this.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)||this.hasContentToDisplay()};BX.Crm.EntityEditorField.prototype.hide=function(){if(!(this.isRequired()||this.isRequiredConditionally())){BX.Crm.EntityEditorField.superclass.hide.apply(this,arguments)}else{this.showMessageDialog("operationDenied",this.getMessage("hideDeniedDlgTitle"),this.getMessage("hideDeniedDlgContent"))}};BX.Crm.EntityEditorField.prototype.getEditPriority=function(){var t=this.hasValue();if(!t&&(this.isRequired()||this.isRequiredConditionally())){return BX.Crm.EntityEditorPriority.high}if(!this._editor.isNew()){return BX.Crm.EntityEditorPriority.normal}return t?BX.Crm.EntityEditorPriority.high:BX.Crm.EntityEditorPriority.normal};BX.Crm.EntityEditorField.prototype.checkIfNotEmpty=function(t){return BX.util.trim(t)!==""};BX.Crm.EntityEditorField.prototype.hasValue=function(){return this.checkIfNotEmpty(this.getValue())};BX.Crm.EntityEditorField.prototype.getValue=function(t){if(!this._model){return""}return this._model.getField(this.getName(),t!==undefined?t:"")};BX.Crm.EntityEditorField.prototype.getStringValue=function(t){return this._model?this._model.getStringField(this.getName(),t):""};BX.Crm.EntityEditorField.prototype.getRuntimeValue=function(){return""};BX.Crm.EntityEditorField.prototype.prepareSaveData=function(t){t[this.getName()]=this.getValue()};BX.Crm.EntityEditorField.prototype.findValidatorIndex=function(t){if(!this._validators){return-1}for(var e=0,i=this._validators.length;e<i;e++){if(this._validators[e]===t){return e}}return-1};BX.Crm.EntityEditorField.prototype.addValidator=function(t){if(t&&this.findValidatorIndex(t)<0){if(!this._validators){this._validators=[]}this._validators.push(t)}};BX.Crm.EntityEditorField.prototype.removeValidator=function(t){if(!this._validators||!t){return}var e=this.findValidatorIndex(t);if(e>=0){this._validators.splice(e,1)}};BX.Crm.EntityEditorField.prototype.getValidators=function(){return this._validators?this._validators:[]};BX.Crm.EntityEditorField.prototype.hasValidators=function(){return this._validators&&this._validators.length>0};BX.Crm.EntityEditorField.prototype.executeValidators=function(t){if(!this._validators){return true}var e=true;for(var i=0,n=this._validators.length;i<n;i++){if(!this._validators[i].validate(t)){e=false}}return e};BX.Crm.EntityEditorField.prototype.hasError=function(){return this._hasError};BX.Crm.EntityEditorField.prototype.showError=function(t,e){if(!this._errorContainer){this._errorContainer=BX.create("div",{attrs:{className:"crm-entity-widget-content-error-text"}})}this._errorContainer.innerHTML=t;this._wrapper.appendChild(this._errorContainer);BX.addClass(this._wrapper,"crm-entity-widget-content-error");this._hasError=true};BX.Crm.EntityEditorField.prototype.showRequiredFieldError=function(t){this.showError(this.getMessage("requiredFieldError"),t)};BX.Crm.EntityEditorField.prototype.clearError=function(){if(!this._hasError){return}if(this._errorContainer&&this._errorContainer.parentNode){this._errorContainer.parentNode.removeChild(this._errorContainer)}BX.removeClass(this._wrapper,"crm-entity-widget-content-error");this._hasError=false};BX.Crm.EntityEditorField.prototype.scrollAnimate=function(){var t=BX.GetDocElement(document);var e=this._wrapper;window.setTimeout(function(){new BX.easing({duration:300,start:{position:t.scrollTop},finish:{position:BX.pos(e).top-10},step:function(e){t.scrollTop=e.position}}).animate()},0)};BX.Crm.EntityEditorField.prototype.setDragObjectType=function(t){this._dragObjectType=t};BX.Crm.EntityEditorField.prototype.getDragObjectType=function(){return this._dragObjectType};BX.Crm.EntityEditorField.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("field_"+this.getId(),{charge:BX.Crm.EditorFieldDragItem.create({control:this,contextId:this._draggableContextId,scope:this.getDragScope()}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorField.prototype.releaseDragDropAbilities=function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}};BX.Crm.EntityEditorField.prototype.initializeSwitchingAbilities=function(){if(this.isInViewMode()){if(this.isSingleEditEnabled()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-click-editable");if(!this.hasContentToDisplay()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-click-empty")}if(this._singleEditButton){BX.bind(this._singleEditButton,"click",this._singleEditButtonHandler)}}if(this.hasContentWrapper()&&BX.Crm.EntityEditorModeSwitchType.check(this.getModeSwitchType(BX.Crm.EntityEditorMode.edit),BX.Crm.EntityEditorModeSwitchType.content)){this._viewController=BX.Crm.EditorFieldViewController.create(this._id,{field:this,wrapper:this.getContentWrapper()})}}else if(this.isInSingleEditMode()){this._singleEditController=BX.Crm.EditorFieldSingleEditController.create(this._id,{field:this})}};BX.Crm.EntityEditorField.prototype.releaseSwitchingAbilities=function(){if(this._singleEditButton){BX.unbind(this._singleEditButton,"click",this._singleEditButtonHandler)}if(this._viewController){this._viewController.release();this._viewController=null}if(this._singleEditController){this._singleEditController.release();this._singleEditController=null}};BX.Crm.EntityEditorField.prototype.initializeLightingAbilities=function(t){var e=BX.prop.getString(t,"text","");if(!BX.type.isNotEmptyString(e)){return}var i=this.getContentWrapper();if(!i){return}this._spotlight=new BX.SpotLight({id:BX.prop.getString(t,"id",""),targetElement:i,autoSave:true,content:e,targetVertex:"middle-left",zIndex:200});this._spotlight.show();var n=BX.prop.getObject(t,"events",{});for(var r in n){if(n.hasOwnProperty(r)){BX.addCustomEvent(this._spotlight,r,n[r])}}};BX.Crm.EntityEditorField.prototype.releaseLightingAbilities=function(){if(this._spotlight){this._spotlight.close();this._spotlight=null}};BX.Crm.EntityEditorField.prototype.prepareContextMenuItems=function(){var t=[];t.push({value:"hide",text:this.getMessage("hide")});t.push({value:"configure",text:this.getMessage("configure")});if(this._parent&&this._parent.hasAdditionalMenu()){var e=this._parent.getAdditionalMenu();for(var i=0;i<e.length;i++){t.push(e[i])}}t.push({value:"showAlways",text:'<label class="crm-context-menu-item-hide-empty-wrap">'+'<input type="checkbox"'+(this.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)?' checked = "true"':"")+' class="crm-context-menu-item-hide-empty-input">'+'<span class="crm-context-menu-item-hide-empty-text">'+this.getMessage("showAlways")+"</span></label>"});this.doPrepareContextMenuItems(t);return t};BX.Crm.EntityEditorField.prototype.doPrepareContextMenuItems=function(t){};BX.Crm.EntityEditorField.prototype.processContextMenuCommand=function(t,e){if(e==="showAlways"){var i=BX.getEventTarget(t);if(i&&i.tagName==="INPUT"){this.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways);if(this._parent){this._parent.processChildControlSchemeChange(this)}if(!this.isNeedToDisplay()){window.setTimeout(BX.delegate(this.clearLayout,this),500);BX.UI.Notification.Center.notify({content:this.getMessage("isHiddenDueToShowAlwaysChanged").replace(/#TITLE#/gi,this.getTitle()),position:"top-center",autoHideDelay:5e3});this.closeContextMenu()}}return}if(e==="hide"){window.setTimeout(BX.delegate(this.hide,this),500)}else if(e==="configure"){this.configure()}else if(this._parent&&this._parent.hasAdditionalMenu()){this._parent.processChildAdditionalMenuCommand(this,e)}this.closeContextMenu()};BX.Crm.EntityEditorField.prototype.onSingleEditBtnClick=function(t){if(!(this.isSingleEditEnabled()&&this._editor)){return}if(this._singleEditTimeoutHandle>0){window.clearTimeout(this._singleEditTimeoutHandle);this._singleEditTimeoutHandle=0}this._singleEditTimeoutHandle=window.setTimeout(BX.delegate(this.switchToSingleEditMode,this),250);BX.eventCancelBubble(t)};BX.Crm.EntityEditorField.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button}return e};BX.Crm.EntityEditorField.prototype.switchToSingleEditMode=function(){this._singleEditTimeoutHandle=0;if(this._editor){this._editor.switchControlMode(this,BX.Crm.EntityEditorMode.edit,BX.Crm.EntityEditorModeOptions.individual)}};if(typeof BX.Crm.EntityEditorField.messages==="undefined"){BX.Crm.EntityEditorField.messages={}}}if(typeof BX.Crm.EntityEditorSection==="undefined"){BX.Crm.EntityEditorSection=function(){BX.Crm.EntityEditorSection.superclass.constructor.apply(this);this._fields=null;this._fieldConfigurator=null;this._userFieldConfigurator=null;this._mandatoryConfigurator=null;this._titleEditButton=null;this._titleEditHandler=BX.delegate(this.onTitleEditButtonClick,this);this._titleView=null;this._titleInput=null;this._titleMode=BX.Crm.EntityEditorMode.intermediate;this._titleInputKeyHandler=BX.delegate(this.onTitleInputKeyPress,this);this._documentClickHandler=BX.delegate(this.onExternalClick,this);this._deleteButtonHandler=BX.delegate(this.onDeleteSectionBtnClick,this);this._detetionConfirmDlgId="section_deletion_confirm";this._enableToggling=true;this._toggleButton=null;this._addChildButton=null;this._childSelectMenu=null;this._buttonPanelWrapper=null;this._fieldTypeSelectMenu=null;this._deleteButton=null;this._dragContainerController=null;this._dragPlaceHolder=null;this._dropHandler=BX.delegate(this.onDrop,this);this._fieldSelector=null;this._stub=null};BX.extend(BX.Crm.EntityEditorSection,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorSection.prototype.doSetActive=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].setActive(this._isActive)}};BX.Crm.EntityEditorSection.prototype.initialize=function(t,e){BX.Crm.EntityEditorSection.superclass.initialize.call(this,t,e);this._draggableContextId=BX.Crm.EditorFieldDragItem.contextId;if(this.getChildDragScope()===BX.Crm.EditorDragScope.parent){this._draggableContextId+="_"+this.getId()}this.initializeFromModel()};BX.Crm.EntityEditorSection.prototype.initializeFromModel=function(){var t,e;if(this._fields){for(t=0,e=this._fields.length;t<e;t++){this._fields[t].release()}}this._fields=[];var i=this._schemeElement.getElements();for(t=0,e=i.length;t<e;t++){var n=i[t];var r=this._editor.createControl(n.getType(),n.getName(),{schemeElement:n,model:this._model,parent:this});if(!r){continue}n.setParent(this._schemeElement);r.setMode(this._mode,{notify:false});this._fields.push(r)}};BX.Crm.EntityEditorSection.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorSection.prototype.createGhostNode=function(){if(!this._wrapper){return null}var t=BX.pos(this._wrapper);var e=BX.create("div",{props:{className:"crm-entity-card-widget-edit"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-inner"}})]})]}),BX.create("div",{props:{className:"crm-entity-card-widget-title"},children:[BX.create("span",{props:{className:"crm-entity-card-widget-title-text"},text:this._schemeElement.getTitle()})]})]});BX.addClass(e,"crm-entity-widget-card-drag");e.style.width=t.width+"px";return e};BX.Crm.EntityEditorSection.prototype.getEditPriority=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].getEditPriority()===BX.Crm.EntityEditorPriority.high){return BX.Crm.EntityEditorPriority.high}}return BX.Crm.EntityEditorPriority.normal};BX.Crm.EntityEditorSection.prototype.layout=function(t){var e=this._schemeElement.getTitle();this._contentContainer=BX.create("div",{props:{className:"crm-entity-widget-content"}});var i=this._mode===BX.Crm.EntityEditorMode.view;var n=i?"crm-entity-card-widget":"crm-entity-card-widget-edit";this._enableToggling=this.isModeToggleEnabled()&&this._schemeElement.getDataBooleanParam("enableToggling",true);this._toggleButton=BX.create("span",{attrs:{className:"crm-entity-widget-hide-btn"},events:{click:BX.delegate(this.onToggleBtnClick,this)},text:this.getMessage(i?"change":"cancel")});if(!this._enableToggling){this._toggleButton.style.display="none"}this._titleMode=BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:n}});if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._schemeElement.isTitleEnabled()){this._titleEditButton=BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"},events:{click:this._titleEditHandler}});if(!this._editor.isSectionEditEnabled()||!this._editor.canChangeScheme()){this._titleEditButton.style.display="none"}this._titleView=BX.create("span",{props:{className:"crm-entity-card-widget-title-text"},text:e});this._titleInput=BX.create("input",{props:{className:"crm-entity-card-widget-title-text"},style:{display:"none"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-card-widget-title"},children:[this._titleView,this._titleInput,this._titleEditButton,BX.create("div",{props:{className:"crm-entity-widget-actions-block"},children:[this._toggleButton]})]}))}this._wrapper.appendChild(this._contentContainer);if(!BX.type.isPlainObject(t)){t={}}var r=BX.prop.getElementNode(t,"anchor",null);if(r){this._container.insertBefore(this._wrapper,r)}else{this._container.appendChild(this._wrapper)}if(i&&this._fields.length===0){this._contentContainer.appendChild(this.createStub())}var o=BX.prop.getBoolean(t,"reset",false);var s=BX.prop.get(t,"userFieldLoader",null);if(!s){s=BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:this._mode,enableBatchMode:true,owner:this})}var a=BX.prop.getObject(t,"lighting",null);var l=false;for(var d=0,h=this._fields.length;d<h;d++){var p=this._fields[d];p.setContainer(this._contentContainer);p.setDraggableContextId(this._draggableContextId);p.releaseLayout();if(o){p.reset()}var u={userFieldLoader:s};if(!l&&a&&p.isVisible()&&p.isNeedToDisplay()){u["lighting"]=a;l=true}p.layout(u);if(!i&&p.isHeading()){p.focus()}}if(s.getOwner()===this){s.runBatch()}this._addChildButton=this._createChildButton=null;if(this._editor.canChangeScheme()&&this._schemeElement.getDataBooleanParam("showButtonPanel",true)){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});this._addChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("selectField"),events:{click:BX.delegate(this.onAddChildBtnClick,this)}});if(!this._editor.hasAvailableSchemeElements()){this._addChildButton.style.display="none"}this._buttonPanelWrapper.appendChild(this._addChildButton);if(this._editor.getUserFieldManager().isCreationEnabled()){this._createChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("createField"),events:{click:BX.delegate(this.onCreateUserFieldBtnClick,this)}});this._buttonPanelWrapper.appendChild(this._createChildButton)}var c="crm-entity-widget-content-block-edit-remove-btn";if(this.isRequired()||this.isRequiredConditionally()){c="crm-entity-widget-content-block-edit-remove-btn-disabled"}this._deleteButton=BX.create("span",{props:{className:c},text:this.getMessage("deleteSection")});this._buttonPanelWrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);this._contentContainer.appendChild(this._buttonPanelWrapper)}if(this.isDragEnabled()){this._dragContainerController=BX.Crm.EditorDragContainerController.create("section_"+this.getId(),{charge:BX.Crm.EditorFieldDragContainer.create({section:this,context:this._draggableContextId}),node:this._wrapper});this._dragContainerController.addDragFinishListener(this._dropHandler);this.initializeDragDropAbilities()}this._hasLayout=true};BX.Crm.EntityEditorSection.prototype.clearLayout=function(){if(!this._hasLayout){return}if(this._dragContainerController){this._dragContainerController.removeDragFinishListener(this._dropHandler);this._dragContainerController.release();this._dragContainerController=null}this.releaseDragDropAbilities();for(var t=0,e=this._fields.length;t<e;t++){var i=this._fields[t];i.clearLayout();i.setContainer(null);i.setDraggableContextId("")}this._addChildButton=BX.remove(this._addChildButton);this._buttonPanelWrapper=BX.remove(this._buttonPanelWrapper);this._deleteButton=null;this._stub=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorSection.prototype.refreshLayout=function(t){t=BX.type.isPlainObject(t)?BX.clone(t,false):{};var e=BX.prop.getFunction(t,"callback",null);delete t["callback"];delete t["anchor"];if(this._wrapper&&this._wrapper.nextSibling){t["anchor"]=this._wrapper.nextSibling}this.clearLayout();this.layout(t);if(e){e()}};BX.Crm.EntityEditorSection.prototype.createStub=function(){this._stub=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-nothing-selected"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-nothing-selected-text"},text:this.getMessage("nothingSelected")})]})]});if(this.isModeToggleEnabled()){BX.bind(this._stub,"click",BX.delegate(this.onStubClick,this))}return this._stub};BX.Crm.EntityEditorSection.prototype.onStubClick=function(t){this.toggle()};BX.Crm.EntityEditorSection.prototype.hasAdditionalMenu=function(t){return false};BX.Crm.EntityEditorSection.prototype.getAdditionalMenu=function(t){return[]};BX.Crm.EntityEditorSection.prototype.processChildAdditionalMenuCommand=function(t,e){};BX.Crm.EntityEditorSection.prototype.setTitleMode=function(t){if(this._titleMode===t){return}this._titleMode=t;if(!this._schemeElement.isTitleEnabled()){return}if(this._titleMode===BX.Crm.EntityEditorMode.view){this._titleView.style.display="";this._titleInput.style.display="none";this._titleEditButton.style.display="";var e=this._titleInput.value;this._titleView.innerHTML=BX.util.htmlspecialchars(e);this._schemeElement.setTitle(e);this.markSchemeAsChanged();this.saveScheme();BX.unbind(this._titleInput,"keyup",this._titleInputKeyHandler);BX.unbind(window.document,"click",this._documentClickHandler)}else{this._titleView.style.display="none";this._titleInput.style.display="";this._titleEditButton.style.display="none";this._titleInput.value=this._schemeElement.getTitle();BX.bind(this._titleInput,"keyup",this._titleInputKeyHandler);this._titleInput.focus();window.setTimeout(BX.delegate(function(){BX.bind(window.document,"click",this._documentClickHandler)},this),100)}};BX.Crm.EntityEditorSection.prototype.toggleTitleMode=function(){this.setTitleMode(this._titleMode===BX.Crm.EntityEditorMode.view?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view)};BX.Crm.EntityEditorSection.prototype.onTitleEditButtonClick=function(t){if(this._editor.isSectionEditEnabled()){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.onTitleInputKeyPress=function(t){if(!t){t=window.event}if(t.keyCode===13){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.onExternalClick=function(t){if(!t){t=window.event}if(this._titleInput!==BX.getEventTarget(t)){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.enableToggling=function(t){t=!!t;if(this._enableToggling===t){return}this._enableToggling=t;if(this._hasLayout){this._toggleButton.style.display=this._enableToggling?"":"none"}};BX.Crm.EntityEditorSection.prototype.toggle=function(){if(this._enableToggling&&this._editor){this._editor.switchControlMode(this,this._mode===BX.Crm.EntityEditorMode.view?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view)}};BX.Crm.EntityEditorSection.prototype.onToggleBtnClick=function(t){this.toggle()};BX.Crm.EntityEditorSection.prototype.onBeforeModeChange=function(){this.removeFieldConfigurator();this.removeUserFieldConfigurator()};BX.Crm.EntityEditorSection.prototype.doSetMode=function(t){if(this._titleMode===BX.Crm.EntityEditorMode.edit){this.toggleTitleMode()}for(var e=0,i=this._fields.length;e<i;e++){this._fields[e].setMode(t,{notify:false})}};BX.Crm.EntityEditorSection.prototype.processAvailableSchemeElementsChange=function(){if(this._hasLayout&&BX.type.isDomNode(this._addChildButton)){this._addChildButton.style.display=this._editor.hasAvailableSchemeElements()?"":"none"}};BX.Crm.EntityEditorSection.prototype.validate=function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){return true}var e=BX.Crm.EntityValidationResult.create();for(var i=0,n=this._fields.length;i<n;i++){var r=this._fields[i];if(r.getMode()!==BX.Crm.EntityEditorMode.edit){continue}r.validate(e)}t.addResult(e);return e.getStatus()};BX.Crm.EntityEditorSection.prototype.commitSchemeChanges=function(){if(this._isSchemeChanged){var t=[];for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e].getSchemeElement();if(n){t.push(n)}}this._schemeElement.setElements(t)}return BX.Crm.EntityEditorSection.superclass.commitSchemeChanges.call(this)};BX.Crm.EntityEditorSection.prototype.save=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].save()}};BX.Crm.EntityEditorSection.prototype.rollback=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].rollback()}if(this._isChanged){this.initializeFromModel();this._isChanged=false}};BX.Crm.EntityEditorSection.prototype.onBeforeSubmit=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].onBeforeSubmit()}};BX.Crm.EntityEditorSection.prototype.getChildIndex=function(t){for(var e=0,i=this._fields.length;e<i;e++){if(this._fields[e]===t){return e}}return-1};BX.Crm.EntityEditorSection.prototype.addChild=function(t,e){if(!BX.type.isPlainObject(e)){e={}}var i=null;var n=BX.prop.getInteger(e,"index",-1);if(n>=0){this._fields.splice(n,0,t);if(n<this._fields.length-1){i=this._fields[n+1]}}else{this._fields.push(t);i=BX.prop.get(e,"related",null)}if(t.hasScheme()){t.getSchemeElement().setParent(this._schemeElement)}t.setActive(this._isActive);if(this._hasLayout){t.setContainer(this._contentContainer);t.setDraggableContextId(this._draggableContextId);var r=BX.prop.getObject(e,"layout",{});if(i){r["anchor"]=i.getWrapper()}else{r["anchor"]=this._buttonPanelWrapper}if(BX.prop.getBoolean(r,"forceDisplay",false)&&!t.isNeedToDisplay()&&!t.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){t.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}t.layout(r)}if(t.hasScheme()){this._editor.processControlAdd(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(e,"enableSaving",true)){this.saveScheme()}}};BX.Crm.EntityEditorSection.prototype.removeChild=function(t,e){if(!BX.type.isPlainObject(e)){e={}}var i=this.getChildIndex(t);if(i<0){return}if(t.isActive()){t.setActive(false)}this._fields.splice(i,1);var n=t.hasScheme();if(n){t.getSchemeElement().setParent(null)}if(this._hasLayout){t.clearLayout();t.setContainer(null);t.setDraggableContextId("")}if(n){this._editor.processControlRemove(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(e,"enableSaving",true)){this.saveScheme()}}};BX.Crm.EntityEditorSection.prototype.moveChild=function(t,e,i){if(!BX.type.isPlainObject(i)){i={}}var n=this.getChildCount();var r=n-1;if(e<0||e>n){e=r}var o=this.getChildIndex(t);if(o<0||o===e){return false}if(this._hasLayout){t.clearLayout()}this._fields.splice(o,1);n--;var s=null;if(this._hasLayout){s=e<n?this._fields[e].getWrapper():this._buttonPanelWrapper}if(e<n){this._fields.splice(e,0,t)}else{this._fields.push(t)}if(this._hasLayout){if(s){t.layout({anchor:s})}else{t.layout()}}this._editor.processControlMove(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(i,"enableSaving",true)){this.saveScheme()}return true};BX.Crm.EntityEditorSection.prototype.editChild=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit){t.focus()}else if(!this.isReadOnly()){var e=true;for(var i=0,n=this._fields.length;i<n;i++){if(this._fields[i].getMode()!==this._mode){e=false;break}}if(e){this.setMode(BX.Crm.EntityEditorMode.edit,{notify:true});this.refreshLayout({callback:function(){t.focus()}})}}};BX.Crm.EntityEditorSection.prototype.getChildById=function(t){for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e];if(n.getId()===t){return n}}return null};BX.Crm.EntityEditorSection.prototype.getChildCount=function(){return this._fields.length};BX.Crm.EntityEditorSection.prototype.getChildren=function(){return this._fields};BX.Crm.EntityEditorSection.prototype.processChildControlModeChange=function(t){if(!this.isActive()&&this._editor){this._editor.processControlModeChange(t)}};BX.Crm.EntityEditorSection.prototype.processChildControlChange=function(t,e){if(!t.isInEditMode()){return}if(typeof e==="undefined"){e={}}if(!BX.prop.get(e,"control",null)){e["control"]=t}this.markAsChanged(e);this.enableToggling(false)};BX.Crm.EntityEditorSection.prototype.processChildControlSchemeChange=function(t){this.markSchemeAsChanged();this.saveScheme()};BX.Crm.EntityEditorSection.prototype.openAddChildMenu=function(){var t=this._editor.getAvailableSchemeElements();var e=t.length;if(e===0){return}var i=[];for(var n=0;n<e;n++){var r=t[n];i.push({text:r.getTitle(),value:r.getName()})}i.push({delimiter:true});i.push({text:this.getMessage("selectFieldFromOtherSection"),value:"ACTION.TRANSFER"});if(this._childSelectMenu){this._childSelectMenu.setupItems(i)}else{this._childSelectMenu=BX.CmrSelectorMenu.create(this._id,{items:i});this._childSelectMenu.addOnSelectListener(BX.delegate(this.onChildSelect,this))}this._childSelectMenu.open(this._addChildButton)};BX.Crm.EntityEditorSection.prototype.onAddChildBtnClick=function(t){this.openAddChildMenu()};BX.Crm.EntityEditorSection.prototype.openTransferDialog=function(){if(!this._fieldSelector){this._fieldSelector=BX.Crm.EntityEditorFieldSelector.create(this._id,{scheme:this._editor.getScheme(),excludedNames:[this.getSchemeElement().getName()],title:this.getMessage("transferDialogTitle")});this._fieldSelector.addClosingListener(BX.delegate(this.onTransferFieldSelect,this))}this._fieldSelector.open()};BX.Crm.EntityEditorSection.prototype.onTransferFieldSelect=function(t,e){if(BX.prop.getBoolean(e,"isCanceled")){return}var i=BX.prop.getArray(e,"items");if(i.length===0){return}for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"sectionName","");var a=BX.prop.getString(o,"fieldName","");var l=this._editor.getControlById(s);if(!l){continue}var d=l.getChildById(a);if(!d){continue}var h=d.getSchemeElement();l.removeChild(d,{enableSaving:false});var p=this._editor.createControl(h.getType(),h.getName(),{schemeElement:h,model:this._model,parent:this,mode:this._mode});this.addChild(p,{layout:{forceDisplay:true},enableSaving:false})}this._editor.saveSchemeChanges()};BX.Crm.EntityEditorSection.prototype.onChildSelect=function(t,e){var i=e.getValue();if(i==="ACTION.TRANSFER"){this.openTransferDialog();return}var n=this._editor.getAvailableSchemeElementByName(i);if(!n){return}var r=this._editor.createControl(n.getType(),n.getName(),{schemeElement:n,model:this._model,parent:this,mode:this._mode});if(r){this.addChild(r,{layout:{forceDisplay:true}})}};BX.Crm.EntityEditorSection.prototype.onCreateUserFieldBtnClick=function(t){if(!this._fieldTypeSelectMenu){var e=this._editor.getUserFieldManager().getTypeInfos();var i=[];for(var n=0,r=e.length;n<r;n++){var o=e[n];i.push({value:o.name,text:o.title,legend:o.legend})}this._fieldTypeSelectMenu=BX.Crm.UserFieldTypeMenu.create(this._id,{items:i,callback:BX.delegate(this.onUserFieldTypeSelect,this)})}this._fieldTypeSelectMenu.open(this._createChildButton)};BX.Crm.EntityEditorSection.prototype.onUserFieldTypeSelect=function(t,e){this._fieldTypeSelectMenu.close();var i=e.getValue();if(i===""){return}if(i==="custom"){window.open(this._editor.getUserFieldManager().getCreationPageUrl())}else{this.removeFieldConfigurator();this.removeUserFieldConfigurator();this.createUserFieldConfigurator({typeId:i})}};BX.Crm.EntityEditorSection.prototype.createUserFieldConfigurator=function(t){if(!BX.type.isPlainObject(t)){throw"EntityEditorSection: The 'params' argument must be object."}var e="";var i=BX.prop.get(t,"field",null);if(i){if(!(i instanceof BX.Crm.EntityEditorUserField)){throw"EntityEditorSection: The 'field' param must be EntityEditorUserField."}e=i.getFieldType();i.setVisible(false)}else{e=BX.prop.get(t,"typeId",BX.Crm.EntityUserFieldType.string)}if(e==="resourcebooking"){this._userFieldConfigurator=BX.Calendar.UserField.EntityEditorUserFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,typeId:e,field:i,showAlways:true})}else{var n=this._editor.getAttributeManager();if(n){this._mandatoryConfigurator=n.createFieldConfigurator(i,BX.Crm.EntityFieldAttributeType.required)}this._userFieldConfigurator=BX.Crm.EntityEditorUserFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,typeId:e,field:i,mandatoryConfigurator:this._mandatoryConfigurator,showAlways:true})}this.addChild(this._userFieldConfigurator,{related:i});BX.addCustomEvent(this._userFieldConfigurator,"onSave",BX.delegate(this.onUserFieldConfigurationSave,this));BX.addCustomEvent(this._userFieldConfigurator,"onCancel",BX.delegate(this.onUserFieldConfigurationCancel,this))};BX.Crm.EntityEditorSection.prototype.removeUserFieldConfigurator=function(){if(this._userFieldConfigurator){var t=this._userFieldConfigurator.getField();if(t){t.setVisible(true)}this.removeChild(this._userFieldConfigurator);this._userFieldConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onUserFieldConfigurationSave=function(t,e){if(t!==this._userFieldConfigurator){return}this._userFieldConfigurator.setLocked(true);var i=BX.prop.getString(e,"typeId");if(i===BX.Crm.EntityUserFieldType.datetime&&!BX.prop.getBoolean(e,"enableTime",false)){i=BX.Crm.EntityUserFieldType.date}var n={USER_TYPE_ID:i};if(this._mandatoryConfigurator&&this._mandatoryConfigurator.isPermitted()&&this._mandatoryConfigurator.isEnabled()&&this._mandatoryConfigurator.isCustomized()){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}n["MANDATORY"]="N"}else{n["MANDATORY"]=BX.prop.getBoolean(e,"mandatory",false)?"Y":"N"}var r=BX.prop.get(e,"settings",null);if(r){n["SETTINGS"]=r}var o=BX.prop.getBoolean(e,"showAlways",null);var s=BX.prop.getString(e,"label","");var a=BX.prop.get(e,"field",null);if(a){if(s!==""||o!==null){a.setTitle(s);if(o!==null&&o!==a.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){a.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.markSchemeAsChanged();this.saveScheme()}n["FIELD"]=a.getName();n["ENTITY_VALUE_ID"]=a.getEntityValueId();n["VALUE"]=a.getFieldValue();if(i===BX.Crm.EntityUserFieldType.enumeration){n["ENUM"]=BX.prop.getArray(e,"enumeration",[])}a.adjustFieldParams(n);this._editor.getUserFieldManager().updateField(n,a.getMode()).then(BX.delegate(this.onUserFieldUpdate,this))}else{if(o!==null){this._editor.setOption("show_always",o?"Y":"N")}n["EDIT_FORM_LABEL"]=n["LIST_COLUMN_LABEL"]=BX.prop.getString(e,"label");n["MULTIPLE"]=BX.prop.getBoolean(e,"multiple",false)?"Y":"N";if(i===BX.Crm.EntityUserFieldType.enumeration){n["ENUM"]=BX.prop.getArray(e,"enumeration",[])}this._editor.getUserFieldManager().createField(n,this._mode).then(BX.delegate(this.onUserFieldCreate,this))}};BX.Crm.EntityEditorSection.prototype.onUserFieldConfigurationCancel=function(t,e){if(t!==this._userFieldConfigurator){return}this.removeUserFieldConfigurator();if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onUserFieldCreate=function(t){if(!BX.type.isPlainObject(t)){return}this.removeUserFieldConfigurator();var e=this._editor.getUserFieldManager();for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=BX.prop.getObject(n,"FIELD",null);if(!r){continue}var o=e.createSchemeElement(r);if(!o){continue}this._model.setField(o.getName(),{VALUE:"",SIGNATURE:BX.prop.getString(r,"SIGNATURE","")});var s=this._editor.createControl(o.getType(),o.getName(),{schemeElement:o,model:this._model,parent:this,mode:this._mode});if(this._mandatoryConfigurator&&this._mandatoryConfigurator.isPermitted()&&this._mandatoryConfigurator.isEnabled()&&this._mandatoryConfigurator.isCustomized()){var a=this._mandatoryConfigurator.getConfiguration();this._editor.getAttributeManager().saveConfiguration(a,o.getName());s.setAttributeConfiguration(a)}var l=this._editor.getOption("show_always","Y")==="Y";if(l!==s.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){s.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.addChild(s,{layout:{notifyIfNotDisplayed:true,html:BX.prop.getString(n,"HTML","")}});break}if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onUserFieldUpdate=function(t){if(!BX.type.isPlainObject(t)){return}this.removeUserFieldConfigurator();var e=this._editor.getUserFieldManager();for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=BX.prop.getObject(n,"FIELD",null);if(!r){continue}var o=this.getChildById(i);if(!o){continue}var s=o.getSchemeElement();if(!s){continue}if(this._mandatoryConfigurator&&this._mandatoryConfigurator.isPermitted()){if(this._mandatoryConfigurator.isEnabled()&&this._mandatoryConfigurator.isCustomized()){var a=this._mandatoryConfigurator.getConfiguration();this._editor.getAttributeManager().saveConfiguration(a,s.getName());o.setAttributeConfiguration(a)}else{var l=this._mandatoryConfigurator.getTypeId();this._editor.getAttributeManager().removeConfiguration(l,s.getName());o.removeAttributeConfiguration(l)}}e.updateSchemeElement(s,r);var d={};var h=BX.prop.getString(n,"HTML","");if(h!==""){d["html"]=h}o.refreshLayout(d);o.synchronize();break}if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}};BX.Crm.EntityEditorSection.prototype.editChildConfiguration=function(t){this.removeFieldConfigurator();this.removeUserFieldConfigurator();if(t.getType()==="userField"&&this._editor.getUserFieldManager().isModificationEnabled()){this.createUserFieldConfigurator({field:t})}else{this.createFieldConfigurator(t)}};BX.Crm.EntityEditorSection.prototype.createFieldConfigurator=function(t){t.setVisible(false);var e=this._editor.getAttributeManager();if(e){this._mandatoryConfigurator=e.createFieldConfigurator(t,BX.Crm.EntityFieldAttributeType.required)}this._fieldConfigurator=BX.Crm.EntityEditorFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,field:t,mandatoryConfigurator:this._mandatoryConfigurator});this.addChild(this._fieldConfigurator,{related:t});BX.addCustomEvent(this._fieldConfigurator,"onSave",BX.delegate(this.onFieldConfigurationSave,this));BX.addCustomEvent(this._fieldConfigurator,"onCancel",BX.delegate(this.onFieldConfigurationCancel,this))};BX.Crm.EntityEditorSection.prototype.removeFieldConfigurator=function(){if(this._fieldConfigurator){var t=this._fieldConfigurator.getField();if(t){t.setVisible(true)}this.removeChild(this._fieldConfigurator);this._fieldConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onFieldConfigurationSave=function(t,e){if(t!==this._fieldConfigurator){return}var i=BX.prop.get(e,"field",null);if(!i){throw"EntityEditorSection. Could not find target field."}var n=BX.prop.getString(e,"label","");var r=BX.prop.getBoolean(e,"showAlways",null);if(n===""&&r===null){this.removeFieldConfigurator();if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}return}this._fieldConfigurator.setLocked(true);i.setTitle(n);if(r!==null&&r!==i.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){i.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.markSchemeAsChanged();this.saveScheme().then(BX.delegate(function(){if(this._mandatoryConfigurator){if(this._mandatoryConfigurator.isPermitted()&&i.areAttributesEnabled()&&!i.isRequired()){if(this._mandatoryConfigurator.isEnabled()){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}var t=this._mandatoryConfigurator.getConfiguration();this._editor.getAttributeManager().saveConfiguration(t,i.getName());i.setAttributeConfiguration(t)}else{var e=this._mandatoryConfigurator.getTypeId();this._editor.getAttributeManager().removeConfiguration(e,i.getName());i.removeAttributeConfiguration(e)}}this._mandatoryConfigurator=null}this.removeFieldConfigurator()},this))};BX.Crm.EntityEditorSection.prototype.onFieldConfigurationCancel=function(t,e){if(t!==this._fieldConfigurator){return}var i=BX.prop.get(e,"field",null);if(!i){throw"EntityEditorSection. Could not find target field."}this.removeFieldConfigurator();if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}};BX.Crm.EntityEditorSection.prototype.enablePointerEvents=function(t){if(!this._fields){return}t=!!t;for(i=0,length=this._fields.length;i<length;i++){this._fields[i].enablePointerEvents(t)}};BX.Crm.EntityEditorSection.prototype.onDeleteConfirm=function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this._editor.removeSchemeElement(this.getSchemeElement());this._editor.removeControl(this);this._editor.saveScheme()};BX.Crm.EntityEditorSection.prototype.onDeleteSectionBtnClick=function(t){if(this.isRequired()||this.isRequiredConditionally()){this.showMessageDialog("operationDenied",this.getMessage("deleteSection"),this.getMessage("deleteSectionDenied"));return}var e=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!e){e=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("deleteSection"),content:this.getMessage("deleteSectionConfirm")})}e.open().then(BX.delegate(this.onDeleteConfirm,this))};BX.Crm.EntityEditorSection.prototype.getDragObjectType=function(){return BX.Crm.EditorDragObjectType.section};BX.Crm.EntityEditorSection.prototype.getChildDragObjectType=function(){return BX.Crm.EditorDragObjectType.field};BX.Crm.EntityEditorSection.prototype.hasPlaceHolder=function(){return!!this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.createPlaceHolder=function(t){this.enablePointerEvents(false);var e=this.getChildCount();if(t<0||t>e){t=e>0?e:0}if(this._dragPlaceHolder){if(this._dragPlaceHolder.getIndex()===t){return this._dragPlaceHolder}this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}this._dragPlaceHolder=BX.Crm.EditorDragFieldPlaceholder.create({container:this._contentContainer,anchor:t<e?this._fields[t].getWrapper():this._buttonPanelWrapper,index:t});this._dragPlaceHolder.layout();return this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.getPlaceHolder=function(){return this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.removePlaceHolder=function(){this.enablePointerEvents(true);if(this._dragPlaceHolder){this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}};BX.Crm.EntityEditorSection.prototype.processDraggedItemDrop=function(t,e){var i=t.getCharge();if(!(i instanceof BX.Crm.EditorFieldDragContainer&&i.getSection()===this)){return}var n=e.getContextData();var r=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(r!==this.getDraggableContextId()){return}var o=this.getPlaceHolder();var s=o?o.getIndex():-1;if(s<0){return}var a=typeof n["charge"]!=="undefined"?n["charge"]:null;if(!(a instanceof BX.Crm.EditorFieldDragItem)){return}var l=a.getControl();if(!l){return}var d=l.getParent();if(d===this){var h=this.getChildIndex(l);if(h<0){return}var p=s<=h?s:s-1;if(p===h){return}this.moveChild(l,p,{enableSaving:false});this._editor.saveSchemeChanges()}else{var u=l.getSchemeElement();d.removeChild(l,{enableSaving:false});var c=this._editor.createControl(u.getType(),u.getName(),{schemeElement:u,model:this._model,parent:this,mode:this._mode});if(this._mode===BX.Crm.EntityEditorMode.view&&!c.hasContentToDisplay()&&!c.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){c.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.addChild(c,{index:s,enableSaving:false});this._editor.saveSchemeChanges()}};BX.Crm.EntityEditorSection.prototype.onDrop=function(t,e,i,n){this.processDraggedItemDrop(t,e)};BX.Crm.EntityEditorSection.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("section_"+this.getId(),{charge:BX.Crm.EditorSectionDragItem.create({control:this}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorSection.prototype.releaseDragDropAbilities=function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}};BX.Crm.EntityEditorSection.prototype.isRequired=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].isRequired()){return true}}return false};BX.Crm.EntityEditorSection.prototype.isRequiredConditionally=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].isRequiredConditionally()){return true}}return false};BX.Crm.EntityEditorSection.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorSection.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.EntityEditorSection.messages==="undefined"){BX.Crm.EntityEditorSection.messages={}}BX.Crm.EntityEditorSection.create=function(t,e){var i=new BX.Crm.EntityEditorSection;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorText==="undefined"){BX.Crm.EntityEditorText=function(){BX.Crm.EntityEditorText.superclass.constructor.apply(this);this._input=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorText,BX.Crm.EntityEditorField);BX.Crm.EntityEditorText.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorText.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorText.prototype.focus=function(){if(!this._input){return}BX.focus(this._input);BX.Crm.EditorTextHelper.getCurrent().setPositionAtEnd(this._input)};BX.Crm.EntityEditorText.prototype.getLineCount=function(){return this._schemeElement.getDataIntegerParam("lineCount",1)};BX.Crm.EntityEditorText.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-text"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));var r=this.getLineCount();if(r>1){this._input=BX.create("textarea",{props:{className:"crm-entity-widget-content-textarea",name:e,rows:r,value:n}})}else{this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}})}if(this.isNewEntity()){var o=this.getCreationPlaceholder();if(o!==""){this._input.setAttribute("placeholder",o)}}BX.bind(this._input,"input",this._changeHandler);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._input]})]});if(this._editor.isDuplicateControlEnabled()){var s=this.getDuplicateControlConfig();if(s){if(!BX.type.isPlainObject(s["field"])){s["field"]={}}s["field"]["id"]=this.getId();s["field"]["element"]=this._input;this._editor.getDuplicateManager().registerField(s)}}}else{this._wrapper.appendChild(this.createTitleNode(i));if(this.hasContentToDisplay()){if(this.getLineCount()>1){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},html:BX.util.nl2br(BX.util.htmlspecialchars(n))})]})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:n})]})}}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorText.prototype.doClearLayout=function(t){if(this._editor.isDuplicateControlEnabled()){var e=this.getDuplicateControlConfig();if(e){if(!BX.type.isPlainObject(e["field"])){e["field"]={}}e["field"]["id"]=this.getId();this._editor.getDuplicateManager().unregisterField(e)}}this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorText.prototype.refreshLayout=function(){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorText.superclass.refreshLayout.apply(this,arguments);return}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._input){this._input.value=this.getValue()}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._innerWrapper){this._innerWrapper.innerHTML=BX.util.htmlspecialchars(this.getValue())}};BX.Crm.EntityEditorText.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorText.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorText. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorText.prototype.showError=function(t,e){BX.Crm.EntityEditorText.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorText.prototype.clearError=function(){BX.Crm.EntityEditorText.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorText.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value,{originator:this})}};BX.Crm.EntityEditorText.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorText.create=function(t,e){var i=new BX.Crm.EntityEditorText;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorNumber==="undefined"){BX.Crm.EntityEditorNumber=function(){BX.Crm.EntityEditorNumber.superclass.constructor.apply(this);this._input=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorNumber,BX.Crm.EntityEditorField);BX.Crm.EntityEditorNumber.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorNumber.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorNumber.prototype.focus=function(){if(!this._input){return}BX.focus(this._input);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._input)};BX.Crm.EntityEditorNumber.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-number"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._input=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}});BX.bind(this._input,"input",this._changeHandler);this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-field-half-width"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._input]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));if(!this.hasContentToDisplay()){n=this.getMessage("isEmpty")}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:n})]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorNumber.prototype.doClearLayout=function(t){this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorNumber.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorNumber.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorNumber. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorNumber.prototype.showError=function(t,e){BX.Crm.EntityEditorNumber.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorNumber.prototype.clearError=function(){BX.Crm.EntityEditorNumber.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorNumber.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value)}};BX.Crm.EntityEditorNumber.create=function(t,e){var i=new BX.Crm.EntityEditorNumber;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorDatetime==="undefined"){BX.Crm.EntityEditorDatetime=function(){BX.Crm.EntityEditorDatetime.superclass.constructor.apply(this);this._input=null;this._inputClickHandler=BX.delegate(this.onInputClick,this);this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorDatetime,BX.Crm.EntityEditorField);BX.Crm.EntityEditorDatetime.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorDatetime.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorDatetime.prototype.focus=function(){if(this._input){BX.focus(this._input);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._input)}};BX.Crm.EntityEditorDatetime.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-date"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}});BX.bind(this._input,"click",this._inputClickHandler);BX.bind(this._input,"change",this._changeHandler);BX.bind(this._input,"input",this._changeHandler);this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-field-half-width"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._input]})]})}else{n=BX.date.format("j F Y",BX.parseDate(n));this._wrapper.appendChild(this.createTitleNode(i));if(!this.hasContentToDisplay()){n=this.getMessage("isEmpty")}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:n})]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorDatetime.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)&&this._input){window.setTimeout(BX.delegate(this.showCalendar,this),100)}};BX.Crm.EntityEditorDatetime.prototype.doClearLayout=function(t){this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorDatetime.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorDatetime.prototype.onInputClick=function(t){this.showCalendar()};BX.Crm.EntityEditorDatetime.prototype.showCalendar=function(){BX.calendar({node:this._input,field:this._input,bTime:false,bSetFocus:false})};BX.Crm.EntityEditorDatetime.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorDatetime. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorDatetime.prototype.showError=function(t,e){BX.Crm.EntityEditorDatetime.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorDatetime.prototype.clearError=function(){BX.Crm.EntityEditorDatetime.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorDatetime.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value)}};BX.Crm.EntityEditorDatetime.create=function(t,e){var i=new BX.Crm.EntityEditorDatetime;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorBoolean==="undefined"){BX.Crm.EntityEditorBoolean=function(){BX.Crm.EntityEditorBoolean.superclass.constructor.apply(this);this._input=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorBoolean,BX.Crm.EntityEditorField);BX.Crm.EntityEditorBoolean.prototype.doInitialize=function(){BX.Crm.EntityEditorBoolean.superclass.doInitialize.apply(this);this._selectedValue=this._model.getField(this._schemeElement.getName())};BX.Crm.EntityEditorBoolean.prototype.areAttributesEnabled=function(){return false};BX.Crm.EntityEditorBoolean.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorBoolean.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorBoolean.prototype.hasValue=function(){return BX.util.trim(this.getValue())!==""};BX.Crm.EntityEditorBoolean.prototype.getValue=function(t){if(!this._model){return""}if(t===undefined){t="N"}var e=this._model.getStringField(this.getName(),t);if(e!=="Y"&&e!=="N"){e="N"}return e};BX.Crm.EntityEditorBoolean.prototype.getRuntimeValue=function(){if(this._mode!==BX.Crm.EntityEditorMode.edit||!this._input)return"";var t=BX.util.trim(this._input.value);if(t!=="Y"&&t!=="N"){t="N"}return t};BX.Crm.EntityEditorBoolean.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-checkbox"]});this.adjustWrapper();var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(BX.create("input",{attrs:{name:e,type:"hidden",value:"N"}}));this._input=BX.create("input",{attrs:{className:"crm-entity-widget-content-checkbox",name:e,type:"checkbox",value:"Y",checked:n==="Y"}});BX.bind(this._input,"change",this._changeHandler);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[BX.create("label",{attrs:{className:"crm-entity-widget-content-block-checkbox-label"},children:[this._input,BX.create("span",{props:{className:"crm-entity-widget-content-block-checkbox-description"},text:i})]})]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:this.getMessage(n==="Y"?"yes":"no")})]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorBoolean.prototype.doClearLayout=function(t){this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorBoolean.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorBoolean. Invalid validation context"}if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));BX.addClass(this._input,"crm-entity-widget-content-error");this.showRequiredFieldError(this._input)}else{BX.removeClass(this._input,"crm-entity-widget-content-error");this.clearError()}return e};BX.Crm.EntityEditorBoolean.prototype.showError=function(t,e){BX.Crm.EntityEditorBoolean.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorBoolean.prototype.clearError=function(){BX.Crm.EntityEditorBoolean.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorBoolean.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.checked?"Y":"N",{originator:this})}};BX.Crm.EntityEditorBoolean.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorBoolean.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorBoolean.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorBoolean.messages==="undefined"){BX.Crm.EntityEditorBoolean.messages={}}BX.Crm.EntityEditorBoolean.create=function(t,e){var i=new BX.Crm.EntityEditorBoolean;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorList==="undefined"){BX.Crm.EntityEditorList=function(){BX.Crm.EntityEditorList.superclass.constructor.apply(this);this._items=null;this._input=null;this._selectContainer=null;this._selectedValue="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._innerWrapper=null;this._isOpened=false};BX.extend(BX.Crm.EntityEditorList,BX.Crm.EntityEditorField);BX.Crm.EntityEditorList.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorList.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorList.prototype.checkIfNotEmpty=function(t){return t!==""&&t!=="0"};BX.Crm.EntityEditorList.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-select"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();var r=this.getItemByValue(n);var o=this.getDataBooleanParam("isHtml",false);var s={};if(!r){r=this.getFirstItem();if(r){n=r["VALUE"]}}this._selectedValue=n;this._selectContainer=null;this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);s={props:{className:"crm-entity-widget-content-select"}};if(o){s.html=r?r["NAME"]:n}else{s.text=r?r["NAME"]:n}this._selectContainer=BX.create("div",s);BX.bind(this._selectContainer,"click",this._selectorClickHandler);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._selectContainer]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));var a="";if(!this.hasContentToDisplay()){a=this.getMessage("isEmpty")}else if(r){a=r["NAME"]}else{a=n}var s={props:{className:"crm-entity-widget-content-block-inner-text"}};if(o){s.html=a}else{s.text=a}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",s)]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorList.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)&&this._selectContainer){window.setTimeout(BX.delegate(this.openMenu,this),100)}};BX.Crm.EntityEditorList.prototype.doClearLayout=function(t){this.closeMenu();this._input=null;this._selectContainer=null;this._innerWrapper=null};BX.Crm.EntityEditorList.prototype.refreshLayout=function(){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMoney.superclass.refreshLayout.apply(this,arguments);return}var t=this.getValue();var e=this.getItemByValue(t);var i=e?BX.prop.getString(e,"NAME",t):t;if(this._mode===BX.Crm.EntityEditorMode.edit){this._selectedValue=t;if(this._input){this._input.value=t}if(this._selectContainer){this._selectContainer.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i)}}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._innerWrapper){this._innerWrapper.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i)}};BX.Crm.EntityEditorList.prototype.validate=function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){throw"BX.Crm.EntityEditorList. Invalid validation context"}if(!this.isEditable()){return true}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorList.prototype.showError=function(t,e){BX.Crm.EntityEditorList.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorList.prototype.clearError=function(){BX.Crm.EntityEditorList.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorList.prototype.onSelectorClick=function(t){if(!this._isOpened){this.openMenu()}else{this.closeMenu()}};BX.Crm.EntityEditorList.prototype.openMenu=function(){if(this._isOpened){return}var t=[];var e=this.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(!BX.prop.getBoolean(r,"IS_EDITABLE",true)){continue}var o=BX.prop.getString(r,"VALUE",i);var s=BX.prop.getString(r,"NAME",o);t.push({text:this.getDataBooleanParam("isHtml",false)?s:BX.util.htmlspecialchars(s),value:o,onclick:BX.delegate(this.onItemSelect,this)})}BX.PopupMenu.show(this._id,this._selectContainer,t,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorList.prototype.closeMenu=function(){var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorList.prototype.onMenuShow=function(){BX.addClass(this._selectContainer,"active");this._isOpened=true};BX.Crm.EntityEditorList.prototype.onMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isOpened=false};BX.Crm.EntityEditorList.prototype.onItemSelect=function(t,e){this.closeMenu();this._selectedValue=this._input.value=e.value;var i=BX.prop.getString(this.getItemByValue(this._selectedValue),"NAME",this._selectedValue);this._selectContainer.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i);this.markAsChanged();BX.PopupMenu.destroy(this._id)};BX.Crm.EntityEditorList.prototype.getItems=function(){if(!this._items){this._items=BX.prop.getArray(this._schemeElement.getData(),"items",[])}return this._items};BX.Crm.EntityEditorList.prototype.getItemByValue=function(t){var e=this.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getString(r,"VALUE","")){return r}}return null};BX.Crm.EntityEditorList.prototype.getFirstItem=function(){var t=this.getItems();return t.length>0?t[0]:null};BX.Crm.EntityEditorList.prototype.save=function(){if(!this.isEditable()){return}this._model.setField(this.getName(),this._selectedValue)};BX.Crm.EntityEditorList.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorList.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?this._selectedValue:""};BX.Crm.EntityEditorList.create=function(t,e){var i=new BX.Crm.EntityEditorList;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorHtml==="undefined"){BX.Crm.EntityEditorHtml=function(){BX.Crm.EntityEditorHtml.superclass.constructor.apply(this);this._htmlEditorContainer=null;this._htmlEditor=null;this._isEditorInitialized=false;this._focusOnLoad=false;this._input=null;this._innerWrapper=null;this._editorInitializationHandler=BX.delegate(this.onEditorInitialized,this);this._viewClickHandler=BX.delegate(this.onViewClick,this)};BX.extend(BX.Crm.EntityEditorHtml,BX.Crm.EntityEditorField);BX.Crm.EntityEditorHtml.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorHtml.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorHtml.prototype.checkIfNotEmpty=function(t){return BX.Crm.EntityEditorHtml.isNotEmptyValue(t)};BX.Crm.EntityEditorHtml.prototype.focus=function(){if(this._htmlEditor&&this._isEditorInitialized){this._htmlEditor.Focus(true)}else{this._focusOnLoad=true}};BX.Crm.EntityEditorHtml.prototype.layout=function(t){if(this._hasLayout){return}this.release();this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-comment"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){if(!this._editor){throw"BX.Crm.EntityEditorHtml: Editor instance is required for create layout."}var r=this._editor.getHtmlEditorConfig(e);if(!r){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor config."}this._htmlEditorContainer=BX(BX.prop.getString(r,"containerId"));if(!BX.type.isElementNode(this._htmlEditorContainer)){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor container."}this._htmlEditor=BXHtmlEditor.Get(BX.prop.getString(r,"id"));if(!this._htmlEditor){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor instance."}this._wrapper.appendChild(this.createTitleNode(i));this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._htmlEditorContainer]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});if(this.hasContentToDisplay()){this._innerWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-comment"},html:n})]}));if(n.length>200){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-comment-collapsed");this._innerWrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-widget-content-block-field-comment-expand-btn-container"},children:[BX.create("A",{attrs:{className:"crm-entity-widget-content-block-field-comment-expand-btn",href:"#"},events:{click:BX.delegate(this.onExpandButtonClick,this)},text:this.getMessage("expand")})]}));this._isCollapsed=true}}else{this._innerWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}this._wrapper.appendChild(this._innerWrapper);BX.bindDelegate(this._wrapper,"mousedown",BX.delegate(this.filterViewNode,this),this._viewClickHandler)}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);if(this._mode===BX.Crm.EntityEditorMode.edit){this._isEditorInitialized=!!this._htmlEditor.inited;if(this._isEditorInitialized){this.prepareEditor()}else{BX.addCustomEvent(this._htmlEditor,"OnCreateIframeAfter",this._editorInitializationHandler);this._htmlEditor.Init()}window.top.setTimeout(BX.delegate(this.bindChangeEvent,this),1e3);this.initializeDragDropAbilities()}this._hasLayout=true};BX.Crm.EntityEditorHtml.prototype.doClearLayout=function(t){this.release();this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorHtml.prototype.onExpandButtonClick=function(t){if(!this._wrapper){return BX.PreventDefault(t)}if(this._hasFiles&&BX.type.isDomNode(this._commentWrapper)&&!this._textLoaded){this._textLoaded=true;this.loadContent(this._commentWrapper,"GET_TEXT")}var e=this._wrapper.querySelector(".crm-entity-widget-content-block-inner-comment");if(this._isCollapsed){BX.defer(function(){e.style.maxHeight=e.scrollHeight+130+"px"})();setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-field-comment-collapsed");BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-comment-expand");e.style.maxHeight=""},this),200)}else{BX.defer(function(){e.style.maxHeight=e.clientHeight+"px"})();BX.defer(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-field-comment-expand");BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-comment-collapsed")},this)();setTimeout(function(){e.style.maxHeight=""},200)}this._isCollapsed=!this._isCollapsed;var i=this._wrapper.querySelector("a.crm-entity-widget-content-block-field-comment-expand-btn");if(i){i.innerHTML=this.getMessage(this._isCollapsed?"expand":"collapse")}return BX.PreventDefault(t)};BX.Crm.EntityEditorHtml.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorHtml.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorHtml.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorHtml.prototype.filterViewNode=function(t){return true};BX.Crm.EntityEditorHtml.prototype.onViewClick=function(t){var e=null;var i=BX.getEventTarget(t);if(i.tagName==="A"){e=i}else{e=BX.findParent(i,{tagName:"a"},this._wrapper)}if(e&&e.target!=="_blank"){e.target="_blank"}};BX.Crm.EntityEditorHtml.prototype.onEditorInitialized=function(){this._isEditorInitialized=true;BX.removeCustomEvent(this._htmlEditor,"OnCreateIframeAfter",this._editorInitializationHandler);this.prepareEditor()};BX.Crm.EntityEditorHtml.prototype.prepareEditor=function(){this._htmlEditorContainer.style.display="";this._htmlEditor.CheckAndReInit();this._htmlEditor.ResizeSceleton("100%",200);this._htmlEditor.SetContent(this.getStringValue(""),true);if(this._focusOnLoad){this._htmlEditor.Focus(true);this._focusOnLoad=false}};BX.Crm.EntityEditorHtml.prototype.release=function(){if(this._htmlEditorContainer){var t=BX.create("DIV",{style:{height:this._htmlEditorContainer.offsetHeight+"px",border:"1px solid #bbc4cd",boxSizing:"border-box"}});this._htmlEditorContainer.parentNode.insertBefore(t,this._htmlEditorContainer);document.body.appendChild(this._htmlEditorContainer);this._htmlEditorContainer.style.display="none";this._htmlEditorContainer=null}if(this._htmlEditor){this.unbindChangeEvent();this._htmlEditor.SetContent("");this._htmlEditor=null;this._isEditorInitialized=false}this._focusOnLoad=false};BX.Crm.EntityEditorHtml.prototype.bindChangeEvent=function(){if(this._htmlEditor){BX.addCustomEvent(this._htmlEditor,"OnContentChanged",this._changeHandler)}};BX.Crm.EntityEditorHtml.prototype.unbindChangeEvent=function(){if(this._htmlEditor){BX.removeCustomEvent(this._htmlEditor,"OnContentChanged",this._changeHandler)}};BX.Crm.EntityEditorHtml.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._htmlEditor)){throw"BX.Crm.EntityEditorHtml. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.Crm.EntityEditorHtml.isNotEmptyValue(this._htmlEditor.GetContent());if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._htmlEditorContainer)}return e};BX.Crm.EntityEditorHtml.prototype.showError=function(t,e){BX.Crm.EntityEditorHtml.superclass.showError.apply(this,arguments);if(this._htmlEditorContainer){BX.addClass(this._htmlEditorContainer,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorHtml.prototype.clearError=function(){BX.Crm.EntityEditorHtml.superclass.clearError.apply(this);if(this._htmlEditorContainer){BX.removeClass(this._htmlEditorContainer,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorHtml.prototype.save=function(){if(this._htmlEditor){var t=this._input.value=this._htmlEditor.GetContent();this._model.setField(this.getName(),t)}};BX.Crm.EntityEditorHtml.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?this._htmlEditor.GetContent():""};BX.Crm.EntityEditorHtml.isNotEmptyValue=function(t){return BX.util.trim(t.replace(/<br\/?>|&nbsp;/gi,""))!==""};BX.Crm.EntityEditorHtml.create=function(t,e){var i=new BX.Crm.EntityEditorHtml;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMoney==="undefined"){BX.Crm.EntityEditorMoney=function(){BX.Crm.EntityEditorMoney.superclass.constructor.apply(this);this._currencyEditor=null;this._amountInput=null;this._currencyInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null;this._selectedCurrencyValue="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._isCurrencyMenuOpened=false};BX.extend(BX.Crm.EntityEditorMoney,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMoney.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMoney.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorMoney.prototype.focus=function(){if(this._amountInput){BX.focus(this._amountInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._amountInput)}};BX.Crm.EntityEditorMoney.prototype.getValue=function(t){if(!this._model){return""}return this._model.getStringField(this.getAmountFieldName(),t!==undefined?t:"")};BX.Crm.EntityEditorMoney.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-money"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=BX.prop.getString(i,"amount");var r=BX.prop.getString(BX.prop.getObject(i,"currency"),"name");var o=this._model.getField(BX.prop.getString(BX.prop.getObject(i,"currency"),"name",""));if(!BX.type.isNotEmptyString(o)){o=BX.Currency.Editor.getBaseCurrencyId()}this._selectedCurrencyValue=o;var s=this._editor.findOption(o,BX.prop.getArray(BX.prop.getObject(i,"currency"),"items"));var a=this.getAmountFieldName();var l=this.getCurrencyFieldName();var d=this._model.getField(a,"");var h=this._model.getField(BX.prop.getString(i,"formatted"),"");this._amountValue=null;this._amountInput=null;this._currencyInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountValue=BX.create("input",{attrs:{name:n,type:"hidden",value:d}});this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:h}});BX.bind(this._amountInput,"input",this._changeHandler);if(this._model.isFieldLocked(a)){this._amountInput.disabled=true}this._currencyInput=BX.create("input",{attrs:{name:r,type:"hidden",value:o}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:s});if(this._model.isFieldLocked(l)){this._selectContainer.disabled=true}else{BX.bind(this._selectContainer,"click",this._selectorClickHandler)}this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double"},children:[this._amountValue,this._amountInput,this._currencyInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"+(this._selectContainer.disabled?"-disabled":"")},children:[this._selectContainer]})]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._inputWrapper]});this._currencyEditor=new BX.Currency.Editor({input:this._amountInput,currency:o,callback:BX.delegate(this.onAmountValueChange,this)});this._currencyEditor.changeValue()}else{this._wrapper.appendChild(this.createTitleNode(e));if(this.hasContentToDisplay()){this._sumElement=BX.create("span",{props:{className:"crm-entity-widget-content-block-wallet"}});this._sumElement.innerHTML=this.renderMoney();this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},children:[this._sumElement]})]})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMoney.prototype.doClearLayout=function(t){BX.PopupMenu.destroy(this._id);if(this._currencyEditor){this._currencyEditor.clean();this._currencyEditor=null}this._amountValue=null;this._amountInput=null;this._currencyInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null};BX.Crm.EntityEditorMoney.prototype.refreshLayout=function(t){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMoney.superclass.refreshLayout.apply(this,arguments);return}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountInput){var e=this._currencyEditor?this._currencyEditor.currency:this._model.getField(this.getCurrencyFieldName());if(!BX.type.isNotEmptyString(e)){e=BX.Currency.Editor.getBaseCurrencyId()}var i=this.getAmountFieldName();this._amountValue.value=this._model.getField(i);this._amountInput.value=BX.Currency.Editor.getFormattedValue(this._model.getField(i,""),e);this._amountInput.disabled=this._model.isFieldLocked(i)}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._sumElement){this._sumElement.innerHTML=this.renderMoney()}};BX.Crm.EntityEditorMoney.prototype.onAmountValueChange=function(t){if(this._amountValue){this._amountValue.value=t}};BX.Crm.EntityEditorMoney.prototype.getAmountFieldName=function(){return this._schemeElement.getDataStringParam("amount","")};BX.Crm.EntityEditorMoney.prototype.getCurrencyFieldName=function(){return BX.prop.getString(this._schemeElement.getDataObjectParam("currency",{}),"name","")};BX.Crm.EntityEditorMoney.prototype.onSelectorClick=function(t){this.openCurrencyMenu()};BX.Crm.EntityEditorMoney.prototype.openCurrencyMenu=function(){if(this._isCurrencyMenuOpened){return}var t=this._schemeElement.getData();var e=BX.prop.getArray(BX.prop.getObject(t,"currency"),"items");var i=0;var n=[];while(i<e.length){n.push({text:e[i]["NAME"],value:e[i]["VALUE"],onclick:BX.delegate(this.onCurrencySelect,this)});i++}BX.PopupMenu.show(this._id,this._selectContainer,n,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onCurrencyMenuOpen,this),onPopupClose:BX.delegate(this.onCurrencyMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorMoney.prototype.closeCurrencyMenu=function(){if(!this._isCurrencyMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorMoney.prototype.onCurrencyMenuOpen=function(){BX.addClass(this._selectContainer,"active");this._isCurrencyMenuOpened=true};BX.Crm.EntityEditorMoney.prototype.onCurrencyMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isCurrencyMenuOpened=false};BX.Crm.EntityEditorMoney.prototype.onCurrencySelect=function(t,e){this.closeCurrencyMenu();this._selectedCurrencyValue=this._currencyInput.value=e.value;this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);if(this._currencyEditor){this._currencyEditor.setCurrency(this._selectedCurrencyValue)}this.markAsChanged({fieldName:this.getCurrencyFieldName(),fieldValue:this._selectedCurrencyValue})};BX.Crm.EntityEditorMoney.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getAmountFieldName()){return}this.refreshLayout()};BX.Crm.EntityEditorMoney.prototype.processModelLock=function(t){var e=BX.prop.getString(t,"name","");if(this.getAmountFieldName()===e){this.refreshLayout()}};BX.Crm.EntityEditorMoney.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountInput&&this._amountValue)){throw"BX.Crm.EntityEditorMoney. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._amountValue.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._inputWrapper)}return e};BX.Crm.EntityEditorMoney.prototype.showError=function(t,e){BX.Crm.EntityEditorMoney.superclass.showError.apply(this,arguments);if(this._amountInput){BX.addClass(this._amountInput,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorMoney.prototype.clearError=function(){BX.Crm.EntityEditorMoney.superclass.clearError.apply(this);if(this._amountInput){BX.removeClass(this._amountInput,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorMoney.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit){if(this._amountValue){t[BX.prop.getString(t,"amount")]=this._amountValue.value}t[BX.prop.getString(t,"currency")]=this._selectedCurrencyValue;return t}return""};BX.Crm.EntityEditorMoney.prototype.save=function(){var t=this._schemeElement.getData();this._model.setField(BX.prop.getString(BX.prop.getObject(t,"currency"),"name"),this._selectedCurrencyValue,{originator:this});if(this._amountValue){this._model.setField(BX.prop.getString(t,"amount"),this._amountValue.value,{originator:this});this._model.setField(BX.prop.getString(t,"formatted"),"",{originator:this});this._editor.formatMoney(this._amountValue.value,this._selectedCurrencyValue,BX.delegate(this.onMoneyFormatRequestSuccess,this))}};BX.Crm.EntityEditorMoney.prototype.onMoneyFormatRequestSuccess=function(t){var e=this._schemeElement.getData();var i=BX.type.isNotEmptyString(t["FORMATTED_SUM_WITH_CURRENCY"])?t["FORMATTED_SUM_WITH_CURRENCY"]:"";this._model.setField(BX.prop.getString(e,"formattedWithCurrency"),i);var n=BX.type.isNotEmptyString(t["FORMATTED_SUM"])?t["FORMATTED_SUM"]:"";this._model.setField(BX.prop.getString(e,"formatted"),n,{originator:this});if(this._sumElement){while(this._sumElement.firstChild){this._sumElement.removeChild(this._sumElement.firstChild)}this._sumElement.innerHTML=this.renderMoney()}};BX.Crm.EntityEditorMoney.prototype.renderMoney=function(){var t=this._schemeElement.getData();var e=this._model.getField(BX.prop.getString(t,"formattedWithCurrency"),"");var i=this._model.getField(BX.prop.getString(t,"formatted"),"");var n=BX.Currency.Editor.trimTrailingZeros(i,this._selectedCurrencyValue);return e.replace(i,'<span class="crm-entity-widget-content-block-colums-right">'+n+"</span>")};BX.Crm.EntityEditorMoney.create=function(t,e){var i=new BX.Crm.EntityEditorMoney;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorImage==="undefined"){BX.Crm.EntityEditorImage=function(){BX.Crm.EntityEditorImage.superclass.constructor.apply(this);this._innerWrapper=null;this._dialogShowHandler=BX.delegate(this.onDialogShow,this);this._dialogCloseHandler=BX.delegate(this.onDialogClose,this);this._fileChangeHandler=BX.delegate(this.onFileChange,this)};BX.extend(BX.Crm.EntityEditorImage,BX.Crm.EntityEditorField);BX.Crm.EntityEditorImage.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorImage.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorImage.prototype.hasContentToDisplay=function(){return this._mode===BX.Crm.EntityEditorMode.edit||this._model.getSchemeField(this._schemeElement,"showUrl","")!==""};BX.Crm.EntityEditorImage.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-file"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._editor.loadCustomHtml("RENDER_IMAGE_INPUT",{FIELD_NAME:e},BX.delegate(this.onEditorHtmlLoad,this))}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});if(this.hasContentToDisplay()){this._innerWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box"},children:[BX.create("img",{props:{className:"crm-entity-widget-content-block-photo",src:this._model.getSchemeField(this._schemeElement,"showUrl","")}})]}))}else{this._innerWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorImage.prototype.doClearLayout=function(t){if(this._innerWrapper){BX.removeCustomEvent(window,"onAfterPopupShow",this._dialogShowHandler);BX.removeCustomEvent(window,"onPopupClose",this._dialogCloseHandler);BX.cleanNode(this._innerWrapper);this._innerWrapper=null}this.unbindFileEvents()};BX.Crm.EntityEditorImage.prototype.onEditorHtmlLoad=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._innerWrapper){this._innerWrapper.innerHTML=t;BX.addCustomEvent(window,"onAfterPopupShow",this._dialogShowHandler);BX.addCustomEvent(window,"onPopupClose",this._dialogCloseHandler);window.setTimeout(BX.delegate(this.bindFileEvents,this),500)}};BX.Crm.EntityEditorImage.prototype.bindFileEvents=function(){var t=BX.MFInput?BX.MFInput.get(this.getName().toLowerCase()+"_uploader"):null;if(t){BX.addCustomEvent(t,"onAddFile",this._fileChangeHandler);BX.addCustomEvent(t,"onDeleteFile",this._fileChangeHandler)}};BX.Crm.EntityEditorImage.prototype.unbindFileEvents=function(){var t=BX.MFInput?BX.MFInput.get(this.getName().toLowerCase()+"_uploader"):null;if(t){BX.removeCustomEvent(t,"onAddFile",this._fileChangeHandler);BX.removeCustomEvent(t,"onDeleteFile",this._fileChangeHandler)}};BX.Crm.EntityEditorImage.prototype.onDialogShow=function(t){if(t.uniquePopupId.indexOf("popupavatarEditor")!==0){return}BX.addCustomEvent(window,"onApply",this._fileChangeHandler);if(this._singleEditController){this._singleEditController.setActiveDelayed(false)}BX.bind(t.popupContainer,"click",function(t){BX.eventCancelBubble(t)})};BX.Crm.EntityEditorImage.prototype.onDialogClose=function(t){if(BX.prop.getString(t,"uniquePopupId","").indexOf("popupavatarEditor")!==0){return}BX.removeCustomEvent(window,"onApply",this._fileChangeHandler);if(this._singleEditController){this._singleEditController.setActiveDelayed(true)}};BX.Crm.EntityEditorImage.prototype.onFileChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorImage.create=function(t,e){var i=new BX.Crm.EntityEditorImage;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUser==="undefined"){BX.Crm.EntityEditorUser=function(){BX.Crm.EntityEditorUser.superclass.constructor.apply(this);this._input=null;this._editButton=null;this._photoElement=null;this._nameElement=null;this._positionElement=null;this._userSelector=null;this._selectedData={};this._editButtonClickHandler=BX.delegate(this.onEditBtnClick,this)};BX.extend(BX.Crm.EntityEditorUser,BX.Crm.EntityEditorField);BX.Crm.EntityEditorUser.prototype.isSingleEditEnabled=function(){return true};BX.Crm.EntityEditorUser.prototype.hasContentToDisplay=function(){return true};BX.Crm.EntityEditorUser.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getName();var i=this._schemeElement.getTitle();var n=this._model.getField(e);var r=this._model.getSchemeField(this._schemeElement,"formated","");var o=this._model.getSchemeField(this._schemeElement,"position","");var s=this._model.getSchemeField(this._schemeElement,"showUrl","","");var a=this._model.getSchemeField(this._schemeElement,"photoUrl","");this._photoElement=BX.create("a",{props:{className:"crm-widget-employee-avatar-container",target:"_blank"},style:{backgroundImage:a!==""?"url('"+a+"')":"",backgroundSize:a!==""?"30px":""}});this._nameElement=BX.create("a",{props:{className:"crm-widget-employee-name",target:"_blank"},text:r});if(s!==""){this._photoElement.href=s;this._nameElement.href=s}this._positionElement=BX.create("SPAN",{props:{className:"crm-widget-employee-position"},text:o});if(this.isInEditMode()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));var l=BX.create("div",{props:{className:"crm-widget-employee-container"}});this._editButton=null;this._input=null;if(this._mode===BX.Crm.EntityEditorMode.edit||this.isEditInViewEnabled()&&!this.isReadOnly()){this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);this._editButton=BX.create("span",{props:{className:"crm-widget-employee-change"},text:this.getMessage("change")});BX.bind(this._editButton,"click",this._editButtonClickHandler);l.appendChild(this._editButton)}l.appendChild(this._photoElement);l.appendChild(BX.create("span",{props:{className:"crm-widget-employee-info"},children:[this._nameElement,this._positionElement]}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[l]}));if(this.isInEditMode()){this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorUser.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)){window.setTimeout(BX.delegate(this.openSelector,this),0)}};BX.Crm.EntityEditorUser.prototype.doClearLayout=function(t){this._input=null;this._editButton=null;this._photoElement=null;this._nameElement=null;this._positionElement=null};BX.Crm.EntityEditorUser.prototype.onEditBtnClick=function(t){if(this._mode===BX.Crm.EntityEditorMode.view&&this.isEditInViewEnabled()&&this.getEditor().isChanged()){this.switchToSingleEditMode()}else{this.openSelector()}};BX.Crm.EntityEditorUser.prototype.openSelector=function(){if(!this._userSelector){this._userSelector=BX.Crm.EntityEditorUserSelector.create(this._id,{callback:BX.delegate(this.processItemSelect,this)})}this._userSelector.open(this._editButton)};BX.Crm.EntityEditorUser.prototype.processItemSelect=function(t,e){var i=this._mode===BX.Crm.EntityEditorMode.view;var n=this.isEditInViewEnabled();if(i&&!n){return}this._selectedData={id:BX.prop.getInteger(e,"entityId",0),photoUrl:BX.prop.getString(e,"avatar",""),formattedNameHtml:BX.prop.getString(e,"name",""),positionHtml:BX.prop.getString(e,"desc","")};this._input.value=this._selectedData["id"];this._photoElement.style.backgroundImage=this._selectedData["photoUrl"]!==""?"url('"+this._selectedData["photoUrl"]+"')":"";this._photoElement.style.backgroundSize=this._selectedData["photoUrl"]!==""?"30px":"";this._nameElement.innerHTML=this._selectedData["formattedNameHtml"];this._positionElement.innerHTML=this._selectedData["positionHtml"];this._userSelector.close();if(!i){this.markAsChanged()}else{this._editor.saveControl(this)}};BX.Crm.EntityEditorUser.prototype.save=function(){var t=this._schemeElement.getData();if(this._selectedData["id"]>0){var e=this._selectedData["id"];this._model.setField(BX.prop.getString(t,"formated"),BX.util.htmlspecialcharsback(this._selectedData["formattedNameHtml"]));this._model.setField(BX.prop.getString(t,"position"),this._selectedData["positionHtml"]!=="&nbsp;"?BX.util.htmlspecialcharsback(this._selectedData["positionHtml"]):"");this._model.setField(BX.prop.getString(t,"showUrl"),BX.prop.getString(t,"pathToProfile").replace(/#user_id#/gi,e));this._model.setField(BX.prop.getString(t,"photoUrl"),this._selectedData["photoUrl"]);this._model.setField(this.getName(),e)}};BX.Crm.EntityEditorUser.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorUser.prototype.getRuntimeValue=function(){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._selectedData["id"]>0){return this._selectedData["id"]}return""};BX.Crm.EntityEditorUser.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorUser.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorUser.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorUser.messages==="undefined"){BX.Crm.EntityEditorUser.messages={}}BX.Crm.EntityEditorUser.create=function(t,e){var i=new BX.Crm.EntityEditorUser;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorAddress==="undefined"){BX.Crm.EntityEditorAddress=function(){BX.Crm.EntityEditorAddress.superclass.constructor.apply(this);this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorAddress,BX.Crm.EntityEditorField);BX.Crm.EntityEditorAddress.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorAddress.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorAddress.prototype.hasContentToDisplay=function(){return this._mode===BX.Crm.EntityEditorMode.edit||this.getViewHtml()!==""};BX.Crm.EntityEditorAddress.prototype.getViewHtml=function(){var t=this._schemeElement.getDataStringParam("view","");if(t===""){t=this._schemeElement.getName()+"_HML"}return this._model.getStringField(t,"")};BX.Crm.EntityEditorAddress.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getName();var i=this.getTitle();var n=this._schemeElement.getDataObjectParam("fields",{});var r=this._schemeElement.getDataObjectParam("labels",{});this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));if(this._mode===BX.Crm.EntityEditorMode.edit){var o=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner-address"}});this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[o]})]});for(var s in n){if(!n.hasOwnProperty(s)){return}var a=n[s];var l=BX.prop.getString(r,s,s);this.layoutField(s,a,l,o)}BX.bindDelegate(o,"bxchange",{tag:["input","textarea"]},this._changeHandler)}else{if(this.hasContentToDisplay()){this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner-text"},html:this.getViewHtml()})]})}else{this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorAddress.prototype.layoutField=function(t,e,i,n){var r=BX.prop.getString(e,"NAME",t);var o=this._model.getStringField(r,"");n.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:i})]}));if(BX.prop.getBoolean(e,"IS_MULTILINE",false)){n.appendChild(BX.create("textarea",{props:{className:"crm-entity-widget-content-input",name:r,type:"text",value:o}}))}else{n.appendChild(BX.create("input",{props:{className:"crm-entity-widget-content-input",name:r,type:"text",value:o}}))}};BX.Crm.EntityEditorAddress.prototype.doClearLayout=function(t){this._innerWrapper=null};BX.Crm.EntityEditorAddress.create=function(t,e){var i=new BX.Crm.EntityEditorAddress;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifieldItem==="undefined"){BX.Crm.EntityEditorMultifieldItem=function(){this._id="";this._settings={};this._parent=null;this._editor=null;this._mode=BX.Crm.EntityEditorMode.view;this._data=null;this._typeId="";this._valueTypeItems=null;this._container=null;this._wrapper=null;this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;this._deleteButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._isJunked=false;this._hasLayout=false};BX.Crm.EntityEditorMultifieldItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._parent=BX.prop.get(this._settings,"parent",null);this._editor=this._parent.getEditor();this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);this._typeId=BX.prop.getString(this._settings,"typeId","");this._data=BX.prop.getObject(this._settings,"data",{});this._valueTypeItems=BX.prop.getArray(this._settings,"valueTypeItems",[]);this._container=BX.prop.getElementNode(this._settings,"container",null)},getId:function(){return this._id},isEmpty:function(){return BX.util.trim(this.getValue())===""},getTypeId:function(){return this._typeId},getValue:function(){return BX.prop.getString(this._data,"VALUE","")},getValueId:function(){return BX.prop.getString(this._data,"ID","")},getValueTypeId:function(){var t=BX.prop.getString(this._data,"VALUE_TYPE","");return t!==""?t:this.getDefaultValueTypeId()},getDefaultValueTypeId:function(){return this._valueTypeItems.length>0?BX.prop.getString(this._valueTypeItems[0],"VALUE"):""},getViewData:function(){return BX.prop.getObject(this._data,"VIEW_DATA",{})},resolveValueTypeName:function(t){if(t===""){return""}for(var e=0,i=this._valueTypeItems.length;e<i;e++){var n=this._valueTypeItems[e];if(t===BX.prop.getString(n,"VALUE","")){return BX.prop.getString(n,"NAME",t)}}return t},prepareControlName:function(t){return this.getTypeId()+"["+this.getValueId()+"]"+"["+t+"]"},getMode:function(){return this._mode},setMode:function(t){this._mode=t},getContainer:function(){return this._container},setContainer:function(t){this._container=t;if(this._hasLayout){this.clearLayout()}},focus:function(){if(this._valueInput){BX.focus(this._valueInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._valueInput)}},layout:function(){if(this._hasLayout){return}this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;this._deleteButton=null;var t=this.getValueTypeId();var e=this.getValue();this._wrapper=BX.create("div");this._container.appendChild(this._wrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double");this._valueInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:this.prepareControlName("VALUE"),type:"text",value:e}});BX.bind(this._valueInput,"input",BX.delegate(this.onValueChange,this));this._wrapper.appendChild(this._valueInput);this._valueTypeInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE_TYPE"),type:"hidden",value:t}});this._wrapper.appendChild(this._valueTypeInput);this._valueTypeSelector=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:this.resolveValueTypeName(t),events:{click:BX.delegate(this.onValueTypeSelectorClick,this)}});this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-select"},children:[this._valueTypeSelector]}));this._deleteButton=BX.create("div",{attrs:{className:"crm-entity-widget-content-remove-block"}});this._wrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);if(this._editor.isDuplicateControlEnabled()){var i=this._parent.getDuplicateControlConfig();if(i){if(!BX.type.isPlainObject(i["field"])){i["field"]={}}i["field"]["id"]=this.getValueId();i["field"]["element"]=this._valueInput;this._editor.getDuplicateManager().registerField(i)}}}else if(this._mode===BX.Crm.EntityEditorMode.view&&!this.isEmpty()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-mutlifield");var n=this.getViewData();var r=BX.prop.getString(n,"value","");if(r===""){r=BX.util.htmlspecialchars(e)}this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-type"},text:this.resolveValueTypeName(t)}));var o=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-value"},html:r});this._wrapper.appendChild(o);if(this._parent.getMultifieldType()==="EMAIL"){var s=o.querySelector("a.crm-entity-email");if(s){BX.bind(s,"click",BX.delegate(this.onEmailClick,this))}}}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._editor.isDuplicateControlEnabled()){var t=this._parent.getDuplicateControlConfig();if(t){if(!BX.type.isPlainObject(t["field"])){t["field"]={}}t["field"]["id"]=this.getValueId();this._editor.getDuplicateManager().unregisterField(t)}}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},adjust:function(){if(this._hasLayout){this._wrapper.style.display=this._isJunked?"none":""}},onValueChange:function(t){this._parent.processItemChange(this)},onValueTypeSelectorClick:function(t){var e=[];for(var i=0,n=this._valueTypeItems.length;i<n;i++){var r=this._valueTypeItems[i];e.push({text:r["NAME"],value:r["VALUE"],onclick:BX.delegate(this.onValueTypeSelect,this)})}BX.addClass(this._valueTypeSelector,"active");BX.PopupMenu.destroy(this._id);BX.PopupMenu.show(this._id,this._valueTypeSelector,e,{angle:false,width:this._valueTypeSelector.offsetWidth+"px",events:{onPopupClose:BX.delegate(this.onValueTypeMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._valueTypeSelector)["width"])},onValueTypeMenuClose:function(t){BX.removeClass(this._valueTypeSelector,"active")},onValueTypeSelect:function(t,e){BX.removeClass(this._valueTypeSelector,"active");this._valueTypeInput.value=e.value;this._valueTypeSelector.innerHTML=BX.util.htmlspecialchars(e.text);this._parent.processItemChange(this);BX.PopupMenu.destroy(this._id)},isJunked:function(){return this._isJunked},markAsJunked:function(t){t=!!t;if(this._isJunked!==t){this._isJunked=t;if(this._isJunked){this._valueInput.value=""}this.adjust()}},onEmailClick:function(t){if(BX.CrmActivityEditor){var e=this._editor.getOwnerInfo();var i={ownerType:e["ownerType"],ownerID:e["ownerID"],communications:[{entityType:e["ownerType"],entityId:e["ownerID"],type:"EMAIL",value:this.getValue()}]};BX.CrmActivityEditor.addEmail(i)}return BX.PreventDefault(t)},onDeleteButtonClick:function(t){this._parent.processItemDeletion(this)}};BX.Crm.EntityEditorMultifieldItem.create=function(t,e){var i=new BX.Crm.EntityEditorMultifieldItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifieldItemPhone==="undefined"){BX.Crm.EntityEditorMultifieldItemPhone=function(){BX.Crm.EntityEditorMultifieldItemPhone.superclass.constructor.apply(this);this._maskedPhone=null;this._maskedValueInput=null;this._countryFlagNode=null};BX.extend(BX.Crm.EntityEditorMultifieldItemPhone,BX.Crm.EntityEditorMultifieldItem);BX.Crm.EntityEditorMultifieldItemPhone.prototype.layout=function(){var t=this;if(this._hasLayout){return}this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;var e=this.getValueTypeId();var i=this.getValue();this._wrapper=BX.create("div");this._container.appendChild(this._wrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double");this._valueInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE"),type:"hidden",value:i}});this._wrapper.appendChild(this._valueInput);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-input-phone-wrapper"},children:[this._countryFlagNode=BX.create("span",{props:{className:"crm-entity-widget-content-country-flag"}}),this._maskedValueInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input crm-entity-widget-content-input-phone",type:"text",value:i}})]}));this._maskedPhone=new BX.PhoneNumber.Input({node:this._maskedValueInput,flagNode:this._countryFlagNode,flagSize:24,onChange:function(e){t._valueInput.value=e.value;t.onValueChange()}});this._valueTypeInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE_TYPE"),type:"hidden",value:e}});this._wrapper.appendChild(this._valueTypeInput);this._valueTypeSelector=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:this.resolveValueTypeName(e),events:{click:BX.delegate(this.onValueTypeSelectorClick,this)}});this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-select"},children:[this._valueTypeSelector]}));this._deleteButton=BX.create("div",{attrs:{className:"crm-entity-widget-content-remove-block"}});this._wrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);if(this._editor.isDuplicateControlEnabled()){var n=this._parent.getDuplicateControlConfig();if(n){if(!BX.type.isPlainObject(n["field"])){n["field"]={}}n["field"]["id"]=this.getValueId();n["field"]["element"]=this._maskedValueInput;this._editor.getDuplicateManager().registerField(n)}}}else if(this._mode===BX.Crm.EntityEditorMode.view&&!this.isEmpty()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-mutlifield");var r=this.getViewData();var o=BX.prop.getString(r,"value","");if(o===""){o=BX.util.htmlspecialchars(i)}this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-type"},text:this.resolveValueTypeName(e)}));this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-value"},html:o}))}this._hasLayout=true};BX.Crm.EntityEditorMultifieldItemPhone.prototype.focus=function(){if(this._maskedValueInput){BX.focus(this._maskedValueInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._maskedValueInput)}};BX.Crm.EntityEditorMultifieldItemPhone.create=function(t,e){var i=new BX.Crm.EntityEditorMultifieldItemPhone;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifield==="undefined"){BX.Crm.EntityEditorMultifield=function(){BX.Crm.EntityEditorMultifield.superclass.constructor.apply(this);this._items=null;this._itemWrapper=null};BX.extend(BX.Crm.EntityEditorMultifield,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMultifield.prototype.doInitialize=function(){this.initializeItems()};BX.Crm.EntityEditorMultifield.prototype.initializeItems=function(){var t=this.getName();var e=this._model.getField(t,[]);if(e.length===0){e.push({ID:"n0"})}for(var i=0,n=e.length;i<n;i++){this.addItem(e[i])}};BX.Crm.EntityEditorMultifield.prototype.findItemIndex=function(t){if(!this._items){return-1}for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorMultifield.prototype.resetItems=function(){if(this._hasLayout){for(var t=0,e=this._items.length;t<e;t++){this._items[t].clearLayout()}}this._items=[]};BX.Crm.EntityEditorMultifield.prototype.deleteItem=function(t){if(!this._items){return}var e=this.findItemIndex(t);if(e>=0){this._items[e].markAsJunked(true)}};BX.Crm.EntityEditorMultifield.prototype.reset=function(){this.resetItems();this.initializeItems()};BX.Crm.EntityEditorMultifield.prototype.hasContentToDisplay=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){return true}var t=this._items.length;if(t===0){return false}for(var e=0;e<t;e++){if(!this._items[e].isEmpty()){return true}}return false};BX.Crm.EntityEditorMultifield.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMultifield.prototype.getContentWrapper=function(){return this._itemWrapper};BX.Crm.EntityEditorMultifield.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorMultifield.prototype.prepareItemsLayout=function(){for(var t=0,e=this._items.length;t<e;t++){var i=this._items[t];i.setMode(this._mode);i.setContainer(this._itemWrapper);i.layout()}};BX.Crm.EntityEditorMultifield.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMultifield.prototype.getContentWrapper=function(){return this._itemWrapper};BX.Crm.EntityEditorMultifield.prototype.focus=function(){if(this._items&&this._items.length>0){this._items[this._items.length-1].focus()}};BX.Crm.EntityEditorMultifield.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-multifield"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}this._itemWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._itemWrapper);if(this.hasContentToDisplay()){this.prepareItemsLayout()}else if(this._mode===BX.Crm.EntityEditorMode.view){this._itemWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-add-field"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-add-field"},text:this.getMessage("add"),events:{click:BX.delegate(this.onAddButtonClick,this)}})]}))}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMultifield.prototype.doClearLayout=function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];n.clearLayout();n.setContainer(null)}this._itemWrapper=null};BX.Crm.EntityEditorMultifield.prototype.refreshLayout=function(t){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMoney.superclass.refreshLayout.apply(this,arguments);return}this.resetItems();this.initializeItems();this.prepareItemsLayout()};BX.Crm.EntityEditorMultifield.prototype.getMultifieldType=function(){return this._schemeElement.getDataStringParam("type","")};BX.Crm.EntityEditorMultifield.prototype.addItem=function(t){var e;var i=this._schemeElement.getName();if(i==="PHONE"){e=BX.Crm.EntityEditorMultifieldItemPhone.create("",{parent:this,typeId:this._schemeElement.getName(),valueTypeItems:this._schemeElement.getDataArrayParam("items",[]),data:t})}else{e=BX.Crm.EntityEditorMultifieldItem.create("",{parent:this,typeId:this._schemeElement.getName(),valueTypeItems:this._schemeElement.getDataArrayParam("items",[]),data:t})}if(this._items===null){this._items=[]}this._items.push(e);if(this._hasLayout){e.setMode(this._mode);e.setContainer(this._itemWrapper);e.layout()}return e};BX.Crm.EntityEditorMultifield.prototype.onAddButtonClick=function(t){this.addItem({ID:"n"+this._items.length.toString()})};BX.Crm.EntityEditorMultifield.prototype.processItemChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorMultifield.prototype.processItemDeletion=function(t){this.deleteItem(t);this.markAsChanged()};BX.Crm.EntityEditorMultifield.create=function(t,e){var i=new BX.Crm.EntityEditorMultifield;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClientSearchBox==="undefined"){BX.Crm.EntityEditorClientSearchBox=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._deleteButton=null;this._resetButton=null;this._parentField=null;this._entityInfo=null;this._entityTypeName="";this._searchInput=null;this._searchControl=null;this._loaderConfig=null;this._changeNotifier=null;this._resetNotifier=null;this._deletionNotifier=null;this._enableDeletion=true;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._resetButtonHandler=BX.delegate(this.onResetButtonClick,this);this._inputFocusHandler=BX.delegate(this.onInputFocus,this);this._inputBlurHandler=BX.delegate(this.onInputBlur,this);this._maskedPhone=null;this._hasFocus=false;this._hasLayout=false};BX.Crm.EntityEditorClientSearchBox.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._parentField=BX.prop.get(this._settings,"parentField",null);this._container=BX.prop.getElementNode(this._settings,"container",null);var i=BX.prop.get(this._settings,"entityInfo",null);if(i){this._entityInfo=i;this._entityTypeName=i.getTypeName()}else{this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","")}this._enableDeletion=BX.prop.getBoolean(this._settings,"enableDeletion",true);this._loaderConfig=BX.prop.get(this._settings,"loaderConfig",null);this._changeNotifier=BX.CrmNotifier.create(this);this._deletionNotifier=BX.CrmNotifier.create(this);this._resetNotifier=BX.CrmNotifier.create(this)},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityEditorClientSearchBox.messages,t)},setEntityTypeName:function(t){if(this._entityTypeName!==t){this._entityTypeName=t}},setEntity:function(t,e){var i=this._entityInfo;this._entityInfo=t;if(t){this._entityTypeName=t.getTypeName()}this.adjust();if(e){this._changeNotifier.notify([this._entityInfo,i])}},hasEntity:function(){return!!this._entityInfo},isNewEntity:function(){return this._entityInfo&&this._entityInfo.getId()===0},layout:function(t){if(this._hasLayout){return}if(!BX.type.isPlainObject(t)){t={}}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-search-row"}});this.innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-search-inner"}});var e=BX.prop.getElementNode(t,"anchor",null);if(e){this._container.insertBefore(this._wrapper,e)}else{this._container.appendChild(this._wrapper)}this._wrapper.appendChild(this.innerWrapper);var i=BX.create("div",{props:{className:"crm-entity-widget-content-search-box"}});this.innerWrapper.appendChild(i);var n=BX.create("div",{props:{className:"crm-entity-widget-img-box"}});if(this._entityTypeName===BX.CrmEntityType.names.company){BX.addClass(n,"crm-entity-widget-img-company")}else if(this._entityTypeName===BX.CrmEntityType.names.contact){BX.addClass(n,"crm-entity-widget-img-contact")}i.appendChild(n);this._searchInput=BX.create("input",{props:{type:"text",placeholder:BX.prop.getString(this._settings,"placeholder",""),className:"crm-entity-widget-content-input crm-entity-widget-content-search-input",autocomplete:"nope"}});i.appendChild(this._searchInput);BX.bind(this._searchInput,"focus",this._inputFocusHandler);BX.bind(this._searchInput,"blur",this._inputBlurHandler);if(this._entityTypeName!==""){i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-btn-new"},text:this.getMessage(this._entityTypeName.toLowerCase()+"ToCreateTag")}))}this._resetButton=BX.create("div",{props:{className:"crm-entity-widget-btn-close"}});i.appendChild(this._resetButton);BX.bind(this._resetButton,"click",this._resetButtonHandler);if(this._entityInfo){this._searchInput.value=this._entityInfo.getTitle()}this._searchControl=new BX.UI.Dropdown({searchAction:"crm.api.entity.search",searchOptions:{types:[this._entityTypeName],scope:"index"},searchResultRenderer:null,targetElement:this._searchInput,items:BX.prop.getArray(this._settings,"lastEntityInfos",[]),enableCreation:BX.prop.getBoolean(this._settings,"enableCreation",false),messages:{creationLegend:this.getMessage(this._entityTypeName.toLowerCase()+"ToCreateLegend"),notFound:this.getMessage("notFound")},events:{onSelect:this.onEntitySelect.bind(this),onAdd:this.onEntityAdd.bind(this),onReset:this.onEntityReset.bind(this)}});this._deleteButton=BX.create("div",{props:{className:"crm-entity-widget-btn-close"}});if(!this._enableDeletion){this._deleteButton.style.display="none"}this.innerWrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);this.adjust();this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}BX.unbind(this._deleteButton,"click",this._deleteButtonHandler);this._deleteButton=null;this._searchControl=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},prepareMultifieldLayout:function(){if(!this._multifieldContainer){this._multifieldContainer=BX.create("div",{props:{className:"crm-entity-widget-content-multifield"}});this._wrapper.appendChild(this._multifieldContainer);this._phoneInput=BX.create("input",{props:{type:"hidden"}});this._countryFlagNode=BX.create("span",{props:{className:"crm-entity-widget-content-country-flag"}});this._maskedPhoneInput=BX.create("input",{props:{type:"text",placeholder:BX.message("CRM_EDITOR_PHONE"),className:"crm-entity-widget-content-input crm-entity-widget-content-input-phone",autocomplete:"nope"}});this._multifieldContainer.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-multifield-item"},children:[this._countryFlagNode,this._maskedPhoneInput,this._phoneInput]}));this._maskedPhone=new BX.PhoneNumber.Input({node:this._maskedPhoneInput,flagNode:this._countryFlagNode,flagSize:24,onChange:BX.delegate(this.onPhoneChange,this)});this._emailInput=BX.create("input",{props:{type:"text",placeholder:BX.message("CRM_EDITOR_EMAIL"),className:"crm-entity-widget-content-input",autocomplete:"nope"}});this._multifieldContainer.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-multifield-item"},children:[this._emailInput]}))}if(this._entityInfo){var t=this._entityInfo.getPhones();if(t.length>0){this._maskedPhone.setValue(BX.prop.getString(t[0],"VALUE_FORMATTED",""))}var e=this._entityInfo.getEmails();if(e.length>0){this._emailInput.value=BX.prop.getString(e[0],"VALUE_FORMATTED","")}}},clearMultifieldLayout:function(){if(this._multifieldContainer){this._multifieldContainer=BX.remove(this._multifieldContainer)}},save:function(){if(!this._entityInfo){return}if(this._searchInput&&this._searchInput.value!==this._entityInfo.getTitle()){this._entityInfo.setTitle(this._searchInput.value)}var t=[];if(this._phoneInput){t.push({TYPE_ID:"PHONE",VALUE:this._phoneInput.value})}if(this._emailInput){t.push({TYPE_ID:"EMAIL",VALUE:this._emailInput.value})}this._entityInfo.setMultifields(t)},focus:function(){if(this._searchInput){this._searchInput.focus()}},hasValue:function(){return!!this._entityInfo},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},addDeletionListener:function(t){this._deletionNotifier.addListener(t)},removeDeletionListener:function(t){this._deletionNotifier.removeListener(t)},addResetListener:function(t){this._resetNotifier.addListener(t)},removeResetListener:function(t){this._resetNotifier.removeListener(t)},enableDeletion:function(t){t=!!t;if(this._enableDeletion===t){return}this._enableDeletion=t;if(this._hasLayout){this._deleteButton.style.display=t?"":"none"}},adjust:function(){if(!this._hasLayout){return}if(this._hasFocus){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-complete");BX.addClass(this._wrapper,"crm-entity-widget-content-block-inprogress")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-inprogress");BX.addClass(this._wrapper,"crm-entity-widget-content-block-complete")}if(this.hasEntity()){if(!this.isNewEntity()){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-new");if(this._searchInput.value.length<0){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-textreset")}else{BX.addClass(this._wrapper,"crm-entity-widget-content-block-textreset")}this.clearMultifieldLayout();if(this._searchControl){this._searchControl.isDisabled=false}}else{BX.addClass(this._wrapper,"crm-entity-widget-content-block-new");if(this._searchInput.value.length>0){BX.addClass(this._wrapper,"crm-entity-widget-content-block-textreset")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-textreset")}this.prepareMultifieldLayout();if(this._searchControl){this._searchControl.isDisabled=true}}}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-new");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-textreset");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-complete");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-inprogress");this.clearMultifieldLayout();if(this._searchControl){this._searchControl.isDisabled=false}}},onPhoneChange:function(t){if(this._phoneInput){this._phoneInput.value=t.value}},onDeleteButtonClick:function(t){if(this._enableDeletion){this._deletionNotifier.notify([this._entityInfo])}},onResetButtonClick:function(t){this.reset()},onInputFocus:function(t){this._hasFocus=true;window.setTimeout(BX.delegate(this.adjust,this),150)},onInputBlur:function(t){this._hasFocus=false;window.setTimeout(BX.delegate(this.adjust,this),300)},onEntityAdd:function(t,e){var i=BX.prop.getString(e,"title","");if(i===""){return}var n={typeName:this._entityTypeName,title:i};if(BX.validation.checkIfEmail(i)){n["title"]=this.getMessage(this._entityTypeName===BX.CrmEntityType.names.contact?"unnamed":"untitled");n["advancedInfo"]={multiFields:[{TYPE_ID:"EMAIL",VALUE:i}]}}else if(BX.validation.checkIfPhone(i)){n["title"]=this.getMessage(this._entityTypeName===BX.CrmEntityType.names.contact?"unnamed":"untitled");n["advancedInfo"]={multiFields:[{TYPE_ID:"PHONE",VALUE:i}]}}if(this._searchInput.value!==n["title"]){this._searchInput.value=n["title"]}this.setEntity(BX.CrmEntityInfo.create(n),true);this._searchControl.destroyPopupWindow()},onEntityReset:function(){this.reset();this._searchControl.destroyPopupWindow()},onEntitySelect:function(t,e){var i=BX.prop.getString(e,"entityType","");var n=BX.prop.getInteger(e,"entityId",0);var r=BX.prop.getString(e,"title","");this.setEntityTypeName(i);if(n<=0){return}this.loadEntityInfo(n);this._searchInput.value=r;this._searchControl.destroyPopupWindow()},onEntityInfoLoad:function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(i){this.setEntity(BX.CrmEntityInfo.create(i),true)}},reset:function(){this._searchInput.value="";var t=this._entityInfo;this._entityInfo=null;this._resetNotifier.notify([t]);window.setTimeout(BX.delegate(this.adjust,this),150)},loadEntityInfo:function(t){var e=BX.prop.getObject(this._loaderConfig,this._entityTypeName,null);if(!e){return}BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t}}).load(BX.delegate(this.onEntityInfoLoad,this))}};if(typeof BX.Crm.EntityEditorClientSearchBox.messages==="undefined"){BX.Crm.EntityEditorClientSearchBox.messages={}}BX.Crm.EntityEditorClientSearchBox.create=function(t,e){var i=new BX.Crm.EntityEditorClientSearchBox;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClientLayoutType==="undefined"){BX.Crm.EntityEditorClientLayoutType={undefined:0,contactCompany:1,companyContact:2,contact:3,company:4}}if(typeof BX.Crm.EntityEditorClientLight==="undefined"){BX.Crm.EntityEditorClientLight=function(){BX.Crm.EntityEditorClientLight.superclass.constructor.apply(this);this._map=null;this._info=null;this._primaryLoaderConfig=null;this._secondaryLoaderConfig=null;this._dataElements=null;this._companyInfo=null;this._contactInfos=null;this._companySearchBox=null;this._contactSearchBoxes=null;this._companyPanel=null;this._contactPanels=null;this._contactWrapper=null;this._addContactButton=null;this._innerWrapper=null;this._layoutType=BX.Crm.EntityEditorClientLayoutType.undefined;this._companyChangeHandler=BX.delegate(this.onCompanyChange,this);this._companyResetHandler=BX.delegate(this.onCompanyReset,this);this._contactChangeHandler=BX.delegate(this.onContactChange,this);this._contactDeletionHandler=BX.delegate(this.onContactDelete,this);this._contactResetHandler=BX.delegate(this.onContactReset,this);this._requisiteChangeHandler=BX.delegate(this.onRequisiteChange,this)};BX.extend(BX.Crm.EntityEditorClientLight,BX.Crm.EntityEditorField);BX.Crm.EntityEditorClientLight.prototype.doInitialize=function(){BX.Crm.EntityEditorClientLight.superclass.doInitialize.apply(this);this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeFromModel()};BX.Crm.EntityEditorClientLight.prototype.initializeFromModel=function(){this._info=this._model.getSchemeField(this._schemeElement,"info",{});var t=BX.prop.getObject(this._info,"COMPANY_DATA",null);var e=t?BX.CrmEntityInfo.create(t):null;if(e){this.setCompany(e)}this._contactInfos=BX.Collection.create();var i=BX.prop.getArray(this._info,"CONTACT_DATA",[]);for(var n=0,r=i.length;n<r;n++){var o=BX.CrmEntityInfo.create(i[n]);if(o.getId()>0){this._contactInfos.add(o)}}var s=this._schemeElement.getDataObjectParam("loaders",{});this._primaryLoaderConfig=BX.prop.getObject(s,"primary",{});this._secondaryLoaderConfig=BX.prop.getObject(s,"secondary",{})};BX.Crm.EntityEditorClientLight.prototype.createDataElement=function(t,e){var i=BX.prop.getString(this._map,t,"");if(i===""){return}var n=BX.create("input",{attrs:{name:i,type:"hidden"}});if(BX.type.isNotEmptyString(e)){n.value=e}if(!this._dataElements){this._dataElements={}}this._dataElements[t]=n;if(this._wrapper){this._wrapper.appendChild(n)}};BX.Crm.EntityEditorClientLight.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorClientLight.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorClientLight.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorClientLight.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorClientLight.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorClientLight.prototype.getCompanyId=function(){return this._companyInfo?this._companyInfo.getId():0};BX.Crm.EntityEditorClientLight.prototype.setCompany=function(t){if(!(t instanceof BX.CrmEntityInfo)){this._companyInfo=null;return}this._companyInfo=t};BX.Crm.EntityEditorClientLight.prototype.addContact=function(t){if(t instanceof BX.CrmEntityInfo){this._contactInfos.add(t)}};BX.Crm.EntityEditorClientLight.prototype.removeContact=function(t){if(t instanceof BX.CrmEntityInfo){this._contactInfos.remove(t)}};BX.Crm.EntityEditorClientLight.prototype.setContacts=function(t){this._contactInfos.removeAll();for(var e=0,i=t.length;e<i;e++){var n=t[e];if(n instanceof BX.CrmEntityInfo){this._contactInfos.add(n)}}};BX.Crm.EntityEditorClientLight.prototype.hasContentToDisplay=function(){return this._companyInfo!==null||this._contactInfos!==null&&this._contactInfos.length()>0};BX.Crm.EntityEditorClientLight.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorClientLight.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorClientLight.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorClientLight.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorClientLight.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorClientLight.prototype.doPrepareContextMenuItems=function(t){t.push({delimiter:true});var e=this.getLayoutType();if(e===BX.Crm.EntityEditorClientLayoutType.companyContact||e===BX.Crm.EntityEditorClientLayoutType.contactCompany){t.push({value:"set_layout_contact",text:this.getMessage("disableCompany")});t.push({value:"set_layout_company",text:this.getMessage("disableContact")})}else if(e===BX.Crm.EntityEditorClientLayoutType.company){t.push({value:"set_layout_company_contact",text:this.getMessage("enableContact")})}else if(e===BX.Crm.EntityEditorClientLayoutType.contact){t.push({value:"set_layout_contact_company",text:this.getMessage("enableCompany")})}if(e===BX.Crm.EntityEditorClientLayoutType.companyContact){t.push({delimiter:true});t.push({value:"set_layout_contact_company",text:this.getMessage("displayContactAtFirst")})}else if(e===BX.Crm.EntityEditorClientLayoutType.contactCompany){t.push({delimiter:true});t.push({value:"set_layout_company_contact",text:this.getMessage("displayCompanyAtFirst")})}};BX.Crm.EntityEditorClientLight.prototype.processContextMenuCommand=function(t,e){if(e==="set_layout_contact_company"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.contactCompany)}.bind(this),100)}else if(e==="set_layout_company_contact"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.companyContact)}.bind(this),100)}else if(e==="set_layout_contact"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.contact)}.bind(this),100)}else if(e==="set_layout_company"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.company)}.bind(this),100)}BX.Crm.EntityEditorClientLight.superclass.processContextMenuCommand.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.isCompanyEnabled=function(){var t=this.getLayoutType();return t===BX.Crm.EntityEditorClientLayoutType.contactCompany||t===BX.Crm.EntityEditorClientLayoutType.companyContact||t===BX.Crm.EntityEditorClientLayoutType.company};BX.Crm.EntityEditorClientLight.prototype.isContactEnabled=function(){var t=this.getLayoutType();return t===BX.Crm.EntityEditorClientLayoutType.contactCompany||t===BX.Crm.EntityEditorClientLayoutType.companyContact||t===BX.Crm.EntityEditorClientLayoutType.contact};BX.Crm.EntityEditorClientLight.prototype.getLayoutType=function(){if(this._layoutType<=0){var t=this._editor.getConfigOption("client_layout","");var e=parseInt(t);if(isNaN(e)||e<=0){e=BX.Crm.EntityEditorClientLayoutType.companyContact}this._layoutType=e}return this._layoutType};BX.Crm.EntityEditorClientLight.prototype.setLayoutType=function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<=0){return}if(t===this._layoutType){return}this._layoutType=t;this._editor.setConfigOption("client_layout",t);this.refreshLayout()};BX.Crm.EntityEditorClientLight.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(!this.hasContentToDisplay()&&this.isInViewMode()){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-inner"},text:this.getMessage("isEmpty")});this._wrapper.appendChild(this._innerWrapper)}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);var e=this.getLayoutType();if(this.isInEditMode()){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"}});this._innerWrapper.appendChild(i);this._innerContainer=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container-inner"}});i.appendChild(this._innerContainer)}else{BX.addClass(this._wrapper,"crm-entity-widget-participants-block");BX.addClass(this._innerWrapper,"crm-entity-widget-inner")}if(this.isContactEnabled()&&this.isCompanyEnabled()){if(e===BX.Crm.EntityEditorClientLayoutType.contactCompany){this.renderContact();this.renderCompany()}else if(e===BX.Crm.EntityEditorClientLayoutType.companyContact){this.renderCompany();this.renderContact()}}else{if(this.isContactEnabled()){this.renderContact()}if(this.isCompanyEnabled()){this.renderCompany()}}}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorClientLight.prototype.renderContact=function(){if(this.isInEditMode()){this._contactWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-inner-row"}});this._innerContainer.appendChild(this._contactWrapper);this._contactWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.contact)})]}));this._addContactButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-add"},text:this.getMessage("addParticipant")});this._contactWrapper.appendChild(this._addContactButton);BX.bind(this._addContactButton,"click",BX.delegate(this.onContactAddButtonClick,this));this._contactSearchBoxes=[];if(this._contactInfos.length()>0){for(var t=0,e=this._contactInfos.length();t<e;t++){this.addContactSearchBox(this.createContactSearchBox({entityInfo:this._contactInfos.get(t)}))}}else{this.addContactSearchBox(this.createContactSearchBox())}}else if(this._contactInfos.length()>0&&this.isContactEnabled()){this._contactPanels=[];this._innerWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.contact)})]}));for(t=0,e=this._contactInfos.length();t<e;t++){var i=this._contactInfos.get(t);var n={editor:this,entityInfo:i,enableEntityTypeCaption:false,enableRequisite:false,mode:BX.Crm.EntityEditorMode.view};var r=t===0&&!(this._companyInfo&&this.isCompanyEnabled());if(r){n["enableRequisite"]=true;n["requisiteBinding"]=this._model.getField("REQUISITE_BINDING",{});n["requisiteSelectUrl"]=this._editor.getEntityRequisiteSelectUrl(BX.CrmEntityType.names.contact,i.getId());n["requisiteMode"]=BX.Crm.EntityEditorMode.edit}var o=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+i.getId().toString(),n);this._contactPanels.push(o);o.setContainer(this._innerWrapper);o.layout();if(r){o.addRequisiteChangeListener(this._requisiteChangeHandler)}}}};BX.Crm.EntityEditorClientLight.prototype.renderCompany=function(){if(this.isInEditMode()){this._companyWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-inner-row"}});this._innerContainer.appendChild(this._companyWrapper);this._companyWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.company)})]}));this._companySearchBox=this.createCompanySearchBox({entityInfo:this._companyInfo});this._companySearchBox.addResetListener(this._companyResetHandler);this._companySearchBox.addChangeListener(this._companyChangeHandler);this._companySearchBox.layout()}else if(this._companyInfo&&this.isCompanyEnabled()){this._innerWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.company)})]}));this._companyPanel=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._companyInfo.getId().toString(),{editor:this,entityInfo:this._companyInfo,enableEntityTypeCaption:false,enableRequisite:true,requisiteBinding:this._model.getField("REQUISITE_BINDING",{}),requisiteSelectUrl:this._editor.getEntityRequisiteSelectUrl(BX.CrmEntityType.names.company,this._companyInfo.getId()),requisiteMode:BX.Crm.EntityEditorMode.edit,mode:BX.Crm.EntityEditorMode.view});this._companyPanel.setContainer(this._innerWrapper);this._companyPanel.layout();this._companyPanel.addRequisiteChangeListener(this._requisiteChangeHandler)}};BX.Crm.EntityEditorClientLight.prototype.createCompanySearchBox=function(t){var e=BX.prop.get(t,"entityInfo",null);if(e!==null&&!(e instanceof BX.CrmEntityInfo)){e=null}var i=this._editor.canCreateCompany();if(i){i=BX.prop.getBoolean(this._schemeElement.getDataObjectParam("creation",{}),BX.CrmEntityType.names.company.toLowerCase(),true)}return BX.Crm.EntityEditorClientSearchBox.create(this._id,{entityTypeName:BX.CrmEntityType.names.company,entityInfo:e,enableCreation:i,loaderConfig:this._primaryLoaderConfig,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastCompanyInfos",[]),container:this._companyWrapper,enableDeletion:false,placeholder:this.getMessage("companySearchPlaceholder"),parentField:this})};BX.Crm.EntityEditorClientLight.prototype.createContactSearchBox=function(t){var e=BX.prop.get(t,"entityInfo",null);if(e!==null&&!(e instanceof BX.CrmEntityInfo)){e=null}var i=this._editor.canCreateContact();if(i){i=BX.prop.getBoolean(this._schemeElement.getDataObjectParam("creation",{}),BX.CrmEntityType.names.contact.toLowerCase(),true)}return BX.Crm.EntityEditorClientSearchBox.create(this._id,{entityTypeName:BX.CrmEntityType.names.contact,entityInfo:e,enableCreation:i,loaderConfig:this._primaryLoaderConfig,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastContactInfos",[]),container:this._contactWrapper,enableDeletion:BX.prop.getBoolean(t,"enableDeletion",true),placeholder:this.getMessage("contactSearchPlaceholder"),parentField:this})};BX.Crm.EntityEditorClientLight.prototype.addContactSearchBox=function(t){this._contactSearchBoxes.push(t);var e={};if(this._addContactButton){e["anchor"]=this._addContactButton}t.layout(e);t.addResetListener(this._contactResetHandler);t.addChangeListener(this._contactChangeHandler);t.addDeletionListener(this._contactDeletionHandler);var i=this._contactSearchBoxes.length>1;for(var n=0,r=this._contactSearchBoxes.length;n<r;n++){this._contactSearchBoxes[n].enableDeletion(i)}return t};BX.Crm.EntityEditorClientLight.prototype.removeContactSearchBox=function(t){var e=this.findContactSearchBoxIndex(t);if(e<0){return}t.removeResetListener(this._contactResetHandler);t.removeChangeListener(this._contactChangeHandler);t.removeDeletionListener(this._contactDeletionHandler);t.clearLayout();this._contactSearchBoxes.splice(e,1);var i=this._contactSearchBoxes.length>1;for(var n=0,r=this._contactSearchBoxes.length;n<r;n++){this._contactSearchBoxes[n].enableDeletion(i)}};BX.Crm.EntityEditorClientLight.prototype.removeContactAllSearchBoxes=function(){for(var t=0,e=this._contactSearchBoxes.length;t<e;t++){var i=this._contactSearchBoxes[t];i.removeResetListener(this._contactResetHandler);i.removeChangeListener(this._contactChangeHandler);i.removeDeletionListener(this._contactDeletionHandler);i.clearLayout()}this._contactSearchBoxes=[]};BX.Crm.EntityEditorClientLight.prototype.findContactSearchBoxIndex=function(t){for(var e=0,i=this._contactSearchBoxes.length;e<i;e++){if(t===this._contactSearchBoxes[e]){return e}}return-1};BX.Crm.EntityEditorClientLight.prototype.save=function(){if(this._companySearchBox!==null&&this._companySearchBox.isNewEntity()){this._companySearchBox.save()}this._model.setMappedField(this._map,"companyId",this._companyInfo?this._companyInfo.getId():0);if(this._companyInfo){this._info["COMPANY_DATA"]=this._companyInfo.getSettings()}else{delete this._info["COMPANY_DATA"]}var t=[];var e=[];var i,n;if(this._contactSearchBoxes!==null){for(i=0,n=this._contactSearchBoxes.length;i<n;i++){if(this._contactSearchBoxes[i].isNewEntity()){this._contactSearchBoxes[i].save()}}}if(this._contactInfos!==null){var r=this._contactInfos.getItems();for(i=0,n=r.length;i<n;i++){var o=r[i];t.push(o.getSettings());e.push(o.getId())}}this._model.setMappedField(this._map,"contactIds",e.join(","));this._info["CONTACT_DATA"]=t};BX.Crm.EntityEditorClientLight.prototype.onContactAddButtonClick=function(t){this.addContactSearchBox(this.createContactSearchBox()).focus()};BX.Crm.EntityEditorClientLight.prototype.onCompanyReset=function(t,e){this._companyInfo=null;this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.onCompanyChange=function(t,e,i){if(!(e instanceof BX.CrmEntityInfo)){return}this.setCompany(e);if(e.getId()>0){var n=BX.prop.getObject(this._secondaryLoaderConfig,BX.CrmEntityType.names.company,null);if(n){BX.CrmDataLoader.create(this._id,{serviceUrl:n["url"],action:n["action"],params:{PRIMARY_TYPE_NAME:BX.CrmEntityType.names.company,PRIMARY_ID:this._companyInfo.getId(),SECONDARY_TYPE_NAME:BX.CrmEntityType.names.contact,OWNER_TYPE_NAME:this.getOwnerTypeName()}}).load(BX.delegate(this.onContactInfosLoad,this))}}this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.onContactChange=function(t,e,i){var n=false;if(i){this.removeContact(i);n=true}if(e){this.addContact(e);n=true}if(n){this.markAsChanged()}};BX.Crm.EntityEditorClientLight.prototype.onContactDelete=function(t,e){if(e){this._contactInfos.remove(e);this.markAsChanged()}this.removeContactSearchBox(t)};BX.Crm.EntityEditorClientLight.prototype.onContactReset=function(t,e){if(e){this._contactInfos.remove(e);this.markAsChanged()}};BX.Crm.EntityEditorClientLight.prototype.onContactInfosLoad=function(t,e){var i=BX.type.isArray(e["ENTITY_INFOS"])?e["ENTITY_INFOS"]:[];var n=[];var r,o;for(r=0,o=i.length;r<o;r++){n.push(BX.CrmEntityInfo.create(i[r]))}this.setContacts(n);this.markAsChanged();this.removeContactAllSearchBoxes();if(n.length>0){for(r=0,o=n.length;r<o;r++){this.addContactSearchBox(this.createContactSearchBox({entityInfo:n[r]}))}}else{this.addContactSearchBox(this.createContactSearchBox())}};BX.Crm.EntityEditorClientLight.prototype.onRequisiteChange=function(t,e){if(this.isInEditMode()){this.markAsChanged()}else{this._editor.saveData({REQUISITE_ID:BX.prop.getInteger(e,"requisiteId",0),BANK_DETAIL_ID:BX.prop.getInteger(e,"bankDetailId",0)})}};BX.Crm.EntityEditorClientLight.prototype.onBeforeSubmit=function(){var t={};if(this.isCompanyEnabled()){if(this._companyInfo!==null){if(this._companyInfo.isNew()){t["COMPANY_DATA"]={title:this._companyInfo.getTitle(),multifields:this._companyInfo.getMultifields()}}else{t["COMPANY_DATA"]={id:this._companyInfo.getId()}}}else{t["COMPANY_DATA"]={}}}if(this.isContactEnabled()){t["CONTACT_DATA"]=[];if(this._contactInfos!==null){var e=this._contactInfos.getItems();for(var i=0,n=e.length;i<n;i++){if(e[i].isNew()){t["CONTACT_DATA"].push({title:e[i].getTitle(),multifields:e[i].getMultifields()})}else{t["CONTACT_DATA"].push({id:e[i].getId()})}}}}this.createDataElement("data",JSON.stringify(t))};if(typeof BX.Crm.EntityEditorClientLight.messages==="undefined"){BX.Crm.EntityEditorClientLight.messages={}}BX.Crm.EntityEditorClientLight.create=function(t,e){var i=new BX.Crm.EntityEditorClientLight;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClient==="undefined"){BX.Crm.EntityEditorClient=function(){BX.Crm.EntityEditorClient.superclass.constructor.apply(this);this._info=null;this._enablePrimaryEntity=true;this._primaryEntityTypeName="";this._primaryEntityInfo=null;this._primaryEntityBindingInfos=null;this._primaryEntityEditor=null;this._secondaryEntityTypeName="";this._secondaryEntityInfos=null;this._secondaryEntityEditor=null;this._dataElements=null;this._map=null;this._bindingTracker=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorClient,BX.Crm.EntityEditorField);BX.Crm.EntityEditorClient.prototype.doInitialize=function(){BX.Crm.EntityEditorClient.superclass.doInitialize.apply(this);this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeFromModel()};BX.Crm.EntityEditorClient.prototype.initializeFromModel=function(){this._info=this._model.getSchemeField(this._schemeElement,"info",{});this._enablePrimaryEntity=this._schemeElement.getDataBooleanParam("enablePrimaryEntity",true);if(this._enablePrimaryEntity){var t=BX.prop.getObject(this._info,"PRIMARY_ENTITY_DATA",null);var e=t?BX.CrmEntityInfo.create(t):null;if(e){this.setPrimaryEntity(e)}else{this.setPrimaryEntityTypeName(this._schemeElement.getDataStringParam("primaryEntityTypeName",BX.CrmEntityType.names.company))}}this.setSecondaryEntityTypeName(this._schemeElement.getDataStringParam("secondaryEntityTypeName",BX.CrmEntityType.names.contact));var i=null;var n=this._schemeElement.getDataStringParam("secondaryEntityInfo","");if(n!==""){i=this._model.getField(n,[])}else{i=BX.prop.getArray(this._info,"SECONDARY_ENTITY_DATA",[])}this._secondaryEntityInfos=BX.Collection.create();this._primaryEntityBindingInfos=BX.Collection.create();var r=e&&e.getTypeName()===BX.CrmEntityType.names.company?e.getId():0;var o,s,a;for(o=0,s=i.length;o<s;o++){a=BX.CrmEntityInfo.create(i[o]);if(a.getId()<=0){continue}if(r>0&&a.checkEntityBinding(BX.CrmEntityType.names.company,r)){this._primaryEntityBindingInfos.add(a)}else{this._secondaryEntityInfos.add(a)}}this._bindingTracker=BX.Crm.EntityBindingTracker.create()};BX.Crm.EntityEditorClient.prototype.hasContentToDisplay=function(){return this._primaryEntityInfo!==null||this._secondaryEntityInfos!==null&&this._secondaryEntityInfos.length()>0};BX.Crm.EntityEditorClient.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorClient.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorClient.prototype.getEntityCreateUrl=function(t){return this._editor.getEntityCreateUrl(t)};BX.Crm.EntityEditorClient.prototype.getEntityRequisiteSelectUrl=function(t,e){return this._editor.getEntityRequisiteSelectUrl(t,e)};BX.Crm.EntityEditorClient.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorClient.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorClient.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorClient.prototype.createDataElement=function(t,e){var i=BX.prop.getString(this._map,t,"");if(i===""){return}var n=BX.create("input",{attrs:{name:i,type:"hidden",value:e}});if(!this._dataElements){this._dataElements={}}this._dataElements[t]=n;if(this._wrapper){this._wrapper.appendChild(n)}};BX.Crm.EntityEditorClient.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getTitle();if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._dataElements={};if(!this.hasContentToDisplay()&&this.isInViewMode()){this._wrapper.appendChild(this.createTitleNode(e));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-block"}});this._innerWrapper.appendChild(this.createTitleNode(e));if(this.isInEditMode()){if(this._enablePrimaryEntity){this.createDataElement("primaryEntityType",this.getPrimaryEntityTypeName());this.createDataElement("primaryEntityId",this.getPrimaryEntityId());this.createDataElement("unboundSecondaryEntityIds","");this.createDataElement("boundSecondaryEntityIds","")}this.createDataElement("secondaryEntityType",this.getSecondaryEntityTypeName());this.createDataElement("secondaryEntityIds",this.getAllSecondaryEntityIds().join(","))}var i=BX.create("div",{props:{className:this.isInEditMode()?"crm-entity-widget-content-block-clients":""}});this._innerWrapper.appendChild(i);var n=BX.create("div",{});i.appendChild(n);var r=this._schemeElement.getDataObjectParam("loaders",{});var o=BX.prop.getObject(r,"primary",{});var s=BX.prop.getObject(r,"secondary",{});if(this._enablePrimaryEntity){this._primaryEntityEditor=BX.Crm.PrimaryClientEditor.create(this._id+"_PRIMARY",{entityInfo:this._primaryEntityInfo,entityTypeName:this._primaryEntityTypeName,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastPrimaryEntityInfos",[]),loaderConfig:o,requisiteBinding:this._model.getField("REQUISITE_BINDING",{}),editor:this,mode:this._mode,onChange:BX.delegate(this.onPrimaryEntityChange,this),onDelete:BX.delegate(this.onPrimaryEntityDelete,this),onBindingAdd:BX.delegate(this.onPrimaryEntityBindingAdd,this),onBindingDelete:BX.delegate(this.onPrimaryEntityBindingDelete,this),onBindingRelease:BX.delegate(this.onPrimaryEntityBindingRelease,this),container:i,achor:n});this._primaryEntityEditor.layout()}var a=BX.create("div",{props:{className:"crm-entity-widget-participants-container"}});i.appendChild(a);this._secondaryEntityEditor=BX.Crm.SecondaryClientEditor.create(this._id+"_SECONDARY",{entityInfos:this._secondaryEntityInfos.getItems(),entityTypeName:this._secondaryEntityTypeName,entityLegend:this._schemeElement.getDataStringParam("secondaryEntityLegend",""),lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastSecondaryEntityInfos",[]),primaryLoader:o,secondaryLoader:s,mode:this._mode,onAdd:BX.delegate(this.onSecondaryEntityAdd,this),onDelete:BX.delegate(this.onSecondaryEntityDelete,this),onBeforeAdd:BX.delegate(this.onSecondaryEntityBeforeAdd,this),editor:this,container:a});this._secondaryEntityEditor.layout();if(this._primaryEntityEditor){if(this.isInEditMode()){this._secondaryEntityEditor.setVisible(this._primaryEntityInfo!==null)}else{this._secondaryEntityEditor.setVisible(this._secondaryEntityInfos.length()>0)}}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorClient.prototype.doClearLayout=function(t){if(this._primaryEntityEditor){this._primaryEntityEditor.clearLayout();this._primaryEntityEditor=null}if(this._secondaryEntityEditor){this._secondaryEntityEditor.clearLayout();this._secondaryEntityEditor=null}for(var e in this._dataElements){if(this._dataElements.hasOwnProperty(e)){BX.remove(this._dataElements[e])}}this._dataElements=null;this._innerWrapper=null};BX.Crm.EntityEditorClient.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorClient.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorClient.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityTypeName=function(){return this._primaryEntityTypeName};BX.Crm.EntityEditorClient.prototype.setPrimaryEntityTypeName=function(t){if(this._primaryEntityTypeName!==t){this._primaryEntityTypeName=t}};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityId=function(){return this._primaryEntityInfo?this._primaryEntityInfo.getId():0};BX.Crm.EntityEditorClient.prototype.getPrimaryEntity=function(){return this._primaryEntityInfo};BX.Crm.EntityEditorClient.prototype.setPrimaryEntity=function(t){if(t instanceof BX.CrmEntityInfo){this._primaryEntityInfo=t;this.setPrimaryEntityTypeName(t.getTypeName())}else{this._primaryEntityInfo=null}this.markAsChanged()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindings=function(){return this._primaryEntityBindingInfos};BX.Crm.EntityEditorClient.prototype.getSecondaryEntityTypeName=function(){return this._secondaryEntityTypeName};BX.Crm.EntityEditorClient.prototype.setSecondaryEntityTypeName=function(t){if(this._secondaryEntityTypeName!==t){this._secondaryEntityTypeName=t}};BX.Crm.EntityEditorClient.prototype.getSecondaryEntities=function(){return this._secondaryEntityInfos.getItems()};BX.Crm.EntityEditorClient.prototype.getSecondaryEntityById=function(t){if(!this._secondaryEntityInfos){return null}return this._secondaryEntityInfos.search(function(e){return e.getId()===t})};BX.Crm.EntityEditorClient.prototype.removeSecondaryEntity=function(t){if(this._secondaryEntityInfos){this._secondaryEntityInfos.remove(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.addSecondaryEntity=function(t){if(this._secondaryEntityInfos){this._secondaryEntityInfos.add(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityDelete=function(t,e){this.removeSecondaryEntity(e)};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityBeforeAdd=function(t,e,i){if(this._primaryEntityEditor&&this._primaryEntityInfo&&this._primaryEntityInfo.getTypeName()===BX.CrmEntityType.names.company){var n=this._primaryEntityInfo.getId();if(e.checkEntityBinding(BX.CrmEntityType.names.company,n)&&!this._bindingTracker.isUnbound(e)){this._primaryEntityEditor.addBinding(this._primaryEntityEditor.createBinding(e));i["cancel"]=true}}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityAdd=function(t,e){this.addSecondaryEntity(e)};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityBind=function(t,e){this._secondaryEntityEditor.removeItem(this._secondaryEntityEditor.getItemById(e.getId()));if(this._primaryEntityEditor){this._primaryEntityEditor.addBinding(this._primaryEntityEditor.createBinding(e))}this._bindingTracker.bind(e)};BX.Crm.EntityEditorClient.prototype.getAllSecondaryEntityIds=function(){var t=this.getAllSecondaryEntityInfos();var e=[];for(var i=0,n=t.length;i<n;i++){e.push(t[i].getId())}return e};BX.Crm.EntityEditorClient.prototype.getAllSecondaryEntityInfos=function(){return[].concat(this._primaryEntityBindingInfos.getItems(),this._secondaryEntityInfos.getItems())};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindings=function(){return this._primaryEntityBindingInfos.getItems()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindingById=function(t){if(!this._primaryEntityBindingInfos){return null}return this._primaryEntityBindingInfos.search(function(e){return e.getId()===t})};BX.Crm.EntityEditorClient.prototype.addPrimaryEntityBinding=function(t){if(this._primaryEntityBindingInfos){this._primaryEntityBindingInfos.add(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.removePrimaryEntityBinding=function(t){if(this._primaryEntityBindingInfos){this._primaryEntityBindingInfos.remove(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingAdd=function(t,e){this.addPrimaryEntityBinding(e)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingDelete=function(t,e){this.removePrimaryEntityBinding(e)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingRelease=function(t,e){this._bindingTracker.unbind(e);this._secondaryEntityEditor.addItem(this._secondaryEntityEditor.createItem(e))};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityDelete=function(t,e){var i=[].concat(this._primaryEntityBindingInfos.getItems(),this._secondaryEntityInfos.getItems());this._secondaryEntityInfos=BX.Collection.create();this._primaryEntityBindingInfos=BX.Collection.create();var n=null;if(i.length>0){n=i.shift()}this.setPrimaryEntity(n);this._primaryEntityEditor.setEntity(n);this._secondaryEntityEditor.setEntities(i);this._secondaryEntityEditor.setVisible(n!==null)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityChange=function(t,e){this.setPrimaryEntity(e);if(this._primaryEntityTypeName===BX.CrmEntityType.names.company){this._bindingTracker.reset();this._primaryEntityBindingInfos=BX.Collection.create();this._secondaryEntityInfos=BX.Collection.create();this._secondaryEntityEditor.clearItems();this._secondaryEntityEditor.reloadEntities()}this._secondaryEntityEditor.setVisible(true)};BX.Crm.EntityEditorClient.prototype.save=function(){var t,e,i;var n=this._schemeElement.getDataObjectParam("map",{});if(this._enablePrimaryEntity){this._model.setMappedField(n,"primaryEntityType",this._primaryEntityTypeName);var r=this._primaryEntityInfo?this._primaryEntityInfo.getId():0;this._model.setMappedField(n,"primaryEntityId",r);if(this._primaryEntityInfo){this._info["PRIMARY_ENTITY_DATA"]=this._primaryEntityInfo.getSettings()}else{delete this._info["PRIMARY_ENTITY_DATA"]}if(r>0){var o=this._bindingTracker.getUnboundEntities();var s=[];for(t=0,e=o.length;t<e;t++){s.push(o[t].getId())}if(s.length>0){for(t=0,e=s.length;t<e;t++){i=this.getSecondaryEntityById(s[t]);if(i){i.removeEntityBinding(this._primaryEntityTypeName,r)}}}this._model.setMappedField(n,"unboundSecondaryEntityIds",s.join(","));var a=this._bindingTracker.getBoundEntities();var l=[];for(t=0,e=a.length;t<e;t++){l.push(a[t].getId())}if(l.length>0){for(t=0,e=l.length;t<e;t++){i=this.getPrimaryEntityBindingById(l[t]);if(i){i.addEntityBinding(this._primaryEntityTypeName,r)}}}this._model.setMappedField(n,"boundSecondaryEntityIds",l.join(","));this._bindingTracker.reset()}}this._model.setMappedField(n,"secondaryEntityType",this._secondaryEntityTypeName);var d=this.getAllSecondaryEntityInfos();var h=[];var p=[];for(t=0,e=d.length;t<e;t++){i=d[t];h.push(i.getSettings());p.push(i.getId())}this._model.setMappedField(n,"secondaryEntityIds",p.join(","));this._info["SECONDARY_ENTITY_DATA"]=h};BX.Crm.EntityEditorClient.prototype.onBeforeSubmit=function(){if(!this._dataElements){return}for(var t in this._dataElements){if(!this._dataElements.hasOwnProperty(t)){continue}var e=BX.prop.getString(this._map,t,"");if(e!==""){this._dataElements[t].value=this._model.getField(e,"")}}};BX.Crm.EntityEditorClient.create=function(t,e){var i=new BX.Crm.EntityEditorClient;i.initialize(t,e);return i}}if(typeof BX.Crm.PrimaryClientEditor==="undefined"){BX.Crm.PrimaryClientEditor=function(){this._id="";this._settings={};this._editor=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._entityInfo=null;this._entityTypeName="";this._container=null;this._wrapper=null;this._bindingWrapper=null;this._externalEventHandler=null;this._externalContext=null;this._entityBindSelector=null;this._searchWrapper=null;this._searchInput=null;this._searchControl=null;this._item=null;this._itemBindings=null;this._skeleton=null;this._loaderConfig=null;this._hasLayout=false};BX.Crm.PrimaryClientEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._mode=BX.prop.getInteger(this._settings,"mode",0);this._container=BX.prop.getElementNode(this._settings,"container",null);this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);if(this._entityInfo){this.setEntity(this._entityInfo)}else{this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","")}this._loaderConfig=BX.prop.getObject(this._settings,"loaderConfig",{})},layout:function(){var t=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-container"}});this._bindingWrapper=null;if(!t){this._searchWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-search-box"}});this._wrapper.appendChild(this._searchWrapper);this.prepareSearchLayout();this.adjustSearchLayout()}this._wrapper.appendChild(BX.create("div",{style:{clear:"both"}}));if(this._item){this._item.setContainer(this._wrapper);this._item.layout();this._bindingWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-block-children"}});this._wrapper.appendChild(this._bindingWrapper);var e=this._editor.getPrimaryEntityBindings();this._itemBindings=[];var i,n;for(i=0,n=e.length;i<n;i++){var r=e[i];var o=BX.Crm.ClientEditorEntityBindingPanel.create(this._id+"_"+r.getId().toString(),{entityInfo:r,editor:this._editor,mode:this._mode,container:this._bindingWrapper,onChange:BX.delegate(this.onItemBindingChange,this)});o.layout();this._itemBindings.push(o)}}var s=BX.prop.getElementNode(this._settings,"achor",null);if(s){this._container.insertBefore(this._wrapper,s)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},adjustLayout:function(){},clearLayout:function(){if(this._item){this._item.clearLayout()}if(this._itemBindings){for(var t=0,e=this._itemBindings.length;t<e;t++){this._itemBindings[t].clearLayout()}this._itemBindings=null}this._wrapper=BX.remove(this._wrapper);this._searchWrapper=null;this._bindingWrapper=null;this._entityCreateButton=null;this._hasLayout=false},prepareSearchLayout:function(){this._searchInput=BX.create("input",{props:{id:"dropdown-input",className:"crm-entity-widget-content-input crm-entity-widget-content-search-input"},attrs:{autocomplete:"nope"}});this._searchWrapper.appendChild(this._searchInput);this._searchControl=new BX.UI.Dropdown({searchAction:"crm.api.entity.search",searchOptions:{types:[BX.CrmEntityType.names.contact,BX.CrmEntityType.names.company]},searchResultRenderer:null,targetElement:this._searchInput,items:BX.prop.getArray(this._settings,"lastEntityInfos",[]),footerItems:[{caption:this.getMessage("create"),buttons:[{type:"create",caption:BX.CrmEntityType.getCaption(BX.CrmEntityType.enumeration.contact),events:{click:BX.delegate(function(){this.createEntity(BX.CrmEntityType.names.contact);this._searchControl.destroyPopupWindow()},this)}},{type:"create",caption:BX.CrmEntityType.getCaption(BX.CrmEntityType.enumeration.company),events:{click:BX.delegate(function(){this.createEntity(BX.CrmEntityType.names.company);this._searchControl.destroyPopupWindow()},this)}}]}],events:{onSelect:this.onEntitySelect.bind(this),onSearch:function(t){}}})},adjustSearchLayout:function(){if(this._searchWrapper){this._searchWrapper.style.display=this._item?"none":""}},getEntityTypeName:function(){return this._entityTypeName},setEntityTypeName:function(t){if(this._entityTypeName===t){return}this._entityTypeName=t},setEntity:function(t){if(this._item){if(this._hasLayout){this._item.clearLayout()}this._item=null}if(!(t instanceof BX.CrmEntityInfo)){this._entityInfo=null}else{this._entityInfo=t;this.setEntityTypeName(this._entityInfo.getTypeName());this._item=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._entityInfo.getId().toString(),{editor:this._editor,entityInfo:this._entityInfo,enableEntityTypeCaption:true,enableRequisite:true,requisiteBinding:BX.prop.getObject(this._settings,"requisiteBinding",{}),mode:this._mode,onDelete:BX.delegate(this.onItemDelete,this)});if(this._hasLayout){this._item.setContainer(this._wrapper);this._item.layout()}}if(this._itemBindings){for(var e=0,i=this._itemBindings.length;e<i;e++){this._itemBindings[e].clearLayout()}this._itemBindings=null}this.adjustSearchLayout()},setupEntity:function(t){if(this._entityInfo&&this._entityInfo.getId()===t){return}this.setEntity(null);var e=BX.prop.getFunction(this._settings,"onChange");if(e){e(this,this._entityInfo)}var i=BX.prop.getObject(this._loaderConfig,this._entityTypeName,null);if(i){this.showSkeleton();BX.CrmDataLoader.create(this._id,{serviceUrl:i["url"],action:i["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t}}).load(BX.delegate(this.onEntityInfoLoad,this))}},showSkeleton:function(){if(!this._skeleton){this._skeleton=BX.Crm.ClientEditorEntitySkeleton.create(this._id,{container:this._wrapper})}this._skeleton.layout()},hideSkeleton:function(){if(this._skeleton){this._skeleton.clearLayout()}},onEntityInfoLoad:function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(i){var n=this._hasLayout;if(n){this.clearLayout()}this.hideSkeleton();var r=BX.CrmEntityInfo.create(i);this.setEntity(r);var o=BX.prop.getFunction(this._settings,"onChange");if(o){o(this,this._entityInfo)}if(n){this.layout()}}},getEntityCreateUrl:function(t){return this._editor.getEntityCreateUrl(t)},createEntity:function(t){var e=this.getEntityCreateUrl(t);if(e===""){return""}var i=this._editor.getContextId();e=BX.util.add_url_param(e,{external_context_id:i});if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}this._externalContext[i]=e;BX.Crm.Page.open(e)},onEntitySelect:function(t,e){this._entityTypeName=BX.prop.getString(e,"entityType","");var i=BX.prop.getInteger(e,"entityId",0);if(i>0){this.setupEntity(i);this._searchControl.destroyPopupWindow()}},onExternalEvent:function(t){if(BX.prop.getString(t,"key","")!=="onCrmEntityCreate"){return}var e=BX.prop.getObject(t,"value",{});var i=BX.prop.getString(e,"context","");if(this._externalContext&&typeof this._externalContext[i]!=="undefined"){var n=BX.prop.getString(e,"entityTypeName","");var r=BX.prop.getInteger(e,"entityId",0);if(this._entityTypeName!==n){this._entityTypeName=n}this.setupEntity(r);BX.Crm.Page.close(this._externalContext[i]);delete this._externalContext[i]}},onItemBindingChange:function(t,e){if(e==="unbind"){var i=BX.prop.getFunction(this._settings,"onBindingRelease");if(i){i(this,t.getEntity())}this.removeBinding(t)}else if(e==="delete"){this.removeBinding(t)}},onItemDelete:function(t){var e=this._entityInfo;var i=this._hasLayout;if(i){this.clearLayout()}this.setEntity(null);if(i){this.layout()}var n=BX.prop.getFunction(this._settings,"onDelete");if(n){n(this,e)}},getBindings:function(){return this._itemBindings},createBinding:function(t){return BX.Crm.ClientEditorEntityBindingPanel.create(this._id+"_"+t.getId().toString(),{entityInfo:t,editor:this._editor,mode:this._mode,onChange:BX.delegate(this.onItemBindingChange,this)})},findBindingById:function(t){for(var e=0,i=this._itemBindings.length;e<i;e++){var n=this._itemBindings[e];if(n.getEntity().getId()===t){return n}}return null},getBindingIndex:function(t){for(var e=0,i=this._itemBindings.length;e<i;e++){if(this._itemBindings[e]===t){return e}}return-1},addBinding:function(t){this._itemBindings.push(t);if(this._hasLayout){t.setContainer(this._bindingWrapper);t.layout()}var e=BX.prop.getFunction(this._settings,"onBindingAdd");if(e){e(this,t.getEntity())}},removeBinding:function(t){var e=this.getBindingIndex(t);if(e<0){return}t.clearLayout();this._itemBindings.splice(e,1);var i=BX.prop.getFunction(this._settings,"onBindingDelete");if(i){i(this,t.getEntity())}},getBindingEntities:function(){var t=[];if(this._itemBindings){for(var e=0,i=this._itemBindings.length;e<i;e++){t.push(this._itemBindings[e].getEntity())}}return t}};BX.Crm.PrimaryClientEditor.prototype.getMessage=function(t){var e=BX.Crm.PrimaryClientEditor.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.PrimaryClientEditor.messages==="undefined"){BX.Crm.PrimaryClientEditor.messages={}}BX.Crm.PrimaryClientEditor.create=function(t,e){var i=new BX.Crm.PrimaryClientEditor;i.initialize(t,e);return i}}if(typeof BX.Crm.SecondaryClientEditor==="undefined"){BX.Crm.SecondaryClientEditor=function(){this._id="";this._settings={};this._mode=BX.Crm.EntityEditorMode.intermediate;this._container=null;this._wrapper=null;this._entityTypeName="";this._entityInfos=null;this._items=null;this._externalEventHandler=null;this._externalContext=null;this._isMultiple=true;this._primaryLoaderConfig=null;this._secondaryLoaderConfig=null;this._editor=null;this._searchWrapper=null;this._searchInput=null;this._searchControl=null;this._addButton=null;this._addButtonHandler=BX.delegate(this.onAddButtonClick,this);this._bindButton=null;this._bindButtonClickHandler=BX.delegate(this.onBindButtonClick,this);this._bindingSelector=null;this._bindingSelectHandler=BX.delegate(this.onBindingSelect,this);this._isVisible=true;this._hasLayout=false};BX.Crm.SecondaryClientEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._mode=BX.prop.getInteger(this._settings,"mode",0);this._editor=BX.prop.get(this._settings,"editor",null);this._container=BX.prop.getElementNode(this._settings,"container",null);this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","");this._entityInfos=BX.prop.getArray(this._settings,"entityInfos","");this._isMultiple=BX.prop.getBoolean(this._settings,"isMultiple",true);this._items=[];var i=this._entityInfos.length;if(!this._isMultiple&&i>1){i=1}for(var n=0;n<i;n++){var r=this.createItem(this._entityInfos[n]);this._items.push(r)}this._primaryLoaderConfig=BX.prop.getObject(this._settings,"primaryLoader",{});this._secondaryLoaderConfig=BX.prop.getObject(this._settings,"secondaryLoader",{})},getMessage:function(t){var e=BX.Crm.SecondaryClientEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getEntityTypeName:function(){return this._entityTypeName},getEntities:function(){return this._entityInfos},setEntities:function(t){this._entityInfos=t;this.clearItems();var e=this._entityInfos.length;if(!this._isMultiple&&e>1){e=1}for(var i=0;i<e;i++){this.addItem(this.createItem(this._entityInfos[i]))}},findItemIndex:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1},getFirstItem:function(){return this._items.length>0?this._items[0]:null},getItemById:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getEntity().getId()===t){return n}}return null},getItems:function(){return this._items},getItemCount:function(){return this._items.length},createItem:function(t){return BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+t.getId().toString(),{editor:this._editor,entityInfo:t,mode:this._mode,onDelete:BX.delegate(this.onItemDelete,this)})},clearItems:function(){for(var t=0,e=this._items.length;t<e;t++){var i=this._items[t];i.clearLayout();i.setContainer(null)}this._items=[]},addItemById:function(t){var e=BX.prop.getObject(this._primaryLoaderConfig,this._entityTypeName,null);if(!e){return}BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t}}).load(BX.delegate(this.onEntityInfoLoad,this))},addItem:function(t){var e=BX.prop.getFunction(this._settings,"onBeforeAdd");if(e){var i={cancel:false};e(this,t.getEntity(),i);if(i["cancel"]){return false}}if(!this._isMultiple){this.clearItems()}this._items.push(t);if(this._hasLayout){t.setContainer(this._itemsWrapper);t.layout()}var n=BX.prop.getFunction(this._settings,"onAdd");if(n){n(this,t.getEntity())}this.adjustLayout();return true},removeItem:function(t){var e=this.findItemIndex(t);if(e<0){return}this._items.splice(e,1);if(this._hasLayout){t.clearLayout();t.setContainer(null)}var i=BX.prop.getFunction(this._settings,"onDelete");if(i){i(this,t.getEntity())}this.adjustLayout()},reloadEntities:function(){if(!this._editor){return}var t=this._editor.getPrimaryEntity();if(!t){return}var e=BX.prop.getObject(this._secondaryLoaderConfig,t.getTypeName(),null);if(e){BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{PRIMARY_TYPE_NAME:t.getTypeName(),PRIMARY_ID:t.getId(),SECONDARY_TYPE_NAME:this._entityTypeName,OWNER_TYPE_NAME:this._editor.getOwnerTypeName()}}).load(BX.delegate(this.onEntityInfosReload,this))}},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;if(this._wrapper){this._wrapper.style.display=t?"":"none"}},layout:function(){var t=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{});if(!this._isVisible){this._wrapper.style.display="none"}this._container.appendChild(this._wrapper);var e=BX.prop.getString(this._settings,"entityLegend","");this._addButton=null;this._bindButton=null;if(t){this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:e})]}))}else{this._bindButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-bind"},text:this.getMessage("bind"),events:{click:this._bindButtonClickHandler}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-participants-title"},children:[BX.create("div",{props:{className:"crm-entity-widget-clients-actions-block"},children:[BX.create("span",{props:{className:"crm-entity-widget-actions-btn-participants"},children:[BX.create("span",{props:{className:"crm-entity-widget-participants-title-text"},text:e})]}),this._bindButton]})]}))}this._searchWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-search-box"}});this._searchWrapper.style.display="none";this._itemsWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-item-container"}});this._wrapper.appendChild(this._searchWrapper);this._wrapper.appendChild(this._itemsWrapper);if(!t){this._addButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-add"},text:this.getMessage("addParticipant"),events:{click:this._addButtonHandler}});this._wrapper.appendChild(this._addButton)}this.prepareSearchLayout();for(var i=0,n=this._items.length;i<n;i++){this._items[i].setContainer(this._itemsWrapper);this._items[i].layout()}this.adjustLayout();this._hasLayout=true},clearLayout:function(){for(var t=0,e=this._items.length;t<e;t++){this._items[t].clearLayout();this._items[t].setContainer(null)}this._addButton=null;this._bindButton=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},adjustLayout:function(){if(!this._bindButton){return}this._bindButton.style.display=this._editor.getPrimaryEntityTypeName()===BX.CrmEntityType.names.company&&BX.util.array_diff(this._editor.getSecondaryEntities(),this._editor.getPrimaryEntityBindings(),BX.CrmEntityInfo.getHashCode).length>0?"":"none"},prepareSearchLayout:function(){var t=BX.CrmEntityType.resolveId(this._entityTypeName);this._searchInput=BX.create("input",{props:{id:"dropdown-input",className:"crm-entity-widget-content-input crm-entity-widget-content-search-input"},attrs:{autocomplete:"nope"}});this._searchWrapper.appendChild(this._searchInput);this._searchControl=new BX.UI.Dropdown({searchAction:"crm.api.entity.search",searchOptions:{types:[this._entityTypeName]},searchResultRenderer:null,targetElement:this._searchInput,items:BX.prop.getArray(this._settings,"lastEntityInfos",[]),footerItems:[{caption:this.getMessage("create"),buttons:[{type:"create",caption:BX.CrmEntityType.getCaption(t),events:{click:BX.delegate(function(){this.createEntity();this._searchControl.destroyPopupWindow()},this)}}]}],events:{onSelect:this.onItemSelect.bind(this),onSearch:function(t){}}})},onAddButtonClick:function(t){this._searchWrapper.style.display=this._searchWrapper.style.display==="none"?"":"none"},onBindButtonClick:function(t){if(this._bindingSelector&&this._bindingSelector.isOpened()){this._bindingSelector.close();return}if(!this._bindingSelector){this._bindingSelector=BX.CmrSelectorMenu.create(this._id,{items:[]});this._bindingSelector.addOnSelectListener(this._bindingSelectHandler)}var e=this._editor.getPrimaryEntityBindings();var i=[];var n,r;for(n=0,r=e.length;n<r;n++){i.push(e[n])}var o=BX.util.array_diff(this._editor.getSecondaryEntities(),i,BX.CrmEntityInfo.getHashCode);var s=[];for(n=0,r=o.length;n<r;n++){var a=o[n];s.push({text:a.getTitle(),value:a.getId()})}this._bindingSelector.setupItems(s);this._bindingSelector.open(this._bindButton)},onBindingSelect:function(t,e){this._editor.onSecondaryEntityBind(this,this._editor.getSecondaryEntityById(e.getValue()))},onItemSelect:function(t,e){var i=BX.prop.getInteger(e,"entityId",0);if(i>0){this.addItemById(i);this._searchWrapper.style.display="none";this._searchControl.destroyPopupWindow()}},onItemDelete:function(t){this.removeItem(t)},onEntityInfoLoad:function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(!i){return}var n=BX.CrmEntityInfo.create(i);if(this.getItemById(n.getId())!==null){return}this.addItem(this.createItem(n))},onEntityInfosReload:function(t,e){var i=BX.type.isArray(e["ENTITY_INFOS"])?e["ENTITY_INFOS"]:[];var n=[];for(var r=0;r<i.length;r++){n.push(BX.CrmEntityInfo.create(i[r]))}this.setEntities(n)},getEntityCreateUrl:function(t){return this._editor.getEntityCreateUrl(t)},createEntity:function(){var t=this.getEntityCreateUrl(this.getEntityTypeName());if(t===""){return}var e=this._editor.getContextId();t=BX.util.add_url_param(t,{external_context_id:e});var i=this._editor.getOwnerTypeName();var n=this._editor.getOwnerId();if(n>0&&i===BX.CrmEntityType.names.company){t=BX.util.add_url_param(t,{company_id:n})}if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}this._externalContext[e]=t;BX.Crm.Page.open(t)},onExternalEvent:function(t){if(!this._externalContext){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";if(e!=="onCrmEntityCreate"){return}var i=BX.prop.getObject(t,"value",{});if(BX.prop.getString(i,"entityTypeName","")!==this.getEntityTypeName()){return}var n=BX.prop.getInteger(i,"entityId",0);var r=BX.prop.getString(i,"context","");if(typeof this._externalContext[r]!=="undefined"){this.addItemById(n);BX.Crm.Page.close(this._externalContext[r]);delete this._externalContext[r]}}};if(typeof BX.Crm.SecondaryClientEditor.messages==="undefined"){BX.Crm.SecondaryClientEditor.messages={}}BX.Crm.SecondaryClientEditor.create=function(t,e){var i=new BX.Crm.SecondaryClientEditor;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorEntity==="undefined"){BX.Crm.EntityEditorEntity=function(){BX.Crm.EntityEditorEntity.superclass.constructor.apply(this);this._entityTypeName="";this._entityInfo=null;this._entitySelectClickHandler=BX.delegate(this.onEntitySelectClick,this);this._entitySelectButton=null;this._entitySelector=null;this._entityWrapper=null;this._dataInput=null;this._skeleton=null};BX.extend(BX.Crm.EntityEditorEntity,BX.Crm.EntityEditorField);BX.Crm.EntityEditorEntity.prototype.doInitialize=function(){BX.Crm.EntityEditorEntity.superclass.doInitialize.apply(this);this._loaderConfig=this._schemeElement.getDataObjectParam("loader",{});this.initializeFromModel()};BX.Crm.EntityEditorEntity.prototype.initializeFromModel=function(){var t=this._model.getSchemeField(this._schemeElement,"info",null);if(t){this.setEntity(BX.CrmEntityInfo.create(t))}else{this.setEntityTypeName(this._schemeElement.getDataStringParam("entityTypeName",""))}};BX.Crm.EntityEditorEntity.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorEntity.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorEntity.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorEntity.prototype.getEntityTypeName=function(){return this._entityTypeName};BX.Crm.EntityEditorEntity.prototype.setEntityTypeName=function(t){if(this._entityTypeName===t){return}this._entityTypeName=t;if(this._entitySelector){this._entitySelector=null}};BX.Crm.EntityEditorEntity.prototype.setEntity=function(t){if(this._item){if(this._hasLayout){this._item.clearLayout()}this._item=null}if(!(t instanceof BX.CrmEntityInfo)){this._entityInfo=null}else{this._entityInfo=t;this.setEntityTypeName(this._entityInfo.getTypeName());this._item=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._entityInfo.getId().toString(),{editor:this,entityInfo:this._entityInfo,enableEntityTypeCaption:false,enableRequisite:true,mode:this._mode,onDelete:BX.delegate(this.onItemDelete,this)});if(this._hasLayout){this._item.setContainer(this._entityWrapper);this._item.layout()}}};BX.Crm.EntityEditorEntity.prototype.setupEntity=function(t){if(this._entityInfo&&this._entityInfo.getId()===t){return}this.setEntity(null);var e=BX.prop.getObject(this._loaderConfig,this._entityTypeName,null);if(e){this.showSkeleton();BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t}}).load(BX.delegate(this.onEntityInfoLoad,this))}};BX.Crm.EntityEditorEntity.prototype.showSkeleton=function(){if(!this._skeleton){this._skeleton=BX.Crm.ClientEditorEntitySkeleton.create(this._id,{container:this._entityWrapper})}this._skeleton.layout()};BX.Crm.EntityEditorEntity.prototype.hideSkeleton=function(){if(this._skeleton){this._skeleton.clearLayout()}};BX.Crm.EntityEditorEntity.prototype.onEntityInfoLoad=function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(i){this.hideSkeleton();var n=BX.CrmEntityInfo.create(i);this.setEntity(n)}};BX.Crm.EntityEditorEntity.prototype.onItemDelete=function(t){this.setEntity(null)};BX.Crm.EntityEditorEntity.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorEntity.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorEntity.prototype.doSetMode=function(t){this.rollback();if(this._item){this._item.setMode(t)}};BX.Crm.EntityEditorEntity.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this._schemeElement.getTitle();var n=this.getValue();var r=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});if(r&&!this._item){this.registerLayout(t);this._hasLayout=true;return}var o=BX.create("div",{props:{className:"crm-entity-widget-clients-block"}});this._wrapper.appendChild(o);o.appendChild(this.createTitleNode(i));var s=BX.create("div",{props:{className:!r?"crm-entity-widget-content-block-clients":""}});o.appendChild(s);this._entityWrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-container"}});s.appendChild(this._entityWrapper);if(!r){this._entitySelectButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-select"},text:this.getMessage("select"),events:{click:this._entitySelectClickHandler}});var a=BX.create("div",{props:{className:"crm-entity-widget-clients-actions-block"},children:[this._entitySelectButton]});this._entityWrapper.appendChild(a);this._dataInput=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._entityWrapper.appendChild(this._dataInput)}if(this._item){this._item.setContainer(this._entityWrapper);this._item.layout()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorEntity.prototype.clearLayout=function(){if(this._item){this._item.clearLayout()}this._wrapper=BX.remove(this._wrapper);this._entityWrapper=null;this._dataInput=null;if(this._entitySelector){if(this._entitySelector.isOpened()){this._entitySelector.close()}this._entitySelector=null}this._hasLayout=false};BX.Crm.EntityEditorEntity.prototype.onEntitySelectClick=function(t){if(this._entitySelector&&this._entitySelector.isOpened()){this._entitySelector.close();return}if(!this._entitySelector){this._entitySelector=BX.Crm.EntityEditorCrmSelector.create(this._id,{entityTypeIds:[BX.CrmEntityType.resolveId(this._entityTypeName)],enableMyCompanyOnly:this._schemeElement.getDataBooleanParam("enableMyCompanyOnly",false),callback:BX.delegate(this.onEntitySelect,this)})}this._entitySelector.open(this._entitySelectButton)};BX.Crm.EntityEditorEntity.prototype.onEntitySelect=function(t,e){var i=BX.prop.getInteger(e,"entityId",0);if(this._entityInfo&&this._entityInfo.getId()===i){return}this._entitySelector.close();this.setupEntity(i)};BX.Crm.EntityEditorEntity.prototype.save=function(){this._model.setField(this.getName(),this._entityInfo?this._entityInfo.getId():0)};BX.Crm.EntityEditorEntity.prototype.onBeforeSubmit=function(){if(this._dataInput){this._dataInput.value=this._model.getField(this.getName(),"")}};BX.Crm.EntityEditorEntity.prototype.getMessage=function(t){return BX.prop.getString(BX.Crm.EntityEditorEntity.messages,t,t)};if(typeof BX.Crm.EntityEditorEntity.messages==="undefined"){BX.Crm.EntityEditorEntity.messages={}}BX.Crm.EntityEditorEntity.create=function(t,e){var i=new BX.Crm.EntityEditorEntity;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFieldConfigurator==="undefined"){BX.Crm.EntityEditorFieldConfigurator=function(){BX.Crm.EntityEditorFieldConfigurator.superclass.constructor.apply(this);this._field=null;this._name=null;this._isLocked=false;this._labelInput=null;this._isRequiredCheckBox=null;this._showAlwaysCheckBox=null;this._saveButton=null;this._cancelButton=null;this._optionWrapper=null;this._mandatoryConfigurator=null};BX.extend(BX.Crm.EntityEditorFieldConfigurator,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorFieldConfigurator.prototype.doInitialize=function(){BX.Crm.EntityEditorFieldConfigurator.superclass.doInitialize.apply(this);this._field=BX.prop.get(this._settings,"field",null);this._name=BX.prop.getString(this._fieldData,"name","");this._mandatoryConfigurator=BX.prop.get(this._settings,"mandatoryConfigurator",null)};BX.Crm.EntityEditorFieldConfigurator.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorFieldConfigurator.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorFieldConfigurator.prototype.layout=function(t){if(this._hasLayout){return}if(this._mode===BX.Crm.EntityEditorMode.view){throw"EntityEditorFieldConfigurator. View mode is not supported by this control type."}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields"}});this._labelInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:this._field.getTitle()}});this._saveButton=BX.create("span",{props:{className:"ui-btn ui-btn-primary"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("span",{props:{className:"ui-btn ui-btn-light-border"},text:BX.message("CRM_EDITOR_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("labelField")})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._labelInput]})]})]}));this._optionWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-checkbox"},children:[this._optionWrapper]}));if(this._field.areAttributesEnabled()&&!this._field.isRequired()&&this._mandatoryConfigurator){this._isRequiredCheckBox=this.createOption({caption:this._mandatoryConfigurator.getTitle()+":",labelSettings:{props:{className:"crm-entity-new-field-addiction-label"}},containerSettings:{style:{alignItems:"center"}},elements:this._mandatoryConfigurator.getButton().prepareLayout()});this._isRequiredCheckBox.checked=!this._mandatoryConfigurator.isEmpty();this._mandatoryConfigurator.setSwitchCheckBox(this._isRequiredCheckBox);this._mandatoryConfigurator.setLabel(this._isRequiredCheckBox.nextSibling);this._mandatoryConfigurator.setEnabled(this._isRequiredCheckBox.checked);this._mandatoryConfigurator.adjust()}this._showAlwaysCheckBox=this.createOption({caption:this.getMessage("showAlways"),helpUrl:"https://helpdesk.bitrix24.ru/open/7046149/"});this._showAlwaysCheckBox.checked=this._field.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways);this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields-btn-container"},children:[this._saveButton,this._cancelButton]}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorFieldConfigurator.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._labelInput=null;this._isRequiredCheckBox=null;this._showAlwaysCheckBox=null;this._saveButton=null;this._cancelButton=null;this._optionWrapper=null;this._hasLayout=false};BX.Crm.EntityEditorFieldConfigurator.prototype.onSaveButtonClick=function(t){if(this._isLocked){return}if(this._mandatoryConfigurator){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}this._mandatoryConfigurator.close()}var e={field:this._field,label:this._labelInput.value,showAlways:this._showAlwaysCheckBox.checked};BX.onCustomEvent(this,"onSave",[this,e])};BX.Crm.EntityEditorFieldConfigurator.prototype.onCancelButtonClick=function(t){if(this._isLocked){return}var e={field:this._field};BX.onCustomEvent(this,"onCancel",[this,e])};BX.Crm.EntityEditorFieldConfigurator.prototype.setLocked=function(t){t=!!t;if(this._isLocked===t){return}this._isLocked=t;if(this._isLocked){BX.addClass(this._saveButton,"ui-btn-clock")}else{BX.removeClass(this._saveButton,"ui-btn-clock")}};BX.Crm.EntityEditorFieldConfigurator.prototype.getField=function(){return this._field};BX.Crm.EntityEditorFieldConfigurator.prototype.createOption=function(t){var e=BX.create("input",{props:{type:"checkbox"}});var i=BX.create("label",{children:[e,BX.create("span",{text:BX.prop.getString(t,"caption","")})]});var n=BX.prop.getObject(t,"labelSettings",null);if(n){BX.adjust(i,n)}var r=BX.prop.getString(t,"helpUrl","");if(r!==""){i.appendChild(BX.create("a",{props:{className:"crm-entity-new-field-helper-icon",href:r,target:"_blank"}}))}var o=[i];var s=BX.prop.getArray(t,"elements",[]);for(var a=0,l=s.length;a<l;a++){o.push(s[a])}var d=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:o});var h=BX.prop.getObject(t,"containerSettings",null);if(h){BX.adjust(d,h)}this._optionWrapper.appendChild(d);return e};if(typeof BX.Crm.EntityEditorFieldConfigurator.messages==="undefined"){BX.Crm.EntityEditorFieldConfigurator.messages={}}BX.Crm.EntityEditorFieldConfigurator.create=function(t,e){var i=new BX.Crm.EntityEditorFieldConfigurator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserFieldConfigurator==="undefined"){BX.Crm.EntityEditorUserFieldConfigurator=function(){BX.Crm.EntityEditorUserFieldConfigurator.superclass.constructor.apply(this);this._field=null;this._typeId="";this._isLocked=false;this._labelInput=null;this._saveButton=null;this._cancelButton=null;this._isTimeEnabledCheckBox=null;this._isRequiredCheckBox=null;this._isMultipleCheckBox=null;this._showAlwaysCheckBox=null;this._enumItemWrapper=null;this._enumItemContainer=null;this._enumButtonWrapper=null;this._optionWrapper=null;this._enumItems=null;this._mandatoryConfigurator=null};BX.extend(BX.Crm.EntityEditorUserFieldConfigurator,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorUserFieldConfigurator.prototype.doInitialize=function(){BX.Crm.EntityEditorUserFieldConfigurator.superclass.doInitialize.apply(this);this._field=BX.prop.get(this._settings,"field",null);if(this._field&&!(this._field instanceof BX.Crm.EntityEditorUserField)){throw"EntityEditorUserFieldConfigurator. The 'field' param must be EntityEditorUserField."}this._mandatoryConfigurator=BX.prop.get(this._settings,"mandatoryConfigurator",null);this._typeId=BX.prop.getString(this._settings,"typeId","");this._enumItems=[]};BX.Crm.EntityEditorUserFieldConfigurator.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorUserFieldConfigurator.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorUserFieldConfigurator.prototype.layout=function(t){if(this._hasLayout){return}if(this._mode===BX.Crm.EntityEditorMode.view){throw"EntityEditorUserFieldConfigurator. View mode is not supported by this control type."}var e=this._field===null;var i=this.getMessage("labelField");var n=this._editor.getUserFieldManager();var r=this._field?this._field.getTitle():n.getDefaultFieldLabel(this._typeId);this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields"}});this._labelInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:r}});this._saveButton=BX.create("span",{props:{className:"ui-btn ui-btn-primary"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("span",{props:{className:"ui-btn ui-btn-light-border"},text:BX.message("CRM_EDITOR_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:i})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._labelInput]})]})]}));if(this._typeId==="enumeration"){this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this._enumItemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});this._wrapper.appendChild(this._enumItemWrapper);this._enumItemWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("enumItems")})]}));this._enumItemContainer=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._enumItemWrapper.appendChild(this._enumItemContainer);this._enumButtonWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-add-field"}});this._enumItemWrapper.appendChild(this._enumButtonWrapper);this._enumButtonWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-widget-content-add-field"},events:{click:BX.delegate(this.onEnumerationItemAddButtonClick,this)},text:this.getMessage("add")}));if(this._field){var o=this._field.getFieldInfo();var s=BX.prop.getArray(o,"ENUM",[]);for(var a=0,l=s.length;a<l;a++){this.createEnumerationItem(s[a])}}this.createEnumerationItem()}this._optionWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-checkbox"},children:[this._optionWrapper]}));var d=0;if(e&&(this._typeId==="datetime"||this._typeId==="date")){this._isTimeEnabledCheckBox=this.createOption({caption:this.getMessage("enableTime")});d++}if(this._typeId!=="boolean"){if(this._mandatoryConfigurator){this._isRequiredCheckBox=this.createOption({caption:this._mandatoryConfigurator.getTitle()+":",labelSettings:{props:{className:"crm-entity-new-field-addiction-label"}},containerSettings:{style:{alignItems:"center"}},elements:this._mandatoryConfigurator.getButton().prepareLayout()});this._isRequiredCheckBox.checked=this._field&&this._field.isRequired()||this._mandatoryConfigurator.isCustomized();this._mandatoryConfigurator.setSwitchCheckBox(this._isRequiredCheckBox);this._mandatoryConfigurator.setLabel(this._isRequiredCheckBox.nextSibling);this._mandatoryConfigurator.setEnabled(this._isRequiredCheckBox.checked);this._mandatoryConfigurator.adjust()}else{this._isRequiredCheckBox=this.createOption({caption:this.getMessage("isRequiredField")});this._isRequiredCheckBox.checked=this._field&&this._field.isRequired()}d++;if(e){this._isMultipleCheckBox=this.createOption({caption:this.getMessage("isMultipleField")});d++}}this._showAlwaysCheckBox=this.createOption({caption:this.getMessage("showAlways"),helpUrl:"https://helpdesk.bitrix24.ru/open/7046149/"});this._showAlwaysCheckBox.checked=e?BX.prop.getBoolean(this._settings,"showAlways",true):this._field.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways);d++;if(d>0){this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}))}this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields-btn-container"},children:[this._saveButton,this._cancelButton]}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorUserFieldConfigurator.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._labelInput=null;this._saveButton=null;this._cancelButton=null;this._isTimeEnabledCheckBox=null;this._isRequiredCheckBox=null;this._isMultipleCheckBox=null;this._showAlwaysCheckBox=null;this._enumItemWrapper=null;this._enumButtonWrapper=null;this._enumItemContainer=null;this._optionWrapper=null;this._enumItems=[];this._hasLayout=false};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onEnumerationItemAddButtonClick=function(t){this.createEnumerationItem().focus()};BX.Crm.EntityEditorUserFieldConfigurator.prototype.createEnumerationItem=function(t){var e=BX.Crm.EntityEditorUserFieldListItem.create("",{configurator:this,container:this._enumItemContainer,data:t});this._enumItems.push(e);e.layout();return e};BX.Crm.EntityEditorUserFieldConfigurator.prototype.removeEnumerationItem=function(t){for(var e=0,i=this._enumItems.length;e<i;e++){if(this._enumItems[e]===t){this._enumItems[e].clearLayout();this._enumItems.splice(e,1);break}}};BX.Crm.EntityEditorUserFieldConfigurator.prototype.createOption=function(t){var e=BX.create("input",{props:{type:"checkbox"}});var i=BX.create("label",{children:[e,BX.create("span",{text:BX.prop.getString(t,"caption","")})]});var n=BX.prop.getObject(t,"labelSettings",null);if(n){BX.adjust(i,n)}var r=BX.prop.getString(t,"helpUrl","");if(r!==""){i.appendChild(BX.create("a",{props:{className:"crm-entity-new-field-helper-icon",href:r,target:"_blank"}}))}var o=[i];var s=BX.prop.getArray(t,"elements",[]);for(var a=0,l=s.length;a<l;a++){o.push(s[a])}var d=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:o});var h=BX.prop.getObject(t,"containerSettings",null);if(h){BX.adjust(d,h)}this._optionWrapper.appendChild(d);return e};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onSaveButtonClick=function(t){if(this._isLocked){return}if(this._mandatoryConfigurator){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}this._mandatoryConfigurator.close()}var e={typeId:this._typeId,label:this._labelInput.value};if(this._field){e["field"]=this._field;if(this._isRequiredCheckBox){e["mandatory"]=this._isRequiredCheckBox.checked}}else{if(this._typeId==="boolean"){e["multiple"]=false}else{if(this._isMultipleCheckBox){e["multiple"]=this._isMultipleCheckBox.checked}e["mandatory"]=this._isRequiredCheckBox.checked}if(this._typeId==="datetime"){e["enableTime"]=this._isTimeEnabledCheckBox.checked}}if(this._typeId==="enumeration"){e["enumeration"]=[];var i=[];for(var n=0,r=this._enumItems.length;n<r;n++){var o=this._enumItems[n].prepareData();if(!o){continue}var s=BX.util.hashCode(o["VALUE"]);if(BX.util.in_array(s,i)){continue}i.push(s);o["SORT"]=(e["enumeration"].length+1)*100;e["enumeration"].push(o)}}e["showAlways"]=this._showAlwaysCheckBox.checked;BX.onCustomEvent(this,"onSave",[this,e])};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onCancelButtonClick=function(t){if(this._isLocked){return}var e={typeId:this._typeId};if(this._field){e["field"]=this._field}BX.onCustomEvent(this,"onCancel",[this,e])};BX.Crm.EntityEditorUserFieldConfigurator.prototype.setLocked=function(t){t=!!t;if(this._isLocked===t){return}this._isLocked=t;if(this._isLocked){BX.addClass(this._saveButton,"ui-btn-clock")}else{BX.removeClass(this._saveButton,"ui-btn-clock")}};BX.Crm.EntityEditorUserFieldConfigurator.prototype.getField=function(){return this._field};if(typeof BX.Crm.EntityEditorUserFieldConfigurator.messages==="undefined"){BX.Crm.EntityEditorUserFieldConfigurator.messages={}}BX.Crm.EntityEditorUserFieldConfigurator.create=function(t,e){var i=new BX.Crm.EntityEditorUserFieldConfigurator;i.initialize(t,e);return i};BX.onCustomEvent(window,"BX.Crm.EntityEditorUserFieldConfigurator:onDefine")}if(typeof BX.Crm.EntityEditorUserFieldListItem==="undefined"){BX.Crm.EntityEditorUserFieldListItem=function(){this._id="";this._settings=null;this._data=null;this._configurator=null;this._container=null;this._labelInput=null;this._hasLayout=false};BX.Crm.EntityEditorUserFieldListItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=BX.type.isPlainObject(e)?e:{};this._data=BX.prop.getObject(this._settings,"data",{});this._configurator=BX.prop.get(this._settings,"configurator");this._container=BX.prop.getElementNode(this._settings,"container")},layout:function(){if(this._hasLayout){return}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"}});this._labelInput=BX.create("input",{props:{className:"crm-entity-widget-content-input",type:"input",value:BX.prop.getString(this._data,"VALUE","")}});this._wrapper.appendChild(this._labelInput);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-remove-block"},events:{click:BX.delegate(this.onDeleteButtonClick,this)}}));var t=BX.prop.getElementNode(this._settings,"anchor");if(t){this._container.insertBefore(this._wrapper,t)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},focus:function(){if(this._labelInput){this._labelInput.focus()}},prepareData:function(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";if(t===""){return null}var e={VALUE:t};var i=BX.prop.getInteger(this._data,"ID",0);if(i>0){e["ID"]=i}var n=BX.prop.getString(this._data,"XML_ID","");if(i>0){e["XML_ID"]=n}return e},onDeleteButtonClick:function(t){this._configurator.removeEnumerationItem(this)}};BX.Crm.EntityEditorUserFieldListItem.create=function(t,e){var i=new BX.Crm.EntityEditorUserFieldListItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserField==="undefined"){BX.Crm.EntityEditorUserField=function(){BX.Crm.EntityEditorUserField.superclass.constructor.apply(this);this._innerWrapper=null;this._isLoaded=false;this._focusOnLoad=false};BX.extend(BX.Crm.EntityEditorUserField,BX.Crm.EntityEditorField);BX.Crm.EntityEditorUserField.prototype.doInitialize=function(){BX.Crm.EntityEditorUserField.superclass.doInitialize.apply(this);this._manager=this._editor.getUserFieldManager()};BX.Crm.EntityEditorUserField.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorUserField.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorUserField.prototype.getFieldInfo=function(){return this._schemeElement.getDataParam("fieldInfo",{})};BX.Crm.EntityEditorUserField.prototype.getFieldType=function(){return BX.prop.getString(this.getFieldInfo(),"USER_TYPE_ID","")};BX.Crm.EntityEditorUserField.prototype.getFieldSettings=function(){return BX.prop.getObject(this.getFieldInfo(),"SETTINGS",{})};BX.Crm.EntityEditorUserField.prototype.isMultiple=function(){return BX.prop.getString(this.getFieldInfo(),"MULTIPLE","N")==="Y"};BX.Crm.EntityEditorUserField.prototype.getEntityValueId=function(){return BX.prop.getString(this.getFieldInfo(),"ENTITY_VALUE_ID","")};BX.Crm.EntityEditorUserField.prototype.getFieldValue=function(){var t=this.getValue();var e=BX.prop.getArray(t,"VALUE",null);if(e===null){e=BX.prop.getString(t,"VALUE","")}return e};BX.Crm.EntityEditorUserField.prototype.getFieldSignature=function(){return BX.prop.getString(this.getValue(),"SIGNATURE","")};BX.Crm.EntityEditorUserField.prototype.isTitleEnabled=function(){var t=this.getFieldInfo();var e=BX.prop.getString(t,"USER_TYPE_ID","");if(e!=="boolean"){return true}return BX.prop.getString(BX.prop.getObject(t,"SETTINGS",{}),"DISPLAY","")!=="CHECKBOX"};BX.Crm.EntityEditorUserField.prototype.getFieldNode=function(){return this._innerWrapper};BX.Crm.EntityEditorUserField.prototype.checkIfNotEmpty=function(t){if(BX.prop.getBoolean(t,"IS_EMPTY",false)){return false}var e;if(this.getFieldType()===BX.Crm.EntityUserFieldType.boolean){e=BX.prop.getString(t,"VALUE","");return e!==""&&e!=="0"}e=BX.prop.getArray(t,"VALUE",null);if(e===null){e=BX.prop.getString(t,"VALUE","")}return BX.type.isArray(e)?e.length>0:e!==""};BX.Crm.EntityEditorUserField.prototype.getValue=function(t){if(t===undefined){t=null}if(!this._model){return t}return this._model.getField(this.getName(),t)};BX.Crm.EntityEditorUserField.prototype.hasContentToDisplay=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){return true}return this.checkIfNotEmpty(this.getValue())};BX.Crm.EntityEditorUserField.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this.getTitle();var n=this.getFieldInfo();var r=this.getValue();var o=BX.prop.getString(r,"SIGNATURE","");this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var s=this.getFieldType();if(s===BX.Crm.EntityUserFieldType.string){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-text")}else if(s===BX.Crm.EntityUserFieldType.integer||s===BX.Crm.EntityUserFieldType.double){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-number")}else if(s===BX.Crm.EntityUserFieldType.money){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-money")}else if(s===BX.Crm.EntityUserFieldType.date||s===BX.Crm.EntityUserFieldType.datetime){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-date")}else if(s===BX.Crm.EntityUserFieldType.boolean){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-checkbox")}else if(s===BX.Crm.EntityUserFieldType.enumeration){BX.addClass(this._wrapper,this.isMultiple()?"crm-entity-widget-content-block-field-custom-multiselect":"crm-entity-widget-content-block-field-custom-select")}else if(s===BX.Crm.EntityUserFieldType.file){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-file")}else if(s===BX.Crm.EntityUserFieldType.url){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-link")}this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){if(this.isTitleEnabled()){this._wrapper.appendChild(this.createTitleNode(i))}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}})}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);if(this.hasContentToDisplay()){var a=BX.prop.getString(t,"html","");if(a!==""){this.setupContentHtml(a)}else{this._isLoaded=false;var l=null;if(!this.isInSingleEditMode()){l=BX.prop.get(t,"userFieldLoader",null)}if(!l){l=BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:this._mode,enableBatchMode:false})}var d=BX.clone(n);d["SIGNATURE"]=o;if(this.checkIfNotEmpty(r)){var h=BX.prop.getArray(r,"VALUE",null);if(h===null){h=BX.prop.getString(r,"VALUE","")}d["VALUE"]=h}this.adjustFieldParams(d);l.addItem({name:e,field:d,callback:BX.delegate(this.onLayoutLoaded,this)});l.run()}}else{this._innerWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}this._hasLayout=true};BX.Crm.EntityEditorUserField.prototype.doRegisterLayout=function(){};BX.Crm.EntityEditorUserField.prototype.adjustFieldParams=function(t){var e=this.getFieldType();if(e===BX.Crm.EntityUserFieldType.boolean){if(!BX.type.isPlainObject(t["SETTINGS"])){t["SETTINGS"]={}}t["SETTINGS"]["LABEL_CHECKBOX"]=this.getTitle()}if(typeof t["VALUE"]!=="undefined"&&this._mode===BX.Crm.EntityEditorMode.edit&&BX.prop.getInteger(t,"ENTITY_VALUE_ID")<=0){if(this._mode===BX.Crm.EntityEditorMode.edit&&BX.prop.getInteger(t,"ENTITY_VALUE_ID")<=0){t["ENTITY_VALUE_ID"]=1}}};BX.Crm.EntityEditorUserField.prototype.doClearLayout=function(t){this._innerWrapper=null};BX.Crm.EntityEditorUserField.prototype.validate=function(){return true};BX.Crm.EntityEditorUserField.prototype.save=function(){};BX.Crm.EntityEditorUserField.prototype.focus=function(){if(this._mode!==BX.Crm.EntityEditorMode.edit){return}if(this._isLoaded){this.doFocus()}else{this._focusOnLoad=true}};BX.Crm.EntityEditorUserField.prototype.doFocus=function(){BX.Main.UF.Factory.focus(this.getName())};BX.Crm.EntityEditorUserField.prototype.setupContentHtml=function(t){if(this._innerWrapper){BX.html(this._innerWrapper,t).then(BX.delegate(this.onLayoutSuccess,this));this._isLoaded=true;if(this._focusOnLoad===true){this.doFocus();this._focusOnLoad=false}}};BX.Crm.EntityEditorUserField.prototype.doSetActive=function(){if(!this._isActive){this._manager.unregisterActiveField(this)}};BX.Crm.EntityEditorUserField.prototype.rollback=function(){this._manager.unregisterActiveField(this)};BX.Crm.EntityEditorUserField.prototype.synchronize=function(){if(this.getFieldType()===BX.Crm.EntityUserFieldType.enumeration){window.setTimeout(function(){this._manager.synchronizeEnumeration(this.getName())}.bind(this),0)}};BX.Crm.EntityEditorUserField.prototype.onLayoutSuccess=function(){if(this._isActive){this._manager.registerActiveField(this)}BX.bindDelegate(this._innerWrapper,"bxchange",{tag:["input","select","textarea"]},this._changeHandler);if(this.getFieldType()===BX.Crm.EntityUserFieldType.employee){var t=this._innerWrapper.querySelector(".feed-add-destination-link");if(t){BX.bind(t,"click",BX.delegate(this.onEmployeeSelectorOpen,this))}}if(!this._hasLayout){this._hasLayout=true}BX.addCustomEvent(window,"onCrmEntityEditorUserFieldExternalChanged",BX.proxy(function(t){if(t==this._id&&BX.type.isFunction(this._changeHandler)){this._changeHandler()}},this));BX.addCustomEvent(window,"onCrmEntityEditorUserFieldSetValidator",BX.proxy(function(t,e){if(t==this._id&&BX.type.isFunction(e)){this.validate=e}},this))};BX.Crm.EntityEditorUserField.prototype.onLayoutLoaded=function(t){var e=BX.prop.getString(t,"HTML","");if(e!==""){this.setupContentHtml(e)}};BX.Crm.EntityEditorUserField.prototype.onEmployeeSelectorOpen=function(t){var e=BX.getEventTarget(t);if(!e){return}var i=e.id.match(/^add_user_([a-z_0-9-]+)/i);if(BX.type.isArray(i)&&i.length>1){var n=BX.Intranet.UserFieldEmployee.instance(i[1]);if(n){BX.addCustomEvent(n,"onUpdateValue",this._changeHandler)}}};BX.Crm.EntityEditorUserField.create=function(t,e){var i=new BX.Crm.EntityEditorUserField;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorProductRowSummary==="undefined"){BX.Crm.EntityEditorProductRowSummary=function(){BX.Crm.EntityEditorProductRowSummary.superclass.constructor.apply(this);this._loader=null;this._table=null;this._itemCount=0;this._totalCount=0;this._moreButton=null;this._moreButtonRow=null;this._moreButtonClickHandler=BX.delegate(this._onMoreButtonClick,this)};BX.extend(BX.Crm.EntityEditorProductRowSummary,BX.Crm.EntityEditorField);BX.Crm.EntityEditorProductRowSummary.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorProductRowSummary.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorProductRowSummary.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getValue();if(!BX.type.isPlainObject(e)){return}var i=BX.prop.getArray(e,"items",[]);this._totalCount=BX.prop.getInteger(e,"count",0);this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});this._table=BX.create("table",{props:{className:"crm-entity-widget-content-block-products-list"}});var n=this._itemCount=i.length;var r=0;if(n>5){r=this._totalCount-5;n=5}for(var o=0;o<n;o++){this.addProductRow(i[o],-1)}var s,a;this._moreButton=null;if(r>0){s=this._moreButtonRow=this._table.insertRow(-1);s.className="crm-entity-widget-content-block-products-item";a=s.insertCell(-1);a.className="crm-entity-widget-content-block-products-item-name";this._moreButton=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-products-show-more"},events:{click:this._moreButtonClickHandler},text:this.getMessage("notShown").replace(/#COUNT#/gi,r.toString())});a.appendChild(this._moreButton);a=s.insertCell(-1);a.className="crm-entity-widget-content-block-products-price"}s=this._table.insertRow(-1);s.className="crm-entity-widget-content-block-products-item";a=s.insertCell(-1);a.className="crm-entity-widget-content-block-products-item-name";a.innerHTML=this.getMessage("total");a=s.insertCell(-1);a.className="crm-entity-widget-content-block-products-price";a.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-products-price-value"},html:e["total"]}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-products"},children:[this._table]}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorProductRowSummary.prototype._onMoreButtonClick=function(t){if(this._totalCount>10){BX.onCustomEvent(window,"OpenEntityDetailTab",["tab_products"]);return}this._moreButtonRow.style.display="none";var e=this.getValue();var i=BX.prop.getArray(e,"items",[]);for(var n=5;n<this._itemCount;n++){this.addProductRow(i[n],n)}};BX.Crm.EntityEditorProductRowSummary.prototype.clearLayout=function(){if(!this._hasLayout){return}this._table=null;this._moreButton=null;this._moreButtonRow=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorProductRowSummary.prototype.addProductRow=function(t,e){if(typeof e==="undefined"){e=-1}var i,n;i=this._table.insertRow(e);i.className="crm-entity-widget-content-block-products-item";n=i.insertCell(-1);n.className="crm-entity-widget-content-block-products-item-name";var r=BX.prop.getString(t,"URL","");if(r!==""){n.appendChild(BX.create("a",{attrs:{target:"_blank",href:r},text:t["PRODUCT_NAME"]}))}else{n.innerHTML=BX.util.htmlspecialchars(t["PRODUCT_NAME"])}n=i.insertCell(-1);n.className="crm-entity-widget-content-block-products-price";n.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-products-price-value"},html:t["SUM"]}))};if(typeof BX.Crm.EntityEditorProductRowSummary.messages==="undefined"){BX.Crm.EntityEditorProductRowSummary.messages={}}BX.Crm.EntityEditorProductRowSummary.create=function(t,e){var i=new BX.Crm.EntityEditorProductRowSummary;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteSelector==="undefined"){BX.Crm.EntityEditorRequisiteSelector=function(){BX.Crm.EntityEditorRequisiteSelector.superclass.constructor.apply(this);this._requisiteId=0;this._bankDetailId=0;this._itemWrappers={};this._itemButtons={};this._itemBankDetailButtons={}};BX.extend(BX.Crm.EntityEditorRequisiteSelector,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRequisiteSelector.prototype.doInitialize=function(){this._requisiteId=this._model.getIntegerField("REQUISITE_ID",0);this._bankDetailId=this._model.getIntegerField("BANK_DETAIL_ID",0)};BX.Crm.EntityEditorRequisiteSelector.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRequisiteSelector.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRequisiteSelector.prototype.getPrefix=function(){return this._id.toLowerCase()+"_"};BX.Crm.EntityEditorRequisiteSelector.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getData();this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:this._requisiteId,bankDetailId:this._bankDetailId,data:BX.prop.getArray(e,"data",{})});var i=this._requisiteInfo.getItems();this._wrapper=BX.create("div",{props:{className:"crm-entity-requisites-slider-wrapper"}});var n=BX.create("div",{props:{className:"crm-entity-requisites-slider-content"}});this._wrapper.appendChild(n);var r=BX.create("div",{props:{className:"crm-entity-requisites-slider-widget-content"}});n.appendChild(r);var o=BX.create("div",{props:{className:"crm-entity-requisites-select-container"}});r.appendChild(o);for(var s=0,a=i.length;s<a;s++){o.appendChild(this.prepareItemLayout(i[s]))}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRequisiteSelector.prototype.getItemData=function(t){var e=this._requisiteInfo.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getInteger(r,"requisiteId",0)){return r}}return null};BX.Crm.EntityEditorRequisiteSelector.prototype.prepareItemLayout=function(t){var e=BX.prop.getObject(t,"viewData",null);if(!e){return}var i=BX.prop.getBoolean(t,"selected",false);var n=this.getPrefix();var r=BX.prop.getInteger(t,"requisiteId",0);var o=BX.create("label",{props:{className:"crm-entity-requisites-select-item"}});o.appendChild(BX.create("strong",{text:BX.prop.getString(e,"title","")}));if(i){BX.addClass(o,"crm-entity-requisites-select-item-selected")}this._itemWrappers[r]=o;var s,a;var l=BX.prop.getArray(e,"fields",[]);for(s=0,a=l.length;s<a;s++){var d=l[s];var h=BX.prop.getString(d,"title","");var p=BX.prop.getString(d,"textValue","");if(h!==""&&p!==""){o.appendChild(BX.create("br"));o.appendChild(BX.create("span",{text:h+": "+p}))}}var u=BX.create("input",{props:{type:"radio",name:n+"requisite",checked:i,className:"crm-entity-requisites-select-item-field"},attrs:{"data-requisiteid":r}});o.appendChild(u);this._itemButtons[r]=u;BX.bind(u,"change",BX.delegate(this.onItemChange,this));var c=BX.prop.getArray(t,"bankDetailViewDataList",[]);if(c.length>0){var m=BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-container"}});o.appendChild(m);m.appendChild(BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-title"},html:this.getMessage("bankDetails")}));var y=BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-field-container"}});m.appendChild(y);this._itemBankDetailButtons[r]={};for(s=0,a=c.length;s<a;s++){var g=c[s];var f=BX.prop.getInteger(g,"pseudoId",0);var _=BX.prop.getObject(g,"viewData",null);if(!_){continue}var E=i&&BX.prop.getBoolean(g,"selected",false);var C=BX.create("label",{props:{className:"crm-entity-requisites-select-item-bank-requisites-field-item"}});y.appendChild(C);var B=BX.create("input",{props:{type:"radio",name:n+"bankrequisite"+r,checked:E,className:"crm-entity-requisites-select-item-bank-requisites-field"},attrs:{"data-requisiteid":r,"data-bankdetailid":f}});C.appendChild(B);BX.bind(B,"change",BX.delegate(this.onItemBankDetailChange,this));this._itemBankDetailButtons[r][f]=B;C.appendChild(document.createTextNode(BX.prop.getString(_,"title","")))}o.appendChild(BX.create("span",{style:{display:"block",clear:"both"}}))}return o};BX.Crm.EntityEditorRequisiteSelector.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._itemWrappers={};this._itemButtons={};this._itemBankDetailButtons={};this._hasLayout=false};BX.Crm.EntityEditorRequisiteSelector.prototype.save=function(){this._model.setField("REQUISITE_ID",this._requisiteId,{originator:this});this._model.setField("BANK_DETAIL_ID",this._bankDetailId,{originator:this})};BX.Crm.EntityEditorRequisiteSelector.prototype.onItemChange=function(t){var e=BX.getEventTarget(t);if(!e.checked){return}var i=parseInt(e.getAttribute("data-requisiteid"));if(isNaN(i)||i<=0){return}this._requisiteId=i;this._bankDetailId=0;var n=this.getItemData(this._requisiteId);var r=BX.prop.getArray(n,"bankDetailViewDataList",[]);for(var o=0,s=r.length;o<s;o++){var a=r[o];var l=BX.prop.getInteger(a,"pseudoId",0);if(l>0&&BX.prop.getBoolean(a,"selected",false)){this._bankDetailId=l;break}}for(var d in this._itemWrappers){if(!this._itemWrappers.hasOwnProperty(d)){continue}var h=this._itemWrappers[d];var p=this._requisiteId===parseInt(d);if(p){BX.addClass(h,"crm-entity-requisites-select-item-selected")}else{BX.removeClass(h,"crm-entity-requisites-select-item-selected")}if(this._itemButtons.hasOwnProperty(d)){var u=this._itemButtons[d];if(u.checked!==p){u.checked=p}}if(this._itemBankDetailButtons.hasOwnProperty(d)){var c=this._itemBankDetailButtons[d];for(var m in c){if(!c.hasOwnProperty(m)){continue}var y=p&&this._bankDetailId===parseInt(m);var g=c[m];if(g.checked!==y){g.checked=y}}}}this.markAsChanged()};BX.Crm.EntityEditorRequisiteSelector.prototype.onItemBankDetailChange=function(t){var e=BX.getEventTarget(t);if(!e.checked){return}var i=parseInt(e.getAttribute("data-requisiteid"));if(isNaN(i)||i<=0){return}if(this._requisiteId!==i){return}var n=parseInt(e.getAttribute("data-bankdetailid"));if(isNaN(n)||n<=0){return}this._bankDetailId=n};if(typeof BX.Crm.EntityEditorRequisiteSelector.messages==="undefined"){BX.Crm.EntityEditorRequisiteSelector.messages={}}BX.Crm.EntityEditorRequisiteSelector.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteSelector;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteListItem==="undefined"){BX.Crm.EntityEditorRequisiteListItem=function(){this._id="";this._settings=null;this._owner=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._data=null;this._requisiteId=0;this._container=null;this._wrapper=null;this._innerWrapper=null;this._editButton=null;this._deleteButton=null;this._hasLayout=false};BX.Crm.EntityEditorRequisiteListItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=BX.type.isPlainObject(e)?e:{};this._owner=BX.prop.get(this._settings,"owner",null);this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.intermediate);this._data=BX.prop.getObject(this._settings,"data",{});this._requisiteId=BX.prop.getInteger(this._data,"requisiteId",0);this._container=BX.prop.getElementNode(this._settings,"container")},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityEditorRequisiteListItem.messages,t,t)},getRequisiteId:function(){return this._requisiteId},getData:function(){return this._data},setData:function(t){this._data=t},layout:function(t){if(this._hasLayout){return}var e=BX.prop.getObject(this._data,"viewData",null);if(!e){e={}}var i=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-container crm-entity-widget-client-requisites-container-opened"}});this._innerWrapper=BX.create("dl",{props:{className:"crm-entity-widget-client-requisites-list"}});this.prepareViewLayout(e,["RQ_ADDR"]);this.prepareFieldViewLayout(e,"RQ_ADDR");var n=BX.prop.getArray(this._data,"bankDetailViewDataList",[]);for(var r=0,o=n.length;r<o;r++){var s=n[r];if(!BX.prop.getBoolean(s,"isDeleted",false)){this.prepareViewLayout(BX.prop.getObject(s,"viewData",null),[])}}if(!i){this._deleteButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-remove-icon"},events:{click:BX.delegate(this.onRemoveButtonClick,this)}});this._editButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-edit-icon"},events:{click:BX.delegate(this.onEditButtonClick,this)}})}this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-inner-container"},children:[this._deleteButton,this._editButton,this._innerWrapper]}));var a=BX.prop.getElementNode(t,"anchor",null);if(a){this._container.insertBefore(this._wrapper,a)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},prepareViewLayout:function(t,e){if(!t){return}var i=BX.prop.getString(t,"title","");if(i!==""){this._innerWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:i}))}var n,r;var o={};if(BX.type.isArray(e)){for(n=0,r=e.length;n<r;n++){o[e[n]]=true}}var s=[];var a=BX.prop.getArray(t,"fields",[]);for(n=0,r=a.length;n<r;n++){var l=a[n];var d=BX.prop.getString(l,"name","");if(o.hasOwnProperty(d)){continue}var h=BX.prop.getString(l,"title","");var p=BX.prop.getString(l,"textValue","");if(h!==""&&p!==""){s.push(h+": "+p)}}this._innerWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:s.join(", ")}))},prepareFieldViewLayout:function(t,e){if(!t){return}var i=BX.prop.getArray(t,"fields",[]);for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"name","");if(s!==e){continue}var a=BX.prop.getString(o,"title","");var l=BX.prop.getString(o,"textValue","");if(a===""||l===""){continue}this._innerWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:a}));this._innerWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:l}))}},clearLayout:function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._innerWrapper=null;this._editButton=null;this._deleteButton=null;this._hasLayout=false},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getWrapper:function(){return this._wrapper},prepareData:function(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";if(t===""){return null}var e={VALUE:t};var i=BX.prop.getInteger(this._data,"ID",0);if(i>0){e["ID"]=i}var n=BX.prop.getString(this._data,"XML_ID","");if(i>0){e["XML_ID"]=n}return e},onEditButtonClick:function(t){this._owner.onEditItem(this)},onRemoveButtonClick:function(t){var e=BX.Crm.EditorAuxiliaryDialog.create(this._id,{title:this.getMessage("deleteTitle"),content:this.getMessage("deleteConfirm"),buttons:[{id:"accept",type:BX.Crm.DialogButtonType.accept,text:BX.message("CRM_EDITOR_DELETE"),callback:BX.delegate(this.onRemovalConfirmationDialogButtonClick,this)},{id:"cancel",type:BX.Crm.DialogButtonType.cancel,text:BX.message("CRM_EDITOR_CANCEL"),callback:BX.delegate(this.onRemovalConfirmationDialogButtonClick,this)}]});e.open();this._owner.onOpenItemRemovalConfirmation(this)},onRemovalConfirmationDialogButtonClick:function(t){var e=t.getDialog();if(t.getId()==="accept"){this._owner.onRemoveItem(this)}e.close();this._owner.onCloseItemRemovalConfirmation(this)}};if(typeof BX.Crm.EntityEditorRequisiteListItem.messages==="undefined"){BX.Crm.EntityEditorRequisiteListItem.messages={}}BX.Crm.EntityEditorRequisiteListItem.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteListItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteList==="undefined"){BX.Crm.EntityEditorRequisiteList=function(){BX.Crm.EntityEditorRequisiteList.superclass.constructor.apply(this);this._items=null;this._data=null;this._externalContext=null;this._externalEventHandler=null;this._createButton=null;this._dataInputs={};this._dataSignInputs={};this._itemWrapper=null;this._dataWrapper=null;this._isPresetMenuOpened=false;this._newItemIndex=-1;this._sliderUrls={}};BX.extend(BX.Crm.EntityEditorRequisiteList,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRequisiteList.prototype.doInitialize=function(){this.initializeFromModel()};BX.Crm.EntityEditorRequisiteList.prototype.initializeFromModel=function(){var t=this.getValue();this._data=BX.type.isArray(t)?BX.clone(t,true):[];var e,i;for(e=0,i=this._data.length;e<i;e++){this.prepareRequisiteData(this._data[e])}this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._data})};BX.Crm.EntityEditorRequisiteList.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.initializeFromModel();this.refreshLayout()};BX.Crm.EntityEditorRequisiteList.prototype.reset=function(){this.initializeFromModel();for(var t in this._sliderUrls){if(this._sliderUrls.hasOwnProperty(t)){BX.Crm.Page.closeSlider(this._sliderUrls[t])}}this._sliderUrls={}};BX.Crm.EntityEditorRequisiteList.prototype.rollback=function(){if(this.isChanged()){this.reset()}};BX.Crm.EntityEditorRequisiteList.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorRequisiteList.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRequisiteList.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorRequisiteList.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorRequisiteList.prototype.prepareDataInputName=function(t,e){return this.getName()+"["+t.toString()+"]"+"["+e+"]"};BX.Crm.EntityEditorRequisiteList.prototype.prepareRequisiteData=function(t){var e=BX.prop.getInteger(t,"requisiteId",0);var i=BX.prop.getString(t,"pseudoId","");if(e>0){t["key"]=e.toString();t["isNew"]=false;t["isChanged"]=BX.prop.getBoolean(t,"isChanged",false)}else{t["key"]=i;t["isNew"]=true;t["isChanged"]=BX.prop.getBoolean(t,"isChanged",true)}t["isDeleted"]=false};BX.Crm.EntityEditorRequisiteList.prototype.findRequisiteDataIndexByKey=function(t){for(var e=0,i=this._data.length;e<i;e++){if(BX.prop.getString(this._data[e],"key",0)===t){return e}}return-1};BX.Crm.EntityEditorRequisiteList.prototype.getRequisiteDataByKey=function(t){var e=this.findRequisiteDataIndexByKey(t);return e>=0?this._data[e]:null};BX.Crm.EntityEditorRequisiteList.prototype.setupRequisiteData=function(t){var e=BX.prop.getString(t,"key","");if(e===""){return}var i=this.findRequisiteDataIndexByKey(e);if(i>=0){this._data[i]=t}else{this._data.push(t)}this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._data})};BX.Crm.EntityEditorRequisiteList.prototype.refreshRequisiteDataInputs=function(){if(!this._hasLayout){return}BX.cleanNode(this._dataWrapper);for(var t=0,e=this._data.length;t<e;t++){var i=this._data[t];var n=BX.prop.getString(i,"key","");if(n===""){continue}var r=BX.prop.getBoolean(i,"isChanged",false);var o=BX.prop.getBoolean(i,"isDeleted",false);if(!r&&!o){continue}if(o){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"DELETED"),value:"Y"}}))}else{var s=BX.prop.getString(i,"requisiteDataSign","");if(s!==""){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"SIGN"),value:s}}))}var a=BX.prop.getString(i,"requisiteData","");if(a!==""){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"DATA"),value:a}}))}}}};BX.Crm.EntityEditorRequisiteList.prototype.hasContentToDisplay=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){return true}return this._requisiteInfo&&this._requisiteInfo.getItems().length>0};BX.Crm.EntityEditorRequisiteList.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();this._items=[];if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}var e,i;var n=this._requisiteInfo.getItems();for(e=0,i=n.length;e<i;e++){var r=n[e];var o=BX.Crm.EntityEditorRequisiteListItem.create(BX.prop.getString(r,"key",""),{owner:this,mode:this._mode,data:r});this._items.push(o)}if(this.isInEditMode()){this._dataWrapper=BX.create("div");this._wrapper.appendChild(this._dataWrapper);this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-requisites"}});this._wrapper.appendChild(this._itemWrapper);for(e=0,i=this._items.length;e<i;e++){this._items[e].setContainer(this._itemWrapper);this._items[e].layout()}this._createButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-add-btn"},text:BX.message("CRM_EDITOR_ADD")});this._itemWrapper.appendChild(this._createButton);BX.bind(this._createButton,"click",BX.delegate(this.onCreateButtonClick,this))}else{this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-colums-block"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._itemWrapper]}));this._wrapper.appendChild(this._itemWrapper);for(e=0,i=this._items.length;e<i;e++){this._items[e].setContainer(this._itemWrapper);this._items[e].layout()}}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRequisiteList.prototype.doClearLayout=function(t){if(this._items){for(var e=0,i=this._items.length;e<i;e++){this._items[e].clearLayout()}}this._items=[];this._itemWrapper=null;this._createButton=null};BX.Crm.EntityEditorRequisiteList.prototype.getItemByIndex=function(t){return t>=0&&t<=this._items.length-1?this._items[t]:null};BX.Crm.EntityEditorRequisiteList.prototype.getItemById=function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getId()===t){return n}}return null};BX.Crm.EntityEditorRequisiteList.prototype.getItemCount=function(){return this._items.length};BX.Crm.EntityEditorRequisiteList.prototype.getItemIndex=function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorRequisiteList.prototype.removeItemByIndex=function(t){if(t<this._items.length){this._items.splice(t,1)}};BX.Crm.EntityEditorRequisiteList.prototype.removeItem=function(t){var e=this.getItemIndex(t);if(e<0){return}var i=this.getRequisiteDataByKey(t.getId());if(i){i["isDeleted"]=true}t.clearLayout();this.removeItemByIndex(e);this.refreshRequisiteDataInputs();this.markAsChanged()};BX.Crm.EntityEditorRequisiteList.prototype.openEditor=function(t){var e=BX.prop.getInteger(t,"requisiteId",0);var i=this._editor.getContextId();var n={etype:this._editor.getEntityTypeId(),eid:this._editor.getEntityId(),external_context_id:i};var r=BX.prop.getInteger(t,"presetId",0);if(r>0){n["pid"]=r}var o="";if(e<=0){this._newItemIndex++;o="n"+this._newItemIndex.toString();n["pseudo_id"]=o}var s=BX.util.add_url_param(this._editor.getRequisiteEditUrl(e),n);if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}if(e>0){this._externalContext[e]={requisiteId:e,url:s}}else{this._externalContext[o]={pseudoId:o,url:s}}if(e>0){this._sliderUrls[e]=s}BX.Crm.Page.openSlider(s,{width:950})};BX.Crm.EntityEditorRequisiteList.prototype.onEditItem=function(t){this.openEditor({requisiteId:t.getRequisiteId()})};BX.Crm.EntityEditorRequisiteList.prototype.onRemoveItem=function(t){this.removeItem(t)};BX.Crm.EntityEditorRequisiteList.prototype.onOpenItemRemovalConfirmation=function(t){if(this._singleEditController){this._singleEditController.setActiveDelayed(false)}};BX.Crm.EntityEditorRequisiteList.prototype.onCloseItemRemovalConfirmation=function(t){if(this._singleEditController){this._singleEditController.setActiveDelayed(true)}};BX.Crm.EntityEditorRequisiteList.prototype.onExternalEvent=function(t){var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";if(e!=="BX.Crm.RequisiteSliderEditor:onSave"){return}var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=BX.prop.getString(i,"context","");if(n!==this._editor.getContextId()){return}var r=BX.prop.getInteger(i,"presetId",0);var o=BX.prop.getString(i,"pseudoId","");var s=BX.prop.getInteger(i,"requisiteId",0);var a=BX.prop.getString(i,"requisiteDataSign","");var l=BX.prop.getString(i,"requisiteData","");var d={entityTypeId:this._editor.getEntityTypeId(),entityId:this._editor.getEntityId(),presetId:r,pseudoId:o,requisiteId:s,requisiteData:l,requisiteDataSign:a,isChanged:true};this.prepareRequisiteData(d);this.setupRequisiteData(d);this.refreshRequisiteDataInputs();this.markAsChanged();var h=BX.prop.getString(d,"key","");var p=BX.prop.getObject(this._externalContext,h,null);if(!p){return}var u=this.getItemById(h);var c;if(u){u.setData(d);u.clearLayout();c={};var m=this.getItemIndex(u);if(m<this.getItemCount()-1){c["anchor"]=this.getItemByIndex(m+1).getWrapper()}else if(this._createButton){c["anchor"]=this._createButton}u.layout(c)}else{u=BX.Crm.EntityEditorRequisiteListItem.create(h,{owner:this,mode:this._mode,data:d,container:this._itemWrapper});this._items.push(u);c={};if(this._createButton){c["anchor"]=this._createButton}u.layout(c)}var y=BX.prop.getString(p,"url","");if(y!==""){BX.Crm.Page.closeSlider(y,true)}delete this._externalContext[s]};BX.Crm.EntityEditorRequisiteList.prototype.onCreateButtonClick=function(t){this.togglePresetMenu()};BX.Crm.EntityEditorRequisiteList.prototype.togglePresetMenu=function(){if(this._isPresetMenuOpened){this.closePresetMenu()}else{this.openPresetMenu()}};BX.Crm.EntityEditorRequisiteList.prototype.openPresetMenu=function(){if(this._isPresetMenuOpened){return}var t=[];var e=BX.prop.getArray(this._schemeElement.getData(),"presets");for(var i=0,n=e.length;i<n;i++){var r=e[i];var o=BX.prop.getString(r,"VALUE",i);var s=BX.prop.getString(r,"NAME",o);t.push({text:s,value:o,onclick:BX.delegate(this.onPresetSelect,this)})}BX.PopupMenu.show(this._id,this._createButton,t,{angle:false,events:{onPopupShow:BX.delegate(this.onPresetMenuShow,this),onPopupClose:BX.delegate(this.onPresetMenuClose,this)}})};BX.Crm.EntityEditorRequisiteList.prototype.closePresetMenu=function(){if(!this._isPresetMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorRequisiteList.prototype.onPresetMenuShow=function(){this._isPresetMenuOpened=true};BX.Crm.EntityEditorRequisiteList.prototype.onPresetMenuClose=function(){BX.PopupMenu.destroy(this._id);this._isPresetMenuOpened=false};BX.Crm.EntityEditorRequisiteList.prototype.onPresetSelect=function(t,e){this.openEditor({presetId:e.value});this.closePresetMenu()};BX.Crm.EntityEditorRequisiteList.prototype.save=function(){};if(typeof BX.Crm.EntityEditorRequisiteList.messages==="undefined"){BX.Crm.EntityEditorRequisiteList.messages={}}BX.Crm.EntityEditorRequisiteList.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteList;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityRequisitePanel==="undefined"){BX.Crm.ClientEditorEntityRequisitePanel=function(){this._id="";this._settings={};this._editor=null;this._entityInfo=null;this._requisiteInfo=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._selectedRequisiteId=0;this._selectedBankDetailId=0;this._container=null;this._wrapper=null;this._contentWrapper=null;this._requisiteInput=null;this._bankDetailInput=null;this._toggleButton=null;this._editButton=null;this._toggleButtonHandler=BX.delegate(this.onToggleButtonClick,this);this._editButtonHandler=BX.delegate(this.onEditButtonClick,this);this._isExpanded=false;this._hasLayout=false;this._externalEventHandler=BX.delegate(this.onExternalEvent,this);this._changeNotifier=null};BX.Crm.ClientEditorEntityRequisitePanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._container=BX.prop.getElementNode(this._settings,"container",null);this._mode=BX.prop.getInteger(this._settings,"mode",0);this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._requisiteInfo=BX.prop.get(this._settings,"requisiteInfo",null);this._selectedRequisiteId=this._requisiteInfo.getRequisiteId();this._selectedBankDetailId=this._requisiteInfo.getBankDetailId();this._changeNotifier=BX.CrmNotifier.create(this);if(BX.Crm.ClientEditorEntityRequisitePanel.options.hasOwnProperty(this._id)){this._isExpanded=BX.prop.getBoolean(BX.Crm.ClientEditorEntityRequisitePanel.options[this._id],"expanded",false)}},getMessage:function(t){var e=BX.Crm.ClientEditorEntityRequisitePanel.messages;return e.hasOwnProperty(t)?e[t]:t},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isExpanded:function(){return this._isExpanded},setExpanded:function(t){t=!!t;if(this._isExpanded===t){return}this._isExpanded=t;if(!BX.Crm.ClientEditorEntityRequisitePanel.options.hasOwnProperty(this._id)){BX.Crm.ClientEditorEntityRequisitePanel.options[this._id]={}}BX.Crm.ClientEditorEntityRequisitePanel.options[this._id]["expanded"]=this._isExpanded;if(t){BX.addClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}else{BX.removeClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}},toggle:function(){this.setExpanded(!this._isExpanded)},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},layout:function(){if(this._hasLayout){return}var t=null;var e=null;var i=this._selectedRequisiteId;var n=this._selectedBankDetailId;if(i>0){t=this._requisiteInfo.getItemById(i)}if(!t){t=this._requisiteInfo.getSelectedItem()}if(!t){t=this._requisiteInfo.getFirstItem()}if(t){if(n>0){e=this._requisiteInfo.getItemBankDetailById(i,n)}if(!e){e=this._requisiteInfo.getSelectedItemBankDetail(i)}if(!e){e=this._requisiteInfo.getFirstItemBankDetail(i)}}var r=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-container"}});this._container.appendChild(this._wrapper);if(this._isExpanded){BX.addClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}if(!r){this._requisiteInput=BX.create("input",{props:{type:"hidden",name:"REQUISITE_ID",value:i}});this._wrapper.appendChild(this._requisiteInput);this._bankDetailInput=BX.create("input",{props:{type:"hidden",name:"BANK_DETAIL_ID",value:n}});this._wrapper.appendChild(this._bankDetailInput)}if(t){this._toggleButton=BX.create("a",{props:{className:"crm-entity-widget-client-requisites-show-btn"},text:this.getMessage("toggle").toLowerCase()});this._wrapper.appendChild(this._toggleButton);BX.bind(this._toggleButton,"click",this._toggleButtonHandler);var o=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-inner-container"}});this._wrapper.appendChild(o);if(!r){this._editButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-edit-icon"}});this._editButton.setAttribute("data-editor-control-type","button");o.appendChild(this._editButton);BX.bind(this._editButton,"click",this._editButtonHandler)}this._contentWrapper=BX.create("dl",{props:{className:"crm-entity-widget-client-requisites-list"}});o.appendChild(this._contentWrapper);var s=BX.prop.getObject(t,"viewData",null);this.prepareItemView(s,["RQ_ADDR"]);this.prepareItemFieldView(s,"RQ_ADDR");if(e){this.prepareItemView(BX.prop.getObject(e,"viewData",null))}}this._hasLayout=true},prepareItemView:function(t,e){if(!t){return}var i=BX.prop.getString(t,"title","");if(i!==""){this._contentWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:i}))}var n,r;var o={};if(BX.type.isArray(e)){for(n=0,r=e.length;n<r;n++){o[e[n]]=true}}var s=[];var a=BX.prop.getArray(t,"fields",[]);for(n=0,r=a.length;n<r;n++){var l=a[n];var d=BX.prop.getString(l,"name","");if(o.hasOwnProperty(d)){continue}var h=BX.prop.getString(l,"title","");var p=BX.prop.getString(l,"textValue","");if(h!==""&&p!==""){s.push(h+": "+p)}}this._contentWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:s.join(", ")}))},prepareItemFieldView:function(t,e){if(!t){return}var i=BX.prop.getArray(t,"fields",[]);for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"name","");if(s!==e){continue}var a=BX.prop.getString(o,"title","");var l=BX.prop.getString(o,"textValue","");if(a===""||l===""){continue}this._contentWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:a}));this._contentWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:l}))}},clearLayout:function(){if(!this._hasLayout){return}if(this._toggleButton){BX.unbind(this._toggleButton,"click",this._toggleButtonHandler);this._toggleButton=null}if(this._editButton){BX.unbind(this._editButton,"click",this._editButtonHandler);this._editButton=null}this._isExpanded=false;this._requisiteInput=null;this._bankDetailInput=null;this._contentWrapper=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},refreshLayout:function(){var t=this.isExpanded();this.clearLayout();this.layout();this.setExpanded(t)},getRuntimeValue:function(){return{REQUISITE_ID:this._selectedRequisiteId,BANK_DETAIL_ID:this._selectedBankDetailId}},onToggleButtonClick:function(t){this.toggle();return BX.eventReturnFalse(t)},onEditButtonClick:function(t){if(!this._editor){return}var e=BX.prop.getString(this._settings,"requisiteSelectUrl","");if(e===""&&BX.type.isFunction(this._editor.getEntityRequisiteSelectUrl)){e=this._editor.getEntityRequisiteSelectUrl(this._entityInfo.getTypeName(),this._entityInfo.getId())}if(e!==""){e=BX.util.add_url_param(e,{external_context_id:this._editor.getContextId(),requisite_id:this._selectedRequisiteId,bank_detail_id:this._selectedBankDetailId});BX.Crm.Page.openSlider(e);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}BX.eventCancelBubble(t)},onExternalEvent:function(t){if(this._mode===BX.Crm.EntityEditorMode.view){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};if(!(this._editor&&this._editor.getContextId()===BX.prop.getString(i,"context"))){return}if(e==="BX.Crm.EntityRequisiteSelector:onCancel"){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}else if(e==="BX.Crm.EntityRequisiteSelector:onSave"){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler);var n=BX.prop.getInteger(i,"requisiteId");if(n>0){this._selectedRequisiteId=n;if(this._requisiteInput){this._requisiteInput.value=this._selectedRequisiteId}}var r=BX.prop.getInteger(i,"bankDetailId");if(r){this._selectedBankDetailId=r;if(this._bankDetailInput){this._bankDetailInput.value=this._selectedBankDetailId}}this._changeNotifier.notify([{requisiteId:this._selectedRequisiteId,bankDetailId:this._selectedBankDetailId}]);this.refreshLayout()}}};if(typeof BX.Crm.ClientEditorEntityRequisitePanel.messages==="undefined"){BX.Crm.ClientEditorEntityRequisitePanel.messages={}}BX.Crm.ClientEditorEntityRequisitePanel.options={};BX.Crm.ClientEditorEntityRequisitePanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityRequisitePanel;i.initialize(t,e);return i}}if(typeof BX.Crm.RequisiteNavigator==="undefined"){BX.Crm.RequisiteNavigator=function(){this._id=null;this._settings={};this._requisite=null;this._bankDetail=null;this._bankDetailList=null;this._closingNotifier=null;this._nextButton=null;this._nextButtonHandler=BX.delegate(this.onNextButtonClick,this);this._wrapper=null;this._innerWrapper=null;this._titleContainer=null;this._contentContainer=null;this._bankDetailContainer=null;this._popup=null;this._isOpened=false;this._isExpanded=true;this._hasLayout=false};BX.Crm.RequisiteNavigator.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._requisiteInfo=BX.prop.get(e,"requisiteInfo");var i=this._requisiteInfo.getRequisiteId();var n=this._requisiteInfo.getBankDetailId();this._requisite=i>0?this._requisiteInfo.getItemById(i):null;if(!this._requisite){this._requisite=this._requisiteInfo.getSelectedItem()}if(!this._requisite){this._requisite=this._requisiteInfo.getFirstItem()}if(this._requisite){this._bankDetailList=this._requisiteInfo.getItemBankDetailList(i);if(this._bankDetailList){if(n>0){this._bankDetail=this._bankDetailList.getItemById(n)}if(!this._bankDetail){this._bankDetail=this._bankDetailList.getSelectedItem()}if(!this._bankDetail){this._bankDetail=this._bankDetailList.getFirstItem()}}}this._closingNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.RequisiteNavigator.messages,t,t)},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},isOpened:function(){return this._isOpened},open:function(t){if(this._isOpened){return}var e=0,i=0;if(BX.type.isElementNode(t)){e=t.offsetWidth+15;i=-(t.offsetHeight+30)}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,offsetLeft:e,offsetTop:i,noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.prepareContent()});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-wrap"}});this._titleContainer=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-box"}});this._wrapper.appendChild(this._titleContainer);this._requisiteTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-wrapper"}});this._titleContainer.appendChild(this._requisiteTitleWrapper);this._nextButton=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-arrow-right"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-requisites-arrow-right-item"}})]});this._titleContainer.appendChild(this._nextButton);BX.bind(this._nextButton,"click",this._nextButtonHandler);this._contentWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-box crm-entity-widget-client-requisites-box-active"}});this._wrapper.appendChild(this._contentWrapper);this._contentInnerWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-box-inner"}});this._contentWrapper.appendChild(this._contentInnerWrapper);this._requisiteWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list-container"}});this._contentInnerWrapper.appendChild(this._requisiteWrapper);this._bankDetailWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list-container"}});this._contentInnerWrapper.appendChild(this._bankDetailWrapper);this.renderRequisites();return this._wrapper},renderTitleFields:function(t,e){for(var i=0,n=t.length;i<n;i++){var r=t[i];var o=BX.prop.getString(r,"title","");var s=BX.prop.getString(r,"textValue","");if(o===""||s===""){continue}e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-desc"},text:o}));e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-content"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-content-item"},text:s})]}))}},renderContentFields:function(t,e,i){var n=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list"}});i.appendChild(n);var r=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-item"}});n.appendChild(r);r.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-name"},text:e}));var o=[];for(var s=0,a=t.length;s<a;s++){var l=t[s];var d=BX.prop.getString(l,"title","");var h=BX.prop.getString(l,"textValue","");if(d!==""&&h!==""){o.push(d+": "+h)}}if(o.length>0){r.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-value"},text:o.join(", ")}))}else{BX.addClass(n,"crm-entity-widget-client-requisites-empty-value");r.appendChild(document.createTextNode(this.getMessage("stub")))}},renderRequisites:function(){BX.cleanNode(this._requisiteTitleWrapper);BX.cleanNode(this._requisiteWrapper);this._nextButton.style.display=this._requisiteInfo.getItemCount()>1?"":"none";if(this._requisite){var t=BX.prop.getObject(this._requisite,"viewData",{});var e=BX.prop.getArray(t,"fields",[]);var i=[];var n=[];for(var r=0,o=e.length;r<o;r++){var s=e[r];var a=BX.prop.getString(s,"name","");if(a==="RQ_ADDR"){i.push(s)}else{n.push(s)}}this._requisiteTitleWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-title"},text:BX.prop.getString(t,"title","")}));this.renderTitleFields(i,this._requisiteTitleWrapper);this.renderContentFields(n,"",this._requisiteWrapper);this.renderBankDetails()}},renderBankDetails:function(){BX.cleanNode(this._bankDetailWrapper);if(this._bankDetailList&&this._bankDetail){var t=BX.prop.getObject(this._bankDetail,"viewData",{});this.renderContentFields(BX.prop.getArray(t,"fields",[]),BX.prop.getString(t,"title",""),this._bankDetailWrapper);var e=this._bankDetailList.getItemCount();if(e>1){var i=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-box"}});this._bankDetailWrapper.appendChild(i);i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-value"},text:this.getMessage("legend").replace(/#NUMBER#/gi,this._bankDetailList.getItemIndex(this._bankDetail)+1).toString().replace(/#TOTAL#/gi,e.toString())}));i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-btn"},html:this.getMessage("next")+"&rarr;",events:{click:BX.delegate(this.onNextBankDetailButtonClick,this)}}))}}},getSelectedItemId:function(){return this._requisite?BX.CrmEntityRequisiteInfo.resolveItemId(this._requisite):0},getSelectedBankDetailId:function(){return this._bankDetail?BX.CrmEntityBankDetailList.resolveItemId(this._bankDetail):0},showNextItem:function(){if(!(this._requisiteInfo&&this._requisite)){return}var t=this._requisiteInfo.getItemCount();if(t===0){return}var e=this._requisiteInfo.getItemIndex(this._requisite);if(e<0){e=0}e++;if(e===t){e=0}this._requisite=this._requisiteInfo.getItemByIndex(e);if(this._requisite){var i=BX.CrmEntityRequisiteInfo.resolveItemId(this._requisite);this._bankDetailList=this._requisiteInfo.getItemBankDetailList(i);if(this._bankDetailList){this._bankDetail=this._bankDetailList.getSelectedItem();if(!this._bankDetail){this._bankDetail=this._bankDetailList.getFirstItem()}}}this.renderRequisites()},showNextBankDetail:function(){if(!(this._bankDetailList&&this._bankDetail)){return}var t=this._bankDetailList.getItemCount();if(t===0){return}var e=this._bankDetailList.getItemIndex(this._bankDetail);if(e<0){e=0}e++;if(e===t){e=0}this._bankDetail=this._bankDetailList.getItemByIndex(e);this.renderBankDetails()},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){if(this._popup){this._popup.destroy()}this._closingNotifier.notify([{requisiteId:this.getSelectedItemId(),bankDetailId:this.getSelectedBankDetailId()}])},onPopupDestroy:function(){this._isOpened=false;this._wrapper=null;this._innerWrapper=null;this._popup=null},onNextButtonClick:function(t){this.showNextItem()},onNextBankDetailButtonClick:function(t){this.showNextBankDetail()}};BX.Crm.RequisiteNavigator.options={};if(typeof BX.Crm.RequisiteNavigator.messages==="undefined"){BX.Crm.RequisiteNavigator.messages={}}BX.Crm.RequisiteNavigator.create=function(t,e){var i=new BX.Crm.RequisiteNavigator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFileStorage==="undefined"){BX.Crm.EntityEditorFileStorage=function(){BX.Crm.EntityEditorFileStorage.superclass.constructor.apply(this);this._uploaderName="entity_editor_storage_"+this._id.toLowerCase();this._dataContainer=null;this._uploaderContainer=null};BX.extend(BX.Crm.EntityEditorFileStorage,BX.Crm.EntityEditorField);BX.Crm.EntityEditorFileStorage.prototype.getStorageTypeId=function(){return this._model.getIntegerField("STORAGE_TYPE_ID",BX.Crm.EditorFileStorageType.undefined)};BX.Crm.EntityEditorFileStorage.prototype.getStorageElementInfos=function(){var t=this.getStorageTypeId();if(t===BX.Crm.EditorFileStorageType.diskfile){return this._model.getArrayField(this._schemeElement.getDataStringParam("diskFileInfo","DISK_FILES"),[])}return[]};BX.Crm.EntityEditorFileStorage.prototype.hasContentToDisplay=function(){return this.getStorageElementInfos().length>0};BX.Crm.EntityEditorFileStorage.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-filestorage"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(this._mode===BX.Crm.EntityEditorMode.edit){this._dataContainer=BX.create("DIV",{});this._wrapper.appendChild(this._dataContainer)}this._uploaderContainer=BX.create("DIV",{attrs:{className:"bx-crm-dialog-activity-webdav-container"}});this._wrapper.appendChild(this._uploaderContainer);var e=this.getStorageTypeId();if(e===BX.Crm.EditorFileStorageType.diskfile){var i=this.prepareDiskUploader();i.setMode(this._mode);i.clearValues();i.setValues(this.getStorageElementInfos());i.layout(this._uploaderContainer)}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorFileStorage.prototype.doClearLayout=function(t){this._dataContainer=this._uploaderContainer=null};BX.Crm.EntityEditorFileStorage.prototype.prepareDiskUploader=function(){var t=null;if(typeof BX.CrmDiskUploader!=="undefined"&&typeof BX.CrmDiskUploader.items[this._uploaderName]!=="undefined"){t=BX.CrmDiskUploader.items[this._uploaderName]}if(t){t.cleanLayout()}else{t=BX.CrmDiskUploader.create(this._uploaderName,{msg:{diskAttachFiles:this.getMessage("diskAttachFiles"),diskAttachedFiles:this.getMessage("diskAttachedFiles"),diskSelectFile:this.getMessage("diskSelectFile"),diskSelectFileLegend:this.getMessage("diskSelectFileLegend"),diskUploadFile:this.getMessage("diskUploadFile"),diskUploadFileLegend:this.getMessage("diskUploadFileLegend")}})}return t};BX.Crm.EntityEditorFileStorage.prototype.getDiskUploaderValues=function(){var t=BX.CrmDiskUploader.items[this._uploaderName];return t?t.getFileIds():[]};BX.Crm.EntityEditorFileStorage.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorFileStorage.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorFileStorage.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorFileStorage.prototype.save=function(){var t=this.getStorageTypeId();if(t===BX.Crm.EditorFileStorageType.diskfile){this._model.setField(this._schemeElement.getDataStringParam("storageElementIds","STORAGE_ELEMENT_IDS"),this.getDiskUploaderValues())}};BX.Crm.EntityEditorFileStorage.prototype.onBeforeSubmit=function(){if(!this._dataContainer){return}BX.cleanNode(this._dataContainer,false);this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:this._schemeElement.getDataStringParam("storageTypeId","STORAGE_TYPE_ID"),value:this.getStorageTypeId()}}));var t=this._schemeElement.getDataStringParam("storageElementIds","STORAGE_ELEMENT_IDS");var e=this._model.getArrayField(t,[]);if(e.length>0){for(var i=0,n=e.length;i<n;i++){this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:t+"[]",value:e[i]}}))}}else{this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:t,value:""}}))}};if(typeof BX.Crm.EntityEditorFileStorage.messages==="undefined"){BX.Crm.EntityEditorFileStorage.messages={}}BX.Crm.EntityEditorFileStorage.create=function(t,e){var i=new BX.Crm.EntityEditorFileStorage;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorCustom==="undefined"){BX.Crm.EntityEditorCustom=function(){BX.Crm.EntityEditorCustom.superclass.constructor.apply(this);this._innerWrapper=null;this._runtimeValue=null};BX.extend(BX.Crm.EntityEditorCustom,BX.Crm.EntityEditorField);BX.Crm.EntityEditorCustom.prototype.hasContentToDisplay=function(){return this.getHtmlContent()!==""};BX.Crm.EntityEditorCustom.prototype.doClearLayout=function(t){this.setRuntimeValue(this.getValue())};BX.Crm.EntityEditorCustom.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorCustom.prototype.layout=function(t){if(this._hasLayout){return}var e=this._schemeElement.getDataArrayParam("classNames",[]);e.push("crm-entity-widget-content-block-field-custom");this.ensureWrapperCreated({classNames:e});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.addClass(this._innerWrapper,"crm-entity-widget-content-block-inner-edit-mode")}var i=this.getHtmlContent();if(this._mode!==BX.Crm.EntityEditorMode.edit&&!BX.type.isNotEmptyString(i)){i=this._model.getSchemeField(this._schemeElement,"empty","")}setTimeout(BX.delegate(function(){BX.html(this._innerWrapper,i)},this),0);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorCustom.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorCustom.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorCustom.prototype.getHtmlContent=function(){return this._model.getSchemeField(this._schemeElement,this.isInEditMode()?"edit":"view","")};BX.Crm.EntityEditorCustom.prototype.setRuntimeValue=function(t){this._runtimeValue=t};BX.Crm.EntityEditorCustom.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit?this._runtimeValue:""};BX.Crm.EntityEditorCustom.create=function(t,e){var i=new BX.Crm.EntityEditorCustom;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorHidden==="undefined"){BX.Crm.EntityEditorHidden=function(){BX.Crm.EntityEditorHidden.superclass.constructor.apply(this);this._input=null;this._view=null};BX.extend(BX.Crm.EntityEditorHidden,BX.Crm.EntityEditorText);BX.Crm.EntityEditorHidden.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-text"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));if(this.hasContentToDisplay()){if(this.getLineCount()>1){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},html:BX.util.nl2br(BX.util.htmlspecialchars(n))})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:n})}}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{props:{id:"crm-entity-widget-content-input",name:e,type:"hidden",value:n}});this._innerWrapper.appendChild(this._input)}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorHidden.create=function(t,e){var i=new BX.Crm.EntityEditorHidden;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityBindingTracker==="undefined"){BX.Crm.EntityBindingTracker=function(){this._id="";this._settings={};this._boundEntityInfos=null;this._unboundEntityInfos=null};BX.Crm.EntityBindingTracker.prototype={initialize:function(){this._boundEntityInfos=[];this._unboundEntityInfos=[]},bind:function(t){if(this.findIndex(t,this._boundEntityInfos)>=0){return}var e=this.findIndex(t,this._unboundEntityInfos);if(e>=0){this._unboundEntityInfos.splice(e,1)}else{this._boundEntityInfos.push(t)}},unbind:function(t){if(this.findIndex(t,this._unboundEntityInfos)>=0){return}var e=this.findIndex(t,this._boundEntityInfos);if(e>=0){this._boundEntityInfos.splice(e,1)}else{this._unboundEntityInfos.push(t)}},getBoundEntities:function(){return this._boundEntityInfos},getUnboundEntities:function(){return this._unboundEntityInfos},isBound:function(t){return this.findIndex(t,this._boundEntityInfos)>=0},isUnbound:function(t){return this.findIndex(t,this._unboundEntityInfos)>=0},reset:function(){this._boundEntityInfos=[];this._unboundEntityInfos=[]},findIndex:function(t,e){var i=t.getId();for(var n=0,r=e.length;n<r;n++){if(i===e[n].getId()){return n}}return-1}};BX.Crm.EntityBindingTracker.create=function(){var t=new BX.Crm.EntityBindingTracker;t.initialize();return t}}if(typeof BX.Crm.ClientEditorEntitySkeleton==="undefined"){BX.Crm.ClientEditorEntitySkeleton=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._hasLayout=false};BX.Crm.ClientEditorEntitySkeleton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null)},layout:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-block crm-entity-widget-client-block-skeleton"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-box"}})]});this._container.appendChild(this._wrapper);this._hasLayout=true},clearLayout:function(){this._wrapper=BX.remove(this._wrapper);this._hasLayout=false}};BX.Crm.ClientEditorEntitySkeleton.create=function(t,e){var i=new BX.Crm.ClientEditorEntitySkeleton;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityPanel==="undefined"){BX.Crm.ClientEditorEntityPanel=function(){this._id="";this._settings={};this._editor=null;this._entityInfo=null;this._requisiteInfo=null;this._requisiteNavigator=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._communicationButtons=null;this._deleteButton=null;this._container=null;this._wrapper=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._requisiteChangeHandler=BX.delegate(this.onRequisiteChange,this);this._requisiteChangeNotifier=null;this._hasLayout=false};BX.Crm.ClientEditorEntityPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null);this._editor=BX.prop.get(this._settings,"editor");this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._mode=BX.prop.getInteger(this._settings,"mode",0);this._isRequisiteEnabled=this._entityInfo.hasRequisites()&&BX.prop.getBoolean(this._settings,"enableRequisite",false);this._requisiteChangeNotifier=BX.CrmNotifier.create(this)},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getEntity:function(){return this._entityInfo},getMode:function(){return this._mode},setMode:function(t){this._mode=t},isRequisiteEnabled:function(){return this._isRequisiteEnabled},addRequisiteChangeListener:function(t){this._requisiteChangeNotifier.addListener(t)},removeRequisiteChangeListener:function(t){this._requisiteChangeNotifier.removeListener(t)},layout:function(){var t=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-block"}});this._container.appendChild(this._wrapper);var e=BX.create("div",{props:{className:"crm-entity-widget-client-box"}});this._wrapper.appendChild(e);if(BX.prop.getBoolean(this._settings,"enableEntityTypeCaption",false)){e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-box-type"},text:this._entityInfo.getTypeCaption()}))}this._deleteButton=null;if(!t){this._deleteButton=BX.create("div",{props:{className:"crm-entity-widget-client-block-remove"},events:{click:this._deleteButtonHandler}});e.appendChild(this._deleteButton)}var i=BX.create("div",{props:{className:"crm-entity-widget-client-box-name-container"}});e.appendChild(i);var n=BX.create("a",{props:{className:"crm-entity-widget-client-box-name",href:this._entityInfo.getShowUrl()},text:this._entityInfo.getTitle()});var r=BX.create("div",{props:{className:"crm-entity-widget-client-actions-container"}});if(this.isRequisiteEnabled()){BX.bind(n,"mouseover",BX.debounce(this.onMouseOver,300,this));BX.bind(n,"mouseout",BX.debounce(this.onMouseOut,300,this))}i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-box-name-row"},children:[n,r]}));this._communicationButtons=[];var o=["PHONE","EMAIL","IM"];for(var s=0,a=o.length;s<a;s++){var l=o[s];var d=BX.Crm.ClientEditorCommunicationButton.create(this._id+"_"+l,{entityInfo:this._entityInfo,type:l,ownerTypeId:this._editor.getOwnerTypeId(),ownerId:this._editor.getOwnerId(),container:r});d.layout();this._communicationButtons.push(d)}var h=this._entityInfo.getDescription();if(h!==""){e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-box-position"},text:h}))}var p=this._entityInfo.getPhones();var u=this._entityInfo.getEmails();if(p.length>0||u.length>0){var c=BX.create("div",{props:{className:"crm-entity-widget-client-contact"}});e.appendChild(c);if(p.length>0){c.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-contact-item crm-entity-widget-client-contact-phone"},text:p[0]["VALUE_FORMATTED"]}))}if(u.length>0){c.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-contact-item crm-entity-widget-client-contact-email"},text:u[0]["VALUE_FORMATTED"]}))}}var m=BX.prop.getFunction(this._settings,"onLayout",null);if(m){m(this,this._wrapper)}this._hasLayout=true},clearLayout:function(){if(this._requisiteNavigator){this._requisiteNavigator.removeClosingListener(this._requisiteChangeHandler);this._requisiteNavigator.close();this._requisiteNavigator=null}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},onMouseOver:function(t){if(this._requisiteHandle>0){window.clearTimeout(this._requisiteHandle);this._requisiteHandle=0}this._requisiteHandle=window.setTimeout(BX.delegate(this.openRequisiteNavigator,this),300)},onMouseOut:function(t){if(this._requisiteHandle>0){window.clearTimeout(this._requisiteHandle);this._requisiteHandle=0}},openRequisiteNavigator:function(){if(!this.isRequisiteEnabled()){return}if(this._requisiteHandle===0){return}this._requisiteHandle=0;if(!this._requisiteNavigator){if(!this._requisiteInfo){var t=BX.prop.getObject(this._settings,"requisiteBinding",{});this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:BX.prop.getInteger(t,"REQUISITE_ID",0),bankDetailId:BX.prop.getInteger(t,"BANK_DETAIL_ID",0),data:this._entityInfo.getRequisites()})}this._requisiteNavigator=BX.Crm.RequisiteNavigator.create(this._id,{requisiteInfo:this._requisiteInfo});this._requisiteNavigator.addClosingListener(this._requisiteChangeHandler)}this._requisiteNavigator.open(this._wrapper)},closeRequisiteNavigator:function(){if(this._requisiteHandle===0){return}this._requisiteHandle=0;if(this._requisiteNavigator){this._requisiteNavigator.close()}},onDeleteButtonClick:function(t){var e=BX.prop.getFunction(this._settings,"onDelete");if(e){e(this)}},onRequisiteChange:function(t,e){var i=BX.prop.getInteger(e,"requisiteId",0);var n=BX.prop.getInteger(e,"bankDetailId",0);if(!this._requisiteInfo||this._requisiteInfo.getRequisiteId()!==i||this._requisiteInfo.getBankDetailId()!==n){this._requisiteChangeNotifier.notify([e])}}};BX.Crm.ClientEditorEntityPanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityPanel;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityBindingPanel==="undefined"){BX.Crm.ClientEditorEntityBindingPanel=function(){this._id="";this._settings={};this._container=null;this._entityInfo=null;this._editor=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._item=null};BX.Crm.ClientEditorEntityBindingPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null);this._editor=BX.prop.get(this._settings,"editor");this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._mode=BX.prop.getInteger(this._settings,"mode",0);this._item=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._entityInfo.getId().toString(),{editor:this._editor,entityInfo:this._entityInfo,mode:this._mode,onLayout:BX.delegate(this.onItemLayout,this),onDelete:BX.delegate(this.onItemDelete,this)})},getEntity:function(){return this._entityInfo},getContainer:function(){return this._container},setContainer:function(t){this._container=t},layout:function(){this._button=BX.create("div",{props:{className:"crm-entity-widget-client-child-link"},events:{click:BX.delegate(this.onButtonClick,this)}});this._item.setContainer(this._container);this._item.layout()},onItemLayout:function(t,e){BX.addClass(e,"crm-entity-widget-client-block-child");var i=e.firstChild;if(i){e.insertBefore(this._button,i)}else{e.appendChild(this._button)}},clearLayout:function(){this._item.clearLayout()},onItemDelete:function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){return}var e=BX.prop.getFunction(this._settings,"onChange",null);if(e){e(this,"delete")}},onButtonClick:function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){return}var e=BX.prop.getFunction(this._settings,"onChange",null);if(e){e(this,"unbind")}}};BX.Crm.ClientEditorEntityBindingPanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityBindingPanel;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorCommunicationButton==="undefined"){BX.Crm.ClientEditorCommunicationButton=function(){this._id="";this._settings={};this._entityInfo=null;this._type="";this._items=null;this._container=null;this._wrapper=null;this._menu=null};BX.Crm.ClientEditorCommunicationButton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._type=BX.prop.getString(this._settings,"type","");this._container=BX.prop.getElementNode(this._settings,"container","");if(this._type===""){this._type="PHONE"}this._items=this._entityInfo.getMultiFieldsByType(this._type)},layout:function(){var t="";if(this._type==="EMAIL"){t="crm-entity-widget-client-action-mail"}else if(this._type==="IM"){t="crm-entity-widget-client-action-im"}else{t="crm-entity-widget-client-action-call"}if(this._items.length>0){t+=" crm-entity-widget-client-action-available"}this._wrapper=BX.create("a",{props:{className:t}});BX.bind(this._wrapper,"click",BX.delegate(this.onClick,this));this._container.appendChild(this._wrapper)},onClick:function(t){if(this._items.length===0){return BX.eventReturnFalse(t)}if(this._items.length===1){var e=this._items[0];var i=BX.prop.getString(e,"VALUE");if(i!==""){if(this._type==="PHONE"){this.addCall(i)}else if(this._type==="EMAIL"){this.addEmail(i)}else if(this._type==="IM"){this.openChat(i)}}return BX.eventReturnFalse(t)}this.toggleMenu();BX.eventReturnFalse(t)},toggleMenu:function(){if(!this._menu){var t=[];for(var e=0,i=this._items.length;e<i;e++){var n=BX.prop.getString(this._items[e],"VALUE");var r=BX.prop.getString(this._items[e],"VALUE_FORMATTED");var o=BX.prop.getString(this._items[e],"COMPLEX_NAME");var s=(o?o+": ":"")+(r?r:n);if(n!==""){t.push({id:n,text:s})}}this._menu=BX.Crm.ClientEditorMenu.create(this._id.toLowerCase()+"_menu",{anchor:this._wrapper,items:t,callback:BX.delegate(this.onMenuItemSelect,this)})}this._menu.toggle()},onMenuItemSelect:function(t,e){if(this._type==="EMAIL"){this.addEmail(e["id"])}else if(this._type==="IM"){}else{this.addCall(e["id"])}this._menu.close()},addCall:function(t){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("telephonyNotSupported"));return}var e={ENTITY_TYPE_NAME:this._entityInfo.getTypeName(),ENTITY_ID:this._entityInfo.getId(),AUTO_FOLD:true};var i=BX.prop.getInteger(this._settings,"ownerTypeId",0);var n=BX.prop.getInteger(this._settings,"ownerId",0);if(i!==this._entityInfo.getTypeId()||n!==this._entityInfo.getId()){e["BINDINGS"]=[{OWNER_TYPE_NAME:BX.CrmEntityType.resolveName(i),OWNER_ID:n}]}window.top["BXIM"].phoneTo(t,e)},addEmail:function(t){BX.CrmActivityEditor.addEmail({communicationsLoaded:true,communications:[{type:"EMAIL",entityType:this._entityInfo.getTypeName(),entityId:this._entityInfo.getId(),value:t}]})},openChat:function(t){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("messagingNotSupported"));return}window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}};BX.Crm.ClientEditorCommunicationButton.prototype.getMessage=function(t){var e=BX.Crm.ClientEditorCommunicationButton.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.ClientEditorCommunicationButton.messages==="undefined"){BX.Crm.ClientEditorCommunicationButton.messages={}}BX.Crm.ClientEditorCommunicationButton.create=function(t,e){var i=new BX.Crm.ClientEditorCommunicationButton;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorMenu==="undefined"){BX.Crm.ClientEditorMenu=function(){this._id=null;this._settings={};this._items=null;this._isOpened=false;this._popup=null};BX.Crm.ClientEditorMenu.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._items=BX.prop.getArray(this._settings,"items",[]);for(var i=0,n=this._items.length;i<n;i++){this._items[i]["onclick"]=BX.delegate(this.onItemSelect,this)}},onItemSelect:function(t,e){var i=BX.prop.getFunction(this._settings,"callback",null);if(i){i(this,e)}},isOpened:function(){return this._isOpened},open:function(){if(this._isOpened){return}BX.PopupMenu.show(this._id,BX.prop.getElementNode(this._settings,"anchor",null),this._items,{offsetTop:0,offsetLeft:0,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._popup=BX.PopupMenu.currentItem},close:function(){if(!this._isOpened){return}if(this._popup){if(this._popup.popupWindow){this._popup.popupWindow.destroy()}}},toggle:function(){if(!this._isOpened){this.open()}else{this.close()}},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){this.close()},onPopupDestroy:function(){this._isOpened=false;this._popup=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}};BX.Crm.ClientEditorMenu.create=function(t,e){var i=new BX.Crm.ClientEditorMenu;i.initialize(t,e);return i}}if(typeof BX.Crm.UserFieldTypeMenu==="undefined"){BX.Crm.UserFieldTypeMenu=function(){this._id=null;this._settings={};this._items=null;this._isOpened=false;this._wrapper=null;this._innerWrapper=null;this._topScrollButton=null;this._bottomScrollButton=null;this._bottomButtonMouseOverHandler=BX.delegate(this.onBottomButtonMouseOver,this);this._bottomButtonMouseOutHandler=BX.delegate(this.onBottomButtonMouseOut,this);this._topButtonMouseOverHandler=BX.delegate(this.onTopButtonMouseOver,this);this._topButtonMouseOutHandler=BX.delegate(this.onTopButtonMouseOut,this);this._scrollHandler=BX.throttle(this.onScroll,100,this);this._enableScrollToBottom=false;this._enableScrollToTop=false;this._popup=null};BX.Crm.UserFieldTypeMenu.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._items=[];var i=BX.prop.getArray(e,"items");for(var n=0,r=i.length;n<r;n++){var o=i[n];o["menu"]=this;this._items.push(BX.Crm.UserFieldTypeMenuItem.create(BX.prop.getString(o,"value"),o))}},getId:function(){return this._id},isOpened:function(){return this._isOpened},open:function(t){if(this._isOpened){return}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.prepareContent()});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-card-widget-create-field-popup"}});var t='<svg xmlns="http://www.w3.org/2000/svg" width="42" height="13" viewBox="0 0 42 13">\n'+'  <polyline fill="none" stroke="#CACDD1" stroke-width="2" points="274 98 284 78.614 274 59" transform="rotate(90 186 -86.5)" stroke-linecap="round" stroke-linejoin="round"/>\n'+"</svg>\n";this._topScrollButton=BX.create("div",{props:{className:"crm-entity-card-widget-popup-scroll-control-top"},html:t});this._wrapper.appendChild(this._topScrollButton);this._bottomScrollButton=BX.create("div",{props:{className:"crm-entity-card-widget-popup-scroll-control-bottom"},html:t});this._wrapper.appendChild(this._bottomScrollButton);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-card-widget-create-field-list"}});this._wrapper.appendChild(this._innerWrapper);for(var e=0,i=this._items.length;e<i;e++){this._innerWrapper.appendChild(this._items[e].prepareContent())}return this._wrapper},adjust:function(){var t=this._innerWrapper.offsetHeight;var e=this._innerWrapper.scrollTop;var i=this._innerWrapper.scrollHeight;if(e===0){BX.addClass(this._topScrollButton,"control-hide")}else{BX.removeClass(this._topScrollButton,"control-hide")}if(e+t===i){BX.addClass(this._bottomScrollButton,"control-hide")}else{BX.removeClass(this._bottomScrollButton,"control-hide")}},onItemSelect:function(t){var e=BX.prop.getFunction(this._settings,"callback",null);if(e){e(this,t)}},onPopupShow:function(){this._isOpened=true;BX.bind(this._bottomScrollButton,"mouseover",this._bottomButtonMouseOverHandler);BX.bind(this._bottomScrollButton,"mouseout",this._bottomButtonMouseOutHandler);BX.bind(this._topScrollButton,"mouseover",this._topButtonMouseOverHandler);BX.bind(this._topScrollButton,"mouseout",this._topButtonMouseOutHandler);BX.bind(this._innerWrapper,"scroll",this._scrollHandler);window.setTimeout(this.adjust.bind(this),100)},onPopupClose:function(){if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){this._isOpened=false;BX.unbind(this._bottomScrollButton,"mouseover",this._bottomButtonMouseOverHandler);BX.unbind(this._bottomScrollButton,"mouseout",this._bottomButtonMouseOutHandler);BX.unbind(this._topScrollButton,"mouseover",this._topButtonMouseOverHandler);BX.unbind(this._topScrollButton,"mouseout",this._topButtonMouseOutHandler);BX.unbind(this._innerWrapper,"scroll",this._scrollHandler);this._wrapper=null;this._innerWrapper=null;this._topScrollButton=null;this._bottomScrollButton=null;this._popup=null},onBottomButtonMouseOver:function(t){if(this._enableScrollToBottom){return}this._enableScrollToBottom=true;this._enableScrollToTop=false;(function t(){if(!this._enableScrollToBottom){return}var e=this._innerWrapper;if(e.scrollTop+e.offsetHeight!==e.scrollHeight){e.scrollTop+=3}if(e.scrollTop+e.offsetHeight===e.scrollHeight){this._enableScrollToBottom=false}else{window.setTimeout(t.bind(this),20)}}).bind(this)()},onBottomButtonMouseOut:function(){this._enableScrollToBottom=false},onTopButtonMouseOver:function(t){if(this._enableScrollToTop){return}this._enableScrollToBottom=false;this._enableScrollToTop=true;(function t(){if(!this._enableScrollToTop){return}var e=this._innerWrapper;if(e.scrollTop>0){e.scrollTop-=3}if(e.scrollTop===0){this._enableScrollToTop=false}else{window.setTimeout(t.bind(this),20)}}).bind(this)()},onTopButtonMouseOut:function(){this._enableScrollToTop=false},onScroll:function(t){this.adjust()}};BX.Crm.UserFieldTypeMenu.create=function(t,e){var i=new BX.Crm.UserFieldTypeMenu;i.initialize(t,e);return i}}if(typeof BX.Crm.UserFieldTypeMenuItem==="undefined"){BX.Crm.UserFieldTypeMenuItem=function(){this._id="";this._settings=null;this._menu="";this._value="";this._text="";this._legend=""};BX.Crm.UserFieldTypeMenuItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._menu=BX.prop.get(e,"menu");this._value=BX.prop.getString(e,"value");this._text=BX.prop.getString(e,"text");this._legend=BX.prop.getString(e,"legend")},getId:function(){return this._id},getValue:function(){return this._value},getText:function(){return this._text},getLegend:function(){return this._legend},prepareContent:function(){var t=BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item"},events:{click:BX.delegate(this.onClick,this)}});t.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item-title"},text:this._text}));t.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item-desc"},text:this._legend}));return t},onClick:function(t){this._menu.onItemSelect(this)}};BX.Crm.UserFieldTypeMenuItem.create=function(t,e){var i=new BX.Crm.UserFieldTypeMenuItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorSubsection==="undefined"){BX.Crm.EntityEditorSubsection=function(){BX.Crm.EntityEditorSubsection.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorSubsection,BX.Crm.EntityEditorSection);BX.Crm.EntityEditorSubsection.prototype.initialize=function(t,e){BX.Crm.EntityEditorSubsection.superclass.initialize.call(this,t,e);this.initializeFromModel()};BX.Crm.EntityEditorSubsection.prototype.ensureWrapperCreated=function(t){if(!this._wrapper){this._wrapper=BX.create("div")}return this._wrapper};BX.Crm.EntityEditorSubsection.prototype.layout=function(t){this._contentContainer=BX.create("div");var e=this._mode===BX.Crm.EntityEditorMode.view;this.ensureWrapperCreated();this.layoutTitle();this._wrapper.appendChild(this._contentContainer);for(var i=0,n=this._fields.length;i<n;i++){this.layoutChild(this._fields[i])}this._addChildButton=this._createChildButton=null;if(this.isDragEnabled()){this._dragContainerController=BX.Crm.EditorDragContainerController.create("section_"+this.getId(),{charge:BX.Crm.EditorFieldDragContainer.create({section:this,context:this._draggableContextId}),node:this._wrapper});this._dragContainerController.addDragFinishListener(this._dropHandler);this.initializeDragDropAbilities()}this._addChildButton=this._createChildButton=null;if(!e){this.createButtonPanel();this._contentContainer.appendChild(this._buttonPanelWrapper)}this._hasLayout=true;this.registerLayout(t)};BX.Crm.EntityEditorSubsection.prototype.getChildDragScope=function(){return BX.Crm.EditorDragScope.parent};BX.Crm.EntityEditorSubsection.prototype.createButtonPanel=function(){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}})};BX.Crm.EntityEditorSubsection.prototype.layoutChild=function(t){t.setContainer(this._contentContainer);t.setDraggableContextId(this._draggableContextId);this.setChildVisible(t);t.releaseLayout();t.layout();if(this._mode!==BX.Crm.EntityEditorMode.view&&t.isHeading()){t.focus()}};BX.Crm.EntityEditorSubsection.prototype.setChildVisible=function(t){t.setVisible(BX.prop.getBoolean(t._schemeElement._settings,"isVisible",true))};BX.Crm.EntityEditorSubsection.prototype.isDragEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.layoutTitle=function(){};BX.Crm.EntityEditorSubsection.prototype.isCreationEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.isContextMenuEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.isRequired=function(){return true};BX.Crm.EntityEditorSubsection.prototype.getRuntimeValue=function(){var t=[];for(var e=0;e<this.getChildCount();e++){var i=this._fields[e].getRuntimeValue();if(BX.type.isArray(i)){for(var n in i){if(i.hasOwnProperty(n)){t[n]=i[n]}}}else{t[this._fields[e].getName()]=i}}return t};BX.Crm.EntityEditorSubsection.prototype.processChildControlChange=function(t,e){if(this._isChanged){return}this.markAsChanged(e)};BX.Crm.EntityEditorSubsection.create=function(t,e){var i=new BX.Crm.EntityEditorSubsection;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurring==="undefined"){BX.Crm.EntityEditorRecurring=function(){BX.Crm.EntityEditorRecurring.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorRecurring,BX.Crm.EntityEditorSubsection);BX.Crm.EntityEditorRecurring.prototype.initialize=function(t,e){BX.Crm.EntityEditorRecurring.superclass.initialize.call(this,t,e);var i=this._schemeElement.getData();this._schemeFieldData=BX.prop.getObject(i,"fieldData",{});this._enableRecurring=BX.prop.getBoolean(this._schemeElement._settings,"enableRecurring",true);this._recurringModel=this._model.getField(this.getName())};BX.Crm.EntityEditorRecurring.prototype.initializeFromModel=function(){BX.Crm.EntityEditorRecurring.superclass.initializeFromModel.call(this);var t=this;for(var e=0,i=this._fields.length;e<i;e++){this._fields[e].getValue=function(e){if(!BX.type.isNotEmptyString(e)){e=this.getName()}return t.getRecurringFieldValue(e)}}};BX.Crm.EntityEditorRecurring.prototype.getRecurringModel=function(){var t=this.getParent();if(t instanceof BX.Crm.EntityEditorRecurring){return t.getRecurringModel()}return this._recurringModel};BX.Crm.EntityEditorRecurring.prototype.getRecurringMode=function(){var t=this.getParent();if(t instanceof BX.Crm.EntityEditorRecurring){return t.getRecurringMode()}return this.getRecurringFieldValue("RECURRING[MODE]")};BX.Crm.EntityEditorRecurring.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRecurring.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRecurring.prototype.processChildControlChange=function(t,e){var i=t.getName();var n=false;var r=t.getValue();var o=t.getRuntimeValue();if(r!==o){switch(i){case"RECURRING[MODE]":case"RECURRING[MULTIPLE_TYPE_LIMIT]":n=true;break;case"RECURRING[MULTIPLE_TYPE]":if(r===this.getSchemeFieldValue("MULTIPLE_CUSTOM")||o===this.getSchemeFieldValue("MULTIPLE_CUSTOM")){n=true}}}var s=this.getRecurringModel();this.setChangedValue(i,o,s);BX.Crm.EntityEditorRecurring.superclass.processChildControlChange.call(this,t,e);if(n){this.refreshLayout()}};BX.Crm.EntityEditorRecurring.prototype.setChangedValue=function(t,e,i){if(typeof e==="object"){for(var n in e){if(e.hasOwnProperty(n)){this.setChangedValue(n,e[n],i)}}}else{i[t]=e}};BX.Crm.EntityEditorRecurring.prototype.layout=function(t){this._contentContainer=BX.create("div");if(this.isMainSubsection()){this._contentContainer.classList.add("crm-entity-widget-content")}var e=this._mode===BX.Crm.EntityEditorMode.view;this.ensureWrapperCreated();this.layoutTitle();this._wrapper.appendChild(this._contentContainer);if(e){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-click-editable"}});if(this._enableRecurring){BX.bind(i,"click",BX.delegate(this.toggle,this))}this._contentContainer.appendChild(i);var n=BX.create("div");var r=this._schemeElement.getData();if(this._schemeElement._promise instanceof BX.Promise){this.loadViewText();this._schemeElement._promise.then(BX.proxy(function(){n.classList="crm-entity-widget-content-block-title";n.innerHTML=BX.util.htmlspecialchars(r.view.text);i.innerHTML="";i.appendChild(n);this._schemeElement._promise=null},this))}else if(BX.type.isNotEmptyString(r.view.text)){n.classList="crm-entity-widget-content-block-title";n.innerHTML=r.view.text;i.appendChild(n)}}else if(!this._enableRecurring){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this.createTitleNode(this.getMessage("modeTitle"))]});var o=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{type:"text",props:{className:"crm-entity-widget-content-input",disabled:"disabled"},text:this.getMessage("notRepeat"),events:{click:BX.delegate(this.showLicencePopup,this)}})]});i.appendChild(o);var s=BX.create("button",{props:{className:"crm-entity-widget-content-block-locked-icon"},events:{click:BX.delegate(this.showLicencePopup,this)}});i.appendChild(s);this._contentContainer.appendChild(i)}else{for(var a=0,l=this._fields.length;a<l;a++){this.layoutChild(this._fields[a])}}this._addChildButton=this._createChildButton=null;this._hasLayout=true;this.registerLayout(t)};BX.Crm.EntityEditorRecurring.prototype.createTitleNode=function(t){var e=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:t})]});return e};BX.Crm.EntityEditorRecurring.prototype.setChildVisible=function(t){var e=false;var i=t.getName();var n=this.getRecurringMode();if(i==="RECURRING[MODE]"){e=true}else if(n===this.getSchemeFieldValue("SINGLE_EXECUTION")){if(i==="SINGLE_PARAMS"||i==="RECURRING[CATEGORY_ID]"){e=true}}else if(n===this.getSchemeFieldValue("MULTIPLE_EXECUTION")){switch(i){case"MULTIPLE_PARAMS":case"RECURRING[MULTIPLE_TYPE]":case"RECURRING[CATEGORY_ID]":case"RECURRING[MULTIPLE_DATE_START]":case"MULTIPLE_LIMIT":case"RECURRING[MULTIPLE_TYPE_LIMIT]":e=true;break;case"MULTIPLE_CUSTOM":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE]")===this.getSchemeFieldValue("MULTIPLE_CUSTOM")){e=true}break;case"RECURRING[MULTIPLE_DATE_LIMIT]":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE_LIMIT]")===this.getSchemeFieldValue("LIMITED_BY_DATE")){e=true}break;case"RECURRING[MULTIPLE_TIMES_LIMIT]":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE_LIMIT]")===this.getSchemeFieldValue("LIMITED_BY_TIMES")){e=true}break}}t.setVisible(e)};BX.Crm.EntityEditorRecurring.prototype.getRecurringFieldValue=function(t){return BX.prop.get(this.getRecurringModel(),t)};BX.Crm.EntityEditorRecurring.prototype.getSchemeFieldValue=function(t){return BX.prop.get(this._schemeFieldData,t,"")};BX.Crm.EntityEditorRecurring.prototype.isMainSubsection=function(){return!(this.getParent()instanceof BX.Crm.EntityEditorRecurring)};BX.Crm.EntityEditorRecurring.prototype.onBeforeSubmit=function(){if(this.isMainSubsection()){this._wrapper.appendChild(BX.create("input",{props:{type:"hidden",name:"IS_RECURRING",value:this._model.getStringField("IS_RECURRING")==="Y"?"Y":"N"}}))}};BX.Crm.EntityEditorRecurring.prototype.save=function(){if(this.isMainSubsection()){this._schemeElement._promise=new BX.Promise}};BX.Crm.EntityEditorRecurring.prototype.loadViewText=function(){var t=this._schemeElement.getData();if(BX.type.isPlainObject(t.loaders)&&BX.type.isNotEmptyString(t.loaders["url"])&&BX.type.isNotEmptyString(t.loaders["action"])){BX.ajax({url:t.loaders["url"],method:"POST",dataType:"json",data:{ACTION:t.loaders["action"],PARAMS:{ID:this._model.getField("ID")}},onsuccess:BX.delegate(this.onEntityHintLoad,this)})}};BX.Crm.EntityEditorRecurring.prototype.onEntityHintLoad=function(t){var e=BX.prop.getObject(t,"DATA",null);if(!e){return}if(BX.type.isNotEmptyString(e.HINT)){this._schemeElement._data.view.text=e.HINT}if(this._schemeElement._promise instanceof BX.Promise){this._schemeElement._promise.fulfill();this._schemeElement._promise=null}};BX.Crm.EntityEditorRecurring.prototype.showLicencePopup=function(t){t.preventDefault();if(!B24||!B24["licenseInfoPopup"]){return}var e=this._schemeElement.getData();var i=e.restrictMessage;if(BX.type.isPlainObject(i)&&BX.type.isNotEmptyString(i.title)&&BX.type.isNotEmptyString(i.text)){B24.licenseInfoPopup.show("crm-deal-recurring-restricted",i.title,i.text)}};BX.Crm.EntityEditorRecurring.create=function(t,e){var i=new BX.Crm.EntityEditorRecurring;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurringCustomRowField==="undefined"){BX.Crm.EntityEditorRecurringCustomRowField=function(){BX.Crm.EntityEditorRecurringCustomRowField.superclass.constructor.apply(this);this._amountInput=null;this._selectInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null;this._selectedValue="";this._selectClickHandler=BX.delegate(this.onSelectorClick,this);this._isMesureMenuOpened=false};BX.extend(BX.Crm.EntityEditorRecurringCustomRowField,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRecurringCustomRowField.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorRecurringCustomRowField.prototype.focus=function(){if(this._amountInput){BX.focus(this._amountInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._amountInput)}};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getValue=function(t){if(!this._model){return""}return this._model.getStringField(this.getAmountFieldName(),t!==undefined?t:"")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-recurring-custom"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=this.getSelectFieldName();this._selectedValue=this.getValue(n);var r=BX.prop.getArray(BX.prop.getObject(i,"select"),"items");var o="";if(!this._selectedValue){var s=r.length>0?r[0]:null;if(s){this._selectedValue=s["VALUE"];o=s["NAME"]}}else{o=this._editor.findOption(this._selectedValue,r)}var a=this.getAmountFieldName();var l=this.getValue(a);this._amountInput=null;this._selectInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:a,type:"text",value:l}});BX.bind(this._amountInput,"input",this._changeHandler);this._selectInput=BX.create("input",{attrs:{name:n,type:"hidden",value:this._selectedValue}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:o});BX.bind(this._selectContainer,"click",this._selectClickHandler);this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._amountInput,this._selectInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"},children:[this._selectContainer]})]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[this._inputWrapper]})}this._wrapper.appendChild(this._innerWrapper);this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.doClearLayout=function(t){BX.PopupMenu.destroy(this._id);this._amountInput=null;this._selectInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getAmountFieldName=function(){return this._schemeElement.getDataStringParam("amount","")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getSelectFieldName=function(){return BX.prop.getString(this._schemeElement.getDataObjectParam("select",{}),"name","")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onSelectorClick=function(t){this.openListMenu()};BX.Crm.EntityEditorRecurringCustomRowField.prototype.openListMenu=function(){if(this._isListMenuOpened){return}var t=this._schemeElement.getData();var e=BX.prop.getArray(BX.prop.getObject(t,"select"),"items");var i=0;var n=[];while(i<e.length){n.push({text:e[i]["NAME"],value:e[i]["VALUE"],onclick:BX.delegate(this.onSelectItem,this)});i++}BX.PopupMenu.show(this._id,this._selectContainer,n,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onListMenuOpen,this),onPopupClose:BX.delegate(this.onListMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorRecurringCustomRowField.prototype.closeListMenu=function(){if(!this._isListMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onListMenuOpen=function(){BX.addClass(this._selectContainer,"active");this._isListMenuOpened=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onListMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isListMenuOpened=false};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onSelectItem=function(t,e){this.closeListMenu();this._selectedValue=this._selectInput.value=e.value;this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);this.markAsChanged({fieldName:this.getSelectFieldName(),fieldValue:this._selectedValue})};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit){if(this._amountInput){t[this.getAmountFieldName()]=this._amountInput.value}t[this.getSelectFieldName()]=this._selectedValue;return t}return""};BX.Crm.EntityEditorRecurringCustomRowField.prototype.save=function(){this._model.setField(this.getSelectFieldName(),this._selectedValue);if(this._amountInput){this._model.setField(this.getAmountFieldName(),this._amountInput.value)}};BX.Crm.EntityEditorRecurringCustomRowField.create=function(t,e){var i=new BX.Crm.EntityEditorRecurringCustomRowField;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurringSingleField==="undefined"){BX.Crm.EntityEditorRecurringSingleField=function(){BX.Crm.EntityEditorRecurringSingleField.superclass.constructor.apply(this);this._dateInput=null};BX.extend(BX.Crm.EntityEditorRecurringSingleField,BX.Crm.EntityEditorRecurringCustomRowField);BX.Crm.EntityEditorRecurringSingleField.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-recurring-single"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=this.getAmountFieldName();var r=this.getValue(n);var o=this.getSelectFieldName();this._selectedValue=this.getValue(o);var s=this.getDateFieldName();this._dateValue=this.getValue(s);var a=BX.prop.getArray(BX.prop.getObject(i,"select"),"items");var l="";if(!this._selectedValue){var d=a.length>0?a[0]:null;if(d){this._selectedValue=d["VALUE"];l=d["NAME"]}}else{l=this._editor.findOption(this._selectedValue,a)}this._amountInput=null;this._selectInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:n,type:"text",value:r}});BX.bind(this._amountInput,"input",this._changeHandler);this._selectInput=BX.create("input",{attrs:{name:o,type:"hidden",value:this._selectedValue}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:l});this._dateInput=BX.create("input",{style:{display:"inline-block"},props:{name:s,className:"crm-entity-widget-content-input crm-entity-widget-content-input-date",value:this._dateValue},events:{click:function(){BX.calendar({node:this,field:this,bTime:false})},change:BX.delegate(function(t){this.markAsChanged()},this)}});BX.bind(this._selectContainer,"click",this._selectClickHandler);this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._amountInput,this._selectInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"},children:[this._selectContainer]}),BX.create("span",{text:this.getMessage("until")}),this._dateInput]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[this._inputWrapper]})}this._wrapper.appendChild(this._innerWrapper);this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getDateFieldName=function(){return this._schemeElement.getDataStringParam("date","")};BX.Crm.EntityEditorRecurringSingleField.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit){if(this._amountInput){t[this.getAmountFieldName()]=this._amountInput.value}t[this.getSelectFieldName()]=this._selectedValue;t[this.getDateFieldName()]=this._dateInput.value;return t}return""};BX.Crm.EntityEditorRecurringSingleField.prototype.save=function(){var t=this._schemeElement.getData();this._model.setField(BX.prop.getString(BX.prop.getObject(t,"select"),"name"),this._selectedValue);if(this._amountInput){this._model.setField(BX.prop.getString(t,"amount"),this._amountInput.value)}if(this._dateInput){this._model.setField(BX.prop.getString(t,"date"),this._dateInput.value)}};BX.Crm.EntityEditorRecurringSingleField.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRecurringSingleField.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRecurringSingleField.create=function(t,e){var i=new BX.Crm.EntityEditorRecurringSingleField;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorFieldSingleEditController==="undefined"){BX.Crm.EditorFieldSingleEditController=function(){this._id="";this._settings=null;this._field=null;this._wrapper=null;this._fieldWrapperHandler=BX.delegate(this.onFieldWrapperClick,this);this._documentHandler=BX.delegate(this.onDocumentClick,this);this._documentTimeoutHandle=0;this._isInitialized=false;this._isActive=false};BX.Crm.EditorFieldSingleEditController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._time=(new Date).toString();this._field=BX.prop.get(this._settings,"field");if(!(this._field instanceof BX.Crm.EntityEditorField)){throw"EditorFieldSingleEditController: The 'field' param must be EntityEditorField."}this._wrapper=this._field.getWrapper();if(!BX.type.isElementNode(this._wrapper)){throw"EditorFieldSingleEditController: Could not find the wrapper element."}window.setTimeout(BX.delegate(this.bind,this),100);this._isActive=this._isInitialized=true},isActive:function(){return this._isActive},setActive:function(t){this._isActive=!!t},setActiveDelayed:function(t,e){if(typeof e==="undefined"){e=0}window.setTimeout(BX.delegate(function(){this.setActive(t)},this),e)},release:function(){this._isActive=this._isInitialized=false;this.unbind()},bind:function(){if(this._isInitialized){BX.bind(this._wrapper,"click",this._fieldWrapperHandler);BX.bind(document,"click",this._documentHandler)}},unbind:function(){BX.unbind(this._wrapper,"click",this._fieldWrapperHandler);BX.unbind(document,"click",this._documentHandler)},saveControl:function(){if(!this._isActive){return}var t=this._field.getEditor();if(t){t.switchControlMode(this._field,BX.Crm.EntityEditorMode.view,BX.Crm.EntityEditorModeOptions.none)}this._isActive=false},onFieldWrapperClick:function(t){BX.eventCancelBubble(t)},onDocumentClick:function(t){if(this._documentTimeoutHandle>0){window.clearTimeout(this._documentTimeoutHandle);this._documentTimeoutHandle=0}this._documentTimeoutHandle=window.setTimeout(BX.delegate(this.saveControl,this),400)}};BX.Crm.EditorFieldSingleEditController.create=function(t,e){var i=new BX.Crm.EditorFieldSingleEditController;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorFieldViewController==="undefined"){BX.Crm.EditorFieldViewController=function(){this._id="";this._settings=null;this._field=null;this._wrapper=null;this._timeoutHandle=0;this._time=0;this._pos={x:0,y:0};this._mouseDownHandler=BX.delegate(this.onMouseDown,this);this._mouseUpHandler=BX.delegate(this.onMouseUp,this);this._isInitialized=false;this._isActive=false};BX.Crm.EditorFieldViewController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._field=BX.prop.get(this._settings,"field");if(!(this._field instanceof BX.Crm.EntityEditorField)){throw"EditorFieldViewController: The 'field' param must be EntityEditorField."}this._wrapper=BX.prop.getElementNode(this._settings,"wrapper");if(!BX.type.isElementNode(this._wrapper)){throw"EditorFieldSingleEditController: Could not find the wrapper element."}window.setTimeout(BX.delegate(this.bind,this),100);this._isActive=this._isInitialized=true},release:function(){this._isActive=this._isInitialized=false;this.unbind()},bind:function(){if(this._isInitialized){BX.bind(this._wrapper,"mousedown",this._mouseDownHandler);BX.bind(this._wrapper,"mouseup",this._mouseUpHandler)}},unbind:function(){BX.unbind(this._wrapper,"mousedown",this._mouseDownHandler);BX.unbind(this._wrapper,"mouseup",this._mouseUpHandler)},onMouseDown:function(t){if(this._timeoutHandle>0){window.clearTimeout(this._timeoutHandle);this._timeoutHandle=0}if(!this.isHandleableEvent(t)){return}this._time=(new Date).valueOf();this._pos={x:t.clientX,y:t.clientY}},onMouseUp:function(t){if(this._timeoutHandle>0){window.clearTimeout(this._timeoutHandle);this._timeoutHandle=0}if(!this.isHandleableEvent(t)){return}if((new Date).valueOf()-this._time<400||Math.abs(this._pos.x-t.clientX)<2){this._timeoutHandle=window.setTimeout(BX.delegate(this.switchTo,this),0)}this._time=0},isHandleableEvent:function(t){var e=BX.getEventTarget(t);if(e.tagName==="A"){return false}if(e.getAttribute("data-editor-control-type")==="button"){return false}return!BX.findParent(e,{tagName:"a"},this._wrapper)},switchTo:function(){this._field.switchToSingleEditMode()}};BX.Crm.EditorFieldViewController.create=function(t,e){var i=new BX.Crm.EditorFieldViewController;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorController==="undefined"){BX.Crm.EntityEditorController=function(){this._id="";this._settings={};this._editor=null;this._model=null;this._config=null;this._isChanged=false};BX.Crm.EntityEditorController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor",null);this._model=BX.prop.get(this._settings,"model",null);this._config=BX.prop.getObject(this._settings,"config",{});this.doInitialize()},doInitialize:function(){},getConfig:function(){return this._config},getConfigStringParam:function(t,e){return BX.prop.getString(this._config,t,e)},isChanged:function(){return this._isChanged},markAsChanged:function(){if(this._isChanged){return}this._isChanged=true;if(this._editor){this._editor.processControllerChange(this)}},rollback:function(){},innerCancel:function(){},onBeforeSubmit:function(){},onAfterSave:function(){if(this._isChanged){this._isChanged=false}},onBeforesSaveControl:function(t){return t}}}if(typeof BX.Crm.EntityEditorProductRowProxy==="undefined"){BX.Crm.EntityEditorProductRowProxy=function(){BX.Crm.EntityEditorProductRowProxy.superclass.constructor.apply(this);this._externalEditor=null;this._editorCreateHandler=null;this._sumTotalChangeHandler=null;this._productAddHandler=null;this._productChangeHandler=null;this._productRemoveHandler=null;this._editorModeChangeHandler=BX.delegate(this.onEditorModeChange,this);this._editorControlChangeHandler=BX.delegate(this.onEditorControlChange,this);this._currencyId=""};BX.extend(BX.Crm.EntityEditorProductRowProxy,BX.Crm.EntityEditorController);BX.Crm.EntityEditorProductRowProxy.prototype.doInitialize=function(){BX.Crm.EntityEditorProductRowProxy.superclass.doInitialize.apply(this);this._sumTotalChangeHandler=BX.delegate(this.onSumTotalChange,this);this._productAddHandler=BX.delegate(this.onProductAdd,this);this._productChangeHandler=BX.delegate(this.onProductChange,this);this._productRemoveHandler=BX.delegate(this.onProductRemove,this);var t=typeof BX.CrmProductEditor!=="undefined"?BX.CrmProductEditor.get(this.getExternalEditorId()):null;if(t){this.setExternalEditor(t)}else{this._editorCreateHandler=BX.delegate(this.onEditorCreate,this);BX.addCustomEvent(window,"ProductRowEditorCreated",this._editorCreateHandler)}this._editor.addModeChangeListener(this._editorModeChangeHandler);BX.addCustomEvent(window,"onEntityDetailsTabShow",BX.delegate(this.onTabShow,this))};BX.Crm.EntityEditorProductRowProxy.prototype.onTabShow=function(t){if(t.getId()!=="tab_products"){return}if(this._externalEditor&&!this._externalEditor.hasLayout()){this._externalEditor.layout()}};BX.Crm.EntityEditorProductRowProxy.prototype.getExternalEditorId=function(){return this.getConfigStringParam("editorId","")};BX.Crm.EntityEditorProductRowProxy.prototype.setExternalEditor=function(t){if(this._externalEditor===t){return}if(this._externalEditor){this._externalEditor.setForm(null);BX.removeCustomEvent(this._externalEditor,"sumTotalChange",this._sumTotalChangeHandler);BX.removeCustomEvent(this._externalEditor,"productAdd",this._productAddHandler);BX.removeCustomEvent(this._externalEditor,"productChange",this._productChangeHandler);BX.removeCustomEvent(this._externalEditor,"productRemove",this._productRemoveHandler)}this._externalEditor=t;if(this._externalEditor){this._externalEditor.setForm(this._editor.getFormElement());BX.addCustomEvent(this._externalEditor,"sumTotalChange",this._sumTotalChangeHandler);BX.addCustomEvent(this._externalEditor,"productAdd",this._productAddHandler);BX.addCustomEvent(this._externalEditor,"productChange",this._productChangeHandler);BX.addCustomEvent(this._externalEditor,"productRemove",this._productRemoveHandler);this.adjustLocks()}};BX.Crm.EntityEditorProductRowProxy.prototype.adjustLocks=function(){if(!this._externalEditor){return}if(this._externalEditor.getProductCount()>0){this._model.lockField("OPPORTUNITY")}else{this._model.unlockField("OPPORTUNITY")}};BX.Crm.EntityEditorProductRowProxy.prototype.adjustTotals=function(t){this._model.setField("FORMATTED_OPPORTUNITY",t["FORMATTED_SUM"],{enableNotification:false});this._model.setField("FORMATTED_OPPORTUNITY_WITH_CURRENCY",t["FORMATTED_SUM_WITH_CURRENCY"],{enableNotification:false});this._model.setField("OPPORTUNITY",t["SUM"],{enableNotification:true})};BX.Crm.EntityEditorProductRowProxy.prototype.onEditorCreate=function(t){if(t.getId()!==this.getExternalEditorId()){return}BX.removeCustomEvent(window,"ProductRowEditorCreated",this._editorCreateHandler);delete this._editorCreateHandler;this.setExternalEditor(t)};BX.Crm.EntityEditorProductRowProxy.prototype.onEditorModeChange=function(t){if(this._editor.getMode()===BX.Crm.EntityEditorMode.edit){this._editor.addControlChangeListener(this._editorControlChangeHandler)}else{this._editor.removeControlChangeListener(this._editorControlChangeHandler)}this._isChanged=false};BX.Crm.EntityEditorProductRowProxy.prototype.onEditorControlChange=function(t,e){if(!this._externalEditor){return}var i=BX.prop.getString(e,"fieldName","");if(i!=="CURRENCY_ID"){return}var n=BX.prop.getString(e,"fieldValue","");if(n!==""){this._currencyId=n;this._externalEditor.setCurrencyId(this._currencyId)}};BX.Crm.EntityEditorProductRowProxy.prototype.onProductAdd=function(t){this.adjustLocks();this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.onProductChange=function(t){this.adjustLocks();this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.onProductRemove=function(t){this.adjustLocks();this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.onSumTotalChange=function(t,e){this.adjustTotals({FORMATTED_SUM_WITH_CURRENCY:e["TOTAL_SUM_FORMATTED"],FORMATTED_SUM:e["TOTAL_SUM_FORMATTED_SHORT"],SUM:e["TOTAL_SUM"]});this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.rollback=function(){var t=this._model.getField("CURRENCY_ID","");if(this._currencyId!==t){this._currencyId=t;if(this._externalEditor){this._externalEditor.setCurrencyId(this._currencyId)}}};BX.Crm.EntityEditorProductRowProxy.prototype.onBeforeSubmit=function(){if(this._externalEditor){this._externalEditor.handleFormSubmit()}};BX.Crm.EntityEditorProductRowProxy.create=function(t,e){var i=new BX.Crm.EntityEditorProductRowProxy;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorToolPanel==="undefined"){BX.Crm.EntityEditorToolPanel=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._editor=null;this._isVisible=false;this._hasLayout=false;this._keyPressHandler=BX.delegate(this.onKeyPress,this)};BX.Crm.EntityEditorToolPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null);this._editor=BX.prop.get(this._settings,"editor",null);this._isVisible=BX.prop.getBoolean(this._settings,"visible",false)},getId:function(){return this._id},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isVisible:function(){return this._isVisible},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;this.adjustLayout()},disableSaveButton:function(){this._editButton.disabled=true;BX.addClass(this._editButton,"ui-btn-disabled")},enableSaveButton:function(){this._editButton.disabled=false;BX.removeClass(this._editButton,"ui-btn-disabled")},isDisabledSaveButton:function(){return typeof this._editButton!=="undefined"?this._editButton.disabled:false},layout:function(){this._editButton=BX.create("button",{props:{className:"ui-btn ui-btn-success",title:"[Ctrl+Enter]"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("a",{props:{className:"ui-btn ui-btn-link",title:"[Esc]"},text:BX.message("CRM_EDITOR_CANCEL"),attrs:{href:"#"},events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._errorContainer=BX.create("DIV",{props:{className:"crm-entity-section-control-error-block"}});this._errorContainer.style.maxHeight="0";this._wrapper=BX.create("DIV",{props:{className:"crm-entity-wrap"},children:[BX.create("DIV",{props:{className:"crm-entity-section crm-entity-section-control"},children:[this._editButton,this._cancelButton,this._errorContainer]})]});document.body.appendChild(this._wrapper);this._hasLayout=true;this.adjustLayout()},adjustLayout:function(){if(!this._hasLayout){return}if(!this._isVisible){BX.removeClass(this._wrapper,"crm-section-control-active");BX.unbind(document,"keydown",this._keyPressHandler)}else{BX.addClass(this._wrapper,"crm-section-control-active");BX.bind(document,"keydown",this._keyPressHandler)}},getPosition:function(){return this._hasLayout?BX.pos(this._wrapper):null}};BX.Crm.EntityEditorToolPanel.prototype.onSaveButtonClick=function(t){this._editor.saveChanged()};BX.Crm.EntityEditorToolPanel.prototype.onCancelButtonClick=function(t){this._editor.cancel();return BX.eventReturnFalse(t)};BX.Crm.EntityEditorToolPanel.prototype.onKeyPress=function(t){if(!this._isVisible){return}if(BX.Crm.EditorAuxiliaryDialog.hasOpenItems()){return}if(BX.type.isFunction(BX.PopupWindowManager.isAnyPopupShown)&&BX.PopupWindowManager.isAnyPopupShown()){return}t=t||window.event;if(t.keyCode==27){this._editor.cancel();BX.eventCancelBubble(t)}else if(t.keyCode==13&&t.ctrlKey){this._editor.saveChanged();BX.eventCancelBubble(t)}};BX.Crm.EntityEditorToolPanel.prototype.processSaveBegin=function(){BX.addClass(this._editButton,"ui-btn-clock")};BX.Crm.EntityEditorToolPanel.prototype.processSaveComplete=function(){BX.removeClass(this._editButton,"ui-btn-clock")};BX.Crm.EntityEditorToolPanel.prototype.addError=function(t){this._errorContainer.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-section-control-error-text"},html:t}));this._errorContainer.style.maxHeight=""};BX.Crm.EntityEditorToolPanel.prototype.clearErrors=function(){this._errorContainer.innerHTML="";this._errorContainer.style.maxHeight="0px"};BX.Crm.EntityEditorToolPanel.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorToolPanel.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.EntityEditorToolPanel.messages==="undefined"){BX.Crm.EntityEditorToolPanel.messages={}}BX.Crm.EntityEditorToolPanel.create=function(t,e){var i=new BX.Crm.EntityEditorToolPanel;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFieldSelector==="undefined"){BX.Crm.EntityEditorFieldSelector=function(){this._id="";this._settings={};this._scheme=null;this._excludedNames=null;this._closingNotifier=null;this._contentWrapper=null;this._popup=null};BX.Crm.EntityEditorFieldSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._scheme=BX.prop.get(this._settings,"scheme",null);if(!this._scheme){throw"BX.Crm.EntityEditorFieldSelector. Parameter 'scheme' is not found."}this._excludedNames=BX.prop.getArray(this._settings,"excludedNames",[]);this._closingNotifier=BX.CrmNotifier.create(this)},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityEditorFieldSelector.messages,t,t)},isSchemeElementEnabled:function(t){var e=t.getName();for(var i=0,n=this._excludedNames.length;i<n;i++){if(this._excludedNames[i]===e){return false}}return true},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},isOpened:function(){return this._popup&&this._popup.isShown()},open:function(){if(this.isOpened()){return}this._popup=new BX.PopupWindow(this._id,null,{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{},zIndex:1,titleBar:BX.prop.getString(this._settings,"title",""),events:{onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:this.prepareContent(),lightShadow:true,contentNoPaddings:true,buttons:[new BX.PopupWindowButton({text:this.getMessage("select"),className:"ui-btn ui-btn-success",events:{click:BX.delegate(this.onAcceptButtonClick,this)}}),new BX.PopupWindowButtonLink({text:this.getMessage("cancel"),className:"ui-btn ui-btn-link",events:{click:BX.delegate(this.onCancelButtonClick,this)}})]});this._popup.show()},close:function(){if(!(this._popup&&this._popup.isShown())){return}this._popup.close()},prepareContent:function(){this._contentWrapper=BX.create("div",{props:{className:"crm-entity-field-selector-window"}});var t=BX.create("div",{props:{className:"crm-entity-field-selector-window-list"}});this._contentWrapper.appendChild(t);var e=this._scheme.getElements();for(var i=0;i<e.length;i++){var n=e[i];if(!this.isSchemeElementEnabled(n)){continue}var r=[];var o=n.getElements();var s;for(var a=0;a<o.length;a++){s=o[a];if(s.isTransferable()&&s.getName()!==""){r.push(s)}}if(r.length===0){continue}var l=n.getName();var d=n.getTitle();t.appendChild(BX.create("div",{attrs:{className:"crm-entity-field-selector-window-list-caption"},text:d}));for(var h=0;h<r.length;h++){s=r[h];var p=s.getName();var u=s.getTitle();var c=l+"\\"+p;var m=BX.create("div",{attrs:{className:"crm-entity-field-selector-window-list-item"}});t.appendChild(m);m.appendChild(BX.create("input",{attrs:{id:c,type:"checkbox",className:"crm-entity-field-selector-window-list-checkbox"}}));m.appendChild(BX.create("label",{attrs:{for:c,className:"crm-entity-field-selector-window-list-label"},text:u}))}}return this._contentWrapper},getSelectedItems:function(){if(!this._contentWrapper){return[]}var t=[];var e=this._contentWrapper.querySelectorAll("input.crm-entity-field-selector-window-list-checkbox");for(var i=0,n=e.length;i<n;i++){var r=e[i];if(r.checked){var o=r.id.split("\\");if(o.length>=2){t.push({sectionName:o[0],fieldName:o[1]})}}}return t},onAcceptButtonClick:function(){this._closingNotifier.notify([{isCanceled:false,items:this.getSelectedItems()}]);this.close()},onCancelButtonClick:function(){this._closingNotifier.notify([{isCanceled:true}]);this.close()},onPopupClose:function(){if(this._popup){this._contentWrapper=null;this._popup.destroy()}},onPopupDestroy:function(){if(!this._popup){return}this._contentWrapper=null;this._popup=null}};if(typeof BX.Crm.EntityEditorFieldSelector.messages==="undefined"){BX.Crm.EntityEditorFieldSelector.messages={}}BX.Crm.EntityEditorFieldSelector.create=function(t,e){var i=new BX.Crm.EntityEditorFieldSelector(t,e);i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserSelector==="undefined"){BX.Crm.EntityEditorUserSelector=function(){this._id="";this._settings={}};BX.Crm.EntityEditorUserSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._isInitialized=false},getId:function(){return this._id},open:function(t){if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){return}if(!this._isInitialized){BX.SocNetLogDestination.init({name:this._id,extranetUser:false,bindMainPopup:{node:t,offsetTop:"5px",offsetLeft:"15px"},callback:{select:BX.delegate(this.onSelect,this)},showSearchInput:true,departmentSelectDisable:true,items:{users:BX.Crm.EntityEditorUserSelector.users,groups:{},sonetgroups:{},department:BX.Crm.EntityEditorUserSelector.department,departmentRelation:BX.SocNetLogDestination.buildDepartmentRelation(BX.Crm.EntityEditorUserSelector.department)},itemsLast:BX.Crm.EntityEditorUserSelector.last,itemsSelected:{},isCrmFeed:false,useClientDatabase:false,destSort:{},allowAddUser:false,allowSearchCrmEmailUsers:false,allowUserSearch:true});this._isInitialized=true}BX.SocNetLogDestination.openDialog(this._id,{bindNode:t});this._mainWindow=BX.SocNetLogDestination.containerWindow},close:function(){if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){BX.SocNetLogDestination.closeDialog();this._mainWindow=null;this._isInitialized=false}},onSelect:function(t,e,i,n){if(e!=="users"){return}var r=BX.prop.getFunction(this._settings,"callback",null);if(r){r(this,t)}}};BX.Crm.EntityEditorUserSelector.items={};BX.Crm.EntityEditorUserSelector.create=function(t,e){var i=new BX.Crm.EntityEditorUserSelector(t,e);i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityEditorCrmSelector==="undefined"){BX.Crm.EntityEditorCrmSelector=function(){this._id="";this._settings={};this._entityTypeIds=[];this._supportedItemTypes={}};BX.Crm.EntityEditorCrmSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._isInitialized=false;this._entityTypeIds=BX.prop.getArray(this._settings,"entityTypeIds",[]);this._supportedItemTypes=[];for(var i=0,n=this._entityTypeIds.length;i<n;i++){var r=this._entityTypeIds[i];if(r===BX.CrmEntityType.enumeration.contact){this._supportedItemTypes.push({name:"contacts",altName:"CRMCONTACT"})}else if(r===BX.CrmEntityType.enumeration.company){this._supportedItemTypes.push({name:"companies",altName:"CRMCOMPANY"})}else if(r===BX.CrmEntityType.enumeration.lead){this._supportedItemTypes.push({name:"leads",altName:"CRMLEAD"})}else if(r===BX.CrmEntityType.enumeration.deal){this._supportedItemTypes.push({name:"deals",altName:"CRMDEAL"})}}},getId:function(){return this._id},isOpened:function(){return BX.SocNetLogDestination.isOpenDialog()},open:function(t){if(this.isOpened()){return}if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){return}if(!this._isInitialized){var e={};var i={};var n=[];for(var r=0,o=this._supportedItemTypes.length;r<o;r++){var s=this._supportedItemTypes[r];e[s.name]=BX.Crm.EntityEditorCrmSelector[s.name];i[s.name]=BX.Crm.EntityEditorCrmSelector[s.name+"Last"];n.push(s.altName)}i["crm"]={};var a={name:this._id,extranetUser:false,bindMainPopup:{node:t,offsetTop:"20px",offsetLeft:"20px"},callback:{select:BX.delegate(this.onSelect,this)},showSearchInput:true,departmentSelectDisable:true,items:e,itemsLast:i,itemsSelected:{},useClientDatabase:false,destSort:{},allowAddUser:false,allowSearchCrmEmailUsers:false,allowUserSearch:false,isCrmFeed:true,CrmTypes:n};if(BX.prop.getBoolean(this._settings,"enableMyCompanyOnly",false)){a["enableMyCrmCompanyOnly"]=true}BX.SocNetLogDestination.init(a);this._isInitialized=true}BX.SocNetLogDestination.openDialog(this._id,{bindNode:t});this._mainWindow=BX.SocNetLogDestination.containerWindow},close:function(){if(!this.isOpened()){return}if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){BX.SocNetLogDestination.closeDialog();this._mainWindow=null}},onSelect:function(t,e,i,n,r,o){if(o!=="select"){return}var s=false;for(var a=0,l=this._supportedItemTypes.length;a<l;a++){var d=this._supportedItemTypes[a];if(d.name===e){s=true;break}}if(!s){return}var h=BX.prop.getFunction(this._settings,"callback",null);if(h){h(this,t)}}};if(typeof BX.Crm.EntityEditorCrmSelector.contacts==="undefined"){BX.Crm.EntityEditorCrmSelector.contacts={}}if(typeof BX.Crm.EntityEditorCrmSelector.contactsLast==="undefined"){BX.Crm.EntityEditorCrmSelector.contactsLast={}}if(typeof BX.Crm.EntityEditorCrmSelector.companies==="undefined"){BX.Crm.EntityEditorCrmSelector.companies={}}if(typeof BX.Crm.EntityEditorCrmSelector.companiesLast==="undefined"){BX.Crm.EntityEditorCrmSelector.companiesLast={}}if(typeof BX.Crm.EntityEditorCrmSelector.leads==="undefined"){BX.Crm.EntityEditorCrmSelector.leads={}}if(typeof BX.Crm.EntityEditorCrmSelector.leadsLast==="undefined"){BX.Crm.EntityEditorCrmSelector.leadsLast={}}if(typeof BX.Crm.EntityEditorCrmSelector.deals==="undefined"){BX.Crm.EntityEditorCrmSelector.deals={}}if(typeof BX.Crm.EntityEditorCrmSelector.dealsLast==="undefined"){BX.Crm.EntityEditorCrmSelector.dealsLast={}}BX.Crm.EntityEditorCrmSelector.items={};BX.Crm.EntityEditorCrmSelector.create=function(t,e){var i=new BX.Crm.EntityEditorCrmSelector(t,e);i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityBizprocManager==="undefined"){BX.Crm.EntityBizprocManager=function(){this._id="";this._settings={};this._moduleId="";this._entity="";this._documentType="";this._autoExecuteType=0;this._containerId=null;this._fieldName=null;this._validParameters=null;this._formInput=null;this._editor=null;this._starter=null};BX.Crm.EntityBizprocManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._hasParameters=BX.prop.getBoolean(this._settings,"hasParameters",false);this._moduleId=BX.prop.getString(this._settings,"moduleId","");this._entity=BX.prop.getString(this._settings,"entity","");this._documentType=BX.prop.getString(this._settings,"documentType","");this._autoExecuteType=BX.prop.getInteger(this._settings,"autoExecuteType",0);this._containerId=BX.prop.getString(this._settings,"containerId","");this._fieldName=BX.prop.getString(this._settings,"fieldName","");this._contentNode=this._containerId?BX(this._containerId):null;if(this._hasParameters){this._starter=new BX.Bizproc.Starter({moduleId:this._moduleId,entity:this._entity,documentType:this._documentType})}},onBeforeSave:function(t){var e=new BX.Promise;var i=function(){window.setTimeout(BX.delegate(function(){e.fulfill()},this),0)};if(t.getStatus()&&this._hasParameters&&this._validParameters===null){try{this._starter.showAutoStartParametersPopup(this._autoExecuteType,{contentNode:this._contentNode,callback:this.onFillParameters.bind(this,e)});this._contentNode=null}catch(t){if("console"in window){window.console.log("Error occurred when bizproc popup is going to show",t)}i()}}else{i()}return e},onAfterSave:function(){this._validParameters=null},onFillParameters:function(t,e){this._validParameters=e.parameters;if(!this._formInput&&this._editor){var i=this._editor.getFormElement();this._formInput=BX.create("input",{props:{type:"hidden",name:this._fieldName}});i.appendChild(this._formInput)}if(this._formInput){this._formInput.value=this._validParameters}t.fulfill()}};if(typeof BX.Crm.EntityBizprocManager.messages==="undefined"){BX.Crm.EntityBizprocManager.messages={}}BX.Crm.EntityBizprocManager.items={};BX.Crm.EntityBizprocManager.create=function(t,e){var i=new BX.Crm.EntityBizprocManager;i.initialize(t,e);this.items[t]=i;return i}}if(typeof BX.Crm.EntityRestPlacementManager==="undefined"){BX.Crm.EntityRestPlacementManager=function(){this._id="";this._entity="";this._editor=null};BX.Crm.EntityRestPlacementManager.items={};BX.Crm.EntityRestPlacementManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entity=this.getSetting("entity");var i=BX(this.getSetting("bottom_button_id"));if(i){BX.bind(i,"click",BX.proxy(this.openMarketplace,this))}BX.defer(this.initializeInterface,this)()},openMarketplace:function(){BX.rest.Marketplace.open({PLACEMENT:this.getSetting("placement")})},getSetting:function(t){return BX.prop.getString(this._settings,t,"")},initializeInterface:function(){if(!!BX.rest&&!!BX.rest.AppLayout){var t=BX.rest.AppLayout.initializePlacement("CRM_"+this._entity+"_DETAIL_TAB");var e=this._editor._entityTypeId,i=this._editor._entityId;t.prototype.resizeWindow=function(t,e){var i=BX(this.params.layoutName);t.height=parseInt(t.height);if(!!t.height){i.style.height=t.height+"px"}var n=BX.pos(i);e({width:n.width,height:n.height})};t.prototype.reloadData=function(t,n){BX.Crm.EntityEvent.fireUpdate(e,i,"");n()}}}};BX.Crm.EntityRestPlacementManager.create=function(t,e){var i=new BX.Crm.EntityRestPlacementManager;i.initialize(t,e);this.items[t]=i;return i}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:99:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/js/field-attr.min.js?154412740118988";s:6:"source";s:79:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/js/field-attr.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Crm");if(typeof BX.Crm.EntityFieldAttributeType==="undefined"){BX.Crm.EntityFieldAttributeType={undefined:0,hidden:1,readonly:2,required:3}}if(typeof BX.Crm.EntityFieldAttributePhaseGroupType==="undefined"){BX.Crm.EntityFieldAttributePhaseGroupType={undefined:0,general:1,pipeline:2,junk:3}}if(typeof BX.Crm.EntityFieldAttributeManager==="undefined"){BX.Crm.EntityFieldAttributeManager=function(){this._id="";this._settings=null;this._entityTypeId=BX.CrmEntityType.enumeration.undefined;this._entityScope=""};BX.Crm.EntityFieldAttributeManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",BX.CrmEntityType.enumeration.undefined);this._entityScope=BX.prop.getString(this._settings,"entityScope","")},isPermitted:function(){return BX.prop.getBoolean(this._settings,"isPermitted",true)},getEntityPhases:function(){var t=BX.CrmProgressManager.current.resolve(this._entityTypeId);return t?t.getInfos(this._entityScope):[]},createFieldConfigurator:function(t,e){return BX.Crm.EntityFieldAttributeConfigurator.create(this._id,{typeId:e,phases:this.getEntityPhases(),captions:BX.prop.getObject(this._settings,"captions",{}),config:t?t.getAttributeConfiguration(e):null,isPermitted:BX.prop.getBoolean(this._settings,"isPermitted",true),lockScript:BX.prop.getString(this._settings,"lockScript","")})},saveConfiguration:function(t,e){if(!this.isPermitted()){return}BX.ajax.runAction("crm.api.fieldAttribute.saveConfiguration",{data:{config:t,fieldName:e,entityTypeName:BX.CrmEntityType.resolveName(this._entityTypeId),entityScope:this._entityScope}})},removeConfiguration:function(t,e){if(!this.isPermitted()){return}BX.ajax.runAction("crm.api.fieldAttribute.removeConfiguration",{data:{type:t,fieldName:e,entityTypeName:BX.CrmEntityType.resolveName(this._entityTypeId),entityScope:this._entityScope}})}};BX.Crm.EntityFieldAttributeManager.create=function(t,e){var i=new BX.Crm.EntityFieldAttributeManager;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldAttributeConfigurator==="undefined"){BX.Crm.EntityFieldAttributeConfigurator=function(){this._id="";this._settings=null;this._typeId=BX.Crm.EntityFieldAttributeType.undefined;this._fieldName="";this._config=null;this._captions=null;this._phases=null;this._groups=null;this._button=null;this._wrapper=null;this._popup=null;this._label=null;this._switchCheckBox=null;this._switchCheckBoxHandler=BX.delegate(this.onSwitchCheckBoxClick,this);this._isPermitted=true;this._isEnabled=true;this._isOpened=false;this._isChanged=false;this._closingNotifier=BX.CrmNotifier.create(this)};BX.Crm.EntityFieldAttributeConfigurator.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._isPermitted=BX.prop.getBoolean(this._settings,"isPermitted",true);this._typeId=BX.prop.getInteger(this._settings,"type",BX.Crm.EntityFieldAttributeType.required);this._fieldName=BX.prop.getString(this._settings,"fieldName","");this._captions=BX.prop.getObject(this._settings,"captions",{});this._config=BX.prop.getObject(this._settings,"config",{});var i=BX.prop.getInteger(this._config,"typeId",BX.Crm.EntityFieldAttributeType.undefined);if(i===BX.Crm.EntityFieldAttributeType.undefined){this._config.typeId=this._typeId}else if(i!==this._typeId){throw"EntityFieldAttributeConfigurator. Configuration type mismatch."}this._phases=BX.prop.getArray(this._settings,"phases",[]);var r=[];var s=[];for(var n=0,o=this._phases.length;n<o;n++){var p=this._phases[n];var a=p["semantics"];if(a==="process"||a==="success"){r.push(p)}else{s.push(p)}}this._groups={};this.createGroup("general","",[{id:"GENERAL",name:this.getCaption("GROUP_TYPE_GENERAL")}],{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.general});if(r.length>0){this.createGroup("pipeline",this.getCaption("GROUP_TYPE_PIPELINE"),r,{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.pipeline})}if(s.length>0){this.createGroup("junk",this.getCaption("GROUP_TYPE_JUNK"),s,{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.junk})}this._isEnabled=!this.isEmpty()},getId:function(){return this._id},getTypeId:function(){return this._typeId},getCaption:function(t){return BX.prop.getString(this._captions,t,t)},getTitle:function(){if(this._typeId===BX.Crm.EntityFieldAttributeType.required){return this.getCaption("REQUIRED_FULL")+":"}return""},getPhaseIndexById:function(t){for(var e=0,i=this._phases.length;e<i;e++){if(this._phases[e]["id"]===t){return e}}return-1},getPhaseInfoById:function(t){var e=this.getPhaseIndexById(t);return e>=0?this._phases[e]:null},resolvePhaseName:function(t){if(t===""){return""}var e=this.getPhaseInfoById(t);return e?BX.prop.getString(e,"name",t):t},resolvePhaseGroupType:function(t){if(t===""){return BX.Crm.EntityFieldAttributePhaseGroupType.undefined}var e=this.getPhaseInfoById(t);if(!e){return BX.Crm.EntityFieldAttributePhaseGroupType.undefined}var i=BX.prop.getString(e,"semantics","");return i==="process"||i==="success"?BX.Crm.EntityFieldAttributePhaseGroupType.pipeline:BX.Crm.EntityFieldAttributePhaseGroupType.junk},prepareLegendData:function(){var t=BX.Crm.EntityPhaseLayout.getCurrent();var e=BX.prop.getArray(this._config,"groups",[]);for(var i=0,r=e.length;i<r;i++){var s=e[i];var n=BX.prop.getArray(s,"items",[]);if(n.length>0){var o=BX.prop.getString(n[0],"startPhaseId","");var p=this.getPhaseInfoById(o);if(p){var a=BX.prop.getString(p,"color","");if(a===""){var h=BX.prop.getString(p,"semantics","");if(h!==""){a=t.getBackgroundColor(h)}}var u=BX.Crm.EntityDetailProgressStep.calculateTextColor(a);return{text:BX.prop.getString(p,"name",o),backgroundColor:a,color:u}}}}return{text:this.getCaption("GROUP_TYPE_GENERAL"),backgroundColor:"#CED4DC",color:"#333"}},adjust:function(){var t=this.isEnabled();var e=this.isEmpty();if(t&&e){this._config=this.getDefaultConfiguration()}else if(!t&&!e){this._config=this.getEmptyConfiguration()}if(this._label){this._label.innerHTML=BX.util.htmlspecialchars(this.getTitle())}if(this._button){this._button.adjust()}},setEnabled:function(t){this._isEnabled=!!t},isEnabled:function(){return this._isEnabled},isChanged:function(){return this._isChanged},isEmpty:function(){return BX.prop.getArray(this._config,"groups",[]).length===0},isCustomized:function(){var t=BX.prop.getArray(this._config,"groups",[]);for(var e=0,i=t.length;e<i;e++){var r=BX.prop.getInteger(t[e],"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined);if(r===BX.Crm.EntityFieldAttributePhaseGroupType.undefined){continue}if(r!==BX.Crm.EntityFieldAttributePhaseGroupType.general){return true}}return false},isPermitted:function(){return this._isPermitted},runLockScript:function(){var lockScript=BX.prop.getString(this._settings,"lockScript","");if(lockScript!==""){eval(lockScript)}},getDefaultConfiguration:function(){return{typeId:this._typeId,groups:[{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.general}]}},getEmptyConfiguration:function(){return{typeId:this._typeId,groups:[]}},getConfiguration:function(){return this._config},acceptChanges:function(){if(!(this._isPermitted&&this._isChanged)){return}this._config=this.getEmptyConfiguration();if(this._groups["general"].isSelected()||this._groups["pipeline"].isFullySelected()&&!this._groups["junk"].isSelected()){this._config["groups"].push({phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.general})}else{this._groups["pipeline"].acceptChanges(this._config);this._groups["junk"].acceptChanges(this._config)}this._isChanged=false},applyConfiguration:function(){for(var t in this._groups){if(!this._groups.hasOwnProperty(t)){continue}this._groups[t].applyConfiguration(this._config)}},createGroup:function(t,e,i,r){if(!this._groups){this._groups={}}this._groups[t]=BX.Crm.EntityFieldAttributePhaseGroup.create(t,{title:e,configurator:this,isReadOnly:!this._isPermitted,phases:i,phaseGroupTypeId:BX.prop.getInteger(r,"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined)});return this._groups[t]},hasSelectedGroup:function(){for(var t in this._groups){if(!this._groups.hasOwnProperty(t)){continue}if(this._groups[t].isSelected()){return true}}return false},processGroupChange:function(t){if(!this._isPermitted){this.runLockScript();return}var e=t.getId();if(e==="general"){if(t.isSelected()){this._groups["pipeline"].setSelected(true);this._groups["junk"].setSelected(false)}else{this._groups["pipeline"].setSelected(false)}}else if(e==="pipeline"){this._groups["general"].setSelected(t.isFullySelected()&&!this._groups["junk"].isSelected())}else if(e==="junk"){if(t.isSelected()&&this._groups["general"].isSelected()){this._groups["general"].setSelected(false)}else if(!t.isSelected()&&this._groups["pipeline"].isFullySelected()){this._groups["general"].setSelected(true)}}this.setEnabled(this.hasSelectedGroup());if(!this._isChanged){this._isChanged=true}},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},open:function(t){if(this._isOpened){return}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:BX.prop.getInteger(this._settings,"zIndex",0),bindOptions:{forceBindPosition:true},content:this.prepareContent(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-step"}});var t=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-container"}});this._wrapper.appendChild(t);for(var e in this._groups){if(!this._groups.hasOwnProperty(e)){continue}var i=this._groups[e];i.setContainer(t);i.layout()}return this._wrapper},onPopupShow:function(){this._isOpened=true;this.applyConfiguration()},onPopupClose:function(){if(this._isPermitted){this.acceptChanges();if(this._switchCheckBox){this._switchCheckBox.checked=this._isEnabled}this.adjust()}if(this._popup){this._popup.destroy()}this._closingNotifier.notify([{config:this._config}])},onPopupDestroy:function(){this._isOpened=false;this._wrapper=null;this._innerWrapper=null;this._popup=null},getButton:function(){if(!this._button){this._button=BX.Crm.EntityFieldAttributeConfigButton.create(this._id,{configurator:this})}return this._button},getSwitchCheckBox:function(){return this._switchCheckBox},setSwitchCheckBox:function(t){if(this._switchCheckBox){BX.unbind(this._switchCheckBox,"click",this._switchCheckBoxHandler)}this._switchCheckBox=t;if(this._switchCheckBox){BX.bind(this._switchCheckBox,"click",this._switchCheckBoxHandler)}},getLabel:function(){return this._label},setLabel:function(t){this._label=t},onSwitchCheckBoxClick:function(t){this.setEnabled(this._switchCheckBox.checked);this.adjust()}};BX.Crm.EntityFieldAttributeConfigurator.create=function(t,e){var i=new BX.Crm.EntityFieldAttributeConfigurator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldAttributePhaseGroup==="undefined"){BX.Crm.EntityFieldAttributePhaseGroup=function(){this._id="";this._settings=null;this._phases=null;this._phaseGroupTypeId=BX.Crm.EntityFieldAttributePhaseGroupType.undefined;this._title="";this._isReadOnly=false;this._configurator=null;this._container=null;this._phaseCheckBoxes=null};BX.Crm.EntityFieldAttributePhaseGroup.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._phases=BX.prop.getArray(this._settings,"phases",[]);this._phaseGroupTypeId=BX.prop.getInteger(this._settings,"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined);this._isReadOnly=BX.prop.getBoolean(this._settings,"isReadOnly",false);this._title=BX.prop.getString(this._settings,"title",this._id);this._configurator=BX.prop.get(this._settings,"configurator",null);this._container=BX.prop.getElementNode(this._settings,"container",null)},getId:function(){return this._id},getPhaseGroupTypeId:function(){return this._phaseGroupTypeId},isReadOnly:function(){return this._isReadOnly},isSelected:function(){for(var t=0,e=this._phaseCheckBoxes.length;t<e;t++){if(this._phaseCheckBoxes[t].checked){return true}}return false},isFullySelected:function(){for(var t=0,e=this._phaseCheckBoxes.length;t<e;t++){if(!this._phaseCheckBoxes[t].checked){return false}}return true},setSelected:function(t){t=!!t;for(var e=0,i=this._phaseCheckBoxes.length;e<i;e++){this._phaseCheckBoxes[e].checked=t}},applyConfiguration:function(t){this.setSelected(false);var e=BX.prop.getArray(t,"groups",[]);for(var i=0,r=e.length;i<r;i++){var s=e[i];var n=BX.prop.getArray(s,"items",[]);var o=BX.prop.getInteger(s,"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined);if(o===BX.Crm.EntityFieldAttributePhaseGroupType.undefined&&n.length>0){o=this._configurator.resolvePhaseGroupType(BX.prop.getString(n[0],"startPhaseId",""))}if(o===BX.Crm.EntityFieldAttributePhaseGroupType.general){if(this._phaseGroupTypeId!==BX.Crm.EntityFieldAttributePhaseGroupType.junk){this.setSelected(true)}}else if(o===this._phaseGroupTypeId&&n.length>0){if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.pipeline){this.selectPhaseCheckBox(BX.prop.getString(n[0],"startPhaseId",""))}else if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.junk){for(var p=0,a=n.length;p<a;p++){this.selectPhaseCheckBox(BX.prop.getString(n[p],"startPhaseId",""))}}}}},acceptChanges:function(t){var e,i,r;var s=[];if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.pipeline){var n=-1;for(e=0,i=this._phaseCheckBoxes.length;e<i;e++){r=this._phaseCheckBoxes[e];if(r.checked){n=e;break}}if(n>=0){s.push({startPhaseId:this._phaseCheckBoxes[n]["id"],finishPhaseId:this._phaseCheckBoxes[this._phaseCheckBoxes.length-1]["id"]})}}else if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.junk){for(e=0,i=this._phaseCheckBoxes.length;e<i;e++){r=this._phaseCheckBoxes[e];if(!r.checked){continue}s.push({startPhaseId:r["id"],finishPhaseId:r["id"]})}}if(s.length>0){t["groups"].push({phaseGroupTypeId:this._phaseGroupTypeId,items:s})}},getContainer:function(){return this._container},setContainer:function(t){this._container=t},createPhaseCheckBox:function(t){if(!this._phaseCheckBoxes){this._phaseCheckBoxes=[]}var e=BX.create("input",{props:{id:t,type:"checkbox"},events:{click:BX.delegate(this.onCheckBoxClick,this)}});this._phaseCheckBoxes.push(e);return e},findCheckBox:function(t){for(var e=0,i=this._phaseCheckBoxes.length;e<i;e++){var r=this._phaseCheckBoxes[e];if(r["id"]===t){return r}}return null},selectPhaseCheckBox:function(t){var e=this.findCheckBox(t);if(!e){return}e.checked=true;this.processCheckBoxChange(e,false)},layout:function(){if(!this._container){return}this._phaseCheckBoxes=[];if(this._title!==""){this._container.appendChild(BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title"},children:[BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title-line"}}),BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title-text"},text:this._title}),BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title-line"}})]}))}var t=BX.Crm.EntityPhaseLayout.getCurrent();var e=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list"}});for(var i=0,r=this._phases.length;i<r;i++){var s=this._phases[i];var n=BX.create("label",{props:{className:"crm-entity-popup-field-addiction-step-item"},children:[this.createPhaseCheckBox(s["id"]),BX.create("span",{props:{className:"crm-entity-popup-field-addiction-step-item-text"},text:s["name"]})]});var o=BX.prop.getString(s,"color","");if(o===""){var p=BX.prop.getString(s,"semantics","");if(p!==""){o=t.getBackgroundColor(p)}}if(o!==""){n.style.backgroundColor=o;n.style.color=t.calculateTextColor(o)}else{BX.addClass(n,"crm-entity-popup-field-addiction-step-item-default")}e.appendChild(n)}this._container.appendChild(e)},onCheckBoxClick:function(t){this.processCheckBoxChange(BX.getEventTarget(t),true)},processCheckBoxChange:function(t,e){if(this._isReadOnly){t.checked=!t.checked}else{if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.pipeline){var i=false,r=false;for(var s=0,n=this._phaseCheckBoxes.length;s<n;s++){var o=this._phaseCheckBoxes[s];if(!i){i=t===o;if(i){if(r&&!o.checked){o.checked=true}continue}}if(o.checked!==i){o.checked=i;if(!i&&!r){r=true}}}}}if(e){this._configurator.processGroupChange(this)}}};BX.Crm.EntityFieldAttributePhaseGroup.create=function(t,e){var i=new BX.Crm.EntityFieldAttributePhaseGroup;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldAttributeConfigButton==="undefined"){BX.Crm.EntityFieldAttributeConfigButton=function(){this._id="";this._settings=null;this._configurator=null;this._wrapper=null;this._icon=null};BX.Crm.EntityFieldAttributeConfigButton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._configurator=BX.prop.get(this._settings,"configurator",null)},onClick:function(t){if(this._configurator.isEnabled()){this._configurator.open(this._wrapper)}},adjust:function(){var t=this._configurator.prepareLegendData();if(this._configurator.isEnabled()){BX.removeClass(this._wrapper,"crm-entity-new-field-addiction-step-disabled")}else{BX.addClass(this._wrapper,"crm-entity-new-field-addiction-step-disabled")}this._wrapper.style.backgroundColor=BX.prop.getString(t,"backgroundColor","#CED4DC");this._wrapper.style.color=BX.prop.getString(t,"color","#333");var e=this._wrapper.querySelector("span.crm-entity-new-field-addiction-step-arrow");if(e){e.style.color=BX.prop.getString(t,"color","#333")}var i=this._wrapper.querySelector("span.crm-entity-new-field-addiction-step-name");if(i){i.innerHTML=BX.util.htmlspecialchars(BX.prop.getString(t,"text","..."))}},prepareLayout:function(){var t=this._configurator.prepareLegendData();this._wrapper=BX.create("span",{props:{className:"crm-entity-new-field-addiction-step"},style:{backgroundColor:BX.prop.getString(t,"backgroundColor","#CED4DC"),color:BX.prop.getString(t,"color","#333")},children:[BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-name"},text:BX.prop.getString(t,"text","")}),BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-arrow"},children:[BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-arrow-inner"}})]})]});BX.bind(this._wrapper,"click",BX.delegate(this.onClick,this));return[this._wrapper]}};BX.Crm.EntityFieldAttributeConfigButton.create=function(t,e){var i=new BX.Crm.EntityFieldAttributeConfigButton;i.initialize(t,e);return i}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/order.min.js?1544127401161864";s:6:"source";s:71:"/bitrix/components/bitrix/crm.entity.editor/templates/.default/order.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Crm");if(typeof BX.Crm.EntityEditorOrderController==="undefined"){BX.Crm.EntityEditorOrderController=function(){BX.Crm.EntityEditorOrderController.superclass.constructor.apply(this);this._loader=null;this._productList=null;this._isRequesting=false;this._isCreateMode=false;this._editorModeChangeHandler=BX.delegate(this.onEditorModeChange,this);this._editorControlChangeHandler=BX.delegate(this.onEditorControlChange,this);this._ajaxOptsPreset={needFormData:true,needProductComponentParams:true,needToolPanel:true}};BX.extend(BX.Crm.EntityEditorOrderController,BX.Crm.EntityEditorController);BX.Crm.EntityEditorOrderController.prototype.setProductList=function(t){this._productList=t};BX.Crm.EntityEditorOrderController.prototype.doInitialize=function(){BX.Crm.EntityEditorOrderController.superclass.doInitialize.apply(this);BX.onCustomEvent(window,"EntityEditorOrderController",[this]);BX.addCustomEvent(window,BX.Crm.EntityEvent.names.create,BX.delegate(this.onAfterCreate,this));BX.addCustomEvent(window,BX.Crm.EntityEvent.names.update,BX.delegate(this.onAfterUpdate,this));BX.addCustomEvent("onPullEvent-crm",BX.delegate(this.onPullEvent,this));this._editor.addModeChangeListener(this._editorModeChangeHandler);window["ConnectedEntityController"]=this;this._model.lockField("PRICE");this._isCreateMode=this._model.getField("ID")<=0;if(!this._isCreateMode){this._model.lockField("CURRENCY")}else{BX.addCustomEvent(window,"onDeliveryExtraServiceValueChange",BX.delegate(this.onDeliveryExtraServiceValueChange,this))}};BX.Crm.EntityEditorOrderController.prototype.onPullEvent=function(t,e){if(t!=="onOrderSave"&&t!=="onOrderPaymentSave"&&t!=="onOrderShipmentSave"){return}if(this._editor.isRequestRunning()){return}if(!e.FIELDS||!e.FIELDS.ID||e.FIELDS.ID!==this._model.getField("ID")){return}if(t==="onOrderSave"){var r=new Date(BX.parseDate(this._model.getField("DATE_UPDATE")));var i=new Date(e.FIELDS.DATE_UPDATE);if(!r||!i||typeof r!=="object"||typeof i!=="object"||r.getTime()===i.getTime()){return}}if(!this._editor.isChanged()){this.loadOrder()}else{}};BX.Crm.EntityEditorOrderController.prototype.onDeliveryExtraServiceValueChange=function(){this.onDataChanged()};BX.Crm.EntityEditorOrderController.prototype.onEditorModeChange=function(t){if(this._editor.getMode()===BX.Crm.EntityEditorMode.edit){this._editor.addControlChangeListener(this._editorControlChangeHandler)}else{this._editor.removeControlChangeListener(this._editorControlChangeHandler)}};BX.Crm.EntityEditorOrderController.prototype.onEditorControlChange=function(t,e){var r=BX.prop.getString(e,"fieldName","");if(r!=="CURRENCY"){return}var i=BX.prop.getString(e,"fieldValue","");if(i!==""){this._editor._model.setField("CURRENCY",i,{enableNotification:false});this.onDataChanged()}};BX.Crm.EntityEditorOrderController.prototype.onAfterCreate=function(t){if(t&&t.entityData&&this._productList){this._productList.setFormData(t.entityData)}};BX.Crm.EntityEditorOrderController.prototype.onAfterUpdate=function(t){if(t&&t.entityData&&this._productList){this._productList.setFormData(t.entityData)}};BX.Crm.EntityEditorOrderController.prototype.onProductAdd=function(t,e){this.ajax("addProduct",{data:{PRODUCT_ID:t,QUANTITY:e}},this._ajaxOptsPreset)};BX.Crm.EntityEditorOrderController.prototype.isLoaderExists=function(){return this._loader!==null};BX.Crm.EntityEditorOrderController.prototype.showLoader=function(){document.body.appendChild(this.getLoader())};BX.Crm.EntityEditorOrderController.prototype.hideLoader=function(){if(this._loader&&this._loader.parentNode===document.body){document.body.removeChild(this._loader)}};BX.Crm.EntityEditorOrderController.prototype.getLoader=function(){if(!this.isLoaderExists()){this._loader=this.createLoader()}return this._loader};BX.Crm.EntityEditorOrderController.prototype.createLoader=function(){var t=document.createElementNS("http://www.w3.org/2000/svg","circle"),e=document.createElementNS("http://www.w3.org/2000/svg","circle"),r=document.createElementNS("http://www.w3.org/2000/svg","svg");BX.addClass(t,"crm-entity-order-controller-loader-path");t.setAttributeNS(null,"cx","50");t.setAttributeNS(null,"cy","50");t.setAttributeNS(null,"r","20");t.setAttributeNS(null,"fill","none");t.setAttributeNS(null,"stroke-miterlimit","10");BX.addClass(e,"crm-entity-order-controller-loader-inner-path");e.setAttributeNS(null,"cx","50");e.setAttributeNS(null,"cy","50");e.setAttributeNS(null,"r","20");e.setAttributeNS(null,"fill","none");t.setAttributeNS(null,"stroke-miterlimit","10");BX.addClass(r,"crm-entity-order-controller-loader-circular");r.setAttributeNS(null,"viewBox","25 25 50 50");r.appendChild(t);r.appendChild(e);return BX.create("div",{props:{className:"crm-entity-order-controller-loader-wrap"},children:[BX.create("div",{props:{className:"crm-entity-order-controller-loader-mask"}}),BX.create("div",{props:{className:"crm-entity-order-controller-loader-box"},children:[r]})]})};BX.Crm.EntityEditorOrderController.prototype.onProductCreate=function(t){if(BX.type.isNotEmptyObject(t)){this.ajax("createProduct",{data:{PRODUCT_DATA:t}},this._ajaxOptsPreset)}};BX.Crm.EntityEditorOrderController.prototype.onProductUpdate=function(t,e){if(BX.type.isNotEmptyObject(e)){this.ajax("updateProduct",{data:{PRODUCT_DATA:e,BASKET_ID:t}},this._ajaxOptsPreset)}};BX.Crm.EntityEditorOrderController.prototype.onChangeDelivery=function(t){this.ajax("changeDelivery",{data:{INDEX:t}},this._ajaxOptsPreset)};BX.Crm.EntityEditorOrderController.prototype.onProductDelete=function(t){this.ajax("deleteProduct",{data:{BASKET_CODE:t}},this._ajaxOptsPreset)};BX.Crm.EntityEditorOrderController.prototype.innerCancel=function(){BX.onCustomEvent(window,"EntityEditorOrderController:onInnerCancel",[this]);var t=[];for(var e=0,r=this._editor._activeControls.length;e<r;e++){var i=this._editor._activeControls[e];if(i.isChanged()){var n=this.getControlValue(i);for(var o in n){if(n.hasOwnProperty(o)){t[o]=n[o]}}}}this.ajax("rollback",{data:{CHANGED_DATA:t}},this._ajaxOptsPreset)};BX.Crm.EntityEditorOrderController.prototype.onCouponDelete=function(t){this.ajax("deleteCoupon",{data:{COUPON:t}},this._ajaxOptsPreset)};BX.Crm.EntityEditorOrderController.prototype.onCouponAdd=function(t){this.ajax("addCoupon",{data:{COUPON:t}},this._ajaxOptsPreset)};BX.Crm.EntityEditorOrderController.prototype.onRefreshOrderDataAndSave=function(){this._editor.getFormElement().appendChild(BX.create("input",{attrs:{type:"hidden",name:"REFRESH_ORDER_DATA_AND_SAVE",value:"Y"}}));this._editor.save()};BX.Crm.EntityEditorOrderController.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorOrderController.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorOrderController.prototype.openDetailSlider=function(t){if(this._editor.isChanged()){BX.Crm.EditorAuxiliaryDialog.create("order_save_confirmation",{title:this.getMessage("saveChanges"),content:this.getMessage("saveConfirm"),buttons:[{id:"save",type:BX.Crm.DialogButtonType.accept,text:this.getMessage("save"),callback:BX.proxy(function(e){this._editor.saveChanged();BX.Crm.Page.openSlider(t);e.getDialog().close()},this)},{id:"cancel",type:BX.Crm.DialogButtonType.cancel,text:this.getMessage("notSave"),callback:function(e){BX.Crm.Page.openSlider(t);e.getDialog().close()}}]}).open()}else{BX.Crm.Page.openSlider(t)}};BX.Crm.EntityEditorOrderController.prototype.ajax=function(t,e,r){if(!t){throw"action must be defined!"}if(this.isLockedSending()){return}this.lockSending();r=r||{};if(typeof r.showLoader==="undefined"){r.showLoader=true}if(r.showLoader){this.showLoader()}var i={ACTION:t,sessid:BX.bitrix_sessid()};if(r.needFormData){i.FORM_DATA=this.demandFormData()}if(r.needProductComponentParams){var n=this._editor.getContext();if(n.PRODUCT_COMPONENT_DATA){i["PRODUCT_COMPONENT_DATA"]=n.PRODUCT_COMPONENT_DATA}}if(typeof e.data==="object"){for(var o in e.data){if(e.data.hasOwnProperty(o)){i[o]=e.data[o]}}}BX.ajax({url:this.getConfigStringParam("serviceUrl",""),method:"POST",dataType:"json",data:i,onsuccess:e.onsuccess?e.onsuccess:BX.proxy(function(t){this.onSendDataSuccess(t,r)},this),onfailure:e.onfailure?e.onfailure:BX.delegate(this.onSendDataFailure,this)});if(r.needToolPanel){this._editor.showToolPanel()}};BX.Crm.EntityEditorOrderController.prototype.isLockedSending=function(){return this._isRequesting};BX.Crm.EntityEditorOrderController.prototype.lockSending=function(){this._isRequesting=true};BX.Crm.EntityEditorOrderController.prototype.unlockSending=function(){this._isRequesting=false};BX.Crm.EntityEditorOrderController.prototype.loadOrder=function(){this.ajax("loadOrder",{data:{ORDER_ID:this._model.getField("ID")}},{showLoader:false,needToolPanel:false,skipMarkAsChanged:true,needFormData:false,needProductComponentParams:true})};BX.Crm.EntityEditorOrderController.prototype.onSkuSelect=function(t){this.ajax("skuSelect",{data:{SKU_PROPS:t.SKU_PROPS,PRODUCT_ID:t.PRODUCT_ID,SKU_ORDER:t.SKU_ORDER,CHANGED_SKU_ID:t.CHANGED_SKU_ID,BASKET_CODE:t.BASKET_CODE}},this._ajaxOptsPreset)};BX.Crm.EntityEditorOrderController.prototype.demandFormData=function(){var t=BX.clone(this._editor._model.getData()),e=this._editor.getControls(),r,i={DELIVERY_SERVICES_LIST:true,EXTRA_SERVICES_HTML:true,STATUS_CONTROL:true};for(r=0;r<e.length;r++){var n=this.getControlValue(e[r]);for(var o in n){if(n.hasOwnProperty(o)){if(!i[o]){t[o]=n[o]}}}}if(this._isCreateMode){var s=this._editor.getFormElement();if(s){var a=BX.ajax.prepareForm(s);if(a&&a.data){if(a.data.SHIPMENT&&a.data.SHIPMENT[0]&&a.data.SHIPMENT[0].EXTRA_SERVICES){t.SHIPMENT[0].EXTRA_SERVICES=a.data.SHIPMENT[0].EXTRA_SERVICES}if(a.data.DISCOUNTS&&a.data.DISCOUNTS.DELIVERY){if(!t.DISCOUNTS){t.DISCOUNTS={}}t.DISCOUNTS.DELIVERY=a.data.DISCOUNTS.DELIVERY}}}}else{if(typeof t.PAYMENT!=="undefined"){for(r in t.PAYMENT){if(t.PAYMENT[r]["SUM"]){delete t.PAYMENT[r]["SUM"]}}}}t["SITE_ID"]=this.getSiteId();var d={};if(this._productList){d=BX.mergeEx(d,this._productList.getFormData())}t=BX.mergeEx(d,t);return t};BX.Crm.EntityEditorOrderController.prototype.getControlValue=function(t){var e=[];if(!t instanceof BX.Crm.EntityEditorControl)return e;var r=[];if(t instanceof BX.Crm.EntityEditorSection){var i=t.getChildren();for(var n=0;n<t.getChildCount();n++){r=this.getControlValue(i[n]);for(var o in r){if(r.hasOwnProperty(o)){e[o]=r[o]}}}}else if(t.isChanged()){e[t.getName()]=t.getRuntimeValue()}return e};BX.Crm.EntityEditorOrderController.prototype.getSiteId=function(){var t=this._editor.getContext();return t.SITE_ID?t.SITE_ID:""};BX.Crm.EntityEditorOrderController.prototype.onDataChanged=function(t){var e={};if(BX.type.isNotEmptyObject(t)){if(t.actionBefore){e["ACTION_BEFORE"]=t.actionBefore}if(t.actionAfter){e["ACTION_AFTER"]=t.actionAfter}if(t.data){e["ADDITIONAL_DATA"]=t.data}}this.ajax("refreshOrderData",{data:e,onsuccess:BX.proxy(function(e){if(BX.type.isNotEmptyObject(t)&&t.callbackBefore&&typeof t.callbackBefore==="function"){t.callbackBefore.call(null,e)}this.onSendDataSuccess(e);if(BX.type.isNotEmptyObject(t)&&t.callbackAfter&&typeof t.callbackAfter==="function"){t.callbackAfter.call(null,e)}},this)},this._ajaxOptsPreset)};BX.Crm.EntityEditorOrderController.prototype.onSendDataSuccess=function(t,e){var r=e&&e.skipMarkAsChanged||false;this.unlockSending();this.hideLoader();this._editor._toolPanel.clearErrors();if(t){if(t.ERROR){if(!this._editor._toolPanel.isVisible()){this._editor._toolPanel.setVisible(true)}this._editor._toolPanel.addError(t.ERROR)}if(t.ORDER_DATA){this._model.setData(t.ORDER_DATA);if(!r){this.markAsChanged()}if(t.ORDER_DATA.PROPERTIES_SCHEME){setTimeout(BX.delegate(function(){BX.onCustomEvent(window,"Crm.OrderModel.ChangePropertyScheme",[t.ORDER_DATA.PROPERTIES_SCHEME])},this),0)}if(t.ORDER_DATA.USER_PROFILE_LIST){var i=BX.prop.getArray(t.ORDER_DATA,"USER_PROFILE_LIST");var n=this._editor.getControls();for(var o=0;o<n.length;o++){var s=n[o].getChildById("USER_PROFILE");if(s){s._items=null;s._schemeElement.setData({items:i});if(BX.type.isNotEmptyString(t.ORDER_DATA.USER_PROFILE)){this._model.setField("USER_PROFILE",t.ORDER_DATA.USER_PROFILE,{enableNotification:false})}s.refreshLayout()}}}if(this._productList){this._productList.setFormData(t)}}}};BX.Crm.EntityEditorOrderController.prototype.onSendDataFailure=function(t,e){this.unlockSending();this.hideLoader();BX.debug(e.message)};BX.Crm.EntityEditorOrderController.prototype.onBeforeSubmit=function(){this.setFormField(this.getConfigStringParam("dataFieldName",""),"["+JSON.stringify(this.demandFormData())+"]")};BX.Crm.EntityEditorOrderController.prototype.setFormField=function(t,e){var r=this._editor.getFormElement();if(r.elements[t]){r.elements[t].value=e}else{r.appendChild(BX.create("input",{attrs:{type:"hidden",name:t,value:e}}))}};BX.Crm.EntityEditorOrderController.prototype.onBeforesSaveControl=function(t){t[this.getConfigStringParam("dataFieldName","")]=JSON.stringify([this.demandFormData()]);return t};BX.Crm.EntityEditorOrderController.create=function(t,e){var r=new BX.Crm.EntityEditorOrderController;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderShipmentController==="undefined"){BX.Crm.EntityEditorOrderShipmentController=function(){BX.Crm.EntityEditorOrderShipmentController.superclass.constructor.apply(this);this._productList=null;this._isRequesting=false};BX.extend(BX.Crm.EntityEditorOrderShipmentController,BX.Crm.EntityEditorController);BX.Crm.EntityEditorOrderShipmentController.prototype.setProductList=function(t){this._productList=t};BX.Crm.EntityEditorOrderShipmentController.prototype.doInitialize=function(){BX.onCustomEvent(window,"onEntityEditorOrderShipmentControllerInit",[this]);BX.addCustomEvent(window,"onDeliveryExtraServiceValueChange",BX.delegate(this.onDeliveryExtraServiceValueChange,this));window["EntityEditorOrderShipmentController"]=this;this._model.lockField("CURRENCY")};BX.Crm.EntityEditorOrderShipmentController.prototype.onDeliveryExtraServiceValueChange=function(){this.onDataChanged()};BX.Crm.EntityEditorOrderShipmentController.prototype.innerCancel=function(){this.ajax("rollback",{},{skipMarkAsChanged:true})};BX.Crm.EntityEditorOrderShipmentController.prototype.onBeforeSubmit=function(){var t=this._editor.getControlById("PRICE_DELIVERY_WITH_CURRENCY");if(t&&t.isChanged()){this.setCustomPriceDelivery()}if(this._productList){var e="["+JSON.stringify(this._productList.getFormData())+"]",r=this._editor.getFormElement(),i=this.getConfigStringParam("productDataFieldName","");if(r.elements[i]){r.elements[i].value=e}else{r.appendChild(BX.create("input",{attrs:{type:"hidden",name:i,value:e}}))}}};BX.Crm.EntityEditorOrderShipmentController.prototype.onChangeDelivery=function(){this.ajax("changeDelivery")};BX.Crm.EntityEditorOrderShipmentController.prototype.setCustomPriceDelivery=function(){var t=this._editor.getFormElement();if(t.elements["CUSTOM_PRICE_DELIVERY"]){t.elements["CUSTOM_PRICE_DELIVERY"].value="Y"}else{t.appendChild(BX.create("input",{attrs:{type:"hidden",name:"CUSTOM_PRICE_DELIVERY",value:"Y"}}))}};BX.Crm.EntityEditorOrderShipmentController.prototype.onProductAdd=function(t){this.ajax("addProduct",{data:{BASKET_ID:t}})};BX.Crm.EntityEditorOrderShipmentController.prototype.onProductDelete=function(t){this.ajax("deleteProduct",{data:{BASKET_CODE:t}})};BX.Crm.EntityEditorOrderShipmentController.prototype.ajax=function(t,e,r){if(!t){throw"action must be defined!"}if(this._isRequesting){return}this._isRequesting=true;e=e||{};r=r||{};var i={ACTION:t,sessid:BX.bitrix_sessid()};i.FORM_DATA=this.demandFormData();var n=this._editor.getContext();if(n.PRODUCT_COMPONENT_DATA){i["PRODUCT_COMPONENT_DATA"]=n.PRODUCT_COMPONENT_DATA}if(typeof e.data==="object"){for(var o in e.data){if(e.data.hasOwnProperty(o)){i[o]=e.data[o]}}}BX.ajax({url:this.getConfigStringParam("serviceUrl",""),method:"POST",dataType:"json",data:i,onsuccess:e.onsuccess?e.onsuccess:BX.proxy(function(t){this.onSendDataSuccess(t,r)},this),onfailure:e.onfailure?e.onfailure:BX.delegate(this.onSendDataFailure,this)})};BX.Crm.EntityEditorOrderShipmentController.prototype.demandFormData=function(){var t=this._editor._model.getData(),e=this._editor.getControls(),r,i={DELIVERY_SERVICES_LIST:true,EXTRA_SERVICES_DATA:true,STATUS_CONTROL:true};var n=this._editor.getContext();t["ORDER_ID"]=n.ORDER_ID?n.ORDER_ID:0;for(r=0;r<e.length;r++){var o=this.getControlValue(e[r]);for(var s in o){if(o.hasOwnProperty(s)){if(!i[s]){t[s]=o[s]}}}}var a=this._editor.getFormElement();if(a){var d=BX.ajax.prepareForm(a);if(d&&d.data){for(r in d.data){if(d.data.hasOwnProperty(r)){t[r]=d.data[r]}}}}if(this._productList){t=BX.mergeEx(this._productList.getFormData(),t)}return t};BX.Crm.EntityEditorOrderShipmentController.prototype.getControlValue=function(t){var e=[];if(!t instanceof BX.Crm.EntityEditorControl)return e;var r=[];if(t instanceof BX.Crm.EntityEditorSection){var i=t.getChildren();for(var n=0;n<t.getChildCount();n++){r=this.getControlValue(i[n]);for(var o in r){if(r.hasOwnProperty(o)){e[o]=r[o]}}}}else if(t.isChanged()){e[t.getName()]=t.getRuntimeValue()}return e};BX.Crm.EntityEditorOrderShipmentController.prototype.onDataChanged=function(){this.ajax("refreshShipmentData")};BX.Crm.EntityEditorOrderShipmentController.prototype.markAsChangedItem=function(){this._editor._toolPanel.enableSaveButton();this._editor._toolPanel.clearErrors();this.markAsChanged()};BX.Crm.EntityEditorOrderShipmentController.prototype.onSendDataSuccess=function(t,e){var r=this._editor._toolPanel;var i=e&&e.skipMarkAsChanged||false;this._isRequesting=false;r.clearErrors();if(t){if(t.ERROR){r.addError(t.ERROR);if(!r.isDisabledSaveButton()){r.disableSaveButton()}this._editor.showToolPanel()}if(t.SHIPMENT_DATA){if(t.SHIPMENT_DATA.CUSTOM_PRICE_DELIVERY==="Y"){this.setCustomPriceDelivery()}this._model.setData(t.SHIPMENT_DATA);if(!i){this.markAsChanged()}if(this._productList!==null){this._productList.setFormData(t)}if(t.SHIPMENT_DATA.DELIVERY_LOGO!=="undefined"){var n=this._editor.getControlById("DELIVERY_LOGO");if(n){n.refreshLayout()}}if(r.isDisabledSaveButton()){r.enableSaveButton()}}}};BX.Crm.EntityEditorOrderShipmentController.prototype.onSendDataFailure=function(t,e){this._isRequesting=false;BX.debug(e.message)};BX.Crm.EntityEditorOrderShipmentController.create=function(t,e){var r=new BX.Crm.EntityEditorOrderShipmentController;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderExtraServicesWrapper==="undefined"){var mode="";BX.Crm.EntityEditorOrderExtraServicesWrapper=function(t){mode=t.mode};BX.Crm.EntityEditorOrderExtraServicesWrapper.prototype.wrapItem=function(t){var e=mode==="view"?t.VIEW_HTML:t.EDIT_HTML;return this.wrapDomNode(t.NAME,createDomNodeFromHtml(e),t.PRICE,t.COST).childNodes};BX.Crm.EntityEditorOrderExtraServicesWrapper.prototype.wrapDomNode=function(t,e,r,i){e=wrap(e,r,i,mode);if(t){e=addName(t,e)}return e};var addName=function(t,e){var r=e.querySelector(".crm-entity-widget-content-block");if(r){r.insertBefore(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},html:t})]}),r.children[0])}return e};var createDomNodeFromHtml=function(t){return BX.create("div",{html:t})};var wrap=function(t,e,r,i){if(i==="edit"){t.querySelectorAll("input[type=checkbox]").forEach(function(t,i,n){wrapCheckbox(t,e,r)},this);t.querySelectorAll("input[type=text]").forEach(function(t,i,n){wrapTextInput(t,e,r)},this);t.querySelectorAll("select").forEach(function(t,i,n){wrapSelect(t,e,r)},this)}else{var n,o=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,false);while(n=o.nextNode()){var s=n.data,a=BX.create("span",{html:s});n.parentNode.replaceChild(getWrappedText(a,e,r),n)}}return t};var getWrappedText=function(t,e,r){var i=null;if(t){i=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},children:[t.innerHTML+(e&&r?" ("+r+") ":"")]})]})]})}return i};var wrapCheckbox=function(t,e,r){if(!t){return}t.className="crm-entity-widget-content-checkbox";t.parentNode.replaceChild(BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-checkbox"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("label",{props:{className:"crm-entity-widget-content-block-checkbox-label"},children:[t.cloneNode(true),BX.create("span",{props:{className:"crm-entity-widget-content-block-checkbox-description"},html:e})]})]})]}),t)};var wrapTextInput=function(t,e,r){if(!t){return}t.className="crm-entity-widget-content-input";t.parentNode.replaceChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[t.cloneNode(true),BX.create("span",{props:{className:"crm-entity-widget-content-block-checkbox-description"},html:"X "+e})]})]})]}),t)};var wrapSelect=function(t,e,r){if(!t){return}t.className="crm-entity-widget-content-input";t.parentNode.replaceChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[t.cloneNode(true)]})]})]}),t)}}if(typeof BX.Crm.EntityEditorOrderPaymentController==="undefined"){BX.Crm.EntityEditorOrderPaymentController=function(){BX.Crm.EntityEditorOrderPaymentController.superclass.constructor.apply(this);this._isRequesting=false};BX.extend(BX.Crm.EntityEditorOrderPaymentController,BX.Crm.EntityEditorController);BX.Crm.EntityEditorOrderPaymentController.prototype.doInitialize=function(){BX.onCustomEvent(window,"onEntityEditorOrderPaymentControllerInit",[this]);window["EntityEditorOrderPaymentController"]=this;this._model.lockField("CURRENCY")};BX.Crm.EntityEditorOrderPaymentController.prototype.ajax=function(t,e,r){if(!t){throw"action must be defined!"}if(this._isRequesting){return}this._isRequesting=true;e=e||{};r=r||{};var i={ACTION:t,sessid:BX.bitrix_sessid()};i.FORM_DATA=this.demandFormData();if(typeof e.data==="object"){for(var n in e.data){if(e.data.hasOwnProperty(n)){i[n]=e.data[n]}}}BX.ajax({url:this.getConfigStringParam("serviceUrl",""),method:"POST",dataType:"json",data:i,onsuccess:e.onsuccess?e.onsuccess:BX.proxy(function(t){this.onSendDataSuccess(t,r)},this),onfailure:e.onfailure?e.onfailure:BX.delegate(this.onSendDataFailure,this)});this._isRequesting=false};BX.Crm.EntityEditorOrderPaymentController.prototype.onDataChanged=function(){this.ajax("refreshPaymentData")};BX.Crm.EntityEditorOrderPaymentController.prototype.demandFormData=function(){var t=this._editor._model.getData(),e=this._editor.getControls(),r;var i=this._editor.getContext();t["ORDER_ID"]=i.ORDER_ID?i.ORDER_ID:0;for(r=0;r<e.length;r++){var n=this.getControlValue(e[r]);for(var o in n){if(n.hasOwnProperty(o)){t[o]=n[o]}}}return t};BX.Crm.EntityEditorOrderPaymentController.prototype.getControlValue=function(t){var e=[];if(!t instanceof BX.Crm.EntityEditorControl)return e;var r=[];if(t instanceof BX.Crm.EntityEditorSection){var i=t.getChildren();for(var n=0;n<t.getChildCount();n++){r=this.getControlValue(i[n]);for(var o in r){if(r.hasOwnProperty(o)){e[o]=r[o]}}}}else if(t.isChanged()){e[t.getName()]=t.getRuntimeValue()}return e};BX.Crm.EntityEditorOrderPaymentController.prototype.onBeforeSubmit=function(){var t="["+JSON.stringify(this.demandFormData())+"]",e=this._editor.getFormElement(),r=this.getConfigStringParam("dataFieldName","");e.appendChild(BX.create("input",{attrs:{type:"hidden",name:r,value:t}}))};BX.Crm.EntityEditorOrderPaymentController.prototype.innerCancel=function(){this.ajax("rollback",{},{skipMarkAsChanged:this._isChanged})};BX.Crm.EntityEditorOrderPaymentController.prototype.onSendDataSuccess=function(t,e){var r=e&&e.skipMarkAsChanged||false;var i=e&&e.sendUpdateEvent||false;this._isRequesting=false;this._editor._toolPanel.clearErrors();if(t){if(t.ERROR){this._editor._toolPanel.addError(t.ERROR)}if(t.PAYMENT_DATA){this._model.setData(t.PAYMENT_DATA);if(!r){this.markAsChanged()}if(i){window.top.BX.SidePanel.Instance.postMessage(window,"CrmOrderPayment::Update",{field:t.PAYMENT_DATA,entityTypeId:BX.CrmEntityType.enumeration.orderpayment})}}}};BX.Crm.EntityEditorOrderPaymentController.prototype.onSendDataFailure=function(t,e){this._isRequesting=false;BX.debug(e.message)};BX.Crm.EntityEditorOrderPaymentController.create=function(t,e){var r=new BX.Crm.EntityEditorOrderPaymentController;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderProductController==="undefined"){BX.Crm.EntityEditorOrderProductController=function(){BX.Crm.EntityEditorOrderProductController.superclass.constructor.apply(this);this._isRequesting=false};BX.extend(BX.Crm.EntityEditorOrderProductController,BX.Crm.EntityEditorController);BX.Crm.EntityEditorOrderProductController.prototype.doInitialize=function(){this._model.lockField("CURRENCY")};BX.Crm.EntityEditorOrderProductController.create=function(t,e){var r=new BX.Crm.EntityEditorOrderProductController;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorPayment==="undefined"){BX.Crm.EntityEditorPayment=function(){BX.Crm.EntityEditorPayment.superclass.constructor.apply(this);this._view=null;this._isPaidButtonMenuOpened={};this._paySystemInputs={};this._sumInput={};this._isReturn={};this._logoImg={};this._paidInput={};this._datePaid={};this._currency={};this._paidButtons={};this._documentLinks={};this._documentInnerData={};this._paymentBlocks={};this._documentType={voucher:1,return:2};this._isCreateMode=false;this._customPaymentSumm={};this._paySystemName={};this._sumFormatted={};this._orderController=null};BX.extend(BX.Crm.EntityEditorPayment,BX.Crm.EntityEditorField);if(typeof BX.Crm.EntityEditorPayment.messages==="undefined"){BX.Crm.EntityEditorPayment.messages={}}BX.Crm.EntityEditorPayment.prototype.getItemField=function(t,e){var r=this._model.getField(this.getName()),i="";if(r&&r[t]&&typeof r[t][e]!=="undefined"){i=r[t][e]}return i};BX.Crm.EntityEditorPayment.prototype.setItemField=function(t,e,r){var i=this._model.getField(this.getName());if(i&&i[t]){i[t][e]=r;this._model.setField(this.getName(),i,{originator:this})}};BX.Crm.EntityEditorPayment.prototype.onPaySystemSelect=function(t){this.setItemField(t,"PAY_SYSTEM_ID",this._paySystemInputs[t].value);this.markAsChanged();this.getOrderController().onDataChanged()};BX.Crm.EntityEditorPayment.prototype.getOrderController=function(){if(this._orderController===null){for(var t=0,e=this._editor._controllers.length;t<e;t++){if(this._editor._controllers[t]instanceof BX.Crm.EntityEditorOrderController){this._orderController=this._editor._controllers[t];break}}}return this._orderController};BX.Crm.EntityEditorPayment.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorPayment.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorPayment.prototype.doInitialize=function(){BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(this.onExternalChange,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(this.onPaymentVoucherUpdate,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(this.onPaymentVoucherInited,this));this._isCreateMode=this._model.getField("ID","n0").charAt(0)==="n"};BX.Crm.EntityEditorPayment.prototype.createPaymentContent=function(t,e){if(this._mode===BX.Crm.EntityEditorMode.edit){return this.createPaymentContentEdit(t,e)}else{return this.createPaymentContentView(t,e)}};BX.Crm.EntityEditorPayment.prototype.processErrors=function(t){if(t.length){var e="";for(var r=0,i=t.length-1;r<=i;r++){e+=t[r]+"\n"}if(e){e=BX.util.htmlspecialchars(e);this.showError(e);this._editor._toolPanel.addError(e)}}};BX.Crm.EntityEditorPayment.prototype.createPaySystemList=function(t,e){var r=this,i=BX.create("select",{props:{name:"PAYMENT["+t+"][PAY_SYSTEM_ID]"},events:{change:function(){r.onPaySystemSelect(t,this[this.selectedIndex].value,e)}}});for(var n in e.PAY_SYSTEMS_LIST){if(!e.PAY_SYSTEMS_LIST.hasOwnProperty(n)){continue}var o=e.PAY_SYSTEM_ID===e.PAY_SYSTEMS_LIST[n].ID;var s=new Option(e.PAY_SYSTEMS_LIST[n].NAME,e.PAY_SYSTEMS_LIST[n].ID,o,o);i.options.add(s)}return i};BX.Crm.EntityEditorPayment.prototype.createLogo=function(t,e){return BX.create("img",{props:{className:"crm-entity-widget-content-block-inner-order-logo",id:"crm_entity_editor_payment_logotip_"+t,src:e.PAY_SYSTEM_LOGO_PATH,alt:e.PAY_SYSTEM_NAME}})};BX.Crm.EntityEditorPayment.prototype.createSumInput=function(t,e){return BX.create("input",{props:{className:"crm-entity-widget-content-input",name:"PAYMENT["+t+"][SUM]",id:"crm_entity_editor_is_payment_sum_"+t,type:"text",value:e.FORMATTED_SUM,size:40},events:{change:BX.delegate(function(e){this.onPaymentSumChanged(e,t)},this)}})};BX.Crm.EntityEditorPayment.prototype.createPaidInput=function(t,e){return BX.create("input",{props:{name:"PAYMENT["+t+"][PAID]",id:"crm_entity_editor_is_payment_paid_input_"+t,type:"hidden",value:e.PAID}})};BX.Crm.EntityEditorPayment.prototype.createIsReturnInput=function(t,e){return BX.create("input",{props:{name:"PAYMENT["+t+"][IS_RETURN]",id:"crm_entity_editor_is_payment_paid_is_return_"+t,type:"hidden",value:e.IS_RETURN}})};BX.Crm.EntityEditorPayment.prototype.createCurrency=function(t,e){return BX.create("span",{props:{className:"crm-entity-widget-content-block-wallet"},html:e.CURRENCY_NAME})};BX.Crm.EntityEditorPayment.prototype.creatDatePaid=function(t,e){return BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-controls-text"},html:e.DATE_PAID})};BX.Crm.EntityEditorPayment.prototype.createPaymentContentEdit=function(t,e){var r=this.getItemField(t,"PAID")==="Y";this._isPaidButtonMenuOpened[t]=false;this._paidButtons[t]=this.createPaymentButton(t,r);this._paySystemInputs[t]=this.createPaySystemList(t,e);this._logoImg[t]=this.createLogo(t,e);this._sumInput[t]=this.createSumInput(t,e);this._paidInput[t]=this.createPaidInput(t,e);this._isReturn[t]=this.createIsReturnInput(t,e);this._currency[t]=this.createCurrency(t,e);this._datePaid[t]=this.creatDatePaid(t,e);var i=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-title"},children:[BX.create("span",{props:{className:"fields enumeration field-wrap"},style:{width:"100%"},children:[BX.create("span",{props:{className:"fields enumeration field-item"},children:[this._paySystemInputs[t]]})]})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-content-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-content-left"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-logo-container"},children:[this._logoImg[t]]})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-content-right"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-money"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},html:this.getMessage("sum")})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._sumInput[t],this._currency[t]]})]})]})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-custom"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-controls"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-controls-row"},children:[this._paidButtons[t],this._datePaid[t],this._paidInput[t],this._isReturn[t]]})]})]})]})]})]})]})]})]});if(BX.type.isNotEmptyString(e.VOUCHER_INFO)){text=this.getMessage("documentTitle")+": "+e.VOUCHER_INFO}else{text=this.getMessage("addDocument")}this._documentLinks[e.ID]=BX.create("a",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:text,events:{click:BX.delegate(function(t){this.onAddDocumentClick(t,e.ID,r)},this)}});if(BX.prop.getNumber(e,"ID",0)===0){this._documentInnerData[e.ID]={index:t,values:{PAY_VOUCHER_NUM:BX.prop.getString(e,"PAY_VOUCHER_NUM",""),PAY_VOUCHER_DATE:BX.prop.getString(e,"PAY_VOUCHER_DATE","")}}}i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this._documentLinks[e.ID]]}));return i};BX.Crm.EntityEditorPayment.prototype.onPaymentSumChanged=function(t,e){t=t||window.event;var r=t.target||t.srcElement,i=this;this._customPaymentSumm[e]=true;this._editor.formatMoney(r.value,this.getModel().getField("CURRENCY",""),function(t){i.setItemField(e,"SUM",r.value);if(t.FORMATTED_SUM){r.value=t.FORMATTED_SUM;i.setItemField(e,"FORMATTED_SUM",t.FORMATTED_SUM)}if(t.FORMATTED_SUM_WITH_CURRENCY){i.setItemField(e,"FORMATTED_SUM_WITH_CURRENCY",t.FORMATTED_SUM_WITH_CURRENCY)}})};BX.Crm.EntityEditorPayment.prototype.createPaySystemName=function(t,e){return BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-title"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-title-text"},html:e.PAY_SYSTEM_NAME}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-title-desc"},children:[BX.create("a",{style:{cursor:"pointer"},html:e.NUMBER_AND_DATE,events:{click:BX.proxy(function(){this.getOrderController().openDetailSlider("/shop/orders/payment/details/"+parseInt(e.ID)+"/")},this)}})]})]})};BX.Crm.EntityEditorPayment.prototype.openPaymentDetail=function(t){if(this._editor.isChanged()){BX.Crm.EditorAuxiliaryDialog.create("order_save_confirmation",{title:this.getMessage("saveChanges"),content:this.getMessage("saveConfirm"),buttons:[{id:"save",type:BX.Crm.DialogButtonType.accept,text:this.getMessage("save"),callback:BX.proxy(function(e){this._editor.saveChanged();BX.Crm.Page.openSlider("/shop/orders/payment/details/"+parseInt(t)+"/");e.getDialog().close()},this)},{id:"cancel",type:BX.Crm.DialogButtonType.cancel,text:this.getMessage("notSave"),callback:function(e){BX.Crm.Page.openSlider("/shop/orders/payment/details/"+parseInt(t)+"/");e.getDialog().close()}}]}).open()}else{BX.Crm.Page.openSlider("/shop/orders/payment/details/"+parseInt(t)+"/")}};BX.Crm.EntityEditorPayment.prototype.createSumFormatted=function(t,e){return BX.create("span",{props:{className:"crm-entity-widget-content-block-colums-right"},html:e.FORMATTED_SUM_WITH_CURRENCY})};BX.Crm.EntityEditorPayment.prototype.createPaymentContentView=function(t,e){var r=e.PAID==="Y";this._isPaidButtonMenuOpened[t]=false;this._paidButtons[t]=this.createPaymentButton(t,r);this._paySystemName[t]=this.createPaySystemName(t,e);this._logoImg[t]=this.createLogo(t,e);this._sumFormatted[t]=this.createSumFormatted(t,e);this._paidInput[t]=this.createPaidInput(t,e);this._isReturn[t]=this.createIsReturnInput(t,e);this._datePaid[t]=this.creatDatePaid(t,e);var i=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box"},children:[this._paySystemName[t],BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-content-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-content-left"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-logo-container"},children:[this._logoImg[t]]})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-content-right"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-money"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},html:this.getMessage("sum")})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-colums-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-wallet"},children:[this._sumFormatted[t]]})]})]})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-custom"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-controls"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-controls-row"},children:[this._paidButtons[t],this._datePaid[t],this._paidInput[t],this._isReturn[t]]})]})]})]})]})]})]})]})]});if(BX.type.isNotEmptyString(e.VOUCHER_INFO)){text=this.getMessage("documentTitle")+": "+e.VOUCHER_INFO}else{text=this.getMessage("addDocument")}this._documentLinks[e.ID]=BX.create("a",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:text,events:{click:BX.delegate(function(t){this.onAddDocumentClick(t,e.ID,r)},this)}});i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this._documentLinks[e.ID]]}));return i};BX.Crm.EntityEditorPayment.prototype.createPaymentButton=function(t,e){var r=BX.create("div",{props:{className:"ui-btn-double ui-btn-sm "+(e?"ui-btn-success-light":"ui-btn-danger-light"),id:"crm_entity_editor_is_payment_paid_button_"+t},children:[BX.create("button",{props:{className:"ui-btn-main",id:"crm_entity_editor_is_payment_paid_button_main_"+t},html:e?this.getMessage("paymentWasPaid"):this.getMessage("paymentWasNotPaid")}),BX.create("button",{props:{className:"ui-btn-extra"}})]});BX.bind(r,"click",BX.delegate(function(e){this.onPaidButtonClick(e,t)},this));return r};BX.Crm.EntityEditorPayment.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getValue();this._wrapper=BX.create("div");this._view=null;var r=this.isDragEnabled();if(r){this._wrapper.appendChild(this.createDragButton())}var i=this.isContextMenuEnabled();if(this.checkIfNotEmpty(e)){this._view=BX.create("div");if(e&&e.length){for(var n=0,o=e.length;n<o;n++){this._paymentBlocks[n]=this.createPaymentContent(n,e[n]);this._view.appendChild(this._paymentBlocks[n])}}this._wrapper.appendChild(this._view)}if(i){this._wrapper.appendChild(this.createContextMenuButton())}if(r){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorPayment.prototype.setPaidStatus=function(t,e,r){this.setItemField(r,"PAID",t);this.setItemField(r,"IS_RETURN",e)};BX.Crm.EntityEditorPayment.prototype.onPaidButtonClick=function(t,e){this.togglePaidButtonMenu(e);t.preventDefault()};BX.Crm.EntityEditorPayment.prototype.onAddDocumentClick=function(t,e,r){var i=this._schemeElement.getDataStringParam("addPaymentDocumentUrl","");var n={paymentId:e,paymentType:this._documentType.voucher};if(BX.type.isNotEmptyObject(this._documentInnerData[e])){var o=this._documentInnerData[e].values;for(var s in o){if(o.hasOwnProperty(s)){n["ENTITY_DATA["+s+"]"]=o[s]}}}i=BX.util.add_url_param(i,n);BX.Crm.Page.openSlider(i,{width:500})};BX.Crm.EntityEditorPayment.prototype.getPaymentIndexById=function(t){if(BX.type.isNotEmptyObject(this.getModel().getField("PAYMENT"))){var e=this.getModel().getField("PAYMENT");for(var r in e){if(e.hasOwnProperty(r)&&e[r]["ID"]==t){return r}}}return false};BX.Crm.EntityEditorPayment.prototype.onPaymentVoucherUpdate=function(t){if(t.getEventId()==="CrmOrderPaymentVoucher::Update"){var e=t.getData();var r=BX.prop.getString(e,"entityId",0);var i=this.getPaymentIndexById(r);if(i===false){return}if(BX.prop.getInteger(e,"entityTypeId",0)!==BX.CrmEntityType.enumeration.orderpayment){return}if(BX.prop.getString(e,"source","")!=="ORDER_PAYMENT"){return}if(BX.type.isDomNode(this._documentLinks[r])){var n=BX.prop.getString(e,"PAY_VOUCHER_NUM","");var o=BX.prop.getString(e,"PAY_VOUCHER_DATE","");var s="";if(BX.type.isNotEmptyString(n)){var a=BX.util.htmlspecialchars(n);if(BX.type.isNotEmptyString(o)){a+=" "+BX.util.htmlspecialchars(o)}s=this.getMessage("documentTitle")+": "+a}else{s=this.getMessage("addDocument")}this._documentLinks[r].innerHTML=s;if(BX.type.isNotEmptyObject(this._documentInnerData[r])){this._documentInnerData[r]["values"]["PAY_VOUCHER_NUM"]=n;this._documentInnerData[r]["values"]["PAY_VOUCHER_DATE"]=o}}for(var d in e){if(d==="entityId"||d==="entityTypeId"){continue}if(e.hasOwnProperty(d)){this.setItemField(i,d,BX.prop.getString(e,d,""))}}if(!this._isCreateMode){if(this._editor.isChanged()){this.markAsChanged();this.getOrderController().onDataChanged()}else{var l=e;l["PAYMENT_ID"]=r;l["PAID"]=this.getItemField(i,"PAID");l["IS_RETURN"]=this.getItemField(i,"IS_RETURN");this.getOrderController().ajax("setPaymentPaidField",{data:{FIELDS:e}},{skipMarkAsChanged:true})}}}};BX.Crm.EntityEditorPayment.prototype.onPaymentVoucherInited=function(t){if(t.getEventId()==="CrmOrderPaymentVoucher::Initialized"){var e=t.getData(),r=BX.prop.getString(e,"entityId",0),i=this.getPaymentIndexById(r);if(BX.prop.getInteger(e,"entityTypeId",0)!==BX.CrmEntityType.enumeration.orderpayment||!e.voucherObject){return}var n=e.voucherObject;n.setField("PAY_VOUCHER_NUM",this.getItemField(i,"PAY_VOUCHER_NUM"));n.setField("PAY_VOUCHER_DATE",this.getItemField(i,"PAY_VOUCHER_DATE"));n.setField("PAY_RETURN_NUM",this.getItemField(i,"PAY_RETURN_NUM"));n.setField("PAY_RETURN_DATE",this.getItemField(i,"PAY_RETURN_DATE"));n.setField("PAY_RETURN_COMMENT",this.getItemField(i,"PAY_RETURN_COMMENT"));n.setField("PAID",this.getItemField(i,"PAID"));n.setField("source","ORDER_PAYMENT");if(this.getItemField(i,"PAID")==="N"){var o=this.getItemField(i,"IS_RETURN");if(o==="Y"||o==="P"){n.setField("IS_RETURN",o)}}}};BX.Crm.EntityEditorPayment.prototype.onExternalChange=function(t){i=false;if(t.getEventId()==="CrmOrderPayment::Update"){var e=t.getData();if(e.entityTypeId==BX.CrmEntityType.enumeration.orderpayment){var r=this.getValue();var i=false;for(var n=0;n<r.length;n++){if(r[n].ID==e.field.ID){if(BX.type.isNotEmptyString(e.field.PAID)){r[n].PAID=e.field.PAID}if(BX.type.isNotEmptyString(e.field.FORMATTED_SUM_WITH_CURRENCY)){r[n].FORMATTED_SUM_WITH_CURRENCY=e.field.FORMATTED_SUM_WITH_CURRENCY}if(BX.type.isNotEmptyString(e.field.FORMATTED_SUM)){r[n].FORMATTED_SUM=e.field.FORMATTED_SUM}if(BX.type.isNotEmptyString(e.field.PAY_SYSTEM_NAME)){r[n].PAY_SYSTEM_NAME=e.field.PAY_SYSTEM_NAME}if(BX.type.isNotEmptyString(e.field.PAY_SYSTEM_LOGO)){r[n].PAY_SYSTEM_LOGO_PATH=e.field.PAY_SYSTEM_LOGO}if(BX.type.isNotEmptyString(e.field.FORMATED_TITLE_WITH_DATE_BILL)){r[n].NUMBER_AND_DATE=e.field.FORMATED_TITLE_WITH_DATE_BILL}i=true}}}}else if(t.getEventId()==="CrmOrderPayment::Create"){r=this.getValue();e=t.getData();if(e.entityTypeId==BX.CrmEntityType.enumeration.orderpayment&&BX.type.isNotEmptyString(e.field.ID)){var o={ID:e.field.ID,PAID:e.field.PAID==="Y"?"Y":"N",NUMBER_AND_DATE:BX.util.htmlspecialchars(e.field.FORMATED_TITLE_WITH_DATE_BILL)||"",PAY_SYSTEM_LOGO_PATH:BX.util.htmlspecialchars(e.field.PAY_SYSTEM_LOGO)||"",PAY_SYSTEM_NAME:BX.util.htmlspecialchars(e.field.PAY_SYSTEM_NAME)||"",FORMATTED_SUM_WITH_CURRENCY:BX.util.htmlspecialchars(e.field.FORMATTED_SUM_WITH_CURRENCY)||"",FORMATTED_SUM:BX.util.htmlspecialchars(e.field.FORMATTED_SUM)||""};r.push(o);i=true;this._paymentBlocks[r.length-1]=this.createPaymentContent(r.length-1,o);this._view.appendChild(this._paymentBlocks[r.length-1])}}else if(t.getEventId()==="CrmOrderPayment::Delete"){r=this.getValue();e=t.getData();if(e.entityTypeId==BX.CrmEntityType.enumeration.orderpayment&&parseInt(e.ID)>0){for(var n in r){if(r[n].ID==e.ID){r.splice(n,1);this._view.removeChild(this._paymentBlocks[n]);break}}i=true}}if(i){this._model.setField(this.getName(),r,{originator:this});this.refreshLayout();var s={entityData:this._model.getData()};BX.onCustomEvent(window,BX.Crm.EntityEvent.names.update,[s])}};BX.Crm.EntityEditorPayment.prototype.togglePaidButtonMenu=function(t){if(this._isPaidButtonMenuOpened[t]){this.closePaidButtonMenu(t)}else{this.openPaidButtonMenu(t)}};BX.Crm.EntityEditorPayment.prototype.closePaidButtonMenu=function(t){if(!this._isPaidButtonMenuOpened[t]){return}var e=BX.PopupMenu.getMenuById(this._id);if(e){e.popupWindow.close()}this._isPaidButtonMenuOpened[t]=false};BX.Crm.EntityEditorPayment.prototype.setPaidButtonView=function(t,e){var r=BX("crm_entity_editor_is_payment_paid_button_"+t),i=BX("crm_entity_editor_is_payment_paid_button_main_"+t);if(e){BX.removeClass(r,"ui-btn-danger-light");BX.addClass(r,"ui-btn-success-light");i.innerHTML=this.getMessage("paymentWasPaid")}else{BX.removeClass(r,"ui-btn-success-light");BX.addClass(r,"ui-btn-danger-light");i.innerHTML=this.getMessage("paymentWasNotPaid")}};BX.Crm.EntityEditorPayment.prototype.openPaidButtonMenu=function(t){var e=this,r=BX("crm_entity_editor_is_payment_paid_input_"+t),i=BX("crm_entity_editor_is_payment_paid_is_return_"+t);var n=function(n,o){var s=BX.prop.getString(o,"value");if(s==="CANCEL"||s==="RETURN"){r.value="N";if(s==="RETURN"){i.value="Y";if(!e._isCreateMode){BX.Crm.Page.openSlider(e.getItemField(t,"PAY_RETURN_URL"),{width:500})}}else{if(!e._isCreateMode){BX.Crm.Page.openSlider(e.getItemField(t,"PAY_CANCEL_URL"),{width:500})}}}else if(s==="SET_PAID"){r.value="Y";i.value="N";if(!e._isCreateMode){if(e._editor.isChanged()){e.setPaidStatus(r.value,i.value,t);e.markAsChanged();e.getOrderController().onDataChanged()}else{e.getOrderController().ajax("setPaymentPaidField",{data:{FIELDS:{PAID:"Y",PAYMENT_ID:e.getItemField(t,"ID")}}},{skipMarkAsChanged:true})}}}e.closePaidButtonMenu(t);e.setPaidStatus(r.value,i.value,t);e.setPaidButtonView(t,s==="SET_PAID")};if(r.value==="Y"){if(this._isCreateMode){var o=[{value:"CANCEL",text:this.getMessage("paymentWasNotPaid"),onclick:n}]}else{o=[{value:"CANCEL",text:this.getMessage("paymentCancel"),onclick:n},{value:"RETURN",text:this.getMessage("paymentReturn"),onclick:n}]}}else{o=[{value:"SET_PAID",text:this.getMessage("paymentWasPaid"),onclick:n}]}BX.PopupMenu.show(this._id,this._paidButtons[t],o,{angle:false,events:{onPopupShow:BX.proxy(function(){this.onMenuShow(t)},this),onPopupClose:BX.delegate(this.onMenuClose,this)}})};BX.Crm.EntityEditorPayment.prototype.onMenuShow=function(t){this._isPaidButtonMenuOpened[t]=true};BX.Crm.EntityEditorPayment.prototype.onMenuClose=function(){BX.PopupMenu.destroy(this._id)};BX.Crm.EntityEditorPayment.prototype.refreshLayout=function(){if(!this._hasLayout){return}var t=this._model.getField(this.getName());this.clearError();if(this._mode===BX.Crm.EntityEditorMode.view){for(var e in t){if(t.hasOwnProperty(e)){var r=this.createPaymentContent(e,t[e]);this._paymentBlocks[e].parentNode.replaceChild(r,this._paymentBlocks[e]);this._paymentBlocks[e]=r;this._paidInput[e].value=t[e].PAID;this._sumFormatted[e]=this.createSumFormatted(e,t[e]);if(t[e].ERRORS){this.processErrors(t[e].ERRORS)}}}}else{for(e in t){if(t.hasOwnProperty(e)){if(typeof t[e].FORMATTED_SUM!=="undefined"){this._sumInput[e].value=t[e].FORMATTED_SUM}if(typeof t[e].CURRENCY_NAME!=="undefined"){var i=this.createCurrency(e,t[e]);this._currency[e].parentNode.replaceChild(i,this._currency[e]);this._currency[e]=i}this.setPaySystem(e,t[e]);this._logoImg[e].src=t[e].PAY_SYSTEM_LOGO_PATH;this._datePaid[e].value=t[e].DATE_PAID;this._isReturn[e].value=t[e].IS_RETURN;this._paidInput[e].value=t[e].PAID;this.setPaidButtonView(e,t[e].PAID==="Y");if(t[e].ERRORS){this.processErrors(t[e].ERRORS)}}}}};BX.Crm.EntityEditorPayment.prototype.setCurrency=function(t,e){if(this._mode===BX.Crm.EntityEditorMode.edit){this._paySystemInputs[t].value=e.PAY_SYSTEM_ID}else{this._paySystemName[t]=this.createPaySystemName(t,e)}};BX.Crm.EntityEditorPayment.prototype.setPaySystem=function(t,e){if(this._mode===BX.Crm.EntityEditorMode.edit){this._paySystemInputs[t].value=parseInt(e.PAY_SYSTEM_ID)>0?e.PAY_SYSTEM_ID:0}else{this._paySystemName[t]=this.createPaySystemName(t,e)}};BX.Crm.EntityEditorPayment.prototype.getRuntimeValue=function(){return this.getModel().getField(this.getName())};BX.Crm.EntityEditorPayment.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}if(this._isCreateMode){var e=0;if(!this._customPaymentSumm[e]){var r=this._editor._model;this.setItemField(e,"SUM",r.getField("PRICE"));this.setItemField(e,"FORMATTED_SUM_WITH_CURRENCY",r.getField("FORMATTED_PRICE_WITH_CURRENCY"));this.setItemField(e,"FORMATTED_SUM",r.getField("FORMATTED_PRICE"));this.setItemField(e,"CURRENCY",r.getField("CURRENCY"))}}this.refreshLayout()};BX.Crm.EntityEditorPayment.create=function(t,e){var r=new BX.Crm.EntityEditorPayment;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorShipment==="undefined"){BX.Crm.EntityEditorShipment=function(){BX.Crm.EntityEditorShipment.superclass.constructor.apply(this);this._view=null;this._isCreateMode=false;this._documentLinks={};this._documentInnerData={};this._deliverySelectors={};this._profileSelectors={};this._deliveryInputs={};this._storeSelectors={};this._inputStores={};this._priceDeliveryInputs={};this._logoImg={};this._currency={};this._headBlocks={};this._shipmentBlocks={};this._extraServices={};this._discounts={};this._isDeliveryAllowedCheckboxes={};this._isDeductedCheckboxes={};this._orderController=null};BX.extend(BX.Crm.EntityEditorShipment,BX.Crm.EntityEditorField);if(typeof BX.Crm.EntityEditorShipment.messages==="undefined"){BX.Crm.EntityEditorShipment.messages={}}BX.Crm.EntityEditorShipment.prototype.doInitialize=function(){BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(this.onExternalChange,this));this._isCreateMode=this._model.getField("ID",0)<=0};BX.Crm.EntityEditorShipment.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorShipment.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorShipment.prototype.getItemField=function(t,e){var r=this._model.getField(this.getName()),i="";if(r[t]&&r[t]&&r[t][e]){i=r[t][e]}return i};BX.Crm.EntityEditorShipment.prototype.setItemField=function(t,e,r){var i=this._model.getField(this.getName());if(i[t]){i[t][e]=r;this._model.setField(this.getName(),i,{originator:this})}};BX.Crm.EntityEditorShipment.prototype.getOrderController=function(){if(this._orderController===null){for(var t=0,e=this._editor._controllers.length;t<e;t++){if(this._editor._controllers[t]instanceof BX.Crm.EntityEditorOrderController){this._orderController=this._editor._controllers[t];break}}}return this._orderController};BX.Crm.EntityEditorShipment.prototype.createDeliverySelector=function(t){return BX.create("select",{events:{change:BX.proxy(function(){this.onSelectorChange(t,"delivery")},this)}})};BX.Crm.EntityEditorShipment.prototype.createProfileSelector=function(t){return BX.create("select",{events:{change:BX.proxy(function(){this.onSelectorChange(t,"profile")},this)}})};BX.Crm.EntityEditorShipment.prototype.setOptionsList=function(t,e,r){return BX.Crm.EntityEditorDeliverySelector.prototype.setOptionsList(t,e,r)};BX.Crm.EntityEditorShipment.prototype.obtainValueFromSelectors=function(t,e,r,i){return BX.Crm.EntityEditorDeliverySelector.prototype.obtainValueFromSelectors(t,e,r,i)};BX.Crm.EntityEditorShipment.prototype.onSelectorChange=function(t,e){this._deliveryInputs[t].value=this.obtainValueFromSelectors(e,this._deliverySelectors[t],this._profileSelectors[t],this._mode);this.setItemField(t,"DELIVERY_ID",this._deliveryInputs[t].value);this.markAsChanged();this.getOrderController().onChangeDelivery(t)};BX.Crm.EntityEditorShipment.prototype.getHeadBlock=function(t){var e=null;if(this._isCreateMode){this._deliverySelectors[t]=this.createDeliverySelector(t);this.setOptionsList(this._deliverySelectors[t],this.getItemField(t,"DELIVERY_SERVICES_LIST"),this.getItemField(t,"DELIVERY_SELECTOR_DELIVERY_ID"));var r=this.getItemField(t,"DELIVERY_PROFILES_LIST");if(BX.type.isNotEmptyObject(r)){this._profileSelectors[t]=this.createProfileSelector(t);this.setOptionsList(this._profileSelectors[t],r,this.getItemField(t,"DELIVERY_SELECTOR_PROFILE_ID"))}else{delete this._profileSelectors[t]}this._deliveryInputs[t]=BX.create("input",{props:{type:"hidden",name:"SHIPMENT["+t+"][DELIVERY_ID]",value:this.getItemField(t,"DELIVERY_ID")}});var i=this.getItemField(t,"DELIVERY_STORES_LIST");if(BX.type.isNotEmptyObject(i)){this._storeSelectors[t]=this.createStoreSelector(t);this.setOptionsList(this._storeSelectors[t],i,this.getItemField(t,"DELIVERY_STORE_ID"));this.createInputStore(t)}else{delete this._storeSelectors[t]}e=BX.create("div",{style:{width:"100%"},children:[BX.create("span",{props:{className:"fields enumeration field-wrap"},style:{width:"100%"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},style:{marginTop:"-6px"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("deliveryService")})]}),BX.create("span",{props:{className:"fields enumeration field-item"},children:[this._deliverySelectors[t],this._deliveryInputs[t]]})]})]});if(this._profileSelectors[t]){e.appendChild(BX.create("span",{props:{className:"fields enumeration field-wrap"},style:{width:"100%"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},style:{marginTop:"3px"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("profile")})]}),BX.create("span",{props:{className:"fields enumeration field-item"},children:[this._profileSelectors[t]]})]}))}if(this._storeSelectors[t]){e.appendChild(BX.create("span",{props:{className:"fields enumeration field-wrap"},style:{marginTop:"20px"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},style:{marginTop:"-16px"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("deliveryStore")})]}),BX.create("span",{props:{className:"fields enumeration field-item"},children:[this._storeSelectors[t],this.getInputStore(t)]})]}),e)}e=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-title"},children:[e]})}else{e=this.createDeliveryServiceName(t)}return e};BX.Crm.EntityEditorShipment.prototype.createDeliveryServiceName=function(t){return BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-title"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-title-text"},html:this.getItemField(t,"DELIVERY_SERVICE_NAME")}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-title-desc"},children:[BX.create("a",{style:{cursor:"pointer"},html:this.getItemField(t,"NUMBER_AND_DATE"),events:{click:BX.proxy(function(){this.getOrderController().openDetailSlider("/shop/orders/shipment/details/"+parseInt(this.getItemField(t,"ID"))+"/")},this)}})]})]})};BX.Crm.EntityEditorShipment.prototype.getInputStore=function(t){if(!this._inputStores[t]){this.createInputStore(t)}return this._inputStores[t]};BX.Crm.EntityEditorShipment.prototype.createInputStore=function(t){if(this._inputStores[t]){return}this._inputStores[t]=BX.create("input",{props:{type:"hidden",name:"SHIPMENT["+t+"][DELIVERY_STORE_ID]",value:this.getItemField(t,"DELIVERY_STORE_ID")}})};BX.Crm.EntityEditorShipment.prototype.createStoreSelector=function(t){return BX.create("select",{events:{change:BX.proxy(function(){this.onStoreChange(t)},this)}})};BX.Crm.EntityEditorShipment.prototype.onStoreChange=function(t){this.getInputStore(t).value=this._storeSelectors[t].value;this.setItemField(t,"DELIVERY_STORE_ID",this._storeSelectors[t].value);this.markAsChanged()};BX.Crm.EntityEditorShipment.prototype.processErrors=function(t){if(t.length){var e="";for(var r=0,i=t.length-1;r<=i;r++){e+=t[r]+"\n"}if(e){e=BX.util.htmlspecialchars(e);this.showError(e);this._editor._toolPanel.addError(e)}}};BX.Crm.EntityEditorShipment.prototype.onPriceDeliveryChange=function(t,e){this.setItemField(t,"PRICE_DELIVERY",e);this.setItemField(t,"CUSTOM_PRICE_DELIVERY","Y");this.getOrderController().onDataChanged()};BX.Crm.EntityEditorShipment.prototype.createCurrency=function(t,e){return BX.create("span",{props:{className:"crm-entity-widget-content-block-wallet"},html:e.CURRENCY_NAME})};BX.Crm.EntityEditorShipment.prototype.createPriceContent=function(t,e){var r=null,i=this;this._priceDeliveryInputs[t]=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:"SHIPMENT["+t+"][PRICE_DELIVERY]",id:"crm_entity_editor_delivery_price_"+t,type:"text",value:e.FORMATTED_PRICE_DELIVERY,size:40},events:{change:function(){i.onPriceDeliveryChange(t,this.value)}}});if(this._isCreateMode){this._currency[t]=this.createCurrency(t,e);r=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-money"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},html:this.getMessage("price")})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._priceDeliveryInputs[t],this._currency[t]]})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-title price-calculated"},style:{display:"none"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},children:[BX.create("span",{html:this.getMessage("deliveryPriceCalculated")+" "}),BX.create("span",{html:"",props:{id:"crm-order-delivery-calculated-price-"+t,title:this.getMessage("deliveryPriceCalculatedHint")},style:{borderBottom:"1px dashed",cursor:"pointer"},events:{click:BX.proxy(function(){this.setItemField(t,"PRICE_DELIVERY",this.getItemField(t,"PRICE_DELIVERY_CALCULATED"));this._priceDeliveryInputs[t].value=this.getItemField(t,"FORMATTED_PRICE_DELIVERY_CALCULATED");this.setItemField(t,"CUSTOM_PRICE_DELIVERY","N");this.getOrderController().onDataChanged()},this)}})]})]})]})}else{r=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-money"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},html:this.getMessage("price")})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-colums-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-wallet"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-colums-right",id:"crm-order-delivery-price-"+t},html:e.FORMATTED_PRICE_DELIVERY_WITH_CURRENCY})]})]})]})]})}return r};BX.Crm.EntityEditorShipment.prototype.createExtraServicesContent=function(t,e){var r=[],i=this._isCreateMode?"edit":"view",n=new BX.Crm.EntityEditorOrderExtraServicesWrapper({mode:i});if(e.EXTRA_SERVICES_DATA&&e.EXTRA_SERVICES_DATA.length){for(var o=0,s=e.EXTRA_SERVICES_DATA.length-1;o<=s;o++){n.wrapItem(e.EXTRA_SERVICES_DATA[o]).forEach(function(t,e,i){r.push(t)})}}return r};BX.Crm.EntityEditorShipment.prototype.createDiscountsContent=function(t,e){if(!this._isCreateMode){return}var r=[],i=this;if(e.DISCOUNTS&&e.DISCOUNTS.length){for(var n=0,o=e.DISCOUNTS.length-1;n<=o;n++){var s=e.DISCOUNTS[n],a=BX.create("input",{props:{type:"checkbox",name:"DISCOUNTS[DELIVERY]["+s.DISCOUNT_ID+"]",value:"Y",checked:s.APPLY==="Y"},attrs:{"data-discount-id":s.DISCOUNT_ID,"data-coupon-id":s.COUPON_ID?s.COUPON_ID:"-"},events:{click:function(){i.onDiscountClick(this)}}});BX.addCustomEvent("crmOrderProductListDiscountToggle",function(t){return function(e){if(t.getAttribute("data-discount-id")==e.discountId){t.checked=e.isSet}}}(a));var d=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-checkbox"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("label",{props:{className:"crm-entity-widget-content-block-checkbox-label"},children:[BX.create("input",{props:{type:"hidden",name:"DISCOUNTS[DELIVERY]["+s.DISCOUNT_ID+"]",value:"N"}}),a,BX.create("span",{props:{className:"crm-entity-widget-content-block-checkbox-description"},html:s.DESCR})]})]})]});r.push(d)}}return BX.create("div",{children:r})};BX.Crm.EntityEditorShipment.prototype.onDiscountClick=function(t){BX.onCustomEvent("crmOrderDetailDiscountToggle",[{discountId:t.getAttribute("data-discount-id"),isSet:t.checked}]);this.getOrderController().onDataChanged()};BX.Crm.EntityEditorShipment.prototype.createShipmentContent=function(t,e){var r=e.STATUS_CONTROL,i=BX.processHTML(r),n=null,o=null;this._isDeliveryAllowedCheckboxes[t]=BX.create("input",{props:{className:"crm-entity-widget-content-checkbox",name:"SHIPMENT["+t+"][ALLOW_DELIVERY]",value:"Y",checked:e.ALLOW_DELIVERY==="Y",type:"checkbox"}});this._isDeductedCheckboxes[t]=BX.create("input",{props:{className:"crm-entity-widget-content-checkbox",name:"SHIPMENT["+t+"][DEDUCTED]",value:"Y",checked:e.DEDUCTED==="Y",type:"checkbox"}});this._logoImg[t]=BX.create("img",{props:{className:"crm-entity-widget-content-block-inner-order-logo",id:"crm_entity_editor_delivery_logotip_"+t,src:e.DELIVERY_LOGO,alt:"LOGO"}});this._headBlocks[t]=this.getHeadBlock(t,e);if(this._isCreateMode){BX.bind(this._isDeliveryAllowedCheckboxes[t],"change",BX.delegate(function(r){this.setItemField(t,"ALLOW_DELIVERY",r.target.checked?"Y":"N",e.ID)},this));BX.bind(this._isDeductedCheckboxes[t],"change",BX.delegate(function(r){this.setItemField(t,"DEDUCTED",r.target.checked?"Y":"N",e.ID)},this));this._extraServices[t]=this.createExtraServicesContent(t,e);n=BX.create("div",{props:{id:"crm-order-shipment-extra-services-"+t},style:{background:"#f9f9f9",marginLeft:"15px",width:"100%",marginTop:"20px"},children:this._extraServices[t]});this._discounts[t]=this.createDiscountsContent(t,e);o=BX.create("div",{props:{id:"crm-order-shipment-discounts-"+t},style:{background:"#f9f9f9",marginLeft:"15px",width:"100%",marginTop:"20px"},children:this._discounts[t]})}else{BX.bind(this._isDeliveryAllowedCheckboxes[t],"change",BX.delegate(function(r){this.setField("ALLOW_DELIVERY",r.target.checked?"Y":"N",e.ID,t)},this));BX.bind(this._isDeductedCheckboxes[t],"change",BX.delegate(function(r){this.setField("DEDUCTED",r.target.checked?"Y":"N",e.ID,t)},this))}var s=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box"},children:[this._headBlocks[t],BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-content-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-content-left"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-logo-container"},children:[this._logoImg[t]]})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-content-right"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-controls"},children:[this.createPriceContent(t,e),BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-checkbox"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("label",{props:{className:"crm-entity-widget-content-block-checkbox-label"},children:[this._isDeliveryAllowedCheckboxes[t],BX.create("span",{props:{className:"crm-entity-widget-content-block-checkbox-description"},html:this.getMessage("deliveryAllowed")}),BX.create("input",{props:{type:"hidden",name:"SHIPMENT["+t+"][ALLOW_DELIVERY]",value:"N"}})]})]})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-checkbox"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("label",{props:{className:"crm-entity-widget-content-block-checkbox-label"},children:[this._isDeductedCheckboxes[t],BX.create("span",{props:{className:"crm-entity-widget-content-block-checkbox-description"},html:this.getMessage("deducted")}),BX.create("input",{props:{type:"hidden",name:"SHIPMENT["+t+"][DEDUCTED]",value:"N"}})]})]})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-progress"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},html:i["HTML"]})]}),n,o]})]})]})]})]})]});setTimeout(function(){for(var t in i["SCRIPT"]){if(!i["SCRIPT"].hasOwnProperty(t))continue;BX.evalGlobal(i["SCRIPT"][t]["JS"]);delete i["SCRIPT"][t]}},1);if(BX.type.isNotEmptyString(e.DOCUMENT_INFO)){text=this.getMessage("documentTitle")+": "+e.DOCUMENT_INFO}else if(BX.type.isNotEmptyString(e.TRACKING_NUMBER)){text=this.getMessage("trackingNumberTitle")+": "+e.TRACKING_NUMBER}else{text=this.getMessage("addDocument")}this._documentLinks[e.ID]=BX.create("a",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:text,events:{click:BX.delegate(function(t){this.onAddDocumentClick(t,e.ID)},this)}});if(BX.prop.getNumber(e,"ID",0)===0){this._documentInnerData[e.ID]={index:t,values:{TRACKING_NUMBER:BX.prop.getString(e,"TRACKING_NUMBER",""),DELIVERY_DOC_NUM:BX.prop.getString(e,"DELIVERY_DOC_NUM",""),DELIVERY_DOC_DATE:BX.prop.getString(e,"DELIVERY_DOC_DATE","")}}}s.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this._documentLinks[e.ID]]}));return s};BX.Crm.EntityEditorShipment.prototype.onAddDocumentClick=function(t,e){var r=this._schemeElement.getDataStringParam("addShipmentDocumentUrl","");var i={shipment_id:e};if(BX.type.isNotEmptyObject(this._documentInnerData[e])){var n=this._documentInnerData[e].values;for(var o in n){if(n.hasOwnProperty(o)){i["ENTITY_DATA["+o+"]"]=n[o]}}}r=BX.util.add_url_param(r,i);BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(this.onDocumentUpdate,this));BX.Crm.Page.openSlider(r,{width:500})};BX.Crm.EntityEditorShipment.prototype.getRuntimeValue=function(){return this.getModel().getField(this.getName())};BX.Crm.EntityEditorShipment.prototype.onDocumentUpdate=function(t){if(t.getEventId()==="CrmOrderShipmentDocument::Update"){var e=t.getData();var r=BX.prop.getString(e,"entityId",0);if(BX.prop.getInteger(e,"entityTypeId",0)!==BX.CrmEntityType.enumeration.ordershipment||!BX.type.isDomNode(this._documentLinks[r])){return}var i=BX.prop.getString(e,"deliveryDocNum","");var n=BX.prop.getString(e,"trackingNumber","");var o=BX.prop.getString(e,"deliveryDocDate","");var s="";if(BX.type.isNotEmptyString(i)){var a=BX.util.htmlspecialchars(i);if(BX.type.isNotEmptyString(o)){a+=" "+BX.util.htmlspecialchars(o)}s=this.getMessage("documentTitle")+": "+a}else{if(BX.type.isNotEmptyString(n)){s=this.getMessage("trackingNumberTitle")+": "+n}else{s=this.getMessage("addDocument")}}this._documentLinks[r].innerHTML=s;if(BX.type.isNotEmptyObject(this._documentInnerData[r])){this._documentInnerData[r]["values"]["TRACKING_NUMBER"]=n;this._documentInnerData[r]["values"]["DELIVERY_DOC_NUM"]=i;this._documentInnerData[r]["values"]["DELIVERY_DOC_DATE"]=o;var d=this._documentInnerData[r]["index"];var l=this._model.getField(this.getName());if(BX.type.isNotEmptyObject(l[d])){l[d]["TRACKING_NUMBER"]=n;l[d]["DELIVERY_DOC_NUM"]=i;l[d]["DELIVERY_DOC_DATE"]=o;this._model.setField(this.getName(),l)}}}};BX.Crm.EntityEditorShipment.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getValue();this._wrapper=BX.create("div");this._view=null;var r=this.isDragEnabled();if(r){this._wrapper.appendChild(this.createDragButton())}var i=this.isContextMenuEnabled();if(this.checkIfNotEmpty(e)){this._view=BX.create("div");if(e&&e.length){for(var n=0,o=e.length;n<o;n++){this._shipmentBlocks[n]=this.createShipmentContent(n,e[n]);this._view.appendChild(this._shipmentBlocks[n])}}this._wrapper.appendChild(this._view)}if(i){this._wrapper.appendChild(this.createContextMenuButton())}if(r){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorShipment.prototype.setField=function(t,e,r,i){if(this._editor.isChanged()){this.setItemField(i,t,e);this.markAsChanged();this.getOrderController().onDataChanged()}else{this.getOrderController().ajax("setShipmentField",{data:{SHIPMENT_ID:r,FIELD_NAME:t,FIELD_VALUE:e}},{skipMarkAsChanged:true})}};BX.Crm.EntityEditorShipment.prototype.setCalculatedPrice=function(t,e,r){var i=BX("crm-order-delivery-calculated-price-"+t);if(!i){return}if(r){i.innerHTML=r}i.parentNode.parentNode.style.display=e?"":"none"};BX.Crm.EntityEditorShipment.prototype.refreshLayout=function(){if(!this._hasLayout){return}var t=this._model.getField(this.getName());this.clearError();for(var e in t){if(t.hasOwnProperty(e)){var r=this.getHeadBlock(e);this._headBlocks[e].parentNode.replaceChild(r,this._headBlocks[e]);this._headBlocks[e]=r;this._isDeliveryAllowedCheckboxes[e].checked=t[e].ALLOW_DELIVERY==="Y";this._isDeductedCheckboxes[e].checked=t[e].DEDUCTED==="Y";this._logoImg[e].src=t[e].DELIVERY_LOGO;if(this._isCreateMode){this._priceDeliveryInputs[e].value=t[e].FORMATTED_PRICE_DELIVERY;if(t[e].CUSTOM_PRICE_DELIVERY==="Y"&&parseFloat(t[e].PRICE_DELIVERY_CALCULATED)!==parseFloat(t[e].PRICE_DELIVERY)){this.setCalculatedPrice(e,true,t[e].FORMATTED_PRICE_DELIVERY_CALCULATED_WITH_CURRENCY)}else{this.setCalculatedPrice(e,false)}var i=this.createCurrency(e,t[e]);this._currency[e].parentNode.replaceChild(i,this._currency[e]);this._currency[e]=i;this._extraServices[e]=this.createExtraServicesContent(e,t[e]);this.insertExtraServicestoContainer(e,this._extraServices[e]);this._discounts[e]=this.createDiscountsContent(e,t[e]);this.insertDiscountsToContainer(e,this._discounts[e])}else{BX("crm-order-delivery-price-"+e).innerHTML=t[e].FORMATTED_PRICE_DELIVERY_WITH_CURRENCY}if(t[e].ERRORS){this.processErrors(t[e].ERRORS)}}}};BX.Crm.EntityEditorShipment.prototype.insertExtraServicestoContainer=function(t,e){var r=BX("crm-order-shipment-extra-services-"+t);if(r){r.innerHTML="";if(e){e.forEach(function(t,e,i){r.appendChild(t)})}}};BX.Crm.EntityEditorShipment.prototype.insertDiscountsToContainer=function(t,e){var r=BX("crm-order-shipment-discounts-"+t);if(!r||!e){return}if(r.childNodes[0]){r.replaceChild(e,r.childNodes[0])}else{r.appendChild(e)}};BX.Crm.EntityEditorShipment.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorShipment.prototype.onExternalChange=function(t){n=false;if(t.getEventId()==="CrmOrderShipment::Update"){var e=t.getData();if(e.entityTypeId==BX.CrmEntityType.enumeration.ordershipment){var r=["DEDUCTED","ALLOW_DELIVERY","FORMATTED_PRICE_DELIVERY_WITH_CURRENCY","DELIVERY_SERVICE_NAME","DELIVERY_SERVICES_LIST","DELIVERY_PROFILES_LIST","STATUS_CONTROL","DELIVERY_LOGO","DELIVERY_SELECTOR_DELIVERY_ID","DELIVERY_SELECTOR_PROFILE_ID","DELIVERY_ID","PRICE_DELIVERY","BASE_PRICE_DELIVERY","EXTRA_SERVICES_DATA"],i=this.getValue(),n=false;for(var o=0;o<i.length;o++){if(i[o].ID==e.field.ID){for(var s=r.length-1;s>=0;s--){if(typeof e.field[r[s]]!=="undefined"){i[o][r[s]]=e.field[r[s]]}}n=true}}}}else if(t.getEventId()==="CrmOrderShipment::Create"){i=this.getValue();e=t.getData();if(e.entityTypeId==BX.CrmEntityType.enumeration.ordershipment&&BX.type.isNotEmptyString(e.field.ID)){var a=e.field;i.push(a);this._shipmentBlocks[i.length-1]=this.createShipmentContent(i.length-1,a);this._view.appendChild(this._shipmentBlocks[i.length-1]);n=true}}else if(t.getEventId()==="CrmOrderShipment::Delete"){i=this.getValue();e=t.getData();if(e.entityTypeId==BX.CrmEntityType.enumeration.ordershipment&&parseInt(e.ID)>0){for(var o in i){if(i[o].ID==e.ID){i.splice(o,1);this._view.removeChild(this._shipmentBlocks[o]);break}}n=true}}if(n){this._model.setField(this.getName(),i);this.refreshLayout();this.getOrderController().onDataChanged()}};BX.Crm.EntityEditorShipment.create=function(t,e){var r=new BX.Crm.EntityEditorShipment;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorPaymentStatus==="undefined"){BX.Crm.EntityEditorPaymentStatus=function(){BX.Crm.EntityEditorPaymentStatus.superclass.constructor.apply(this);this._view=null;this._isPaidButtonMenuOpened={};this._isCreateMode=false;this._paidButtons={};this._paymentController=null};BX.extend(BX.Crm.EntityEditorPaymentStatus,BX.Crm.EntityEditorField);BX.Crm.EntityEditorPaymentStatus.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getValue();this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-select"]});this.adjustWrapper();this._view=null;var r=this.isDragEnabled();if(r){this._wrapper.appendChild(this.createDragButton())}var i=this.isContextMenuEnabled();this._view=BX.create("div");var n=e.isPaid==="Y",o=0;var s=this.getTitle();this._wrapper.appendChild(this.createTitleNode(s));this._paidButtons[o]=this.createPaymentButton(o,n);var a=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-custom"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-controls"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-controls-row"},children:[this._paidButtons[o],BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-order-controls-text"},html:e.DATE_PAID})]})]})]})]});this._view.appendChild(a);this._wrapper.appendChild(this._view);if(i){this._wrapper.appendChild(this.createContextMenuButton())}if(r){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorPaymentStatus.prototype.getDragObjectType=function(){return BX.Crm.EditorDragObjectType.field};BX.Crm.EntityEditorPaymentStatus.prototype.createPaymentButton=function(t,e){var r=BX.create("div",{props:{className:"ui-btn-double ui-btn-sm "+(e?"ui-btn-success-light":"ui-btn-danger-light"),id:"crm_entity_editor_is_payment_paid_button_"+t},children:[BX.create("button",{props:{className:"ui-btn-main",id:"crm_entity_editor_is_payment_paid_button_main_"+t},html:e?this.getMessage("paymentWasPaid"):this.getMessage("paymentWasNotPaid")}),BX.create("button",{props:{className:"ui-btn-extra"}})]});BX.bind(r,"click",BX.delegate(function(e){this.onPaidButtonClick(e,t)},this));return r};BX.Crm.EntityEditorPaymentStatus.prototype.doInitialize=function(){BX.addCustomEvent(window,BX.Crm.EntityEvent.names.update,BX.delegate(this.onAfterUpdate,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(this.onPaymentVoucherUpdate,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(this.onPaymentVoucherInited,this));this._isCreateMode=!this._model._data.ID};BX.Crm.EntityEditorPaymentStatus.prototype.onAfterUpdate=function(t){if(t.entityData){if(this._model._data.hasOwnProperty("STATUS")&&BX.type.isPlainObject(this._model._data["STATUS"])){if(t.entityData.PAID){this._model._data["STATUS"].isPaid=t.entityData.PAID}if(t.entityData.DATE_PAID){this._model._data["STATUS"].datePaid=t.entityData.DATE_PAID}}}};BX.Crm.EntityEditorPaymentStatus.prototype.onPaymentVoucherUpdate=function(t){if(t.getEventId()==="CrmOrderPaymentVoucher::Update"){var e=t.getData(),r;if(BX.prop.getInteger(e,"entityTypeId",0)!==BX.CrmEntityType.enumeration.orderpayment){return}if(BX.prop.getString(e,"source","")!=="PAYMENT"){return}for(var i in e){if(i==="entityId"||i==="entityTypeId"){continue}if(e.hasOwnProperty(i)){this.getModel().setField(i,BX.prop.getString(e,i,""));if(r=this.getEditor().getControlByIdRecursive("field")){r.onModelChange()}}}if(!this._isCreateMode){if(this._editor.isChanged()){this.markAsChanged();this.getPaymentController().onDataChanged()}else{var n=e;n["PAYMENT_ID"]=BX.prop.getString(e,"entityId",0);n["PAID"]=this.getModel().getField("PAID");n["IS_RETURN"]=this.getModel().getField("IS_RETURN");this.getPaymentController().ajax("setPaymentPaidField",{data:{FIELDS:e}},{skipMarkAsChanged:true,sendUpdateEvent:true})}}}};BX.Crm.EntityEditorPaymentStatus.prototype.onPaymentVoucherInited=function(t){if(t.getEventId()==="CrmOrderPaymentVoucher::Initialized"){var e=t.getData();if(BX.prop.getInteger(e,"entityTypeId",0)!==BX.CrmEntityType.enumeration.orderpayment||!e.voucherObject){return}var r=e.voucherObject;r.setField("PAY_VOUCHER_NUM",this.getModel().getField("PAY_VOUCHER_NUM"));r.setField("PAY_VOUCHER_DATE",this.getModel().getField("PAY_VOUCHER_DATE"));r.setField("PAY_RETURN_NUM",this.getModel().getField("PAY_RETURN_NUM"));r.setField("PAY_RETURN_DATE",this.getModel().getField("PAY_RETURN_DATE"));r.setField("PAY_RETURN_COMMENT",this.getModel().getField("PAY_RETURN_COMMENT"));r.setField("PAID",this.getModel().getField("PAID"));r.setField("source","PAYMENT");if(this.getModel().getField("PAID")==="N"){var i=this.getModel().getField("IS_RETURN");if(i==="Y"||i==="P"){r.setField("IS_RETURN",i)}}}};BX.Crm.EntityEditorPaymentStatus.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorPaymentStatus.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorPaymentStatus.prototype.onPaidButtonClick=function(t,e){this.togglePaidButtonMenu(e);t.preventDefault()};BX.Crm.EntityEditorPaymentStatus.prototype.togglePaidButtonMenu=function(t){if(this._isPaidButtonMenuOpened[t]){this.closePaidButtonMenu(t)}else{this.openPaidButtonMenu(t)}};BX.Crm.EntityEditorPaymentStatus.prototype.closePaidButtonMenu=function(t){if(!this._isPaidButtonMenuOpened[t]){return}var e=BX.PopupMenu.getMenuById(this._id);if(e){e.popupWindow.close()}this._isPaidButtonMenuOpened[t]=false};BX.Crm.EntityEditorPaymentStatus.prototype.getValue=function(t){if(!this._model){return""}return this._model.getField(this.getName(),t!==undefined?t:"")};BX.Crm.EntityEditorPaymentStatus.prototype.setValue=function(t){if(!this._model){return""}return this._model.setField(this.getName(),t)};BX.Crm.EntityEditorPaymentStatus.prototype.setPaidButtonView=function(t,e){var r=BX("crm_entity_editor_is_payment_paid_button_"+t),i=BX("crm_entity_editor_is_payment_paid_button_main_"+t);if(e){BX.removeClass(r,"ui-btn-danger-light");BX.addClass(r,"ui-btn-success-light");i.innerHTML=this.getMessage("paymentWasPaid")}else{BX.removeClass(r,"ui-btn-success-light");BX.addClass(r,"ui-btn-danger-light");i.innerHTML=this.getMessage("paymentWasNotPaid")}};BX.Crm.EntityEditorPaymentStatus.prototype.openPaidButtonMenu=function(t){var e=this,r;var i=function(r,i){var n=BX.prop.getString(i,"value");if(n==="CANCEL"||n==="RETURN"){e.setValue({isPaid:"N",datePaid:e.getValue().datePaid});e.getModel().setField("PAID","N");if(n==="RETURN"){e.getModel().setField("IS_RETURN","Y");if(!e._isCreateMode){BX.Crm.Page.openSlider(e.getModel().getStringField("PAY_RETURN_URL"),{width:500})}}else{if(!e._isCreateMode){BX.Crm.Page.openSlider(e.getModel().getStringField("PAY_CANCEL_URL"),{width:500})}}}else if(n==="SET_PAID"){e.setValue({isPaid:"Y",datePaid:e.getValue().datePaid});e.getModel().setField("PAID","Y");e.getModel().setField("IS_RETURN","N");if(!e._isCreateMode){if(e._editor.isChanged()){e.markAsChanged();e.getPaymentController().markAsChanged();e.getPaymentController().onDataChanged()}else{e.getPaymentController().ajax("setPaymentPaidField",{data:{FIELDS:{PAID:"Y",PAYMENT_ID:e.getModel().getField("ID")}}},{skipMarkAsChanged:true,sendUpdateEvent:true})}}}e.closePaidButtonMenu(t);e.setPaidButtonView(t,n==="SET_PAID")};var n=this.getValue();if(n.isPaid==="Y"){if(this._isCreateMode){r=[{value:"CANCEL",text:this.getMessage("paymentWasNotPaid"),onclick:i}]}else{r=[{value:"CANCEL",text:this.getMessage("paymentCancel"),onclick:i},{value:"RETURN",text:this.getMessage("paymentReturn"),onclick:i}]}}else{r=[{value:"SET_PAID",text:this.getMessage("paymentWasPaid"),onclick:i}]}BX.PopupMenu.show(this._id,this._paidButtons[t],r,{angle:false});this._isPaidButtonMenuOpened[t]=true};BX.Crm.EntityEditorPaymentStatus.prototype.getPaymentController=function(){if(this._paymentController===null){for(var t=0,e=this._editor._controllers.length;t<e;t++){if(this._editor._controllers[t]instanceof BX.Crm.EntityEditorOrderPaymentController){this._paymentController=this._editor._controllers[t];break}}}return this._paymentController};BX.Crm.EntityEditorPaymentStatus.prototype.checkIfNotEmpty=function(t){return BX.util.trim(t)!==""};BX.Crm.EntityEditorPaymentStatus.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout();this.setPaidButtonView(0,this.getModel().getField("PAID")==="Y")};BX.Crm.EntityEditorPaymentStatus.prototype.clearLayout=function(t){if(!this._hasLayout){return}this._hasLayout=false;this._input=null;this._wrapper=null;this._view=null;this._isPaidButtonMenuOpened={};this._paidButtons={}};BX.Crm.EntityEditorPaymentStatus.prototype.ensureWrapperCreated=function(t){if(!this._wrapper){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}})}var e=BX.prop.getArray(t,"classNames",[]);for(var r=0,i=e.length;r<i;r++){BX.addClass(this._wrapper,e[r])}return this._wrapper};BX.Crm.EntityEditorPaymentStatus.prototype.adjustWrapper=function(){if(!this._wrapper){return}if(this.isInEditMode()&&(this.checkModeOption(BX.Crm.EntityEditorModeOptions.exclusive)||this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual))){BX.addClass(this._wrapper,"crm-entity-widget-content-block-edit")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-edit")}if(this._layoutAttributes){for(var t in this._layoutAttributes){if(this._layoutAttributes.hasOwnProperty(t)){this._wrapper.setAttribute("data-"+t,this._layoutAttributes[t])}}this._layoutAttributes=null}};BX.Crm.EntityEditorPaymentStatus.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorPaymentStatus.prototype.createTitleNode=function(t){this._titleWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-title"}});this.prepareTitleLayout(BX.type.isNotEmptyString(t)?t:this.getTitle());return this._titleWrapper};BX.Crm.EntityEditorPaymentStatus.prototype.prepareTitleLayout=function(t){if(!this._titleWrapper){return}this._titleWrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:t}));var e=this.createTitleMarker();if(e){this._titleWrapper.appendChild(e)}};BX.Crm.EntityEditorPaymentStatus.prototype.createTitleMarker=function(){if(this._mode===BX.Crm.EntityEditorMode.view){return null}if(this.isRequired()){return BX.create("span",{style:{color:"#f00"},text:"*"})}else if(this.isRequiredConditionally()){return BX.create("span",{text:"*"})}return null};BX.Crm.EntityEditorPaymentStatus.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("field_"+this.getId(),{charge:BX.Crm.EditorFieldDragItem.create({control:this,contextId:this._draggableContextId}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorPaymentStatus.prototype.onSetPaidFieldFailure=function(t){this.showError(t)};BX.Crm.EntityEditorPaymentStatus.prototype.showError=function(t,e){BX.Crm.EntityEditorPaymentStatus.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorPaymentStatus.prototype.clearError=function(){BX.Crm.EntityEditorPaymentStatus.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorPaymentStatus.create=function(t,e){var r=new BX.Crm.EntityEditorPaymentStatus;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorPaymentCheck==="undefined"){BX.Crm.EntityEditorPaymentCheck=function(){BX.Crm.EntityEditorPaymentCheck.superclass.constructor.apply(this);this._loader=null};BX.extend(BX.Crm.EntityEditorPaymentCheck,BX.Crm.EntityEditorField);BX.Crm.EntityEditorPaymentCheck.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorPaymentCheck.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorPaymentCheck.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getValue();if(!BX.type.isPlainObject(e)){return}var r=BX.prop.getArray(e,"items",[]);this._totalCount=BX.prop.getInteger(e,"count",0);this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});var i=this._itemCount=r.length;var n=[];for(var o=0;o<i;o++){n.push(this.addCheckRow(r[o],-1))}if(n.length===0){var s=BX.create("div",{props:{className:"crm-entity-widget-content-nothing-selected-text"},text:this.getMessage("emptyCheckList")});n.push(s)}this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-products"},children:n}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorPaymentCheck.prototype.addCheckRow=function(t){if(parseInt(t["ID"])<=0){return}var e=[];var r=BX.create("div",{props:{className:"crm-entity-widget-content-check-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:BX.type.isNotEmptyString(t["TITLE"])?t["TITLE"]:""}),BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:BX.type.isNotEmptyString(t["DATE_CREATE"])?t["DATE_CREATE"]:""})]});var i=[];i.push(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-title"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box-title-text"},html:t["TITLE"]})]}));i.push(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this.createTitleNode(this.getMessage("titleFieldSum")),BX.create("span",{props:{className:"crm-entity-widget-content-block-colums-right"},html:t["SUM_WITH_CURRENCY"]})]})]})]}));i.push(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this.createTitleNode(this.getMessage("titleFieldDateCreate")),BX.create("span",{html:t["DATE_CREATE"]})]})]})]}));i.push(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this.createTitleNode(this.getMessage("titleFieldType")),BX.create("span",{html:t["CHECK_TYPE"]})]})]})]}));if(BX.type.isNotEmptyString(t["CASHBOX_NAME"])){i.push(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this.createTitleNode(this.getMessage("titleFieldCashBoxName")),BX.create("span",{html:t["CASHBOX_NAME"]})]})]})]}))}i.push(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this.createTitleNode(this.getMessage("titleFieldStatus")),BX.create("span",{html:t["STATUS_NAME"]})]})]})]}));var n=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box"},children:i})]})]});e.push(n);return BX.create("div",{props:{className:"crm-entity-widget-content-nothing-selected-text"},children:e})};BX.Crm.EntityEditorPaymentCheck.prototype.clearLayout=function(){if(!this._hasLayout){return}this._table=null;this._moreButton=null;this._moreButtonRow=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};if(typeof BX.Crm.EntityEditorPaymentCheck.messages==="undefined"){BX.Crm.EntityEditorPaymentCheck.messages={}}BX.Crm.EntityEditorPaymentCheck.create=function(t,e){var r=new BX.Crm.EntityEditorPaymentCheck;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderPropertyWrapper==="undefined"){BX.Crm.EntityEditorOrderPropertyWrapper=function(){BX.Crm.EntityEditorOrderPropertyWrapper.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorOrderPropertyWrapper,BX.Crm.EntityEditorSubsection);BX.Crm.EntityEditorOrderPropertyWrapper.prototype.initialize=function(t,e){BX.Crm.EntityEditorOrderPropertyWrapper.superclass.initialize.call(this,t,e);this._personTypeId=BX.prop.getInteger(this._model.getData(),"PERSON_TYPE_ID");this._disabledFieldsBlock=null;this._elementsData=BX.prop.getObject(this._schemeElement._settings,"sortedElements",{});this._elementData={active:BX.prop.getArray(this._elementsData,"active",{}),hidden:BX.prop.getArray(this._elementsData,"hidden",{})};this._childrenScheme={active:[],hidden:[]};this._childrenScheme.active=this.setChildrenScheme(this._elementData.active);this._childrenScheme.hidden=this.setChildrenScheme(this._elementData.hidden);this.addChildren();BX.addCustomEvent(window,BX.Crm.EntityEvent.names.update,BX.delegate(this.onAfterSubmit,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(this.onPropertySave,this));BX.addCustomEvent(window,"Crm.OrderModel.ChangePropertyScheme",BX.delegate(this.onSchemeChange,this))};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.setChildrenScheme=function(t){var e=[];for(var r=0,i=t.length;r<i;r++){e.push(BX.Crm.EntitySchemeElement.create(t[r]))}return e};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.addChildren=function(){var t=BX.Crm.EntitySchemeElement.create({name:this._id+"_ACTIVE",type:"order_property_subsection",transferable:false,editable:true,isDragEnabled:BX.prop.getBoolean(this._schemeElement._settings,"isDragEnabled",false),elements:[],data:this._schemeElement.getData()});this._activeElementsBlock=this._editor.createControl(t.getType(),t.getName(),{schemeElement:t,model:this._model,parent:this,mode:this._mode});if(this._activeElementsBlock){this.addChild(this._activeElementsBlock)}t=BX.Crm.EntitySchemeElement.create({name:this._id+"_DISABLED",type:"order_property_subsection",transferable:false,title:this.getMessage("disabledBlockTitle"),editable:true,isDragEnabled:false,elements:[]});this._disabledFieldsBlock=this._editor.createControl(t.getType(),t.getName(),{schemeElement:t,model:this._model,parent:this,mode:this._mode});this._disabledFieldsBlock._showFieldLink=false;if(this._disabledFieldsBlock){this.addChild(this._disabledFieldsBlock)}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.layout=function(){this.setChildrenFields();BX.Crm.EntityEditorOrderPropertyWrapper.superclass.layout.call(this);var t=this.getParent();if(t instanceof BX.Crm.EntityEditorSection&&BX.type.isDomNode(t.getWrapper())){t.getWrapper().classList.add("crm-entity-card-widget-order-properties")}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.setChildrenFields=function(){this._activeElementsBlock._fields=[];this._disabledFieldsBlock._fields=[];var t=BX.prop.getInteger(this._model.getData(),"PERSON_TYPE_ID");var e=this._childrenScheme.active;for(var r=0;r<e.length;r++){var i=null;var n=e[r];if(t===n.getDataIntegerParam("personTypeId")){i=this._activeElementsBlock;n._isContextMenuEnabled=true}else{var o=BX.prop.getString(this._model.getData(),n.getName());if(!BX.type.isNotEmptyString(o)){continue}n._isContextMenuEnabled=false;i=this._disabledFieldsBlock}var s=this._editor.createControl(n.getType(),n.getName(),{schemeElement:n,model:this._model,parent:i,mode:this._mode});if(this._mode!==BX.Crm.EntityEditorMode.edit||t!==n.getDataIntegerParam("personTypeId")){s.setDragObjectType(BX.Crm.EditorDragObjectType.intermediate)}i.addChild(s)}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.initializeFromModel=function(){this._fields=[]};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.createButtonPanel=function(){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});if(this.isCreationEnabled()){this._createChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("createField"),events:{click:BX.delegate(this.onCreateUserFieldBtnClick,this)}});this._buttonPanelWrapper.appendChild(this._createChildButton);this._insertChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("insertField"),events:{click:BX.delegate(this.onInsertPropertyBtnClick,this)}});this._buttonPanelWrapper.appendChild(this._insertChildButton)}this._addChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("selectField"),events:{click:BX.delegate(this.onAddChildBtnClick,this)}});this.toggleChildButton();this._buttonPanelWrapper.appendChild(this._addChildButton)};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.isCreationEnabled=function(){return true};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.toggleChildButton=function(){if(!BX.type.isDomNode(this._addChildButton)){return}var t=false;for(var e=0;e<this._childrenScheme.hidden.length;e++){if(this._personTypeId===this._childrenScheme.hidden[e].getDataIntegerParam("personTypeId")){t=true;break}}if(t){this._addChildButton.style.display="inline-block"}else{this._addChildButton.style.display="none"}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.onSchemeChange=function(t){this._elementData={active:BX.prop.getArray(t,"ACTIVE",{}),hidden:BX.prop.getArray(t,"HIDDEN",{})};var e=BX.prop.getNumber(t,"PERSON_TYPE_ID",0);if(e>0){this._personTypeId=e;if(this._activeElementsBlock){this._activeElementsBlock._personTypeId=e}}this._childrenScheme.active=this.setChildrenScheme(this._elementData.active);this._childrenScheme.hidden=this.setChildrenScheme(this._elementData.hidden);this.toggleChildButton();this.refreshLayout()};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.onPropertySave=function(t){if(t.getEventId()==="OrderPropertyEdit::onSave"){var e=t.getData();var r=BX.prop.getNumber(e.property,"ID");if(!BX.type.isNotEmptyObject(e.property)||!r){return}var i=e.property;var n="PROPERTY_"+r;this.addActiveField(n,i)}else if(t.getEventId()==="OrderForm::onSave"){this.getOrderController().ajax("getPropertiesScheme",{data:{ORDER_ID:this._editor.getEntityId()},onsuccess:BX.delegate(this.refreshChildren,this)})}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.addActiveField=function(t,e){var r=this._activeElementsBlock.getChildById(t);if(r){r._schemeElement._isRequired=e.REQUIRED==="Y";r._schemeElement.setTitle(BX.util.htmlspecialchars(e.NAME));if(r instanceof BX.Crm.EntityEditorList||r instanceof BX.Crm.EntityEditorMultiList){if(!BX.type.isArray(e.VARIANTS)){property.VARIANTS=[]}var i=[];for(var n=0;n<e.VARIANTS.length;n++){var o=e.VARIANTS[n].VALUE;if(!BX.type.isNotEmptyString(o)){continue}var s=BX.type.isNotEmptyString(e.VARIANTS[n].NAME)?BX.util.htmlspecialchars(e.VARIANTS[n].NAME):o;i.push({VALUE:o,NAME:s})}r._items=i}this.refreshLayout()}else{this.getOrderController().ajax("preparePropertyScheme",{data:{PROPERTY:e},onsuccess:BX.delegate(this.createProperty,this)})}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.getOrderController=function(){for(var t=0,e=this._editor._controllers.length;t<e;t++){if(this._editor._controllers[t]instanceof BX.Crm.EntityEditorOrderController){return this._editor._controllers[t]}}return null};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.createProperty=function(t){this.getOrderController().unlockSending();this.getOrderController().hideLoader();var e=BX.prop.getObject(t,"FIELD",null);if(!e){return}var r=BX.Crm.EntitySchemeElement.create(e);this._model.setField(r.getName(),"");this._childrenScheme.active.push(r);var i=this._editor.createControl(r.getType(),r.getName(),{schemeElement:r,model:this._model,parent:this,mode:this._mode});var n=this._editor.getOption("show_always","Y")==="Y";if(n!==i.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){i.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}if(i instanceof BX.Crm.EntityEditorCustom){this.getOrderController().onDataChanged()}else{this._activeElementsBlock.addChild(i)}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.refreshChildren=function(t){this.getOrderController().unlockSending();this.getOrderController().hideLoader();if(parseInt(t.ORDER_ID)!==parseInt(this._editor.getEntityId())||!BX.type.isNotEmptyObject(t.PROPERTIES)){return}if(BX.type.isArray(t.PROPERTIES.ACTIVE)){this._childrenScheme.active=this.setChildrenScheme(BX.prop.getArray(t.PROPERTIES,"ACTIVE",[]))}if(BX.type.isArray(t.PROPERTIES.HIDDEN)){this._childrenScheme.hidden=this.setChildrenScheme(BX.prop.getArray(t.PROPERTIES,"HIDDEN",[]))}this.refreshLayout()};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.removeChild=function(t){this._childrenScheme.hidden.push(t.getSchemeElement());var e=t.getId();for(var r=0;r<this._childrenScheme.active.length;r++){if(e===this._childrenScheme.active[r].getName()){this._childrenScheme.active.splice(r,1);break}}this.toggleChildButton()};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.openAddChildMenu=function(){var t=[];for(var e=0;e<this._childrenScheme.hidden.length;e++){if(this._personTypeId===this._childrenScheme.hidden[e].getDataIntegerParam("personTypeId")){t.push(this._childrenScheme.hidden[e])}}var r=t.length;if(r===0){return}var i=[];for(e=0;e<r;e++){var n=t[e];i.push({text:n.getTitle(),value:n.getName()})}if(this._childSelectMenu){this._childSelectMenu.setupItems(i)}else{this._childSelectMenu=BX.CmrSelectorMenu.create(this._id,{items:i});this._childSelectMenu.addOnSelectListener(BX.delegate(this.onChildSelect,this))}this._childSelectMenu.open(this._addChildButton)};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.onChildSelect=function(t,e){var r=e.getValue();if(r==="ACTION.TRANSFER"){this.openTransferDialog();return}for(var i=0;i<this._childrenScheme.hidden.length;i++){if(this._childrenScheme.hidden[i].getName()===r){element=this._childrenScheme.hidden[i];this._childrenScheme.hidden=BX.util.deleteFromArray(this._childrenScheme.hidden,i);this.toggleChildButton();break}}if(!element){return}var n=element.getDataStringParam("propertyId");var o={SETTINGS:{IS_HIDDEN:"N"}};this._activeElementsBlock.savePropertyConfig(n,o);var s=this._editor.createControl(element.getType(),element.getName(),{schemeElement:element,model:this._model,parent:this,mode:this._mode});if(s){this._activeElementsBlock.addChild(s);this._childrenScheme.active.push(element)}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.onAfterSubmit=function(t){var e=BX.prop.getObject(t,"entityData",null);if(e){var r=BX.prop.getArray(e,"USER_PROFILE_LIST");this.refreshProfilesList(r);var i=BX.prop.getNumber(e,"PERSON_TYPE_ID");if(this._personTypeId!==i){this.refreshLayout()}}if(this._activeElementsBlock.isSchemeChanged()){var n=[];var o=[];var s=this._activeElementsBlock._fields;for(var a=0;a<s.length;a++){var d=s[a];var l=d._schemeElement.getDataStringParam("propertyId");if(BX.type.isNotEmptyString(l)){n.push(d._schemeElement.getDataStringParam("propertyId"));o.push(d._schemeElement)}}if(n.length>0){BX.ajax.post(BX.prop.getString(this._settings,"serviceUrl",""),{PROPERTIES:n,ACTION:"sortProperties"})}for(a=0;a<this._childrenScheme.active.length;a++){var c=this._childrenScheme.active[a].getDataStringParam("propertyId");if(!BX.util.in_array(c,n)){o.push(this._childrenScheme.active[a])}}this._childrenScheme.active=o}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.refreshProfilesList=function(t){if(BX.type.isArray(t)){var e=this._editor.getControls();for(var r=0;r<e.length;r++){var i=e[r].getChildById("USER_PROFILE");if(i){i._items=null;i._schemeElement.setData({items:t});i.refreshLayout();return}}}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.setDraggableContextId=function(t){};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.showPropertyEditor=function(t){t=parseInt(t);var e=this._schemeElement.getData();if(BX.type.isNotEmptyString(e.editorUrl)){var r=e.editorUrl.replace("#property_id#",t).replace("#person_type_id#",this._personTypeId);BX.SidePanel.Instance.open(r,{loader:"crm-webform-view-loader"})}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.showManagerSlider=function(t){var e=this._schemeElement.getData();if(BX.type.isNotEmptyString(e.managerUrl)){var r=e.managerUrl.replace("#person_type_id#",this._personTypeId);BX.SidePanel.Instance.open(r,{loader:"crm-webform-view-loader"})}};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.onCreateUserFieldBtnClick=function(t){this.showPropertyEditor(0)};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.onInsertPropertyBtnClick=function(t){this.showManagerSlider()};BX.Crm.EntityEditorOrderPropertyWrapper.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorOrderPropertyWrapper.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorOrderPropertyWrapper.create=function(t,e){var r=new BX.Crm.EntityEditorOrderPropertyWrapper;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderPropertySubsection==="undefined"){BX.Crm.EntityEditorOrderPropertySubsection=function(){BX.Crm.EntityEditorOrderPropertySubsection.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorOrderPropertySubsection,BX.Crm.EntityEditorSubsection);BX.Crm.EntityEditorOrderPropertySubsection.prototype.initialize=function(t,e){BX.Crm.EntityEditorOrderPropertySubsection.superclass.initialize.call(this,t,e);this._personTypeId=BX.prop.getInteger(this._model.getData(),"PERSON_TYPE_ID");this._showFieldLink=true;if(this.getChildDragScope()===BX.Crm.EditorDragScope.parent){this._draggableContextId+="_"+this.getId()}BX.addCustomEvent(window,"CrmOrderPropertySetCustom",BX.delegate(this.onChangeCustomProperty,this))};BX.Crm.EntityEditorOrderPropertySubsection.prototype.getEditPriority=function(){return BX.Crm.EntityEditorPriority.high};BX.Crm.EntityEditorOrderPropertySubsection.prototype.layoutChild=function(t){BX.Crm.EntityEditorOrderPropertySubsection.superclass.layoutChild.call(this,t);var e=BX.prop.getString(t._schemeElement._settings,"linked");if(this._mode!==BX.Crm.EntityEditorMode.view&&t.isContextMenuEnabled()&&BX.type.isNotEmptyString(e)&&this._showFieldLink){BX.addClass(t._wrapper,"crm-entity-widget-content-block-linked");t._titleWrapper.setAttribute("title",e)}};BX.Crm.EntityEditorOrderPropertySubsection.prototype.layoutTitle=function(){if(BX.type.isNotEmptyString(this._schemeElement.getTitle())&&this.getChildCount()>0){var t=BX.create("div",{attrs:{className:"crm-entity-card-widget-title"},text:this._schemeElement.getTitle()});if(BX.type.isDomNode(this._contentContainer)){BX.addClass(this._contentContainer,"crm-entity-widget-content")}this._wrapper.appendChild(t)}};BX.Crm.EntityEditorOrderPropertySubsection.prototype.onFieldConfigurationSave=function(t,e){if(t!==this._fieldConfigurator){return}var r=BX.prop.get(e,"field",null);if(!r){throw"EntityEditorSection. Could not find target field."}var i=BX.prop.getString(e,"label","");var n=BX.prop.getBoolean(e,"showAlways",null);if(i===""&&n===null){this.removeFieldConfigurator();return}this._fieldConfigurator.setLocked(true);r.setTitle(i);if(n!==null&&n!==r.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){r.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}var o={NAME:i,SETTINGS:{SHOW_ALWAYS:n?"Y":"N"}};var s=r._schemeElement.getDataStringParam("propertyId");this.savePropertyConfig(s,o).then(BX.delegate(function(){this.removeFieldConfigurator()},this))};BX.Crm.EntityEditorOrderPropertySubsection.prototype.getOrderController=function(){for(var t=0,e=this._editor._controllers.length;t<e;t++){if(this._editor._controllers[t]instanceof BX.Crm.EntityEditorOrderController){return this._editor._controllers[t]}}return null};BX.Crm.EntityEditorOrderPropertySubsection.prototype.processChildControlSchemeChange=function(t){var e=t._schemeElement.getDataStringParam("propertyId");var r={SETTINGS:{SHOW_ALWAYS:t.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)?"Y":"N"}};this.savePropertyConfig(e,r)};BX.Crm.EntityEditorOrderPropertySubsection.prototype.processDraggedItemDrop=function(t,e){var r=t.getCharge();if(!(r instanceof BX.Crm.EditorFieldDragContainer&&r.getSection()===this)){return}var i=e.getContextData();var n=BX.type.isNotEmptyString(i["contextId"])?i["contextId"]:"";if(n!==this.getDraggableContextId()){return}var o=typeof i["charge"]!=="undefined"?i["charge"]:null;if(!(o instanceof BX.Crm.EditorFieldDragItem)){return}var s=o.getControl();if(!s){return}var a=this.getChildIndex(s);if(a<0){return}var d=this.getPlaceHolder();var l=d?d.getIndex():-1;if(l<0){return}var c=l<=a?l:l-1;if(c!==a){this.moveChild(s,c)}};BX.Crm.EntityEditorOrderPropertySubsection.prototype.onChangeCustomProperty=function(t){if(BX.type.isNotEmptyString(t)){var e=this.getChildById(t);if(e){var r=e.getWrapper();if(!BX.type.isDomNode(r))return;var i=e._schemeElement.getDataStringParam("type");if(i==="LOCATION"){var n=r.querySelector("input[name="+t+"]");if(BX.type.isDomNode(n)){var o=BX.prop.getString(this._model.getData(),t);if(n.value!==o){e.setRuntimeValue(n.value);e.markAsChanged()}}}else if(i==="FILE"){var s=BX.prop.getString(this._model.getData(),t);e.setRuntimeValue(s);e.markAsChanged()}}}};BX.Crm.EntityEditorOrderPropertySubsection.prototype.editChildConfiguration=function(t){this.showPropertyEditor(t._schemeElement.getDataStringParam("propertyId"))};BX.Crm.EntityEditorOrderPropertySubsection.prototype.removeChild=function(t,e){if(!BX.type.isPlainObject(e)){e={}}var r=this.getChildIndex(t);if(r<0){return}if(t.isActive()){t.setActive(false)}this._fields.splice(r,1);var i=t.hasScheme();if(i){t.getSchemeElement().setParent(null);if(this._parent){this._parent.removeChild(t)}}if(this._hasLayout){t.clearLayout();t.setContainer(null);t.setDraggableContextId("")}if(i){var n=t._schemeElement.getDataStringParam("propertyId");var o={SETTINGS:{IS_HIDDEN:"Y"}};this.savePropertyConfig(n,o)}};BX.Crm.EntityEditorOrderPropertySubsection.prototype.savePropertyConfig=function(t,e){var r=new BX.Promise;var i={PROPERTY_ID:t,ACTION:"savePropertyConfig",CONFIG:e};BX.ajax.post(BX.prop.getString(this._settings,"serviceUrl",""),i,function(){r.fulfill()});this._isChanged=false;return r};BX.Crm.EntityEditorOrderPropertySubsection.prototype.isDragEnabled=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&BX.prop.getBoolean(this._schemeElement._settings,"isDragEnabled",false)};BX.Crm.EntityEditorOrderPropertySubsection.prototype.refreshProfilesList=function(t){if(BX.type.isArray(t)){var e=this._editor.getControls();for(var r=0;r<e.length;r++){var i=e[r].getChildById("USER_PROFILE");if(i){i._items=null;i._schemeElement.setData({items:t});i.refreshLayout();return}}}};BX.Crm.EntityEditorOrderPropertySubsection.prototype.moveChild=function(t,e){var r=this.getChildCount();var i=r-1;if(e<0||e>r){e=i}var n=this.getChildIndex(t);if(n<0||n===e){return false}if(this._hasLayout){t.clearLayout()}this._fields.splice(n,1);r--;var o=null;if(this._hasLayout){o=e<r?this._fields[e].getWrapper():this._buttonPanelWrapper}if(e<r){this._fields.splice(e,0,t)}else{this._fields.push(t)}if(this._hasLayout){if(o){t.layout({anchor:o})}else{t.layout()}}this.markSchemeAsChanged();this.markAsChanged();return true};BX.Crm.EntityEditorOrderPropertySubsection.prototype.hasAdditionalMenu=function(t){return true};BX.Crm.EntityEditorOrderPropertySubsection.prototype.getAdditionalMenu=function(t){return[{value:"linkToSettings",text:this.getMessage("linkToSettings")}]};BX.Crm.EntityEditorOrderPropertySubsection.prototype.showPropertyEditor=function(t){t=parseInt(t);var e=this._schemeElement.getData();if(BX.type.isNotEmptyString(e.editorUrl)){var r=e.editorUrl.replace("#property_id#",t).replace("#person_type_id#",this._personTypeId);BX.SidePanel.Instance.open(r,{loader:"crm-webform-view-loader"})}};BX.Crm.EntityEditorOrderPropertySubsection.prototype.showManagerSlider=function(t){var e=this._schemeElement.getData();if(BX.type.isNotEmptyString(e.managerUrl)){var r=e.managerUrl.replace("#person_type_id#",this._personTypeId);BX.SidePanel.Instance.open(r,{loader:"crm-webform-view-loader"})}};BX.Crm.EntityEditorOrderPropertySubsection.prototype.processChildAdditionalMenuCommand=function(t,e){if(e==="linkToSettings"){this.showManagerSlider()}};BX.Crm.EntityEditorOrderPropertySubsection.prototype.onCreateUserFieldBtnClick=function(t){this.showPropertyEditor(0)};BX.Crm.EntityEditorOrderPropertySubsection.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorOrderPropertySubsection.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorOrderPropertySubsection.create=function(t,e){var r=new BX.Crm.EntityEditorOrderPropertySubsection;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderProductProperty==="undefined"){BX.Crm.EntityEditorOrderProductProperty=function(){BX.Crm.EntityEditorOrderProductProperty.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorOrderProductProperty,BX.Crm.EntityEditorField);BX.Crm.EntityEditorOrderProductProperty.prototype.initialize=function(t,e){BX.Crm.EntityEditorOrderProductProperty.superclass.initialize.call(this,t,e);this._addPropertyLink=null;this._innerWrapper=null;this._index=0};BX.Crm.EntityEditorOrderProductProperty.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-text"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}this._innerWrapper=BX.create("div");this._wrapper.appendChild(this._innerWrapper);var e=BX.prop.get(this._model.getData(),this.getName(),[]);for(var r in e){if(e.hasOwnProperty(r)){this.layoutProperty(e[r])}}this._addPropertyLink=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("addProductProperty"),events:{click:BX.delegate(this.layoutProperty,this)}});this._wrapper.appendChild(this._addPropertyLink);this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorOrderProductProperty.prototype.layoutProperty=function(t){var t=t||{};if(!BX.type.isDomNode(this._innerWrapper))return;this._index++;var e=this.getMessage("fieldBlockTitle");e=e.replace("#INDEX#",this._index);var r=BX.create("div",{attrs:{className:"crm-entity-card-widget"},children:[BX.create("div",{attrs:{className:"crm-entity-card-widget-title"},text:e})]});this._innerWrapper.appendChild(r);var i=["Name","Value","Code","Sort"];for(var n=0;n<i.length;n++){var o={name:"PROPERTY["+this._index+"]["+i[n].toUpperCase()+"]",className:"crm-entity-widget-content-input",type:"text"};var s=BX.prop.getString(t,i[n].toUpperCase());if(s!==undefined){o.value=s}else if(i[n]==="Sort"){o.value=100}var a=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},children:[this.createTitleNode(this.getMessage("fieldTitle"+i[n])),BX.create("input",{attrs:o})]});this._innerWrapper.appendChild(a)}if(BX.type.isDomNode(this._addPropertyLink)&&!BX.hasClass(this._addPropertyLink,"crm-entity-widget-content-block-edit-action-btn-added")){BX.addClass(this._addPropertyLink,"crm-entity-widget-content-block-edit-action-btn-added")}this.markAsChanged()};BX.Crm.EntityEditorOrderProductProperty.prototype.save=function(t){if(BX.type.isDomNode(this._wrapper)){var e={};var r=this._wrapper.querySelectorAll("input");for(var i=0;i<r.length;i++){e[r[i].name]=r[i].value}this._model.setField(this.getName(),e,{originator:this})}};BX.Crm.EntityEditorOrderProductProperty.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorOrderProductProperty.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorOrderProductProperty.create=function(t,e){var r=new BX.Crm.EntityEditorOrderProductProperty;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderPersonType==="undefined"){BX.Crm.EntityEditorOrderPersonType=function(){BX.Crm.EntityEditorOrderPersonType.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorOrderPersonType,BX.Crm.EntityEditorList);BX.Crm.EntityEditorOrderPersonType.prototype.initialize=function(t,e){BX.Crm.EntityEditorOrderPersonType.superclass.initialize.call(this,t,e);BX.addCustomEvent(window,BX.Crm.EntityEvent.names.update,BX.delegate(this.onAfterUpdate,this));this._baseValue=this.getValue()};BX.Crm.EntityEditorOrderPersonType.prototype.onItemSelect=function(t,e){this.closeMenu();if(this._selectedValue!==e.value){this._selectedValue=this._input.value=e.value;var r=BX.prop.getString(this.getItemByValue(this._selectedValue),"NAME",this._selectedValue);this._selectContainer.innerHTML=this.getDataBooleanParam("isHtml",false)?r:BX.util.htmlspecialchars(r);this.markAsChanged();for(var i=0,n=this._editor._controllers.length;i<n;i++){if(this._editor._controllers[i]instanceof BX.Crm.EntityEditorOrderController&&this._selectedValue!=="NEW"){this._editor._controllers[i].onDataChanged()}}}BX.PopupMenu.destroy(this._id)};BX.Crm.EntityEditorOrderPersonType.prototype.getDragObjectType=function(){return BX.Crm.EditorDragObjectType.intermediate};BX.Crm.EntityEditorOrderPersonType.prototype.onAfterUpdate=function(t,e){if(this.isChanged()){this._baseValue=this.getValue()}};BX.Crm.EntityEditorOrderPersonType.create=function(t,e){var r=new BX.Crm.EntityEditorOrderPersonType;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderUser==="undefined"){BX.Crm.EntityEditorOrderUser=function(){BX.Crm.EntityEditorOrderUser.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorOrderUser,BX.Crm.EntityEditorClientLight);BX.Crm.EntityEditorOrderUser.prototype.doInitialize=function(){BX.Crm.EntityEditorOrderUser.superclass.doInitialize.apply(this);this._selectedValue=null;this._searchBox=null};BX.Crm.EntityEditorOrderUser.prototype.addContact=function(t){if(t instanceof BX.CrmEntityInfo){this._contactInfos.add(t)}};BX.Crm.EntityEditorOrderUser.prototype.removeContact=function(t){if(t instanceof BX.CrmEntityInfo){this._contactInfos.remove(t)}};BX.Crm.EntityEditorOrderUser.prototype.setContacts=function(t){this._contactInfos.removeAll();for(var e=0,r=t.length;e<r;e++){var i=t[e];if(i instanceof BX.CrmEntityInfo){this._contactInfos.add(i)}}};BX.Crm.EntityEditorOrderUser.prototype.hasContentToDisplay=function(){return this._companyInfo!==null||this._contactInfos!==null&&this._contactInfos.length()>0};BX.Crm.EntityEditorOrderUser.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorOrderUser.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorOrderUser.prototype.rollback=function(){};BX.Crm.EntityEditorOrderUser.prototype.doPrepareContextMenuItems=function(t){};BX.Crm.EntityEditorOrderUser.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(this.isInViewMode()){var e=this._model.getSchemeField(this._schemeElement,"formated","");var r=this._model.getSchemeField(this._schemeElement,"position","");var i=this._model.getSchemeField(this._schemeElement,"showUrl","","");var n=this._model.getSchemeField(this._schemeElement,"photoUrl","");this._photoElement=BX.create("a",{props:{className:"crm-widget-employee-avatar-container",target:"_blank"},style:{backgroundImage:n!==""?"url('"+n+"')":"",backgroundSize:n!==""?"30px":""}});this._nameElement=BX.create("a",{props:{className:"crm-widget-employee-name",target:"_blank"},text:e});if(i!==""){this._photoElement.href=i;this._nameElement.href=i}this._positionElement=BX.create("SPAN",{props:{className:"crm-widget-employee-position"},text:r});if(this.isInEditMode()){this._wrapper.appendChild(this.createDragButton())}var o=BX.create("div",{props:{className:"crm-widget-employee-container"}});this._editButton=BX.create("span",{props:{className:"crm-widget-employee-change"},text:this.getMessage("change")});BX.bind(this._editButton,"click",BX.delegate(this.switchToSingleEditMode,this));o.appendChild(this._editButton);o.appendChild(this._photoElement);o.appendChild(BX.create("span",{props:{className:"crm-widget-employee-info"},children:[this._nameElement,this._positionElement]}));this._searchBox=null;this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[o]}))}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);BX.addClass(this._innerWrapper,"crm-entity-widget-content-inner");var s=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"}});this._innerWrapper.appendChild(s);this._innerContainer=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container-inner"}});s.appendChild(this._innerContainer);var a=this._schemeElement.getName();this._selectedValue=this._model.getField(a);this._contactSearchBoxes=[];this._searchBox=this.addSearchBox(this.createSearchBox())}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorOrderUser.prototype.hasContentToDisplay=function(){return this.hasValue()};BX.Crm.EntityEditorOrderUser.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}if(BX.prop.getBoolean(t,"forAll",false)&&this._searchBox){var e=this._model.getSchemeField(this._schemeElement,"defaultUserList",[]);this._searchBox._searchControl.setItems(e)}var r=this._schemeElement.getName();if(this._selectedValue!=this._model.getField(r)){this.refreshLayout()}};BX.Crm.EntityEditorOrderUser.prototype.addSearchBox=function(t){this._contactSearchBoxes.push(t);var e={};if(this._addContactButton){e["anchor"]=this._addContactButton}t.layout(e);return t};BX.Crm.EntityEditorOrderUser.prototype.createSearchBox=function(t){var e=this._schemeElement.getName();var r=this._model.getField(e);var i=BX.CrmEntityInfo.create({title:this._model.getSchemeField(this._schemeElement,"formated",""),entityId:r});if(i!==null&&!(i instanceof BX.CrmEntityInfo)){i=null}return BX.Crm.EntityEditorOrderClientSearchBox.create(this._id,{entityInfo:i,enableCreation:false,loaderConfig:this._primaryLoaderConfig,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"defaultUserList",[]),container:this._innerContainer,enableDeletion:true,placeholder:this.getMessage("searchPlaceholder"),parentField:this})};BX.Crm.EntityEditorOrderUser.prototype.save=function(){if(!this.isEditable()){return}this._model.setField(this.getName(),this._selectedValue)};BX.Crm.EntityEditorOrderUser.prototype.onContactAddButtonClick=function(t){};BX.Crm.EntityEditorOrderUser.prototype.onCompanyReset=function(t,e){};BX.Crm.EntityEditorOrderUser.prototype.onCompanyChange=function(t,e,r){};BX.Crm.EntityEditorOrderUser.prototype.onContactInfosLoad=function(t,e){};BX.Crm.EntityEditorOrderUser.prototype.getRuntimeValue=function(){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._selectedValue){return this._selectedValue}return""};BX.Crm.EntityEditorOrderUser.prototype.onRequisiteChange=function(t,e){};BX.Crm.EntityEditorOrderUser.prototype.onBeforeSubmit=function(){};BX.Crm.EntityEditorOrderUser.prototype.processItemSelect=function(t){var e=this._mode===BX.Crm.EntityEditorMode.view;var r=this.isEditInViewEnabled();var n=BX.prop.getInteger(t,"id",0);if(e&&!r){return}this._selectedValue=n;if(!e){this.markAsChanged()}else{this._editor.saveControl(this)}if(this._mode!==BX.Crm.EntityEditorMode.view){for(i=0,length=this._editor._controllers.length;i<length;i++){if(this._editor._controllers[i]instanceof BX.Crm.EntityEditorOrderController){this._editor._controllers[i].onDataChanged()}}}};BX.Crm.EntityEditorOrderUser.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorOrderUser.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorOrderUser.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorOrderUser.create=function(t,e){var r=new BX.Crm.EntityEditorOrderUser;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderClientSearchBox==="undefined"){BX.Crm.EntityEditorOrderClientSearchBox=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._resetButton=null;this._parentField=null;this._entityInfo=null;this._searchInput=null;this._searchControl=null;this._loaderConfig=null;this._resetButtonHandler=BX.delegate(this.onResetButtonClick,this);this._hasLayout=false};BX.Crm.EntityEditorOrderClientSearchBox.prototype.initialize=function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._parentField=BX.prop.get(this._settings,"parentField",null);this._container=BX.prop.getElementNode(this._settings,"container",null);var r=BX.prop.get(this._settings,"entityInfo",null);if(r){this._entityInfo=r}this._loaderConfig=BX.prop.get(this._settings,"loaderConfig",null)};BX.Crm.EntityEditorOrderClientSearchBox.prototype.layout=function(t){if(this._hasLayout){return}if(!BX.type.isPlainObject(t)){t={}}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-search-row"}});this.innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-search-inner"}});var e=BX.prop.getElementNode(t,"anchor",null);if(e){this._container.insertBefore(this._wrapper,e)}else{this._container.appendChild(this._wrapper)}this._wrapper.appendChild(this.innerWrapper);var r=BX.create("div",{props:{className:"crm-entity-widget-content-search-box"}});this.innerWrapper.appendChild(r);var i=BX.create("div",{props:{className:"crm-entity-widget-img-box crm-entity-widget-img-contact"}});r.appendChild(i);this._searchInput=BX.create("input",{props:{type:"text",placeholder:BX.prop.getString(this._settings,"placeholder",""),className:"crm-entity-widget-content-input crm-entity-widget-content-search-input",autocomplete:"off"}});r.appendChild(this._searchInput);BX.bind(this._searchInput,"focus",this._inputFocusHandler);BX.bind(this._searchInput,"blur",this._inputBlurHandler);this._resetButton=BX.create("div",{props:{className:"crm-entity-widget-btn-close"}});this.innerWrapper.appendChild(this._resetButton);BX.bind(this._resetButton,"click",this._resetButtonHandler);if(this._entityInfo){this._searchInput.value=this._entityInfo.getTitle()}this._searchControl=new BX.UI.Dropdown({searchAction:"crm.api.order.searchBuyer",searchOptions:{emptyItem:{subtitle:this.getMessage("notFound"),title:""}},searchResultRenderer:null,targetElement:this._searchInput,items:BX.prop.getArray(this._settings,"lastEntityInfos",[]),enableCreation:false,showEmptyContainer:true,messages:{notFound:this.getMessage("notFound")},events:{onSelect:this.onEntitySelect.bind(this)}});this._hasLayout=true};BX.Crm.EntityEditorOrderClientSearchBox.prototype.onEntitySelect=function(t,e){var r=BX.prop.getInteger(e,"id",0);var i=BX.prop.getString(e,"title","");if(r<=0){return}this._searchInput.value=i;if(this._parentField instanceof BX.Crm.EntityEditorOrderUser){this._parentField.processItemSelect(e)}this._searchControl.alertEmptyContainer=null;this._searchControl.destroyPopupWindow()};BX.Crm.EntityEditorOrderClientSearchBox.prototype.onResetButtonClick=function(t){this._searchInput.value="";if(this._parentField instanceof BX.Crm.EntityEditorOrderUser){this._parentField.processItemSelect({item:null})}};BX.Crm.EntityEditorOrderClientSearchBox.prototype.getMessage=function(t){return BX.prop.getString(BX.Crm.EntityEditorOrderClientSearchBox.messages,t)};if(typeof BX.Crm.EntityEditorOrderClientSearchBox.messages==="undefined"){BX.Crm.EntityEditorOrderClientSearchBox.messages={}}BX.Crm.EntityEditorOrderClientSearchBox.create=function(t,e){var r=new BX.Crm.EntityEditorOrderClientSearchBox;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderClient==="undefined"){BX.Crm.EntityEditorOrderClient=function(){BX.Crm.EntityEditorOrderClient.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorOrderClient,BX.Crm.EntityEditorClientLight);BX.Crm.EntityEditorOrderClient.prototype.save=function(){BX.Crm.EntityEditorOrderClient.superclass.save.apply(this);if(this._item&&this._item._requisitePanel){this._model.setField("REQUISITE_BINDING",this._item._requisitePanel.getRuntimeValue())}};BX.Crm.EntityEditorOrderClient.prototype.getRuntimeValue=function(){var t={};var e=BX.prop.getString(this._map,"companyId","");if(e!==""){t[e]=this._companyInfo?this._companyInfo.getId():0}var r=[];var i,n;if(this._contactInfos!==null){var o=this._contactInfos.getItems();for(i=0,n=o.length;i<n;i++){var s=o[i];r.push(s.getId())}}e=BX.prop.getString(this._map,"contactIds","");if(e!==""){t[e]=r}if(this._item&&this._item._requisitePanel){t["REQUISITE_BINDING"]=this._item._requisitePanel.getRuntimeValue()}return t};BX.Crm.EntityEditorOrderClient.prototype.onCompanyChange=function(t,e,r){BX.Crm.EntityEditorOrderClient.superclass.onCompanyChange.call(this,t,e,r);if(e.getId()>0){for(var i=0,n=this._editor._controllers.length;i<n;i++){if(this._editor._controllers[i]instanceof BX.Crm.EntityEditorOrderController){this._editor._controllers[i].onDataChanged();this._editor._controllers[i].unlockSending();return}}}};BX.Crm.EntityEditorOrderClient.prototype.onContactChange=function(t,e,r){BX.Crm.EntityEditorOrderClient.superclass.onContactChange.call(this,t,e,r);for(var i=0,n=this._editor._controllers.length;i<n;i++){if(this._editor._controllers[i]instanceof BX.Crm.EntityEditorOrderController){this._editor._controllers[i].onDataChanged();this._editor._controllers[i].unlockSending();return}}};BX.Crm.EntityEditorOrderClient.prototype.onContactInfosLoad=function(t,e){BX.Crm.EntityEditorOrderClient.superclass.onContactInfosLoad.call(this,t,e);for(var r=0,i=this._editor._controllers.length;r<i;r++){if(this._editor._controllers[r]instanceof BX.Crm.EntityEditorOrderController){this._editor._controllers[r].onDataChanged();this._editor._controllers[r].unlockSending();return}}};BX.Crm.EntityEditorOrderClient.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}if(BX.prop.getBoolean(t,"forAll",false)&&this._companySearchBox){var e=this._model.getSchemeField(this._schemeElement,"lastCompanyInfos",[]);if(BX.type.isNotEmptyObject(e)){this._companySearchBox._searchControl.setItems(e);this._companySearchBox._searchControl.setDefaultItems(e)}}var r=this._model.getSchemeField(this._schemeElement,"lastContactInfos",[]);if(BX.prop.getBoolean(t,"forAll",false)&&BX.type.isArray(this._contactSearchBoxes)&&this._contactSearchBoxes.length>0&&BX.type.isNotEmptyObject(r)){for(var i=0;i<this._contactSearchBoxes.length;i++){this._contactSearchBoxes[i]._searchControl.setItems(r);this._contactSearchBoxes[i]._searchControl.setDefaultItems(r)}}};BX.Crm.EntityEditorOrderClient.create=function(t,e){var r=new BX.Crm.EntityEditorOrderClient;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorMultiList==="undefined"){BX.Crm.EntityEditorMultiList=function(){BX.Crm.EntityEditorMultiList.superclass.constructor.apply(this);this._items=null;this._input=null;this._selectedValues=[];this._hiddenNode="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._innerWrapper=null;this._isOpened=false};BX.extend(BX.Crm.EntityEditorMultiList,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMultiList.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMultiList.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorMultiList.prototype.hasContentToDisplay=function(){var t=this.getValue();return BX.type.isArray(t)&&t.length>0&&BX.type.isNotEmptyString(t[0])};BX.Crm.EntityEditorMultiList.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-custom-multiselect"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var r=this.getTitle();var i=this.getValue();this._selectedValues=this.getSelectedValues(i);if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(r));var n={isMulti:true,fieldName:e};this._input=BX.decl({block:"main-ui-multi-select",name:e,items:this._items,value:this._selectedValues,params:n,valueDelete:true});var o=BX.create("div",{props:{className:"fields enumeration field-item"},children:[this._input]});BX.addCustomEvent(window,"UI::Select::change",BX.delegate(this.onChange,this));BX.bind(o,"click",BX.defer(function(){this.onChange({params:n,node:o.firstChild})},this));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._innerWrapper.appendChild(o);this.layoutHidden();this._innerWrapper.appendChild(this._hiddenNode)}else{this._wrapper.appendChild(this.createTitleNode(r));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});var s="";if(!this.hasContentToDisplay()){itemContainer=BX.create("div",{text:this.getMessage("isEmpty")});this._innerWrapper.appendChild(itemContainer)}else{for(var a=0;a<this._selectedValues.length;a++){var d=this.getItemByValue(this._selectedValues[a].VALUE);if(BX.type.isNotEmptyString(d["NAME"])){s=d["NAME"]}else{s=d["VALUE"]}if(BX.type.isNotEmptyString(s)){itemContainer=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:s});this._innerWrapper.appendChild(itemContainer)}}}}this._wrapper.appendChild(this._innerWrapper);if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMultiList.prototype.doClearLayout=function(t){this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorMultiList.prototype.layoutHidden=function(){if(!BX.type.isDomNode(this._hiddenNode)){this._hiddenNode=BX.create("div")}else{this._hiddenNode.innerHTML=""}var t=this._selectedValues.length;if(t>0){for(var e=0;e<t;e++){this._hiddenNode.appendChild(BX.create("input",{attrs:{type:"hidden",name:this.getName()+"[]",value:this._selectedValues[e].VALUE}}))}}else{this._hiddenNode.appendChild(BX.create("input",{attrs:{type:"hidden",name:this.getName()+"[]"}}))}};BX.Crm.EntityEditorMultiList.prototype.validate=function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){throw"BX.Crm.EntityEditorMultiList. Invalid validation context"}if(!this.isEditable()){return true}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorMultiList.prototype.showError=function(t,e){BX.Crm.EntityEditorMultiList.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorMultiList.prototype.clearError=function(){BX.Crm.EntityEditorMultiList.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorMultiList.prototype.onChange=function(t){if(t.params.fieldName===this.getName()&&this._input){this._selectedValues=JSON.parse(this._input.getAttribute("data-value"));this.layoutHidden();this.markAsChanged()}};BX.Crm.EntityEditorMultiList.prototype.getItems=function(){if(!this._items){this._items=BX.prop.getArray(this._schemeElement.getData(),"items")}return this._items};BX.Crm.EntityEditorMultiList.prototype.getItemByValue=function(t){var e=this.getItems();for(var r=0,i=e.length;r<i;r++){var n=e[r];if(t===BX.prop.getString(n,"VALUE","")){return n}}return null};BX.Crm.EntityEditorMultiList.prototype.getSelectedValues=function(t){var e=[];var r=this.getItems();if(!BX.type.isArray(t)){return[]}for(var i=0;i<t.length;i++){value=t[i];for(var n=0,o=r.length;n<o;n++){var s=r[n];if(value===BX.prop.getString(s,"VALUE","")){e.push(s)}}}return e};BX.Crm.EntityEditorMultiList.prototype.getFirstItem=function(){var t=this.getItems();return t.length>0?t[0]:null};BX.Crm.EntityEditorMultiList.prototype.save=function(){if(!this.isEditable()){return}this._model.setField(this.getName(),this.getRuntimeValue())};BX.Crm.EntityEditorMultiList.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit&&this._input){for(var e=0;e<this._selectedValues.length;e++){t.push(this._selectedValues[e].VALUE)}}return t};BX.Crm.EntityEditorMultiList.create=function(t,e){var r=new BX.Crm.EntityEditorMultiList;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderQuantity==="undefined"){BX.Crm.EntityEditorOrderQuantity=function(){BX.Crm.EntityEditorOrderQuantity.superclass.constructor.apply(this);this._amountInput=null;this._measureInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null;this._selectedMeasureValue="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._isMesureMenuOpened=false};BX.extend(BX.Crm.EntityEditorOrderQuantity,BX.Crm.EntityEditorField);BX.Crm.EntityEditorOrderQuantity.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorOrderQuantity.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorOrderQuantity.prototype.focus=function(){if(this._amountInput){BX.focus(this._amountInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._amountInput)}};BX.Crm.EntityEditorOrderQuantity.prototype.getValue=function(t){if(!this._model){return""}return this._model.getStringField(this.getAmountFieldName(),t!==undefined?t:"")};BX.Crm.EntityEditorOrderQuantity.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-order-quantity"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var r=this.getData();var i=BX.prop.getString(r,"amount");var n=BX.prop.getString(BX.prop.getObject(r,"measure"),"name");this._selectedMeasureValue=this._model.getStringField(BX.prop.getString(BX.prop.getObject(r,"measure"),"name",""));var o=BX.prop.getArray(BX.prop.getObject(r,"measure"),"items");var s="";if(!this._selectedMeasureValue){var a=o.length>0?o[0]:null;if(a){this._selectedMeasureValue=a["VALUE"];s=a["NAME"]}}else{s=this._editor.findOption(this._selectedMeasureValue,o)}var d=this.getAmountFieldName();var l=this._model.getField(BX.prop.getString(r,"formatted"),"");this._amountInput=null;this._measureInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:i,type:"text",value:l}});BX.bind(this._amountInput,"input",this._changeHandler);if(this._model.isFieldLocked(d)){this._amountInput.disabled=true}this._measureInput=BX.create("input",{attrs:{name:n,type:"hidden",value:this._selectedMeasureValue}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:s});BX.bind(this._selectContainer,"click",this._selectorClickHandler);this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._amountInput,this._measureInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"},children:[this._selectContainer]})]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[this._inputWrapper]})}else{this._wrapper.appendChild(this.createTitleNode(e));if(this.hasContentToDisplay()){var c=BX.prop.getString(this._schemeElement.getDataObjectParam("formattedWithCurrency",{}),"name","");this._sumElement=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-wallet"}});this._sumElement.innerHTML=this._model.getField(c,"");this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-colums-block"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-colums"},children:[this._sumElement]})]})]})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorOrderQuantity.prototype.doClearLayout=function(t){BX.PopupMenu.destroy(this._id);this._amountInput=null;this._measureInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null};BX.Crm.EntityEditorOrderQuantity.prototype.getAmountFieldName=function(){return this._schemeElement.getDataStringParam("amount","")};BX.Crm.EntityEditorOrderQuantity.prototype.getMeasureFieldName=function(){return BX.prop.getString(this._schemeElement.getDataObjectParam("measure",{}),"name","")};BX.Crm.EntityEditorOrderQuantity.prototype.onSelectorClick=function(t){this.openMeasureMenu()};BX.Crm.EntityEditorOrderQuantity.prototype.openMeasureMenu=function(){if(this._isMesureMenuOpened){return}var t=this._schemeElement.getData();var e=BX.prop.getArray(BX.prop.getObject(t,"measure"),"items");var r=0;var i=[];while(r<e.length){i.push({text:e[r]["NAME"],value:e[r]["VALUE"],onclick:BX.delegate(this.onMeasureSelect,this)});r++}BX.PopupMenu.show(this._id,this._selectContainer,i,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onMeasureMenuOpen,this),onPopupClose:BX.delegate(this.onMeasureMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorOrderQuantity.prototype.closeMeasureMenu=function(){if(!this._isMesureMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorOrderQuantity.prototype.onMeasureMenuOpen=function(){BX.addClass(this._selectContainer,"active");this._isMesureMenuOpened=true};BX.Crm.EntityEditorOrderQuantity.prototype.onMeasureMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isMesureMenuOpened=false};BX.Crm.EntityEditorOrderQuantity.prototype.onMeasureSelect=function(t,e){this.closeMeasureMenu();this._selectedMeasureValue=this._measureInput.value=e.value;this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);this.markAsChanged({fieldName:this.getMeasureFieldName(),fieldValue:this._selectedMeasureValue})};BX.Crm.EntityEditorOrderQuantity.prototype.processModelLock=function(t){var e=BX.prop.getString(t,"name","");if(this.getAmountFieldName()===e){this.refreshLayout()}};BX.Crm.EntityEditorOrderQuantity.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountInput)){throw"BX.Crm.EntityEditorOrderQuantity. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._amountInput.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._inputWrapper)}return e};BX.Crm.EntityEditorOrderQuantity.prototype.showError=function(t,e){BX.Crm.EntityEditorOrderQuantity.superclass.showError.apply(this,arguments);if(this._amountInput){BX.addClass(this._amountInput,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorOrderQuantity.prototype.clearError=function(){BX.Crm.EntityEditorOrderQuantity.superclass.clearError.apply(this);if(this._amountInput){BX.removeClass(this._amountInput,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorOrderQuantity.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit){if(this._amountInput){t[BX.prop.getString(t,"amount")]=this._amountInput.value}t[BX.prop.getString(t,"measure")]=this._selectedMeasureValue;return t}return""};BX.Crm.EntityEditorOrderQuantity.prototype.save=function(){var t=this._schemeElement.getData();this._model.setField(BX.prop.getString(BX.prop.getObject(t,"measure"),"name"),this._selectedMeasureValue);if(this._amountInput){this._model.setField(BX.prop.getString(t,"amount"),this._amountInput.value);this._model.setField(BX.prop.getString(t,"formatted"),this._amountInput.value)}};BX.Crm.EntityEditorOrderQuantity.create=function(t,e){var r=new BX.Crm.EntityEditorOrderQuantity;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderPropertyFile==="undefined"){BX.Crm.EntityEditorOrderPropertyFile=function(){BX.Crm.EntityEditorOrderPropertyFile.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorOrderPropertyFile,BX.Crm.EntityEditorCustom);BX.Crm.EntityEditorOrderPropertyFile.prototype.layout=function(t){BX.Crm.EntityEditorOrderPropertyFile.superclass.layout.apply(this,arguments);if(this._mode===BX.Crm.EntityEditorMode.edit){setTimeout(BX.delegate(function(){var t=this._innerWrapper.querySelectorAll('input[type="checkbox"]');for(var e=0;e<t.length;e++){BX.bind(t[e],"change",BX.delegate(function(){BX.onCustomEvent("CrmOrderPropertySetCustom",[this.getName()])},this))}},this),10)}};BX.Crm.EntityEditorOrderPropertyFile.create=function(t,e){var r=new BX.Crm.EntityEditorOrderPropertyFile;r.initialize(t,e);return r}}if(typeof BX.Crm.OrderModel==="undefined"){BX.Crm.OrderModel=function(){BX.Crm.OrderModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.OrderModel,BX.Crm.EntityModel);BX.Crm.OrderModel.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this))};BX.Crm.OrderModel.prototype.onEntityProgressChange=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this.getEntityTypeId()||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var r=BX.prop.getString(e,"currentStepId","");if(r!==this.getField("STATUS_ID","")){this.setField("STATUS_ID",r)}};BX.Crm.OrderModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.order};BX.Crm.OrderModel.prototype.isCaptionEditable=function(){return false};BX.Crm.OrderModel.prototype.getCaption=function(){var t=this.getField("TITLE");return BX.type.isString(t)?t:""};BX.Crm.OrderModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.OrderModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.OrderModel.create=function(t,e){var r=new BX.Crm.OrderModel;r.initialize(t,e);return r}}if(typeof BX.Crm.OrderShipmentModel==="undefined"){BX.Crm.OrderShipmentModel=function(){BX.Crm.OrderShipmentModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.OrderShipmentModel,BX.Crm.EntityModel);BX.Crm.OrderShipmentModel.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this))};BX.Crm.OrderShipmentModel.prototype.onEntityProgressChange=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this.getEntityTypeId()||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var r=BX.prop.getString(e,"currentStepId","");if(r!==this.getField("STATUS_ID","")){this.setField("STATUS_ID",r)}};BX.Crm.OrderShipmentModel.prototype.isCaptionEditable=function(){return false};BX.Crm.OrderShipmentModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.ordershipment};BX.Crm.OrderShipmentModel.prototype.getCaption=function(){return this.getField("TITLE","")};BX.Crm.OrderShipmentModel.create=function(t,e){var r=new BX.Crm.OrderShipmentModel;r.initialize(t,e);return r}}if(typeof BX.Crm.OrderPaymentModel==="undefined"){BX.Crm.OrderPaymentModel=function(){BX.Crm.OrderPaymentModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.OrderPaymentModel,BX.Crm.EntityModel);BX.Crm.OrderPaymentModel.prototype.isCaptionEditable=function(){return false};BX.Crm.OrderPaymentModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.orderpayment};BX.Crm.OrderPaymentModel.prototype.getCaption=function(){return this.getField("TITLE","")};BX.Crm.OrderPaymentModel.create=function(t,e){var r=new BX.Crm.OrderPaymentModel;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorOrderUserSelector==="undefined"){BX.Crm.EntityEditorOrderUserSelector=function(){BX.Crm.EntityEditorOrderUserSelector.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorOrderUserSelector,BX.Crm.EntityEditorUserSelector);BX.Crm.EntityEditorOrderUserSelector.prototype.initialize=function(t,e){BX.Crm.EntityEditorOrderUserSelector.superclass.initialize.call(this,t,e);this._editor=BX.prop.get(e,"editor");this._url=BX.prop.getString(e,"url");for(var r=0,i=this._editor._controllers.length;r<i;r++){if(this._editor._controllers[r]instanceof BX.Crm.EntityEditorOrderController){this._controller=this._editor._controllers[r];break}}};BX.Crm.EntityEditorOrderUserSelector.prototype.open=function(t){if(!(BX.type.isDomNode(this._editor._formElement)&&BX.type.isNotEmptyString(this._url))){BX.Crm.EntityEditorOrderUserSelector.superclass.open.call(this,t);return}window.open(this._url,"","scrollbars=yes,resizable=yes,width=840,height=500,top="+Math.floor((screen.height-840)/2-14)+",left="+Math.floor((screen.width-760)/2-5));BX.bind(this._editor._formElement[this._id],"change",BX.delegate(function(){this.onChangeUserId(this._editor._formElement[this._id].value)},this))};BX.Crm.EntityEditorOrderUserSelector.prototype.onChangeUserId=function(t){if(this._controller){this._controller.ajax("loadUserInfo",{data:{USER_ID:t,ENTITY_ID:this._editor.getEntityId()},onsuccess:BX.delegate(this.onLoadUserInfo,this)})}};BX.Crm.EntityEditorOrderUserSelector.prototype.onLoadUserInfo=function(t){if(this._controller){this._controller._isRequesting=false;this._controller.hideLoader()}if(t.ERROR){return}this.onSelect(t.USER_DATA,"users")};BX.Crm.EntityEditorOrderUserSelector.items={};BX.Crm.EntityEditorOrderUserSelector.create=function(t,e){var r=new BX.Crm.EntityEditorOrderUserSelector(t,e);r.initialize(t,e);this.items[r.getId()]=r;return r}}if(typeof BX.Crm.EntityEditorDeliverySelector==="undefined"){BX.Crm.EntityEditorDeliverySelector=function(){BX.Crm.EntityEditorDeliverySelector.superclass.constructor.apply(this);this._innerWrapper=null;this._deliverySelector=null;this._profileSelector=null;this._storeSelector=null;this._input=null;this._inputStore=null};BX.extend(BX.Crm.EntityEditorDeliverySelector,BX.Crm.EntityEditorField);BX.Crm.EntityEditorDeliverySelector.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorDeliverySelector.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorDeliverySelector.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(e));if(this._mode===BX.Crm.EntityEditorMode.edit){this._deliverySelector=BX.create("select",{events:{change:BX.proxy(function(){this.onSelectorChange("delivery")},this)}});this.setOptionsList(this._deliverySelector,this.getModel().getField("DELIVERY_SERVICES_LIST"),this.getModel().getIntegerField("DELIVERY_SELECTOR_DELIVERY_ID"));var r=this.getModel().getField("DELIVERY_PROFILES_LIST");if(BX.type.isNotEmptyObject(r)){this._profileSelector=this.createProfileSelector();this.setOptionsList(this._profileSelector,r,this.getModel().getIntegerField("DELIVERY_SELECTOR_PROFILE_ID"))}this._input=BX.create("input",{props:{type:"hidden",name:this.getName(),value:this.getValue()}});var i=this.getModel().getField("DELIVERY_STORES_LIST");if(BX.type.isNotEmptyObject(i)){this._storeSelector=this.createStoreSelector();this.setOptionsList(this._storeSelector,i,this.getModel().getIntegerField("DELIVERY_STORE_ID"));this.createInputStore()}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("span",{props:{className:"fields enumeration field-wrap"},children:[BX.create("span",{props:{className:"fields enumeration field-item"},children:[this._deliverySelector,this._input]})]})]});if(this._profileSelector!==null){this.insertProfileSelector()}if(this.getModel().getField("ERRORS")){this.processErrors(this.getModel().getField("ERRORS"))}else{this.clearError()}this._wrapper.appendChild(this._innerWrapper);if(this._storeSelector!==null){this.insertStoreSelector()}}else{var n=this.getModel().getStringField("DELIVERY_SERVICE_NAME")||this.getMessage("notSelected");this.setDeliveryServiceName(n);this._wrapper.appendChild(this._innerWrapper);if(parseInt(this.getModel().getField("DELIVERY_STORE_ID"))>0){this.setDeliveryStore()}}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorDeliverySelector.prototype.createInputStore=function(){if(this._inputStore){return}this._inputStore=BX.create("input",{props:{type:"hidden",name:"DELIVERY_STORE_ID",value:this.getModel().getIntegerField("DELIVERY_STORE_ID")}})};BX.Crm.EntityEditorDeliverySelector.prototype.getInputStore=function(){if(!this._inputStore){this.createInputStore()}return this._inputStore};BX.Crm.EntityEditorDeliverySelector.prototype.setDeliveryServiceName=function(t){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},html:t})};BX.Crm.EntityEditorDeliverySelector.prototype.setDeliveryStore=function(){this._innerWrapper.parentNode.insertBefore(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{html:this.getModel().getField("DELIVERY_STORE_TITLE")}),BX.create("div",{html:this.getModel().getField("DELIVERY_STORE_ADDRESS"),style:{fontStyle:"italic",fontSize:"12px"}})]}),this._innerWrapper.nextSibling);this._innerWrapper.parentNode.insertBefore(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},html:this.getMessage("deliveryStore")})]}),this._innerWrapper.nextSibling)};BX.Crm.EntityEditorDeliverySelector.prototype.getController=function(){for(var t=0,e=this._editor._controllers.length;t<e;t++){if(this._editor._controllers[t]instanceof BX.Crm.EntityEditorOrderShipmentController){return this._editor._controllers[t]}}return null};if(typeof BX.Crm.EntityEditorDeliverySelector.messages==="undefined"){BX.Crm.EntityEditorDeliverySelector.messages={}}BX.Crm.EntityEditorDeliverySelector.prototype.onSelectorChange=function(t){this._input.value=this.obtainValueFromSelectors(t,this._deliverySelector,this._profileSelector,this._mode);this.markAsChanged();this.getController().onChangeDelivery()};BX.Crm.EntityEditorDeliverySelector.prototype.onStoreChange=function(){this.getInputStore().value=this._storeSelector.value;this.getModel().setField("DELIVERY_STORE_ID",this._storeSelector.value);this.markAsChanged()};BX.Crm.EntityEditorDeliverySelector.prototype.setOptionsList=function(t,e,r){if(t.childNodes.length>0){for(var i=t.childNodes.length-1;i>=0;i--){t.removeChild(t.childNodes[i])}}for(i in e){if(!e.hasOwnProperty(i)){continue}if(typeof e[i].ITEMS!=="undefined"){t.appendChild(this.createOptionsGroup(e[i],r))}else{var n=parseInt(r)===parseInt(e[i].ID);var o=new Option(e[i].NAME||e[i].TITLE,e[i].ID,n,n);t.options.add(o)}}return t};BX.Crm.EntityEditorDeliverySelector.prototype.createOptionsGroup=function(t,e){var r=BX.create("optgroup",{props:{label:t.NAME}});for(var i in t.ITEMS){if(!t.ITEMS.hasOwnProperty(i)){continue}r.appendChild(BX.create("option",{props:{value:t.ITEMS[i].ID,selected:e==t.ITEMS[i].ID},html:t.ITEMS[i].NAME}))}return r};BX.Crm.EntityEditorDeliverySelector.prototype.createProfileSelector=function(){return BX.create("select",{events:{change:BX.proxy(function(){this.onSelectorChange("profile")},this)}})};BX.Crm.EntityEditorDeliverySelector.prototype.createStoreSelector=function(){return BX.create("select",{events:{change:BX.proxy(function(){this.onStoreChange()},this)}})};BX.Crm.EntityEditorDeliverySelector.prototype.insertStoreSelector=function(){if(!this._innerWrapper){return}if(!this._storeSelector){return}this._innerWrapper.appendChild(BX.create("span",{props:{className:"fields enumeration field-wrap"},style:{marginTop:"20px"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},style:{marginTop:"-16px"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("deliveryStore")})]}),BX.create("span",{props:{className:"fields enumeration field-item"},children:[this._storeSelector,this.getInputStore()]})]}),this._innerWrapper)};BX.Crm.EntityEditorDeliverySelector.prototype.insertProfileSelector=function(){if(!this._innerWrapper){return}if(!this._profileSelector){return}this._innerWrapper.appendChild(BX.create("span",{props:{className:"fields enumeration field-wrap"},style:{marginTop:"20px"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},style:{marginTop:"-16px"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("deliveryProfile")})]}),BX.create("span",{props:{className:"fields enumeration field-item"},children:[this._profileSelector]})]}),this._innerWrapper)};BX.Crm.EntityEditorDeliverySelector.prototype.removeProfileSelector=function(){if(!this._profileSelector){return}this._profileSelector.parentNode.parentNode.parentNode.removeChild(this._profileSelector.parentNode.parentNode);this._profileSelector=null};BX.Crm.EntityEditorDeliverySelector.prototype.removeStoreSelector=function(){if(!this._storeSelector){return}this._storeSelector.parentNode.parentNode.parentNode.removeChild(this._storeSelector.parentNode.parentNode);this._storeSelector=null};BX.Crm.EntityEditorDeliverySelector.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorDeliverySelector.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorDeliverySelector.prototype.doClearLayout=function(t){this._deliverySelector=null;this._profileSelector=null;this._storeSelector=null;this._innerWrapper=null;this._input=null;this._inputStore=null};BX.Crm.EntityEditorDeliverySelector.prototype.refreshLayout=function(t){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorDeliverySelector.superclass.refreshLayout.apply(this,arguments);return}if(this._mode===BX.Crm.EntityEditorMode.edit){if(!this._deliverySelector){return}this.setOptionsList(this._deliverySelector,this.getModel().getField("DELIVERY_SERVICES_LIST"),this.getModel().getField("DELIVERY_SELECTOR_DELIVERY_ID"));if(!this._profileSelector&&BX.type.isNotEmptyObject(this.getModel().getField("DELIVERY_PROFILES_LIST"))){this._profileSelector=this.createProfileSelector();this.insertProfileSelector()}else if(this._profileSelector&&!BX.type.isNotEmptyObject(this.getModel().getField("DELIVERY_PROFILES_LIST"))){this.removeProfileSelector()}if(this._profileSelector&&BX.type.isNotEmptyObject(this.getModel().getField("DELIVERY_PROFILES_LIST"))){this.setOptionsList(this._profileSelector,this.getModel().getField("DELIVERY_PROFILES_LIST"),this.getModel().getField("DELIVERY_SELECTOR_PROFILE_ID"))}if(!this._storeSelector&&BX.type.isNotEmptyObject(this.getModel().getField("DELIVERY_STORES_LIST"))){this._storeSelector=this.createStoreSelector();this.insertStoreSelector()}else if(this._storeSelector&&!BX.type.isNotEmptyObject(this.getModel().getField("DELIVERY_STORES_LIST"))){this.removeStoreSelector()}if(this._storeSelector&&BX.type.isNotEmptyObject(this.getModel().getField("DELIVERY_STORES_LIST"))){this.setOptionsList(this._storeSelector,this.getModel().getField("DELIVERY_STORES_LIST"),this.getModel().getField("DELIVERY_STORE_ID"))}if(this.getModel().getField("ERRORS")){this.processErrors(this.getModel().getField("ERRORS"))}else{this.clearError()}this._input.value=this.getValue()}else{this.setDeliveryServiceName(this.getModel().getField("DELIVERY_SERVICE_NAME"));if(parseInt(this.getModel().getField("DELIVERY_STORE_ID"))>0){this.setDeliveryStore()}}};BX.Crm.EntityEditorDeliverySelector.prototype.processErrors=function(t){this.clearError();if(t.length){var e="";for(var r=0,i=t.length-1;r<=i;r++){e+=t[r]+"<br>"}if(e){this.showError(e)}}};BX.Crm.EntityEditorDeliverySelector.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorDeliverySelector.prototype.showError=function(t,e){BX.Crm.EntityEditorDeliverySelector.superclass.showError.apply(this,arguments);if(this._innerWrapper){BX.addClass(this._innerWrapper,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorDeliverySelector.prototype.clearError=function(){BX.Crm.EntityEditorDeliverySelector.superclass.clearError.apply(this);if(this._innerWrapper){BX.removeClass(this._innerWrapper,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorDeliverySelector.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorDeliverySelector.prototype.obtainValueFromSelectors=function(t,e,r,i){var n="";if(i===BX.Crm.EntityEditorMode.edit){if(r&&t!=="delivery"){var o=r.value}if(o>0){n=o}else{var s=e.value;if(s>0){n=s}}}return n};BX.Crm.EntityEditorDeliverySelector.prototype.save=function(){if(this._input){this.getModel().setField(this.getName(),this._input.value,{originator:this})}};BX.Crm.EntityEditorDeliverySelector.create=function(t,e){var r=new BX.Crm.EntityEditorDeliverySelector;r.initialize(t,e);return r}}if(typeof BX.Crm.EntityEditorShipmentExtraServices==="undefined"){BX.Crm.EntityEditorShipmentExtraServices=function(){BX.Crm.EntityEditorDeliverySelector.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorShipmentExtraServices,BX.Crm.EntityEditorCustom);BX.Crm.EntityEditorShipmentExtraServices.prototype.getHtmlContent=function(){var t=[],e=this.isInEditMode()?"edit":"view",r=new BX.Crm.EntityEditorOrderExtraServicesWrapper({mode:e}),i=this._model.getField("EXTRA_SERVICES_DATA");if(i&&i.length){for(var n=0,o=i.length-1;n<=o;n++){r.wrapItem(i[n]).forEach(function(e,r,i){t.push(e)})}}return BX.create("div",{style:{marginLeft:"15px",width:"100%",marginTop:"20px"},children:t}).outerHTML};BX.Crm.EntityEditorShipmentExtraServices.create=function(t,e){var r=new BX.Crm.EntityEditorShipmentExtraServices;r.initialize(t,e);return r}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:88:"/bitrix/components/bitrix/crm.timeline/templates/.default/script.min.js?1544127401232538";s:6:"source";s:67:"/bitrix/components/bitrix/crm.timeline/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
if(typeof BX.CrmTimelineManager==="undefined"){BX.CrmTimelineManager=function(){this._id="";this._settings={};this._container=null;this._ownerTypeId=0;this._ownerId=0;this._ownerInfo=null;this._progressSemantics="";this._commentEditor=null;this._waitEditor=null;this._smsEditor=null;this._schedule=null;this._history=null;this._activityEditor=null;this._menuBar=null;this._readOnly=false;this._pullTagName=""};BX.CrmTimelineManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._ownerTypeId=parseInt(this.getSetting("ownerTypeId"));this._ownerId=parseInt(this.getSetting("ownerId"));this._ownerInfo=this.getSetting("ownerInfo");this._progressSemantics=BX.prop.getString(this._settings,"progressSemantics","");this._spotlightFastenShowed=this.getSetting("spotlightFastenShowed",true);var i=this.getSetting("containerId");if(!BX.type.isNotEmptyString(i)){throw"BX.CrmTimelineManager. A required parameter 'containerId' is missing."}this._container=BX(i);if(!BX.type.isElementNode(this._container)){throw"BX.CrmTimelineManager. Container node is not found."}this._editorContainer=BX(this.getSetting("editorContainer"));this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);var r=this.getSetting("activityEditorId");if(BX.type.isNotEmptyString(r)){this._activityEditor=BX.CrmActivityEditor.items[r];if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.CrmTimeline. Activity editor instance is not found."}}var n=this.getSetting("ajaxId");var s=this.getSetting("currentUrl");this._schedule=BX.CrmSchedule.create(this._id,{manager:this,container:this._container,activityEditor:this._activityEditor,itemData:this.getSetting("scheduleData"),isStubMode:this._ownerId<=0,ajaxId:n,currentUrl:s,readOnly:this._readOnly});this._fixedHistory=BX.CrmFixedHistory.create(this._id,{manager:this,container:this._container,editorContainer:this._editorContainer,activityEditor:this._activityEditor,itemData:this.getSetting("fixedData"),isStubMode:this._ownerId<=0,ajaxId:n,serviceUrl:this.getSetting("serviceUrl"),commentEditorUrl:this.getSetting("commentEditorUrl"),currentUrl:s,readOnly:this._readOnly});this._history=BX.CrmHistory.create(this._id,{manager:this,container:this._container,fixedHistory:this._fixedHistory,activityEditor:this._activityEditor,itemData:this.getSetting("historyData"),isStubMode:this._ownerId<=0,ajaxId:n,serviceUrl:this.getSetting("serviceUrl"),commentEditorUrl:this.getSetting("commentEditorUrl"),currentUrl:s,readOnly:this._readOnly});this._schedule.setHistory(this._history);this._fixedHistory.setHistory(this._history);this._fixedHistory.setItems();this._commentEditor=BX.CrmTimelineCommentEditor.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,serviceUrl:this.getSetting("serviceUrl"),commentEditorUrl:this.getSetting("commentEditorUrl"),container:this.getSetting("editorCommentContainer"),input:this.getSetting("editorCommentInput"),editorName:this.getSetting("editorCommentEditorName"),button:this.getSetting("editorCommentButton"),cancelButton:this.getSetting("editorCommentCancelButton")});this._commentEditor.setVisible(true);this._commentEditor.setHistory(this._history);if(this._readOnly){this._commentEditor.setVisible(false)}if(BX.prop.getBoolean(this._settings,"enableWait",false)){this._waitEditor=BX.CrmTimelineWaitEditor.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,serviceUrl:this.getSetting("serviceUrl"),config:this.getSetting("editorWaitConfig",{}),targetDates:this.getSetting("editorWaitTargetDates",[]),container:this.getSetting("editorWaitContainer"),configContainer:this.getSetting("editorWaitConfigContainer"),input:this.getSetting("editorWaitInput"),button:this.getSetting("editorWaitButton"),cancelButton:this.getSetting("editorWaitCancelButton")});this._waitEditor.setVisible(false)}if(BX.prop.getBoolean(this._settings,"enableSms",false)){this._smsEditor=BX.CrmTimelineSmsEditor.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,serviceUrl:this.getSetting("serviceUrl"),config:this.getSetting("editorSmsConfig",{}),container:this.getSetting("editorSmsContainer"),input:this.getSetting("editorSmsInput"),button:this.getSetting("editorSmsButton"),cancelButton:this.getSetting("editorSmsCancelButton")});this._smsEditor.setVisible(false)}if(BX.prop.getBoolean(this._settings,"enableRest",false)){this._restEditor=BX.CrmTimelineRestEditor.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,placement:BX.prop.getString(this._settings,"restPlacement","")})}this._schedule.layout();this._fixedHistory.layout();this._history.layout();this._pullTagName=BX.prop.getString(this._settings,"pullTagName","");if(this._pullTagName!==""){BX.addCustomEvent("onPullEvent-crm",BX.delegate(this.onPullEvent,this));this.extendWatch()}this._menuBar=BX.CrmTimelineMenuBar.create(this._id,{container:BX(this.getSetting("menuBarContainer")),ownerInfo:this._ownerInfo,activityEditor:this._activityEditor,commentEditor:this._commentEditor,waitEditor:this._waitEditor,smsEditor:this._smsEditor,restEditor:this._restEditor,readOnly:this._readOnly,manager:this});if(!this._readOnly){this._menuBar.setActiveItemById("comment")}BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this));BX.ready(function(){window.addEventListener("scroll",BX.throttle(function(){BX.LazyLoad.onScroll()},80))})},extendWatch:function(){if(BX.type.isFunction(BX.PULL)&&this._pullTagName!==""){BX.PULL.extendWatch(this._pullTagName);window.setTimeout(BX.delegate(this.extendWatch,this),6e4)}},onPullEvent:function(t,e){if(this._pullTagName!==BX.prop.getString(e,"TAG","")){return}if(t==="timeline_activity_add"){this.processActivityExternalAdd(e)}else if(t==="timeline_activity_update"){this.processActivityExternalUpdate(e)}else if(t==="timeline_activity_delete"){this.processActivityExternalDelete(e)}else if(t==="timeline_comment_add"){this.processCommentExternalAdd(e)}else if(t==="timeline_link_add"){this.processLinkExternalAdd(e)}else if(t==="timeline_document_add"){this.processLinkExternalAdd(e)}else if(t==="timeline_document_delete"){this.processDocumentExternalDelete(e)}else if(t==="timeline_comment_update"){this.processCommentExternalUpdate(e)}else if(t==="timeline_comment_delete"){this.processCommentExternalDelete(e)}else if(t==="timeline_changed_binding"){this.processChangeBinding(e)}else if(t==="timeline_item_change_fasten"){this.processItemChangeFasten(e)}else if(t==="timeline_item_update"){this.processItemExternalUpdate(e)}else if(t==="timeline_wait_add"){this.processWaitExternalAdd(e)}else if(t==="timeline_wait_update"){this.processWaitExternalUpdate(e)}else if(t==="timeline_wait_delete"){this.processWaitExternalDelete(e)}else if(t==="timeline_bizproc_status"){this.processBizprocStatus(e)}},processActivityExternalAdd:function(t){var e,i,r,n,s;e=BX.prop.getObject(t,"ENTITY",null);i=BX.prop.getObject(t,"SCHEDULE_ITEM",null);r=BX.prop.getObject(t,"HISTORY_ITEM",null);if(e&&r&&!BX.type.isPlainObject(r["ASSOCIATED_ENTITY"])){r["ASSOCIATED_ENTITY"]=e}if(i!==null){n=this.addScheduleItem(i);n.addWrapperClass("crm-entity-stream-section-updated",1e3)}if(r!==null){s=this.addHistoryItem(r);BX.CrmTimelineItemExpand.create(s.getWrapper(),null).run()}},processActivityExternalUpdate:function(t){var e,i,r,n,s,a;e=BX.prop.getObject(t,"ENTITY",null);i=BX.prop.getObject(t,"SCHEDULE_ITEM",null);n=BX.prop.getObject(t,"HISTORY_ITEM",null);if(e){if(n&&!BX.type.isPlainObject(n["ASSOCIATED_ENTITY"])){n["ASSOCIATED_ENTITY"]=e}var o=BX.prop.getInteger(e,"ID",0);var c=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,o);for(var m=0,l=c.length;m<l;m++){s=c[m];s.setAssociatedEntityData(e);s.refreshLayout()}var h=this._fixedHistory.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,o);for(var m=0,l=h.length;m<l;m++){a=h[m];a.setAssociatedEntityData(e);a.refreshLayout()}}if(i!==null){r=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.activity,BX.prop.getInteger(i,"ASSOCIATED_ENTITY_ID"));if(r){r.setData(i);if(!r.isDone()){this._schedule.refreshItem(r)}else{if(n){this._schedule.transferItemToHistory(r,n);n=null}else{this._schedule.deleteItem(r)}}}else if(!BX.CrmScheduleItem.isDone(i)){r=this.addScheduleItem(i);r.addWrapperClass("crm-entity-stream-section-updated",1e3)}}if(n!==null){s=this._history.findItemById(BX.prop.getString(n,"ID"));if(!s){s=this.addHistoryItem(n);BX.CrmTimelineItemExpand.create(s.getWrapper(),null).run()}else{s.setData(n);s.refreshLayout();a=this._fixedHistory.findItemById(BX.prop.getString(n,"ID"));if(a){a.setData(n);a.refreshLayout()}}}},processActivityExternalDelete:function(t){var e=BX.prop.getInteger(t,"ENTITY_ID",0);var i=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,e);for(var r=0,n=i.length;r<n;r++){this._history.deleteItem(i[r])}var s=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.activity,e);if(s){this._schedule.deleteItem(s)}},processCommentExternalAdd:function(t){var e,i;e=BX.prop.getObject(t,"HISTORY_ITEM",null);if(e!==null){window.setTimeout(BX.delegate(function(){if(!this._history.findItemById(e["ID"])){i=this.addHistoryItem(e);BX.CrmTimelineItemExpand.create(i.getWrapper(),null).run()}},this),1500)}},processLinkExternalAdd:function(t){var e,i;e=BX.prop.getObject(t,"HISTORY_ITEM",null);if(e!==null){i=this.addHistoryItem(e);BX.CrmTimelineItemExpand.create(i.getWrapper(),null).run()}},processCommentExternalUpdate:function(t){var e=BX.prop.getInteger(t,"ENTITY_ID",0);var i=BX.prop.getObject(t,"HISTORY_ITEM",null);var r=this._history.findItemById(e);if(r instanceof BX.CrmHistoryItemComment&&i!==null){r.setData(i);r.switchToViewMode()}var n=this._fixedHistory.findItemById(e);if(n instanceof BX.CrmHistoryItemComment&&i!==null){n.setData(i);n.switchToViewMode()}},processCommentExternalDelete:function(t){var e=BX.prop.getInteger(t,"ENTITY_ID",0);window.setTimeout(BX.delegate(function(){var t=this._history.findItemById(e);if(t instanceof BX.CrmHistoryItemComment)this._history.deleteItem(t);var i=this._fixedHistory.findItemById(e);if(i instanceof BX.CrmHistoryItemComment)this._fixedHistory.deleteItem(i)},this),1200)},processDocumentExternalDelete:function(t){var e=BX.prop.getInteger(t,"ENTITY_ID",0);window.setTimeout(BX.delegate(function(){var t=this._history.findItemById(e);if(t instanceof BX.CrmHistoryItemDocument)this._history.deleteItem(t);var i=this._fixedHistory.findItemById(e);if(i instanceof BX.CrmHistoryItemDocument)this._fixedHistory.deleteItem(i)},this),1200)},processChangeBinding:function(t){var e=BX.prop.getString(t,"OLD_ID",0);var i=BX.prop.getString(t,"NEW_ID",0);var r=this._history.findItemById(e);if(r instanceof BX.CrmHistoryItem){r._id=i;var n=r.getData();n.ID=i;r.setData(n)}var s=this._fixedHistory.findItemById(e);if(s instanceof BX.CrmHistoryItem){s._id=i;var a=s.getData();a.ID=i;s.setData(a)}},processItemChangeFasten:function(t){var e=BX.prop.getInteger(t,"ENTITY_ID",0);var i=BX.prop.getObject(t,"HISTORY_ITEM",null);window.setTimeout(BX.delegate(function(){var t=this._fixedHistory.findItemById(e);if(i["IS_FIXED"]==="N"&&t){t.onSuccessUnfasten()}else if(i["IS_FIXED"]==="Y"&&!t){var r=this._history.findItemById(e);if(r){r.onSuccessFasten()}else{var n=this._fixedHistory.createItem(this._data);n._isFixed=true;this._fixedHistory.addItem(n,0);n.layout()}}},this),1200)},processItemExternalUpdate:function(t){var e=BX.prop.getInteger(t,"ENTITY_ID",0);var i=BX.prop.getObject(t,"HISTORY_ITEM",null);var r=this._history.findItemById(e);if(r&&i!==null){r.setData(i);r.markAsTerminated(this._history.checkItemForTermination(r));r.refreshLayout();if(r.isTerminated()){BX.addClass(r._wrapper,"crm-entity-stream-section-last")}}},processWaitExternalAdd:function(t){var e=BX.prop.getObject(t,"SCHEDULE_ITEM",null);if(e!==null){this.addScheduleItem(e)}},processWaitExternalUpdate:function(t){var e,i,r,n,s;e=BX.prop.getObject(t,"ENTITY",null);i=BX.prop.getObject(t,"SCHEDULE_ITEM",null);n=BX.prop.getObject(t,"HISTORY_ITEM",null);if(e){if(n&&!BX.type.isPlainObject(n["ASSOCIATED_ENTITY"])){n["ASSOCIATED_ENTITY"]=e}var a=BX.prop.getInteger(e,"ID",0);var o=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.wait,a);for(var c=0,m=o.length;c<m;c++){s=o[c];s.setAssociatedEntityData(e);s.refreshLayout()}}if(i!==null){r=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.wait,BX.prop.getInteger(i,"ASSOCIATED_ENTITY_ID"));if(!r){this.addScheduleItem(i)}else{r.setData(i);if(!r.isDone()){this._schedule.refreshItem(r)}else{if(n){this._schedule.transferItemToHistory(r,n);n=null}else{this._schedule.deleteItem(r)}}}}if(n!==null){s=this._history.findItemById(BX.prop.getString(n,"ID"));if(!s){s=this.addHistoryItem(n);BX.CrmTimelineItemExpand.create(s.getWrapper(),null).run()}else{s.setData(n);s.refreshLayout()}}},processWaitExternalDelete:function(t){var e=BX.prop.getInteger(t,"ENTITY_ID",0);var i=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.wait,e);for(var r=0,n=i.length;r<n;r++){this._history.deleteItem(i[r])}var s=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.wait,e);if(s){this._schedule.deleteItem(s)}},processBizprocStatus:function(t){var e,i;e=BX.prop.getObject(t,"HISTORY_ITEM",null);if(e!==null){i=this.addHistoryItem(e);BX.CrmTimelineItemExpand.create(i.getWrapper(),null).run()}},onEntityProgressChange:function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this._ownerTypeId||BX.prop.getInteger(e,"entityId",0)!==this._ownerId){return}var i=BX.prop.getString(e,"semantics","");if(i===this._progressSemantics){return}this._progressSemantics=i;this._schedule.refreshLayout()},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getOwnerTypeId:function(){return this._ownerTypeId},getOwnerId:function(){return this._ownerId},getOwnerInfo:function(){return this._ownerInfo},isStubCounterEnabled:function(){if(this._ownerId<=0){return false}return(this._ownerTypeId===BX.CrmEntityType.enumeration.deal||this._ownerTypeId===BX.CrmEntityType.enumeration.lead)&&this._progressSemantics==="process"},getSchedule:function(){return this._schedule},getHistory:function(){return this._history},getWaitEditor:function(){return this._waitEditor},getSmsEditor:function(){return this._smsEditor},processSheduleLayoutChange:function(){},processHistoryLayoutChange:function(){this._schedule.refreshLayout()},processEditingCompletion:function(t){if(this._waitEditor&&t===this._waitEditor){this._waitEditor.setVisible(false);this._commentEditor.setVisible(true);this._menuBar.setActiveItemById("comment")}if(this._smsEditor&&t===this._smsEditor){this._smsEditor.setVisible(false);this._commentEditor.setVisible(true);this._menuBar.setActiveItemById("comment")}},processEditingCancellation:function(t){if(this._waitEditor&&t===this._waitEditor){this._waitEditor.setVisible(false);this._commentEditor.setVisible(true);this._menuBar.setActiveItemById("comment")}if(this._smsEditor&&t===this._smsEditor){this._smsEditor.setVisible(false);this._commentEditor.setVisible(true);this._menuBar.setActiveItemById("comment")}},addScheduleItem:function(t){var e=this._schedule.createItem(t);var i=this._schedule.calculateItemIndex(e);var r=this._schedule.createAnchor(i);this._schedule.addItem(e,i);e.layout({anchor:r});return e},addHistoryItem:function(t){var e=this._history.createItem(t);var i=this._history.calculateItemIndex(e);var r=this._history.createAnchor(i);this._history.addItem(e,i);e.layout({anchor:r});return e},loadMediaPlayer:function(t,e,i,r){var n=new BX.Fileman.Player(t,{sources:[{src:e,type:i}],isAudio:true,skin:"vjs-timeline_player-skin",width:350,height:30,onInit:function(t){t.vjsPlayer.controlBar.removeChild("timeDivider");t.vjsPlayer.controlBar.removeChild("durationDisplay");t.vjsPlayer.controlBar.removeChild("fullscreenToggle");t.vjsPlayer.controlBar.addChild("timeDivider");t.vjsPlayer.controlBar.addChild("durationDisplay");if(!t.isPlaying()){t.play()}}});BX.cleanNode(r,false);r.appendChild(n.createElement());n.init()},onActivityCreated:function(t,e){},isSpotlightShowed:function(){return this._spotlightFastenShowed},setSpotlightShowed:function(){this._spotlightFastenShowed=true}};BX.CrmTimelineManager.instances={};BX.CrmTimelineManager.create=function(t,e){var i=new BX.CrmTimelineManager;i.initialize(t,e);this.instances[i.getId()]=i;return i}}if(typeof BX.CrmTimeline==="undefined"){BX.CrmTimeline=function(){this._id="";this._settings={};this._container=null;this._manager=null;this._activityEditor=null;this._isStubMode=false;this._readOnly=false};BX.CrmTimeline.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX(this.getSetting("container"));if(!BX.type.isElementNode(this._container)){throw"BX.CrmTimeline. Container node is not found."}this._editorContainer=BX(this.getSetting("editorContainer"));this._manager=this.getSetting("manager");if(!(this._manager instanceof BX.CrmTimelineManager)){throw"BX.CrmTimeline. Manager instance is not found."}this._activityEditor=this.getSetting("activityEditor");this._isStubMode=this.getSetting("isStubMode",false);this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);this.doInitialize()},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},doInitialize:function(){},layout:function(){},isStubMode:function(){return this._isStubMode},isReadOnly:function(){return this._readOnly},refreshLayout:function(){},getManager:function(){return this._manager},getOwnerInfo:function(){return this._manager.getOwnerInfo()},reload:function(){var t=this.getSetting("currentUrl");var e=this.getSetting("ajaxId");if(e!==""){BX.ajax.insertToNode(BX.util.add_url_param(t,{bxajaxid:e}),"comp_"+e)}else{window.location=t}}}}if(typeof BX.CrmHistory==="undefined"){BX.CrmHistory=function(){BX.CrmHistory.superclass.constructor.apply(this);this._items=[];this._wrapper=null;this._fixedHistory=null;this._currentDaySection=null;this._lastDaySection=null;this._lastDate=null;this._anchor=null;this._year=0;this._history=this;this._enableLoading=false;this._lastLoadedItemTimestamp="";this._scrollHandler=BX.delegate(this.onWindowScroll,this);this._loadingWaiter=null;this._isRequestRunning=false};BX.extend(BX.CrmHistory,BX.CrmTimeline);BX.CrmHistory.prototype.doInitialize=function(){var t=BX.message("FORMAT_DATETIME").replace(/:SS/,"");var e=BX.message("FORMAT_DATE");var i=BX.util.trim(t.replace(e,""));this._fixedHistory=this.getSetting("fixedHistory");this._ownerTypeId=this.getSetting("ownerTypeId");this._ownerId=this.getSetting("ownerId");this._serviceUrl=this.getSetting("serviceUrl","");this._timeFormat=BX.date.convertBitrixFormat(i);this._year=(new Date).getFullYear();if(!this.isStubMode()){var r=this.getSetting("itemData");if(!BX.type.isArray(r)){r=[]}var n,s,a;for(n=0,s=r.length;n<s;n++){a=this.createItem(r[n]);this._items.push(a)}}};BX.CrmHistory.prototype.layout=function(){this._wrapper=BX.create("DIV",{});this._container.appendChild(this._wrapper);var t=BX.prop.extractDate(new Date);var e,i,r;if(!this.isStubMode()){for(e=0,i=this._items.length;e<i;e++){r=this._items[e];r.setContainer(this._wrapper);var n=r.getCreatedDate();if(this._lastDate===null||this._lastDate.getTime()!==n.getTime()){this._lastDate=n;if(t.getTime()===n.getTime()){this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection)}else{this._lastDaySection=this.createDaySection(this._lastDate);this._wrapper.appendChild(this._lastDaySection)}}r._lastDate=this._lastDate;r.layout()}i=this._items.length;if(i){this._lastLoadedItemTimestamp=this._items[i-1].getCreatedTimestamp();this._loadingWaiter=this._items[i-1].getWrapper();this._enableLoading=true;BX.bind(window,"scroll",this._scrollHandler)}this.refreshLayout()}else{this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection);this._wrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-createEntity crm-entity-stream-section-last"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:BX.message("CRM_TIMELINE_HISTORY_STUB")})]})]})]}))}this._manager.processHistoryLayoutChange()};BX.CrmHistory.prototype.refreshLayout=function(){var t=this._items.length;if(t===0){return}if(t>1){for(var e=0;e<t-1;e++){var i=this._items[e];if(i.isTerminated()){i.markAsTerminated(false)}}}this._items[t-1].markAsTerminated(true)};BX.CrmHistory.prototype.formatTime=function(t){return BX.date.format(this._timeFormat,t)};BX.CrmHistory.prototype.calculateItemIndex=function(t){return 0};BX.CrmHistory.prototype.checkItemForTermination=function(t){return this.getLastItem()===t};BX.CrmHistory.prototype.getLastItem=function(){return this._items.length>0?this._items[this._items.length-1]:null};BX.CrmHistory.prototype.getItemByIndex=function(t){return t<this._items.length?this._items[t]:null};BX.CrmHistory.prototype.getItemCount=function(){return this._items.length};BX.CrmHistory.prototype.removeItemByIndex=function(t){if(t<this._items.length){this._items.splice(t,1)}};BX.CrmHistory.prototype.getItemIndex=function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.CrmHistory.prototype.getItemsByAssociatedEntity=function(t,e){if(!BX.type.isNumber(t)){t=parseInt(t)}if(!BX.type.isNumber(e)){e=parseInt(e)}if(isNaN(t)||t<=0||isNaN(e)||e<=0){return[]}var i=[];for(var r=0,n=this._items.length;r<n;r++){var s=this._items[r];if(s.getAssociatedEntityTypeId()===t&&s.getAssociatedEntityId()===e){i.push(s)}}return i};BX.CrmHistory.prototype.findItemById=function(t){t=t.toString();for(var e=0,i=this._items.length;e<i;e++){if(this._items[e].getId()===t){return this._items[e]}}return null};BX.CrmHistory.prototype.formatDate=function(t){return BX.date.format([["today","today"],["tommorow","tommorow"],["yesterday","yesterday"],["",t.getFullYear()===this._year?"j F":"j F Y"]],t)};BX.CrmHistory.prototype.createCurrentDaySection=function(){return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-today-label"},text:this.formatDate(BX.prop.extractDate(new Date))})]})]})};BX.CrmHistory.prototype.createDaySection=function(t){return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-history-label"},text:this.formatDate(t)})]})]})};BX.CrmHistory.prototype.createAnchor=function(t){if(this._currentDaySection===null){this._currentDaySection=this.createCurrentDaySection();if(this._wrapper.firstChild){this._wrapper.insertBefore(this._currentDaySection,this._wrapper.firstChild)}else{this._wrapper.appendChild(this._currentDaySection)}}if(this._anchor===null){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-shadow"}});if(this._currentDaySection.nextSibling){this._wrapper.insertBefore(this._anchor,this._currentDaySection.nextSibling)}else{this._wrapper.appendChild(this._anchor)}}return this._anchor};BX.CrmHistory.prototype.createActivityItem=function(t){var e=BX.prop.getInteger(t,"TYPE_ID",BX.CrmTimelineType.undefined);var i=BX.prop.getInteger(t,"TYPE_CATEGORY_ID",0);if(e!==BX.CrmTimelineType.activity){return null}if(i===BX.CrmActivityType.email){return BX.CrmHistoryItemEmail.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}if(i===BX.CrmActivityType.call){return BX.CrmHistoryItemCall.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===BX.CrmActivityType.meeting){return BX.CrmHistoryItemMeeting.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===BX.CrmActivityType.task){return BX.CrmHistoryItemTask.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===BX.CrmActivityType.provider){var r=BX.prop.getString(BX.prop.getObject(t,"ASSOCIATED_ENTITY",{}),"PROVIDER_ID","");if(r==="CRM_WEBFORM"){return BX.CrmHistoryItemWebForm.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(r==="CRM_SMS"){return BX.CrmHistoryItemSms.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t,smsStatusDescriptions:this._manager.getSetting("smsStatusDescriptions",{}),smsStatusSemantics:this._manager.getSetting("smsStatusSemantics",{})})}else if(r==="CRM_REQUEST"){return BX.CrmHistoryItemActivityRequest.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(r==="IMOPENLINES_SESSION"){return BX.CrmHistoryItemOpenLine.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(r==="REST_APP"){return BX.CrmHistoryItemActivityRestApplication.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(r==="VISIT_TRACKER"){return BX.CrmHistoryItemVisit.create(t["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}}return BX.CrmHistoryItemActivity.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})};BX.CrmHistory.prototype.createItem=function(t){var e=BX.prop.getInteger(t,"TYPE_ID",BX.CrmTimelineType.undefined);var i=BX.prop.getInteger(t,"TYPE_CATEGORY_ID",0);if(e===BX.CrmTimelineType.activity){return this.createActivityItem(t)}else if(e===BX.CrmTimelineType.creation){return BX.CrmHistoryItemCreation.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmTimelineType.link){return BX.CrmHistoryItemLink.create(t["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmTimelineType.mark){return BX.CrmHistoryItemMark.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmTimelineType.comment){return BX.CrmHistoryItemComment.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,commentEditorUrl:this.getSetting("commentEditorUrl"),data:t})}else if(e===BX.CrmTimelineType.wait){return BX.CrmHistoryItemWait.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmTimelineType.document){return BX.CrmHistoryItemDocument.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmTimelineType.sender){return BX.CrmHistoryItemSender.create(t["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmTimelineType.modification){return BX.CrmHistoryItemModification.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmTimelineType.conversion){return BX.CrmHistoryItemConversion.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmTimelineType.bizproc){return BX.CrmHistoryItemBizproc.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}return BX.CrmHistoryItem.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})};BX.CrmHistory.prototype.addItem=function(t,e){if(!BX.type.isNumber(e)||e<0){e=this.calculateItemIndex(t)}if(e<this._items.length){this._items.splice(e,0,t)}else{this._items.push(t)}this.refreshLayout();this._manager.processHistoryLayoutChange()};BX.CrmHistory.prototype.deleteItem=function(t){var e=this.getItemIndex(t);if(e<0){return}t.clearLayout();this.removeItemByIndex(e);this.refreshLayout();this._manager.processHistoryLayoutChange()};BX.CrmHistory.prototype.onWindowScroll=function(t){if(!this._loadingWaiter||!this._enableLoading||this._isRequestRunning){return}var e=this._loadingWaiter.getBoundingClientRect();if(e.top<=document.documentElement.clientHeight){this.loadItems()}};BX.CrmHistory.prototype.onItemsLoad=function(t,e){var i=BX.prop.extractDate(new Date);var r=BX.prop.getArray(e,"HISTORY_ITEMS");var n,s,a;var o="";var c=0;for(n=0,s=r.length;n<s;n++){var m=BX.prop.getInteger(r[n],"ID",0);if(m<=0){continue}o=BX.prop.getString(r[n],"CREATED_SERVER","");if(this.findItemById(m)!==null){continue}a=this.createItem(r[n]);this._items.push(a);var l=a.getCreatedDate();if(this._lastDate===null||this._lastDate.getTime()!==l.getTime()){this._lastDate=l;if(i.getTime()===l.getTime()){this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection)}else{this._lastDaySection=this.createDaySection(this._lastDate);this._wrapper.appendChild(this._lastDaySection)}}a.layout();c++}if(c>0){if(o!==""){this._lastLoadedItemTimestamp=o}s=this._items.length;this._loadingWaiter=this._items[s-1].getWrapper();this.refreshLayout();this._manager.processHistoryLayoutChange()}else{this._loadingWaiter=null;this._enableLoading=false;BX.unbind(window,"scroll",this._scrollHandler)}this._isRequestRunning=false};BX.CrmHistory.prototype.loadItems=function(){this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_HISTORY_ITEMS",params:{OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId(),LAST_ITEM_TIME:this._lastLoadedItemTimestamp}}).load(BX.delegate(this.onItemsLoad,this))};BX.CrmHistory.prototype.getMessage=function(t){var e=BX.CrmHistory.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmHistory.messages==="undefined"){BX.CrmHistory.messages={}}BX.CrmHistory.instances={};BX.CrmHistory.create=function(t,e){var i=new BX.CrmHistory;i.initialize(t,e);this.instances[i.getId()]=i;return i}}if(typeof BX.CrmFixedHistory==="undefined"){BX.CrmFixedHistory=function(){BX.CrmFixedHistory.superclass.constructor.apply(this);this._items=[];this._wrapper=null;this._fixedHistory=this;this._history=this;this._isRequestRunning=false};BX.extend(BX.CrmFixedHistory,BX.CrmHistory);BX.CrmFixedHistory.prototype.doInitialize=function(){};BX.CrmFixedHistory.prototype.setHistory=function(t){this._history=t};BX.CrmFixedHistory.prototype.setItems=function(){var t=this.getSetting("itemData");if(!BX.type.isArray(t)){t=[]}var e,i,r;for(e=0,i=t.length;e<i;e++){r=this.createItem(t[e]);r._isFixed=true;this._items.push(r)}};BX.CrmFixedHistory.prototype.layout=function(){this._wrapper=BX.create("DIV",{});this.createAnchor();this._container.insertBefore(this._wrapper,this._editorContainer.nextElementSibling);for(var t=0;t<this._items.length;t++){this._items[t].setContainer(this._wrapper);this._items[t].layout()}this.refreshLayout();this._manager.processHistoryLayoutChange()};BX.CrmFixedHistory.prototype.refreshLayout=function(){};BX.CrmFixedHistory.prototype.formatDate=function(t){};BX.CrmFixedHistory.prototype.createCurrentDaySection=function(){};BX.CrmFixedHistory.prototype.createDaySection=function(t){};BX.CrmFixedHistory.prototype.createAnchor=function(t){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-fixed-anchor"}});this._wrapper.appendChild(this._anchor)};BX.CrmFixedHistory.prototype.onWindowScroll=function(t){};BX.CrmFixedHistory.prototype.onItemsLoad=function(t,e){};BX.CrmFixedHistory.prototype.loadItems=function(){this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_FIXED_HISTORY_ITEMS",params:{OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId(),LAST_ITEM_TIME:this._lastLoadedItemTimestamp}}).load(BX.delegate(this.onItemsLoad,this))};BX.CrmFixedHistory.instances={};BX.CrmFixedHistory.create=function(t,e){var i=new BX.CrmFixedHistory;i.initialize(t,e);this.instances[i.getId()]=i;return i}}if(typeof BX.CrmSchedule==="undefined"){BX.CrmSchedule=function(){BX.CrmSchedule.superclass.constructor.apply(this);this._items=[];this._history=null;this._wrapper=null;this._anchor=null;this._stub=null;this._timeFormat=""};BX.extend(BX.CrmSchedule,BX.CrmTimeline);BX.CrmSchedule.prototype.doInitialize=function(){var t=BX.message("FORMAT_DATETIME").replace(/:SS/,"");var e=BX.message("FORMAT_DATE");var i=BX.util.trim(t.replace(e,""));this._timeFormat=BX.date.convertBitrixFormat(i);if(!this.isStubMode()){var r=this.getSetting("itemData");if(!BX.type.isArray(r)){r=[]}var n,s,a;for(n=0,s=r.length;n<s;n++){a=this.createItem(r[n]);if(a){this._items.push(a)}}}};BX.CrmSchedule.prototype.layout=function(){this._wrapper=BX.create("DIV",{});this._container.appendChild(this._wrapper);var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-planned-label"},text:this.getMessage("planned")});var e="crm-entity-stream-section crm-entity-stream-section-planned-label";this._wrapper.appendChild(BX.create("DIV",{attrs:{className:e},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[t]})]}));if(this.isStubMode()){this.addStub()}else{var i=this._items.length;if(i===0){this.addStub()}else{for(var r=0;r<i;r++){var n=this._items[r];n.setContainer(this._wrapper);n.layout()}}}this.refreshLayout();this._manager.processSheduleLayoutChange()};BX.CrmSchedule.prototype.refreshLayout=function(){var t=this._items.length;var e=this._history?this._history.getItemCount():0;if(t===0){this.addStub();if(e>0||this._history.isStubMode()){BX.removeClass(this._stub,"crm-entity-stream-section-last")}else{BX.addClass(this._stub,"crm-entity-stream-section-last")}var i=this._stub.querySelector(".crm-entity-stream-section-icon");if(i){if(this._manager.isStubCounterEnabled()){BX.addClass(i,"crm-entity-stream-section-counter")}else{BX.removeClass(i,"crm-entity-stream-section-counter")}}return}var r,n;if(e>0){for(r=0;r<t;r++){n=this._items[r];if(n.isTerminated()){n.markAsTerminated(false)}}}else{if(t>1){for(r=0;r<t-1;r++){n=this._items[r];if(n.isTerminated()){n.markAsTerminated(false)}}}this._items[t-1].markAsTerminated(true)}};BX.CrmSchedule.prototype.formatDateTime=function(t){var e=new Date;return BX.date.format([["today","today, "+this._timeFormat],["tommorow","tommorow, "+this._timeFormat],["yesterday","yesterday, "+this._timeFormat],["",(t.getFullYear()===e.getFullYear()?"j F ":"j F Y ")+this._timeFormat]],t,e)};BX.CrmSchedule.prototype.checkItemForTermination=function(t){if(this._history&&this._history.getItemCount()>0){return false}return this.getLastItem()===t};BX.CrmSchedule.prototype.getLastItem=function(){return this._items.length>0?this._items[this._items.length-1]:null};BX.CrmSchedule.prototype.calculateItemIndex=function(t){var e,i;var r=t.getDeadline();if(r){for(e=0,i=this._items.length;e<i;e++){var n=this._items[e].getDeadline();if(!n||r<=n){return e}}}else{var s=t.getSourceId();for(e=0,i=this._items.length;e<i;e++){if(this._items[e].getDeadline()){continue}if(s<=this._items[e].getSourceId()){return e}}}return this._items.length};BX.CrmSchedule.prototype.getItemCount=function(){return this._items.length};BX.CrmSchedule.prototype.getItems=function(){return this._items};BX.CrmSchedule.prototype.getItemByAssociatedEntity=function(t,e){if(!BX.type.isNumber(t)){t=parseInt(t)}if(!BX.type.isNumber(e)){e=parseInt(e)}if(isNaN(t)||t<=0||isNaN(e)||e<=0){return null}for(var i=0,r=this._items.length;i<r;i++){var n=this._items[i];if(n.getAssociatedEntityTypeId()===t&&n.getAssociatedEntityId()===e){return n}}return null};BX.CrmSchedule.prototype.getItemIndex=function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.CrmSchedule.prototype.getItemByIndex=function(t){return t<this._items.length?this._items[t]:null};BX.CrmSchedule.prototype.removeItemByIndex=function(t){if(t<this._items.length){this._items.splice(t,1)}};BX.CrmSchedule.prototype.createItem=function(t){var e=BX.prop.getInteger(t,"ASSOCIATED_ENTITY_TYPE_ID",0);var i=BX.prop.getInteger(t,"ASSOCIATED_ENTITY_ID",0);var r=BX.prop.getObject(t,"ASSOCIATED_ENTITY",{});var n=BX.CrmEntityType.resolveName(e)+"_"+i.toString();if(e===BX.CrmEntityType.enumeration.wait){return BX.CrmScheduleItemWait.create(n,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else{var s=BX.prop.getInteger(r,"TYPE_ID",0);var a=BX.prop.getString(r,"PROVIDER_ID","");if(s===BX.CrmActivityType.email){return BX.CrmScheduleItemEmail.create(n,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(s===BX.CrmActivityType.call){return BX.CrmScheduleItemCall.create(n,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(s===BX.CrmActivityType.meeting){return BX.CrmScheduleItemMeeting.create(n,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(s===BX.CrmActivityType.task){return BX.CrmScheduleItemTask.create(n,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(s===BX.CrmActivityType.provider){if(a==="CRM_WEBFORM"){return BX.CrmScheduleItemWebForm.create(n,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(a==="CRM_REQUEST"){return BX.CrmScheduleItemActivityRequest.create(n,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(a==="IMOPENLINES_SESSION"){return BX.CrmScheduleItemActivityOpenLine.create(n,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(a==="REST_APP"){return BX.CrmScheduleItemActivityRestApplication.create(n,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}}}return null};BX.CrmSchedule.prototype.addItem=function(t,e){if(!BX.type.isNumber(e)||e<0){e=this.calculateItemIndex(t)}if(e<this._items.length){this._items.splice(e,0,t)}else{this._items.push(t)}this.removeStub();this.refreshLayout();this._manager.processSheduleLayoutChange()};BX.CrmSchedule.prototype.getHistory=function(){return this._history};BX.CrmSchedule.prototype.setHistory=function(t){this._history=t};BX.CrmSchedule.prototype.createAnchor=function(t){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-shadow"}});if(t>=0&&t<this._items.length){this._wrapper.insertBefore(this._anchor,this._items[t].getWrapper())}else{this._wrapper.appendChild(this._anchor)}return this._anchor};BX.CrmSchedule.prototype.deleteItem=function(t){var e=this.getItemIndex(t);if(e<0){return}t.clearLayout();this.removeItemByIndex(e);this.refreshLayout();this._manager.processSheduleLayoutChange()};BX.CrmSchedule.prototype.refreshItem=function(t){var e=this.getItemIndex(t);if(e<0){return}this.removeItemByIndex(e);var i=this.createItem(t.getData());var r=this.calculateItemIndex(i);if(r===e){this.addItem(t,r);t.refreshLayout();t.addWrapperClass("crm-entity-stream-section-updated",1e3);return}var n=this.createAnchor(r);this.addItem(i,r);i.layout({add:false});var s=BX.CrmTimelineItemAnimation.create("",{initialItem:t,finalItem:i,anchor:n});s.run()};BX.CrmSchedule.prototype.transferItemToHistory=function(t,e){var i=this.getItemIndex(t);if(i<0){return}this.removeItemByIndex(i);this.refreshLayout();this._manager.processSheduleLayoutChange();var r=this._history.createItem(e);this._history.addItem(r,0);r.layout({add:false});var n=BX.CrmTimelineItemAnimationNew.create("",{initialItem:t,finalItem:r,anchor:this._history.createAnchor(),events:{complete:BX.delegate(this.onTransferComplete,this)}});n.run()};BX.CrmSchedule.prototype.onTransferComplete=function(){if(this._items.length===0){this.addStub()}};BX.CrmSchedule.prototype.onItemMarkedAsDone=function(t,e){};BX.CrmSchedule.prototype.addStub=function(){if(!this._stub){var t="crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-notTask";var e="crm-entity-stream-section-icon crm-entity-stream-section-icon-info";var i=this.getMessage("stub");var r=this._manager.getOwnerTypeId();if(r===BX.CrmEntityType.enumeration.lead){i=this.getMessage("leadStub")}else if(r===BX.CrmEntityType.enumeration.deal){i=this.getMessage("dealStub")}if(this._manager.isStubCounterEnabled()){e+=" crm-entity-stream-section-counter"}this._stub=BX.create("DIV",{attrs:{className:t},children:[BX.create("DIV",{attrs:{className:e}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:i})]})]})]});this._wrapper.appendChild(this._stub)}if(this._history&&this._history.getItemCount()>0){BX.removeClass(this._stub,"crm-entity-stream-section-last")}else{BX.addClass(this._stub,"crm-entity-stream-section-last")}};BX.CrmSchedule.prototype.removeStub=function(){if(this._stub){this._stub=BX.remove(this._stub)}};BX.CrmSchedule.items={};BX.CrmSchedule.prototype.getMessage=function(t){var e=BX.CrmSchedule.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmSchedule.messages==="undefined"){BX.CrmSchedule.messages={}}BX.CrmSchedule.create=function(t,e){var i=new BX.CrmSchedule;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmTimelineBaseEditor==="undefined"){BX.CrmTimelineBaseEditor=function(){this._id="";this._settings={};this._manager=null;this._ownerTypeId=0;this._ownerId=0;this._container=null;this._input=null;this._saveButton=null;this._cancelButton=null;this._ghostInput=null;this._saveButtonHandler=BX.delegate(this.onSaveButtonClick,this);this._cancelButtonHandler=BX.delegate(this.onCancelButtonClick,this);this._focusHandler=BX.delegate(this.onFocus,this);this._blurHandler=BX.delegate(this.onBlur,this);this._keyupHandler=BX.delegate(this.resizeForm,this);this._isVisible=true;this._hideButtonsOnBlur=true};BX.CrmTimelineBaseEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._manager=this.getSetting("manager");if(!(this._manager instanceof BX.CrmTimelineManager)){throw"BX.CrmTimelineBaseEditor. Manager instance is not found."}this._ownerTypeId=this.getSetting("ownerTypeId",0);this._ownerId=this.getSetting("ownerId",0);this._container=BX(this.getSetting("container"));this._input=BX(this.getSetting("input"));this._saveButton=BX(this.getSetting("button"));this._cancelButton=BX(this.getSetting("cancelButton"));BX.bind(this._saveButton,"click",this._saveButtonHandler);if(this._cancelButton){BX.bind(this._cancelButton,"click",this._cancelButtonHandler)}BX.bind(this._input,"focus",this._focusHandler);BX.bind(this._input,"blur",this._blurHandler);BX.bind(this._input,"keyup",this._keyupHandler);this.doInitialize()},doInitialize:function(){},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;this._container.style.display=t?"":"none"},isVisible:function(){return this._isVisible},onFocus:function(t){BX.addClass(this._container,"focus")},onBlur:function(t){if(!this._hideButtonsOnBlur){return}if(this._input.value===""){window.setTimeout(BX.delegate(function(){BX.removeClass(this._container,"focus");this._input.style.minHeight=""},this),200)}},onSaveButtonClick:function(t){this.save()},onCancelButtonClick:function(){this.cancel();this._manager.processEditingCancellation(this)},save:function(){},cancel:function(){},release:function(){if(this._ghostInput){this._ghostInput=BX.remove(this._ghostInput)}},ensureGhostCreated:function(){if(this._ghostInput){return this._ghostInput}this._ghostInput=BX.create("div",{props:{className:"crm-entity-stream-content-new-comment-textarea-shadow"},text:this._input.value});this._ghostInput.style.width=this._input.offsetWidth+"px";document.body.appendChild(this._ghostInput);return this._ghostInput},resizeForm:function(){var t=this.ensureGhostCreated();var e=getComputedStyle(this._input);var i=parseInt(e.paddingBottom)+parseInt(e.paddingTop)+parseInt(e.borderTopWidth)+parseInt(e.borderBottomWidth)||0;t.innerHTML=this._input.value.replace(/[\r\n]{1}/g,"<br>");this._input.style.minHeight=t.scrollHeight+i+"px"}}}if(typeof BX.CrmTimelineCommentEditor==="undefined"){BX.CrmTimelineCommentEditor=function(){BX.CrmTimelineCommentEditor.superclass.constructor.apply(this);this._history=null;this._serviceUrl="";this._postForm=null;this._editor=null;this._isRequestRunning=false;this._isLocked=false};BX.extend(BX.CrmTimelineCommentEditor,BX.CrmTimelineBaseEditor);BX.CrmTimelineCommentEditor.prototype.doInitialize=function(){this._serviceUrl=this.getSetting("serviceUrl","");this._commentEditorUrl=this.getSetting("commentEditorUrl");BX.unbind(this._input,"blur",this._blurHandler);BX.unbind(this._input,"keyup",this._keyupHandler)};BX.CrmTimelineCommentEditor.prototype.loadEditor=function(){this._editorName="CrmTimeLineComment0";if(!this._commentEditorUrl||this._postForm)return;var t=BX.util.add_url_param(this._commentEditorUrl,{name:this._editorName});BX.ajax.get(t,BX.delegate(this.onLoadEditorSuccess,this))};BX.CrmTimelineCommentEditor.prototype.onLoadEditorSuccess=function(t){var e=BX.html(this._editorContainer,t);e.then(BX.delegate(function(){if(LHEPostForm){window.setTimeout(BX.delegate(function(){this._postForm=LHEPostForm.getHandler(this._editorName);this._editor=BXHtmlEditor.Get(this._editorName);BX.onCustomEvent(this._postForm.eventNode,"OnShowLHE",[true])},this),100)}},this))};BX.CrmTimelineCommentEditor.prototype.getHistory=function(){return this._history};BX.CrmTimelineCommentEditor.prototype.setHistory=function(t){this._history=t};BX.CrmTimelineCommentEditor.prototype.onFocus=function(t){this._input.style.display="none";if(this._editor&&this._postForm){this._postForm.eventNode.style.display="block";this._editor.Focus()}else{if(!BX.type.isDomNode(this._editorContainer)){this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});this._editorContainer.appendChild(BX.create("DIV",{attrs:{className:"crm-timeline-wait"}}));this._container.appendChild(this._editorContainer)}window.setTimeout(BX.delegate(function(){this.loadEditor()},this),100)}BX.addClass(this._container,"focus")};BX.CrmTimelineCommentEditor.prototype.save=function(){var t="";var e=[];if(this._postForm){t=this._postForm.oEditor.GetContent();var i=[];for(var r in this._postForm.arFiles){if(this._postForm.arFiles.hasOwnProperty(r)){var n=this._postForm.arFiles[r];i.indexOf(n)===-1?i.push(n):null}}for(var s=0,a=i.length;s<a;s++){for(var o in this._postForm.controllers[i[s]].values){if(this._postForm.controllers[i[s]].values.hasOwnProperty(o)&&e.indexOf(o)===-1){e.push(o)}}}}else{t=this._input.value}if(t===""){if(!this.emptyCommentMessage){this.emptyCommentMessage=new BX.PopupWindow("timeline_empty_new_comment_"+this._ownerId,this._saveButton,{content:BX.message("CRM_TIMELINE_EMPTY_COMMENT_MESSAGE"),darkMode:true,autoHide:true,zIndex:1200,angle:{position:"top",offset:77},closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.emptyCommentMessage.show();return}if(this._isRequestRunning||this._isLocked){return}this._isRequestRunning=this._isLocked=true;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"SAVE_COMMENT",TEXT:t,OWNER_TYPE_ID:this._ownerTypeId,OWNER_ID:this._ownerId,ATTACHMENTS:e},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)})};BX.CrmTimelineCommentEditor.prototype.cancel=function(){this._input.value="";this._input.style.minHeight="";if(BX.type.isDomNode(this._editorContainer))this._postForm.eventNode.style.display="none";this._input.style.display="block";BX.removeClass(this._container,"focus");this.release()};BX.CrmTimelineCommentEditor.prototype.onSaveSuccess=function(t){this._isRequestRunning=false;if(this._postForm){this._postForm.reinit();for(var e in this._postForm.controllers){if(this._postForm.controllers.hasOwnProperty(e)){this._postForm.controllers[e].values={}}}}this.cancel();var i=BX.prop.getObject(t,"HISTORY_ITEM");var r=this._history.createItem(i);this._history.addItem(r,0);var n=this._history.createAnchor();r.layout({anchor:n});var s=BX.CrmCommentAnimation.create(r.getWrapper(),n,BX.pos(this._input),{start:BX.delegate(this.onAnimationStart,this),complete:BX.delegate(this.onAnimationComplete,this)});s.run()};BX.CrmTimelineCommentEditor.prototype.onSaveFailure=function(){this._isRequestRunning=this._isLocked=false};BX.CrmTimelineCommentEditor.prototype.onAnimationStart=function(){this._input.value=""};BX.CrmTimelineCommentEditor.prototype.onAnimationComplete=function(){this._isLocked=false;BX.removeClass(this._container,"focus");this._input.style.minHeight="";this._manager.processEditingCompletion(this);this.release();this._history._anchor=null};BX.CrmTimelineCommentEditor.items={};BX.CrmTimelineCommentEditor.create=function(t,e){var i=new BX.CrmTimelineCommentEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmTimelineWaitType==="undefined"){BX.CrmTimelineWaitType={undefined:0,after:1,before:2,names:{after:"after",before:"before"},resolveTypeId:function(t){if(t===this.names.after){return this.after}else if(t===this.names.before){return this.before}return this.undefined}}}if(typeof BX.CrmTimelineWaitHelper==="undefined"){BX.CrmTimelineWaitHelper={getDurationText:function(t,e){e=!!e;var i="D";if(e){var r="";if(t%7===0){t=t/7;i="W"}}if(i==="W"){r=BX.CrmMessageHelper.getCurrent().getNumberDeclension(t,this.getMessage("weekNominative"),this.getMessage("weekGenitiveSingular"),this.getMessage("weekGenitivePlural"))}else{r=BX.CrmMessageHelper.getCurrent().getNumberDeclension(t,this.getMessage("dayNominative"),this.getMessage("dayGenitiveSingular"),this.getMessage("dayGenitivePlural"))}if(e){r=t.toString()+" "+r}return r},getMessage:function(t){return this.messages.hasOwnProperty(t)?this.messages[t]:t}};if(typeof BX.CrmTimelineWaitHelper.messages==="undefined"){BX.CrmTimelineWaitHelper.messages={}}}if(typeof BX.CrmTimelineWaitEditor==="undefined"){BX.CrmTimelineWaitEditor=function(){BX.CrmTimelineWaitEditor.superclass.constructor.apply(this);this._serviceUrl="";this._isRequestRunning=false;this._isLocked=false;this._hideButtonsOnBlur=false;this._type=BX.CrmTimelineWaitType.after;this._duration=1;this._target="";this._configContainer=null;this._configSelector=null;this._isMenuShown=false;this._menu=null;this._configDialog=null};BX.extend(BX.CrmTimelineWaitEditor,BX.CrmTimelineBaseEditor);BX.CrmTimelineWaitEditor.prototype.doInitialize=function(){this._configContainer=BX(this.getSetting("configContainer"));this._serviceUrl=this.getSetting("serviceUrl","");var t=BX.prop.getObject(this._settings,"config",{});this._type=BX.CrmTimelineWaitType.resolveTypeId(BX.prop.getString(t,"type",BX.CrmTimelineWaitType.names.after));this._duration=BX.prop.getInteger(t,"duration",1);this._target=BX.prop.getString(t,"target","");this._targetDates=BX.prop.getArray(this._settings,"targetDates",[]);this.layoutConfigurationSummary()};BX.CrmTimelineWaitEditor.prototype.getDurationText=function(t,e){return BX.CrmTimelineWaitHelper.getDurationText(t,e)};BX.CrmTimelineWaitEditor.prototype.getTargetDateCaption=function(t){for(var e=0,i=this._targetDates.length;e<i;e++){var r=this._targetDates[e];if(r["name"]===t){return r["caption"]}}return""};BX.CrmTimelineWaitEditor.prototype.onSelectorClick=function(t){if(!this._isMenuShown){this.openMenu()}else{this.closeMenu()}t.preventDefault?t.preventDefault():t.returnValue=false};BX.CrmTimelineWaitEditor.prototype.openMenu=function(){if(this._isMenuShown){return}var t=BX.delegate(this.onMenuItemClick,this);var e=[{id:"day_1",text:this.getMessage("oneDay"),onclick:t},{id:"day_2",text:this.getMessage("twoDays"),onclick:t},{id:"day_3",text:this.getMessage("threeDays"),onclick:t},{id:"week_1",text:this.getMessage("oneWeek"),onclick:t},{id:"week_2",text:this.getMessage("twoWeek"),onclick:t},{id:"week_3",text:this.getMessage("threeWeeks"),onclick:t}];var i={id:"custom",text:this.getMessage("custom"),items:[]};i["items"].push({id:"afterDays",text:this.getMessage("afterDays"),onclick:t});if(this._targetDates.length>0){i["items"].push({id:"beforeDate",text:this.getMessage("beforeDate"),onclick:t})}e.push(i);BX.PopupMenu.show(this._id,this._configSelector,e,{offsetTop:0,offsetLeft:36,angle:{position:"top",offset:0},events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu=BX.PopupMenu.currentItem};BX.CrmTimelineWaitEditor.prototype.closeMenu=function(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}};BX.CrmTimelineWaitEditor.prototype.onMenuItemClick=function(t,e){this.closeMenu();if(e.id==="afterDays"||e.id==="beforeDate"){this.openConfigDialog(e.id==="afterDays"?BX.CrmTimelineWaitType.after:BX.CrmTimelineWaitType.before);return}var i={type:BX.CrmTimelineWaitType.after};if(e.id==="day_1"){i["duration"]=1}else if(e.id==="day_2"){i["duration"]=2}else if(e.id==="day_3"){i["duration"]=3}if(e.id==="week_1"){i["duration"]=7}else if(e.id==="week_2"){i["duration"]=14}else if(e.id==="week_3"){i["duration"]=21}this.saveConfiguration(i)};BX.CrmTimelineWaitEditor.prototype.openConfigDialog=function(t){if(!this._configDialog){this._configDialog=BX.CrmTimelineWaitConfigurationDialog.create("",{targetDates:this._targetDates,onSave:BX.delegate(this.onConfigDialogSave,this),onCancel:BX.delegate(this.onConfigDialogCancel,this)})}this._configDialog.setType(t);this._configDialog.setDuration(this._duration);var e=this._target;if(e===""&&this._targetDates.length>0){e=this._targetDates[0]["name"]}this._configDialog.setTarget(e);this._configDialog.open()};BX.CrmTimelineWaitEditor.prototype.onConfigDialogSave=function(t,e){this.saveConfiguration(e);this._configDialog.close()};BX.CrmTimelineWaitEditor.prototype.onConfigDialogCancel=function(t){this._configDialog.close()};BX.CrmTimelineWaitEditor.prototype.onMenuShow=function(){this._isMenuShown=true};BX.CrmTimelineWaitEditor.prototype.onMenuClose=function(){if(this._menu&&this._menu.popupWindow){this._menu.popupWindow.destroy()}};BX.CrmTimelineWaitEditor.prototype.onMenuDestroy=function(){this._isMenuShown=false;this._menu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}};BX.CrmTimelineWaitEditor.prototype.saveConfiguration=function(t){this._type=BX.prop.getInteger(t,"type",BX.CrmTimelineWaitType.after);this._duration=BX.prop.getInteger(t,"duration",0);if(this._duration<=0){this._duration=1}this._target=this._type===BX.CrmTimelineWaitType.before?BX.prop.getString(t,"target",""):"";var e=this._manager.getId().toLowerCase();BX.userOptions.save("crm.timeline.wait",e,"type",this._type===BX.CrmTimelineWaitType.after?"after":"before");BX.userOptions.save("crm.timeline.wait",e,"duration",this._duration);BX.userOptions.save("crm.timeline.wait",e,"target",this._target);this.layoutConfigurationSummary()};BX.CrmTimelineWaitEditor.prototype.getSummaryHtml=function(){if(this._type===BX.CrmTimelineWaitType.before){return this.getMessage("completionTypeBefore").replace("#DURATION#",this.getDurationText(this._duration,true)).replace("#TARGET_DATE#",this.getTargetDateCaption(this._target))}return this.getMessage("completionTypeAfter").replace("#DURATION#",this.getDurationText(this._duration,true))};BX.CrmTimelineWaitEditor.prototype.getSummaryText=function(){return BX.util.strip_tags(this.getSummaryHtml())};BX.CrmTimelineWaitEditor.prototype.layoutConfigurationSummary=function(){this._configContainer.innerHTML=this.getSummaryHtml();this._configSelector=this._configContainer.querySelector("a");if(this._configSelector){BX.bind(this._configSelector,"click",BX.delegate(this.onSelectorClick,this))}};BX.CrmTimelineWaitEditor.prototype.postpone=function(t,e,i){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"POSTPONE_WAIT",DATA:{ID:t,OFFSET:e}},onsuccess:i})};BX.CrmTimelineWaitEditor.prototype.complete=function(t,e,i){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"COMPLETE_WAIT",DATA:{ID:t,COMPLETED:e?"Y":"N"}},onsuccess:i})};BX.CrmTimelineWaitEditor.prototype.save=function(){if(this._isRequestRunning||this._isLocked){return}var t=this.getSummaryText();var e=BX.util.trim(this._input.value);if(e!==""){t+="\n"+e}var i={ID:0,typeId:this._type,duration:this._duration,targetFieldName:this._target,subject:"",description:t,completed:0,ownerType:BX.CrmEntityType.resolveName(this._ownerTypeId),ownerID:this._ownerId};BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"SAVE_WAIT",DATA:i},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)});this._isRequestRunning=this._isLocked=true};BX.CrmTimelineWaitEditor.prototype.cancel=function(){this._input.value="";this._input.style.minHeight="";this.release()};BX.CrmTimelineWaitEditor.prototype.onSaveSuccess=function(t){this._isRequestRunning=this._isLocked=false;var e=BX.prop.getString(t,"ERROR","");if(e!==""){alert(e);return}this._input.value="";this._input.style.minHeight="";this._manager.processEditingCompletion(this);this.release()};BX.CrmTimelineWaitEditor.prototype.onSaveFailure=function(){this._isRequestRunning=this._isLocked=false};BX.CrmTimelineWaitEditor.prototype.getMessage=function(t){var e=BX.CrmTimelineWaitEditor.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmTimelineWaitEditor.messages==="undefined"){BX.CrmTimelineWaitEditor.messages={}}BX.CrmTimelineWaitEditor.items={};BX.CrmTimelineWaitEditor.create=function(t,e){var i=new BX.CrmTimelineWaitEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmTimelineSmsEditor==="undefined"){BX.CrmTimelineSmsEditor=function(){BX.CrmTimelineSmsEditor.superclass.constructor.apply(this);this._history=null;this._serviceUrl="";this._isRequestRunning=false;this._isLocked=false;this._senderId=null;this._from=null;this._commEntityTypeId=null;this._commEntityId=null;this._to=null;this._canUse=null;this._canSendMessage=null;this._manageUrl="";this._senders=[];this._fromList=[];this._toList=[];this._defaults={};this._communications=[];this._menu=null;this._isMenuShown=false;this._shownMenuId=null};BX.extend(BX.CrmTimelineSmsEditor,BX.CrmTimelineBaseEditor);BX.CrmTimelineSmsEditor.prototype.doInitialize=function(){this._serviceUrl=BX.util.remove_url_param(this.getSetting("serviceUrl",""),["sessid","site"]);var t=BX.prop.getObject(this._settings,"config",{});this._canUse=BX.prop.getBoolean(t,"canUse",false);this._canSendMessage=BX.prop.getBoolean(t,"canSendMessage",false);this._manageUrl=BX.prop.getString(t,"manageUrl","");this._senders=BX.prop.getArray(t,"senders",[]);this._defaults=BX.prop.getObject(t,"defaults",{senderId:null,from:null});this._communications=BX.prop.getArray(t,"communications",[]);this._senderSelectorNode=this._container.querySelector('[data-role="sender-selector"]');this._fromContainerNode=this._container.querySelector('[data-role="from-container"]');this._fromSelectorNode=this._container.querySelector('[data-role="from-selector"]');this._clientContainerNode=this._container.querySelector('[data-role="client-container"]');this._clientSelectorNode=this._container.querySelector('[data-role="client-selector"]');this._toSelectorNode=this._container.querySelector('[data-role="to-selector"]');this._messageLengthCounterNode=this._container.querySelector('[data-role="message-length-counter"]');if(this._canUse&&this._canSendMessage){this.initSenderSelector();this.initFromSelector();this.initClientContainer();this.initClientSelector();this.initToSelector();this.initMessageLengthCounter()}};BX.CrmTimelineSmsEditor.prototype.initSenderSelector=function(){var t=this._defaults.senderId;var e=this._senders[0].canUse?this._senders[0]:null;var i=null;var r=[];var n=this.onSenderSelectorClick.bind(this);for(var s=0;s<this._senders.length;++s){if(this._senders[s].canUse&&this._senders[s].fromList.length&&(this._senders[s].id===t||!e)){e=this._senders[s]}if(this._senders[s].id==="rest"){i=this._senders[s];continue}r.push({text:this._senders[s].name,sender:this._senders[s],onclick:n,className:!this._senders[s].canUse||!this._senders[s].fromList.length?"crm-timeline-popup-menu-item-disabled menu-popup-no-icon":""})}if(i){if(i.fromList.length>0){r.push({delimiter:true});for(s=0;s<i.fromList.length;++s){r.push({text:i.fromList[s].name,sender:i,from:i.fromList[s],onclick:n})}}r.push({delimiter:true},{text:BX.message("CRM_TIMELINE_SMS_REST_MARKETPLACE"),href:"/marketplace/category/crm_robot_sms/",target:"_blank"})}if(e){this.setSender(e)}BX.bind(this._senderSelectorNode,"click",this.openMenu.bind(this,"sender",this._senderSelectorNode,r))};BX.CrmTimelineSmsEditor.prototype.onSenderSelectorClick=function(t,e){if(e.sender){if(!e.sender.canUse||!e.sender.fromList.length){window.open(e.sender.manageUrl);return}this.setSender(e.sender,true);var i=e.from?e.from:e.sender.fromList[0];this.setFrom(i,true)}this._menu.close()};BX.CrmTimelineSmsEditor.prototype.setSender=function(t,e){this._senderId=t.id;this._fromList=t.fromList;this._senderSelectorNode.textContent=t.shortName?t.shortName:t.name;var i=t.id==="rest"?"hide":"show";BX[i](this._fromContainerNode);if(e){BX.userOptions.save("crm","sms_manager_editor","senderId",this._senderId)}};BX.CrmTimelineSmsEditor.prototype.initFromSelector=function(){if(this._fromList.length>0){var t=this._defaults.from||this._fromList[0].id;var e=null;for(var i=0;i<this._fromList.length;++i){if(this._fromList[i].id===t||!e){e=this._fromList[i]}}if(e){this.setFrom(e)}}BX.bind(this._fromSelectorNode,"click",this.onFromSelectorClick.bind(this))};BX.CrmTimelineSmsEditor.prototype.onFromSelectorClick=function(t){var e=[];var i=this.onFromSelectorItemClick.bind(this);for(var r=0;r<this._fromList.length;++r){e.push({text:this._fromList[r].name,from:this._fromList[r],onclick:i})}this.openMenu("from_"+this._senderId,this._fromSelectorNode,e,t)};BX.CrmTimelineSmsEditor.prototype.onFromSelectorItemClick=function(t,e){if(e.from){this.setFrom(e.from,true)}this._menu.close()};BX.CrmTimelineSmsEditor.prototype.setFrom=function(t,e){this._from=t.id;if(this._senderId==="rest"){this._senderSelectorNode.textContent=t.name}else{this._fromSelectorNode.textContent=t.name}if(e){BX.userOptions.save("crm","sms_manager_editor","from",this._from)}};BX.CrmTimelineSmsEditor.prototype.initClientContainer=function(){if(this._communications.length===0){BX.hide(this._clientContainerNode)}};BX.CrmTimelineSmsEditor.prototype.initClientSelector=function(){var t=[];var e=this.onClientSelectorClick.bind(this);for(var i=0;i<this._communications.length;++i){t.push({text:this._communications[i].caption,client:this._communications[i],onclick:e});if(i===0){this.setClient(this._communications[i])}}BX.bind(this._clientSelectorNode,"click",this.openMenu.bind(this,"comm",this._clientSelectorNode,t))};BX.CrmTimelineSmsEditor.prototype.onClientSelectorClick=function(t,e){if(e.client){this.setClient(e.client)}this._menu.close()};BX.CrmTimelineSmsEditor.prototype.setClient=function(t){this._commEntityTypeId=t.entityTypeId;this._commEntityId=t.entityId;this._clientSelectorNode.textContent=t.caption;this._toList=t.phones;this.setTo(t.phones[0])};BX.CrmTimelineSmsEditor.prototype.initToSelector=function(){BX.bind(this._toSelectorNode,"click",this.onToSelectorClick.bind(this))};BX.CrmTimelineSmsEditor.prototype.onToSelectorClick=function(t){var e=[];var i=this.onToSelectorItemClick.bind(this);for(var r=0;r<this._toList.length;++r){e.push({text:this._toList[r].valueFormatted||this._toList[r].value,to:this._toList[r],onclick:i})}this.openMenu("to_"+this._commEntityTypeId+"_"+this._commEntityId,this._toSelectorNode,e,t)};BX.CrmTimelineSmsEditor.prototype.onToSelectorItemClick=function(t,e){if(e.to){this.setTo(e.to)}this._menu.close()};BX.CrmTimelineSmsEditor.prototype.setTo=function(t){this._to=t.value;this._toSelectorNode.textContent=t.valueFormatted||t.value};BX.CrmTimelineSmsEditor.prototype.openMenu=function(t,e,i,r){if(this._shownMenuId===t){return}if(this._shownMenuId!==null&&this._menu){this._menu.close();this._shownMenuId=null}BX.PopupMenu.show(this._id+t,e,i,{offsetTop:0,offsetLeft:36,angle:{position:"top",offset:0},events:{onPopupClose:BX.delegate(this.onMenuClose,this)}});this._menu=BX.PopupMenu.currentItem;r.preventDefault()};BX.CrmTimelineSmsEditor.prototype.onMenuClose=function(){this._shownMenuId=null;this._menu=null};BX.CrmTimelineSmsEditor.prototype.initMessageLengthCounter=function(){this._messageLengthMax=parseInt(this._messageLengthCounterNode.getAttribute("data-length-max"));BX.bind(this._input,"keyup",this.setMessageLengthCounter.bind(this))};BX.CrmTimelineSmsEditor.prototype.setMessageLengthCounter=function(){var t=this._input.value.length;this._messageLengthCounterNode.textContent=t;var e=t>=this._messageLengthMax?"addClass":"removeClass";BX[e](this._messageLengthCounterNode,"crm-entity-stream-content-sms-symbol-counter-number-overhead")};BX.CrmTimelineSmsEditor.prototype.save=function(){var t=this._input.value;if(t===""){return}if(!this._communications.length){alert(BX.message("CRM_TIMELINE_SMS_ERROR_NO_COMMUNICATIONS"));return}if(this._isRequestRunning||this._isLocked){return}this._isRequestRunning=this._isLocked=true;BX.ajax({url:BX.util.add_url_param(this._serviceUrl,{action:"save_sms_message",sender:this._senderId}),method:"POST",dataType:"json",data:{site:BX.message("SITE_ID"),sessid:BX.bitrix_sessid(),ACTION:"SAVE_SMS_MESSAGE",SENDER_ID:this._senderId,MESSAGE_FROM:this._from,MESSAGE_TO:this._to,MESSAGE_BODY:t,OWNER_TYPE_ID:this._ownerTypeId,OWNER_ID:this._ownerId,TO_ENTITY_TYPE_ID:this._commEntityTypeId,TO_ENTITY_ID:this._commEntityId},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)})};BX.CrmTimelineSmsEditor.prototype.cancel=function(){this._input.value="";this.setMessageLengthCounter();this._input.style.minHeight="";this.release()};BX.CrmTimelineSmsEditor.prototype.onSaveSuccess=function(t){this._isRequestRunning=this._isLocked=false;var e=BX.prop.getString(t,"ERROR","");if(e!==""){alert(e);return}this._input.value="";this.setMessageLengthCounter();this._input.style.minHeight="";this._manager.processEditingCompletion(this);this.release()};BX.CrmTimelineSmsEditor.prototype.onSaveFailure=function(){this._isRequestRunning=this._isLocked=false};BX.CrmTimelineSmsEditor.items={};BX.CrmTimelineSmsEditor.create=function(t,e){var i=new BX.CrmTimelineSmsEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmTimelineRestEditor==="undefined"){BX.CrmTimelineRestEditor=function(){BX.CrmTimelineRestEditor.superclass.constructor.apply(this);this._interfaceInitialized=false};BX.extend(BX.CrmTimelineRestEditor,BX.CrmTimelineBaseEditor);BX.CrmTimelineRestEditor.prototype.action=function(t){if(!this._interfaceInitialized){this._interfaceInitialized=true;this.initializeInterface()}if(t==="activity_rest_applist"){BX.rest.Marketplace.open({PLACEMENT:this.getSetting("placement","")});top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",BX.proxy(this.fireUpdateEvent,this))}else{var e=t.replace("activity_rest_","");var i=e.split("_");BX.rest.AppLayout.openApplication(i[0],{ID:this._ownerId},{PLACEMENT:this.getSetting("placement",""),PLACEMENT_ID:i[1]})}};BX.CrmTimelineRestEditor.prototype.initializeInterface=function(){if(!!top.BX.rest&&!!top.BX.rest.AppLayout){var t=this._manager._ownerTypeId,e=this._manager._ownerId;var i=top.BX.rest.AppLayout.initializePlacement(this.getSetting("placement",""));i.prototype.reloadData=function(i,r){BX.Crm.EntityEvent.fireUpdate(t,e,"");r()}}};BX.CrmTimelineRestEditor.prototype.fireUpdateEvent=function(){var t=this._manager._ownerTypeId,e=this._manager._ownerId;setTimeout(function(){console.log("fireUpdate",e,t);BX.Crm.EntityEvent.fire(BX.Crm.EntityEvent.names.invalidate,t,e,"")},3e3)};BX.CrmTimelineRestEditor.items={};BX.CrmTimelineRestEditor.create=function(t,e){var i=new BX.CrmTimelineRestEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmTimelineWaitConfigurationDialog==="undefined"){BX.CrmTimelineWaitConfigurationDialog=function(){this._id="";this._settings={};this._type=BX.CrmTimelineWaitType.undefined;this._duration=0;this._target="";this._targetDates=null;this._container=null;this._durationMeasureNode=null;this._durationInput=null;this._targetDateNode=null;this._popup=null};BX.CrmTimelineWaitConfigurationDialog.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._type=BX.prop.getInteger(this._settings,"type",BX.CrmTimelineWaitType.after);this._duration=BX.prop.getInteger(this._settings,"duration",1);this._target=BX.prop.getString(this._settings,"target","");this._targetDates=BX.prop.getArray(this._settings,"targetDates",[]);this._menuId=this._id+"_target_date_sel"},getId:function(){return this._id},getType:function(){return this._type},setType:function(t){this._type=t},getDuration:function(){return this._duration},setDuration:function(t){this._duration=t},getTarget:function(){return this._target},setTarget:function(t){this._target=t},getMessage:function(t){var e=BX.CrmTimelineWaitConfigurationDialog.messages;return e.hasOwnProperty(t)?e[t]:t},getDurationText:function(t,e){return BX.CrmTimelineWaitHelper.getDurationText(t,e)},getTargetDateCaption:function(t){for(var e=0,i=this._targetDates.length;e<i;e++){var r=this._targetDates[e];if(r["name"]===t){return r["caption"]}}return""},open:function(){this._popup=new BX.PopupWindow(this._id,this._configSelector,{autoHide:true,draggable:false,bindOptions:{forceBindPosition:false},closeByEsc:true,zIndex:0,content:this.prepareDialogContent(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},buttons:[new BX.PopupWindowButton({text:this.getMessage("select"),className:"popup-window-button-accept",events:{click:BX.delegate(this.onSaveButtonClick,this)}}),new BX.PopupWindowButtonLink({text:BX.message("JS_CORE_WINDOW_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}})]});this._popup.show()},close:function(){if(this._popup){this._popup.close()}},prepareDialogContent:function(){var t=BX.create("div",{attrs:{className:"crm-wait-popup-select-block"}});var e=BX.create("div",{attrs:{className:"crm-wait-popup-select-wrapper"}});t.appendChild(e);this._durationInput=BX.create("input",{attrs:{type:"text",className:"crm-wait-popup-settings-input",value:this._duration},events:{keyup:BX.delegate(this.onDurationChange,this)}});this._durationMeasureNode=BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:this.getDurationText(this._duration,false)});if(this._type===BX.CrmTimelineWaitType.after){e.appendChild(BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:this.getMessage("prefixTypeAfter")}));e.appendChild(this._durationInput);e.appendChild(this._durationMeasureNode)}else{e.appendChild(BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:this.getMessage("prefixTypeBefore")}));e.appendChild(this._durationInput);e.appendChild(this._durationMeasureNode);e.appendChild(BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:" "+this.getMessage("targetPrefixTypeBefore")}));this._targetDateNode=BX.create("span",{attrs:{className:"crm-automation-popup-settings-link"},text:this.getTargetDateCaption(this._target),events:{click:BX.delegate(this.toggleTargetMenu,this)}});e.appendChild(this._targetDateNode)}return t},onDurationChange:function(){var t=parseInt(this._durationInput.value);if(isNaN(t)||t<=0){t=1}this._duration=t;this._durationMeasureNode.innerHTML=BX.util.htmlspecialchars(this.getDurationText(t,false))},toggleTargetMenu:function(){if(this.isTargetMenuOpened()){this.closeTargetMenu()}else{this.openTargetMenu()}},isTargetMenuOpened:function(){return!!BX.PopupMenu.getMenuById(this._menuId)},openTargetMenu:function(){var t=[];for(var e=0,i=this._targetDates.length;e<i;e++){var r=this._targetDates[e];t.push({text:r["caption"],title:r["caption"],value:r["name"],onclick:BX.delegate(this.onTargetSelect,this)})}BX.PopupMenu.show(this._menuId,this._targetDateNode,t,{zIndex:200,autoHide:true,offsetLeft:BX.pos(this._targetDateNode)["width"]/2,angle:{position:"top",offset:0}})},closeTargetMenu:function(){BX.PopupMenu.destroy(this._menuId)},onPopupShow:function(t,e){},onPopupClose:function(){if(this._popup){this._popup.destroy()}this.closeTargetMenu()},onPopupDestroy:function(){if(this._popup){this._popup=null}},onSaveButtonClick:function(t){var e=BX.prop.getFunction(this._settings,"onSave",null);if(!e){return}var i={type:this._type};i["duration"]=this._duration;i["target"]=this._type===BX.CrmTimelineWaitType.before?this._target:"";e(this,i)},onCancelButtonClick:function(t){var e=BX.prop.getFunction(this._settings,"onCancel",null);if(e){e(this)}},onTargetSelect:function(t,e){var i=BX.prop.getString(e,"value","");if(i!==""){this._target=i;this._targetDateNode.innerHTML=BX.util.htmlspecialchars(this.getTargetDateCaption(i))}this.closeTargetMenu();t.preventDefault?t.preventDefault():t.returnValue=false}};if(typeof BX.CrmTimelineWaitConfigurationDialog.messages==="undefined"){BX.CrmTimelineWaitConfigurationDialog.messages={}}BX.CrmTimelineWaitConfigurationDialog.create=function(t,e){var i=new BX.CrmTimelineWaitConfigurationDialog;i.initialize(t,e);return i}}if(typeof BX.CrmTimelineType==="undefined"){BX.CrmTimelineType={undefined:0,activity:1,creation:2,modification:3,link:4,mark:6,comment:7,wait:8,bizproc:9,conversion:10,sender:11,document:12}}if(typeof BX.CrmTimelineAction==="undefined"){BX.CrmTimelineAction=function(){this._id="";this._settings={};this._container=null};BX.CrmTimelineAction.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"BX.CrmTimelineAction: Could not find container."}this.doInitialize()},doInitialize:function(){},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},layout:function(){this.doLayout()},doLayout:function(){}}}if(typeof BX.CrmTimelineActivityAction==="undefined"){BX.CrmTimelineActivityAction=function(){BX.CrmTimelineActivityAction.superclass.constructor.apply(this);this._activityEditor=null;this._entityData=null;this._item=null;this._isEnabled=true};BX.extend(BX.CrmTimelineActivityAction,BX.CrmTimelineAction);BX.CrmTimelineActivityAction.prototype.doInitialize=function(){this._entityData=this.getSetting("entityData");if(!BX.type.isPlainObject(this._entityData)){throw"BX.CrmTimelineActivityAction. A required parameter 'entityData' is missing."}this._activityEditor=this.getSetting("activityEditor");if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.CrmTimelineActivityAction. A required parameter 'activityEditor' is missing."}this._item=this.getSetting("item");this._isEnabled=this.getSetting("enabled",true)};BX.CrmTimelineActivityAction.prototype.getActivityId=function(){return BX.prop.getInteger(this._entityData,"ID",0)};BX.CrmTimelineActivityAction.prototype.loadActivityCommunications=function(t){this._activityEditor.getActivityCommunications(this.getActivityId(),function(e){if(BX.type.isFunction(t)){t(e)}},true)};BX.CrmTimelineActivityAction.prototype.getItemData=function(){return this._item?this._item.getData():null}}if(typeof BX.CrmTimelineEmailAction==="undefined"){BX.CrmTimelineEmailAction=function(){BX.CrmTimelineEmailAction.superclass.constructor.apply(this);this._clickHandler=BX.delegate(this.onClick,this);this._saveHandler=BX.delegate(this.onSave,this)};BX.extend(BX.CrmTimelineEmailAction,BX.CrmTimelineActivityAction);BX.CrmTimelineEmailAction.prototype.onClick=function(t){var e={ownerType:BX.CrmEntityType.resolveName(BX.prop.getInteger(this._entityData,"OWNER_TYPE_ID",0)),ownerID:BX.prop.getInteger(this._entityData,"OWNER_ID",0),ownerUrl:BX.prop.getString(this._entityData,"OWNER_URL",""),ownerTitle:BX.prop.getString(this._entityData,"OWNER_TITLE",""),originalMessageID:BX.prop.getInteger(this._entityData,"ID",0),messageType:"RE"};if(BX.CrmActivityProvider&&top.BX.Bitrix24&&top.BX.Bitrix24.Slider){var i=this._activityEditor.addEmail(e);i.addOnSave(this._saveHandler)}else{this.loadActivityCommunications(BX.delegate(function(t){e["communications"]=BX.type.isArray(t)?t:[];e["communicationsLoaded"]=true;BX.CrmActivityEmail.prepareReply(e);var i=this._activityEditor.addEmail(e);i.addOnSave(this._saveHandler)},this))}return BX.PreventDefault(t)};BX.CrmTimelineEmailAction.prototype.onSave=function(t,e){if(BX.type.isFunction(this._item.onActivityCreate)){this._item.onActivityCreate(t,e)}}}if(typeof BX.CrmTimelineCallAction==="undefined"){BX.CrmTimelineCallAction=function(){BX.CrmTimelineCallAction.superclass.constructor.apply(this);this._clickHandler=BX.delegate(this.onClick,this);this._menu=null;this._isMenuShown=false;this._menuItems=null};BX.extend(BX.CrmTimelineCallAction,BX.CrmTimelineActivityAction);BX.CrmTimelineCallAction.prototype.getButton=function(){return null};BX.CrmTimelineCallAction.prototype.onClick=function(t){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("telephonyNotSupported"));return}var e="";var i=this.getItemData();var r=BX.prop.getArray(i,"PHONE",[]);if(r.length===1){this.addCall(r[0]["VALUE"])}else if(r.length>1){this.showMenu()}else{var n=BX.prop.getObject(this._entityData,"COMMUNICATION",null);if(n){if(BX.prop.getString(n,"TYPE")==="PHONE"){e=BX.prop.getString(n,"VALUE");if(e){this.addCall(e)}}}}return BX.PreventDefault(t)};BX.CrmTimelineCallAction.prototype.showMenu=function(){if(this._isMenuShown){return}this.prepareMenuItems();if(!this._menuItems||this._menuItems.length===0){return}this._menu=new BX.PopupMenuWindow(this._id,this._container,this._menuItems,{offsetTop:0,offsetLeft:16,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu.popupWindow.show()};BX.CrmTimelineCallAction.prototype.closeMenu=function(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}};BX.CrmTimelineCallAction.prototype.prepareMenuItems=function(){if(this._menuItems){return}var t=this.getItemData();var e=BX.prop.getArray(t,"PHONE",[]);var i=BX.delegate(this.onMenuItemClick,this);this._menuItems=[];if(e.length===0){return}for(var r=0,n=e.length;r<n;r++){var s=BX.prop.getString(e[r],"VALUE");var a=BX.prop.getString(e[r],"VALUE_FORMATTED");var o=BX.prop.getString(e[r],"COMPLEX_NAME");var c=(o?o+": ":"")+(a?a:s);if(s!==""){this._menuItems.push({id:s,text:c,onclick:i})}}};BX.CrmTimelineCallAction.prototype.onMenuItemClick=function(t,e){this.closeMenu();this.addCall(e.id)};BX.CrmTimelineCallAction.prototype.onMenuShow=function(){this._isMenuShown=true};BX.CrmTimelineCallAction.prototype.onMenuClose=function(){this._isMenuShown=false;this._menu.popupWindow.destroy()};BX.CrmTimelineCallAction.prototype.onMenuDestroy=function(){this._menu=null};BX.CrmTimelineCallAction.prototype.addCall=function(t){var e=BX.prop.getObject(this._entityData,"COMMUNICATION",null);var i=parseInt(BX.prop.getString(e,"ENTITY_TYPE_ID","0"));if(isNaN(i)){i=0}var r=parseInt(BX.prop.getString(e,"ENTITY_ID","0"));if(isNaN(r)){r=0}var n=0;var s=0;var a=BX.prop.getObject(this._settings,"ownerInfo");if(a){n=BX.prop.getInteger(a,"ENTITY_TYPE_ID",0);s=BX.prop.getInteger(a,"ENTITY_ID",0)}if(n<=0||s<=0){n=BX.prop.getInteger(this._entityData,"OWNER_TYPE_ID",0);s=BX.prop.getInteger(this._entityData,"OWNER_ID","0")}if(n<=0||s<=0){n=i;s=r}var o=parseInt(BX.prop.getString(this._entityData,"ID","0"));if(isNaN(o)){o=0}var c={ENTITY_TYPE_NAME:BX.CrmEntityType.resolveName(i),ENTITY_ID:r,AUTO_FOLD:true};if(n!==i||s!==r){c["BINDINGS"]=[{OWNER_TYPE_NAME:BX.CrmEntityType.resolveName(n),OWNER_ID:s}]}if(o>0){c["SRC_ACTIVITY_ID"]=o}window.top["BXIM"].phoneTo(t,c)};BX.CrmTimelineCallAction.prototype.getMessage=function(t){var e=BX.CrmTimelineCallAction.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmTimelineCallAction.messages==="undefined"){BX.CrmTimelineCallAction.messages={}}}if(typeof BX.CrmTimelineOpenLineAction==="undefined"){BX.CrmTimelineOpenLineAction=function(){BX.CrmTimelineOpenLineAction.superclass.constructor.apply(this);this._clickHandler=BX.delegate(this.onClick,this);this._button=null};BX.extend(BX.CrmTimelineOpenLineAction,BX.CrmTimelineActivityAction);BX.CrmTimelineOpenLineAction.prototype.getButton=function(){return this._button};BX.CrmTimelineOpenLineAction.prototype.onClick=function(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}var t="";var e=BX.prop.getObject(this._entityData,"COMMUNICATION",null);if(e){if(BX.prop.getString(e,"TYPE")==="IM"){t=BX.prop.getString(e,"VALUE")}}if(t!==""){window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}};BX.CrmTimelineOpenLineAction.prototype.doLayout=function(){this._button=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}});this._container.appendChild(this._button)};BX.CrmTimelineOpenLineAction.prototype.getMessage=function(t){var e=BX.CrmTimelineOpenLineAction.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmTimelineOpenLineAction.messages==="undefined"){BX.CrmTimelineOpenLineAction.messages={}}}if(typeof BX.CrmHistoryEmailAction==="undefined"){BX.CrmHistoryEmailAction=function(){BX.CrmHistoryEmailAction.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryEmailAction,BX.CrmTimelineEmailAction);BX.CrmHistoryEmailAction.prototype.doLayout=function(){this._container.appendChild(BX.create("A",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))};BX.CrmHistoryEmailAction.create=function(t,e){var i=new BX.CrmHistoryEmailAction;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryCallAction==="undefined"){BX.CrmHistoryCallAction=function(){BX.CrmHistoryCallAction.superclass.constructor.apply(this);this._button=null};BX.extend(BX.CrmHistoryCallAction,BX.CrmTimelineCallAction);BX.CrmHistoryCallAction.prototype.getButton=function(){return this._button};BX.CrmHistoryCallAction.prototype.doLayout=function(){this._button=BX.create("A",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}});this._container.appendChild(this._button)};BX.CrmHistoryCallAction.create=function(t,e){var i=new BX.CrmHistoryCallAction;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryOpenLineAction==="undefined"){BX.CrmHistoryOpenLineAction=function(){BX.CrmHistoryOpenLineAction.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryOpenLineAction,BX.CrmTimelineOpenLineAction);BX.CrmHistoryOpenLineAction.create=function(t,e){var i=new BX.CrmHistoryOpenLineAction;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleEmailAction==="undefined"){BX.CrmScheduleEmailAction=function(){BX.CrmScheduleEmailAction.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleEmailAction,BX.CrmTimelineEmailAction);BX.CrmScheduleEmailAction.prototype.doLayout=function(){this._container.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))};BX.CrmScheduleEmailAction.create=function(t,e){var i=new BX.CrmScheduleEmailAction;i.initialize(t,e);return i}}if(typeof BX.CrmSchedulePostponeController==="undefined"){BX.CrmSchedulePostponeController=function(){this._item=null};BX.CrmSchedulePostponeController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._item=BX.prop.get(this._settings,"item",null)},getTitle:function(){return this.getMessage("title")},getCommandList:function(){return[{name:"postpone_hour_1",title:this.getMessage("forOneHour")},{name:"postpone_hour_2",title:this.getMessage("forTwoHours")},{name:"postpone_hour_3",title:this.getMessage("forThreeHours")},{name:"postpone_day_1",title:this.getMessage("forOneDay")},{name:"postpone_day_2",title:this.getMessage("forTwoDays")},{name:"postpone_day_3",title:this.getMessage("forThreeDays")}]},processCommand:function(t){if(t.indexOf("postpone")!==0){return false}var e=0;if(t==="postpone_hour_1"){e=3600}else if(t==="postpone_hour_2"){e=7200}else if(t==="postpone_hour_3"){e=10800}else if(t==="postpone_day_1"){e=86400}else if(t==="postpone_day_2"){e=172800}else if(t==="postpone_day_3"){e=259200}if(e>0&&this._item){this._item.postpone(e)}return true},getMessage:function(t){var e=BX.CrmSchedulePostponeController.messages;return e.hasOwnProperty(t)?e[t]:t}};if(typeof BX.CrmSchedulePostponeController.messages==="undefined"){BX.CrmSchedulePostponeController.messages={}}BX.CrmSchedulePostponeController.create=function(t,e){var i=new BX.CrmSchedulePostponeController;i.initialize(t,e);return i}}if(typeof BX.CrmSchedulePostponeAction==="undefined"){BX.CrmSchedulePostponeAction=function(){BX.CrmSchedulePostponeAction.superclass.constructor.apply(this);this._button=null;this._clickHandler=BX.delegate(this.onClick,this);this._isMenuShown=false;this._menu=false};BX.extend(BX.CrmSchedulePostponeAction,BX.CrmTimelineActivityAction);BX.CrmSchedulePostponeAction.prototype.doLayout=function(){this._button=BX.create("DIV",{attrs:{className:this._isEnabled?"crm-entity-stream-planned-action-aside":"crm-entity-stream-planned-action-aside-disabled"},text:this.getMessage("postpone")});if(this._isEnabled){BX.bind(this._button,"click",this._clickHandler)}this._container.appendChild(this._button)};BX.CrmSchedulePostponeAction.prototype.openMenu=function(){if(this._isMenuShown){return}var t=BX.delegate(this.onMenuItemClick,this);var e=[{id:"hour_1",text:this.getMessage("forOneHour"),onclick:t},{id:"hour_2",text:this.getMessage("forTwoHours"),onclick:t},{id:"hour_3",text:this.getMessage("forThreeHours"),onclick:t},{id:"day_1",text:this.getMessage("forOneDay"),onclick:t},{id:"day_2",text:this.getMessage("forTwoDays"),onclick:t},{id:"day_3",text:this.getMessage("forThreeDays"),onclick:t}];BX.PopupMenu.show(this._id,this._button,e,{offsetTop:0,offsetLeft:16,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu=BX.PopupMenu.currentItem};BX.CrmSchedulePostponeAction.prototype.closeMenu=function(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}};BX.CrmSchedulePostponeAction.prototype.onClick=function(){if(!this._isEnabled){return}if(this._isMenuShown){this.closeMenu()}else{this.openMenu()}};BX.CrmSchedulePostponeAction.prototype.onMenuItemClick=function(t,e){this.closeMenu();var i=0;if(e.id==="hour_1"){i=3600}else if(e.id==="hour_2"){i=7200}else if(e.id==="hour_3"){i=10800}else if(e.id==="day_1"){i=86400}else if(e.id==="day_2"){i=172800}else if(e.id==="day_3"){i=259200}if(i>0&&this._item){this._item.postpone(i)}};BX.CrmSchedulePostponeAction.prototype.onMenuShow=function(){this._isMenuShown=true};BX.CrmSchedulePostponeAction.prototype.onMenuClose=function(){if(this._menu&&this._menu.popupWindow){this._menu.popupWindow.destroy()}};BX.CrmSchedulePostponeAction.prototype.onMenuDestroy=function(){this._isMenuShown=false;this._menu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}};BX.CrmSchedulePostponeAction.prototype.getMessage=function(t){var e=BX.CrmSchedulePostponeAction.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmSchedulePostponeAction.messages==="undefined"){BX.CrmSchedulePostponeAction.messages={}}BX.CrmSchedulePostponeAction.create=function(t,e){var i=new BX.CrmSchedulePostponeAction;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleCallAction==="undefined"){BX.CrmScheduleCallAction=function(){BX.CrmScheduleCallAction.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleCallAction,BX.CrmTimelineCallAction);BX.CrmScheduleCallAction.prototype.doLayout=function(){this._container.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))};BX.CrmScheduleCallAction.create=function(t,e){var i=new BX.CrmScheduleCallAction;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleOpenLineAction==="undefined"){BX.CrmScheduleOpenLineAction=function(){BX.CrmScheduleOpenLineAction.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleOpenLineAction,BX.CrmTimelineOpenLineAction);BX.CrmScheduleOpenLineAction.create=function(t,e){var i=new BX.CrmScheduleOpenLineAction;i.initialize(t,e);return i}}if(typeof BX.CrmTimelineItem==="undefined"){BX.CrmTimelineItem=function(){this._id="";this._settings={};this._data={};this._container=null;this._wrapper=null;this._typeCategoryId=null;this._associatedEntityData=null;this._associatedEntityTypeId=null;this._associatedEntityId=null;this._isContextMenuShown=false;this._contextMenuButton=null;this._activityEditor=null;this._actions=[];this._actionContainer=null;this._isTerminated=false};BX.CrmTimelineItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=this.getSetting("container");if(!BX.type.isPlainObject(e["data"])){throw"BX.CrmTimelineItem. A required parameter 'data' is missing."}this._data=e["data"];this._activityEditor=this.getSetting("activityEditor");this.doInitialize()},doInitialize:function(){},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getData:function(){return this._data},setData:function(t){if(BX.type.isPlainObject(t)){this._data=t;this.clearCachedData()}},getAssociatedEntityData:function(){if(this._associatedEntityData===null){this._associatedEntityData=BX.type.isPlainObject(this._data["ASSOCIATED_ENTITY"])?this._data["ASSOCIATED_ENTITY"]:{}}return this._associatedEntityData},getAssociatedEntityTypeId:function(){if(this._associatedEntityTypeId===null){this._associatedEntityTypeId=BX.prop.getInteger(this._data,"ASSOCIATED_ENTITY_TYPE_ID",0)}return this._associatedEntityTypeId},getAssociatedEntityId:function(){if(this._associatedEntityId===null){this._associatedEntityId=BX.prop.getInteger(this._data,"ASSOCIATED_ENTITY_ID",0)}return this._associatedEntityId},setAssociatedEntityData:function(t){if(!BX.type.isPlainObject(t)){t={}}this._data["ASSOCIATED_ENTITY"]=t;this.clearCachedData()},getTextDataParam:function(t){return BX.prop.getString(this._data,t,"")},getObjectDataParam:function(t){return BX.prop.getObject(this._data,t,{})},getArrayDataParam:function(t){return BX.prop.getArray(this._data,t,[])},getTypeId:function(){return BX.CrmTimelineType.undefined},getTypeCategoryId:function(){if(this._typeCategoryId===null){this._typeCategoryId=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0)}return this._typeCategoryId},getContainer:function(){return this._container},setContainer:function(t){this._container=BX.type.isElementNode(t)?t:null},getWrapper:function(){return this._wrapper},addWrapperClass:function(t,e){if(!this._wrapper){return}BX.addClass(this._wrapper,t);if(BX.type.isNumber(e)&&e>=0){window.setTimeout(BX.delegate(function(){this.removeWrapperClass(t)},this),e)}},removeWrapperClass:function(t,e){if(!this._wrapper){return}BX.removeClass(this._wrapper,t);if(BX.type.isNumber(e)&&e>=0){window.setTimeout(BX.delegate(function(){this.addWrapperClass(t)},this),e)}},layout:function(t){if(!BX.type.isElementNode(this._container)){throw"BX.CrmTimelineItem. Container is not assigned."}this.prepareLayout(t);this.prepareActions();var e=this._actions.length;for(var i=0;i<e;i++){this._actions[i].layout()}this.showActions(e>0)},prepareLayout:function(t){},prepareActions:function(){},showActions:function(t){},clearLayout:function(){this._wrapper=BX.remove(this._wrapper)},refreshLayout:function(){var t=this._wrapper.previousSibling;this._wrapper=BX.remove(this._wrapper);this.layout({anchor:t})},clearCachedData:function(){this._typeCategoryId=null;this._associatedEntityData=null;this._associatedEntityTypeId=null;this._associatedEntityId=null},isDone:function(){return false},markAsDone:function(t){},isTerminated:function(){return this._isTerminated},markAsTerminated:function(t){t=!!t;if(this._isTerminated===t){return}this._isTerminated=t;if(!this._wrapper){return}if(t){BX.addClass(this._wrapper,"crm-entity-stream-section-last")}else{BX.removeClass(this._wrapper,"crm-entity-stream-section-last")}},view:function(){},edit:function(){},fasten:function(){},unfasten:function(){},remove:function(){},cutOffText:function(t,e){if(!BX.type.isNumber(e)){e=0}if(e<=0||t.length<=e){return t}var i=e-1;var r=t.substring(i).search(/\s/i);if(r>0){i+=r}return t.substring(0,i)},prepareCutOffElements:function(t,e,i){if(!BX.type.isNumber(e)){e=0}if(e<=0||t.length<=e){return[BX.util.htmlspecialchars(t)]}var r=e-1;var n=t.substring(r).search(/\s/i);if(n>0){r+=n}return[BX.util.htmlspecialchars(t.substring(0,r))+"&hellip;&nbsp;",BX.create("A",{attrs:{className:"crm-entity-stream-content-letter-more",href:"#"},events:{click:i},text:this.getMessage("details")})]},prepareAuthorLayout:function(){var t=this.getObjectDataParam("AUTHOR",null);if(!t){return null}var e=BX.prop.getString(t,"SHOW_URL","");if(e===""){return null}var i=BX.create("A",{attrs:{className:"crm-entity-stream-content-detail-employee",href:e,target:"_blank",title:BX.prop.getString(t,"FORMATTED_NAME","")}});var r=BX.prop.getString(t,"IMAGE_URL","");if(r!==""){i.style.backgroundImage="url('"+r+"')";i.style.backgroundSize="21px"}return i},onActivityCreate:function(t,e){}};BX.CrmTimelineItem.userTimezoneOffset=null;BX.CrmTimelineItem.getUserTimezoneOffset=function(){if(!this.userTimezoneOffset){this.userTimezoneOffset=parseInt(BX.message("USER_TZ_OFFSET"));if(isNaN(this.userTimezoneOffset)){this.userTimezoneOffset=0}}return this.userTimezoneOffset};BX.CrmTimelineItem.prototype.isContextMenuEnabled=function(){return false};BX.CrmTimelineItem.prototype.prepareContextMenuButton=function(){this._contextMenuButton=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-context-menu"},events:{click:BX.delegate(this.onContextMenuButtonClick,this)}});return this._contextMenuButton};BX.CrmTimelineItem.prototype.onContextMenuButtonClick=function(t){if(!this._isContextMenuShown){this.openContextMenu()}else{this.closeContextMenu()}};BX.CrmTimelineItem.prototype.openContextMenu=function(){var t=this.prepareContextMenuItems();if(t.length===0){return}BX.PopupMenu.show(this._id,this._contextMenuButton,t,{offsetTop:0,offsetLeft:16,angle:{position:"top",offset:0},events:{onPopupShow:BX.delegate(this.onContextMenuShow,this),onPopupClose:BX.delegate(this.onContextMenuClose,this),onPopupDestroy:BX.delegate(this.onContextMenuDestroy,this)}});this._contextMenu=BX.PopupMenu.currentItem};BX.CrmTimelineItem.prototype.closeContextMenu=function(){if(this._contextMenu){this._contextMenu.close()}};BX.CrmTimelineItem.prototype.prepareContextMenuItems=function(){return[]};BX.CrmTimelineItem.prototype.onContextMenuShow=function(){this._isContextMenuShown=true;BX.addClass(this._contextMenuButton,"active")};BX.CrmTimelineItem.prototype.onContextMenuClose=function(){if(this._contextMenu){this._contextMenu.popupWindow.destroy()}};BX.CrmTimelineItem.prototype.onContextMenuDestroy=function(){this._isContextMenuShown=false;BX.removeClass(this._contextMenuButton,"active");this._contextMenu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}};BX.CrmTimelineItem.prototype.getMessage=function(t){var e=BX.CrmTimelineItem.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmTimelineItem.messages==="undefined"){BX.CrmTimelineItem.messages={}}}if(typeof BX.Crm.TimelineEditorMode==="undefined"){BX.Crm.TimelineEditorMode={view:1,edit:2}}if(typeof BX.CrmHistoryItem==="undefined"){BX.CrmHistoryItem=function(){BX.CrmHistoryItem.superclass.constructor.apply(this);this._history=null;this._fixedHistory=null;this._typeId=null;this._createdTime=null;this._isFixed=false;this._headerClickHandler=BX.delegate(this.onHeaderClick,this)};BX.extend(BX.CrmHistoryItem,BX.CrmTimelineItem);BX.CrmHistoryItem.prototype.doInitialize=function(){this._history=this.getSetting("history");this._fixedHistory=this.getSetting("fixedHistory")};BX.CrmHistoryItem.prototype.getTypeId=function(){if(this._typeId===null){this._typeId=BX.prop.getInteger(this._data,"TYPE_ID",BX.CrmTimelineType.undefined)}return this._typeId};BX.CrmHistoryItem.prototype.getTitle=function(){return""};BX.CrmHistoryItem.prototype.isContextMenuEnabled=function(){return!this.isReadOnly()};BX.CrmHistoryItem.prototype.getCreatedTimestamp=function(){return this.getTextDataParam("CREATED_SERVER")};BX.CrmHistoryItem.prototype.getCreatedTime=function(){if(this._createdTime===null){var t=BX.parseDate(this.getCreatedTimestamp(),false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");this._createdTime=new Date(t.getTime()+1e3*BX.CrmTimelineItem.getUserTimezoneOffset())}return this._createdTime};BX.CrmHistoryItem.prototype.getCreatedDate=function(){return BX.prop.extractDate(new Date(this.getCreatedTime().getTime()))};BX.CrmHistoryItem.prototype.getOwnerInfo=function(){return this._history?this._history.getOwnerInfo():null};BX.CrmHistoryItem.prototype.getOwnerTypeId=function(){return BX.prop.getInteger(this.getOwnerInfo(),"ENTITY_TYPE_ID",BX.CrmEntityType.enumeration.undefined)};BX.CrmHistoryItem.prototype.getOwnerId=function(){return BX.prop.getInteger(this.getOwnerInfo(),"ENTITY_ID",0)};BX.CrmHistoryItem.prototype.isReadOnly=function(){return this._history.isReadOnly()};BX.CrmHistoryItem.prototype.isDone=function(){var t=this.getTypeId();if(t===BX.CrmTimelineType.activity){var e=this.getAssociatedEntityData();return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(e,"STATUS",0))}return false};BX.CrmHistoryItem.prototype.isFixed=function(){return this._isFixed};BX.CrmHistoryItem.prototype.fasten=function(t){if(this._fixedHistory._items.length>=3){if(!this.fastenLimitPopup){this.fastenLimitPopup=new BX.PopupWindow("timeline_fasten_limit_popup_"+this._id,this._switcher,{content:BX.message("CRM_TIMELINE_FASTEN_LIMIT_MESSAGE"),darkMode:true,autoHide:true,zIndex:1200,angle:true,closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.fastenLimitPopup.show();this.closeContextMenu();return}BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"CHANGE_FASTEN_ITEM",VALUE:"Y",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this._id},onsuccess:BX.delegate(this.onSuccessFasten,this)});this.closeContextMenu()};BX.CrmHistoryItem.prototype.onSuccessFasten=function(t){if(BX.type.isNotEmptyString(t.ERROR))return;if(!this.isFixed()){this._data.IS_FIXED="Y";var e=this._fixedHistory.createItem(this._data);e._isFixed=true;this._fixedHistory.addItem(e,0);e.layout({add:false});this.refreshLayout();var i=BX.CrmTimelineItemFasten.create("",{initialItem:this,finalItem:e,anchor:this._fixedHistory._anchor});i.run()}this.closeContextMenu()};BX.CrmHistoryItem.prototype.onFinishFasten=function(t){};BX.CrmHistoryItem.prototype.unfasten=function(t){BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"CHANGE_FASTEN_ITEM",VALUE:"N",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this._id},onsuccess:BX.delegate(this.onSuccessUnfasten,this)});this.closeContextMenu()};BX.CrmHistoryItem.prototype.onSuccessUnfasten=function(t){if(BX.type.isNotEmptyString(t.ERROR))return;var e=null;var i=null;if(this.isFixed()){e=this;i=this._history.findItemById(this._id)}else{e=this._fixedHistory.findItemById(this._id);i=this}if(e){var r=this._fixedHistory.getItemIndex(e);e.clearAnimate();this._fixedHistory.removeItemByIndex(r);if(i){i._data.IS_FIXED="N";i.refreshLayout();BX.LazyLoad.showImages()}}};BX.CrmHistoryItem.prototype.clearAnimate=function(){if(!BX.type.isDomNode(this._wrapper))return;var t=BX.pos(this._wrapper);var e=new BX.easing({duration:1e3,start:{height:t.height,opacity:1,marginBottom:15},finish:{height:0,opacity:0,marginBottom:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy(function(t){this._wrapper.style.height=t.height+"px";this._wrapper.style.opacity=t.opacity;this._wrapper.style.marginBottom=t.marginBottom},this),complete:BX.proxy(function(){this.clearLayout()},this)});e.animate()};BX.CrmHistoryItem.prototype.getWrapperClassName=function(){return""};BX.CrmHistoryItem.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"};BX.CrmHistoryItem.prototype.prepareContentDetails=function(){return[]};BX.CrmHistoryItem.prototype.prepareContent=function(){var t=this.getWrapperClassName();if(t!==""){t="crm-entity-stream-section crm-entity-stream-section-history"+" "+t}else{t="crm-entity-stream-section crm-entity-stream-section-history"}var e=BX.create("DIV",{attrs:{className:t}});e.appendChild(BX.create("DIV",{attrs:{className:this.getIconClassName()}}));var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})]});i.appendChild(r);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:this.prepareContentDetails()}));var n=this.prepareAuthorLayout();if(n){i.appendChild(n)}return e};BX.CrmHistoryItem.prototype.prepareLayout=function(t){this._wrapper=this.prepareContent();if(this._wrapper){var e=BX.type.isPlainObject(t)?BX.prop.getBoolean(t,"add",true):true;if(e){var i=BX.type.isPlainObject(t)&&BX.type.isElementNode(t["anchor"])?t["anchor"]:null;if(i&&i.nextSibling){this._container.insertBefore(this._wrapper,i.nextSibling)}else{this._container.appendChild(this._wrapper)}}this.markAsTerminated(this._history.checkItemForTermination(this))}};BX.CrmHistoryItem.prototype.onHeaderClick=function(t){this.view();t.preventDefault?t.preventDefault():t.returnValue=false};BX.CrmHistoryItem.prototype.prepareTitleLayout=function(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTitle()})};BX.CrmHistoryItem.prototype.prepareFixedSwitcherLayout=function(){var t=this.getTextDataParam("IS_FIXED")==="Y";this._switcher=BX.create("span",{attrs:{className:"crm-entity-stream-section-top-fixed-btn"},events:{click:t?BX.delegate(this.unfasten,this):BX.delegate(this.fasten,this)}});if(t)BX.addClass(this._switcher,"crm-entity-stream-section-top-fixed-btn-active");if(!this.isReadOnly()&&!t){var e=this._history.getManager();if(!e.isSpotlightShowed()){e.setSpotlightShowed();BX.addClass(this._switcher,"crm-entity-stream-section-top-fixed-btn-spotlight");var i=new BX.SpotLight({targetElement:this._switcher,targetVertex:"middle-center",lightMode:false,id:"CRM_TIMELINE_FASTEN_SWITCHER",zIndex:1e3,top:-3,left:-1,autoSave:true,content:BX.message("CRM_TIMELINE_SPOTLIGHT_FASTEN_MESSAGE")});i.show()}}return this._switcher};BX.CrmHistoryItem.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return t};BX.CrmHistoryItem.prototype.onActivityCreate=function(t,e){this._history.getManager().onActivityCreated(t,e)};BX.CrmHistoryItem.prototype.formatTime=function(t){return this._history.formatTime(t)};BX.CrmHistoryItem.create=function(t,e){var i=new BX.CrmHistoryItem;i.initialize(t,e);return i};BX.CrmHistoryItem.isCounterEnabled=function(t){if(!BX.type.isDate(t)){return false}var e=new Date;e.setHours(0);e.setMinutes(0);e.setSeconds(0);e.setMilliseconds(0);e=e.getTime();var i=new Date;i.setHours(23);i.setMinutes(59);i.setSeconds(59);i.setMilliseconds(999);i=i.getTime();var r=t.getTime();return r<e||r>=e&&r<=i}}if(typeof BX.CrmHistoryItemActivity==="undefined"){BX.CrmHistoryItemActivity=function(){BX.CrmHistoryItemActivity.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemActivity,BX.CrmHistoryItem);BX.CrmHistoryItemActivity.prototype.doInitialize=function(){BX.CrmHistoryItemActivity.superclass.doInitialize.apply(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.CrmHistoryItemActivity. The field 'activityEditor' is not assigned."}};BX.CrmHistoryItemActivity.prototype.getTitle=function(){return BX.prop.getString(this.getAssociatedEntityData(),"SUBJECT","")};BX.CrmHistoryItemActivity.prototype.getTypeDescription=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getInteger(t,"DIRECTION",0);var i=this.getTypeCategoryId();if(i===BX.CrmActivityType.email){return this.getMessage(e===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")}else if(i===BX.CrmActivityType.call){return this.getMessage(e===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")}else if(i===BX.CrmActivityType.meeting){return this.getMessage("meeting")}else if(i===BX.CrmActivityType.task){return this.getMessage("task")}else if(i===BX.CrmActivityType.provider){var r=BX.prop.getString(t,"PROVIDER_ID","");if(r==="CRM_WEBFORM"){return this.getMessage("webform")}else if(r==="CRM_SMS"){return this.getMessage("sms")}else if(r==="CRM_REQUEST"){return this.getMessage("activityRequest")}else if(r==="IMOPENLINES_SESSION"){return this.getMessage("openLine")}else if(r==="REST_APP"){return this.getMessage("restApplication")}else if(r==="VISIT_TRACKER"){return this.getMessage("visit")}}return""};BX.CrmHistoryItemActivity.prototype.prepareTitleLayout=function(){return BX.create("A",{attrs:{href:"#",className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTypeDescription()})};BX.CrmHistoryItemActivity.prototype.prepareTimeLayout=function(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})};BX.CrmHistoryItemActivity.prototype.prepareMarkLayout=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getInteger(t,"MARK_TYPE_ID",0);if(e<=0){return null}var i="";if(e===2){i="SuccessMark"}else if(e===3){i="RenewMark"}if(i===""){return null}var r="";var n=this.getTypeCategoryId();if(n===BX.CrmActivityType.email){r=this.getMessage("email"+i)}else if(n===BX.CrmActivityType.call){r=this.getMessage("call"+i)}else if(n===BX.CrmActivityType.meeting){r=this.getMessage("meeting"+i)}else if(n===BX.CrmActivityType.task){r=this.getMessage("task"+i)}if(r===""){return null}return BX.create("SPAN",{props:{className:"crm-entity-stream-content-event-skipped"},text:r})};BX.CrmHistoryItemActivity.prototype.prepareActions=function(){if(this.isReadOnly()){return}var t=this.getTypeCategoryId();if(t===BX.CrmActivityType.email){this._actions.push(BX.CrmHistoryEmailAction.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))}};BX.CrmHistoryItemActivity.prototype.prepareContextMenuItems=function(){if(this._isMenuShown){return}var t=[];if(!this.isReadOnly()){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.edit,this)});t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t};BX.CrmHistoryItemActivity.prototype.view=function(){this.closeContextMenu();var t=this.getAssociatedEntityData();var e=BX.prop.getInteger(t,"ID",0);if(e>0){this._activityEditor.viewActivity(e)}};BX.CrmHistoryItemActivity.prototype.edit=function(){this.closeContextMenu();var t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){var e=this.getAssociatedEntityData();var i=BX.prop.getInteger(e,"ID",0);if(i>0){this._activityEditor.editActivity(i)}}};BX.CrmHistoryItemActivity.prototype.processRemoval=function(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";var t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getRemoveMessage()})}t.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))};BX.CrmHistoryItemActivity.prototype.getRemoveMessage=function(){return this.getMessage("removeConfirm")};BX.CrmHistoryItemActivity.prototype.onRemovalConfirm=function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.remove()};BX.CrmHistoryItemActivity.prototype.onRemovalCancel=function(){};BX.CrmHistoryItemActivity.prototype.remove=function(){var t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){var e=this.getAssociatedEntityData();var i=BX.prop.getInteger(e,"ID",0);if(i>0){var r=this._activityEditor;var n=r.getItemById(i);if(n){r.deleteActivity(i,true)}else{var s=BX.util.add_url_param(r.getSetting("serviceUrl",""),{id:i,action:"get_activity",ownertype:r.getSetting("ownerType",""),ownerid:r.getSetting("ownerID","")});BX.ajax({url:s,method:"POST",dataType:"json",data:{ACTION:"GET_ACTIVITY",ID:i,OWNER_TYPE:r.getSetting("ownerType",""),OWNER_ID:r.getSetting("ownerID","")},onsuccess:BX.delegate(function(t){if(typeof t["ACTIVITY"]!=="undefined"){r._handleActivityChange(t["ACTIVITY"]);window.setTimeout(BX.delegate(this.remove,this),500)}},this),onfailure:function(t){}})}}}};if(typeof BX.CrmHistoryItemActivity.messages==="undefined"){BX.CrmHistoryItemActivity.messages={}}BX.CrmHistoryItemActivity.create=function(t,e){var i=new BX.CrmHistoryItemActivity;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemComment==="undefined"){BX.CrmHistoryItemComment=function(){BX.CrmHistoryItemComment.superclass.constructor.apply(this);this._isCollapsed=false;this._isMenuShown=false;this._isFixed=false;this._hasFiles=false;this._commentEditorUrl=null;this._postForm=null;this._editor=null;this._mode=BX.Crm.TimelineEditorMode.view};BX.extend(BX.CrmHistoryItemComment,BX.CrmHistoryItem);BX.CrmHistoryItemComment.prototype.doInitialize=function(){BX.CrmHistoryItemComment.superclass.doInitialize.apply(this);this._commentEditorUrl=this.getSetting("commentEditorUrl");this._hasFiles=this.getTextDataParam("HAS_FILES")==="Y"};BX.CrmHistoryItemComment.prototype.getTitle=function(){return this.getMessage("comment")};BX.CrmHistoryItemComment.prototype.prepareContent=function(){var t=this.getTextDataParam("COMMENT","");var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-comment"}});if(this.isReadOnly()){BX.addClass(e,"crm-entity-stream-section-comment-read-only")}if(this.isFixed())BX.addClass(e,"crm-entity-stream-section-top-fixed");e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-comment"}}));if(this.isContextMenuEnabled()){e.appendChild(this.prepareContextMenuButton())}var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var r=this.prepareHeaderLayout();i.appendChild(r);if(!this.isReadOnly())e.appendChild(this.prepareFixedSwitcherLayout());var n=[];if(this._mode!==BX.Crm.TimelineEditorMode.edit){this._commentWrapper=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});BX.html(this._commentWrapper,this.getTextDataParam("COMMENT",""));n.push(this._commentWrapper);if(!this.isReadOnly()){BX.bind(this._commentWrapper,"click",BX.delegate(this.switchToEditMode,this));BX.bind(r,"click",BX.delegate(this.switchToEditMode,this))}}else{if(!BX.type.isDomNode(this._editorContainer))this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});n.push(this._editorContainer);var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-comment-edit-btn-container"},children:[BX.create("button",{attrs:{className:"ui-btn ui-btn-xs ui-btn-primary"},html:this.getMessage("send"),events:{click:BX.delegate(this.save,this)}}),BX.create("a",{attrs:{className:"ui-btn ui-btn-xs ui-btn-link"},html:this.getMessage("cancel"),events:{click:BX.delegate(this.switchToViewMode,this)}})]});n.push(s)}i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:n}));var a=this.prepareAuthorLayout();if(a){i.appendChild(a)}var o=this.getTextDataParam("TEXT","");var c=this.getTextDataParam("HAS_INLINE_ATTACHMENT","")==="Y";if(o.length<=128&&!c||this._mode===BX.Crm.TimelineEditorMode.edit){this._isCollapsed=false;e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}))}else{this._isCollapsed=true;e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content crm-entity-stream-section-content-collapsed"},children:[i]}));e.querySelector(".crm-entity-stream-content-event").appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content-expand-btn-container"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-section-content-expand-btn",href:"#"},events:{click:BX.delegate(this.onExpandButtonClick,this)},text:this.getMessage("expand")})]}))}if(this._mode===BX.Crm.TimelineEditorMode.view&&this._hasFiles){this._textLoaded=false;this._fileBlock=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-files-inner"},children:[BX.create("DIV",{attrs:{className:"crm-timeline-wait"}})]});e.querySelector(".crm-entity-stream-section-content").appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-files"},children:[this._fileBlock]}));BX.ready(BX.delegate(function(){window.setTimeout(BX.delegate(function(){this.loadContent(this._fileBlock,"GET_FILE_BLOCK")},this),100)},this))}return e};BX.CrmHistoryItemComment.prototype.prepareActions=function(){if(this._mode===BX.Crm.TimelineEditorMode.view&&BX.type.isDomNode(this._commentWrapper)){this.registerImages(this._commentWrapper);BX.viewElementBind(this._commentWrapper,{showTitle:true},function(t){return BX.type.isElementNode(t)&&(t.getAttribute("data-bx-viewer")||t.getAttribute("data-bx-image"))})}};BX.CrmHistoryItemComment.prototype.loadContent=function(t,e){if(!BX.type.isDomNode(t))return;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"GET_COMMENT_CONTENT",ID:this.getId(),ENTITY_TYPE_ID:this.getOwnerTypeId(),ENTITY_ID:this.getOwnerId(),TYPE:e},onsuccess:BX.delegate(function(i){if(BX.type.isNotEmptyString(i.ERROR)&&e==="GET_FILE_BLOCK"){BX.remove(t);return}if(BX.type.isNotEmptyString(i.BLOCK)){var r=BX.html(t,i.BLOCK);r.then(BX.delegate(function(){this.registerImages(t);if(!this.isReadOnly()){BX.bind(t,"click",BX.delegate(this.switchToEditMode,this))}BX.LazyLoad.showImages()},this))}},this)})};BX.CrmHistoryItemComment.prototype.loadEditor=function(){this._editorName="CrmTimeLineComment"+this._id+BX.util.getRandomString(4);if(!this._commentEditorUrl&&this._postForm)return;var t=BX.util.add_url_param(this._commentEditorUrl,{id:this._id,name:this._editorName});BX.ajax.get(t,BX.delegate(this.onLoadEditorSuccess,this))};BX.CrmHistoryItemComment.prototype.onLoadEditorSuccess=function(t){if(!BX.type.isDomNode(this._editorContainer))this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});this._editorContainer.innerHTML=t;if(LHEPostForm){window.setTimeout(BX.delegate(function(){this._postForm=LHEPostForm.getHandler(this._editorName);this._editor=BXHtmlEditor.Get(this._editorName);BX.onCustomEvent(this._postForm.eventNode,"OnShowLHE",[true])},this),0)}};BX.CrmHistoryItemComment.prototype.onFinishFasten=function(){this.registerImages(this._commentWrapper);if(BX.type.isDomNode(this._fileBlock))this.registerImages(this._fileBlock);BX.LazyLoad.showImages()};BX.CrmHistoryItemComment.prototype.registerImages=function(t){var e=t.querySelectorAll('[data-bx-viewer="image"]');var i=e.length;if(i>0){var r=[];for(var n=0;n<i;++n){if(BX.type.isDomNode(e[n])){e[n].id+=BX.util.getRandomString(4);r.push(e[n].id)}}if(r.length>0){BX.LazyLoad.registerImages(r)}}BX.LazyLoad.registerImages(r)};BX.CrmHistoryItemComment.prototype.ensureGhostCreated=function(){if(this._ghostInput){return this._ghostInput}this._ghostInput=BX.create("div",{props:{className:"crm-entity-stream-content-new-comment-textarea-shadow"},text:this._input.value});this._ghostInput.style.width=this._input.offsetWidth+"px";document.body.appendChild(this._ghostInput);return this._ghostInput};BX.CrmHistoryItemComment.prototype.toggleMode=function(t){this._mode=parseInt(t);this._hasFiles=this.getTextDataParam("HAS_FILES")==="Y";this.refreshLayout();this.closeContextMenu()};BX.CrmHistoryItemComment.prototype.switchToViewMode=function(t){if(LHEPostForm)LHEPostForm.unsetHandler(this._editorName);this.toggleMode(BX.Crm.TimelineEditorMode.view)};BX.CrmHistoryItemComment.prototype.switchToEditMode=function(t){var e=t.target.tagName.toLowerCase();if(e==="a"||e==="img"||BX.hasClass(t.target,"feed-con-file-changes-link-more")||BX.hasClass(t.target,"feed-com-file-inline")){return}this.toggleMode(BX.Crm.TimelineEditorMode.edit);window.setTimeout(BX.delegate(function(){this.loadEditor()},this),100)};BX.CrmHistoryItemComment.prototype.prepareContextMenuItems=function(){if(this._isMenuShown){return}var t=[];if(!this.isReadOnly()){if(this._mode!==BX.Crm.TimelineEditorMode.edit){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.switchToEditMode,this)})}else{t.push({id:"cancel",text:this.getMessage("menuCancel"),onclick:BX.delegate(this.switchToViewMode,this)})}t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t};BX.CrmHistoryItemComment.prototype.save=function(t){var e=[];var i="";if(this._postForm){i=this._postForm.oEditor.GetContent();var r=[];for(var n in this._postForm.arFiles){if(this._postForm.arFiles.hasOwnProperty(n)){var s=this._postForm.arFiles[n];r.indexOf(s)===-1?r.push(s):null}}for(var a=0,o=r.length;a<o;a++){for(var c in this._postForm.controllers[r[a]].values){if(this._postForm.controllers[r[a]].values.hasOwnProperty(c)&&e.indexOf(c)===-1){e.push(c)}}}}else{i=this._input.value}if(!BX.type.isNotEmptyString(i)){if(!this.emptyCommentMessage){this.emptyCommentMessage=new BX.PopupWindow("timeline_empty_comment_"+this._id,t.target,{content:BX.message("CRM_TIMELINE_EMPTY_COMMENT_MESSAGE"),darkMode:true,autoHide:true,zIndex:1200,angle:{position:"top",offset:77},closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.emptyCommentMessage.show();return}if(this._isRequestRunning&&BX.type.isNotEmptyString(i)){return}this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"UPDATE_COMMENT",ID:this.getId(),TEXT:i,OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ATTACHMENTS:e},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})};BX.CrmHistoryItemComment.prototype.processRemoval=function(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";var t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getMessage("commentRemove")})}t.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))};BX.CrmHistoryItemComment.prototype.onRemovalConfirm=function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.remove()};BX.CrmHistoryItemComment.prototype.onRemovalCancel=function(){};BX.CrmHistoryItemComment.prototype.remove=function(t){if(this._isRequestRunning){return}var e=this._history.findItemById(this._id);if(e instanceof BX.CrmHistoryItemComment)e.clearAnimate();var i=this._fixedHistory.findItemById(this._id);if(i instanceof BX.CrmHistoryItemComment)i.clearAnimate();this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"DELETE_COMMENT",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this.getId()},onsuccess:BX.delegate(this.onRemoveSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})};BX.CrmHistoryItemComment.prototype.onSaveSuccess=function(t){this._isRequestRunning=false;var e=BX.prop.getObject(t,"HISTORY_ITEM");var i=this._fixedHistory.findItemById(this._id);if(i instanceof BX.CrmHistoryItemComment){if(!BX.type.isNotEmptyString(e["IS_FIXED"]))e["IS_FIXED"]="Y";i.setData(e);i._id=BX.prop.getString(e,"ID");i.switchToViewMode()}var r=this._history.findItemById(this._id);if(r instanceof BX.CrmHistoryItemComment){r.setData(e);r._id=BX.prop.getString(e,"ID");r.switchToViewMode()}};BX.CrmHistoryItemComment.prototype.onRemoveSuccess=function(t){};BX.CrmHistoryItemComment.prototype.onRequestFailure=function(t){this._isRequestRunning=this._isLocked=false};BX.CrmHistoryItemComment.prototype.onExpandButtonClick=function(t){if(!this._wrapper){return BX.PreventDefault(t)}var e=this._wrapper.querySelector("div.crm-entity-stream-section-content");if(!e){return BX.PreventDefault(t)}if(this._hasFiles&&BX.type.isDomNode(this._commentWrapper)&&!this._textLoaded){this._textLoaded=true;this.loadContent(this._commentWrapper,"GET_TEXT")}var i=e.querySelector(".crm-entity-stream-content-event");if(this._isCollapsed){i.style.maxHeight=i.scrollHeight+130+"px";BX.removeClass(e,"crm-entity-stream-section-content-collapsed");BX.addClass(e,"crm-entity-stream-section-content-expand");setTimeout(BX.delegate(function(){i.style.maxHeight=""},this),300)}else{i.style.maxHeight=i.clientHeight+"px";BX.removeClass(e,"crm-entity-stream-section-content-expand");BX.addClass(e,"crm-entity-stream-section-content-collapsed");setTimeout(BX.delegate(function(){i.style.maxHeight=""},this),0)}this._isCollapsed=!this._isCollapsed;var r=e.querySelector("a.crm-entity-stream-section-content-expand-btn");if(r){r.innerHTML=this.getMessage(this._isCollapsed?"expand":"collapse")}return BX.PreventDefault(t)};BX.CrmHistoryItemComment.create=function(t,e){var i=new BX.CrmHistoryItemComment;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemModification==="undefined"){BX.CrmHistoryItemModification=function(){BX.CrmHistoryItemModification.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemModification,BX.CrmHistoryItem);BX.CrmHistoryItemModification.prototype.getMessage=function(t){var e=BX.CrmHistoryItemModification.messages;return e.hasOwnProperty(t)?e[t]:t};BX.CrmHistoryItemModification.prototype.getTitle=function(){return this.getTextDataParam("TITLE")};BX.CrmHistoryItemModification.prototype.prepareContent=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-info"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var i=this.prepareHeaderLayout();var r=[];if(BX.type.isNotEmptyString(this.getTextDataParam("START_NAME"))){r.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("START_NAME")}));r.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-info-separator-icon"}}))}if(BX.type.isNotEmptyString(this.getTextDataParam("FINISH_NAME"))){r.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("FINISH_NAME")}))}e.appendChild(i);e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-info"},children:r})]}));var n=this.prepareAuthorLayout();if(n){e.appendChild(n)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[e]}));return t};if(typeof BX.CrmHistoryItemModification.messages==="undefined"){BX.CrmHistoryItemModification.messages={}}BX.CrmHistoryItemModification.create=function(t,e){var i=new BX.CrmHistoryItemModification;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemMark==="undefined"){BX.CrmHistoryItemMark=function(){BX.CrmHistoryItemMark.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemMark,BX.CrmHistoryItem);BX.CrmHistoryItemMark.prototype.doInitialize=function(){BX.CrmHistoryItemMark.superclass.doInitialize.apply(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.CrmHistoryItemMark. The field 'activityEditor' is not assigned."}};BX.CrmHistoryItemMark.prototype.getMessage=function(t){var e=BX.CrmHistoryItemMark.messages;return e.hasOwnProperty(t)?e[t]:t};BX.CrmHistoryItemMark.prototype.getTitle=function(){var t="";var e=this.getAssociatedEntityData();var i=this.getAssociatedEntityTypeId();var r=this.getTypeCategoryId();if(i===BX.CrmEntityType.enumeration.activity){var n=BX.prop.getInteger(e,"TYPE_ID",0);var s=BX.prop.getInteger(e,"DIRECTION",0);var a=BX.prop.getString(e,"PROVIDER_ID","");if(n===BX.CrmActivityType.email){if(r===2){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")+"SuccessMark")}else if(r===3){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")+"RenewMark")}}else if(n===BX.CrmActivityType.call){if(r===2){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")+"SuccessMark")}else if(r===3){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")+"RenewMark")}}else if(n===BX.CrmActivityType.meeting){if(r===2){t=this.getMessage("meetingSuccessMark")}else if(r===3){t=this.getMessage("meetingRenewMark")}}else if(n===BX.CrmActivityType.task){if(r===2){t=this.getMessage("taskSuccessMark")}else if(r===3){t=this.getMessage("taskRenewMark")}}else if(n===BX.CrmActivityType.provider){if(a==="CRM_REQUEST"){if(r===2){t=this.getMessage("requestSuccessMark")}else if(r===3){t=this.getMessage("requestRenewMark")}}else if(r===2){t=this.getMessage("webformSuccessMark")}else if(r===3){t=this.getMessage("webformRenewMark")}}}else if(i===BX.CrmEntityType.enumeration.deal){if(r===2){t=this.getMessage("dealSuccessMark")}else if(r===5){t=this.getMessage("dealFailedMark")}}return t};BX.CrmHistoryItemMark.prototype.prepareTitleLayout=function(){return BX.create("A",{attrs:{href:"#",className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTitle()})};BX.CrmHistoryItemMark.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=this.getAssociatedEntityTypeId();var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-completed"}});var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var n=this.prepareHeaderLayout();if(e===BX.CrmEntityType.enumeration.activity){var s=BX.prop.getInteger(t,"TYPE_ID",0);var a="crm-entity-stream-section-icon";if(s===BX.CrmActivityType.email){a+=" crm-entity-stream-section-icon-email"}else if(s===BX.CrmActivityType.call){a+=" crm-entity-stream-section-icon-call"}else if(s===BX.CrmActivityType.meeting){a+=" crm-entity-stream-section-icon-meeting"}else if(s===BX.CrmActivityType.task){a+=" crm-entity-stream-section-icon-task"}else if(s===BX.CrmActivityType.provider){var o=BX.prop.getString(t,"PROVIDER_ID","");if(o==="CRM_WEBFORM"){a+=" crm-entity-stream-section-icon-crmForm"}}i.appendChild(BX.create("DIV",{attrs:{className:a}}));r.appendChild(n);var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});r.appendChild(c);c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.cutOffText(BX.prop.getString(t,"SUBJECT",""),128)})]}));var m=this.getTextDataParam("SUMMARY");if(m!==""){c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:m}))}}else{i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));r.appendChild(n);r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:this.cutOffText(BX.prop.getString(t,"TITLE",""),128)}))}var l=this.prepareAuthorLayout();if(l){r.appendChild(l)}i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[r]}));return i};BX.CrmHistoryItemMark.prototype.view=function(){var t=this.getAssociatedEntityData();var e=this.getAssociatedEntityTypeId();if(e===BX.CrmEntityType.enumeration.activity){var i=BX.prop.getInteger(t,"ID",0);if(i>0){this._activityEditor.viewActivity(i)}}else{var r=BX.prop.getString(t,"SHOW_URL","");if(r!==""){BX.Crm.Page.open(r)}}};if(typeof BX.CrmHistoryItemMark.messages==="undefined"){BX.CrmHistoryItemMark.messages={}}BX.CrmHistoryItemMark.create=function(t,e){var i=new BX.CrmHistoryItemMark;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemCreation==="undefined"){BX.CrmHistoryItemCreation=function(){BX.CrmHistoryItemCreation.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemCreation,BX.CrmHistoryItem);BX.CrmHistoryItemCreation.prototype.doInitialize=function(){BX.CrmHistoryItemCreation.superclass.doInitialize.apply(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.CrmHistoryItemCreation. The field 'activityEditor' is not assigned."}};BX.CrmHistoryItemCreation.prototype.getTitle=function(){var t=this.getAssociatedEntityTypeId();var e=this.getAssociatedEntityData();if(t===BX.CrmEntityType.enumeration.activity){var i=BX.prop.getInteger(e,"TYPE_ID");var r=this.getMessage(i===BX.CrmActivityType.task?"task":"activity");return r.replace(/#TITLE#/gi,this.cutOffText(BX.prop.getString(e,"SUBJECT")),64)}return this.getMessage(BX.CrmEntityType.resolveName(this.getAssociatedEntityTypeId()).toLowerCase())};BX.CrmHistoryItemCreation.prototype.getWrapperClassName=function(){return"crm-entity-stream-section-createEntity"};BX.CrmHistoryItemCreation.prototype.prepareContentDetails=function(){var t=this.getAssociatedEntityTypeId();var e=this.getAssociatedEntityId();var i=this.getAssociatedEntityData();if(t===BX.CrmEntityType.enumeration.activity){var r=BX.create("A",{attrs:{href:"#"},html:this.cutOffText(BX.prop.getString(i,"DESCRIPTION_RAW"),128)});BX.bind(r,"click",this._headerClickHandler);return[r]}var n=BX.prop.getString(i,"TITLE");if(n!==""){var s=[];if(t===this.getOwnerTypeId()&&e===this.getOwnerId()){s.push(BX.create("SPAN",{text:n}))}else{s.push(BX.create("A",{attrs:{href:BX.prop.getString(i,"SHOW_URL","#")},text:n}))}var a=this.getTextDataParam("LEGEND");if(a!==""){s.push(BX.create("BR"));s.push(BX.create("SPAN",{text:a}))}var o=this.getObjectDataParam("BASE");var c=BX.prop.getObject(o,"ENTITY_INFO");if(c){s.push(BX.create("BR"));s.push(BX.create("SPAN",{text:BX.prop.getString(o,"CAPTION")+": "}));s.push(BX.create("A",{attrs:{href:BX.prop.getString(c,"SHOW_URL","#")},text:BX.prop.getString(c,"TITLE","")}))}return s}return[]};BX.CrmHistoryItemCreation.prototype.view=function(){var t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){var e=this.getAssociatedEntityData();var i=BX.prop.getInteger(e,"ID",0);if(i>0){this._activityEditor.viewActivity(i)}}};BX.CrmHistoryItemCreation.prototype.getMessage=function(t){var e=BX.CrmHistoryItemCreation.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmHistoryItemCreation.messages==="undefined"){BX.CrmHistoryItemCreation.messages={}}BX.CrmHistoryItemCreation.create=function(t,e){var i=new BX.CrmHistoryItemCreation;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemLink==="undefined"){BX.CrmHistoryItemLink=function(){BX.CrmHistoryItemLink.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemLink,BX.CrmHistoryItem);BX.CrmHistoryItemLink.prototype.getTitle=function(){return this.getMessage(BX.CrmEntityType.resolveName(this.getAssociatedEntityTypeId()).toLowerCase())};BX.CrmHistoryItemLink.prototype.getWrapperClassName=function(){return"crm-entity-stream-section-createEntity"};BX.CrmHistoryItemLink.prototype.prepareContentDetails=function(){var t=this.getAssociatedEntityData();var e=[];e.push(BX.create("A",{attrs:{href:BX.prop.getString(t,"SHOW_URL","#")},text:BX.prop.getString(t,"TITLE")}));return e};BX.CrmHistoryItemLink.prototype.getMessage=function(t){var e=BX.CrmHistoryItemLink.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmHistoryItemLink.messages==="undefined"){BX.CrmHistoryItemLink.messages={}}BX.CrmHistoryItemLink.create=function(t,e){var i=new BX.CrmHistoryItemLink;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemEmail==="undefined"){BX.CrmHistoryItemEmail=function(){BX.CrmHistoryItemEmail.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemEmail,BX.CrmHistoryItemActivity);BX.CrmHistoryItemEmail.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());var e=this.getAssociatedEntityData();var i=BX.prop.getObject(e,"EMAIL_INFO",null);var r=i!==null?BX.prop.getString(i,"STATUS_TEXT",""):"";if(r!==""){t.appendChild(BX.create("SPAN",{props:{className:"crm-entity-stream-content-event-skipped"},text:r}))}var n=this.prepareMarkLayout();if(n){t.appendChild(n)}t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemEmail.prototype.prepareContextMenuItems=function(){if(this._isMenuShown){return}var t=[];if(!this.isReadOnly()){t.push({id:"view",text:this.getMessage("menuView"),onclick:BX.delegate(this.view,this)});t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t};BX.CrmHistoryItemEmail.prototype.reply=function(){};BX.CrmHistoryItemEmail.prototype.replyAll=function(){};BX.CrmHistoryItemEmail.prototype.forward=function(){};BX.CrmHistoryItemEmail.prototype.getRemoveMessage=function(){return this.getMessage("emailRemove").replace("#TITLE#",this.getTitle())};BX.CrmHistoryItemEmail.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"DESCRIPTION_RAW","");if(e!==""){e=e.replace(/^\s+/,"")}var i=BX.prop.getObject(t,"COMMUNICATION",{});var r=BX.prop.getString(i,"TITLE","");var n=BX.prop.getString(i,"SHOW_URL","");var s=BX.prop.getString(i,"VALUE","");var a=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-email"}});a.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-email"}}));if(this.isFixed())BX.addClass(a,"crm-entity-stream-section-top-fixed");var o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});a.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));var c=this.prepareHeaderLayout();o.appendChild(c);if(this.isContextMenuEnabled()){o.appendChild(this.prepareContextMenuButton())}var m=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[m]}));m.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-to"}});m.appendChild(l);if(r!==""){if(n!==""){l.appendChild(BX.create("A",{attrs:{href:n},text:r}))}else{l.appendChild(BX.create("SPAN",{text:r}))}}if(s!==""){if(r!==""){l.appendChild(BX.create("SPAN",{text:" "}))}l.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-email-address"},text:s}))}m.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-fragment"},children:this.prepareCutOffElements(e,128,this._headerClickHandler)}));var h=this.prepareAuthorLayout();if(h){o.appendChild(h)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});o.appendChild(this._actionContainer);if(!this.isReadOnly())o.appendChild(this.prepareFixedSwitcherLayout());return a};BX.CrmHistoryItemEmail.prototype.prepareActions=function(){if(this.isReadOnly()){return}this._actions.push(BX.CrmHistoryEmailAction.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))};BX.CrmHistoryItemEmail.prototype.showActions=function(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}};BX.CrmHistoryItemEmail.create=function(t,e){var i=new BX.CrmHistoryItemEmail;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemCall==="undefined"){BX.CrmHistoryItemCall=function(){BX.CrmHistoryItemCall.superclass.constructor.apply(this);this._playerDummyClickHandler=BX.delegate(this.onPlayerDummyClick,this);this._playerWrapper=null;this._transcriptWrapper=null;this._mediaFileInfo=null};BX.extend(BX.CrmHistoryItemCall,BX.CrmHistoryItemActivity);BX.CrmHistoryItemCall.prototype.getTypeDescription=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getObject(t,"CALL_INFO",null);var i=e!==null?BX.prop.getString(e,"CALL_TYPE_TEXT",""):"";if(i!==""){return i}var r=BX.prop.getInteger(t,"DIRECTION",0);return this.getMessage(r===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")};BX.CrmHistoryItemCall.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());var e=this.getAssociatedEntityData();var i=BX.prop.getObject(e,"CALL_INFO",null);var r=i!==null;var n=r?BX.prop.getBoolean(i,"SUCCESSFUL",false):false;var s=r?BX.prop.getString(i,"STATUS_TEXT",""):"";if(r){t.appendChild(BX.create("DIV",{attrs:{className:n?"crm-entity-stream-content-event-successful":"crm-entity-stream-content-event-missing"},text:s}))}t.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return t};BX.CrmHistoryItemCall.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"DESCRIPTION_RAW","");if(e!==""){e=e.replace(/^\s+/,"")}var i=BX.prop.getObject(t,"COMMUNICATION",{});var r=BX.prop.getString(i,"TITLE","");var n=BX.prop.getString(i,"SHOW_URL","");var s=BX.prop.getString(i,"VALUE","");var a=BX.prop.getString(i,"FORMATTED_VALUE",s);var o=BX.prop.getObject(t,"CALL_INFO",null);var c=o!==null;var m=c?BX.prop.getString(o,"DURATION_TEXT",""):"";var l=c?BX.prop.getBoolean(o,"HAS_TRANSCRIPT",""):"";var h=c?BX.prop.getBoolean(o,"TRANSCRIPT_PENDING",""):"";var p=c?BX.prop.getString(o,"CALL_ID",""):"";var d=c?BX.prop.getString(o,"COMMENT",""):"";var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-call"}});u.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-call"}}));if(this.isFixed())BX.addClass(u,"crm-entity-stream-section-top-fixed");var y=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});u.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[y]}));var f=this.prepareHeaderLayout();y.appendChild(f);if(this.isContextMenuEnabled()){y.appendChild(this.prepareContextMenuButton())}var g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});y.appendChild(g);g.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));g.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(e,128,this._headerClickHandler)}));if(c){var B=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-call"}});g.appendChild(B);this._mediaFileInfo=BX.prop.getObject(t,"MEDIA_FILE_INFO",null);if(this._mediaFileInfo!==null){this._playerWrapper=BX.create("DIV",{attrs:{className:"crm-audio-cap-wrap-container"}});this._playerWrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-audio-cap-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-audio-cap-time"},text:m})],events:{click:this._playerDummyClickHandler}}));B.appendChild(this._playerWrapper)}if(l){this._transcriptWrapper=BX.create("DIV",{attrs:{className:"crm-audio-transcript-wrap-container"},events:{click:function(t){if(BX.Voximplant&&BX.Voximplant.Transcript){BX.Voximplant.Transcript.create({callId:p}).show()}}},children:[BX.create("DIV",{attrs:{className:"crm-audio-transcript-icon"}}),BX.create("DIV",{attrs:{className:"crm-audio-transcript-conversation"},text:BX.message("CRM_TIMELINE_CALL_TRANSCRIPT")})]});B.appendChild(this._transcriptWrapper)}else if(h){this._transcriptWrapper=BX.create("DIV",{attrs:{className:"crm-audio-transcript-wrap-container-pending"},children:[BX.create("DIV",{attrs:{className:"crm-audio-transcript-icon-pending"},html:'<svg class="crm-transcript-loader-circular" viewBox="25 25 50 50"><circle class="crm-transcript-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"></circle></svg>'}),BX.create("DIV",{attrs:{className:"crm-audio-transcript-conversation"},text:BX.message("CRM_TIMELINE_CALL_TRANSCRIPT_PENDING")})]});B.appendChild(this._transcriptWrapper)}if(d){g.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:BX.util.htmlspecialchars(d)}))}}var C=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});g.appendChild(C);if(r!==""){if(n!==""){C.appendChild(BX.create("A",{attrs:{href:n},text:r}))}else{C.appendChild(BX.create("SPAN",{text:r}))}}if(a!==""){if(r!==""){C.appendChild(BX.create("SPAN",{text:" "}))}C.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-email-address"},text:a}))}var _=this.prepareAuthorLayout();if(_){y.appendChild(_)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});y.appendChild(this._actionContainer);if(!this.isReadOnly())y.appendChild(this.prepareFixedSwitcherLayout());return u};BX.CrmHistoryItemCall.prototype.prepareActions=function(){if(this.isReadOnly()){return}this._actions.push(BX.CrmHistoryCallAction.create("call",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._history.getOwnerInfo()}))};BX.CrmHistoryItemCall.prototype.getRemoveMessage=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getInteger(t,"DIRECTION",0);var i=e===BX.CrmActivityDirection.incoming?"incomingCallRemove":"outgoingCallRemove";return this.getMessage(i).replace("#TITLE#",this.getTitle())};BX.CrmHistoryItemCall.prototype.onPlayerDummyClick=function(t){var e=this._playerWrapper.querySelector(".crm-audio-cap-wrap");if(e){BX.addClass(e,"crm-audio-cap-wrap-loader")}this._history.getManager().loadMediaPlayer("history_"+this.getId(),this._mediaFileInfo["URL"],this._mediaFileInfo["TYPE"],this._playerWrapper)};BX.CrmHistoryItemCall.create=function(t,e){var i=new BX.CrmHistoryItemCall;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemMeeting==="undefined"){BX.CrmHistoryItemMeeting=function(){BX.CrmHistoryItemMeeting.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemMeeting,BX.CrmHistoryItemActivity);BX.CrmHistoryItemMeeting.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());var e=this.prepareMarkLayout();if(e){t.appendChild(e)}t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemMeeting.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"DESCRIPTION_RAW","");if(e!==""){e=e.replace(/^\s+/,"")}var i=BX.prop.getObject(t,"COMMUNICATION",{});var r=BX.prop.getString(i,"TITLE","");var n=BX.prop.getString(i,"SHOW_URL","");var s=BX.prop.getString(i,"VALUE","");var a=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-meeting"}});a.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-meeting"}}));if(this.isContextMenuEnabled()){a.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(a,"crm-entity-stream-section-top-fixed");var o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});a.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));var c=this.prepareHeaderLayout();o.appendChild(c);var m=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});o.appendChild(m);m.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));m.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(e,128,this._headerClickHandler)}));var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});m.appendChild(l);if(r!==""){l.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(n!==""){l.appendChild(BX.create("A",{attrs:{href:n},text:r}))}else{l.appendChild(BX.create("SPAN",{text:r}))}}l.appendChild(BX.create("SPAN",{text:" "+s}));var h=this.prepareAuthorLayout();if(h){o.appendChild(h)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});o.appendChild(this._actionContainer);if(!this.isReadOnly())o.appendChild(this.prepareFixedSwitcherLayout());return a};BX.CrmHistoryItemMeeting.prototype.getRemoveMessage=function(){return this.getMessage("meetingRemove").replace("#TITLE#",this.getTitle())};BX.CrmHistoryItemMeeting.prototype.prepareActions=function(){};BX.CrmHistoryItemMeeting.prototype.showActions=function(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}};BX.CrmHistoryItemMeeting.create=function(t,e){var i=new BX.CrmHistoryItemMeeting;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemTask==="undefined"){BX.CrmHistoryItemTask=function(){BX.CrmHistoryItemTask.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemTask,BX.CrmHistoryItemActivity);BX.CrmHistoryItemTask.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());var e=this.prepareMarkLayout();if(e){t.appendChild(e)}t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemTask.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"DESCRIPTION_RAW","");if(e!==""){e=e.replace(/^\s+/,"")}var i=BX.prop.getObject(t,"COMMUNICATION",{});var r=BX.prop.getString(i,"TITLE","");var n=BX.prop.getString(i,"SHOW_URL","");var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-task"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-task"}}));if(this.isContextMenuEnabled()){s.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");var a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[a]}));var o=this.prepareHeaderLayout();a.appendChild(o);var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});a.appendChild(c);c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(e,128,this._headerClickHandler)}));var m=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});c.appendChild(m);if(r!==""){m.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(n!==""){m.appendChild(BX.create("A",{attrs:{href:n},text:r}))}else{m.appendChild(BX.create("SPAN",{text:r}))}}var l=this.prepareAuthorLayout();if(l){a.appendChild(l)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});a.appendChild(this._actionContainer);if(!this.isReadOnly())a.appendChild(this.prepareFixedSwitcherLayout());return s};BX.CrmHistoryItemTask.prototype.prepareActions=function(){};BX.CrmHistoryItemTask.prototype.getRemoveMessage=function(){return this.getMessage("taskRemove").replace("#TITLE#",this.getTitle())};BX.CrmHistoryItemTask.prototype.showActions=function(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}};BX.CrmHistoryItemTask.create=function(t,e){var i=new BX.CrmHistoryItemTask;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemWebForm==="undefined"){BX.CrmHistoryItemWebForm=function(){BX.CrmHistoryItemWebForm.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemWebForm,BX.CrmHistoryItemActivity);BX.CrmHistoryItemWebForm.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemWebForm.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-crmForm"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-crmForm"}}));var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));if(this.isFixed())BX.addClass(e,"crm-entity-stream-section-top-fixed");var r=this.prepareHeaderLayout();i.appendChild(r);var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});i.appendChild(n);n.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));var s=this.prepareAuthorLayout();if(s){i.appendChild(s)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});i.appendChild(this._actionContainer);if(!this.isReadOnly())i.appendChild(this.prepareFixedSwitcherLayout());return e};BX.CrmHistoryItemWebForm.prototype.prepareActions=function(){};BX.CrmHistoryItemWebForm.prototype.showActions=function(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}};BX.CrmHistoryItemWebForm.create=function(t,e){var i=new BX.CrmHistoryItemWebForm;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemWait==="undefined"){BX.CrmHistoryItemWait=function(){BX.CrmHistoryItemWait.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemWait,BX.CrmHistoryItem);BX.CrmHistoryItemWait.prototype.getTitle=function(){return this.getMessage("wait")};BX.CrmHistoryItemWait.prototype.prepareTitleLayout=function(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]})};BX.CrmHistoryItemWait.prototype.prepareTimeLayout=function(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})};BX.CrmHistoryItemWait.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemWait.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"DESCRIPTION_RAW","");if(e!==""){e=BX.util.trim(e);e=BX.util.strip_tags(e);e=BX.util.nl2br(e)}var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-wait"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-complete"}}));var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[r]}));var n=this.prepareHeaderLayout();r.appendChild(n);var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:e});r.appendChild(s);var a=this.prepareAuthorLayout();if(a){r.appendChild(a)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});r.appendChild(this._actionContainer);return i};BX.CrmHistoryItemWait.prototype.prepareActions=function(){};BX.CrmHistoryItemWait.prototype.showActions=function(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}};BX.CrmHistoryItemWait.create=function(t,e){var i=new BX.CrmHistoryItemWait;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemDocument==="undefined"){BX.CrmHistoryItemDocument=function(){BX.CrmHistoryItemDocument.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemDocument,BX.CrmHistoryItem);BX.CrmHistoryItemDocument.prototype.getTitle=function(){return this.getMessage("document")};BX.CrmHistoryItemDocument.prototype.prepareTitleLayout=function(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:BX.delegate(this.editDocument,this)},text:this.getTitle()})]})};BX.CrmHistoryItemDocument.prototype.prepareTimeLayout=function(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})};BX.CrmHistoryItemDocument.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemDocument.prototype.prepareContent=function(){var t=this.getTextDataParam("COMMENT","");var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-document"}});if(this.isFixed()){BX.addClass(e,"crm-entity-stream-section-top-fixed")}e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-document"}}));if(this.isContextMenuEnabled()){e.appendChild(this.prepareContextMenuButton())}if(!this.isReadOnly()){e.appendChild(this.prepareFixedSwitcherLayout())}var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));var r=this.prepareHeaderLayout();i.appendChild(r);var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:t});var s=BX.findChildByClassName(n,"document-title-link");if(s){BX.bind(s,"click",BX.proxy(this.editDocument,this))}i.appendChild(n);var a=this.prepareAuthorLayout();if(a){i.appendChild(a)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});i.appendChild(this._actionContainer);return e};BX.CrmHistoryItemDocument.prototype.prepareActions=function(){};BX.CrmHistoryItemDocument.prototype.showActions=function(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}};BX.CrmHistoryItemDocument.prototype.prepareContextMenuItems=function(){if(this._isMenuShown){return}var t=[];if(!this.isReadOnly()){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.editDocument,this)});t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.confirmDelete,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id)){t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)})}else{t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}}return t};BX.CrmHistoryItemDocument.prototype.confirmDelete=function(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";var t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getMessage("documentRemove")})}t.open().then(BX.delegate(this.onConfirmDelete,this),BX.DoNothing)};BX.CrmHistoryItemDocument.prototype.onConfirmDelete=function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.deleteDocument()};BX.CrmHistoryItemDocument.prototype.deleteDocument=function(){if(this._isRequestRunning){return}this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"DELETE_DOCUMENT",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this.getId()},onsuccess:BX.delegate(function(){this._isRequestRunning=false;var t=this._history.findItemById(this._id);if(t instanceof BX.CrmHistoryItemDocument){t.clearAnimate()}var e=this._fixedHistory.findItemById(this._id);if(e instanceof BX.CrmHistoryItemDocument){e.clearAnimate()}},this),onfailure:BX.delegate(function(){this._isRequestRunning=false},this)})};BX.CrmHistoryItemDocument.prototype.editDocument=function(){var t=this.getData().DOCUMENT_ID||0;if(t>0){var e="/bitrix/components/bitrix/crm.document.view/slider.php";e=BX.util.add_url_param(e,{documentId:t});if(BX.SidePanel){BX.SidePanel.Instance.open(e,{width:980})}else{top.location.href=e}}};BX.CrmHistoryItemDocument.create=function(t,e){var i=new BX.CrmHistoryItemDocument;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemSender==="undefined"){BX.CrmHistoryItemSender=function(){BX.CrmHistoryItemSender.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemSender,BX.CrmHistoryItem);BX.CrmHistoryItemSender.prototype.getDataSetting=function(t){var e=this.getObjectDataParam("SETTINGS")||{};return e[t]||null};BX.CrmHistoryItemSender.prototype.getMessage=function(t){var e=BX.CrmHistoryItemSender.messages;return e.hasOwnProperty(t)?e[t]:t};BX.CrmHistoryItemSender.prototype.getTitle=function(){return this.getDataSetting("messageName")};BX.CrmHistoryItemSender.prototype.prepareTitleLayout=function(){var t=this;return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[this.isRemoved()?BX.create("SPAN",{text:this.getTitle()}):BX.create("A",{attrs:{href:""},events:{click:function(e){if(BX.SidePanel){BX.SidePanel.Instance.open(t.getDataSetting("path"))}else{top.location.href=t.getDataSetting("path")}e.preventDefault();e.stopPropagation()}},text:this.getTitle()})]})};BX.CrmHistoryItemSender.prototype.prepareTimeLayout=function(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})};BX.CrmHistoryItemSender.prototype.prepareStatusLayout=function(){var t,e;if(this.getDataSetting("isUnsub")){e=this.getMessage("unsub");t="crm-entity-stream-content-event-missing"}else if(this.getDataSetting("isClick")){e=this.getMessage("click");t="crm-entity-stream-content-event-successful"}else{e=this.getMessage("read");t="crm-entity-stream-content-event-skipped"}return BX.create("SPAN",{attrs:{className:t},text:e})};BX.CrmHistoryItemSender.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());if(this.getDataSetting("isRead")||this.getDataSetting("isUnsub")){t.appendChild(this.prepareStatusLayout())}t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemSender.prototype.isRemoved=function(){return!this.getDataSetting("letterTitle")};BX.CrmHistoryItemSender.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=this.isRemoved()?this.getMessage("removed"):this.getMessage("title")+": "+this.getDataSetting("letterTitle");var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-wait"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-complete"}}));var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[r]}));var n=this.prepareHeaderLayout();r.appendChild(n);var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:e});r.appendChild(s);var a=this.prepareAuthorLayout();if(a){r.appendChild(a)}return i};BX.CrmHistoryItemSender.create=function(t,e){var i=new BX.CrmHistoryItemSender;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemBizproc==="undefined"){BX.CrmHistoryItemBizproc=function(){BX.CrmHistoryItemBizproc.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemBizproc,BX.CrmHistoryItem);BX.CrmHistoryItemBizproc.prototype.getTitle=function(){return this.getMessage("bizproc")};BX.CrmHistoryItemBizproc.prototype.prepareContent=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-bp"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-bp"}}));var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var i=this.prepareHeaderLayout();e.appendChild(i);e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},html:this.prepareContentTextHtml()})]}));var r=this.prepareAuthorLayout();if(r){e.appendChild(r)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[e]}));return t};BX.CrmHistoryItemBizproc.prototype.prepareContentTextHtml=function(){var t=this.getTextDataParam("TYPE");if(t==="ACTIVITY_ERROR"){return"<strong>#TITLE#</strong>: #ERROR_TEXT#".replace("#TITLE#",BX.util.htmlspecialchars(this.getTextDataParam("ACTIVITY_TITLE"))).replace("#ERROR_TEXT#",BX.util.htmlspecialchars(this.getTextDataParam("ERROR_TEXT")))}var e=this.getTextDataParam("WORKFLOW_TEMPLATE_NAME");var i=this.getTextDataParam("WORKFLOW_STATUS_NAME");if(!e||i!=="Created"&&i!=="Completed"&&i!=="Terminated"){return BX.util.htmlspecialchars(this.getTextDataParam("COMMENT"))}var r=BX.message("CRM_TIMELINE_BIZPROC_CREATED");if(i==="Completed"){r=BX.message("CRM_TIMELINE_BIZPROC_COMPLETED")}else if(i==="Terminated"){r=BX.message("CRM_TIMELINE_BIZPROC_TERMINATED")}return BX.util.htmlspecialchars(r).replace("#NAME#","<strong>"+BX.util.htmlspecialchars(e)+"</strong>")};BX.CrmHistoryItemBizproc.create=function(t,e){var i=new BX.CrmHistoryItemBizproc;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemSms==="undefined"){BX.CrmHistoryItemSms=function(){BX.CrmHistoryItemSms.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemSms,BX.CrmHistoryItemActivity);BX.CrmHistoryItemSms.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareMessageStatusLayout());t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemSms.prototype.prepareMessageStatusLayout=function(){return this._messageStatusNode=BX.create("SPAN")};BX.CrmHistoryItemSms.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getObject(t,"COMMUNICATION",{});var i=BX.prop.getString(e,"TITLE","");var r=BX.prop.getString(e,"SHOW_URL","");var n=BX.prop.getString(e,"VALUE","");var s=BX.prop.getObject(t,"SMS_INFO",{});var a="crm-entity-stream-section-sms";var o=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"+" "+a}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-sms"}}));if(this.isFixed())BX.addClass(o,"crm-entity-stream-section-top-fixed");var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[c]}));var m=this.prepareHeaderLayout();c.appendChild(m);var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});c.appendChild(l);var h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-sms"}});if(s.senderId){var p=s.senderId;var d=s.senderShortName;if(p==="rest"&&s.fromName){d=s.fromName}var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-sms-status"},children:[BX.message("CRM_TIMELINE_SMS_SENDER")+" ",BX.create("STRONG",{text:d})]});if(p!=="rest"&&s.fromName){u.innerHTML+=" "+BX.message("CRM_TIMELINE_SMS_FROM")+" ";u.appendChild(BX.create("STRONG",{text:s.fromName}))}h.appendChild(u)}if(s.statusId!==""){this.setMessageStatus(s.statusId,s.errorText)}var y=BX.util.htmlspecialchars(t["DESCRIPTION_RAW"]).replace(/\r\n|\r|\n/g,"<br/>");var f=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-sms-fragment"}});f.appendChild(BX.create("SPAN",{html:y}));h.appendChild(f);l.appendChild(h);var g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"},text:BX.message("CRM_TIMELINE_SMS_TO")+" "});l.appendChild(g);if(i!==""){if(r!==""){g.appendChild(BX.create("A",{attrs:{href:r},text:i}))}else{g.appendChild(BX.create("SPAN",{text:i}))}}g.appendChild(BX.create("SPAN",{text:" "+n}));var B=this.prepareAuthorLayout();if(B){c.appendChild(B)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});c.appendChild(this._actionContainer);if(!this.isReadOnly())c.appendChild(this.prepareFixedSwitcherLayout());return o};BX.CrmHistoryItemSms.prototype.prepareActions=function(){};BX.CrmHistoryItemSms.prototype.showActions=function(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}};BX.CrmHistoryItemSms.prototype.setMessageStatus=function(t,e){t=parseInt(t);if(isNaN(t)||!this._messageStatusNode)return;var i=this.getSetting("smsStatusDescriptions",{});if(i.hasOwnProperty(t)){this._messageStatusNode.textContent=i[t];this.setMessageStatusErrorText(e);var r=this.getMessageStatusSemantic(t);this.setMessageStatusSemantic(r)}};BX.CrmHistoryItemSms.prototype.setMessageStatusSemantic=function(t){var e={process:"crm-entity-stream-content-event-process",success:"crm-entity-stream-content-event-successful",failure:"crm-entity-stream-content-event-missing"};for(var i in e){var r=i===t?"addClass":"removeClass";BX[r](this._messageStatusNode,e[i])}};BX.CrmHistoryItemSms.prototype.setMessageStatusErrorText=function(t){if(!t){this._messageStatusNode.removeAttribute("title");BX.removeClass(this._messageStatusNode,"crm-entity-stream-content-event-error-tip")}else{this._messageStatusNode.setAttribute("title",t);BX.addClass(this._messageStatusNode,"crm-entity-stream-content-event-error-tip")}};BX.CrmHistoryItemSms.prototype.getMessageStatusSemantic=function(t){var e=this.getSetting("smsStatusSemantics",{});return e.hasOwnProperty(t)?e[t]:"failure"};BX.CrmHistoryItemSms.prototype.subscribe=function(){if(!BX.CrmSmsWatcher)return;var t=this.getAssociatedEntityData();var e=BX.prop.getObject(t,"SMS_INFO",{});if(e.id){BX.CrmSmsWatcher.subscribeOnMessageUpdate(e.id,this.onMessageUpdate.bind(this))}};BX.CrmHistoryItemSms.prototype.onMessageUpdate=function(t){if(t.STATUS_ID){this.setMessageStatus(t.STATUS_ID,t.EXEC_ERROR)}};BX.CrmHistoryItemSms.create=function(t,e){var i=new BX.CrmHistoryItemSms;i.initialize(t,e);i.subscribe();return i}}if(typeof BX.CrmHistoryItemActivityRequest==="undefined"){BX.CrmHistoryItemActivityRequest=function(){BX.CrmHistoryItemActivityRequest.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemActivityRequest,BX.CrmHistoryItemActivity);BX.CrmHistoryItemActivityRequest.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemActivityRequest.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"DESCRIPTION_RAW","");if(e!==""){e=e.replace(/^\s+/,"")}var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today crm-entity-stream-section-robot"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-robot"}}));if(this.isContextMenuEnabled()){i.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(i,"crm-entity-stream-section-top-fixed");var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[r]}));var n=this.prepareHeaderLayout();r.appendChild(n);var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});r.appendChild(s);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(e,128,this._headerClickHandler)}));var a=this.prepareAuthorLayout();if(a){r.appendChild(a)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});r.appendChild(this._actionContainer);if(!this.isReadOnly())r.appendChild(this.prepareFixedSwitcherLayout());return i};BX.CrmHistoryItemActivityRequest.prototype.prepareActions=function(){};BX.CrmHistoryItemActivityRequest.prototype.showActions=function(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}};BX.CrmHistoryItemActivityRequest.create=function(t,e){var i=new BX.CrmHistoryItemActivityRequest;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemActivityRestApplication==="undefined"){BX.CrmHistoryItemActivityRestApplication=function(){BX.CrmHistoryItemActivityRestApplication.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemActivityRestApplication,BX.CrmHistoryItemActivity);BX.CrmHistoryItemActivityRestApplication.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemActivityRestApplication.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"DESCRIPTION_RAW","");if(e!==""){e=e.replace(/^\s+/,"")}var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today crm-entity-stream-section-rest"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-rest"}}));if(this.isFixed())BX.addClass(i,"crm-entity-stream-section-top-fixed");var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[r]}));var n=this.prepareHeaderLayout();r.appendChild(n);var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});r.appendChild(s);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(e,128,this._headerClickHandler)}));var a=this.prepareAuthorLayout();if(a){r.appendChild(a)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});r.appendChild(this._actionContainer);if(!this.isReadOnly())r.appendChild(this.prepareFixedSwitcherLayout());return i};BX.CrmHistoryItemActivityRestApplication.prototype.prepareActions=function(){};BX.CrmHistoryItemActivityRestApplication.prototype.showActions=function(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}};BX.CrmHistoryItemActivityRestApplication.create=function(t,e){var i=new BX.CrmHistoryItemActivityRestApplication;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemOpenLine==="undefined"){BX.CrmHistoryItemOpenLine=function(){BX.CrmHistoryItemOpenLine.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemOpenLine,BX.CrmHistoryItemActivity);BX.CrmHistoryItemOpenLine.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t};BX.CrmHistoryItemOpenLine.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"DESCRIPTION_RAW","");if(e!==""){e=e.replace(/^\s+/,"")}var i=BX.prop.getObject(t,"COMMUNICATION",{});var r=BX.prop.getString(i,"TITLE","");var n=BX.prop.getString(i,"SHOW_URL","");var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-IM"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-IM"}}));if(this.isContextMenuEnabled()){s.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");var a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[a]}));var o=this.prepareHeaderLayout();a.appendChild(o);var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});a.appendChild(c);c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));var m=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM"}});c.appendChild(m);var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM-messages"}});m.appendChild(l);var h=BX.prop.getObject(this.getAssociatedEntityData(),"OPENLINE_INFO",null);if(h){var p=BX.prop.getArray(h,"MESSAGES",[]);for(var d=0,u=p.length;d<u;d++){var y=p[d];var f=BX.prop.getBoolean(y,"IS_EXTERNAL",true);l.appendChild(BX.create("DIV",{attrs:{className:f?"crm-entity-stream-content-detail-IM-message-incoming":"crm-entity-stream-content-detail-IM-message-outgoing"},text:BX.prop.getString(y,"MESSAGE","")}))}}var g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});c.appendChild(g);if(r!==""){g.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(n!==""){g.appendChild(BX.create("A",{attrs:{href:n},text:r}))}else{g.appendChild(BX.create("SPAN",{text:r}))}}var B=this.prepareAuthorLayout();if(B){a.appendChild(B)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});a.appendChild(this._actionContainer);if(!this.isReadOnly())a.appendChild(this.prepareFixedSwitcherLayout());return s};BX.CrmHistoryItemOpenLine.prototype.prepareActions=function(){if(this.isReadOnly()){return}this._actions.push(BX.CrmHistoryOpenLineAction.create("openline",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._history.getOwnerInfo()}))};BX.CrmHistoryItemOpenLine.prototype.view=function(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}var t="";var e=BX.prop.getObject(this.getAssociatedEntityData(),"COMMUNICATION",null);if(e){if(BX.prop.getString(e,"TYPE")==="IM"){t=BX.prop.getString(e,"VALUE")}}if(t!==""){window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}};BX.CrmHistoryItemOpenLine.create=function(t,e){var i=new BX.CrmHistoryItemOpenLine;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemConversion==="undefined"){BX.CrmHistoryItemConversion=function(){BX.CrmHistoryItemConversion.superclass.constructor.apply(this)};BX.extend(BX.CrmHistoryItemConversion,BX.CrmHistoryItem);BX.CrmHistoryItemConversion.prototype.getMessage=function(t){var e=BX.CrmHistoryItemConversion.messages;return e.hasOwnProperty(t)?e[t]:t};BX.CrmHistoryItemConversion.prototype.getTitle=function(){return this.getTextDataParam("TITLE")};BX.CrmHistoryItemConversion.prototype.prepareContent=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-convert crm-entity-stream-section-history"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-convert"}}));var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var i=this.prepareHeaderLayout();e.appendChild(i);var r=[];var n=this.getArrayDataParam("ENTITIES");for(var s=0,a=n.length;s<a;s++){var o=n[s];var c;if(BX.prop.getString(o,"SHOW_URL","")===""){c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-convert"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-status-text"},text:BX.CrmEntityType.getNotFoundMessage(o["ENTITY_TYPE_ID"])})]})]})}else{c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-convert"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-status-text"},text:BX.CrmEntityType.getCaption(o["ENTITY_TYPE_ID"])})]}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-convert-separator-icon"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-content-detail-target",href:o["SHOW_URL"]},text:o["TITLE"]})]})]})}r.push(c)}e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:r}));var m=this.prepareAuthorLayout();if(m){e.appendChild(m)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[e]}));return t};if(typeof BX.CrmHistoryItemConversion.messages==="undefined"){BX.CrmHistoryItemConversion.messages={}}BX.CrmHistoryItemConversion.create=function(t,e){var i=new BX.CrmHistoryItemConversion;i.initialize(t,e);return i}}if(typeof BX.CrmHistoryItemVisit==="undefined"){BX.CrmHistoryItemVisit=function(){BX.CrmHistoryItemVisit.superclass.constructor.apply(this);this._playerDummyClickHandler=BX.delegate(this.onPlayerDummyClick,this);this._playerWrapper=null;this._transcriptWrapper=null;this._mediaFileInfo=null};BX.extend(BX.CrmHistoryItemVisit,BX.CrmHistoryItemActivity);BX.CrmHistoryItemVisit.prototype.prepareHeaderLayout=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());var e=this.getAssociatedEntityData();var i=BX.prop.getObject(e,"VISIT_INFO",{});var r=BX.prop.getInteger(i,"RECORD_LENGTH",0);var n=BX.prop.getString(i,"RECORD_LENGTH_FORMATTED_FULL","");t.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:(r>0?n+", "+BX.message("CRM_TIMELINE_VISIT_AT")+" ":"")+this.formatTime(this.getCreatedTime())}));return t};BX.CrmHistoryItemVisit.prototype.prepareContent=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getObject(t,"COMMUNICATION",{});var i=BX.prop.getString(e,"TITLE","");var r=BX.prop.getString(e,"SHOW_URL","");var n=BX.prop.getString(e,"VALUE","");var s=BX.prop.getString(e,"FORMATTED_VALUE",n);var a=BX.prop.getObject(t,"VISIT_INFO",{});var o=BX.prop.getInteger(a,"RECORD_LENGTH",0);var c=BX.prop.getString(a,"RECORD_LENGTH_FORMATTED_SHORT","");var m=BX.prop.getString(a,"VK_PROFILE","");var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-visit"}});l.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-visit"}}));var h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});l.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[h]}));var p=this.prepareHeaderLayout();h.appendChild(p);var d=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});h.appendChild(d);this._mediaFileInfo=BX.prop.getObject(t,"MEDIA_FILE_INFO",null);if(this._mediaFileInfo!==null&&o>0){this._playerWrapper=BX.create("DIV",{attrs:{className:"crm-audio-cap-wrap-container"}});this._playerWrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-audio-cap-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-audio-cap-time"},text:c})],events:{click:this._playerDummyClickHandler}}));d.appendChild(this._playerWrapper)}var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});d.appendChild(u);if(i!==""){u.appendChild(document.createTextNode(BX.message("CRM_TIMELINE_VISIT_WITH")+" "));if(r!==""){u.appendChild(BX.create("A",{attrs:{href:r},text:i}))}else{u.appendChild(BX.create("SPAN",{text:i}))}}if(BX.type.isNotEmptyString(m)){u.appendChild(document.createTextNode(" "));u.appendChild(BX.create("a",{attrs:{className:"crm-entity-stream-content-detail-additional",target:"_blank",href:this.getVkProfileUrl(m)},text:BX.message("CRM_TIMELINE_VISIT_VKONTAKTE_PROFILE")}))}var y=this.prepareAuthorLayout();if(y){h.appendChild(y)}return l};BX.CrmHistoryItemVisit.prototype.onPlayerDummyClick=function(t){var e=this._playerWrapper.querySelector(".crm-audio-cap-wrap");if(e){BX.addClass(e,"crm-audio-cap-wrap-loader")}this._history.getManager().loadMediaPlayer("history_"+this.getId(),this._mediaFileInfo["URL"],this._mediaFileInfo["TYPE"],this._playerWrapper)};BX.CrmHistoryItemVisit.prototype.getVkProfileUrl=function(t){return"https://vk.com/"+BX.util.htmlspecialchars(t)};BX.CrmHistoryItemVisit.create=function(t,e){var i=new BX.CrmHistoryItemVisit;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleItem==="undefined"){BX.CrmScheduleItem=function(){BX.CrmScheduleItem.superclass.constructor.apply(this);this._schedule=null;this._deadlineNode=null;this._headerClickHandler=BX.delegate(this.onHeaderClick,this);this._setAsDoneButtonHandler=BX.delegate(this.onSetAsDoneButtonClick,this)};BX.extend(BX.CrmScheduleItem,BX.CrmTimelineItem);BX.CrmScheduleItem.prototype.doInitialize=function(){this._schedule=this.getSetting("schedule");if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.CrmScheduleItem. The field 'activityEditor' is not assigned."}};BX.CrmScheduleItem.prototype.getDeadline=function(){return null};BX.CrmScheduleItem.prototype.hasDeadline=function(){return BX.type.isDate(this.getDeadline())};BX.CrmScheduleItem.prototype.isCounterEnabled=function(){var t=this.getDeadline();return t&&BX.CrmHistoryItem.isCounterEnabled(t)};BX.CrmScheduleItem.prototype.getSourceId=function(){return BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0)};BX.CrmScheduleItem.prototype.onSetAsDoneCompleted=function(t){if(!BX.prop.getBoolean(t,"COMPLETED")){return}this.markAsDone(true);this._schedule.onItemMarkedAsDone(this,{historyItemData:BX.prop.getObject(t,"HISTORY_ITEM")})};BX.CrmScheduleItem.prototype.onPosponeCompleted=function(t){};BX.CrmScheduleItem.prototype.refreshDeadline=function(){this._deadlineNode.innerHTML=this.formatDateTime(this.getDeadline())};BX.CrmScheduleItem.prototype.formatDateTime=function(t){return this._schedule.formatDateTime(t)};BX.CrmScheduleItem.prototype.getWrapperClassName=function(){return""};BX.CrmScheduleItem.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon"};BX.CrmScheduleItem.prototype.isReadOnly=function(){return this._schedule.isReadOnly()};BX.CrmScheduleItem.prototype.canPostpone=function(){if(this.isReadOnly()){return false}var t=BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{});return BX.prop.getBoolean(t,"POSTPONE",false)};BX.CrmScheduleItem.prototype.isDone=function(){return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(this.getAssociatedEntityData(),"STATUS",0))};BX.CrmScheduleItem.prototype.canComplete=function(){if(this.isReadOnly()){return false}var t=BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{});return BX.prop.getBoolean(t,"COMPLETE",false)};BX.CrmScheduleItem.prototype.setAsDone=function(t){};BX.CrmScheduleItem.prototype.prepareContent=function(t){return null};BX.CrmScheduleItem.prototype.prepareLayout=function(t){this._wrapper=this.prepareContent(t);if(this._wrapper){var e=BX.type.isPlainObject(t)?BX.prop.getBoolean(t,"add",true):true;if(e){var i=BX.type.isPlainObject(t)&&BX.type.isElementNode(t["anchor"])?t["anchor"]:null;if(i&&i.nextSibling){this._container.insertBefore(this._wrapper,i.nextSibling)}else{this._container.appendChild(this._wrapper)}}this.markAsTerminated(this._schedule.checkItemForTermination(this))}};BX.CrmScheduleItem.prototype.onHeaderClick=function(t){this.view();t.preventDefault?t.preventDefault():t.returnValue=false};BX.CrmScheduleItem.prototype.onSetAsDoneButtonClick=function(t){if(this.canComplete()){this.setAsDone(!this.isDone())}};BX.CrmScheduleItem.prototype.onActivityCreate=function(t,e){this._schedule.getManager().onActivityCreated(t,e)};BX.CrmScheduleItem.isDone=function(t){var e=BX.prop.getObject(t,"ASSOCIATED_ENTITY",{});return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(e,"STATUS",0))};BX.CrmScheduleItem.create=function(t,e){var i=new BX.CrmScheduleItem;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleItemActivity==="undefined"){BX.CrmScheduleItemActivity=function(){BX.CrmScheduleItemActivity.superclass.constructor.apply(this);this._postponeController=null};BX.extend(BX.CrmScheduleItemActivity,BX.CrmScheduleItem);BX.CrmScheduleItemActivity.prototype.getTypeId=function(){return BX.CrmTimelineType.activity};BX.CrmScheduleItemActivity.prototype.isDone=function(){var t=BX.prop.getInteger(this.getAssociatedEntityData(),"STATUS");return t===BX.CrmActivityStatus.completed||t===BX.CrmActivityStatus.autoCompleted};BX.CrmScheduleItemActivity.prototype.setAsDone=function(t){t=!!t;if(this.isDone()===t){return}var e=BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0);if(e>0){this._activityEditor.setActivityCompleted(e,t,BX.delegate(this.onSetAsDoneCompleted,this))}};BX.CrmScheduleItemActivity.prototype.postpone=function(t){var e=this.getSourceId();if(e>0&&t>0){this._activityEditor.postponeActivity(e,t,BX.delegate(this.onPosponeCompleted,this))}};BX.CrmScheduleItemActivity.prototype.view=function(){var t=BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0);if(t>0){this._activityEditor.viewActivity(t)}};BX.CrmScheduleItemActivity.prototype.edit=function(){this.closeContextMenu();var t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){var e=this.getAssociatedEntityData();var i=BX.prop.getInteger(e,"ID",0);if(i>0){this._activityEditor.editActivity(i)}}};BX.CrmScheduleItemActivity.prototype.processRemoval=function(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";var t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getRemoveMessage()})}t.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))};BX.CrmScheduleItemActivity.prototype.getRemoveMessage=function(){return this.getMessage("removeConfirm")};BX.CrmScheduleItemActivity.prototype.onRemovalConfirm=function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.remove()};BX.CrmScheduleItemActivity.prototype.onRemovalCancel=function(){};BX.CrmScheduleItemActivity.prototype.remove=function(){var t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){var e=this.getAssociatedEntityData();var i=BX.prop.getInteger(e,"ID",0);if(i>0){var r=this._activityEditor;var n=r.getItemById(i);if(n){r.deleteActivity(i,true)}else{var s=r.getSetting("ownerType","");var a=r.getSetting("ownerID","");var o=BX.util.add_url_param(r.getSetting("serviceUrl",""),{id:i,action:"get_activity",ownertype:s,ownerid:a});BX.ajax({url:o,method:"POST",dataType:"json",data:{ACTION:"GET_ACTIVITY",ID:i,OWNER_TYPE:s,OWNER_ID:a},onsuccess:BX.delegate(function(t){if(typeof t["ACTIVITY"]!=="undefined"){r._handleActivityChange(t["ACTIVITY"]);window.setTimeout(BX.delegate(this.remove,this),500)}},this),onfailure:function(t){}})}}}};BX.CrmScheduleItemActivity.prototype.getDeadline=function(){var t=this.getAssociatedEntityData();var e=BX.parseDate(t["DEADLINE_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!e){return null}return new Date(e.getTime()+1e3*BX.CrmTimelineItem.getUserTimezoneOffset())};BX.CrmScheduleItemActivity.prototype.markAsDone=function(t){t=!!t;this.getAssociatedEntityData()["STATUS"]=t?BX.CrmActivityStatus.completed:BX.CrmActivityStatus.waiting};BX.CrmScheduleItemActivity.prototype.getPrepositionText=function(t){return this.getMessage(t===BX.CrmActivityDirection.incoming?"from":"to")};BX.CrmScheduleItemActivity.prototype.getTypeDescription=function(t){return""};BX.CrmScheduleItemActivity.prototype.isContextMenuEnabled=function(){return!!this.getDeadline()&&this.canPostpone()||this.canComplete()};BX.CrmScheduleItemActivity.prototype.prepareContent=function(t){var e=this.getDeadline();var i=e?this.formatDateTime(e):this.getMessage("termless");var r=this.getAssociatedEntityData();var n=BX.prop.getInteger(r,"DIRECTION",0);var s=this.isDone();var a=BX.prop.getString(r,"SUBJECT","");var o=BX.prop.getString(r,"DESCRIPTION_RAW","");var c=BX.prop.getObject(r,"COMMUNICATION",{});var m=BX.prop.getString(c,"TITLE","");var l=BX.prop.getString(c,"SHOW_URL","");var h=BX.prop.getString(c,"TYPE","")!==""?BX.prop.getString(c,"VALUE",""):"";var p=this.getWrapperClassName();if(p!==""){p="crm-entity-stream-section crm-entity-stream-section-planned"+" "+p}else{p="crm-entity-stream-section crm-entity-stream-section-planned"}var d=BX.create("DIV",{attrs:{className:p}});var u=this.getIconClassName();if(this.isCounterEnabled()){u+=" crm-entity-stream-section-counter"}d.appendChild(BX.create("DIV",{attrs:{className:u}}));if(this.isContextMenuEnabled()){d.appendChild(this.prepareContextMenuButton())}var y=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});d.appendChild(y);if(o!==""){o=o.replace(/^\s+/,"")}var f=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});y.appendChild(f);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:i});var g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTypeDescription(n)}),this._deadlineNode]});f.appendChild(g);var B=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});f.appendChild(B);B.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:a})]}));B.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:this.cutOffText(o,128)}));var C=this.prepareDetailNodes();if(BX.type.isArray(C)){for(var _=0,X=C.length;_<X;_++){B.appendChild(C[_])}}var I=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});if(m!==""){I.appendChild(BX.create("SPAN",{text:this.getPrepositionText(n)+": "}));if(l!==""){I.appendChild(BX.create("A",{attrs:{href:l},text:m}))}else{I.appendChild(BX.create("SPAN",{text:m}))}}if(h!==""){var v=this.prepareCommunicationNode(h);if(v){I.appendChild(v)}}B.appendChild(I);var T=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:s},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){T.disabled=true}var S=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[T]});f.appendChild(S);var E=this.prepareAuthorLayout();if(E){f.appendChild(E)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});f.appendChild(this._actionContainer);return d};BX.CrmScheduleItemActivity.prototype.prepareCommunicationNode=function(t){return BX.create("SPAN",{text:" "+t})};BX.CrmScheduleItemActivity.prototype.prepareDetailNodes=function(){return[]};BX.CrmScheduleItemActivity.prototype.prepareContextMenuItems=function(){var t=[];if(!this.isReadOnly()){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.edit,this)});t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)})}var e=BX.delegate(this.onContextMenuItemSelect,this);if(!this._postponeController){this._postponeController=BX.CrmSchedulePostponeController.create("",{item:this})}var i={id:"postpone",text:this._postponeController.getTitle(),items:[]};var r=this._postponeController.getCommandList();for(var n=0,s=r.length;n<s;n++){var a=r[n];i.items.push({id:a["name"],text:a["title"],onclick:e})}t.push(i);return t};BX.CrmScheduleItemActivity.prototype.onContextMenuItemSelect=function(t,e){this.closeContextMenu();if(this._postponeController){this._postponeController.processCommand(e.id)}}}if(typeof BX.CrmScheduleItemEmail==="undefined"){BX.CrmScheduleItemEmail=function(){BX.CrmScheduleItemEmail.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleItemEmail,BX.CrmScheduleItemActivity);BX.CrmScheduleItemEmail.prototype.getWrapperClassName=function(){return"crm-entity-stream-section-email"};BX.CrmScheduleItemEmail.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-email"};BX.CrmScheduleItemEmail.prototype.prepareActions=function(){if(this.isReadOnly()){return}this._actions.push(BX.CrmScheduleEmailAction.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))};BX.CrmScheduleItemEmail.prototype.getTypeDescription=function(t){return this.getMessage(t===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")};BX.CrmScheduleItemEmail.prototype.getRemoveMessage=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"SUBJECT","");return this.getMessage("emailRemove").replace("#TITLE#",e)};BX.CrmScheduleItemEmail.create=function(t,e){var i=new BX.CrmScheduleItemEmail;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleItemCall==="undefined"){BX.CrmScheduleItemCall=function(){BX.CrmScheduleItemCall.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleItemCall,BX.CrmScheduleItemActivity);BX.CrmScheduleItemCall.prototype.getWrapperClassName=function(){return"crm-entity-stream-section-call"};BX.CrmScheduleItemCall.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-call"};BX.CrmScheduleItemCall.prototype.prepareActions=function(){if(this.isReadOnly()){return}this._actions.push(BX.CrmScheduleCallAction.create("call",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._schedule.getOwnerInfo()}))};BX.CrmScheduleItemCall.prototype.getTypeDescription=function(t){var e=this.getAssociatedEntityData();var i=BX.prop.getObject(e,"CALL_INFO",null);var r=i!==null?BX.prop.getString(i,"CALL_TYPE_TEXT",""):"";if(r!==""){return r}return this.getMessage(t===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")};BX.CrmScheduleItemCall.prototype.getRemoveMessage=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getInteger(t,"DIRECTION",0);var i=BX.prop.getString(t,"SUBJECT","");var r=e===BX.CrmActivityDirection.incoming?"incomingCallRemove":"outgoingCallRemove";return this.getMessage(r).replace("#TITLE#",i)};BX.CrmScheduleItemCall.create=function(t,e){var i=new BX.CrmScheduleItemCall;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleItemMeeting==="undefined"){BX.CrmScheduleItemMeeting=function(){BX.CrmScheduleItemMeeting.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleItemMeeting,BX.CrmScheduleItemActivity);BX.CrmScheduleItemMeeting.prototype.getWrapperClassName=function(){return""};BX.CrmScheduleItemMeeting.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-meeting"};BX.CrmScheduleItemMeeting.prototype.prepareActions=function(){};BX.CrmScheduleItemMeeting.prototype.getPrepositionText=function(){return this.getMessage("reciprocal")};BX.CrmScheduleItemMeeting.prototype.getRemoveMessage=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"SUBJECT","");return this.getMessage("meetingRemove").replace("#TITLE#",e)};BX.CrmScheduleItemMeeting.prototype.getTypeDescription=function(){return this.getMessage("meeting")};BX.CrmScheduleItemMeeting.create=function(t,e){var i=new BX.CrmScheduleItemMeeting;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleItemTask==="undefined"){BX.CrmScheduleItemTask=function(){BX.CrmScheduleItemTask.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleItemTask,BX.CrmScheduleItemActivity);BX.CrmScheduleItemTask.prototype.getWrapperClassName=function(){return"crm-entity-stream-section-planned-task"};BX.CrmScheduleItemTask.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-task"};BX.CrmScheduleItemTask.prototype.getTypeDescription=function(){return this.getMessage("task")};BX.CrmScheduleItemTask.prototype.getPrepositionText=function(t){return this.getMessage("reciprocal")};BX.CrmScheduleItemTask.prototype.getRemoveMessage=function(){var t=this.getAssociatedEntityData();var e=BX.prop.getString(t,"SUBJECT","");return this.getMessage("taskRemove").replace("#TITLE#",e)};BX.CrmScheduleItemTask.create=function(t,e){var i=new BX.CrmScheduleItemTask;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleItemWebForm==="undefined"){BX.CrmScheduleItemWebForm=function(){BX.CrmScheduleItemWebForm.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleItemWebForm,BX.CrmScheduleItemActivity);BX.CrmScheduleItemWebForm.prototype.getWrapperClassName=function(){return""};BX.CrmScheduleItemWebForm.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-crmForm"};BX.CrmScheduleItemWebForm.prototype.prepareActions=function(){};BX.CrmScheduleItemWebForm.prototype.getPrepositionText=function(){return this.getMessage("from")};BX.CrmScheduleItemWebForm.prototype.getTypeDescription=function(){return this.getMessage("webform")};BX.CrmScheduleItemWebForm.create=function(t,e){var i=new BX.CrmScheduleItemWebForm;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleItemWait==="undefined"){BX.CrmScheduleItemWait=function(){BX.CrmScheduleItemWait.superclass.constructor.apply(this);this._postponeController=null};BX.extend(BX.CrmScheduleItemWait,BX.CrmScheduleItem);BX.CrmScheduleItemWait.prototype.getWrapperClassName=function(){return"crm-entity-stream-section-wait"};BX.CrmScheduleItemWait.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-wait"};BX.CrmScheduleItemWait.prototype.prepareActions=function(){};BX.CrmScheduleItemWait.prototype.isCounterEnabled=function(){return false};BX.CrmScheduleItemWait.prototype.getDeadline=function(){var t=this.getAssociatedEntityData();var e=BX.parseDate(t["DEADLINE_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!e){return null}return new Date(e.getTime()+1e3*BX.CrmTimelineItem.getUserTimezoneOffset())};BX.CrmScheduleItemWait.prototype.isDone=function(){return BX.prop.getString(this.getAssociatedEntityData(),"COMPLETED","N")==="Y"};BX.CrmScheduleItemWait.prototype.setAsDone=function(t){t=!!t;if(this.isDone()===t){return}var e=this.getAssociatedEntityId();if(e>0){var i=this._schedule.getManager().getWaitEditor();if(i){i.complete(e,t,BX.delegate(this.onSetAsDoneCompleted,this))}}};BX.CrmScheduleItemWait.prototype.postpone=function(t){var e=this.getAssociatedEntityId();if(e>0&&t>0){var i=this._schedule.getManager().getWaitEditor();if(i){i.postpone(e,t,BX.delegate(this.onPosponeCompleted,this))}}};BX.CrmScheduleItemWait.prototype.isContextMenuEnabled=function(){return!!this.getDeadline()&&this.canPostpone()};BX.CrmScheduleItemWait.prototype.prepareContent=function(){var t=this.getDeadline();var e=t?this.formatDateTime(t):this.getMessage("termless");var i=this.getAssociatedEntityData();var r=this.isDone();var n=BX.prop.getString(i,"DESCRIPTION_RAW","");var s=this.getWrapperClassName();if(s!==""){s="crm-entity-stream-section crm-entity-stream-section-planned"+" "+s}else{s="crm-entity-stream-section crm-entity-stream-section-planned"}var a=BX.create("DIV",{attrs:{className:s}});var o=this.getIconClassName();if(this.isCounterEnabled()){o+=" crm-entity-stream-section-counter"}a.appendChild(BX.create("DIV",{attrs:{className:o}}));if(this.isContextMenuEnabled()){a.appendChild(this.prepareContextMenuButton())}var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});a.appendChild(c);if(n!==""){n=BX.util.trim(n);n=BX.util.strip_tags(n);n=this.cutOffText(n,512);n=BX.util.nl2br(n)}var m=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});c.appendChild(m);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:e});var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getMessage("wait")}),this._deadlineNode]});m.appendChild(l);var h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});m.appendChild(h);h.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},html:n}));var p=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});h.appendChild(p);var d=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:r},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){d.disabled=true}var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[d]});m.appendChild(u);var y=this.prepareAuthorLayout();if(y){m.appendChild(y)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});m.appendChild(this._actionContainer);return a};BX.CrmScheduleItemWait.prototype.prepareContextMenuItems=function(){var t=[];var e=BX.delegate(this.onContextMenuItemSelect,this);if(!this._postponeController){this._postponeController=BX.CrmSchedulePostponeController.create("",{item:this})}var i={id:"postpone",text:this._postponeController.getTitle(),items:[]};var r=this._postponeController.getCommandList();for(var n=0,s=r.length;n<s;n++){var a=r[n];i.items.push({id:a["name"],text:a["title"],onclick:e})}t.push(i);return t};BX.CrmScheduleItemWait.prototype.onContextMenuItemSelect=function(t,e){this.closeContextMenu();if(this._postponeController){this._postponeController.processCommand(e.id)}};BX.CrmScheduleItemWait.prototype.getTypeDescription=function(){return this.getMessage("wait")};BX.CrmScheduleItemWait.create=function(t,e){var i=new BX.CrmScheduleItemWait;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleItemActivityRequest==="undefined"){BX.CrmScheduleItemActivityRequest=function(){BX.CrmScheduleItemActivityRequest.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleItemActivityRequest,BX.CrmScheduleItemActivity);BX.CrmScheduleItemActivityRequest.prototype.getWrapperClassName=function(){return""};BX.CrmScheduleItemActivityRequest.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-robot"};BX.CrmScheduleItemActivityRequest.prototype.getTypeDescription=function(){return this.getMessage("activityRequest")};BX.CrmScheduleItemActivityRequest.create=function(t,e){var i=new BX.CrmScheduleItemActivityRequest;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleItemActivityRestApplication==="undefined"){BX.CrmScheduleItemActivityRestApplication=function(){BX.CrmScheduleItemActivityRestApplication.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleItemActivityRestApplication,BX.CrmScheduleItemActivity);BX.CrmScheduleItemActivityRestApplication.prototype.getWrapperClassName=function(){return""};BX.CrmScheduleItemActivityRestApplication.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-rest"};BX.CrmScheduleItemActivityRestApplication.prototype.getTypeDescription=function(){return this.getMessage("restApplication")};BX.CrmScheduleItemActivityRestApplication.create=function(t,e){var i=new BX.CrmScheduleItemActivityRestApplication;i.initialize(t,e);return i}}if(typeof BX.CrmScheduleItemActivityOpenLine==="undefined"){BX.CrmScheduleItemActivityOpenLine=function(){BX.CrmScheduleItemActivityOpenLine.superclass.constructor.apply(this)};BX.extend(BX.CrmScheduleItemActivityOpenLine,BX.CrmScheduleItemActivity);BX.CrmScheduleItemActivityOpenLine.prototype.getWrapperClassName=function(){return"crm-entity-stream-section-IM"};BX.CrmScheduleItemActivityOpenLine.prototype.getIconClassName=function(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-IM"};BX.CrmScheduleItemActivityOpenLine.prototype.prepareActions=function(){if(this.isReadOnly()){return}this._actions.push(BX.CrmScheduleOpenLineAction.create("openline",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._schedule.getOwnerInfo()}))};BX.CrmScheduleItemActivityOpenLine.prototype.getTypeDescription=function(){return this.getMessage("openLine")};BX.CrmScheduleItemActivityOpenLine.prototype.getPrepositionText=function(t){return this.getMessage("reciprocal")};BX.CrmScheduleItemActivityOpenLine.prototype.prepareCommunicationNode=function(t){return null};BX.CrmScheduleItemActivityOpenLine.prototype.prepareDetailNodes=function(){var t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM"}});var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM-messages"}});t.appendChild(e);var i=BX.prop.getObject(this.getAssociatedEntityData(),"OPENLINE_INFO",null);if(i){var r=BX.prop.getArray(i,"MESSAGES",[]);for(var n=0,s=r.length;n<s;n++){var a=r[n];var o=BX.prop.getBoolean(a,"IS_EXTERNAL",true);e.appendChild(BX.create("DIV",{attrs:{className:o?"crm-entity-stream-content-detail-IM-message-incoming":"crm-entity-stream-content-detail-IM-message-outgoing"},text:BX.prop.getString(a,"MESSAGE","")}))}}return[t]};BX.CrmScheduleItemActivityOpenLine.prototype.view=function(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}var t="";var e=BX.prop.getObject(this.getAssociatedEntityData(),"COMMUNICATION",null);if(e){if(BX.prop.getString(e,"TYPE")==="IM"){t=BX.prop.getString(e,"VALUE")}}if(t!==""){window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}};BX.CrmScheduleItemActivityOpenLine.create=function(t,e){var i=new BX.CrmScheduleItemActivityOpenLine;i.initialize(t,e);return i}}if(typeof BX.CrmTimelineItemAnimation==="undefined"){BX.CrmTimelineItemAnimation=function(){this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null};BX.CrmTimelineItemAnimation.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},run:function(){this._node=this._initialItem.getWrapper();var t=BX.pos(this._node);this._initialYPosition=t.top;this._initialXPosition=t.left;this._initialWidth=this._node.offsetWidth;this._initialHeight=this._node.offsetHeight;this._anchorYPosition=BX.pos(this._anchor).top;this.createStub();this.createGhost();this.moveGhost()},createStub:function(){this._stub=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-shadow"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon"}}),BX.create("DIV",{props:{className:"crm-entity-stream-section-content"},style:{height:this._initialHeight+"px"}})]});this._node.parentNode.insertBefore(this._stub,this._node)},createGhost:function(){this._ghostNode=this._node;this._ghostNode.style.position="absolute";this._ghostNode.style.width=this._initialWidth+"px";this._ghostNode.style.height=this._initialHeight+"px";this._ghostNode.style.top=this._initialYPosition+"px";this._ghostNode.style.left=this._initialXPosition+"px";document.body.appendChild(this._ghostNode);setTimeout(BX.proxy(function(){BX.addClass(this._ghostNode,"crm-entity-stream-section-casper")},this),20)},moveGhost:function(){var t=this._ghostNode;var e=new BX.easing({duration:500,start:{top:this._initialYPosition},finish:{top:this._anchorYPosition},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy(function(e){t.style.top=e.top+"px"},this)});setTimeout(BX.proxy(function(){e.animate();t.style.boxShadow=""},this),500);var i=new BX.easing({duration:500,start:{height:0},finish:{height:this._initialHeight+20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy(function(t){this._anchor.style.height=t.height+"px"},this),complete:BX.proxy(function(){if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}this.addHistoryItem();this.removeGhost()},this)});setTimeout(function(){i.animate()},500)},addHistoryItem:function(){var t=this._finalItem.getWrapper();this._anchor.parentNode.insertBefore(t,this._anchor.nextSibling);this._finalItemHeight=this._anchor.offsetHeight-t.offsetHeight;this._anchor.style.height=0;t.style.marginBottom=this._finalItemHeight+"px"},removeGhost:function(){var t=this._ghostNode;var e=this._finalItem.getWrapper();t.style.overflow="hidden";var i=new BX.easing({duration:70,start:{opacity:100,height:t.offsetHeight,marginBottom:this._finalItemHeight},finish:{opacity:0,height:e.offsetHeight,marginBottom:20},step:BX.proxy(function(i){t.style.opacity=i.opacity/100;t.style.height=i.height+"px";e.style.marginBottom=i.marginBottom+"px"},this),complete:BX.proxy(function(){t.remove();e.style.marginBottom="";this.collapseStub()},this)});i.animate()},collapseStub:function(){var t=new BX.easing({duration:500,start:{opacity:100,height:this._initialHeight,marginBottom:15},finish:{opacity:0,height:0,marginBottom:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy(function(t){this._stub.style.height=t.height+"px";this._stub.style.marginBottom=t.marginBottom+"px";this._stub.style.opacity=t.opacity/100},this),complete:BX.proxy(function(){this.inited=false},this)});t.animate()}};BX.CrmTimelineItemAnimation.create=function(t,e){var i=new BX.CrmTimelineItemAnimation;i.initialize(t,e);return i}}if(typeof BX.CrmTimelineItemAnimationNew==="undefined"){BX.CrmTimelineItemAnimationNew=function(){this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null};BX.CrmTimelineItemAnimationNew.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},addHistoryItem:function(){var t=this._finalItem.getWrapper();this._anchor.parentNode.insertBefore(t,this._anchor.nextSibling)},run:function(){this._node=this._initialItem.getWrapper();this.createStub();BX.addClass(this._node,"crm-entity-stream-section-animate-start");this._startPosition=BX.pos(this._stub);this._node.style.position="absolute";this._node.style.width=this._startPosition.width+"px";this._node.style.height=this._startPosition.height+"px";this._node.style.top=this._startPosition.top+"px";this._node.style.left=this._startPosition.left+"px";this._node.style.zIndex=1100;document.body.appendChild(this._node);var t=BX.CrmTimelineItemShift.create(this._node,this._anchor,this._startPosition,this._stub,{complete:BX.delegate(this.finish,this)});t.run()},createStub:function(){this._stub=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-shadow"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon"}}),BX.create("DIV",{props:{className:"crm-entity-stream-section-content"},style:{height:this._initialItem._wrapper.clientHeight+"px"}})]});this._node.parentNode.insertBefore(this._stub,this._node)},finish:function(){var t=this._stub.querySelector(".crm-entity-stream-section-content");this._anchor.style.height=0;setTimeout(BX.delegate(function(){BX.removeClass(this._node,"crm-entity-stream-section-animate-start")},this),0);this._node.style.opacity=0;setTimeout(BX.delegate(function(){t.style.height=0;t.style.opacity=0;t.style.paddingTop=0;t.style.paddingBottom=0},this),120);setTimeout(BX.delegate(function(){BX.remove(this._stub);BX.remove(this._node);this.addHistoryItem();if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}},this),420)}};BX.CrmTimelineItemAnimationNew.create=function(t,e){var i=new BX.CrmTimelineItemAnimationNew;i.initialize(t,e);return i}}if(typeof BX.CrmTimelineItemExpand==="undefined"){BX.CrmTimelineItemExpand=function(){this._node=null;this._callback=null};BX.CrmTimelineItemExpand.prototype={initialize:function(t,e){this._node=t;this._callback=BX.type.isFunction(e)?e:null},run:function(){var t=BX.pos(this._node);this._node.style.height=0;this._node.style.opacity=0;this._node.style.overflow="hidden";new BX.easing({duration:150,start:{height:0},finish:{height:t.height},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.delegate(this.onNodeHeightStep,this),complete:BX.delegate(this.onNodeHeightComplete,this)}).animate()},onNodeHeightStep:function(t){this._node.style.height=t.height+"px"},onNodeHeightComplete:function(){this._node.style.overflow="";new BX.easing({duration:150,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.delegate(this.onNodeOpacityStep,this),complete:BX.delegate(this.onNodeOpacityComplete,this)}).animate()},onNodeOpacityStep:function(t){this._node.style.opacity=t.opacity/100},onNodeOpacityComplete:function(){this._node.style.height="";this._node.style.opacity="";if(this._callback){this._callback()}}};BX.CrmTimelineItemExpand.create=function(t,e){var i=new BX.CrmTimelineItemExpand;i.initialize(t,e);return i}}if(typeof BX.CrmTimelineItemExtract==="undefined"){BX.CrmTimelineItemExtract=function(){this._node=null;this._shadowNode=null;this._events=null};BX.CrmTimelineItemExtract.prototype={initialize:function(t,e,i){this._node=t;this._shadowNode=e;this._events=BX.type.isPlainObject(i)?i:{}},run:function(){},finish:function(){}};BX.CrmTimelineItemExtract.create=function(t,e,i){var r=new BX.CrmTimelineItemExtract;r.initialize(t,e,i);return r}}if(typeof BX.CrmTimelineItemShift==="undefined"){BX.CrmTimelineItemShift=function(){this._node=null;this._anchor=null;this._nodeParent=null;this._startPosition=null;this._events=null};BX.CrmTimelineItemShift.prototype={initialize:function(t,e,i,r,n){this._node=t;this._shadowNode=r;this._anchor=e;this._nodeParent=t.parentNode;this._startPosition=i;this._events=BX.type.isPlainObject(n)?n:{}},run:function(){this._anchorPosition=BX.pos(this._anchor);setTimeout(BX.proxy(function(){BX.addClass(this._node,"crm-entity-stream-section-casper")},this),0);var t=new BX.easing({duration:1500,start:{top:this._startPosition.top,height:0},finish:{top:this._anchorPosition.top,height:this._startPosition.height+20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy(function(t){this._node.style.top=t.top+"px";this._anchor.style.height=t.height+"px"},this),complete:BX.proxy(function(){this.finish()},this)});t.animate()},finish:function(){if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}if(this._shadowNode!==false){}}};BX.CrmTimelineItemShift.create=function(t,e,i,r,n){var s=new BX.CrmTimelineItemShift;s.initialize(t,e,i,r,n);return s}}if(typeof BX.CrmCommentAnimation==="undefined"){BX.CrmCommentAnimation=function(){this._node=null;this._anchor=null;this._nodeParent=null;this._startPosition=null;this._events=null};BX.CrmCommentAnimation.prototype={initialize:function(t,e,i,r){this._node=t;this._anchor=e;this._nodeParent=t.parentNode;this._startPosition=i;this._events=BX.type.isPlainObject(r)?r:{}},run:function(){BX.addClass(this._node,"crm-entity-stream-section-animate-start");this._node.style.position="absolute";this._node.style.width=this._startPosition.width+"px";this._node.style.height=this._startPosition.height+"px";this._node.style.top=this._startPosition.top-30+"px";this._node.style.left=this._startPosition.left+"px";this._node.style.opacity=0;this._node.style.zIndex=1100;document.body.appendChild(this._node);var t=new BX.easing({duration:350,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy(function(t){this._node.style.opacity=t.opacity/100},this),complete:BX.proxy(function(){if(BX.type.isFunction(this._events["start"])){this._events["start"]()}var t=BX.CrmTimelineItemShift.create(this._node,this._anchor,this._startPosition,false,{complete:BX.delegate(this.finish,this)});t.run()},this)});t.animate();if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}},finish:function(){this._node.style.position="";this._node.style.width="";this._node.style.height="";this._node.style.top="";this._node.style.left="";this._node.style.opacity="";this._node.style.zIndex="";this._anchor.style.height="";this._anchor.parentNode.insertBefore(this._node,this._anchor.nextSibling);setTimeout(BX.delegate(function(){BX.removeClass(this._node,"crm-entity-stream-section-animate-start");BX.remove(this._anchor)},this),0)}};BX.CrmCommentAnimation.create=function(t,e,i,r){var n=new BX.CrmCommentAnimation;n.initialize(t,e,i,r);return n}}if(typeof BX.CrmTimelineItemFasten==="undefined"){BX.CrmTimelineItemFasten=function(){this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null};BX.CrmTimelineItemFasten.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},addFixedHistoryItem:function(){var t=this._finalItem.getWrapper();BX.addClass(t,"crm-entity-stream-section-animate-start");this._anchor.parentNode.insertBefore(t,this._anchor.nextSibling);setTimeout(BX.delegate(function(){BX.removeClass(t,"crm-entity-stream-section-animate-start")},this),0);this._finalItem.onFinishFasten()},run:function(){var t=this._initialItem.getWrapper();this._clone=t.cloneNode(true);BX.addClass(this._clone,"crm-entity-stream-section-animate-start crm-entity-stream-section-top-fixed");this._startPosition=BX.pos(t);this._clone.style.position="absolute";this._clone.style.width=this._startPosition.width+"px";var e=this._startPosition.height;var i=65;var r=18;if(e<r+i)e=r+i;this._clone.style.height=e+"px";this._clone.style.top=this._startPosition.top+"px";this._clone.style.left=this._startPosition.left+"px";this._clone.style.zIndex=1100;document.body.appendChild(this._clone);setTimeout(BX.proxy(function(){BX.addClass(this._clone,"crm-entity-stream-section-casper")},this),0);this._anchorPosition=BX.pos(this._anchor);var n={top:this._anchorPosition.top,height:e+15,opacity:1};var s=this._startPosition.top-this._anchorPosition.bottom;var a=2*(document.body.clientHeight+this._startPosition.height);if(s>a){n.top=this._startPosition.top-a;n.opacity=0}var o=Math.abs(n.top-this._startPosition.top)*2;o=o<1500?1500:o;var c=new BX.easing({duration:o,start:{top:this._startPosition.top,height:0,opacity:1},finish:n,transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy(function(t){this._clone.style.top=t.top+"px";this._clone.style.opacity=t.opacity;this._anchor.style.height=t.height+"px"},this),complete:BX.proxy(function(){this.finish()},this)});c.animate()},finish:function(){this._anchor.style.height=0;this.addFixedHistoryItem();BX.remove(this._clone);if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}}};BX.CrmTimelineItemFasten.create=function(t,e){var i=new BX.CrmTimelineItemFasten;i.initialize(t,e);return i}}if(typeof BX.CrmTimelineMenuBar==="undefined"){BX.CrmTimelineMenuBar=function(){this._id="";this._ownerInfo=null;this._container=null;this._items=null;this._moreButton=null;this._activityEditor=null;this._commentEditor=null;this._waitEditor=null;this._smsEditor=null;this._readOnly=false;this._menu=null;this._isMenuShown=false;this._manager=null};BX.CrmTimelineMenuBar.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._ownerInfo=BX.prop.getObject(this._settings,"ownerInfo");if(!this._ownerInfo){throw"BX.CrmTimelineMenuBar. A required parameter 'ownerInfo' is missing."}this._activityEditor=BX.prop.get(this._settings,"activityEditor",null);this._commentEditor=BX.prop.get(this._settings,"commentEditor");this._waitEditor=BX.prop.get(this._settings,"waitEditor");this._smsEditor=BX.prop.get(this._settings,"smsEditor");this._restEditor=BX.prop.get(this._settings,"restEditor");this._manager=BX.prop.get(this._settings,"manager");if(!(this._manager instanceof BX.CrmTimelineManager)){throw"BX.CrmTimeline. Manager instance is not found."}this._container=BX.prop.getElementNode(this._settings,"container");if(!this._container){throw"BX.CrmTimelineMenuBar. A required parameter 'container' is missing."}this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);this._items=[];var i=this._container.querySelectorAll(".crm-entity-stream-section-new-action");for(var r=0,n=i.length;r<n;r++){var s=i[r];var a=BX.CrmTimelineMenuBarItem.create(s.getAttribute("data-item-id"),{container:s,owner:this});this._items.push(a)}this._moreButton=this._container.querySelector(".crm-entity-stream-section-new-action-more");if(this._moreButton){BX.bind(this._moreButton,"click",BX.delegate(this.onMoreButtonClick,this))}this.adjust();BX.bind(window,"resize",BX.delegate(this.onResize,this))},getId:function(){return this._id},getItemById:function(t){for(var e=0,i=this._items.length;e<i;e++){var r=this._items[e];if(r.getId()===t){return r}}return null},setActiveItemById:function(t){for(var e=0,i=this._items.length;e<i;e++){var r=this._items[e];r.setActive(r.getId()===t)}},setActiveItem:function(t){for(var e=0,i=this._items.length;e<i;e++){var r=this._items[e];r.setActive(r===t)}},adjust:function(){if(this._moreButton){this._moreButton.style.display=this.getInvisibleItems().length>0?"":"none"}},processItemSelection:function(t){if(this._readOnly){return}var e=null;var i=t.getId();if(i==="call"){e=new BX.Crm.Activity.Planner;e.showEdit({TYPE_ID:BX.CrmActivityType.call,OWNER_TYPE_ID:this._ownerInfo["ENTITY_TYPE_ID"],OWNER_ID:this._ownerInfo["ENTITY_ID"]})}if(i==="meeting"){e=new BX.Crm.Activity.Planner;e.showEdit({TYPE_ID:BX.CrmActivityType.meeting,OWNER_TYPE_ID:this._ownerInfo["ENTITY_TYPE_ID"],OWNER_ID:this._ownerInfo["ENTITY_ID"]})}else if(i==="email"){this._activityEditor.addEmail({ownerType:this._ownerInfo["ENTITY_TYPE_NAME"],ownerID:this._ownerInfo["ENTITY_ID"],ownerUrl:this._ownerInfo["SHOW_URL"],ownerTitle:this._ownerInfo["TITLE"],subject:""})}else if(i==="task"){this._activityEditor.addTask({ownerType:this._ownerInfo["ENTITY_TYPE_NAME"],ownerID:this._ownerInfo["ENTITY_ID"]})}else if(i==="comment"&&this._commentEditor){if(this._waitEditor){this._waitEditor.setVisible(false)}if(this._smsEditor){this._smsEditor.setVisible(false)}this._commentEditor.setVisible(true);this.setActiveItem(t)}else if(i==="wait"&&this._waitEditor){if(this._commentEditor){this._commentEditor.setVisible(false)}if(this._smsEditor){this._smsEditor.setVisible(false)}this._waitEditor.setVisible(true);this.setActiveItem(t)}else if(i==="sms"&&this._smsEditor){if(this._commentEditor){this._commentEditor.setVisible(false)}if(this._waitEditor){this._waitEditor.setVisible(false)}this._smsEditor.setVisible(true);this.setActiveItem(t)}else if(i==="visit"){var r=this._manager.getSetting("visitParameters");r["OWNER_TYPE"]=this._ownerInfo["ENTITY_TYPE_NAME"];r["OWNER_ID"]=this._ownerInfo["ENTITY_ID"];BX.CrmActivityVisit.create(r).showEdit()}else if(i.match(/^activity_rest_/)){if(this._restEditor){this._restEditor.action(i)}}},getInvisibleItems:function(){var t=[];for(var e=0,i=this._items.length;e<i;e++){var r=this._items[e];if(!r.isVisible()){t.push(r)}}return t},openMenu:function(){var t=this.getInvisibleItems();if(t.length===0){return}var e=BX.delegate(this.onMenuItemSelect,this);var i=[];for(var r=0,n=t.length;r<n;r++){var s=t[r];i.push({id:s.getId(),text:s.getTitle(),onclick:e})}BX.PopupMenu.show(this._id,this._moreButton,i,{offsetTop:0,offsetLeft:16,angle:{position:"top",offset:0},events:{onPopupShow:BX.delegate(this.onContextMenuShow,this),onPopupClose:BX.delegate(this.onContextMenuClose,this),onPopupDestroy:BX.delegate(this.onContextMenuDestroy,this)}});this._menu=BX.PopupMenu.currentItem},closeMenu:function(){if(this._menu){this._menu.close()}},onMoreButtonClick:function(t){if(!this._isMenuShown){this.openMenu()}else{this.closeMenu()}t.preventDefault?t.preventDefault():t.returnValue=false},onMenuItemSelect:function(t,e){var i=this.getItemById(e.id);if(i){this.processItemSelection(i)}this.closeMenu()},onContextMenuShow:function(){this._isMenuShown=true},onContextMenuClose:function(){if(this._menu){this._menu.popupWindow.destroy()}},onContextMenuDestroy:function(){this._isMenuShown=false;this._menu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}},onResize:function(t){if(this._isMenuShown){this.closeMenu()}this.adjust()}};BX.CrmTimelineMenuBar.create=function(t,e){var i=new BX.CrmTimelineMenuBar;i.initialize(t,e);return i}}if(typeof BX.CrmTimelineMenuBarItem==="undefined"){BX.CrmTimelineMenuBarItem=function(){this._id="";this._owner=null;this._container=null;this._isActive=false};BX.CrmTimelineMenuBarItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container");if(!this._container){throw"BX.CrmTimelineMenuBarItem. Container node is not found."}BX.bind(this._container,"click",BX.delegate(this.onClick,this));this._isActive=BX.hasClass(this._container,"crm-entity-stream-section-new-action-active");this._owner=BX.prop.get(this._settings,"owner");if(!this._owner){throw"BX.CrmTimelineMenuBarItem. Owner is not found."}},getId:function(){return this._id},isActive:function(){return this._isActive},setActive:function(t){t=!!t;this._isActive=t;if(t){BX.addClass(this._container,"crm-entity-stream-section-new-action-active")}else{BX.removeClass(this._container,"crm-entity-stream-section-new-action-active")}},isVisible:function(){return this._container.offsetTop===0},getTitle:function(){var t=this._container.getAttribute("data-item-title");if(!BX.type.isNotEmptyString(t)){t=this._container.innerHTML}return BX.util.htmlspecialcharsback(t)},onClick:function(t){this._owner.processItemSelection(this);t.preventDefault?t.preventDefault():t.returnValue=false}};BX.CrmTimelineMenuBarItem.create=function(t,e){var i=new BX.CrmTimelineMenuBarItem;i.initialize(t,e);return i}}if(typeof BX.CrmSmsWatcher==="undefined"){BX.CrmSmsWatcher={_pullTagName:"MESSAGESERVICE",_pullInited:false,_listeners:{},initPull:function(){if(this._pullInited)return;BX.addCustomEvent("onPullEvent-messageservice",this.onPullEvent.bind(this));this.extendWatch();this._pullInited=true},subscribeOnMessageUpdate:function(t,e){this.initPull();this._listeners[t]=e},fireExternalStatusUpdate:function(t,e){var i=this._listeners[t];if(i){i(e)}},onPullEvent:function(t,e){if(t==="message_update"){for(var i=0;i<e.messages.length;++i){var r=e.messages[i];this.fireExternalStatusUpdate(r["ID"],r)}}},extendWatch:function(){if(BX.type.isFunction(BX.PULL)){BX.PULL.extendWatch(this._pullTagName);window.setTimeout(this.extendWatch.bind(this),6e4)}}}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.post.form/templates/.default/script.min.js?154412738466246";s:6:"source";s:69:"/bitrix/components/bitrix/main.post.form/templates/.default/script.js";s:3:"min";s:73:"/bitrix/components/bitrix/main.post.form/templates/.default/script.min.js";s:3:"map";s:73:"/bitrix/components/bitrix/main.post.form/templates/.default/script.map.js";}"*/
(function(){if(window["LHEPostForm"])return;var e={controller:{},handler:{}};BX.addCustomEvent(window,"BFileDLoadFormControllerWasBound",function(t){e.controller[t.id]=true});BX.addCustomEvent(window,"WDLoadFormControllerInit",function(t){e.controller[t.CID]=t});BX.addCustomEvent(window,"WDLoadFormControllerWasBound",function(t){e.controller[t.CID]=true});BX.addCustomEvent(window,"DiskDLoadFormControllerInit",function(t){e.controller[t.CID]=t});BX.addCustomEvent(window,"DiskLoadFormControllerWasBound",function(t){e.controller[t.CID]=true});BX.addCustomEvent(window,"OnEditorInitedBefore",function(t){if(e.handler[t.id]){t.__lhe_flags=["OnEditorInitedBefore"];if(e.handler[t.id]["params"]&&e.handler[t.id]["params"]["LHEJsObjName"])window[e.handler[t.id].params["LHEJsObjName"]]=t;e.handler[t.id].OnEditorInitedBefore(t)}});var t=function(t){if(e.handler[t.id]&&e.handler[t.id].editorIsLoaded!==true){e.handler[t.id].editorIsLoaded=true;e.handler[t.id].exec();BX.onCustomEvent(e.handler[t.id],"OnEditorIsLoaded",[e.handler[t.id],t])}};BX.addCustomEvent(window,"OnCreateIframeAfter",t);BX.addCustomEvent(window,"OnEditorInitedAfter",function(i,n){if(e.handler[i.id]){i.__lhe_flags.push("OnEditorInitedAfter");e.handler[i.id].OnEditorInitedAfter(i);if(e.handler[i.id].editorIsLoaded!==true&&n&&i.sandbox&&i.sandbox.inited)t.apply(i,[i])}});BX.util.object_search=function(e,t){for(var i in t){if(t.hasOwnProperty(i)){if(t[i]==e)return true;else if(typeof t[i]=="object"&&t[i]!==null){var n=BX.util.object_search_key(e,t[i]);if(n!==false)return n}}}return false};var i=function(e,t,i){i=i&&i.length>0?i:[];if(typeof t=="object"&&t.length>0){var n;while((n=t.pop())&&n&&t.length>0){i.push(n)}t=n}i.push(t);this.exist=true;this.bxTag=e;this.tag=t;this.tags=i;this.regexp=new RegExp("\\[("+i.join("|")+")=((?:\\s|\\S)*?)(?:\\s*?WIDTH=(\\d+)\\s*?HEIGHT=(\\d+))?\\]","ig");this.code="["+t+"=#ID##ADDITIONAL#]";this.wysiwyg='<span style="color: #2067B0; border-bottom: 1px dashed #2067B0; margin:0 2px;" id="#ID#"#ADDITIONAL#>#NAME#</span>'},n=function(t,i,n){this.CID=this.id=i;this.parser=t.parser["disk_file"]||null;this.params=n;this.node=BX("diskuf-selectdialog-"+i);this.handler=e.controller[i];this.manager=t;this.eventNode=this.manager.eventNode;this.parserName="disk_file";this.prefixNode="disk-edit-attach";this.prefixHTMLNode="disk-attach-";this.props={valueEditClassName:"wd-inline-file",securityCID:"disk-upload-cid"};this.storage="disk";this.fileToAttach={};this.xmlToAttach={};this.events={onInit:"DiskDLoadFormControllerInit",onShow:"DiskLoadFormController",onBound:"DiskLoadFormControllerWasBound"}};n.prototype={parser:false,eventNode:null,values:{},initialized:false,functionsToExec:[],exec:function(e,t){if(typeof e=="function")this.functionsToExec.push([e,t]);if(this.handler&&this.handler!==true){var i;while((i=this.functionsToExec.shift())&&i)i[0].apply(this,i[1])}},init:function(){if(this.initialized!==true){this.values={};this.functionsToExec=[];this.initialized=true;this.bindMainEvents(this.manager);if(this.parser!==null){this.bindEvents(this.manager);return this.initValues()}}return false},initValues:function(){var e=BX.findChildren(this.node,{className:this.props.valueEditClassName},true);if(e&&e.length>0){this.exec(this.runCheckText);return true}return false},bindMainEvents:function(t){var i=null;BX.addCustomEvent(t.eventNode,"onReinitializeBefore",BX.proxy(this.clean,this));BX.addCustomEvent(t.eventNode,"onShowControllers",BX.proxy(function(e){i=e;BX.onCustomEvent(t.eventNode,this.events.onShow,[e])},this));if(!e.controller[this.id]){var o=BX.delegate(function(e){if(e["UID"]==this.id||e["id"]==this.id){if(i==="show"||i==="hide"){BX.onCustomEvent(t.eventNode,this.events.onShow,[i]);i=null}BX.removeCustomEvent(window,this.events.onBound,o)}},this);BX.addCustomEvent(window,this.events.onBound,o)}if(BX["DD"]&&this.storage=="disk"){var a=BX.delegate(function(e){if((e["UID"]==this.id||e["id"]==this.id)&&this.manager["dropZoneExists"]!==true){BX.removeCustomEvent(window,this.events.onBound,a);this.manager["dropZoneExists"]=true;var i=this.eventNode,o=this.id;n.dndCatcher=n.dndCatcher||{};n.dndCatcher[o]={catch:true,files:[],dropZone:null,dropZoneMicro:null,initdrag:BX.delegate(function(){n.dndCatcher[o].dropZone=new BX.DD.dropFiles(t.eventNode);BX.addCustomEvent(t.eventNode,"OnImageDataUriHandle",BX.delegate(function(e,t){if(BX["UploaderUtils"]){var i=BX.UploaderUtils.dataURLToBlob(t.src);if(i&&i.size>0&&i.type.indexOf("image/")==0){i.name=i.name||t.title||"image."+i.type.substr(6);i.referrerToEditor=t;if(n.dndCatcher[o]["catch"]===true)n.dndCatcher[o]["drop"]([i]);else if(this.handler&&this.handler["addFile"])this.handler.addFile(i);BX.onCustomEvent(e,"OnImageDataUriCaught",[t])}}},this));BX.addCustomEvent(n.dndCatcher[o].dropZone,"dropFiles",n.dndCatcher[o]["drop"]);BX.addCustomEvent(n.dndCatcher[o].dropZone,"dragEnter",n.dndCatcher[o]["dragover"]);BX.addCustomEvent(n.dndCatcher[o].dropZone,"dragLeave",n.dndCatcher[o]["dragleave"]);if(BX("micro"+t.__divId)){n.dndCatcher[o].dropZoneMicro=new BX.DD.dropFiles(BX("micro"+t.__divId));BX.addCustomEvent(n.dndCatcher[o].dropZoneMicro,"dragEnter",function(){BX.onCustomEvent(t.eventNode,"OnShowLHE",["justShow"])})}BX.unbind(document,"dragover",n.dndCatcher[o]["initdrag"]);BX.onCustomEvent(t.eventNode,"onDropZoneExists",[])},this),dragover:BX.delegate(function(){BX.addClass(t.eventNode,"feed-add-post-dnd-over");BX.onCustomEvent(t.eventNode,"dragover",[])},this),dragleave:BX.delegate(function(){BX.removeClass(t.eventNode,"feed-add-post-dnd-over");BX.onCustomEvent(t.eventNode,"dragleave",[])},this),dragenterwindow:BX.delegate(function(){BX.addClass(t.eventNode,"feed-add-post-dnd-ready");if(BX("micro"+t.__divId)){BX.addClass(BX("micro"+t.__divId),"feed-add-post-micro-dnd-ready")}BX.onCustomEvent(t.eventNode,"dragenterwindow",[])},this),dragleavewindow:BX.delegate(function(e){BX.removeClass(t.eventNode,"feed-add-post-dnd-ready");if(BX("micro"+t.__divId)){BX.removeClass(BX("micro"+t.__divId),"feed-add-post-micro-dnd-ready")}BX.onCustomEvent(t.eventNode,"dragleavewindow",[])},this),drop:BX.delegate(function(e){BX.onCustomEvent(t.eventNode,"drop",[]);BX.onCustomEvent(window,"dragWindowLeave");BX.onCustomEvent(window,"__dragWindowLeave");var i=0;if(e&&e.length>0){if(n.dndCatcher[o]["catch"]===true){n.dndCatcher[o].files=e;i=1}else{i=2}BX.onCustomEvent(t.eventNode,this.events.onShow,["show"]);BX.removeClass(t.eventNode,"feed-add-post-dnd-ready feed-add-post-dnd-over")}return i},this)};BX.ready(function(){n.dndCatcher[o]["initdrag"]()});BX.addCustomEvent(i,"OnIframeDrop",BX.delegate(function(e){BX.PreventDefault(e);if(e["dataTransfer"]&&e["dataTransfer"]["files"]){if(n.dndCatcher[o].drop(e["dataTransfer"]["files"])===2){this.handler.agent.onChange(e["dataTransfer"]["files"])}}},this));BX.addCustomEvent(i,"OnIframeDragOver",n.dndCatcher[o].dragover);BX.addCustomEvent(i,"OnIframeDragLeave",n.dndCatcher[o].dragleave);if(!window["bxMpfDndCatcher"]){window["bxMpfDndCatcher"]=true;var s=false,r=function(){if(s===false){s=true;BX.bind(document,"dragleave",l);BX.bind(document,"dragover",l);BX.bind(document,"mouseout",d);BX.onCustomEvent(window,"dragWindowEnter")}},d=function(e){BX.unbind(document,"dragleave",l);BX.unbind(document,"dragover",l);BX.unbind(document,"mouseout",d);s=false;BX.onCustomEvent(window,"dragWindowLeave")},l=function(e){if(h>0){clearTimeout(h);h=0}BX.fixEventPageXY(e);var t=true;if(e.pageX>0&&e.pageY>0){var i=BX.GetWindowSize();if(e.pageY<i.scrollHeight&&e.pageX<i.scrollWidth){var n=e.pageY-i.scrollTop,o=e.pageX-i.scrollLeft;if(0<n&&n<i.innerHeight-20&&0<o&&o<i.innerWidth-20){t=false}}}if(t){d(e)}else{h=setTimeout(function(){l({type:"intervalLimit"})},100)}},h=0;BX.bind(document,"dragenter",function(e){if(window["bxMpfDndCatcher"]>0){clearTimeout(window["bxMpfDndCatcher"])}var t=true;if(e&&e["dataTransfer"]&&e["dataTransfer"]["types"]){for(var i=0;i<e["dataTransfer"]["types"].length;i++){if(e["dataTransfer"]["types"][i]=="Files"){t=true;break}}}if(t){r()}});BX.addCustomEvent(window,"__dragWindowLeave",d);BX.bind(document,"dragover",function(e){return BX.PreventDefault(e)});BX.bind(document,"drop",function(e){d(e);return BX.PreventDefault(e)})}BX.addCustomEvent(window,"dragWindowEnter",n.dndCatcher[o].dragenterwindow);BX.addCustomEvent(window,"dragWindowLeave",n.dndCatcher[o].dragleavewindow);this.__initCatcher=BX.delegate(function(e,i){if(e==this.id){BX.removeCustomEvent(t.eventNode,"onControllerInitialized",this.__initCatcher);i.agent.initDropZone(t.eventNode);if(n.dndCatcher[e].files.length>0){i.agent.onChange(n.dndCatcher[e].files);n.dndCatcher[e].files=[]}n.dndCatcher[e]["catch"]=false;this.__initCatcher=null}},this);BX.addCustomEvent(t.eventNode,"onControllerInitialized",this.__initCatcher)}},this);BX.addCustomEvent(window,this.events.onBound,a);if(e.controller[this.id])a(e.controller[this.id])}},bindEvents:function(e){this._catchHandler=BX.delegate(function(t){BX.removeCustomEvent(this.eventNode,this.events.onInit,this._catchHandler);this.handler=t;var i=BX.findChild(BX(e.formID),{attr:{id:this.props.securityCID}},true,false);if(i)i.value=this.handler.CID;this.exec();var n=BX.delegate(function(){BX.onCustomEvent(e.eventNode,"onUploadsHasBeenChanged",arguments)},this);BX.addCustomEvent(this.handler.agent,"onFileIsInited",n);BX.addCustomEvent(this.handler.agent,"ChangeFileInput",n);BX.onCustomEvent(e.eventNode,"onControllerInitialized",[this.id,t])},this);if(typeof this.handler!="object"||!this.handler)BX.addCustomEvent(e.eventNode,this.events.onInit,this._catchHandler);else this._catchHandler(this.handler);BX.addCustomEvent(e.eventNode,"OnFileUploadSuccess",BX.delegate(function(e,t,i){if(this.id==t.CID||this.id==t.id){i=i||{};i.usePostfix=true;this.addFile(e,i,t)}},this));BX.addCustomEvent(e.eventNode,"OnFileUploadFailed",BX.delegate(function(e,t,i){if(this.id==t.CID||this.id==t.id){this.failFile(e,i,t)}},this));BX.addCustomEvent(e.eventNode,"OnFileUploadRemove",BX.delegate(function(e,t){if(this.id==t.CID||this.id==t.id){this.deleteFile(e,{usePostfix:true},t)}},this));BX.addCustomEvent(this,"onFileIsInText",BX.proxy(function(e,t){this.adjustFile(this.checkFile(e),t)},this))},addFile:function(e,t,i){var n=this.checkFile(e.element_id,e,t);if(n){setTimeout(BX.proxy(function(){this.bindFile(n);this.adjustFile(n,false)},this),100);BX.onCustomEvent(this.eventNode,"onFileIsAdded",[n,this,i,t])}else{this.failFile(this,t,i)}return true},failFile:function(e,t,i){BX.onCustomEvent(this.eventNode,"onFileIsFailed",[this,i,t])},checkFile:function(e,t){e=""+(typeof e=="object"?e.id:e);if(typeof t=="object"&&t!==null&&e&&t.element_name&&BX(t.place)){var i={id:e,name:t.element_name,url:t.element_url,type:"isnotimage/xyz",isImage:false,place:BX(t.place,true),xmlID:BX(t.place,true).getAttribute("bx-attach-xml-id"),fileID:BX(t.place,true).getAttribute("bx-attach-file-id"),fileType:BX(t.place,true).getAttribute("bx-attach-file-type")},n;if(/(\.png|\.jpg|\.jpeg|\.gif|\.bmp)$/i.test(t.element_name)&&(n=BX.findChild(i.place,{className:"files-preview",tagName:"IMG"},true,false))&&n){i.type="image/xyz";i.lowsrc=n.src;i.element_url=i.src=n.src.replace(/\Wwidth=(\d+)/,"").replace(/\Wheight=(\d+)/,"");i.isImage=true;i.width=parseInt(n.getAttribute("data-bx-full-width")||n.getAttribute("data-bx-width"));i.height=parseInt(n.getAttribute("data-bx-full-height")||n.getAttribute("data-bx-height"))}if(i.xmlID)this.xmlToAttach[i.xmlID+""]=e;if(i.fileID)this.fileToAttach[i.fileID+""]=e;this.values[e]=i}return this.values[e]||false},bindFile:function(e){var t=e.place;if(typeof e=="object"&&t&&!t.hasAttribute("bx-file-is-bound")){var i=BX.findChild(t,{className:"f-wrap"},true,false),n=BX.findChild(t,{className:"files-preview"},true,false);if(i){BX.bind(i,"click",BX.delegate(function(){this.insertFile(e.id)},this));i.style.cursor="pointer";i.title=BX.message("MPF_FILE")}if(n){BX.bind(n,"click",BX.delegate(function(){this.insertFile(e.id)},this))}}},adjustFile:function(e,t){var i=e.place;if(t===true||t===false){if(!e.info)e.info=BX.findChild(e.place,{className:"files-info"},true,false);i=e.info;if(BX.type.isDomNode(i)){var n="check-in-text-"+e.id,o=BX(n),a=t===false?{attrs:{"bx-file-is-in-text":"N"},props:{className:"insert-btn"},html:'<span class="insert-btn-text">'+BX.message("MPF_FILE_INSERT_IN_TEXT")+"</span>"}:{attrs:{"bx-file-is-in-text":"Y"},props:{className:"insert-text"},html:'<span class="insert-btn-text">'+BX.message("MPF_FILE_IN_TEXT")+"</span>"};if(!o){a.attrs.id=n;a.events={click:BX.proxy(function(){this.insertFile(e.id)},this)};i.appendChild(BX.create("SPAN",a))}else{BX.adjust(o,a)}}}},insertFile:function(e){BX.onCustomEvent(this.eventNode,"onFileIsInserted",[this.checkFile(e),this])},deleteFile:function(e,t){e=this.checkFile(e,t);if(e){BX.onCustomEvent(this.eventNode,"onFileIsDeleted",[e,this]);this.values[e.id].place=null;delete this.values[e.id].place;this.values[e.id]=null;delete this.values[e.id];e=null;return true}return false},reinitValues:function(e,t){var i,n,o={};while((i=t.pop())&&i){n=BX(this.prefixHTMLNode+i);n=n?n.tagName=="A"?n:BX.findChild(n,{tagName:"IMG"},true):null;if(n){o["E"+i]={type:"file",id:i,name:n.getAttribute("data-bx-title")||n.getAttribute("data-title"),size:n.getAttribute("data-bx-size")||"",sizeInt:n.getAttribute("data-bx-size")||"",width:n.getAttribute("data-bx-width"),height:n.getAttribute("data-bx-height"),storage:"disk",previewUrl:n.tagName=="A"?"":n.getAttribute("data-bx-src")||n.getAttribute("data-src"),fileId:n.getAttribute("bx-attach-file-id")};if(n.hasAttribute("bx-attach-xml-id"))o["E"+i]["xmlId"]=n.getAttribute("bx-attach-xml-id");if(n.hasAttribute("bx-attach-file-type"))o["E"+i]["fileType"]=n.getAttribute("bx-attach-file-type")}}this.handler.selectFile({},{},o);this.runCheckText()},runCheckText:function(){if(!this._checkText)this._checkText=BX.delegate(this.checkText,this);this.manager.exec(this._checkText)},checkText:function(){var e,t=this.manager.getContent(),i=[],n,o;if(t!=""){e=t;for(o in this.xmlToAttach){if(this.xmlToAttach.hasOwnProperty(o)){t=t.replace(new RegExp("\\&\\#91\\;DOCUMENT ID=("+o+")([WIDTHHEIGHT=0-9 ]*)\\&\\#93\\;","gim"),"["+this.parser["tag"]+"="+this.xmlToAttach[o]+"$2]").replace(new RegExp("\\[DOCUMENT ID=("+o+")([WIDTHHEIGHT=0-9 ]*)\\]","gim"),"["+this.parser["tag"]+"="+this.xmlToAttach[o]+"$2]")}}for(o in this.fileToAttach){if(this.fileToAttach.hasOwnProperty(o)){t=t.replace(new RegExp("\\&\\#91\\;"+this.parser["tag"]+"=("+o+")([WIDTHHEIGHT=0-9 ]*)\\&\\#93\\;","gim"),"["+this.parser["tag"]+"="+this.fileToAttach[o]+"$2]").replace(new RegExp("\\["+this.parser["tag"]+"=("+o+")([WIDTHHEIGHT=0-9 ]*)\\]","gim"),"["+this.parser["tag"]+"="+this.fileToAttach[o]+"$2]")}}n=new RegExp("(?:\\&\\#91\\;)("+this.parser["tags"].join("|")+")=([a-z=0-9 ]+)(?:\\&\\#93\\;)","gim");if(n.test(t)){for(o in this.values){if(this.values.hasOwnProperty(o)){i.push(o)}}if(i.length>0){n=new RegExp("(?:\\&\\#91\\;|\\[)("+this.parser["tags"].join("|")+")=("+i.join("|")+")([WIDTHHEIGHT=0-9 ]*)(?:\\&\\#93\\;|\\])","gim");if(n.test(t))t=t.replace(n,BX.delegate(function(e,t,i,n){return"["+t+"="+i+n+"]"},this))}}if(e!=t)BX.onCustomEvent(this.eventNode,"onFileIsDetected",[t,this])}return t},clean:function(){if(this.handler&&this.handler.values){var e,t,i,n=BX(this.manager.formID);while((e=this.handler.values.pop())&&e){BX.remove(e)}if(this.handler.params&&this.handler.params.controlName){t=BX.findChildren(n,{tagName:"INPUT",attribute:{name:this.handler.params.controlName}},true)}if(t){for(i=0;i<t.length;i++){BX.remove(t[i])}}}},reinit:function(e,t){var i=[],n,o;for(n in t){if(t.hasOwnProperty(n)){if(t[n]["USER_TYPE_ID"]==this.parserName&&t[n]["VALUE"]){for(o in t[n]["VALUE"]){if(t[n]["VALUE"].hasOwnProperty(o)){i.push(t[n]["VALUE"][o])}}}}}if(i.length>0){this.exec(this.reinitValues,[e,i]);return true}return false}};var o=function(e,t,i){o.superclass.constructor.apply(this,arguments);this.parser=e.parser["webdav_element"]||null;this.node=BX("wduf-selectdialog-"+t);this.manager=e;this.parserName="webdav_element";this.prefixNode="wd-doc";this.prefixHTMLNode="wdif-doc-";this.storage="webdav";this.events={onInit:"WDLoadFormControllerInit",onShow:"WDLoadFormController",onBound:"WDLoadFormControllerWasBound"}};BX.extend(o,n);o.prototype.reinitValues=function(e,t){var i,n,o={};this.waitAnswerFromServer=[];while((i=t.pop())&&i){n=BX(this.prefixHTMLNode+i);n=n?n.tagName=="A"?n:BX.findChild(n,{tagName:"IMG"},true):null;if(n){o["E"+i]={type:"file",id:i,name:n.getAttribute("alt"),storage:"webdav",size:n.getAttribute("data-bx-size"),sizeInt:1,ext:"",link:n.getAttribute("data-bx-document")};if(n.hasAttribute("bx-attach-xml-id"))o["E"+i]["xmlId"]=n.getAttribute("bx-attach-xml-id");this.waitAnswerFromServer.push(i)}}if(this.waitAnswerFromServer.length>0){if(!this._defferCheckText)this._defferCheckText=BX.delegate(this.defferCheckText,this);BX.addCustomEvent(this.eventNode,"OnFileUploadSuccess",this._defferCheckText);this.handler.WDFD_SelectFile({},{},o)}};o.prototype.defferCheckText=function(e){var t=BX.util.array_search(e.element_id,this.waitAnswerFromServer);if(t>=0){this.runCheckText();this.waitAnswerFromServer=BX.util.deleteFromArray(this.waitAnswerFromServer,t)}if(this.waitAnswerFromServer.length<=0)BX.removeCustomEvent(this.eventNode,"OnFileUploadSuccess",this._defferCheckText)};var a=function(e,t,i){a.superclass.constructor.apply(this,arguments);this.parser=e.parser["file"]?e.parser["file"]:e.parser["postimage"]["exist"]?e.parser["postimage"]:null;this.postfix=i["postfix"]||"";this.node=BX("file-selectdialog-"+t);this.parserName="file";this.prefixNode="wd-doc";this.prefixHTMLNode="file-doc-";this.props={valueEditClassName:"file-inline-file",securityCID:"upload-cid"};this.storage="bfile";this.events={onInit:"BFileDLoadFormControllerInit",onShow:"BFileDLoadFormController",onBound:"BFileDLoadFormControllerWasBound"}};BX.extend(a,n);a.prototype.initValues=function(e){var t;if(e!==true){t=BX.findChildren(this.node,{className:this.props.valueEditClassName},true);if(t&&t.length>1){this.exec(this.initValues,[true]);return true}return false}t=this.handler.agent.values||[];var i,n,o,a,s={},r="/bitrix/components/bitrix/main.file.input/file.php?mfi_mode=down&cid="+this.handler.CID+"&sessid="+BX.bitrix_sessid();for(var d=0;d<t.length;d++){a=parseInt(t[d].getAttribute("id").replace(this.prefixNode,""));if(s["id"+a])continue;s["id"+a]="Y";if(a>0){n=BX.findChild(t[d],{className:"f-wrap"},true,false);if(!n)continue;o={element_id:a,element_name:n.innerHTML,parser:this.parser.bxTag,storage:"bfile",element_url:r+"&fileID="+a};i=this.addFile(o,{usePostfix:true,hasPreview:false})}}this.runCheckText();return true};a.prototype.checkFile=function(e,t,i){e=""+(typeof e=="object"?e.id:e);e=e+(i&&i["usePostfix"]===true?this.postfix:"");if(typeof t=="object"&&t!==null&&e&&t.element_name&&BX(this.prefixNode+t.element_id,true)){var n={id:e,name:t.element_name,url:t.element_url,type:"isnotimage/xyz",isImage:false,place:BX(this.prefixNode+t.element_id,true)},o;if((t["element_type"]&&t["element_type"].indexOf("image/")===0||/(\.png|\.jpg|\.jpeg|\.gif|\.bmp)$/i.test(t.element_name))&&((o=BX.findChild(n.place,{tagName:"IMG"},true,false))&&o||i&&i["hasPreview"]===false)){n.type="image/xyz";n.src=t["element_thumbnail"]||t["element_url"];n.isImage=true;n.hasPreview=false;n.lowsrc="";n.width="";n.height="";if(BX(o)){n.hasPreview=true;n.lowsrc=t["element_thumbnail"]||o["src"];n.width=parseInt(o.getAttribute("data-bx-full-width"));n.height=parseInt(o.getAttribute("data-bx-full-height"))}}else if(this.parser.bxTag=="postimage"){return false}if(BX(n.place,true).getAttribute("bx-attach-file-type")){n.fileType=BX(n.place,true).getAttribute("bx-attach-file-type")}this.values[e]=n}return this.values[e]||false};a.prototype.bindFile=function(e){var t=e&&e["place"]?e["place"]:null;if(typeof e=="object"&&t&&!t.hasAttribute("bx-file-is-bound")){if(e.isImage&&e.hasPreview){var i=BX.findChild(t,{className:"feed-add-img-title"},true,false),n=BX.findChild(t,{className:"feed-add-img-wrap"},true,false);if(n){BX.bind(n,"click",BX.proxy(function(){this.insertFile(e)},this));n.style.cursor="pointer";n.title=BX.message("MPF_IMAGE")}if(i){BX.bind(i,"click",BX.delegate(function(){this.insertFile(e)},this));i.style.cursor="pointer";i.title=BX.message("MPF_IMAGE")}}else a.superclass.bindFile.apply(this,arguments)}};a.prototype.clean=function(){a.superclass.clean.apply(this,arguments);if(this["handler"]&&this.handler["agent"]&&this.handler.agent["inputName"]){var e,t,i=BX(this.manager.formID);e=BX.findChildren(i,{tagName:"INPUT",attribute:{name:this.handler.agent.inputName+"[]"}},true);if(e){for(t=0;t<e.length;t++){BX.remove(e[t])}}}};var s=function(t,i){this.params=i;this.formID=t;this.showPinButton=!!BX("lhe_button_editor_"+this.formID);if(this.showPinButton){this.params.showPanelEditor=!!this.params.pinEditorPanel}this.oEditorId=i["LHEJsObjId"];this.__divId=i["LHEJsObjName"]||i["LHEJsObjId"];e.handler[this.oEditorId]=this;this.oEditor=s.getEditor(this.oEditorId);this.urlPreview=this.initUrlPreview(i);this.eventNode=BX("div"+this.__divId);BX.addCustomEvent(this.eventNode,"OnShowLHE",BX.delegate(this.OnShowLHE,this));BX.addCustomEvent(this.eventNode,"OnButtonClick",BX.delegate(this.OnButtonClick,this));BX.addCustomEvent(this.eventNode,"OnAfterShowLHE",function(e,t){if(t.oEditor&&t.oEditor["AllowBeforeUnloadHandler"])t.oEditor.AllowBeforeUnloadHandler();if(t.monitoringWakeUp===true)t.monitoringStart()});BX.addCustomEvent(this.eventNode,"OnAfterHideLHE",function(e,t){t.monitoringWakeUp=t.monitoringStop();if(t.oEditor&&t.oEditor["DenyBeforeUnloadHandler"])t.oEditor.DenyBeforeUnloadHandler()});this.initParsers(i);this.initFiles(t,i);BX.ready(BX.delegate(function(){if(BX("lhe_button_submit_"+t,true)){BX.bind(BX("lhe_button_submit_"+t,true),"click",BX.proxy(function(e){BX.onCustomEvent(this.eventNode,"OnButtonClick",["submit"]);return BX.PreventDefault(e)},this))}if(BX("lhe_button_cancel_"+t,true)){BX.bind(BX("lhe_button_cancel_"+t,true),"click",BX.proxy(function(e){BX.onCustomEvent(this.eventNode,"OnButtonClick",["cancel"]);return BX.PreventDefault(e)},this))}},this));this.inited=true;BX.addCustomEvent(BX(this.formID),"onAutoSavePrepare",function(e){e.FORM.setAttribute("bx-lhe-autosave-prepared","Y")});BX.onCustomEvent(this,"onInitialized",[this,t,i,this.parsers]);BX.onCustomEvent(this.eventNode,"onInitialized",[this,t,i,this.parsers]);if(this.oEditor&&this.oEditor.inited&&!this.oEditor["__lhe_flags"]){BX.onCustomEvent(this.oEditor,"OnEditorInitedBefore",[this.oEditor]);BX.onCustomEvent(this.oEditor,"OnEditorInitedAfter",[this.oEditor,true])}};s.prototype={editorIsLoaded:false,arFiles:{},parser:{},controllers:{},exec:function(e,t){this.functionsToExec=this.functionsToExec||[];if(typeof e=="function")this.functionsToExec.push([e,t]);if(this.editorIsLoaded===true){var i;while((i=this.functionsToExec.shift())&&i)i[0].apply(this,i[1])}},initParsers:function(e){this.parser={postimage:{exist:false,bxTag:"postimage",tag:"IMG ID",tags:["IMG ID"],regexp:/\[(IMG ID)=((?:\s|\S)*?)(?:\s*?WIDTH=(\d+)\s*?HEIGHT=(\d+))?\]/gi,code:"[IMG ID=#ID##ADDITIONAL#]",wysiwyg:'<img id="#ID#" src="'+'#SRC#" lowsrc="'+'#LOWSRC#" title=""#ADDITIONAL# />'},player:{exist:false,bxTag:"player",tag:"FILE ID",tags:["FILE ID"],regexp:/\[(FILE ID)=((?:\s|\S)*?)?\]/gi,code:"[FILE ID=#ID##ADDITIONAL#]",wysiwyg:'<img class="bxhtmled-player-surrogate" id="#ID#" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" contenteditable="false" title=""#ADDITIONAL# />'}};var t=e["parsers"]?e["parsers"]:{};for(var n in t){if(t.hasOwnProperty(n)&&/[a-z]/gi.test(n+"")){this.parser[n]=new i(n,t[n])}}if(BX.util.object_search("UploadImage",t)){this.parser["postimage"]["exist"]=true}if(typeof e["arSize"]=="object"){var o="";if(e["arSize"]["width"])o+="max-width:"+e["arSize"]["width"]+"px;";if(e["arSize"]["height"])o+="max-height:"+e["arSize"]["height"]+"px;";if(o!=="")this.parser["postimage"]["wysiwyg"]=this.parser["postimage"]["wysiwyg"].replace("#ADDITIONAL#",' style="'+o+'" #ADDITIONAL#')}},initFiles:function(e,t){this.arFiles={};this.controllers={common:{postfix:"",storage:"bfile",parser:"postimage",node:window,obj:null,init:false}};this.monitoring={interval:null,text:"",savedText:"",files:[],savedFiles:[]};if(!t["CID"]||typeof t["CID"]!=="object")return;BX.addCustomEvent(this.eventNode,"onFileIsAdded",BX.delegate(this.OnFileUploadSuccess,this));BX.addCustomEvent(this.eventNode,"onFileIsFailed",BX.delegate(this.OnFileUploadFailed,this));BX.addCustomEvent(this.eventNode,"onFileIsDeleted",BX.delegate(this.OnFileUploadRemove,this));BX.addCustomEvent(this.eventNode,"onFileIsDetected",BX.delegate(this.setContent,this));BX.addCustomEvent(this.eventNode,"onFileIsInserted",BX.delegate(this.insertFile,this));var i,s,r;for(s in t["CID"]){if(t["CID"].hasOwnProperty(s)){i=t["CID"][s]["parser"];if(i=="disk_file")this.controllers[s]=new n(this,s,t["CID"][s]);else if(i=="webdav_element")this.controllers[s]=new o(this,s,t["CID"][s]);else if(i=="file")this.controllers[s]=new a(this,s,t["CID"][s]);if(this.controllers[s]&&this.controllers[s].init()&&!r)r=true}}BX.ready(BX.delegate(function(){BX.bind(BX("bx-b-uploadfile-"+e),"click",BX.proxy(this.controllerInit,this));if(r)this.controllerInit("show")},this))},controllerInit:function(e){this.controllerInitStatus=e=="show"||e=="hide"?e:this.controllerInitStatus=="show"?"hide":"show";BX.onCustomEvent(this.eventNode,"onShowControllers",[this.controllerInitStatus])},initUrlPreview:function(){if(this.params["urlPreviewId"]&&window["BXUrlPreview"]&&BX(this.params["urlPreviewId"])){return new BXUrlPreview(BX(this.params["urlPreviewId"]))}return null},getContent:function(){return this.oEditor?this.oEditor.GetContent():""},setContent:function(e){if(this.oEditor)this.oEditor.SetContent(e)},OnFileUploadSuccess:function(e,t,i,n){if(this.controllers[t.id]){var o=t.parser.bxTag+e.id;this.arFiles[o]=this.arFiles[o]||[];this.arFiles[o].push(t.id);if(n&&n["referrerToEditor"]){var a=this.getFileToInsert(e,t);BX.onCustomEvent(n["referrerToEditor"],"OnImageDataUriCaughtUploaded",[a]);BX.onCustomEvent(this.oEditor,"OnImageDataUriCaughtUploaded",[n["referrerToEditor"],e,a])}else if(i===true&&e.isImage&&this.insertImageAfterUpload){if(!this._insertFile)this._insertFile=BX.delegate(this.insertFile,this);this.exec(this._insertFile,arguments)}}},OnFileUploadFailed:function(e,t,i){if(i&&i["referrerToEditor"]){BX.onCustomEvent(i["referrerToEditor"],"OnImageDataUriCaughtFailed",[]);BX.onCustomEvent(this.editor,"OnImageDataUriCaughtFailed",[i["referrerToEditor"]])}},OnFileUploadRemove:function(e,t){if(this.controllers[t.id]){var i=t.parser.bxTag+e.id;if(this.arFiles[i]){var n=BX.util.array_search(t.id,this.arFiles[i]);this.arFiles[i]=BX.util.deleteFromArray(this.arFiles[i],n);if(!this.arFiles[i]||this.arFiles[i].length<=0){this.arFiles[i]=null;delete this.arFiles[i];if(!this._deleteFile)this._deleteFile=BX.delegate(this.deleteFile,this);this.exec(this._deleteFile,arguments)}}}},showPanelEditor:function(e,t){if(e==undefined)e=!this.oEditor.toolbar.IsShown();this.params.showPanelEditor=e;var i=BX("lhe_button_editor_"+this.formID),n=BX("panel-close"+this.__divId);if(n){this.oEditor.dom.cont.appendChild(n)}if(e){this.oEditor.dom.toolbarCont.style.opacity="inherit";this.oEditor.toolbar.Show();if(i)BX.addClass(i,"feed-add-post-form-btn-active");if(n)n.style.display=""}else{this.oEditor.toolbar.Hide();if(i)BX.removeClass(i,"feed-add-post-form-btn-active");if(n)n.style.display="none"}if(t!==false)BX.userOptions.save("main.post.form","postEdit","showBBCode",e?"Y":"N")},monitoring:{},monitoringStart:function(){if(this.monitoring.interval===null){if(!this._monitoringStart){this._monitoringStart=BX.delegate(this.checkFilesInText,this);BX.addCustomEvent(this.oEditor,"OnContentChanged",BX.proxy(function(e){this.monitoring.text=e},this))}this.monitoring.interval=setInterval(this._monitoringStart,1e3)}},monitoringStop:function(){var e=this.monitoring.interval!==null;if(this.monitoring.interval!==null)clearInterval(this.monitoring.interval);this.monitoring.interval=null;return e},monitoringSetStatus:function(e,t,i){if(this.arFiles[e+t]){var n;for(var o=0;o<this.arFiles[e+t].length;o++){n=this.arFiles[e+t][o];BX.onCustomEvent(this.controllers[n],"onFileIsInText",[t,i])}}},checkFilesInText:function(){if(this.monitoring.text!==this.monitoring.savedText){this.monitoring.savedText=this.monitoring.text;this.monitoring.files=[];var e=this.monitoring.savedText,t,i=function(e,t){return function(i,n,o){e.monitoring.files.push([t,o].join("/"))}};for(t in this.parser){if(this.parser.hasOwnProperty(t)){if(!this.parser[t]["checkFilesInText"]){this.parser[t]["checkFilesInText"]=i(this,t)}e.replace(this.parser[t]["regexp"],this.parser[t]["checkFilesInText"])}}if(this.monitoring.savedFiles.join(",")!==this.monitoring.files.join(",")){var n={},o;while(o=this.monitoring.savedFiles.pop()){n[o]=null}for(t=0;t<this.monitoring.files.length;t++){o=this.monitoring.files[t];n[o]=n[o]>=0?n[o]+1:1}for(t in n){if(n.hasOwnProperty(t)){o=t.split("/");this.monitoringSetStatus(o[0],o[1],n[t]>0)}}}this.monitoring.savedFiles=this.monitoring.files;if(this.monitoring.savedFiles.length<=0)this.monitoringStop()}},checkFile:function(e,t){var i=false;if(typeof e=="string"){var n=typeof t=="string"?t:t.parser;if(!!this.arFiles[n+e]){var o=this.arFiles[n+e][0];t=this.controllers[o];i={file:t.values[e],controller:t}}}else if(this.controllers[t.id]){i={file:e,controller:t}}return i},insertFile:function(e,t){var i=this.oEditor;if(i&&e){var n=i.GetViewMode(),o=this.getFileToInsert(e,t);if(n=="wysiwyg"){i.InsertHtml(o.replacement);setTimeout(BX.delegate(i.AutoResizeSceleton,i),500);setTimeout(BX.delegate(i.AutoResizeSceleton,i),1e3)}else if(n=="code"){i.textareaView.Focus();if(!i.bbCode){var a=i.GetIframeDoc();var s=a.createElement("DIV");s.style.display="none";s.innerHTML=o.replacement;a.body.appendChild(s);o.replacement=i.Parse(o.replacement,true,false);s.parentNode.removeChild(s)}i.textareaView.WrapWith("","",o.replacement)}else{return}o["callback"]()}},getFileToInsert:function(e,t){var i=this.oEditor;if(i&&e){var n=e["id"],o="",a=t.parser,s=i.bbCode?i.GetViewMode():"wysiwyg",r=this.parser[a.bxTag][s];if(e["fileType"]&&this.parser[e["fileType"]]&&s=="wysiwyg"){r=this.parser[e["fileType"]][s]}if(e["isImage"]){r=s=="wysiwyg"?this.parser["postimage"][s]:r;if(e.width>0&&e.height>0&&i.sEditorMode=="html"){o=' style="width:'+e.width+"px;height:"+e.height+"px;\" onload=\"this.style.width='auto';this.style.height='auto';\""}}if(s=="wysiwyg"){r=r.replace("#ID#",i.SetBxTag(false,{tag:a.bxTag,params:{value:n}})).replace("#SRC#",e.src).replace("#URL#",e.url).replace("#LOWSRC#",e.lowsrc||"").replace("#NAME#",e.name).replace("#ADDITIONAL#",o)+"<span>&nbsp;</span>"}else if(s=="code"&&i.bbCode){r=r.replace("#ID#",n).replace("#ADDITIONAL#","")}return{replacement:r,callback:BX.proxy(function(){this.monitoringSetStatus(t.parser.bxTag,e.id,true);this.monitoringStart()},this)}}return{replacement:"",callback:BX.DoNothing}},deleteFile:function(e,t){var i=this.oEditor,n=t.parser,o=e.id,a=i.GetContent();if(n&&a.indexOf("="+o)>=0){if(i.GetViewMode()=="wysiwyg"){var s=i.GetIframeDoc(),r,d;for(r in i["bxTags"]){if(i["bxTags"].hasOwnProperty(r)){if(typeof i.bxTags[r]=="object"&&i.bxTags[r]["params"]&&i.bxTags[r]["params"]["value"]==e.id){d=s.getElementById(r);if(d)d.parentNode.removeChild(d)}}}i.SaveContent()}else{a=a.replace(n.regexp,function(t,i,n){return n==e.id?"":t});i.SetContent(a);i.Focus()}this.monitoringSetStatus(n.bxTag,e.id,false)}},reinit:function(e,t){BX.onCustomEvent(this.eventNode,"onReinitializeBefore",[this,e,t]);this.arFiles={};delete this.monitoringWakeUp;this.monitoringStop();this.oEditor.CheckAndReInit(e||"");BX.onCustomEvent(this.eventNode,"onReinitialize",[this,e,t]);var i,n=false;for(i in this.controllers){if(this.controllers.hasOwnProperty(i)){if(this.controllers[i]["init"]&&this.controllers[i].reinit(e,t))n=true}}this.controllerInit(n?"show":"hide");if(this.params["~height"]){this.oEditor.SetConfigHeight(this.params["~height"]);this.oEditor.ResizeSceleton()}if(this.urlPreview){this.urlPreview.detachUrlPreview();var o;for(var a in t){if(t.hasOwnProperty(a)&&t[a].hasOwnProperty("USER_TYPE_ID")&&t[a]["USER_TYPE_ID"]==="url_preview"){o=t[a]["VALUE"]}}if(o)this.urlPreview.attachUrlPreview({id:o})}},Parse:function(e,t,i){var n=this.parser[e],o=this;if(n){t=t.replace(n.regexp,function(t,a,s,r,d){var l=o.checkFile(s,e);if(l&&(l=l.file)&&l){var h="",f=l.isImage?o.parser.postimage.wysiwyg:n.wysiwyg;o.monitoringStart();if(l.fileType&&o.parser[l.fileType]&&o.parser[l.fileType].wysiwyg){f=o.parser[l.fileType].wysiwyg}if(l.isImage){r=parseInt(r);d=parseInt(d);h=r&&d?' width="'+r+'" height="'+d+'"':"";if(h===""&&l["width"]>0&&l["height"]>0){h=' style="width:'+l["width"]+"px;height:"+l["height"]+"px;\" onload=\"this.style.width='auto';this.style.height='auto';\""}}return f.replace("#ID#",i.SetBxTag(false,{tag:e,params:{value:s}})).replace("#NAME#",l.name).replace("#SRC#",l.src).replace("#LOWSRC#",l.lowsrc).replace("#ADDITIONAL#",h).replace("#WIDTH#",parseInt(r)).replace("#HEIGHT#",parseInt(d))}return t})}return t},Unparse:function(e,t){var i="",n=e.tag;if(this.parser[n]){var o=parseInt(t.node.hasAttribute("width")?t.node.getAttribute("width"):0),a=parseInt(t.node.hasAttribute("height")?t.node.getAttribute("height"):0),s="";if(o>0&&a>0){s=" WIDTH="+o+" HEIGHT="+a}i=this.parser[n]["code"].replace("#ID#",e.params.value).replace("#ADDITIONAL#",s).replace("#WIDTH#",o).replace("#HEIGHT#",a)}return i},OnShowLHE:function(e,t,i){var n=this.__divId;e=e===false?false:e==="hide"?"hide":e==="justShow"?"justShow":true;this.oEditor=this.oEditor||s.getEditor(this.oEditorId);if(!this.oEditor)return;this.oEditor.Init();var o=BX("micro"+n),a=this.eventNode;if(o){o.style.display=e===true||e==="justShow"?"none":"block"}if(e=="hide"){BX.onCustomEvent(this.eventNode,"OnBeforeHideLHE",[e,this]);if(this.eventNode.style.display=="none"){BX.onCustomEvent(this.eventNode,"OnAfterHideLHE",[e,this])}else{new BX["easing"]({duration:200,start:{opacity:100,height:this.eventNode.scrollHeight},finish:{opacity:0,height:20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){a.style.height=e.height+"px";a.style.opacity=e.opacity/100},complete:BX.proxy(function(){this.eventNode.style.cssText="";this.eventNode.style.display="none";BX.onCustomEvent(a,"OnAfterHideLHE",[e,this])},this)}).animate()}}else if(e){BX.onCustomEvent(this.eventNode,"OnBeforeShowLHE",[e,this]);if(e=="justShow"){this.eventNode.style.display="block";BX.onCustomEvent(this.eventNode,"OnAfterShowLHE",[e,this]);if(i!==false)this.oEditor.Focus()}else if(this.eventNode.style.display=="block"){BX.onCustomEvent(this.eventNode,"OnAfterShowLHE",[e,this]);if(i!==false)this.oEditor.Focus()}else{BX.adjust(this.eventNode,{style:{display:"block",overflow:"hidden",height:"20px",opacity:.1}});new BX["easing"]({duration:200,start:{opacity:10,height:20},finish:{opacity:100,height:a.scrollHeight},transition:BX["easing"].makeEaseOut(BX.easing.transitions.quad),step:function(e){a.style.height=e.height+"px";a.style.opacity=e.opacity/100},complete:BX.proxy(function(){BX.onCustomEvent(a,"OnAfterShowLHE",[e,this]);this.oEditor.Focus();this.eventNode.style.cssText=""},this)}).animate()}}else{BX.onCustomEvent(this.eventNode,"OnBeforeHideLHE",[e,this]);this.eventNode.style.display="none";BX.onCustomEvent(this.eventNode,"OnAfterHideLHE",[e,this])}},OnButtonClick:function(e){if(e!=="cancel"){var t={result:true};BX.onCustomEvent(this.eventNode,"OnClickBeforeSubmit",[this,t]);if(t["result"]!==false)BX.onCustomEvent(this.eventNode,"OnClickSubmit",[this])}else{BX.onCustomEvent(this.eventNode,"OnClickCancel",[this]);BX.onCustomEvent(this.eventNode,"OnShowLHE",["hide"])}},OnEditorInitedBefore:function(e){var t=this;this.oEditor=e;e.formID=this.formID;if(this.params)this.params["~height"]=e.config["height"];BX.addCustomEvent(e,"OnCtrlEnter",function(){e.SaveContent();if(t.params&&t.params["ctrlEnterHandler"]&&typeof window[t.params["ctrlEnterHandler"]]=="function")window[t.params["ctrlEnterHandler"]]();else BX.submit(BX(t.formID))});var i=this.params.parsers?this.params.parsers:[];if(BX.util.object_search("Spoiler",i)){e.AddButton({id:"spoiler",name:BX.message("spoilerText"),iconClassName:"spoiler",disabledForTextarea:false,src:BX.message("MPF_TEMPLATE_FOLDER")+"/images/lhespoiler.png",toolbarSort:205,handler:function(){var e=this,t=false;if(!e.editor.bbCode||!e.editor.synchro.IsFocusedOnTextarea()){t=e.editor.action.actions.formatBlock.exec("formatBlock","blockquote","bx-spoiler",false,{bxTagParams:{tag:"spoiler"}})}else{t=e.editor.action.actions.formatBbCode.exec("quote",{tag:"SPOILER"})}return t}});e.AddParser({name:"spoiler",obj:{Parse:function(e,t,i){if(/\[(cut|spoiler)(([^\]])*)\]/gi.test(t)){t=t.replace(/[\001-\006]/gi,"").replace(/\[cut(((?:=)[^\]]*)|)\]/gi,"$1").replace(/\[\/cut]/gi,"").replace(/\[spoiler([^\]]*)\]/gi,"$1").replace(/\[\/spoiler]/gi,"");var n=/(?:\001([^\001]*)\001)([^\001-\004]+)\002/gi,o=/(?:\003([^\003]*)\003)([^\001-\004]+)\004/gi,a=function(e,t){e=e.replace(/^(="|='|=)/gi,"").replace(/("|')?$/gi,"");return'<blockquote class="bx-spoiler" id="'+i.SetBxTag(false,{tag:"spoiler"})+'" title="'+e+'">'+t+"</blockquote>"},s=function(e,t,i){return a(t,i)};while(t.match(n)||t.match(o)){t=t.replace(n,s).replace(o,s)}}t=t.replace(/\001([^\001]*)\001/gi,"[cut$1]").replace(/\003([^\003]*)\003/gi,"[spoiler$1]").replace(/\002/gi,"[/cut]").replace(/\004/gi,"[/spoiler]");return t},UnParse:function(t,i){if(t.tag=="spoiler"){var n="",o;for(o=0;o<i.node.childNodes.length;o++){n+=e.bbParser.GetNodeHtml(i.node.childNodes[o])}n=BX.util.trim(n);if(n!="")return"[SPOILER"+(i.node.hasAttribute("title")?"="+i.node.getAttribute("title"):"")+"]"+n+"[/SPOILER]"}return""}}})}if(BX.util.object_search("MentionUser",i)){e.AddParser({name:"postuser",obj:{Parse:function(t,i){i=i.replace(/\[USER\s*=\s*(\d+)\]((?:\s|\S)*?)\[\/USER\]/gi,function(t,i,n){n=BX.util.trim(n);if(n=="")return"";return'<span id="'+e.SetBxTag(false,{tag:"postuser",params:{value:parseInt(i)}})+'" class="bxhtmled-metion">'+n+"</span>"});return i},UnParse:function(t,i){if(t.tag=="postuser"){var n="",o;for(o=0;o<i.node.childNodes.length;o++){n+=e.bbParser.GetNodeHtml(i.node.childNodes[o])}n=BX.util.trim(n);if(n!="")return"[USER="+t.params.value+"]"+n+"[/USER]"}return""}}})}var n=function(i,n){return t.Parse(i,n,e)},o=function(e,i){return t.Unparse(e,i)};for(var a in this.parser){if(this.parser.hasOwnProperty(a)){e.AddParser({name:a,obj:{Parse:n,UnParse:o}})}}if(this.showPinButton){this.pinEditorPanel=this.params&&this.params.pinEditorPanel===true;var s="toolbar_pin";var r=function(e,i){r.superclass.constructor.apply(this,arguments);this.id=s;this.title=BX.message("MPF_PIN_EDITOR_PANNEL");this.className+=" "+(t.pinEditorPanel?"bxhtmled-button-toolbar-pined":"bxhtmled-button-toolbar-pin");this.Create();if(i)i.appendChild(this.GetCont())};BX.extend(r,window.BXHtmlEditor.Button);r.prototype.OnClick=function(){BX.removeClass(this.pCont,"bxhtmled-button-toolbar-pined");BX.removeClass(this.pCont,"bxhtmled-button-toolbar-pin");if(t.pinEditorPanel){t.pinEditorPanel=false;BX.addClass(this.pCont,"bxhtmled-button-toolbar-pin")}else{t.pinEditorPanel=true;BX.addClass(this.pCont,"bxhtmled-button-toolbar-pined")}BX.userOptions.save("main.post.form","postEdit","pinEditorPanel",t.pinEditorPanel?"Y":"N")};window.BXHtmlEditor.Controls[s]=r;BX.addCustomEvent(e,"GetControlsMap",function(e){e.push({id:s,compact:true,hidden:false,sort:500,checkWidth:true,offsetWidth:32,wrap:"right"})})}},OnEditorInitedAfter:function(t){BX.addCustomEvent(t,"OnIframeDrop",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDrop",arguments)},this));BX.addCustomEvent(t,"OnIframeDragOver",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDragOver",arguments)},this));BX.addCustomEvent(t,"OnIframeDragLeave",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDragLeave",arguments)},this));BX.addCustomEvent(t,"OnImageDataUriHandle",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnImageDataUriHandle",arguments)},this));BX.addCustomEvent(t,"OnAfterUrlConvert",this.OnAfterUrlConvert.bind(this));BX.addCustomEvent(t,"OnBeforeCommandExec",this.OnBeforeCommandExec.bind(this));t.contextMenu.items["postimage"]=t.contextMenu.items["postdocument"]=t.contextMenu.items["postfile"]=[{TEXT:BX.message("BXEdDelFromText"),bbMode:true,ACTION:function(){var e=t.contextMenu.GetTargetItem("postimage");if(!e)e=t.contextMenu.GetTargetItem("postdocument");if(!e)e=t.contextMenu.GetTargetItem("postfile");if(e&&e.element){t.selection.RemoveNode(e.element)}t.contextMenu.Hide()}}];if(!this.params["lazyLoad"]){BX.onCustomEvent(this.eventNode,"OnShowLHE",["justShow",t,false])}if(t.toolbar.controls&&t.toolbar.controls.FontSelector){t.toolbar.controls.FontSelector.SetWidth(45)}BX.addCustomEvent(BX(this.formID),"onAutoSavePrepare",function(e){var i=e;setTimeout(function(){BX.addCustomEvent(t,"OnContentChanged",BX.proxy(function(e){this["mpfTextContent"]=e;this.Init()},i))},1500)});BX.addCustomEvent(BX(this.formID),"onAutoSave",BX.proxy(function(e,t){if(BX.type.isNotEmptyString(e["mpfTextContent"]))t["text"+this.formID]=e["mpfTextContent"]},this));BX.addCustomEvent(BX(this.formID),"onAutoSaveRestore",BX.proxy(function(i,n){if(e.handler[t.id]){for(var o in e.handler[t.id].controllers){if(e.handler[t.id].controllers.hasOwnProperty(o)&&e.handler[t.id].controllers[o].handler&&e.handler[t.id].controllers[o].handler.params&&e.handler[t.id].controllers[o].handler.params.controlName&&e.handler[t.id].controllers[o].handler.params.controlName){delete n[e.handler[t.id].controllers[o].handler.params.controlName]}}}if(n["text"+this.formID]&&/[^\s]+/gi.test(n["text"+this.formID])){t.CheckAndReInit(n["text"+this.formID])}},this));if(BX(this.formID)&&BX(this.formID).hasAttribute("bx-lhe-autosave-prepared")&&BX(this.formID).BXAUTOSAVE){BX(this.formID).removeAttribute("bx-lhe-autosave-prepared");setTimeout(BX.proxy(function(){BX(this.formID).BXAUTOSAVE.Prepare()},this),100)}var i=this.formID,n=this.params;this.showPanelEditor(n.showPanelEditor,false);if(!t.mainPostFormCustomized){t.mainPostFormCustomized=true;BX.addCustomEvent(t,"OnIframeKeydown",function(e){if(window.onKeyDownHandler){window.onKeyDownHandler(e,t,i)}});BX.addCustomEvent(t,"OnIframeKeyup",function(e){if(window.onKeyUpHandler){window.onKeyUpHandler(e,t,i)}});if(window["BXfpdStopMent"+i]){BX.addCustomEvent(t,"OnIframeClick",function(){window["BXfpdStopMent"+i]()})}if(t&&t.textareaView.GetCursorPosition){BX.addCustomEvent(t,"OnTextareaKeyup",function(e){if(window.onTextareaKeyUpHandler){window.onTextareaKeyUpHandler(e,t,i)}});BX.addCustomEvent(t,"OnTextareaKeydown",function(e){if(window.onTextareaKeyDownHandler){window.onTextareaKeyDownHandler(e,t,i)}})}}},OnAfterUrlConvert:function(e){if(this.urlPreview){this.urlPreview.attachUrlPreview({url:e})}},OnBeforeCommandExec:function(e,t,i,n){if(this.urlPreview&&t=="createLink"&&BX.type.isPlainObject(n)&&n.hasOwnProperty("href")){this.urlPreview.attachUrlPreview({url:n.href})}}};s.getEditor=function(e){return window["BXHtmlEditor"]?window["BXHtmlEditor"].Get(typeof e=="object"?e.id:e):null};s.getHandler=function(t){return e.handler[typeof t=="object"?t.id:t]};s.unsetHandler=function(t){var i=typeof t=="object"?t.id:t;if(!e.handler[i])return;if(e.handler[i].oEditor)e.handler[i].oEditor.Destroy();e.handler[i]=null};s.reinitData=function(e,t,i){var n=s.getHandler(e);if(n)n.exec(n.reinit,[t,i]);return false};s.reinitDataBefore=function(e){var t=s.getHandler(e);if(t&&t["eventNode"])BX.onCustomEvent(t.eventNode,"onReinitializeBefore",[t])};window.LHEPostForm=s;window.BXPostFormTags=function(e,t){this.popup=null;this.formID=e;this.buttonID=t;this.sharpButton=null;this.addNewLink=null;this.tagsArea=null;this.hiddenField=null;this.popupContent=null;BX.ready(BX.proxy(this.init,this))};window.BXPostFormTags.prototype.init=function(){this.sharpButton=BX(this.buttonID);this.addNewLink=BX("post-tags-add-new-"+this.formID);this.tagsArea=BX("post-tags-block-"+this.formID);this.tagsContainer=BX("post-tags-container-"+this.formID);this.hiddenField=BX("post-tags-hidden-"+this.formID);this.popupContent=BX("post-tags-popup-content-"+this.formID);this.popupInput=BX.findChild(this.popupContent,{tag:"input"});var e=BX.findChildren(this.tagsContainer,{className:"feed-add-post-del-but"},true);for(var t=0,i=e.length;t<i;t++){BX.bind(e[t],"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:e[t].parentNode,tagValue:e[t].parentNode.getAttribute("data-tag")}))}BX.bind(this.sharpButton,"click",BX.proxy(this.onButtonClick,this));BX.bind(this.addNewLink,"click",BX.proxy(this.onAddNewClick,this))};window.BXPostFormTags.prototype.onTagDelete=function(){BX.remove(this.tagBox);this.obj.hiddenField.value=this.obj.hiddenField.value.replace(this.tagValue+",","").replace("  "," ")};window.BXPostFormTags.prototype.show=function(){if(this.popup===null){this.popup=new BX.PopupWindow("bx-post-tag-popup",this.addNewLink,{content:this.popupContent,lightShadow:false,offsetTop:8,offsetLeft:10,autoHide:true,angle:true,closeByEsc:true,zIndex:-840,buttons:[new BX.PopupWindowButton({text:BX.message("TAG_ADD"),events:{click:BX.proxy(this.onTagAdd,this)}})]});BX.bind(this.popupInput,"keydown",BX.proxy(this.onKeyPress,this));BX.bind(this.popupInput,"keyup",BX.proxy(this.onKeyPress,this))}this.popup.show();BX.focus(this.popupInput)};window.BXPostFormTags.prototype.addTag=function(e){var t=BX.type.isNotEmptyString(e)?e.split(","):this.popupInput.value.split(",");var i=[];for(var n=0;n<t.length;n++){var o=BX.util.trim(t[n]);if(o.length>0){var a=this.hiddenField.value.split(",");if(!BX.util.in_array(o,a)){var s;var r=BX.create("span",{children:[s=BX.create("span",{attrs:{class:"feed-add-post-del-but"}})],attrs:{class:"feed-add-post-tags"}});r.insertBefore(document.createTextNode(o),s);this.tagsContainer.insertBefore(r,this.addNewLink);BX.bind(s,"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:r,tagValue:o}));this.hiddenField.value+=o+",";i.push(o)}}}return i};window.BXPostFormTags.prototype.onTagAdd=function(){this.addTag();this.popupInput.value="";this.popup.close()};window.BXPostFormTags.prototype.onAddNewClick=function(e){e=e||window.event;this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onButtonClick=function(e){e=e||window.event;BX.show(this.tagsArea);this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onKeyPress=function(e){e=e||window.event;var t=e.keyCode?e.keyCode:e.which?e.which:null;if(t==13){setTimeout(BX.proxy(this.onTagAdd,this),0)}};window.BXPostFormImportant=function(e,t,i){if(i){this.formID=e;this.buttonID=t;this.inputName=i;this.fireButton=null;this.activeBlock=null;this.hiddenField=null;BX.ready(BX.proxy(this.init,this))}return false};window.BXPostFormImportant.prototype.init=function(){this.fireButton=BX(this.buttonID);this.activeBlock=BX(this.buttonID+"-active");var e=BX(this.formID);if(e){this.hiddenField=e[this.inputName];if(this.hiddenField&&this.hiddenField.value==1){this.showActive()}}BX.bind(this.fireButton,"click",BX.proxy(function(e){e=e||window.event;this.showActive();BX.PreventDefault(e)},this));BX.bind(this.activeBlock,"click",BX.proxy(function(e){e=e||window.event;this.hideActive();BX.PreventDefault(e)},this))};window.BXPostFormImportant.prototype.showActive=function(e){BX.hide(this.fireButton);BX.show(this.activeBlock,"inline-block");if(this.hiddenField){this.hiddenField.value=1}return false};window.BXPostFormImportant.prototype.hideActive=function(e){BX.hide(this.activeBlock);BX.show(this.fireButton,"inline-block");if(this.hiddenField){this.hiddenField.value=0}return false};var r=null;window.MPFbuttonShowWait=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||this;e=e?e.tagName=="A"?e:e.parentNode:e;if(e){BX.addClass(e,"ui-btn-clock");r=e;BX.defer(function(){e.disabled=true})()}};window.MPFbuttonCloseWait=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||r||this;if(e){e.disabled=false;BX.removeClass(e,"ui-btn-clock");r=null}};window.__mpf_wd_getinfofromnode=function(e,t){var i=BX.findChild(BX((e["prefixNode"]||"wd-doc")+e.element_id),{className:"files-preview",tagName:"IMG"},true,false);if(i){e.lowsrc=i.src;e.element_url=i.src.replace(/\Wwidth=(\d+)/,"").replace(/\Wheight\=(\d+)/,"");e.width=parseInt(i.getAttribute("data-bx-full-width"));e.height=parseInt(i.getAttribute("data-bx-full-height"))}else if(t.urlGet){e.element_url=t.urlGet.replace("#element_id#",e.element_id).replace("#ELEMENT_ID#",e.element_id).replace("#element_name#",e.element_name).replace("#ELEMENT_NAME#",e.element_name)}};var d={listen:false,plus:false,text:"",bSearch:false};window.BXfpdSelectCallback=function(e,t,i,n,o,a){BX.SocNetLogDestination.BXfpSelectCallback({item:e,type:t,bUndeleted:n,containerInput:BX("feed-add-post-destination-item"),valueInput:BX("feed-add-post-destination-input"),formName:o,tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2"),state:typeof a!="undefined"?a:null})};window.BXfpdUnSelectCallback=function(e,t,i,n){BX.SocNetLogDestination.BXfpUnSelectCallback.call({formName:n,inputContainerName:"feed-add-post-destination-item",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")},e)};window.BXfpdOpenDialogCallback=function(e){BX.SocNetLogDestination.BXfpOpenDialogCallback.call({inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})};window.BXfpdCloseDialogCallback=function(e){BX.SocNetLogDestination.BXfpCloseDialogCallback.call({inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})};window.BXfpdCloseSearchCallback=function(e){BX.SocNetLogDestination.BXfpCloseSearchCallback.call({inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})};window.onKeyDownHandler=function(e,t,i){var n=e.keyCode;if(!window["BXfpdStopMent"+i])return true;if(BX.util.in_array(n,[107,187])||(e.shiftKey||e.modifiers>3)&&BX.util.in_array(n,[50,43,61])||e.altKey&&BX.util.in_array(n,[76])){setTimeout(function(){var e=t.selection.GetRange(),n=t.GetIframeDoc(),o=e?e.endContainer.textContent:"",a=o?o.slice(e.endOffset-1,e.endOffset):"",s=o?o.slice(e.endOffset-2,e.endOffset-1):"";if((a=="@"||a=="+")&&(!s||BX.util.in_array(s,["+","@",",","("])||s.length==1&&BX.util.trim(s)==="")){d.listen=true;d.listenFlag=true;d.text="";d.leaveContent=true;e.setStart(e.endContainer,e.endOffset-1);e.setEnd(e.endContainer,e.endOffset);t.selection.SetSelection(e);var r=BX.create("SPAN",{props:{id:"bx-mention-node"}},n);t.selection.Surround(r,e);e.setStart(r,1);e.setEnd(r,1);t.selection.SetSelection(e);if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i],{bindNode:l(r,t)})}}},10)}if(d.listen){var o=d.bSearch?"search":BX.SocNetLogDestination.obTabSelected[window["BXSocNetLogDestinationFormNameMent"+i]];if(n==t.KEY_CODES["enter"]){BX.SocNetLogDestination.selectCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i]);t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["left"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"left");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["right"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"right");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["up"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"up");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["down"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"down");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}}if(!d.listen&&d.listenFlag&&n===t.KEY_CODES["enter"]){var a=t.selection.GetRange();if(a.collapsed){var s=a.endContainer,r=t.GetIframeDoc();if(s){if(s.className!=="bxhtmled-metion"){s=BX.findParent(s,function(e){return e.className=="bxhtmled-metion"},r.body)}if(s&&s.className=="bxhtmled-metion"){t.selection.SetAfter(s)}}}}};window.onKeyUpHandler=function(e,t,i){var n=e.keyCode,o,a,s;if(!window["BXfpdStopMent"+i])return true;if(d.listen===true){if(n==t.KEY_CODES["escape"]){window["BXfpdStopMent"+i]()}else if(n!==t.KEY_CODES["enter"]&&n!==t.KEY_CODES["left"]&&n!==t.KEY_CODES["right"]&&n!==t.KEY_CODES["up"]&&n!==t.KEY_CODES["down"]){o=t.GetIframeDoc();var r=o.getElementById("bx-mention-node");if(r){s=BX.util.trim(t.util.GetTextContent(r));var h=s;s=s.replace(/^[\+@]*/,"");d.bSearch=s.length>0;BX.SocNetLogDestination.search(s,true,window["BXSocNetLogDestinationFormNameMent"+i],BX.message("MPF_NAME_TEMPLATE"),{bindNode:l(r,t)});if(d.leaveContent&&d._lastText&&h===""){window["BXfpdStopMent"+i]()}else if(d.leaveContent&&d.lastText&&h!==""&&s===""){d.bSearch=false;window["BXfpdStopMent"+i]();BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i],{bindNode:l(r,t)})}d.lastText=s;d._lastText=h}else{window["BXfpdStopMent"+i]()}}}else{if(!e.shiftKey&&(n===t.KEY_CODES["space"]||n===t.KEY_CODES["escape"]||n===188||n===190)){a=t.selection.GetRange();if(a.collapsed){var f=a.endContainer;o=t.GetIframeDoc();if(f){if(f.className!=="bxhtmled-metion"){f=BX.findParent(f,function(e){return e.className=="bxhtmled-metion"},o.body)}if(f&&f.className=="bxhtmled-metion"){s=t.util.GetTextContent(f);var u=s.match(/[\s\.\,]$/);if(u||n===t.KEY_CODES["escape"]){f.innerHTML=s.replace(/[\s\.\,]$/,"");var c=BX.create("SPAN",{html:u||t.INVISIBLE_SPACE},o);t.util.InsertAfter(c,f);t.selection.SetAfter(c)}}}}}}};window.onTextareaKeyDownHandler=function(e,t,i){var n=e.keyCode;if(d.listen&&n==t.KEY_CODES["enter"]){BX.SocNetLogDestination.selectFirstSearchItem(window["BXSocNetLogDestinationFormNameMent"+i]);t.textareaKeyDownPreventDefault=true;BX.PreventDefault(e)}};window.onTextareaKeyUpHandler=function(e,t,i){var n,o,a=e.keyCode;if(d.listen===true){if(a==27){window["BXfpdStopMent"+i]()}else if(a!==13){o=t.textareaView.GetValue(false);n=t.textareaView.GetCursorPosition();if(o.indexOf("+")!==-1||o.indexOf("@")!==-1){var s=o.substr(0,n),r=Math.max(s.lastIndexOf("+"),s.lastIndexOf("@"));if(r>=0){var l=s.substr(r),h=l;l=l.replace(/^[\+@]*/,"");if(BX.SocNetLogDestination&&!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i])}d.bSearch=l.length>0;if(BX.SocNetLogDestination)BX.SocNetLogDestination.search(l,true,window["BXSocNetLogDestinationFormNameMent"+i],BX.message("MPF_NAME_TEMPLATE"));if(d.leaveContent&&d._lastText&&h===""){window["BXfpdStopMent"+i]()}else if(d.leaveContent&&d.lastText&&h!==""&&l===""){window["BXfpdStopMent"+i]();if(BX.SocNetLogDestination)BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i])}d.lastText=l;d._lastText=h}}}}else{if(a==16){var f=this;this.shiftPressed=true;if(this.shiftTimeout)this.shiftTimeout=clearTimeout(this.shiftTimeout);this.shiftTimeout=setTimeout(function(){f.shiftPressed=false},100)}if(a==107||(e.shiftKey||e.modifiers>3||this.shiftPressed)&&BX.util.in_array(a,[187,50,107,43,61])){n=t.textareaView.element.selectionStart;if(n>0){o=t.textareaView.element.value;var u=o.substr(n-1,1);if(u&&(u==="+"||u==="@")){d.listen=true;d.listenFlag=true;d.text="";d.textarea=true;if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i])}}}}}};var l=function(e,t){var i=BX.pos(e),n=BX.pos(t.dom.areaCont),o=BX.GetWindowScrollPos(t.GetIframeDoc()),a=n.top+i.bottom-o.scrollTop+2,s=n.left+i.right-o.scrollLeft;return{top:a,left:s}};window.BxInsertMention=function(e){var t=e.item,i=e.type,n=e.formID,o=e.editorId,a=e.bNeedComa,r=s.getEditor(o),l;if(i=="users"&&t&&t.entityId>0&&r){if(r.GetViewMode()=="wysiwyg"){var h=r.GetIframeDoc(),f=r.selection.GetRange(),u=h.getElementById("bx-mention-node"),c=BX.create("SPAN",{props:{className:"bxhtmled-metion"},text:BX.util.htmlspecialcharsback(t.name)},h);l=BX.create("SPAN",{html:a?",&nbsp;":"&nbsp;"},h);r.SetBxTag(c,{tag:"postuser",params:{value:t.entityId}});if(u){r.util.ReplaceNode(u,c)}else{r.selection.InsertNode(c,f)}if(c&&c.parentNode){var p=BX.findParent(c,{className:"bxhtmled-metion"},h.body);if(p){r.util.InsertAfter(c,p)}}if(c&&c.parentNode){r.util.InsertAfter(l,c);r.selection.SetAfter(l)}}else if(r.GetViewMode()=="code"&&r.bbCode){r.textareaView.Focus();var m=r.textareaView.GetValue(false),B=r.textareaView.GetCursorPosition(),g=m.substr(0,B),X=Math.max(g.lastIndexOf("+"),g.lastIndexOf("@"));if(X>=0&&B>X){r.textareaView.SetValue(m.substr(0,X)+m.substr(B));r.textareaView.element.setSelectionRange(X,X)}r.textareaView.WrapWith(false,false,"[USER="+t.entityId+"]"+t.name+"[/USER]"+(a?", ":" "))}if(e.fireAddEvent===true){BX.onCustomEvent(window,"onMentionAdd",[t])}delete BX.SocNetLogDestination.obItemsSelected[window["BXSocNetLogDestinationFormNameMent"+n]][t.id];window["BXfpdStopMent"+n]();d["text"]="";if(r.GetViewMode()=="wysiwyg"){r.Focus();r.selection.SetAfter(l)}}};window.MPFMentionInit=function(e,t){if(!t["items"]["departmentRelation"]){t["items"]["departmentRelation"]=BX.SocNetLogDestination.buildDepartmentRelation(t["items"]["department"])}window["departmentRelation"]=t["items"]["departmentRelation"];if(t.initDestination===true){window.BXSocNetLogDestinationFormName="destination"+(""+(new Date).getTime()).substr(6);window.BXSocNetLogDestinationDisableBackspace=null;BX.SocNetLogDestination.init({name:window.BXSocNetLogDestinationFormName,searchInput:BX("feed-add-post-destination-input"),extranetUser:t["extranetUser"],bindMainPopup:{node:BX("feed-add-post-destination-container"),offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:BX("feed-add-post-destination-container"),offsetTop:"5px",offsetLeft:"15px"},callback:{select:window.BXfpdSelectCallback,unSelect:BX.delegate(BX.SocNetLogDestination.BXfpUnSelectCallback,{formName:window.BXSocNetLogDestinationFormName,inputContainerName:"feed-add-post-destination-item",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")}),openDialog:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}),closeDialog:BX.delegate(BX.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}),openSearch:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})},items:t["items"],itemsLast:t["itemsLast"],itemsSelected:t["itemsSelected"],isCrmFeed:t["isCrmFeed"],useClientDatabase:!!t["useClientDatabase"],destSort:t["destSort"],allowAddUser:t["allowAddUser"],allowAddCrmContact:t["allowAddCrmContact"],allowSearchCrmEmailUsers:typeof t["allowSearchCrmEmailUsers"]!="undefined"?!!t["allowSearchCrmEmailUsers"]:false,userNameTemplate:typeof t["userNameTemplate"]!="undefined"?t["userNameTemplate"]:"",allowSonetGroupsAjaxSearch:typeof t["allowSonetGroupsAjaxSearch"]!="undefined"?t["allowSonetGroupsAjaxSearch"]:false,allowSonetGroupsAjaxSearchFeatures:typeof t["allowSonetGroupsAjaxSearchFeatures"]!="undefined"?t["allowSonetGroupsAjaxSearchFeatures"]:{},showVacations:true,usersVacation:typeof t["usersVacation"]!="undefined"?t["usersVacation"]:{}});BX.bind(BX("feed-add-post-destination-input"),"keyup",BX.delegate(BX.SocNetLogDestination.BXfpSearch,{formName:window.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}));BX.bind(BX("feed-add-post-destination-input"),"paste",BX.defer(BX.SocNetLogDestination.BXfpSearch,{formName:window.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag",onPasteEvent:true}));BX.bind(BX("feed-add-post-destination-input"),"keydown",BX.delegate(BX.SocNetLogDestination.BXfpSearchBefore,{formName:window.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input"}));BX.bind(BX("feed-add-post-destination-input"),"blur",BX.delegate(BX.SocNetLogDestination.BXfpBlurInput,{inputBoxName:"feed-add-post-destination-input-box",tagInputName:"bx-destination-tag"}));BX.bind(BX("bx-destination-tag"),"focus",function(e){BX.SocNetLogDestination.openDialog(window.BXSocNetLogDestinationFormName,{bByFocusEvent:true});return BX.PreventDefault(e)});BX.bind(BX("feed-add-post-destination-container"),"click",function(e){BX.SocNetLogDestination.openDialog(window.BXSocNetLogDestinationFormName);return BX.PreventDefault(e)});BX.addCustomEvent(window,"onMentionAdd",function(e){if(!BX.type.isPlainObject(BX.SocNetLogDestination.obItems[window.BXSocNetLogDestinationFormName]["users"][e.id])){BX.SocNetLogDestination.obItems[window.BXSocNetLogDestinationFormName]["users"][e.id]=e}BX.addCustomEvent(window,"BX.SocNetLogDestination:onBeforeSelectItemFocus",function(e){if(e.id==window.BXSocNetLogDestinationFormName){e.blockFocus=true}});if(typeof BX.SocNetLogDestination.obItemsSelected[window.BXSocNetLogDestinationFormName][e.id]=="undefined"||!BX.SocNetLogDestination.obItemsSelected[window.BXSocNetLogDestinationFormName][e.id]){BX.SocNetLogDestination.selectItem(window.BXSocNetLogDestinationFormName,null,null,e.id,"users",false)}});if(t["itemsHidden"]){for(var i in t["itemsHidden"]){if(t["itemsHidden"].hasOwnProperty(i)){window.BXfpdSelectCallback({id:(typeof t["itemsHidden"][i]["PREFIX"]!="undefined"?t["itemsHidden"][i]["PREFIX"]:"SG")+t["itemsHidden"][i]["ID"],name:t["itemsHidden"][i]["NAME"]},typeof t["itemsHidden"][i]["TYPE"]!="undefined"?t["itemsHidden"][i]["TYPE"]:"sonetgroups","",true,"","init")}}}BX.SocNetLogDestination.BXfpSetLinkName({formName:window.BXSocNetLogDestinationFormName,tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")})}window["BXfpdSelectCallbackMent"+e]=function(i,n,o){window.BxInsertMention({item:i,type:n,formID:e,editorId:t.editorId,fireAddEvent:t.initDestination})};window["BXfpdStopMent"+e]=function(){BX.SocNetLogDestination.closeDialog();BX.SocNetLogDestination.closeSearch();clearTimeout(BX.SocNetLogDestination.searchTimeout);BX.SocNetLogDestination.searchOnSuccessHandle=false};window["BXfpdOnDialogOpen"+e]=function(){d.listen=true;d.listenFlag=true};window["BXfpdOnDialogClose"+e]=function(){d.listen=false;setTimeout(function(){d.listenFlag=false;if(!d.listen){var e=s.getEditor(t.editorId);if(e){var i=e.GetIframeDoc(),n=i.getElementById("bx-mention-node");if(n){e.selection.SetAfter(n);if(d.leaveContent){e.util.ReplaceWithOwnChildren(n)}else{BX.remove(n)}}e.Focus()}}},100)};window["BXSocNetLogDestinationFormNameMent"+e]="mention"+(""+(new Date).getTime()).substr(5);window["BXSocNetLogDestinationDisableBackspace"]=null;var n=BX("bx-b-mention-"+e);if(!t.extranetUser&&typeof t.items.extranetRoot!="undefined"){t["items"]["departmentExtranet"]=BX.clone(t["items"]["department"]);for(var o in t["items"]["extranetRoot"]){if(t["items"]["extranetRoot"].hasOwnProperty(o)){t["items"]["departmentExtranet"][o]=t["items"]["extranetRoot"][o]}}t["items"]["departmentRelationExtranet"]=BX.SocNetLogDestination.buildDepartmentRelation(t["items"]["departmentExtranet"])}BX.SocNetLogDestination.init({name:window["BXSocNetLogDestinationFormNameMent"+e],searchInput:n,extranetUser:t.extranetUser,bindMainPopup:{node:n,offsetTop:"1px",offsetLeft:"12px"},bindSearchPopup:{node:n,offsetTop:"1px",offsetLeft:"12px"},callback:{select:window["BXfpdSelectCallbackMent"+e],openDialog:window["BXfpdOnDialogOpen"+e],closeDialog:window["BXfpdOnDialogClose"+e],openSearch:window["BXfpdOnDialogOpen"+e],closeSearch:window["BXfpdOnDialogClose"+e]},items:{users:t["items"]["mentionUsers"],groups:{},sonetgroups:{},department:typeof t["items"]["departmentExtranet"]!="undefined"?t["items"]["departmentExtranet"]:t["items"]["department"],departmentRelation:typeof t["items"]["departmentRelationExtranet"]!="undefined"?t["items"]["departmentRelationExtranet"]:t["items"]["departmentRelation"]},itemsLast:{users:t["itemsLast"]["mentionUsers"],sonetgroups:{},department:{},groups:{}},itemsSelected:{},destSort:typeof t["mentionDestSort"]!="undefined"&&t["mentionDestSort"]?t["mentionDestSort"]:{},departmentSelectDisable:true,obWindowClass:"bx-lm-mention",obWindowCloseIcon:false,useClientDatabase:!!t["useClientDatabase"],userNameTemplate:typeof t["userNameTemplate"]!="undefined"?t["userNameTemplate"]:"",showVacations:false,showSearchInput:BX.browser.IsMobile()});BX.ready(function(){var i=BX("bx-b-mention-"+e);BX.bind(i,"mousedown",function(n){if(d.listen!==true){var o=s.getEditor(t.editorId),a=o.GetIframeDoc();if(o.GetViewMode()=="wysiwyg"&&a){d.listen=true;d.listenFlag=true;d.text="";d.leaveContent=false;var r=o.selection.GetRange(),l=a.getElementById("bx-mention-node");if(l){BX.remove(l)}o.InsertHtml('<span id="bx-mention-node">'+o.INVISIBLE_SPACE+"</span>",r);setTimeout(function(){if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+e],{bindNode:i})}var t=a.getElementById("bx-mention-node");if(t){r.setStart(t,0);if(t.firstChild&&t.firstChild.nodeType==3&&t.firstChild.nodeValue.length>0){r.setEnd(t,1)}else{r.setEnd(t,0)}o.selection.SetSelection(r)}o.Focus()},100)}else if(o.GetViewMode()=="code"){d.listen=true;d.listenFlag=true;d.text="";d.leaveContent=false;setTimeout(function(){if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+e],{bindNode:i})}},100)}BX.onCustomEvent(i,"mentionClick")}})})}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js?154412740428279";s:6:"source";s:67:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(e){var t=false,i=false,s=0,o=null,a=null,n={};BX.namespace("BX.Disk");if(BX.Disk.UF)return;BX.Disk.UF=function(){var t=function(t){this.dialogName="DiskFileDialog";this.params=t;this.CID=t["UID"];this.controller=t.controller;this.values=t.values||[];this.prefix="diskuf-doc";this.onUploaderIsAlmostInited=BX.delegate(this.onUploaderIsAlmostInited,this);BX.addCustomEvent(e,"onUploaderIsAlmostInited",this.onUploaderIsAlmostInited);this.agent=BX.Uploader.getInstance({id:t["UID"],streams:3,allowUpload:"A",uploadFormData:"N",uploadMethod:"immediate",uploadFileUrl:t["urlUpload"],showImage:false,sortItems:false,input:t["input"],dropZone:t["dropZone"],placeHolder:t["placeHolder"],queueFields:{thumb:{tagName:"TR",className:"wd-inline-file"}},fields:{thumb:{tagName:"",template:BX.message("DISK_TMPLT_THUMB")}}});this.urlSelect=!!t["urlSelect"]?t["urlSelect"]:null;this.urlRenameFile=!!t["urlRenameFile"]?t["urlRenameFile"]:null;this.urlDeleteFile=!!t["urlDeleteFile"]?t["urlDeleteFile"]:null;this.urlSelect=this._addUrlParam(this.urlSelect,"dialog2=Y&ACTION=SELECT&MULTI=Y");this.urlUpload=!!t["urlUpload"]?t["urlUpload"]:null;this.urlShow=!!t["urlShow"]?t["urlShow"]:null;this.params.controlName=this.params.controlName||"FILES[]";this.init();return this};t.prototype={_addUrlParam:function(e,t){if(!e)return null;if(e.indexOf(t)==-1)e+=(e.indexOf("?")==-1?"?":"&")+t;return e},_camelToSNAKE:function(e){var t={},i,s;for(i in e){s=i.replace(/(.)([A-Z])/g,"$1_$2").toUpperCase();t[s]=e[i];t[i]=e[i]}return t},onUploaderIsAlmostInited:function(t,i){if(this.CID!=i["id"])return;BX.removeCustomEvent(e,"onUploaderIsAlmostInited",this.onUploaderIsAlmostInited);var s=BX.findChild(this.controller,{className:"diskuf-simple"},true),o=BX.findChild(this.controller,{className:"diskuf-extended"},true);if(t=="BX.UploaderSimple"){BX.remove(o);BX.show(s)}else{BX.remove(s);BX.show(o)}i.input=BX.findChild(this.controller,{className:"diskuf-fileUploader"},true);i.dropZone=BX.findChild(this.controller,{className:"diskuf-extended"},false);this.params.placeHolder=i["placeHolder"]=BX.findChild(this.controller,{className:"diskuf-placeholder-tbody"},true)},init:function(){this._onItemIsAdded=BX.delegate(this.onItemIsAdded,this);this._onFileIsAppended=BX.delegate(this.onFileIsAppended,this);this._onFileIsAttached=BX.delegate(this.onFileIsAttached,this);this._onFileIsBound=BX.delegate(this.onFileIsBound,this);this._onFileIsInited=BX.delegate(this.onFileIsInited,this);this._onError=BX.delegate(this.onError,this);BX.addCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded);BX.addCustomEvent(this.agent,"onFileIsInited",this._onFileIsInited);BX.addCustomEvent(this.agent,"onError",this._onError);this._onUploadProgress=BX.delegate(this.onUploadProgress,this);this._onUploadDone=BX.delegate(this.onUploadDone,this);this._onUploadError=BX.delegate(this.onUploadError,this);this._onUploadRestore=BX.delegate(this.onUploadRestore,this);BX.onCustomEvent(BX(this.controller.parentNode),"DiskDLoadFormControllerInit",[this]);var e=[],t=[],i;for(var s=0;s<this.values.length;s++){i=BX.findChild(this.values[s],{className:"f-wrap"},true);if(!!i){e.push({name:i.innerHTML});t.push(this.values[s])}}this.values=[];this.agent.onAttach(e,t);var o=BX.findChild(this.controller,{className:"diskuf-selector-link"},true);if(!!o){BX.bind(o,"click",BX.proxy(this.showSelectDialog,this))}var a=BX.findChildren(this.controller,{className:"diskuf-selector-link-cloud"},true);if(!!a){for(var n in a){if(!a.hasOwnProperty(n))continue;BX.bind(a[n],"click",BX.proxy(this.showSelectDialogCloudImport,this))}}return false},addFile:function(e){return this.agent&&this.agent.onChange([e])},onItemIsAdded:function(){BX.removeCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded);BX.show(BX.findParent(this.params.placeHolder,{className:"diskuf-files-block"}))},onFileIsInited:function(e,t){BX.addCustomEvent(t,"onFileIsAttached",this._onFileIsAttached);BX.addCustomEvent(t,"onFileIsAfterCreated",function(e,t,i,s){if(t&&!t.sizeInt){e.size=" "}});BX.addCustomEvent(t,"onFileIsAppended",this._onFileIsAppended);BX.addCustomEvent(t,"onFileIsBound",this._onFileIsBound);BX.addCustomEvent(t,"onUploadProgress",this._onUploadProgress);BX.addCustomEvent(t,"onUploadDone",this._onUploadDone);BX.addCustomEvent(t,"onUploadError",this._onUploadError)},onFileIs:function(e,t,i){this.bindEventsHandlers(e,t,i);var s={element_id:i.element_id,element_name:i.element_name||t.name,element_url:i.element_name||i.previewUrl||i.preview_url,place:e,storage:"disk"};this.values.push(e);BX.onCustomEvent(this.params.controller.parentNode,"OnFileUploadSuccess",[s,this,t.file,t]);t.__disk_element_id=i.element_id;BX.onCustomEvent(t,"OnFileUploadSuccess",[s,this])},onFileIsAppended:function(e,t){var i=this.agent.getItem(e),s=i.node;this.bindEventsHandlers(s,t,{})},onFileIsBound:function(e,t){var i=this.agent.getItem(e),s=i.node,o=s.getAttribute("id").replace("disk-edit-attach","");this.onFileIs(s,t,{element_id:o})},onFileIsAttached:function(e,t,i,s){if(!!s["sizeFormatted"])s["size"]=s["sizeFormatted"];if(!s.hasOwnProperty("service")){this.onUploadDone(t,{file:s});return}BX.Disk.ExternalLoader.startLoad({file:{id:s.id,name:s.name,service:s.service},onFinish:BX.delegate(function(e){var i=this.agent.getItem(t.id).node;BX.hide(i);var s={id:e.ufId,name:e.name,storage:e.storage,ext:t.ext,size:e.sizeFormatted,previewUrl:e.previewUrl,preview_url:e.previewUrl,element_url:e.previewUrl,size_int:parseInt(e.size,10)};var o;var a=BX.message("DISK_TMPLT_THUMB2").replace("#control_name#",this.params.controlName).replace("#CONTROL_NAME#",this.params.controlName);for(var n in s){o=s[n];if(s.hasOwnProperty(n)){if(n.toLowerCase()=="size"){if(s.hasOwnProperty("size_int")){if(parseInt(s["size_int"],10)==0||isNaN(s["size_int"])){o=""}}if(s.hasOwnProperty("SIZE_INT")||isNaN(s["SIZE_INT"])){if(parseInt(s["SIZE_INT"],10)==0){o=""}}}a=a.replace(new RegExp("#"+n.toLowerCase()+"#","gi"),o).replace(new RegExp("#"+n.toUpperCase()+"#","gi"),o)}}var l={id:"disk-edit-attach"+s.id,"bx-agentFileId":t.id},r;r=BX.create("TR",{attrs:l,props:{className:"wd-inline-file"},html:a});var d=BX.findChild(r,{className:"files-name-edit-btn"},true);if(d){BX.remove(d)}i.parentNode.insertBefore(r,i);s.element_id=s.id;this.agent.onAttach([s],[r]);t.deleteFile()},this),onProgress:BX.delegate(function(e){this.onUploadProgress(t,e)},this)})},onUploadProgress:function(e,t){t=Math.min(t,98);var i=e.id;if(!e.__progressBarWidth)e.__progressBarWidth=5;if(t>e.__progressBarWidth){e.__progressBarWidth=Math.ceil(t);e.__progressBarWidth=e.__progressBarWidth>100?100:e.__progressBarWidth;if(BX("wdu"+i+"Progressbar"))BX.adjust(BX("wdu"+i+"Progressbar"),{style:{width:e.__progressBarWidth+"%"}});if(BX("wdu"+i+"ProgressbarText"))BX.adjust(BX("wdu"+i+"ProgressbarText"),{text:e.__progressBarWidth+"%"})}},onUploadDone:function(e,t){if(t["file"]&&t["file"]["attachId"]&&t["file"]["attachId"]!=t["file"]["id"]){t["file"]["id"]=t["file"]["attachId"];delete t["file"]["attachId"]}var i=this.agent.getItem(e.id).node,s=this._camelToSNAKE(t["file"]);if(BX(i)){var o=BX.message("DISK_TMPLT_THUMB2").replace("#control_name#",this.params.controlName).replace("#CONTROL_NAME#",this.params.controlName),a;for(var n in s){if(s.hasOwnProperty(n)){a=s[n];if(n.toLowerCase()=="size"){if(s.hasOwnProperty("size_int")){if(parseInt(s["size_int"],10)==0){a=""}}if(s.hasOwnProperty("SIZE_INT")){if(parseInt(s["SIZE_INT"],10)==0){a=""}}}if(n.toLowerCase()=="storage"&&a==="disk"){l(s.id).then(function(e){if(e.crumbs){var t=e.crumbs.join(" / ");var i=BX("disk-edit-attach"+s.id);if(i){var o=BX.findChild(i,{className:"files-placement"},true);if(o){BX.adjust(o,{text:t})}}}})}o=o.replace(new RegExp("#"+n.toLowerCase()+"#","gi"),a).replace(new RegExp("#"+n.toUpperCase()+"#","gi"),a)}}o=o.replace(new RegExp("#(width|height)#","gi"),"0").replace(new RegExp("#preview_url#","gi"),"javascript:void(0);");var r={id:"disk-edit-attach"+s.id,"bx-agentFileId":e.id},d;if(s["XML_ID"])r["bx-attach-xml-id"]=s["XML_ID"];if(s["FILE_ID"])r["bx-attach-file-id"]="n"+s["FILE_ID"];if(s["FILE_TYPE"])r["bx-attach-file-type"]=s["FILE_TYPE"];d=BX.create("TR",{attrs:r,props:{className:"wd-inline-file"},html:o});if(!t.file.canChangeName){var h=BX.findChild(d,{className:"files-name-edit-btn"},true);if(h){BX.remove(h)}}i.parentNode.replaceChild(d,i);s.element_id=s.id;this.onFileIs(d,e,s)}else{this.onUploadError(e,t,this.agent)}},onUploadError:function(e,t,i){var s=this.agent.getItem(e.id);if(!!s&&(s=s.node)&&BX(s)&&(i==true||!BX(s).hasAttribute("bx-disk-error"))){BX(s).setAttribute("bx-disk-error","Y");BX.adjust(s,{props:{className:"error-load"}});var o=t&&t["error"]?t["error"]:"Uploading error";s.cells[1].innerHTML="";s.cells[2].innerHTML='<span class="info-icon"></span><span class="error-text">'+o+"</span>";BX.onCustomEvent(e,"OnFileUploadFailed",[s,this]);BX.onCustomEvent(this.params.controller.parentNode,"OnFileUploadFailed",[s,this,e.file,e])}},onError:function(e,t,i){var s="Uploading error.",o=s,a,n;if(i){if(i["error"]&&typeof i["error"]=="string")o=i["error"];else if(i["message"]&&typeof i["message"]=="string")o=i["message"];else if(BX.type.isArray(i["errors"])&&i["errors"].length>0){o=[];for(var l=0;l<i["errors"].length;l++){if(typeof i["errors"][l]=="object"&&i["errors"][l]["message"])o.push(i["errors"][l]["message"])}if(o.length<=0)o.push("Uploading error.");o=o.join(" ")}}e.files=e.files||{};for(n in e.files){if(e.files.hasOwnProperty(n)){a=this.agent.queue.items.getItem(n);this.onUploadError(a,{error:o},o!=s)}}},onBlurRenameInput:function(e){var t=e.target||e.srcElement;var i=BX.findChild(t.parentNode,{className:"files-name-edit-btn"},true);if(!!i)BX.fireEvent(i,"click")},bindEventsHandlers:function(t,i,s){var o=s.element_id,a="file-action-control",n=BX.findChild(t,{className:"files-path"},true),l=BX.findChild(t,{className:"files-name-edit-btn"},true),r=BX.findChild(t,{className:"f-wrap"},true);if(!!l&&!!n&&!!r&&!n.getAttribute(a)){n.setAttribute(a,"enabled");BX.show(n,"inline");BX.hide(BX.findChild(t,{className:"files-placement"},true));BX.bind(n,"click",BX.delegate(function(){this.move(o,r.innerHTML,t)},this))}if(!!l){BX.bind(l,"click",BX.delegate(function(){BX.toggleClass(l.parentNode,"files-name-editable");this.rename(o,t)},this));var d=BX.findChild(t,{className:"files-name-edit-inp"},true);if(d){BX.bind(d,"keydown",BX.delegate(function(i){var s=(i||e.event).keyCode||(i||e.event).charCode;if(s==13){BX.unbind(d,"blur",BX.proxy(this.onBlurRenameInput,this));BX.toggleClass(l.parentNode,"files-name-editable");this.rename(o,t);return BX.PreventDefault(i)}if(s==27){BX.unbind(d,"blur",BX.proxy(this.onBlurRenameInput,this));BX.toggleClass(l.parentNode,"files-name-editable");this.revertRename(o,t);return BX.PreventDefault(i)}},this))}}var h=BX.findChild(t,{className:"feed-add-post-loading"},true),u=BX.delegate(function(){this.deleteFile(t,i)},this),c=BX.create("SPAN",{props:{className:"del-but"},events:{click:u}});if(!!h){var m=BX.findChild(h,{className:"del-but"},true);if(!!m)BX.bind(m,"click",u);else h.appendChild(c.cloneNode(true))}if(!BX.findChild(t,{className:"files-info"},true)){t.appendChild(BX.create("TD",{props:{className:"files-info"}}))}if(!BX.findChild(t,{className:"files-del-btn"},true)){t.appendChild(BX.create("TD",{props:{className:"files-del-btn"},children:[c]}))}if(!c.hasAttribute("bx-bound")){c.setAttribute("bx-bound","Y");BX.bind(c,"click",u);BX.onCustomEvent(t,"OnMkClose",[t])}var p=BX.findChild(t,{className:"transformer-upgrade-popup"},true);if(p){BX.show(p.parentNode);BX.bind(p,"click",BX.proxy(BX.Disk.UF.showTransformationUpgradePopup,this))}},deleteFile:function(e,t){if(!!t.__disk_element_id){BX.Disk.ajax({url:this.urlDeleteFile,method:"POST",dataType:"json",data:{attachedId:t.__disk_element_id},onsuccess:function(e){}});BX.onCustomEvent(this.controller.parentNode,"OnFileUploadRemove",[t.__disk_element_id,this])}BX.removeCustomEvent(t,"onFileIsAttached",this._onFileIsAttached);BX.removeCustomEvent(t,"onFileIsAppended",this._onFileIsAppended);BX.removeCustomEvent(t,"onFileIsBound",this._onFileIsBound);BX.removeCustomEvent(t,"onUploadProgress",this._onUploadProgress);BX.removeCustomEvent(t,"onUploadDone",this._onUploadDone);BX.removeCustomEvent(t,"onUploadError",this._onUploadError);delete t.hash;t.deleteFile("deleteFile");BX.remove(e)},move:function(e,t,i){var s=this._addUrlParam(this.urlSelect.replace("ACTION=SELECT","").replace("MULTI=Y",""),"ID=E"+e+"&NAME="+t+"&wish=fakemove");while(s.indexOf("&&")>=0)s=s.replace("&&","&");if(!this._checkFileName){this._checkFileName=BX.proxy(this.checkFileName,this);this._selectFolder=BX.proxy(this.selectFolder,this);this._openSection=BX.proxy(this.openSection,this);this._selectItem=BX.proxy(this.selectItem,this);this._unSelectItem=BX.proxy(this.unSelectItem,this)}var o=i||BX("disk-edit-attach"+e),a=BX.findChild(o,{className:"f-wrap"},true);BX.DiskFileDialog.arParams={};BX.DiskFileDialog.arParams[this.dialogName]={element_id:e,element_name:a.innerHTML};BX.addCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.addCustomEvent(BX.DiskFileDialog,"selectItem",this._selectItem);BX.addCustomEvent(BX.DiskFileDialog,"unSelectItem",this._unSelectItem);return BX.ajax.get(s,"dialogName="+this.dialogName,BX.delegate(function(){setTimeout(BX.delegate(function(){BX.DiskFileDialog.obCallback[this.dialogName]={saveButton:this._selectFolder};BX.DiskFileDialog.openDialog(this.dialogName)},this),100)},this))},rename:function(e,t){if(!this.urlRenameFile){return}var i=BX.findChild(t,{className:"files-name-editable"},true);var s=BX.findChild(t,{className:"files-name-edit-inp"},true);var o=BX.findChild(t,{className:"f-wrap"},true);var a=o.textContent||o.innerText;var n=a.split(".").pop();var l=s.value+"."+n;if(!!i){BX.focus(s);BX.bind(s,"blur",BX.proxy(this.onBlurRenameInput,this))}else if(s.value&&l!==a){BX.adjust(o,{text:l});var r=t.getAttribute("bx-agentFileId");var d=r?this.agent.getItem(r):null;if(!!d){d.item.file.name=l;d.item.name=l}var h=this.manager?this.manager.checkFile("disk_file"+e):null;if(!!h){h.name=l}BX.Disk.ajax({url:this.urlRenameFile,method:"POST",dataType:"json",data:{newName:l,attachedId:e},onsuccess:function(e){}})}},revertRename:function(e,t){if(!this.urlRenameFile){return}var i=BX.findChild(t,{className:"files-name-editable"},true);var s=BX.findChild(t,{className:"files-name-edit-inp"},true);var o=BX.findChild(t,{className:"f-wrap"},true);var a=o.textContent||o.innerText;var n=a.split(".");var l=n.pop();s.value=n.join(".")},showMovedFile:function(e,t,i){if(!e)return false;var s,o=e,a=BX("disk-edit-attach"+o),n=BX.findChild(a,{className:"files-path"},true);BX.cleanNode(n);i=i.split("/").join(" / ");n.innerHTML=i;var l=parseInt(n.offsetWidth);var r=parseInt(n.parentNode.offsetWidth)-150,d;s=r/(l/i.length);if(l>r){d=Math.floor(s/2)+1;i=i.substr(0,d)+" ... "+i.substr(i.length-d);n.innerHTML=i}var h=BX("diskuf-doc"+o);if(!!h){var u=this._fileUnserialize(h.value);u.section=t["sectionID"];u.iblock=t["iblockID"];h.value=this._fileSerialize(u)}return true},_fileUnserialize:function(e){if(!BX.type.isString(e))return false;var t=e.split("|");return{id:t[0]||0,section:t[1]||0,iblock:t[2]||0}},_fileSerialize:function(e){var t=[e.id,e.section,e.iblock];return t.join("|")},selectFolder:function(e,t,i,s){var o=false,a=false,n,l,r;if(BX.DiskFileDialog.arParams&&BX.DiskFileDialog.arParams[this.dialogName]&&BX.DiskFileDialog.arParams[this.dialogName]["element_id"])o=BX.DiskFileDialog.arParams[this.dialogName]["element_id"];var d=BX.delegate(function(e,t,i,s){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","moveUploadedFile"),data:{attachedId:e,targetFolderId:t},onsuccess:BX.delegate(function(t){if(!t||t.status!="success"){BX.Disk.showModalWithStatusAction(t);return}this.showMovedFile(e,i,s)},this)})},this);for(n in i){if(i.hasOwnProperty(n)&&i[n].type==="folder"){l=e.name+i[n].path;r={sectionID:n,iblockID:e.iblock_id};d(o,i[n].id,r,l);a=true}}if(!a){l=e.name;r={sectionID:e.section_id,iblockID:e.iblock_id};if(!!s&&!!s.path&&s.path!="/"){l+=s.path;r.sectionID=s.id;if(!!s){d(o,s.id,r,l)}}}BX.removeCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.removeCustomEvent(BX.DiskFileDialog,"loadItemsDone",this._checkFileName);BX.removeCustomEvent(BX.DiskFileDialog,"selectItem",this._selectItem);BX.removeCustomEvent(BX.DiskFileDialog,"unSelectItem",this._unSelectItem)},checkFileName:function(e){if(this.noticeTimeout){clearTimeout(this.noticeTimeout);this.noticeTimeout=null}if(!!e&&e!=this.dialogName)return;var t=BX.DiskFileDialog.arParams[this.dialogName]["element_name"];var i=false,s;for(s in BX.DiskFileDialog.obItems[this.dialogName]){if(BX.DiskFileDialog.obItems[this.dialogName].hasOwnProperty(s)){if(BX.DiskFileDialog.obItems[this.dialogName][s]["name"]==t)i=true;if(i)break}}if(i)BX.DiskFileDialog.showNotice(BX.message("DISK_FILE_EXISTS"),this.dialogName);else BX.DiskFileDialog.closeNotice(this.dialogName)},selectItem:function(e,t,i){if(i!=this.dialogName)return;var s=t.substr(1);var o=BX.DiskFileDialog.obCurrentTab[i].link;o=o.replace("/index.php","")+"/element/upload/"+s+"/?use_light_view=Y&AJAX_CALL=Y&SIMPLE_UPLOAD=Y&IFRAME=Y&sessid="+BX.bitrix_sessid()+"&SECTION_ID="+s+"&CHECK_NAME="+BX.DiskFileDialog.arParams[this.dialogName]["element_name"];o=o.replace("/files/lib/","/files/");BX.ajax.loadJSON(o,BX.delegate(function(e){var t=e.permission===true&&e["okmsg"]!="";if(this.noticeTimeout){clearTimeout(this.noticeTimeout);this.noticeTimeout=null}this.noticeTimeout=setTimeout(BX.delegate(function(){if(t){BX.DiskFileDialog.showNotice(this.msg.file_exists,this.dialogName)}else{BX.DiskFileDialog.closeNotice(this.dialogName)}},this),200)},this))},unSelectItem:function(){if(this.noticeTimeout){clearTimeout(this.noticeTimeout);this.noticeTimeout=null}this.noticeTimeout=setTimeout(BX.delegate(function(){this.checkFileName()},this),200)},openSection:function(e,t){if(t==this.dialogName){BX.DiskFileDialog.target[t]=this._addUrlParam(e,"dialog2=Y")}},openSectionCloud:function(e,t){if(t==this.dialogName){BX.DiskFileDialog.target[t]=this._addUrlParam(e,"dialog2=Y");BX.DiskFileDialog.target[t]=this._addUrlParam(BX.DiskFileDialog.target[t],"cloudImport=1")}},selectFile:function(e,t,i){var s=[],o;for(o in i){if(i.hasOwnProperty(o)){if(i[o].type=="file"&&!BX(this.prefix+o)){i[o].sizeFormatted=i[o]["size"];i[o].size=i[o]["sizeInt"];if(!i[o]["ext"])i[o]["ext"]=i[o]["name"].split(".").pop();if(!i[o]["storage"])i[o]["storage"]="";s.push(i[o])}}}this.agent.onAttach(s,s);BX.removeCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection)},selectCloudFile:function(e,t,i){var s=[],o;for(o in i){if(i.hasOwnProperty(o)){if(i[o].type=="file"&&!BX(this.prefix+o)){if(i[o].hasOwnProperty("provider")){i[o].service=i[o].provider}else{i[o].service=a}i[o].sizeFormatted=i[o]["size"];i[o].size=i[o]["sizeInt"];if(!i[o]["ext"])i[o]["ext"]=i[o]["name"].split(".").pop();if(!i[o]["storage"])i[o]["storage"]="";s.push(i[o])}}}this.agent.onAttach(s,s);BX.removeCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection)},showSelectDialog:function(){this._openSection=BX.proxy(this.openSection,this);this._selectFile=BX.proxy(this.selectFile,this);BX.addCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.ajax.get(this.urlSelect,"dialogName="+this.dialogName,BX.delegate(function(){setTimeout(BX.delegate(function(){BX.DiskFileDialog.obCallback[this.dialogName]={saveButton:this._selectFile};BX.DiskFileDialog.openDialog(this.dialogName)},this),10)},this))},showSelectDialogCloudImport:function(e){var t=e.target||e.srcElement;if(!BX.hasClass(t,"diskuf-selector-link-cloud")){t=BX.findParent(t,{className:"diskuf-selector-link-cloud"})}if(!t||!t.getAttribute("data-bx-doc-handler"))return;a=t.getAttribute("data-bx-doc-handler");this._openSection=BX.proxy(this.openSectionCloud,this);this._selectFile=BX.proxy(this.selectFile,this);this._selectCloudFile=BX.proxy(this.selectCloudFile,this);BX.addCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.ajax.get(this.urlSelect,"&cloudImport=1&service="+a+"&dialogName="+this.dialogName,BX.delegate(function(){setTimeout(BX.delegate(function(){BX.DiskFileDialog.obCallback[this.dialogName]={saveButton:this._selectCloudFile};BX.DiskFileDialog.openDialog(this.dialogName)},this),10)},this))}};return t}();BX.Disk.UF.dndCatcher={};BX.Disk.UF.add=function(e){e["controller"]=BX("diskuf-selectdialog-"+e["UID"]);if(e["controller"]&&BX.isNodeInDom(e["controller"])){e["values"]=BX.findChildren(e["controller"],{className:"wd-inline-file"},true);var t=BX(e["controller"]).parentNode;BX.onCustomEvent(e["controller"],"DiskLoadFormControllerWasBound",[e,"DiskLoadFormControllerWasBound"]);if(!BX(e["controller"]).hasAttribute("bx-disk-load-is-bound")){BX(e["controller"]).setAttribute("bx-disk-load-is-bound","Y");BX.addCustomEvent(t,"DiskLoadFormController",function(t){BX.Disk.UF.initialize(t,e)})}if(!!e["values"]&&e["values"].length>0&&!e["hideSelectDialog"])BX.onCustomEvent(e["controller"].parentNode,"DiskLoadFormController",["show"])}};BX.Disk.UF.initialize=function(e,t){e=e==="show"||e==="hide"?e:t["controller"].style.display!="none"?"hide":"show";if(!t["controller"].loaded){t["controller"].loaded=true;n[t["UID"]]=new BX.Disk.UF(t)}if(e=="show"){if(t["controller"].style.display!="block"){BX.fx.show(t["controller"],"fade",{time:.2});if(t["switcher"]&&t["switcher"].style.display!="none")BX.fx.hide(t["switcher"],"fade",{time:.1});BX.onCustomEvent(t["controller"],"onControllerIsShown",[t["controller"],n[t["UID"]]]);o=n[t["UID"]]}}else if(t["controller"].style.display!="none"){o=null;BX.fx.hide(t["controller"],"fade",{time:.2});BX.onCustomEvent(t["controller"],"onControllerIsHidden",[t["controller"],n[t["UID"]]])}return n[t["UID"]]};var l=function(e){return BX.Disk.ajaxPromise({url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","getBreadcrumbs"),method:"POST",dataType:"json",data:{attachedId:e}})};var r=function(e){if(!BX(e)||e.hasAttribute("bx-is-bound"))return;e.setAttribute("bx-is-bound","Y");this.img=e;this.node=e.parentNode.parentNode.parentNode;BX.unbindAll(e);BX.unbindAll(this.node);BX.show(this.node);BX.remove(this.node.nextSibling);this.id="wufdp_"+Math.random();BX.bind(this.node,"mouseover",BX.delegate(function(){this.turnOn()},this));BX.bind(this.node,"mouseout",BX.delegate(function(){this.turnOff()},this))};r.prototype={turnOn:function(){this.timeout=setTimeout(BX.delegate(function(){this.show()},this),500)},turnOff:function(){clearTimeout(this.timeout);this.timeout=null;this.hide()},show:function(){if(this.popup!=null)this.popup.close();if(this.popup==null){var e={width:this.img.naturalWidth,height:this.img.naturalHeight};if(BX["UploaderUtils"]){var t=BX.UploaderUtils.scaleImage(e,{width:parseInt(BX.message("DISK_THUMB_WIDTH")),height:parseInt(BX.message("DISK_THUMB_HEIGHT"))});e=t.destin}this.popup=new BX.PopupWindow("bx-wufd-preview-img-"+this.id,this.img.parentNode,{lightShadow:true,offsetTop:-7,offsetLeft:(51-28)/2+14,autoHide:true,closeByEsc:true,bindOptions:{position:"top"},events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.proxy(function(){this.popup=null},this)},content:BX.create("DIV",{props:e,children:[BX.create("IMG",{props:e,attrs:{src:this.img.src}})]})});this.popup.show()}this.popup.setAngle({position:"bottom"});this.popup.bindOptions.forceBindPosition=true;this.popup.adjustPosition();this.popup.bindOptions.forceBindPosition=false},hide:function(){if(this.popup!=null)this.popup.close()}};BX.addCustomEvent("onDiskPreviewIsReady",function(e){new r(e)});BX.Disk.UF.runImport=function(e){BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_PROCESS_LOADING"),showLoaderIcon:true,autoHide:false});BX.Disk.ExternalLoader.reloadLoadAttachedObject({attachedObject:{id:e.id,name:e.name,service:e.service},onFinish:BX.delegate(function(e){if(e.hasOwnProperty("hasNewVersion")&&!e.hasNewVersion){BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_HAS_LAST_VERSION"),showSuccessIcon:true,autoHide:true})}else if(e.status==="success"){BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_SUCCESS_LOADING"),showSuccessIcon:true,autoHide:true})}else{BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_FAIL_LOADING"),autoHide:true})}},this),onProgress:BX.delegate(function(e){},this)}).start()};BX.Disk.UF.disableAutoCommentToAttachedObject=function(e){var t=e.attachedId;BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","disableAutoCommentToAttachedObject"),data:{attachedId:t},onsuccess:BX.delegate(function(e){},this)})};BX.Disk.UF.enableAutoCommentToAttachedObject=function(e){var t=e.attachedId;BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","enableAutoCommentToAttachedObject"),data:{attachedId:t},onsuccess:BX.delegate(function(e){},this)})};BX.Disk.UF.showTransformationUpgradePopup=function(e){B24.licenseInfoPopup.show("disk_transformation_video_limit",BX.message("DISK_UF_CONTROLLER_TRANSFORMATION_UPGRADE_POPUP_TITLE"),BX.message("DISK_UF_CONTROLLER_TRANSFORMATION_UPGRADE_POPUP_CONTENT"),false)};e.DiskCreateDocument=function(e){if(!o){return false}if(!e){return false}var t=new BX.CViewer({createDoc:true});var i=t.createBlankElementByParams({docType:e,editUrl:BX.message("DISK_CREATE_BLANK_URL"),renameUrl:BX.message("DISK_RENAME_FILE_URL")});t.setCurrent(i);i.afterSuccessCreate=function(e){var t={};var i=e.name.split(".");i.pop();t["E"+e.objectId]={type:"file",id:"n"+e.objectId,name:e.name,label:i.join("."),storage:e.folderName,size:e.size,sizeInt:e.sizeInt,ext:e.extension,canChangeName:true,link:e.link};setTimeout(function(){o.selectFile({},{},t)},200)};t.runActionByCurrentElement("create",{obElementViewer:t});try{BX.PreventDefault()}catch(e){}return false};e.DiskOpenMenuCreateService=function(e){var t=new BX.CViewer({});t.openMenu("disk_open_menu_with_services",BX(e),[BX.CViewer.isDisabledLocalEdit?null:{text:BX.message("DISK_FOLDER_TOOLBAR_LABEL_LOCAL_BDISK_EDIT"),className:"bx-viewer-popup-item item-b24",href:"#",onclick:BX.delegate(function(t){if(BX.CViewer.isEnableLocalEditInDesktop()){this.setEditService("l");BX.adjust(e,{text:BX.message("DISK_FOLDER_TOOLBAR_LABEL_LOCAL_BDISK_EDIT")});BX.PopupMenu.destroy("disk_open_menu_with_services")}else{this.helpDiskDialog()}return BX.PreventDefault(t)},t)},{text:t.getNameEditService("google"),className:"bx-viewer-popup-item item-gdocs",href:"#",onclick:BX.delegate(function(t){this.setEditService("google");BX.adjust(e,{text:this.getNameEditService("google")});BX.PopupMenu.destroy("disk_open_menu_with_services");return BX.PreventDefault(t)},t)},{text:t.getNameEditService("office365"),className:"bx-viewer-popup-item item-office365",href:"#",onclick:BX.delegate(function(t){this.setEditService("office365");BX.adjust(e,{text:this.getNameEditService("office365")});BX.PopupMenu.destroy("disk_open_menu_with_services");return BX.PreventDefault(t)},t)},{text:t.getNameEditService("skydrive"),className:"bx-viewer-popup-item item-office",href:"#",onclick:BX.delegate(function(t){this.setEditService("skydrive");BX.adjust(e,{text:this.getNameEditService("skydrive")});BX.PopupMenu.destroy("disk_open_menu_with_services");return BX.PreventDefault(t)},t)}],{offsetTop:0,offsetLeft:25})};e.DiskOpenMenuImportService=function(e,t){var i=[];for(var s in t){if(!t.hasOwnProperty(s))continue;i.push({text:t[s].name,code:t[s].id,href:"#",onclick:function(e,t){var i=t.layout.item;BX.addClass(i,"diskuf-selector-link-cloud");i.setAttribute("data-bx-doc-handler",t.code);BX.onCustomEvent("onManualChooseCloudImport",[{target:i}]);BX.removeClass(i,"diskuf-selector-link-cloud");i.removeAttribute("data-bx-doc-handler");BX.PopupMenu.destroy("disk_open_menu_with_import_services");return BX.PreventDefault(e)}})}var o=new BX.CViewer({});o.openMenu("disk_open_menu_with_import_services",BX(e),i,{offsetTop:0,offsetLeft:25});return BX.PreventDefault()};e.DiskActionFileMenu=function(e,t,i){s++;BX.PopupMenu.show("bx-viewer-wd-popup"+s+"_"+e,BX(t),i,{angle:{position:"top",offset:25},autoHide:true});return false};e.WDInlineElementClickDispatcher=function(e,t){var i=BX(t);if(i){BX.fireEvent(i,"click")}return false}})(window);
/* End */
;; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?154412738440309*/
; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js?1544127384575*/
; /* /bitrix/components/bitrix/crm.product_row.list/templates/.default/script.min.js?1544127401100018*/
; /* /bitrix/components/bitrix/crm.product_row.list/templates/.default/product_create.min.js?15441274018298*/
; /* /bitrix/components/bitrix/crm.lead.menu/templates/.default/script.js?1544127401481*/
; /* /bitrix/components/bitrix/crm.interface.toolbar/templates/slider/script.min.js?154412740112549*/
; /* /bitrix/components/bitrix/crm.entity.details/templates/.default/script.min.js?154412740123674*/
; /* /bitrix/components/bitrix/crm.entity.progressbar/templates/.default/script.min.js?154412740118911*/
; /* /bitrix/components/bitrix/crm.entity.editor/templates/.default/script.min.js?1544127401471392*/
; /* /bitrix/components/bitrix/crm.entity.editor/templates/.default/js/field-attr.min.js?154412740118988*/
; /* /bitrix/components/bitrix/crm.entity.editor/templates/.default/order.min.js?1544127401161864*/
; /* /bitrix/components/bitrix/crm.timeline/templates/.default/script.min.js?1544127401232538*/
; /* /bitrix/components/bitrix/main.post.form/templates/.default/script.min.js?154412738466246*/
; /* /bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js?154412740428279*/

//# sourceMappingURL=page_3e94bc6aaeaf478261fb2fad29901207.map.js