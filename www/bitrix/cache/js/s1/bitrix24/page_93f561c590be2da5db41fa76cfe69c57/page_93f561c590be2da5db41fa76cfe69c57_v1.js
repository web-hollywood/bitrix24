
; /* Start:"a:4:{s:4:"full";s:97:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?154412738440309";s:6:"source";s:77:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Main");if(typeof BX.Main.interfaceButtons==="undefined"){BX.Main.interfaceButtons=function(t,e){this.classItem="main-buttons-item";this.classItemSublink="main-buttons-item-sublink";this.classItemText="main-buttons-item-text";this.classItemCounter="main-buttons-item-counter";this.classItemIcon="main-buttons-item-icon";this.classItemMore="main-buttons-item-more";this.classOnDrag="main-buttons-drag";this.classDropzone="main-buttons-submenu-dropzone";this.classSeporator="main-buttons-submenu-separator";this.classHiddenLabel="main-buttons-hidden-label";this.classSubmenuItem="main-buttons-submenu-item";this.classItemDisabled="main-buttons-disabled";this.classItemOver="over";this.classItemActive="main-buttons-item-active";this.classSubmenu="main-buttons-submenu";this.classSecret="secret";this.classItemLocked="locked";this.submenuIdPrefix="main_buttons_popup_";this.childMenuIdPrefix="main_buttons_popup_child_";this.submenuWindowIdPrefix="menu-popup-";this.classSettingMenuItem="main-buttons-submenu-setting";this.classEditState="main-buttons-edit";this.classEditItemButton="main-buttons-item-edit-button";this.classDragItemButton="main-buttons-item-drag-button";this.classSettingsApplyButton="main-buttons-submenu-settings-apply";this.classSettingsResetButton="main-buttons-submenu-settings-reset";this.classSetHome="main-buttons-set-home";this.classSetHide="main-buttons-set-hide";this.classManage="main-buttons-manage";this.classContainer="main-buttons";this.classSubmenuNoHiddenItem="main-buttons-submenu-item-no-hidden";this.classDefaultSubmenuItem="menu-popup-item";this.classInner="main-buttons-inner-container";this.listContainer=null;this.pinContainer=null;this.dragItem=null;this.overItem=null;this.moreButton=null;this.messages=null;this.licenseParams=null;this.isSubmenuShown=false;this.isSubmenuShownOnDragStart=false;this.isSettingsEnabled=true;this.containerId=e.containerId;this.tmp={};this.init(t,e);return{getItemById:BX.delegate(this.getItemById,this),getAllItems:BX.delegate(this.getAllItems,this),getHiddenItems:BX.delegate(this.getHiddenItems,this),getVisibleItems:BX.delegate(this.getVisibleItems,this),getDisabledItems:BX.delegate(this.getDisabledItems,this),getMoreButton:BX.delegate(this.getMoreButton,this),adjustMoreButtonPosition:BX.delegate(this.adjustMoreButtonPosition,this),showSubmenu:BX.delegate(this.showSubmenu,this),closeSubmenu:BX.delegate(this.closeSubmenu,this),refreshSubmenu:BX.delegate(this.refreshSubmenu,this),getCurrentSettings:BX.delegate(this.getCurrentSettings,this),saveSettings:BX.delegate(this.saveSettings,this),setCounterValueByItemId:BX.delegate(this.setCounterValueByItemId,this),getCounterValueByItemId:BX.delegate(this.getCounterValueByItemId,this),updateCounter:BX.delegate(this.updateCounter,this),getActive:BX.delegate(this.getActive,this),isEditEnabled:BX.delegate(this.isEditEnabled,this),isActiveInMoreMenu:BX.delegate(this.isActiveInMoreMenu,this),isSettingsEnabled:this.isSettingsEnabled,classes:{item:this.classItem,itemText:this.classItemText,itemCounter:this.classItemCounter,itemIcon:this.classItemIcon,itemDisabled:this.classItemDisabled,itemOver:this.classItemOver,itemActive:this.classItemActive,itemLocked:this.classItemLocked,submenu:this.classSubmenu,submenuItem:this.classSubmenuItem,containerOnDrag:this.classOnDrag,classSettingMenuItem:this.classSettingMenuItem},itemsContainer:this.listContainer,itemsContainerId:this.listContainer.id}};BX.Main.interfaceButtons.prototype={init:function(t,e){this.listContainer=BX(this.getId());if(!BX.type.isPlainObject(e)){throw"BX.MainButtons: params is not Object"}if(!("containerId"in e)||!BX.type.isNotEmptyString(e.containerId)){throw"BX.MainButtons: containerId not set in params"}if(!BX.type.isDomNode(this.listContainer)){throw"BX.MainButtons: #"+e.containerId+" is not dom node"}if("classes"in e&&BX.type.isPlainObject(e.classes)){this.setCustomClasses(e.classes)}if("messages"in e&&BX.type.isPlainObject(e.messages)){this.setMessages(e.messages)}if("licenseWindow"in e&&BX.type.isPlainObject(e.licenseWindow)){this.setLicenseWindowParams(e.licenseWindow)}if("disableSettings"in e&&e.disableSettings==="true"){this.isSettingsEnabled=false;this.visibleControlMoreButton()}this.moreButton=this.getMoreButton();this.listChildItems={};if(this.isSettingsEnabled){this.dragAndDropInit()}this.adjustMoreButtonPosition();this.bindOnClickOnMoreButton();this.bindOnScrollWindow();this.setContainerHeight();BX.bind(this.getContainer(),"click",BX.delegate(this._onDocumentClick,this));BX.addCustomEvent("onPullEvent-main",BX.delegate(this._onPush,this));this.updateMoreButtonCounter();if(this.isActiveInMoreMenu()){this.activateItem(this.moreButton)}var i=this.getVisibleItems();var s=BX.type.isArray(i)&&i.length>0?i[0]:null;var n=BX.Buttons.Utils.getByTag(s,"a");if(!BX.type.isDomNode(n)){return}var a=n.getAttribute("href");if(a.charAt(0)==="?"){a=n.pathname+n.search}if(!this.lastHomeLink){this.lastHomeLink=a}this.bindOnResizeFrame()},_onDocumentClick:function(t){var e=this.getItem(t);var i,s,n,a,o,u;if(this.isDragButton(t.target)){t.preventDefault();t.stopPropagation()}if(BX.type.isDomNode(e)){if(this.isSettings(e)){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton());return false}if(this.isApplySettingsButton(e)){t.preventDefault();t.stopPropagation();this.disableEdit();BX.show(this.getSettingsButton());BX.hide(this.getSettingsApplyButton());return false}if(this.isResetSettingsButton(e)){this.resetSettings();return false}if(this.isLocked(e)){t.preventDefault();this.showLicenseWindow();return false}if(this.isEditButton(t.target)){var r,h;t.preventDefault();t.stopPropagation();if(this.isSubmenuItem(e)){e=this.getItemAlias(e)}try{r=JSON.parse(BX.data(e,"item"))}catch(t){}h=this.getItemEditMenu();if(h&&h.popupWindow.isShown()&&this.lastEditNode===e){h.popupWindow.close()}else{this.showItemEditMenu(r,t.target)}this.lastEditNode=e;return false}if(this.isSetHide(e)){o=this.getVisibleItems();u=BX.type.isArray(o)?o.length:null;a=this.editItemData.ID.replace(this.listContainer.id+"_","");s=this.getItemById(a);n=this.getItemAlias(s);s=this.isVisibleItem(s)?s:n;if(this.isDisabled(n)){this.enableItem(n)}else if(!this.isDisabled(n)&&u>2){this.disableItem(n)}if(u===2){BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[s,this])}this.refreshSubmenu();this.saveSettings();this.adjustMoreButtonPosition();if(this.isEditEnabled()){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton())}this.editMenu.popupWindow.close();return false}if(this.isSetHome(e)){a=this.editItemData.ID.replace(this.listContainer.id+"_","");s=this.getItemById(a);n=this.getItemAlias(s);if(this.isDisabled(n)){this.enableItem(n)}this.listContainer.insertBefore(s,BX.firstChild(this.listContainer));this.adjustMoreButtonPosition();this.refreshSubmenu();this.saveSettings();if(this.isEditEnabled()){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton())}this.editMenu.popupWindow.close();return false}if(!this.isSublink(t.target)){i=this.dataValue(e,"onclick");if(BX.type.isNotEmptyString(i)){t.preventDefault();this.execScript(i)}}}if(this.isEditEnabled()){this.getSubmenu().popupWindow.setAutoHide(false)}},isActiveInMoreMenu:function(){var t=this.getHiddenItems();var e=this.getDisabledItems();var i=t.concat(e);return i.some(function(t){var e;try{e=JSON.parse(BX.data(t,"item"))}catch(t){}return BX.type.isPlainObject(e)&&("IS_ACTIVE"in e&&e.IS_ACTIVE===true||e.IS_ACTIVE==="true"||e.IS_ACTIVE==="Y")},this)},_onPush:function(t,e){if(t==="user_counter"&&e&&BX.message("SITE_ID")in e){var i=e[BX.message("SITE_ID")];for(var s in i){if(i.hasOwnProperty(s)){this.updateCounter(s,i[s])}}}},bindOnScrollWindow:function(){BX.bind(window,"scroll",BX.delegate(this._onScroll,this))},getActive:function(){var t=this.getAllItems();var e,i;var s=null;if(BX.type.isArray(t)){t.forEach(function(t){try{e=JSON.parse(BX.data(t,"item"))}catch(t){e=null}if(BX.type.isPlainObject(e)&&"IS_ACTIVE"in e&&(e.IS_ACTIVE===true||e.IS_ACTIVE==="true"||e.IS_ACTIVE==="Y")){s=e}},this)}if(BX.type.isPlainObject(s)){i=BX(s.ID);if(BX.type.isDomNode(i)){s.NODE=i}else{s.NODE=null}}return s},isSetHome:function(t){return BX.hasClass(t,this.classSetHome)},isSetHide:function(t){return BX.hasClass(t,this.classSetHide)},getSettingsButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingMenuItem)},getSettingsApplyButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingsApplyButton)},isApplySettingsButton:function(t){return BX.hasClass(t,this.classSettingsApplyButton)},enableEdit:function(){var t=this.getSubmenu();if(t&&"popupWindow"in t){t.popupWindow.setAutoHide(false)}BX.addClass(this.listContainer,this.classEditState);BX.addClass(this.getSubmenuContainer(),this.classEditState);this.isEditEnabledState=true},disableEdit:function(){var t=this.getSubmenu();if(t&&"popupWindow"in t){t.popupWindow.setAutoHide(true)}BX.removeClass(this.listContainer,this.classEditState);BX.removeClass(this.getSubmenuContainer(),this.classEditState);this.isEditEnabledState=false},isEditEnabled:function(){return this.isEditEnabledState},showItemEditMenu:function(t,e){if(BX.type.isPlainObject(t)&&"ID"in t){var i=[this.listContainer.id,"_edit_item"].join("");var s=BX.PopupMenu.getMenuById(i);if(s){BX.PopupMenu.destroy(i)}s=this.createItemEditMenu(t,i,e);s.popupWindow.show()}},getContainer:function(){if(!BX.type.isDomNode(this.container)){this.container=BX(this.containerId).parentNode}return this.container},getItemEditMenu:function(){return BX.PopupMenu.getMenuById([this.listContainer.id,"_edit_item"].join(""))},createItemEditMenu:function(t,e,i){var s;var n=[{text:this.message("MIB_SET_HOME"),className:"main-buttons-set-home menu-popup-no-icon"}];var a=t.ID.replace(this.listContainer.id+"_","");var o=this.getItemById(a);if(this.isDisabled(o)){n.push({text:this.message("MIB_SET_SHOW"),className:"main-buttons-set-hide menu-popup-no-icon"})}else{n.push({text:this.message("MIB_SET_HIDE"),className:"main-buttons-set-hide menu-popup-no-icon"})}var u=BX.pos(i);var r={menuId:e,anchor:i,menuItems:n,settings:{autoHide:true,offsetTop:0,offsetLeft:u.width/2,zIndex:20,angle:{position:"top",offset:u.width/2}}};s=BX.PopupMenu.create(r.menuId,r.anchor,r.menuItems,r.settings);if(this.isVisibleItem(o)){t.NODE=o}else{t.NODE=this.getItemAlias(o)}this.editItemData=t;if("menuItems"in s&&BX.type.isArray(s.menuItems)){s.menuItems.forEach(function(t){BX.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))},this)}BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onBeforeCreateEditMenu",[s,t,this]);this.editMenu=s;return s},setHome:function(){var t=this.getVisibleItems();var e=BX.type.isArray(t)&&t.length>0?t[0]:null;var i=BX.Buttons.Utils.getByTag(e,"a");if(!BX.type.isDomNode(i)){return}var s=i.getAttribute("href");if(s.charAt(0)==="?"){s=i.pathname+i.search}if(!this.lastHomeLink){this.lastHomeLink=s}if(this.lastHomeLink!==s){BX.userOptions.save("ui",this.listContainer.id,"firstPageLink",s);BX.onCustomEvent("BX.Main.InterfaceButtons:onFirstItemChange",[s,e])}this.lastHomeLink=s},isEditButton:function(t){return BX.hasClass(t,this.classEditItemButton)},isDragButton:function(t){return BX.hasClass(t,this.classDragItemButton)},isResetSettingsButton:function(t){return BX.hasClass(t,this.classSettingsResetButton)},getContainerHeight:function(){var t=this.getAllItems().map(function(t){var e=getComputedStyle(t);return BX.height(t)+parseInt(e.marginTop)+parseInt(e.marginBottom)});return Math.max.apply(Math,t)},setContainerHeight:function(){var t=this.getContainerHeight();var e=8;BX.height(this.listContainer,t-e)},setLicenseWindowParams:function(t){this.licenseParams=t||{}},message:function(t){var e;try{e=this.messages[t]}catch(t){e=""}return e},setCustomClasses:function(t){if(!BX.type.isPlainObject(t)){return}this.classItem=t.item||this.classItem;this.classItemSublink=t.itemSublink||this.classItemSublink;this.classItemText=t.itemText||this.classItemText;this.classItemCounter=t.itemCounter||this.classItemCounter;this.classItemIcon=t.itemIcon||this.classItemIcon;this.classItemMore=t.itemMore||this.classItemMore;this.classItemOver=t.itemOver||this.classItemOver;this.classItemActive=t.itemActive||this.classItemActive;this.classItemDisabled=t.itemDisabled||this.classItemDisabled;this.classOnDrag=t.onDrag||this.classOnDrag;this.classDropzone=t.dropzone||this.classDropzone;this.classSeporator=t.separator||this.classSeporator;this.classSubmenuItem=t.submenuItem||this.classSubmenuItem;this.classSubmenu=t.submenu||this.classSubmenu;this.classSecret=t.secret||this.classSecret;this.classItemLocked=t.itemLocked||this.classItemLocked},setMessages:function(t){if(!BX.type.isPlainObject(t)){return}this.messages=t},makeFullItemId:function(t){if(!BX.type.isNotEmptyString(t)){return}return[this.listContainer.id,t.replace("-","_")].join("_")},getItemById:function(t){var e=null;var i;if(BX.type.isNotEmptyString(t)){i=this.makeFullItemId(t);e=BX.Buttons.Utils.getBySelector(this.listContainer,"#"+i)}return e},getItemCounterObject:function(t){var e=null;if(BX.type.isDomNode(t)){e=BX.Buttons.Utils.getByClass(t,this.classItemCounter)}return e},setCounterValue:function(t,e){var i=this.getItemCounterObject(t);if(BX.type.isDomNode(i)){i.innerText=e>99?"99+":e>0?e:"";t.dataset.counter=e}this.updateMoreButtonCounter()},updateCounter:function(t,e){if(t.indexOf("crm")===0&&e<0){return}var i,s,n;var a=null;var o=this.getAllItems();if(BX.type.isArray(o)){o.forEach(function(e){try{s=JSON.parse(BX.data(e,"item"))}catch(t){s={}}if(BX.type.isPlainObject(s)&&"COUNTER_ID"in s&&s.COUNTER_ID===t){a=e}},this)}i=this.getItemCounterObject(a);if(BX.type.isDomNode(i)){a=this.getItem(i);i.innerText=e>99?"99+":e>0?e:"";a.dataset.counter=e}n=this.getItemAlias(a);if(BX.type.isDomNode(n)){i=this.getItemCounterObject(n);if(BX.type.isDomNode(i)){i.innerText=e>99?"99+":e>0?e:"";n.dataset.counter=e}}this.updateMoreButtonCounter()},setCounterValueByItemId:function(t,e){var i=e!==null?parseFloat(e):null;var s,n;if(!BX.type.isNotEmptyString(t)){throw"Bad first arg. Need string as item id"}if(i!==null&&!BX.type.isNumber(i)){throw"Bad two arg. Need number counter value - Integer, Float or string with number"}s=this.getItemById(t);if(!BX.type.isDomNode(s)){console.info("Not found node with id #"+t);return}n=this.getItemAlias(s);this.setCounterValue(s,i);this.setCounterValue(n,i)},getCounterValueByItemId:function(t){var e,i;var s=NaN;if(!BX.type.isNotEmptyString(t)){throw"Bad first arg. Need string item id"}else{e=this.getItemById(t);s=this.dataValue(e,"counter");s=parseFloat(s);if(!BX.type.isNumber(s)){i=this.getItemCounterObject(e);s=parseFloat(i.innerText)}}return s},setMoreButtonCounter:function(t){var e=this.getItemCounterObject(this.moreButton);var i=t>99?"99+":t>0?t:"";i=parseInt(i);i=BX.type.isNumber(i)?i:"";e.innerText=i},bindOnClickOnMoreButton:function(){BX.bind(this.moreButton,"click",BX.delegate(this._onClickMoreButton,this))},bindOnResizeFrame:function(){window.frames["maininterfacebuttonstmpframe-"+this.getId()].onresize=BX.throttle(this._onResizeHandler,20,this)},getId:function(){return BX.Buttons.Utils.getByClass(this.getContainer(),this.classInner).id},getAllItems:function(){return BX.Buttons.Utils.getByClass(this.listContainer,this.classItem,true)},getVisibleItems:function(){var t=this.getAllItems();var e=this;var i=[];if(t&&t.length){i=t.filter(function(t){return e.isVisibleItem(t)&&!e.isDisabled(t)})}return i},getHiddenItems:function(){var t=this.getAllItems();var e=[];var i=this;if(t&&t.length){e=t.filter(function(t){return!i.isVisibleItem(t)&&!i.isDisabled(t)})}return e},getDisabledItems:function(){return this.getAllItems().filter(function(t){return this.isDisabled(t)},this)},getMoreButton:function(){var t=null;this.getAllItems().forEach(function(e){!t&&BX.hasClass(e,this.classItemMore)&&(t=e)},this);return t},getLastVisibleItem:function(){var t=this.getVisibleItems();var e=null;if(BX.type.isArray(t)&&t.length){e=t[t.length-1]}if(!BX.type.isDomNode(e)){e=null}return e},adjustMoreButtonPosition:function(){var t=this.getLastVisibleItem();var e=this.isMoreButton(t);if(!e){this.listContainer.insertBefore(this.moreButton,t)}this.updateMoreButtonCounter()},getSubmenuId:function(t){var e="";if(BX.type.isDomNode(this.listContainer)&&BX.type.isNotEmptyString(this.listContainer.id)){e=this.submenuIdPrefix+this.listContainer.id}if(t){e=this.submenuWindowIdPrefix+e}return e},getChildMenuId:function(){var t="";if(BX.type.isDomNode(this.listContainer)&&BX.type.isNotEmptyString(this.listContainer.id)){t=this.childMenuIdPrefix+this.listContainer.id}return t},getSubmenuItemText:function(t){var e,i,s;if(!BX.type.isDomNode(t)){return null}e=this.findChildrenByClassName(t,this.classItemText);i=this.findChildrenByClassName(t,this.classItemCounter);if(BX.type.isDomNode(i)&&BX.type.isDomNode(e)){i.dataset.counter=this.dataValue(t,"counter");s=e.outerHTML+i.outerHTML}else{e=this.dataValue(t,"text");i=this.dataValue(t,"counter");s=e}return s},getChildMenuItemText:function(t){var e,i,s;if(!BX.type.isDomNode(t)){return null}e=this.findChildrenByClassName(t,this.classItemText);i=this.findChildrenByClassName(t,this.classItemCounter);if(BX.type.isDomNode(i)&&BX.type.isDomNode(e)){i.dataset.counter=this.dataValue(t,"counter");s=e.outerHTML+i.outerHTML}else{e=this.dataValue(t,"text");s=e}return s},getLockedClass:function(t){var e="";if(BX.type.isDomNode(t)&&this.isLocked(t)){e=this.classItemLocked}return e},getSubmenuItems:function(){var t=this.getAllItems();var e=this.getHiddenItems();var i=this.getDisabledItems();var s=[];var n,a;if(t.length){t.forEach(function(t){if(e.indexOf(t)===-1&&i.indexOf(t)===-1){s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:[this.classSubmenuItem,this.getIconClass(t),this.classSecret,this.getAliasLink(t),this.getLockedClass(t)].join(" ")})}},this)}if(e.length){e.forEach(function(t){try{n=JSON.parse(this.dataValue(t,"item"))}catch(t){n=null}a=[this.classSubmenuItem,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(BX.type.isPlainObject(n)&&("IS_ACTIVE"in n&&n.IS_ACTIVE===true||n.IS_ACTIVE==="true"||n.IS_ACTIVE==="Y")){a.push(this.classItemActive)}s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:a.join(" "),items:this.getChildMenuItems(t)})},this)}if(this.isSettingsEnabled){s.push({text:"<span>"+this.message("MIB_HIDDEN")+"</span>",className:[this.classSeporator,this.classSubmenuItem,this.classHiddenLabel].join(" ")});if(!i.length){s.push({text:"<span>"+this.message("MIB_NO_HIDDEN")+"</span>",className:[this.classSubmenuItem,this.classSubmenuNoHiddenItem].join(" ")})}if(i.length){i.forEach(function(t){try{n=JSON.parse(this.dataValue(t,"item"))}catch(t){n=null}a=[this.classSubmenuItem,this.classItemDisabled,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(BX.type.isPlainObject(n)&&("IS_ACTIVE"in n&&n.IS_ACTIVE===true||n.IS_ACTIVE==="true"||n.IS_ACTIVE==="Y")){a.push(this.classItemActive)}s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:a.join(" "),items:this.getChildMenuItems(t)})},this)}s.push({text:"<span>"+this.message("MIB_MANAGE")+"</span>",className:[this.classSeporator,this.classSubmenuItem,this.classHiddenLabel,this.classManage].join(" ")});s.push({text:this.message("MIB_SETTING_MENU_ITEM"),className:[this.classSettingMenuItem,this.classSubmenuItem].join(" ")});s.push({text:this.message("MIB_APPLY_SETTING_MENU_ITEM"),className:[this.classSettingsApplyButton,this.classSubmenuItem].join(" ")});s.push({text:this.message("MIB_RESET_SETTINGS"),className:[this.classSettingsResetButton,this.classSubmenuItem].join(" ")})}return s},getChildMenuItems:function(t){var e;try{e=JSON.parse(this.dataValue(t,"item"))}catch(t){e=null}if(!BX.type.isPlainObject(e)){return[]}if(!BX.type.isArray(this.listChildItems[t.id])){var i={};this.setListAllItems(i,e);var s=this.getListItems(i,"");if(s.length){this.listChildItems[t.id]=BX.type.isArray(s[0].items)?s[0].items:[]}}return this.listChildItems[t.id]},setListAllItems:function(t,e){var i=[];if(BX.type.isPlainObject(e)){i.push(e)}else{i=e}i.forEach(function(e){t[e["ID"].replace(this.containerId+"_","")]=e;if(BX.type.isArray(e["ITEMS"])){this.setListAllItems(t,e["ITEMS"])}},this)},getListItems:function(t,e){var i=[];for(var s in t){if(!t.hasOwnProperty(s)){continue}var n=t[s];if(n["PARENT_ID"]===e){var a,o={text:n["TEXT"],href:n["URL"],onclick:n["ON_CLICK"],title:n["TITLE"]};a=this.getListItems(t,s);if(a.length){o.items=a}i.push(o);delete t[s]}}return i},getSubmenuArgs:function(){var t=this.getSubmenuId();var e=this.moreButton;var i=BX.pos(e);var s=this.getSubmenuItems();var n={autoHide:true,offsetLeft:i.width/2-80,angle:{position:"top",offset:100},zIndex:0,events:{onPopupClose:BX.delegate(this._onSubmenuClose,this)}};return[t,e,s,n]},getChildMenuArgs:function(t){var e=this.getChildMenuId();var i=this.getChildMenuItems(t);if(!i||BX.type.isArray(i)&&!i.length){return[]}var s={autoHide:true,angle:true,offsetLeft:t.getBoundingClientRect().width/2};return[e,t,i,s]},visibleControlMoreButton:function(){var t=this.getHiddenItems();if(!t.length||t.length===1&&this.isMoreButton(t[0])){this.getMoreButton().style.display="none"}else{this.getMoreButton().style.display=""}},createSubmenu:function(){var t=BX.PopupMenu.create.apply(BX.PopupMenu,this.getSubmenuArgs());if(this.isSettingsEnabled){this.dragAndDropInitInSubmenu()}t.menuItems.forEach(function(t){BX.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))},this);return t},createChildMenu:function(t){return BX.PopupMenu.create.apply(BX.PopupMenu,this.getChildMenuArgs(t))},showSubmenu:function(){var t=this.getSubmenu();if(t!==null){t.popupWindow.show()}else{this.destroySubmenu();t=this.createSubmenu();t.popupWindow.show()}this.setSubmenuShown(true);this.activateItem(this.moreButton);if(this.isEditEnabled()){t.popupWindow.setAutoHide(false)}},showChildMenu:function(t){var e=BX.PopupMenu.getMenuById(this.getChildMenuId()),i=null;if(e&&e.bindElement){if(e.bindElement.id!==t.id){this.destroyChildMenu(t);i=this.createChildMenu(t);i.popupWindow.show()}else{e.popupWindow.show()}}else{this.destroyChildMenu(t);i=this.createChildMenu(t);i.popupWindow.show()}},closeSubmenu:function(){var t=this.getSubmenu();if(t===null){return}t.popupWindow.close();if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}this.setSubmenuShown(false)},closeChildMenu:function(t){var e=this.getChildMenu(t);if(e===null){return}e.popupWindow.close()},getSubmenu:function(){return BX.PopupMenu.getMenuById(this.getSubmenuId())},getChildMenu:function(){return BX.PopupMenu.getMenuById(this.getChildMenuId())},destroySubmenu:function(){BX.PopupMenu.destroy(this.getSubmenuId())},destroyChildMenu:function(){BX.PopupMenu.destroy(this.getChildMenuId())},refreshSubmenu:function(){var t=this.getSubmenu();var e;if(t===null){return}e=this.getSubmenuArgs();if(BX.type.isArray(e)){this.destroySubmenu();this.createSubmenu();this.showSubmenu()}},setSubmenuShown:function(t){this.isSubmenuShown=false;if(BX.type.isBoolean(t)){this.isSubmenuShown=t}},activateItem:function(t){if(!BX.type.isDomNode(t)){return}if(!BX.hasClass(t,this.classItemActive)){BX.addClass(t,this.classItemActive)}},deactivateItem:function(t){if(!BX.type.isDomNode(t)){return}if(BX.hasClass(t,this.classItemActive)){BX.removeClass(t,this.classItemActive)}},getCurrentSettings:function(){var t={};this.getAllItems().forEach(function(e,i){t[e.id]={sort:i,isDisabled:this.isDisabled(e)}},this);return t},saveSettings:function(){var t=this.getCurrentSettings();var e="settings";var i;if(!BX.type.isPlainObject(t)){return}if(BX.type.isDomNode(this.listContainer)){if("id"in this.listContainer){i=this.listContainer.id;t=JSON.stringify(t);BX.userOptions.save("ui",i,e,t);this.setHome()}}},resetSettings:function(){var t=null;var e=BX.PopupWindowManager.create(this.listContainer.id+"_reset_popup",null,{content:this.message("MIB_RESET_ALERT"),autoHide:false,overlay:true,closeByEsc:true,closeIcon:true,draggable:{restrict:true},titleBar:this.message("MIB_RESET_SETTINGS"),buttons:[t=new BX.PopupWindowButton({text:this.message("MIB_RESET_BUTTON"),className:"popup-window-button-create",events:{click:function(){if(BX.hasClass(t.buttonNode,"popup-window-button-wait")){return}BX.addClass(t.buttonNode,"popup-window-button-wait");this.handleResetSettings(function(i){if(i){BX.removeClass(t.buttonNode,"popup-window-button-wait");e.setContent(i)}else{var s="settings";BX.userOptions.save("ui",this.listContainer.id,s,JSON.stringify({}));BX.userOptions.save("ui",this.listContainer.id,"firstPageLink","");window.location.reload()}}.bind(this))}.bind(this)}}),new BX.PopupWindowButtonLink({text:this.message("MIB_CANCEL_BUTTON"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});e.show()},handleResetSettings:function(t){var e=[];BX.onCustomEvent("BX.Main.InterfaceButtons:onBeforeResetMenu",[e,this]);var i=new BX.Promise;var s=i;for(var n=0;n<e.length;n++){i=i.then(e[n])}i.then(function(e){t(null,e)},function(e){t(e,null)});s.fulfill()},moveButtonAlias:function(t){var e,i;if(!t||!this.dragItem){return}e=this.getItemAlias(this.dragItem);i=this.getItemAlias(t);if(this.isListItem(e)){if(!i){this.listContainer.appendChild(e)}else{this.listContainer.insertBefore(e,i)}}},moveButton:function(t){var e;if(!BX.type.isDomNode(t)||!BX.type.isDomNode(this.dragItem)){return}if(this.isListItem(t)){if(this.isDisabled(this.dragItem)){this.dragItem.dataset.disabled="false"}if(BX.type.isDomNode(t)){this.listContainer.insertBefore(this.dragItem,t)}else{this.listContainer.appendChild(this.dragItem)}}if(this.isSubmenuItem(t)){if(this.isDisabled(this.dragItem)&&!this.isDisabled(t)){this.enableItem(this.dragItem)}e=this.getSubmenuContainer();e.insertBefore(this.dragItem,t)}},getSubmenuContainer:function(){var t=this.getSubmenu();var e=null;if(t!==null){e=t.itemsContainer}return e},findNextSiblingByClass:function(t,e){var i=t;for(;!!t;t=t.nextElementSibling){if(e){if(BX.hasClass(t,e)&&t!==i){return t}}else{return null}}},findParentByClassName:function(t,e){for(;t&&t!==document;t=t.parentNode){if(e){if(BX.hasClass(t,e)){return t}}else{return null}}},findChildrenByClassName:function(t,e){var i=null;if(BX.type.isDomNode(t)&&BX.type.isNotEmptyString(e)){i=BX.Buttons.Utils.getByClass(t,e)}return i},dragAndDropInit:function(){this.getAllItems().forEach(function(t,e){if(!this.isSeparator(t)&&!this.isSettings(t)&&!this.isApplySettingsButton(t)&&!this.isResetSettingsButton(t)){t.setAttribute("draggable","true");t.setAttribute("tabindex","-1");t.dataset.link="item"+e;BX.bind(t,"dragstart",BX.delegate(this._onDragStart,this));BX.bind(t,"dragend",BX.delegate(this._onDragEnd,this));BX.bind(t,"dragenter",BX.delegate(this._onDragEnter,this));BX.bind(t,"dragover",BX.delegate(this._onDragOver,this));BX.bind(t,"dragleave",BX.delegate(this._onDragLeave,this));BX.bind(t,"drop",BX.delegate(this._onDrop,this))}BX.bind(t,"mouseover",BX.delegate(this._onMouse,this));BX.bind(t,"mouseout",BX.delegate(this._onMouse,this))},this)},dragAndDropInitInSubmenu:function(){var t=this.getSubmenu();var e=t.menuItems;e.forEach(function(t){if(!this.isSeparator(t.layout.item)&&!this.isSettings(t.layout.item)&&!this.isApplySettingsButton(t.layout.item)&&!this.isResetSettingsButton(t.layout.item)){t.layout.item.draggable=true;t.layout.item.dataset.sortable=true;BX.bind(t.layout.item,"dragstart",BX.delegate(this._onDragStart,this));BX.bind(t.layout.item,"dragenter",BX.delegate(this._onDragEnter,this));BX.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this));BX.bind(t.layout.item,"dragleave",BX.delegate(this._onDragLeave,this));BX.bind(t.layout.item,"dragend",BX.delegate(this._onDragEnd,this));BX.bind(t.layout.item,"drop",BX.delegate(this._onDrop,this))}if(BX.hasClass(t.layout.item,this.classHiddenLabel)&&!BX.hasClass(t.layout.item,this.classManage)){BX.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this))}},this)},getItem:function(t){if(!BX.type.isDomNode(t)){if(!t||!BX.type.isDomNode(t.target)){return null}}else{t={target:t}}var e=this.findParentByClassName(t.target,this.classItem);if(!BX.type.isDomNode(e)){e=this.findParentByClassName(t.target,this.classDefaultSubmenuItem)}return e},setOpacity:function(t){if(!BX.type.isDomNode(t)){return}BX.style(t,"opacity",".1")},unsetOpacity:function(t){if(!BX.type.isDomNode(t)){return}BX.style(t,"opacity","1")},setDragStyles:function(){BX.addClass(this.listContainer,this.classOnDrag);BX.addClass(BX(this.getSubmenuId(true)),this.classOnDrag);this.setOpacity(this.dragItem)},unsetDragStyles:function(){var t=this.getSubmenu();this.getAllItems().forEach(function(t){this.unsetOpacity(t);BX.removeClass(t,"over")},this);if(t&&"menuItems"in t&&BX.type.isArray(t.menuItems)&&t.menuItems.length){t.menuItems.forEach(function(t){this.unsetOpacity(t);BX.removeClass(t.layout.item,"over")},this)}BX.removeClass(this.listContainer,this.classOnDrag);BX.removeClass(BX(this.getSubmenuId(true)),this.classOnDrag)},getIconClass:function(t){var e="";if(BX.type.isDomNode(t)&&"dataset"in t&&"class"in t.dataset&&BX.type.isNotEmptyString(t.dataset.class)){e=t.dataset.class}return e},disableItem:function(t){var e=this.getItemAlias(t);if(t&&"dataset"in t){t.dataset.disabled="true";if(e){e.dataset.disabled="true"}}},enableItem:function(t){var e;if(!BX.type.isDomNode(t)){return}if(this.isSubmenuItem(t)){BX.removeClass(t,this.classItemDisabled);e=this.getItemAlias(t);if(BX.type.isDomNode(e)){e.dataset.disabled="false"}}},getAliasLink:function(t){return this.dataValue(t,"link")||""},getItemAlias:function(t){var e=null;if(!BX.type.isDomNode(t)){return e}var i=this.getAllItems();var s=this.isSubmenuItem(t);var n=this.isListItem(t);if(!s&&!n){return e}if(s){i.forEach(function(i){BX.hasClass(t,this.getAliasLink(i))&&(e=i)},this)}if(n){e=BX.Buttons.Utils.getByClass(document,this.getAliasLink(t))}return e},hideItem:function(t){!!t&&BX.addClass(t,this.classSecret)},showItem:function(t){!!t&&BX.removeClass(t,this.classSecret)},fakeDragItem:function(){var t=null;if(!BX.type.isDomNode(this.dragItem)||!BX.type.isDomNode(this.overItem)){return}if(this.isDragToSubmenu()){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.listContainer.appendChild(this.dragItem);this.dragItem=t;this.showItem(this.dragItem);this.adjustMoreButtonPosition();this.updateSubmenuItems();this.tmp.moved=false;this.tmp.movetToSubmenu=true;this.setOpacity(this.dragItem)}}if(this.isDragToList()&&!this.tmp.movetToSubmenu){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.hideItem(this.dragItem);this.dragItem=t;this.adjustMoreButtonPosition();this.updateSubmenuItems();this.setOpacity(this.dragItem)}}this.tmp.movetToSubmenu=false},updateSubmenuItems:function(){var t=this.getHiddenItems();var e=this.getDisabledItems();var i=this;var s=[];var n,a,o;n=this.getSubmenu();if(n===null){return}a=n.menuItems;if(!BX.type.isArray(a)||!a.length){return}s=e.concat(t);a.forEach(function(t){o=[].some.call(s,function(e){return BX.hasClass(t.layout.item,i.dataValue(e,"link"))||i.isDisabled(t.layout.item)||i.isSeparator(t.layout.item)||i.isDropzone(t.layout.item)});if(o||(i.isSettings(t.layout.item)||i.isApplySettingsButton(t.layout.item)||i.isResetSettingsButton(t.layout.item)||i.isNotHiddenItem(t.layout.item)||i.isSeparator(t.layout.item)||t.layout.item===i.dragItem)&&!i.isMoreButton(t.layout.item)){i.showItem(t.layout.item)}else{i.hideItem(t.layout.item)}})},isNotHiddenItem:function(t){return BX.hasClass(t,this.classSubmenuNoHiddenItem)},getNotHidden:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSubmenuNoHiddenItem)},setOverStyles:function(t){if(BX.type.isDomNode(t)&&!BX.hasClass(t,this.classItemOver)){BX.addClass(t,this.classItemOver)}},unsetOverStyles:function(t){if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItemOver)){BX.removeClass(t,this.classItemOver)}},dataValue:function(t,e){var i="";var s;if(BX.type.isDomNode(t)){s=BX.data(t,e);if(typeof s!=="undefined"){i=s}}return i},execScript:function(script){if(BX.type.isNotEmptyString(script)){eval(script)}},showLicenseWindow:function(){var t;if(!B24.licenseInfoPopup){return}t=B24.licenseInfoPopup;t.init({B24_LICENSE_BUTTON_TEXT:this.message("MIB_LICENSE_BUY_BUTTON"),B24_TRIAL_BUTTON_TEXT:this.message("MIB_LICENSE_TRIAL_BUTTON"),IS_FULL_DEMO_EXISTS:this.licenseParams.isFullDemoExists,HOST_NAME:this.licenseParams.hostname,AJAX_URL:this.licenseParams.ajaxUrl,LICENSE_ALL_PATH:this.licenseParams.licenseAllPath,LICENSE_DEMO_PATH:this.licenseParams.licenseDemoPath,FEATURE_GROUP_NAME:this.licenseParams.featureGroupName,AJAX_ACTIONS_URL:this.licenseParams.ajaxActionsUrl,B24_FEATURE_TRIAL_SUCCESS_TEXT:this.message("MIB_LICENSE_WINDOW_TRIAL_SUCCESS_TEXT")});t.show("main-buttons",this.message("MIB_LICENSE_WINDOW_HEADER_TEXT"),this.message("MIB_LICENSE_WINDOW_TEXT"))},_onDragStart:function(t){var e=this.getVisibleItems();var i=BX.type.isArray(e)?e.length:null;this.dragItem=this.getItem(t);if(!BX.type.isDomNode(this.dragItem)){return}if(i===2&&this.isListItem(this.dragItem)){t.preventDefault();BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[this.dragItem,this]);return}if(this.isMoreButton(this.dragItem)||this.isSeparator(this.dragItem)||this.isNotHiddenItem(this.dragItem)){t.preventDefault();return}this.isSubmenuShownOnDragStart=!!this.isSubmenuShown;if(this.isListItem(this.dragItem)){this.showSubmenu()}this.setDragStyles();if(!this.isEditEnabled()){this.enableEdit()}},_onDragEnd:function(t){t.preventDefault();var e=this.getItem(t);var i,s;if(!BX.type.isDomNode(e)){return}this.unsetDragStyles();if(!this.isSubmenuShownOnDragStart){this.refreshSubmenu();if(!this.isEditEnabled()){this.closeSubmenu()}}else{this.refreshSubmenu()}i=BX.findNextSibling(this.dragItem,BX.delegate(function(t){return this.isVisibleItem(t)},this));s=BX.findPreviousSibling(this.dragItem,BX.delegate(function(t){return this.isVisibleItem(t)},this));if(BX.type.isDomNode(s)&&(BX.hasClass(s,this.classHiddenLabel)||this.isDisabled(s)&&this.isSubmenuItem(s))||(BX.type.isDomNode(i)&&BX.hasClass(i,this.classManage)||this.isDisabled(i)&&this.isSubmenuItem(i))){this.disableItem(this.dragItem);this.refreshSubmenu()}if(this.isEditEnabled()){this.enableEdit();BX.show(this.getSettingsApplyButton());BX.hide(this.getSettingsButton())}else{this.disableEdit();BX.hide(this.getSettingsApplyButton());BX.show(this.getSettingsButton())}this.updateMoreButtonCounter();this.saveSettings();this.dragItem=null;this.overItem=null;this.tmp.moved=false},updateMoreButtonCounter:function(){var t,e,i,s;t=this.getHiddenItems();s=this.getDisabledItems();t=t.concat(s);e=0;if(BX.type.isArray(t)){t.forEach(function(t){e+=parseInt(this.dataValue(t,"counter"))||0},this)}if(BX.type.isNumber(e)){this.setMoreButtonCounter(e)}},_onDragEnter:function(t){var e=this.getItem(t);if(BX.type.isDomNode(e)&&this.isNotHiddenItem(e)){this.setOverStyles(e)}},_onDragOver:function(t){t.preventDefault();var e=null;this.overItem=this.getItem(t);if(!BX.type.isDomNode(this.overItem)||!BX.type.isDomNode(this.dragItem)||this.overItem===this.dragItem||this.isNotHiddenItem(this.overItem)){return}this.fakeDragItem();if(this.isNext(t)&&this.isGoodPosition(t)&&!this.isMoreButton(this.overItem)){e=this.findNextSiblingByClass(this.overItem,this.classItem);if(this.isMoreButton(e)&&!this.tmp.moved){e=e.previousElementSibling;this.tmp.moved=true}if(!BX.type.isDomNode(e)){e=this.findNextSiblingByClass(this.overItem,this.classSubmenuItem)}if(BX.type.isDomNode(e)){this.moveButton(e);this.moveButtonAlias(e);this.adjustMoreButtonPosition();this.updateSubmenuItems()}}if(!this.isNext(t)&&this.isGoodPosition(t)&&!this.isMoreButton(this.overItem)||!this.isGoodPosition(t)&&this.isMoreButton(this.overItem)&&this.getVisibleItems().length===1){this.moveButton(this.overItem);this.moveButtonAlias(this.overItem);this.adjustMoreButtonPosition();this.updateSubmenuItems()}},_onDragLeave:function(t){var e=this.getItem(t);if(BX.type.isDomNode(e)){this.unsetOverStyles(t.target)}},_onDrop:function(t){var e=this.getItem(t);if(!BX.type.isDomNode(e)){return}if(this.isNotHiddenItem(e)||this.isDisabled(e)){this.disableItem(this.dragItem);this.adjustMoreButtonPosition()}this.unsetDragStyles();t.preventDefault()},getIndex:function(t,e){return[].indexOf.call(t||[],e)},_onSubmenuClose:function(){this.setSubmenuShown(false);if(this.isEditEnabled()){this.activateItem(this.moreButton)}else{if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}}},_onResizeHandler:function(){this.adjustMoreButtonPosition();this.updateSubmenuItems();if(!this.isSettingsEnabled){this.visibleControlMoreButton()}},_onClickMoreButton:function(t){t.preventDefault();this.showSubmenu()},_onMouse:function(t){var e=this.getItem(t);if(t.type==="mouseover"&&!BX.hasClass(e,this.classItemOver)){if(!BX.hasClass(e,this.classItemMore)){this.showChildMenu(e)}BX.addClass(e,this.classItemOver)}if(t.type==="mouseout"&&BX.hasClass(e,this.classItemOver)){BX.removeClass(e,this.classItemOver)}},getSettingsResetButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingsResetButton)},_onScroll:function(){if(BX.style(this.pinContainer,"position")==="fixed"){this.closeSubmenu()}},isDisabled:function(t){var e=false;if(BX.type.isDomNode(t)){e=this.dataValue(t,"disabled")==="true"||BX.hasClass(t,this.classItemDisabled)}return e},isSettings:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classSettingMenuItem)}return e},isLocked:function(t){var e=false;if(BX.type.isDomNode(t)){e=this.dataValue(t,"locked")==="true"||BX.hasClass(t,this.classItemLocked)}return e},isDropzone:function(t){return BX.hasClass(t,this.classDropzone)},isNext:function(t){var e=this.dragItem.getBoundingClientRect();var i=this.overItem.getBoundingClientRect();var s=getComputedStyle(this.dragItem);var n=parseInt(s.marginRight.replace("px",""));var a=null;if(this.isListItem(this.overItem)){a=t.clientX>i.left-n&&t.clientX>e.right}if(this.isSubmenuItem(this.overItem)){a=t.clientY>e.top}return a},isGoodPosition:function(t){var e=this.overItem;var i,s;if(!BX.type.isDomNode(e)){return false}i=e.getBoundingClientRect();if(this.isListItem(e)){s=this.isNext(t)&&t.clientX>=i.left+i.width/2||!this.isNext(t)&&t.clientX<=i.left+i.width/2}if(this.isSubmenuItem(e)){s=this.isNext(t)&&t.clientY>=i.top+i.height/2||!this.isNext(t)&&t.clientY<=i.top+i.height/2}return s},isSubmenuItem:function(t){return BX.hasClass(t,this.classSubmenuItem)},isVisibleItem:function(t){if(!BX.type.isDomNode(t)){return false}return t.offsetTop===0},isMoreButton:function(t){var e=false;if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItemMore)){e=true}return e},isListItem:function(t){var e=false;if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItem)){e=true}return e},isSublink:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classItemSublink)}return e},isSeparator:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classSeporator)}return e},isDragToSubmenu:function(){return!this.isSubmenuItem(this.dragItem)&&this.isSubmenuItem(this.overItem)},isDragToList:function(){return this.isSubmenuItem(this.dragItem)&&!this.isSubmenuItem(this.overItem)}}}if(typeof BX.Main.interfaceButtonsManager==="undefined"){BX.Main.interfaceButtonsManager={data:{},init:function(t){var e=null;if(!BX.type.isPlainObject(t)||!("containerId"in t)){throw"BX.Main.interfaceButtonsManager: containerId not set in params Object"}e=BX(t.containerId);if(BX.type.isDomNode(e)){this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)}else{BX(BX.delegate(function(){e=BX(t.containerId);if(!BX.type.isDomNode(e)){throw"BX.Main.interfaceButtonsManager: container is not dom node"}this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)},this))}},getById:function(t){var e=null;if(BX.type.isString(t)&&BX.type.isNotEmptyString(t)){try{e=this.data[t]}catch(t){}}return e},getObjects:function(){return this.data}}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:94:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js?1544127384575";s:6:"source";s:76:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js";s:3:"min";s:80:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js";s:3:"map";s:80:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Buttons");BX.Buttons.Utils={getByClass:function(e,t,l){var n=[];if(t){n=(e||document.body).getElementsByClassName(t);if(!l){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getByTag:function(e,t,l){var n=[];if(t){n=(e||document.body).getElementsByTagName(t);if(!l){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getBySelector:function(e,t,l){var n=[];if(t){if(!l){n=(e||document.body).querySelector(t)}else{n=(e||document.body).querySelectorAll(t);n=[].slice.call(n)}}return n}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:93:"/bitrix/components/bitrix/bizproc.automation/templates/.default/script.min.js?154412738799148";s:6:"source";s:73:"/bitrix/components/bitrix/bizproc.automation/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
if(!BX.getClass("BX.Bizproc.Automation.Component"))(function(t){"use strict";t.namespace("BX.Bizproc.Automation");var e=function(e){if(!t.type.isDomNode(e))throw"baseNode must be Dom Node Element";this.node=e;f.component=this};e.ViewMode={View:1,Edit:2};e.LogStatus={Waiting:0,Running:1,Completed:2,AutoCompleted:3};e.idIncrement=0;e.generateUniqueId=function(){++e.idIncrement;return"bizproc-automation-cmp-"+e.idIncrement};e.prototype={init:function(i,a){var o=this;this.viewMode=a||e.ViewMode.View;if(typeof i==="undefined")i={};this.data=i;this.initData();this.initTracker();this.initTriggerManager();this.initTemplateManager();this.initButtons();this.initButtonsPosition();this.initHelpTips();this.setTitle();this.fixTitleColors();window.onbeforeunload=function(){if(o.templateManager.needSave()||o.triggerManager.needSave()){return t.message("BIZPROC_AUTOMATION_CMP_NEED_SAVE")}}},initData:function(){this.documentType=this.data.DOCUMENT_TYPE;this.documentId=this.data.DOCUMENT_ID;this.documentCategoryId=this.data.DOCUMENT_CATEGORY_ID;this.documentSigned=this.data.DOCUMENT_SIGNED;this.bizprocEditorUrl=this.data.WORKFLOW_EDIT_URL;this.documentStatuses=this.data.DOCUMENT_STATUS_LIST;this.statusesSort=[];for(var e=0;e<this.documentStatuses.length;++e){this.statusesSort.push(this.documentStatuses[e]["STATUS_ID"])}this.setDocumentStatus(this.data.DOCUMENT_STATUS);this.userOptions={};if(t.type.isPlainObject(this.data.USER_OPTIONS)){this.userOptions=this.data.USER_OPTIONS}this.frameMode=t.type.isBoolean(this.data.FRAME_MODE)?this.data.FRAME_MODE:false},setDocumentStatus:function(t){this.documentStatus=t;this.currentStatusIndex=-1;for(var e=0;e<this.statusesSort.length;++e){if(this.statusesSort[e]==t){this.currentStatusIndex=e;break}}return this},isPreviousStatus:function(t){var e=0;for(var i=0;i<this.statusesSort.length;++i){if(t==this.statusesSort[i])e=i}return this.currentStatusIndex>-1&&e<this.currentStatusIndex},isCurrentStatus:function(t){return t==this.documentStatus},isNextStatus:function(t){var e=0;for(var i=0;i<this.statusesSort.length;++i){if(t==this.statusesSort[i])e=i}return this.currentStatusIndex>-1&&e>this.currentStatusIndex},initTriggerManager:function(){this.triggerManager=new s(this);this.triggerManager.init(this.data,this.viewMode)},reInitTriggerManager:function(e){if(t.type.isArray(e))this.data.TRIGGERS=e;this.triggerManager.reInit(this.data,this.viewMode)},initTemplateManager:function(){this.templateManager=new i(this);this.templateManager.init(this.data,this.viewMode)},reInitTemplateManager:function(e){if(t.type.isArray(e))this.data.TEMPLATES=e;this.templateManager.reInit(this.data,this.viewMode)},initButtons:function(){var i=this.node.querySelector('[data-role="automation-buttons"]');if(i){if(this.viewMode===e.ViewMode.View){t.hide(i)}}this.bindSaveButton();this.bindCancelButton();this.bindChangeViewButton()},initButtonsPosition:function(){var e=this.node.querySelector('[data-role="automation-buttons"]');if(e){if(this.frameMode){t.addClass(e,"bizproc-automation-buttons-fixed-slider")}}},initHelpTips:function(){t.UI.Hint.init(this.node)},reInitButtons:function(){var i=this.node.querySelector('[data-role="automation-buttons"]');if(i&&this.viewMode===e.ViewMode.View){t.hide(i)}else if(i&&this.viewMode===e.ViewMode.Edit){t.show(i)}var a=this.node.querySelector('[data-role="automation-btn-change-view"]');if(a){a.innerHTML=a.getAttribute("data-label-"+(this.viewMode===e.ViewMode.View?"edit":"view"))}},setTitle:function(){var t=this.node.querySelector('[data-role="automation-title"]');if(t){t.innerHTML=t.getAttribute("data-title-"+(this.viewMode===e.ViewMode.View?"view":"edit"))}},fixTitleColors:function(){var t,e,i=this.node.querySelectorAll('[data-role="automation-status-title"]');for(t=0;t<i.length;++t){e=i[t].getAttribute("data-bgcolor");if(e){var a=parseInt(e,16);var o=a>>16&255;var s=a>>8&255;var n=a&255;var r=.21*o+.72*s+.07*n;if(r<145){i[t].style.color="white"}}}},initTracker:function(){this.tracker=new r(this);this.tracker.init(this.data.LOG)},bindSaveButton:function(){var e=this,i=t("ui-button-panel-save");if(i){t.bind(i,"click",function(t){t.preventDefault();e.saveAutomation();i.classList.remove("ui-btn-wait")})}},bindCancelButton:function(){var i=this,a=this.node.querySelector('[data-role="automation-btn-cancel"]');if(a){t.bind(a,"click",function(t){t.preventDefault();i.changeViewMode(e.ViewMode.View,true)})}},bindChangeViewButton:function(){var i=this,a=this.node.querySelector('[data-role="automation-btn-change-view"]');if(a){a.innerHTML=a.getAttribute("data-label-"+(this.viewMode===e.ViewMode.View?"edit":"view"));if(i.canEdit()){t.bind(a,"click",function(t){t.preventDefault();var a=i.viewMode===e.ViewMode.Edit?e.ViewMode.View:e.ViewMode.Edit;i.changeViewMode(a)})}}},getAjaxUrl:function(){return t.util.add_url_param(this.data.AJAX_URL,{site_id:t.message("SITE_ID"),sessid:t.bitrix_sessid()})},saveAutomation:function(i){var a=this,o={ajax_action:"save_automation",document_signed:this.documentSigned,triggers:this.triggerManager.serialize(),templates:this.templateManager.serialize()};return t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:o,onsuccess:function(t){if(t.SUCCESS){a.reInitTemplateManager(t.DATA.templates);a.reInitTriggerManager(t.DATA.triggers);a.changeViewMode(e.ViewMode.View);if(i){i(t.DATA)}}else alert(t.ERRORS[0])}})},changeViewMode:function(i,a){if(!a&&(this.templateManager.needSave()||this.triggerManager.needSave())){alert(t.message("BIZPROC_AUTOMATION_CMP_NEED_SAVE"));return}if(i!==e.ViewMode.View&&i!==e.ViewMode.Edit)throw"Unknown view mode";this.viewMode=i;this.reInitTriggerManager();this.reInitTemplateManager();this.reInitButtons();this.setTitle()},canEdit:function(){return this.data["CAN_EDIT"]},updateTracker:function(){var i=this;t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:{ajax_action:"get_log",document_signed:this.documentSigned},onsuccess:function(t){if(t.DATA&&t.DATA.LOG){i.tracker.reInit(t.DATA.LOG);if(i.viewMode===e.ViewMode.View){i.templateManager.reInit()}}}})},onGlobalHelpClick:function(e){e.preventDefault();if(this.data["B24_TARIF_ZONE"]==="en"){window.open("https://helpdesk.bitrix24.com/open/4781101/")}else if(this.data["B24_TARIF_ZONE"]==="de"){window.open("https://helpdesk.bitrix24.de/open/4781105/")}else if(this.data["B24_TARIF_ZONE"]==="es"){window.open("https://helpdesk.bitrix24.es/open/5859003/")}else if(t.Helper&&t.Helper.frameOpenUrl.indexOf("//helpdesk.bitrix24.ru/")>0){t.Helper.show("redirect=detail&HD_ID=5265469")}else{window.open("https://helpdesk.bitrix24.ru/open/5265469/")}},getUserOption:function(t,e,i){var a=i;if(this.userOptions[t]&&this.userOptions[t][e]){a=this.userOptions[t][e]}return a},setUserOption:function(e,i,a){if(!t.type.isPlainObject(this.userOptions[e])){this.userOptions[e]={}}var o=this.userOptions[e][i];if(o!==a){this.userOptions[e][i]=a;t.userOptions.save("bizproc.automation",e,i,a,false)}return this}};var i=function(t){this.component=t};i.prototype={init:function(i,a){if(!t.type.isPlainObject(i))i={};this.viewMode=a||e.ViewMode.View;this.availableRobots=t.type.isArray(i.AVAILABLE_ROBOTS)?i.AVAILABLE_ROBOTS:[];this.availableRobotsMap={};for(var o=0;o<this.availableRobots.length;++o){this.availableRobotsMap[this.availableRobots[o]["CLASS"]]=this.availableRobots[o]}this.templatesData=t.type.isArray(i.TEMPLATES)?i.TEMPLATES:[];this.initTemplates()},reInit:function(i,a){if(!t.type.isPlainObject(i))i={};this.viewMode=a||e.ViewMode.View;if(t.type.isArray(i.TEMPLATES))this.templatesData=i.TEMPLATES;this.reInitTemplates(this.templatesData)},initTemplates:function(){this.templates=[];this.templatesMap={};for(var t=0;t<this.templatesData.length;++t){var e=new a(this);e.init(this.templatesData[t],this.viewMode);this.templates.push(e);this.templatesMap[e.getStatusId()]=e}},reInitTemplates:function(t){for(var e=0;e<this.templates.length;++e){if(t[e]){this.templates[e].reInit(t[e],this.viewMode)}}},getAvailableRobots:function(){return this.availableRobots},getRobotDescription:function(t){return this.availableRobotsMap[t]||null},serialize:function(){var t=[];for(var e=0;e<this.templates.length;++e){t.push(this.templates[e].serialize())}return t},getTemplateByColumnNode:function(t){var e=t.getAttribute("data-status-id");return this.getTemplateByStatusId(e)},getTemplateByStatusId:function(t){return this.templatesMap[t]||null},needSave:function(){var t=false;for(var e=0;e<this.templates.length;++e){if(this.templates[e].isModified()){t=true;break}}return t}};var a=function(t){this.manager=t;this.component=t.component;this.data={}};a.prototype={init:function(i,a){if(t.type.isPlainObject(i))this.data=i;this.viewMode=a||e.ViewMode.View;this.node=this.component.node.querySelector('[data-role="automation-template"][data-status-id="'+this.getStatusId()+'"]');this.listNode=this.node.querySelector('[data-role="robot-list"]');this.buttonsNode=this.node.querySelector('[data-role="buttons"]');this.initRobots();this.initButtons();this.modified=false;if(!this.isExternalModified()){jsDD.registerDest(this.node,10)}},reInit:function(e,i){t.cleanNode(this.listNode);t.cleanNode(this.buttonsNode);this.init(e,i)},initRobots:function(){this.robots=[];this.robotsMap={};if(t.type.isArray(this.data.ROBOTS)){for(var e=0;e<this.data.ROBOTS.length;++e){var i=new o(this);i.init(this.data.ROBOTS[e],this.viewMode);this.insertRobotNode(i.node);this.robots.push(i);this.robotsMap[i.getId()]=i}}},getStatusId:function(){return this.data.DOCUMENT_STATUS},getTemplateId:function(){var t=parseInt(this.data.ID);return!isNaN(t)?t:0},initButtons:function(){if(this.isExternalModified()){this.createExternalLocker()}else if(this.viewMode===e.ViewMode.Edit){if(!this.isExternalModified())this.createAddButton();if(this.getTemplateId()>0)this.createExternalEditTemplateButton()}if(this.viewMode===e.ViewMode.View&&this.component.canEdit()){this.createEditButton()}},createAddButton:function(){var e=this,i=t.create("a",{text:t.message("BIZPROC_AUTOMATION_CMP_ADD"),props:{href:"#"},events:{click:function(t){t.preventDefault();e.onAddButtonClick(this)}},attrs:{className:"bizproc-automation-robot-btn-add"}});this.buttonsNode.appendChild(i)},createEditButton:function(){var i=this,a=t.create("a",{text:t.message("BIZPROC_AUTOMATION_CMP_AUTOMATION_EDIT"),props:{href:"#"},events:{click:function(t){t.preventDefault();i.manager.component.changeViewMode(e.ViewMode.Edit)}},attrs:{className:"bizproc-automation-robot-btn-set"}});this.buttonsNode.appendChild(a)},createExternalEditTemplateButton:function(){if(this.manager.component.bizprocEditorUrl===null){return false}var e=this,i=t.create("a",{text:t.message("BIZPROC_AUTOMATION_CMP_EXTERNAL_EDIT"),props:{href:"#"},events:{click:function(t){t.preventDefault();e.onExternalEditTemplateButtonClick(this)}},attrs:{className:"bizproc-automation-robot-btn-set"}});if(!this.manager.component.bizprocEditorUrl.length){t.addClass(i,"bizproc-automation-robot-btn-set-locked")}this.buttonsNode.appendChild(i)},createExternalLocker:function(){var i=this,a=t.create("div",{attrs:{className:"bizproc-automation-robot-container"},children:[t.create("div",{attrs:{className:"bizproc-automation-robot-container-wrapper bizproc-automation-robot-container-wrapper-lock"},children:[t.create("div",{attrs:{className:"bizproc-automation-robot-deadline"}}),t.create("div",{attrs:{className:"bizproc-automation-robot-title"},text:t.message("BIZPROC_AUTOMATION_CMP_EXTERNAL_EDIT_TEXT")})]})]});if(this.viewMode===e.ViewMode.Edit){var o=t.create("div",{attrs:{className:"bizproc-automation-robot-btn-settings"},text:t.message("BIZPROC_AUTOMATION_CMP_EDIT")});t.bind(a,"click",function(t){i.onExternalEditTemplateButtonClick(this)});a.appendChild(o);t.addClass(a.firstChild,"bizproc-automation-robot-container-wrapper-border");var s=t.create("SPAN",{attrs:{className:"bizproc-automation-robot-btn-delete"}});t.bind(s,"click",function(t){t.stopPropagation();i.onUnsetExternalModifiedClick(this)});a.lastChild.appendChild(s)}this.listNode.appendChild(a)},onAddButtonClick:function(i){var a=this,o,s,n={employee:[],client:[],ads:[],other:[]};var r,l,p,d=this.manager.getAvailableRobots();var c=function(e,i){var o=t.clone(i.robotData);if(o["ROBOT_SETTINGS"]&&o["ROBOT_SETTINGS"]["TITLE_CATEGORY"]&&o["ROBOT_SETTINGS"]["TITLE_CATEGORY"][i.category]){o["NAME"]=o["ROBOT_SETTINGS"]["TITLE_CATEGORY"][i.category]}else if(o["ROBOT_SETTINGS"]&&o["ROBOT_SETTINGS"]["TITLE"]){o["NAME"]=o["ROBOT_SETTINGS"]["TITLE"]}a.addRobot(o,function(t){a.openRobotSettingsDialog(t,{ADD_MENU_CATEGORY:i.category})});this.getRootMenuWindow().close()};for(o=0;o<d.length;++o){if(d[o]["EXCLUDED"]){continue}l=t.type.isPlainObject(d[o]["ROBOT_SETTINGS"])?d[o]["ROBOT_SETTINGS"]:{};r=d[o].NAME;if(l["TITLE"])r=l["TITLE"];p=[];if(l["CATEGORY"]){p=t.type.isArray(l["CATEGORY"])?l["CATEGORY"]:[l["CATEGORY"]]}if(!p.length){p.push("other")}for(s=0;s<p.length;++s){if(!n[p[s]])continue;n[p[s]].push({text:r,robotData:d[o],category:p[s],onclick:c})}}if(n["other"].length>0){n["other"].push({delimiter:true})}if(t.getClass("BX.rest.Marketplace")){n["other"].push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER_MARKETPLACE"),onclick:function(){t.rest.Marketplace.open({},a.component.data["MARKETPLACE_ROBOT_CATEGORY"]);this.getRootMenuWindow().close()}})}else{n["other"].push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER_MARKETPLACE"),href:"/marketplace/category/%category%/".replace("%category%",this.component.data["MARKETPLACE_ROBOT_CATEGORY"]),target:"_blank"})}var u=i.getAttribute("data-menu-id");if(!u){u=e.generateUniqueId();i.setAttribute("data-menu-id",u)}var h=[];if(n["employee"].length>0){h.push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_EMPLOYEE"),items:n["employee"]})}if(n["client"].length>0){h.push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_CLIENT"),items:n["client"]})}if(n["ads"].length>0){h.push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_ADS"),items:n["ads"]})}h.push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER"),items:n["other"]});t.PopupMenu.show(u,i,h,{autoHide:true,offsetLeft:t.pos(i)["width"]/2,angle:{position:"top",offset:0}})},onExternalEditTemplateButtonClick:function(e){if(!this.manager.component.bizprocEditorUrl.length){if(t.getClass("B24.licenseInfoPopup")){B24.licenseInfoPopup.show("bizproc_automation_designer",t.message("BIZPROC_AUTOMATION_CMP_EXTERNAL_EDIT"),t.message("BIZPROC_AUTOMATION_CMP_EXTERNAL_EDIT_LOCKED"))}return}var i=this.getTemplateId();if(i>0)this.openBizprocEditor(i)},onUnsetExternalModifiedClick:function(t){this.data["IS_EXTERNAL_MODIFIED"]=false;this.reInit(null,this.viewMode)},openBizprocEditor:function(t){var e=this.manager.component.bizprocEditorUrl.replace("#ID#",t);top.window.location.href=e},addRobot:function(t,e){var i=new o(this);var a={Type:t["CLASS"],Properties:{Title:t["NAME"]}};if(this.robots.length>0){var s=this.robots[this.robots.length-1];if(!s.delay.isNow()||s.isExecuteAfterPrevious()){a["Delay"]=s.delay.serialize();a["ExecuteAfterPrevious"]=1}}i.init(a,this.viewMode);i.draft=true;if(e)e(i)},insertRobot:function(t,e){if(e){for(var i=0;i<this.robots.length;++i){if(this.robots[i]!==e)continue;this.robots.splice(i,0,t);break}}else{this.robots.push(t)}this.modified=true},deleteRobot:function(t,e){for(var i=0;i<this.robots.length;++i){if(this.robots[i]===t){this.robots.splice(i,1);break}}if(e)e(t);this.modified=true},insertRobotNode:function(t,e){if(e){this.listNode.insertBefore(t,e)}else{this.listNode.appendChild(t)}},openRobotSettingsDialog:function(e,i){if(f.getRobotSettingsDialog())return;var a=this,o="bizproc_automation_robot_dialog";var s=t.create("form",{props:{name:o}});s.appendChild(a.renderDelaySettings(e));s.appendChild(a.renderConditionSettings(e));var n=t.create("div",{attrs:{className:"bizproc-automation-robot-help"},events:{click:t.delegate(this.component.onGlobalHelpClick,this.component)}});s.appendChild(n);if(!t.type.isPlainObject(i))i={};i["DOCUMENT_CATEGORY_ID"]=this.manager.component.documentCategoryId;f.setRobotSettingsDialog({template:this,context:i,robot:e,form:s});t.ajax({method:"POST",dataType:"html",url:this.manager.component.getAjaxUrl(),data:{ajax_action:"get_robot_dialog",document_signed:this.component.documentSigned,document_status:this.component.documentStatus,context:i,robot:e.serialize(),form_name:o},onsuccess:function(i){if(i){var o=t.create("div",{html:i});s.appendChild(o)}a.showRobotSettingsPopup(e,s)}})},showRobotSettingsPopup:function(i,a){t.addClass(this.component.node,"automation-base-blocked");this.initRobotSettingsControls(i,a);var o=parseInt(this.component.getUserOption("defaults","robot_settings_popup_width",580));var s=580;if(i.data.Type==="CrmSendEmailActivity"||i.data.Type==="MailActivity"){s+=124;if(o<s){o=s}}var n=this,r=new t.PopupWindow(e.generateUniqueId(),null,{titleBar:i.getProperty("Title")||i.getDescriptionTitle(),content:a,closeIcon:true,width:o,resizable:{minWidth:s,minHeight:100},offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:false,events:{onPopupClose:function(e){n.currentRobot=null;f.setRobotSettingsDialog(null);n.destroyRobotSettingsControls();e.destroy();t.removeClass(n.component.node,"automation-base-blocked")},onPopupResize:function(){n.onResizeRobotSettings()},onPopupResizeEnd:function(){n.component.setUserOption("defaults","robot_settings_popup_width",this.getWidth())}},buttons:[new t.PopupWindowButton({text:t.message("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function(){n.saveRobotSettings(a,i,t.delegate(function(){this.popupWindow.close()},this))}}}),new t.PopupWindowButtonLink({text:t.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});n.currentRobot=i;f.getRobotSettingsDialog().popup=r;r.show()},initRobotSettingsControls:function(e,i){if(!t.type.isArray(this.robotSettingsControls))this.robotSettingsControls=[];var a,o=i.querySelectorAll('[data-role="user-selector"]');for(a=0;a<o.length;++a){this.robotSettingsControls.push(new l(this.manager.component,o[a]))}var s=i.querySelectorAll('[data-role="file-selector"]');for(a=0;a<s.length;++a){this.robotSettingsControls.push(new p(this.manager.component,s[a]))}var n=i.querySelectorAll('[data-role="inline-selector-target"]');for(a=0;a<n.length;++a){this.robotSettingsControls.push(new d(this.manager.component,n[a]))}var r=i.querySelectorAll('[data-role="inline-selector-html"]');for(a=0;a<r.length;++a){this.robotSettingsControls.push(new c(this.manager.component,r[a]))}var m=i.querySelectorAll('[data-role="time-selector"]');for(a=0;a<m.length;++a){this.robotSettingsControls.push(new u(m[a]))}var f=i.querySelectorAll('[data-role="save-state-checkbox"]');for(a=0;a<f.length;++a){this.robotSettingsControls.push(new h(f[a],e))}t.UI.Hint.init(i)},destroyRobotSettingsControls:function(){if(t.type.isArray(this.robotSettingsControls)){for(var e=0;e<this.robotSettingsControls.length;++e){if(t.type.isFunction(this.robotSettingsControls[e].destroy))this.robotSettingsControls[e].destroy()}}this.robotSettingsControls=null},onBeforeSaveRobotSettings:function(){if(t.type.isArray(this.robotSettingsControls)){for(var e=0;e<this.robotSettingsControls.length;++e){if(t.type.isFunction(this.robotSettingsControls[e].onBeforeSave))this.robotSettingsControls[e].onBeforeSave()}}},onResizeRobotSettings:function(){if(t.type.isArray(this.robotSettingsControls)){for(var e=0;e<this.robotSettingsControls.length;++e){if(t.type.isFunction(this.robotSettingsControls[e].onPopupResize))this.robotSettingsControls[e].onPopupResize()}}},renderDelaySettings:function(i){var a=t.clone(i.getDelayInterval());var o=i.isExecuteAfterPrevious();var s=e.generateUniqueId();var n=t.create("input",{attrs:{type:"checkbox",id:"param-group-3-1"+s,name:"execute_after_previous",value:"1",style:"vertical-align: middle"}});var r=t.create("input",{attrs:{type:"hidden",name:"delay_type",value:a.type}});var l=t.create("input",{attrs:{type:"hidden",name:"delay_value",value:a.value}});var p=t.create("input",{attrs:{type:"hidden",name:"delay_value_type",value:a.valueType}});var d=t.create("input",{attrs:{type:"hidden",name:"delay_basis",value:a.basis}});var c=t.create("input",{attrs:{type:"hidden",name:"delay_worktime",value:a.workTime?1:0}});var u=t.create("input",{attrs:{type:"hidden",name:"delay_localtime",value:a.localTime?1:0}});if(o){n.setAttribute("checked","checked")}var h=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"}});var f=[];if(t.type.isArray(this.component.data["DOCUMENT_FIELDS"])){var g,T;for(g=0;g<this.component.data["DOCUMENT_FIELDS"].length;++g){T=this.component.data["DOCUMENT_FIELDS"][g];if(T["Type"]=="date"||T["Type"]=="datetime"||T["Type"]=="UF:date")f.push(T)}}var b=new m({labelNode:h,onchange:function(t){r.value=t.type;l.value=t.value;p.value=t.valueType;d.value=t.basis;c.value=t.workTime?1:0;u.value=t.localTime?1:0},basisFields:f});var v=t.create("div",{attrs:{className:"bizproc-automation-popup-settings bizproc-automation-popup-settings-flex"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block bizproc-automation-popup-settings-block-flex"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title-wrapper"},children:[r,l,p,d,c,u,t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-left"},text:t.message("BIZPROC_AUTOMATION_CMP_TO_EXECUTE")+":"}),h]})]}),t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:[n,t.create("label",{attrs:{for:"param-group-3-1"+s,style:"color: #535C69"},text:t.message("BIZPROC_AUTOMATION_CMP_AFTER_PREVIOUS_WIDE")})]})]});b.init(a);return v},setDelaySettingsFromForm:function(t,e){var i=new g;i.setType(t["delay_type"]);i.setValue(t["delay_value"]);i.setValueType(t["delay_value_type"]);i.setBasis(t["delay_basis"]);i.setWorkTime(t["delay_worktime"]==="1");i.setLocalTime(t["delay_localtime"]==="1");var a=t["execute_after_previous"]&&t["execute_after_previous"]==="1";e.setDelayInterval(i);e.setExecuteAfterPrevious(a);return this},renderConditionSettings:function(e){var i=t.clone(e.getCondition());var a=new v(i,{fields:this.component.data["DOCUMENT_FIELDS"]});return t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION")+":"}),a.createNode()]})]})},setConditionSettingsFromForm:function(e,i){var a,o=new b;if(t.type.isArray(e["condition_field"])){for(a=0;a<e["condition_field"].length;++a){if(e["condition_field"][a]===""){continue}var s=new T;s.setField(e["condition_field"][a]);s.setOperator(e["condition_operator"][a]);s.setValue(e["condition_value"][a]);var n=b.Joiner.And;if(e["condition_joiner"]&&e["condition_joiner"][a]===b.Joiner.Or){n=b.Joiner.Or}o.addItem(s,n)}}i.setCondition(o);return this},saveRobotSettings:function(e,i,a){this.onBeforeSaveRobotSettings();var o=this,s=t.ajax.prepareForm(e);t.ajax({method:"POST",dataType:"json",url:this.manager.component.getAjaxUrl(),data:{ajax_action:"save_robot_settings",document_signed:this.component.documentSigned,robot:i.serialize(),form_data:s["data"]},onsuccess:function(t){if(t.SUCCESS){i.updateData(t.DATA.robot);o.setDelaySettingsFromForm(s["data"],i);o.setConditionSettingsFromForm(s["data"],i);if(i.draft){o.robots.push(i);o.insertRobotNode(i.node)}delete i.draft;i.reInit();o.modified=true;if(a){a(t.DATA)}}else alert(t.ERRORS[0])}})},serialize:function(){var t=this.data;t["IS_EXTERNAL_MODIFIED"]=this.isExternalModified()?1:0;t["ROBOTS"]=[];for(var e=0;e<this.robots.length;++e){t["ROBOTS"].push(this.robots[e].serialize())}return t},isExternalModified:function(){return this.data["IS_EXTERNAL_MODIFIED"]===true},getRobotById:function(t){return this.robotsMap[t]||null},isModified:function(){return this.modified}};var o=function(t){this.template=t;this.templateManager=t.manager;this.component=this.templateManager.component;this.tracker=t.manager.component.tracker};o.generateName=function(){return"A"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)};o.prototype={init:function(t,i){if(t)this.data=t;if(!this.data.Name){this.data.Name=o.generateName()}this.delay=new g(this.data.Delay);this.condition=new b(this.data.Condition);this.viewMode=i||e.ViewMode.View;this.node=this.createNode()},reInit:function(t,e){var i=this.node;this.node=this.createNode();if(i.parentNode)i.parentNode.replaceChild(this.node,i)},getProperty:function(t){return this.data.Properties[t]||null},setProperty:function(t,e){this.data.Properties[t]=e;return this},getId:function(){return this.data.Name||null},getLogStatus:function(){var t=e.LogStatus.Waiting;var i=this.tracker.getRobotLog(this.getId());if(i){t=parseInt(i["STATUS"])}else if(this.data.DelayName){i=this.tracker.getRobotLog(this.data.DelayName);if(i&&parseInt(i["STATUS"])>e.LogStatus.Waiting)t=e.LogStatus.Running}return t},getLogErrors:function(){var t=[],e=this.tracker.getRobotLog(this.getId());if(e&&e.ERRORS){t=e.ERRORS}return t},createNode:function(){var i=this,a=this.getLogStatus(),o;var s=this.getDescriptionSettings();var n="bizproc-automation-robot-container-wrapper";if(this.viewMode===e.ViewMode.Edit){n+=" bizproc-automation-robot-container-wrapper-draggable"}var r=t.message("BIZPROC_AUTOMATION_CMP_TO");var l=t.create("a",{attrs:{className:"bizproc-automation-robot-settings-name",title:t.message("BIZPROC_AUTOMATION_CMP_AUTOMATICALLY")},text:t.message("BIZPROC_AUTOMATION_CMP_AUTOMATICALLY")});if(t.type.isPlainObject(this.data.viewData)&&this.data.viewData.responsibleLabel){var p=this.data.viewData.responsibleLabel.replace("{=Document:ASSIGNED_BY_ID}",t.message("BIZPROC_AUTOMATION_CMP_RESPONSIBLE")).replace("author",t.message("BIZPROC_AUTOMATION_CMP_RESPONSIBLE"));if(p.indexOf("{=Document")>=0&&t.type.isArray(this.component.data["DOCUMENT_FIELDS"])){var d,c;for(d=0;d<this.component.data["DOCUMENT_FIELDS"].length;++d){c=this.component.data["DOCUMENT_FIELDS"][d];p=p.replace(c["SystemExpression"],c["Name"])}}l.textContent=p;l.setAttribute("title",p);if(this.data.viewData.responsibleUrl){l.href=this.data.viewData.responsibleUrl;if(this.component.frameMode){l.setAttribute("target","_blank")}}if(parseInt(this.data.viewData.responsibleId)>0){l.setAttribute("bx-tooltip-user-id",this.data.viewData.responsibleId)}}var u=I(this.getDelayInterval(),t.message("BIZPROC_AUTOMATION_CMP_AT_ONCE"),this.component.data["DOCUMENT_FIELDS"]);if(this.isExecuteAfterPrevious()){u=u!==t.message("BIZPROC_AUTOMATION_CMP_AT_ONCE")?u+", ":"";u+=t.message("BIZPROC_AUTOMATION_CMP_AFTER_PREVIOUS")}if(this.getCondition().items.length>0){u+=", "+t.message("BIZPROC_AUTOMATION_CMP_BY_CONDITION")}var h;if(this.viewMode===e.ViewMode.Edit){h=t.create("a",{attrs:{className:"bizproc-automation-robot-link",title:u},text:u})}else{h=t.create("span",{attrs:{className:"bizproc-automation-robot-text"},text:u})}if(this.viewMode===e.ViewMode.View){switch(a){case e.LogStatus.Running:if(this.component.isCurrentStatus(this.template.getStatusId())){o=t.create("div",{attrs:{className:"bizproc-automation-robot-loader"}})}break;case e.LogStatus.Completed:case e.LogStatus.AutoCompleted:n+=" bizproc-automation-robot-container-wrapper-complete";break}var m=this.getLogErrors();if(m.length>0){o=t.create("div",{attrs:{className:"bizproc-automation-robot-errors","data-text":m.join("\n")}});C.bindToNode(o)}}var f="bizproc-automation-robot-title-text";if(this.viewMode===e.ViewMode.Edit){f+=" bizproc-automation-robot-title-text-editable"}var g=this.getProperty("Title")||this.getDescriptionTitle();var T=t.create("div",{attrs:{className:"bizproc-automation-robot-container","data-role":"robot-container","data-type":"item-robot","data-id":this.getId()},children:[t.create("div",{attrs:{className:n},children:[t.create("div",{attrs:{className:"bizproc-automation-robot-deadline"},children:[h]}),t.create("div",{attrs:{className:"bizproc-automation-robot-title"},children:[t.create("div",{attrs:{className:f},html:this.clipTitle(g),events:{click:this.viewMode===e.ViewMode.Edit?this.onTitleEditClick.bind(this):null}})]}),t.create("div",{attrs:{className:"bizproc-automation-robot-settings"},children:[t.create("div",{attrs:{className:"bizproc-automation-robot-settings-title"},text:r+":"}),l]}),o]})]});if(this.viewMode===e.ViewMode.Edit){this.registerItem(T);var b=t.create("SPAN",{attrs:{className:"bizproc-automation-robot-btn-delete"}});t.bind(b,"click",function(t){t.preventDefault();t.stopPropagation();i.onDeleteButtonClick(this)});T.lastChild.appendChild(b);var v=t.create("div",{attrs:{className:"bizproc-automation-robot-btn-settings"},text:t.message("BIZPROC_AUTOMATION_CMP_EDIT")});t.bind(T,"click",function(t){i.onSettingsButtonClick(this)});T.appendChild(v);t.addClass(T.firstChild,"bizproc-automation-robot-container-wrapper-border")}return T},onDeleteButtonClick:function(e){t.remove(this.node);this.template.deleteRobot(this)},onSettingsButtonClick:function(t){this.template.openRobotSettingsDialog(this)},onTitleEditClick:function(i){i.preventDefault();i.stopPropagation();var a=this,o="bizproc_automation_robot_title_dialog";var s=t.create("form",{props:{name:o},style:{"min-width":"540px"}});var n=this.getProperty("Title")||this.getDescriptionTitle();s.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:t.message("BIZPROC_AUTOMATION_CMP_ROBOT_NAME")+":"}));s.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("input",{attrs:{className:"bizproc-automation-popup-input",type:"text",name:"name",value:n}})]}));t.addClass(this.component.node,"automation-base-blocked");var r=new t.PopupWindow(e.generateUniqueId(),null,{titleBar:t.message("BIZPROC_AUTOMATION_CMP_ROBOT_NAME"),content:s,closeIcon:true,zIndex:-100,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:false,events:{onPopupClose:function(e){e.destroy();t.removeClass(a.component.node,"automation-base-blocked")}},buttons:[new t.PopupWindowButton({text:t.message("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function(){var t=s.elements.name;a.setProperty("Title",t.value);a.reInit();a.template.modified=true;this.popupWindow.close()}}}),new t.PopupWindowButtonLink({text:t.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});r.show()},clipTitle:function(t){var e=t;var i=e.split(" ");var a="<span>"+i[i.length-1]+"</span>";i.splice(i.length-1);e=i.join(" ")+" "+a;return e},updateData:function(e){if(t.type.isPlainObject(e)){this.data=e}else throw"Invalid data"},serialize:function(){var e=t.clone(this.data);var i=function(e){for(var a in e){if(e.hasOwnProperty(a)){if(typeof e[a]==="boolean"){e[a]=e[a]?1:0}else if(e[a]===null){e[a]=""}else if(t.type.isPlainObject(e[a])){i(e[a])}}}};if(t.type.isPlainObject(e.Properties)){i(e.Properties)}e.Delay=this.delay.serialize();e.Condition=this.condition.serialize();return e},getDelayInterval:function(){return this.delay},setDelayInterval:function(t){this.delay=t;return this},getCondition:function(){return this.condition},setCondition:function(t){this.condition=t;return this},setExecuteAfterPrevious:function(t){this.data.ExecuteAfterPrevious=t?1:0;return this},isExecuteAfterPrevious:function(){return this.data.ExecuteAfterPrevious===1},registerItem:function(e){e.onbxdragstart=t.proxy(this.dragStart,this);e.onbxdrag=t.proxy(this.dragMove,this);e.onbxdragstop=t.proxy(this.dragStop,this);e.onbxdraghover=t.proxy(this.dragOver,this);jsDD.registerObject(e);jsDD.registerDest(e,1)},dragStart:function(){this.draggableItem=t.proxy_context;this.draggableItem.className="bizproc-automation-robot-container";if(!this.draggableItem){jsDD.stopCurrentDrag();return}if(!this.stub){var e=this.draggableItem.offsetWidth;this.stub=this.draggableItem.cloneNode(true);this.stub.style.position="absolute";this.stub.className="bizproc-automation-robot-container bizproc-automation-robot-container-drag";this.stub.style.width=e+"px";document.body.appendChild(this.stub)}},dragMove:function(t,e){this.stub.style.left=t+"px";this.stub.style.top=e+"px"},dragOver:function(t,e,i){if(this.droppableItem){this.droppableItem.className="bizproc-automation-robot-container"}if(this.droppableColumn){this.droppableColumn.className="bizproc-automation-robot-list"}var a=t.getAttribute("data-type");if(a==="item-robot"){this.droppableItem=t;this.droppableColumn=null}if(a==="column-robot"){this.droppableColumn=t.children[0];this.droppableItem=null}if(this.droppableItem){this.droppableItem.className="bizproc-automation-robot-container bizproc-automation-robot-container-pre"}if(this.droppableColumn){this.droppableColumn.className="bizproc-automation-robot-list bizproc-automation-robot-list-pre"}},dragStop:function(t,e,i){i=i||window.event;var a=i&&i.ctrlKey;var o,s;if(this.draggableItem){if(this.droppableItem){this.droppableItem.className="bizproc-automation-robot-container";o=this.templateManager.getTemplateByColumnNode(this.droppableItem.parentNode);if(o){s=o.getRobotById(this.droppableItem.getAttribute("data-id"));if(a){this.copyTo(o,s)}else if(this!==s)this.moveTo(o,s)}}else if(this.droppableColumn){this.droppableColumn.className="bizproc-automation-robot-list";o=this.templateManager.getTemplateByColumnNode(this.droppableColumn);if(o){a?this.copyTo(o):this.moveTo(o)}}}this.stub.parentNode.removeChild(this.stub);this.stub=null;this.draggableItem=null;this.droppableItem=null},moveTo:function(e,i){t.remove(this.node);this.template.deleteRobot(this);this.template=e;this.template.insertRobot(this,i);this.node=this.createNode();this.template.insertRobotNode(this.node,i?i.node:null)},copyTo:function(t,e){var i=new o(t);var a=this.serialize();delete a["Name"];delete a["DelayName"];i.init(a,this.viewMode);t.insertRobot(i,e);t.insertRobotNode(i.node,e?e.node:null)},getDescriptionSettings:function(){var t={};var e=this.templateManager.getRobotDescription(this.data["Type"]);if(e&&e["ROBOT_SETTINGS"]){t=e["ROBOT_SETTINGS"]}return t},getDescriptionTitle:function(){var t="untitled";var e=this.templateManager.getRobotDescription(this.data["Type"]);if(e["NAME"]){t=e["NAME"]}if(e["ROBOT_SETTINGS"]&&e["ROBOT_SETTINGS"]["TITLE"]){t=e["ROBOT_SETTINGS"]["TITLE"]}return t}};var s=function(t){this.component=t};s.prototype={init:function(i,a){if(!t.type.isPlainObject(i))i={};this.viewMode=a||e.ViewMode.View;this.availableTriggers=t.type.isArray(i.AVAILABLE_TRIGGERS)?i.AVAILABLE_TRIGGERS:[];this.triggersData=t.type.isArray(i.TRIGGERS)?i.TRIGGERS:[];this.columnNodes=document.querySelectorAll('[data-type="column-trigger"]');this.listNodes=this.component.node.querySelectorAll('[data-role="trigger-list"]');this.buttonsNodes=this.component.node.querySelectorAll('[data-role="trigger-buttons"]');this.initButtons();this.initTriggers();this.modified=false;for(var o=0;o<this.columnNodes.length;o++){jsDD.registerDest(this.columnNodes[o],10)}top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",this.onRestAppInstall.bind(this))},reInit:function(i,a){if(!t.type.isPlainObject(i))i={};var o;this.viewMode=a||e.ViewMode.View;for(o=0;o<this.listNodes.length;++o){t.cleanNode(this.listNodes[o])}for(o=0;o<this.buttonsNodes.length;++o){t.cleanNode(this.buttonsNodes[o])}this.triggersData=t.type.isArray(i.TRIGGERS)?i.TRIGGERS:[];this.initTriggers();this.initButtons();this.modified=false},initTriggers:function(){this.triggers=[];for(var t=0;t<this.triggersData.length;++t){var e=new n(this);e.init(this.triggersData[t],this.viewMode);this.insertTriggerNode(e.getStatusId(),e.node);this.triggers.push(e)}},initButtons:function(){if(this.viewMode===e.ViewMode.Edit){for(var t=0;t<this.buttonsNodes.length;++t){this.createAddButton(this.buttonsNodes[t])}}},createAddButton:function(e){var i=this,a=t.create("a",{text:t.message("BIZPROC_AUTOMATION_CMP_ADD"),props:{href:"#"},events:{click:function(t){t.preventDefault();i.onAddButtonClick(this)}},attrs:{className:"bizproc-automation-btn-add","data-status-id":e.getAttribute("data-status-id")}});e.appendChild(a)},onAddButtonClick:function(i){var a=this,o,s=[];var n=function(t,e){a.addTrigger(e.triggerData,function(t){a.openTriggerSettingsDialog(t)});this.popupWindow.close()};for(o=0;o<this.availableTriggers.length;++o){if(this.availableTriggers[o].CODE==="APP"){s.push(this.createAppTriggerMenuItem(i.getAttribute("data-status-id"),this.availableTriggers[o]));continue}s.push({text:this.availableTriggers[o].NAME,triggerData:{DOCUMENT_STATUS:i.getAttribute("data-status-id"),CODE:this.availableTriggers[o].CODE},onclick:n})}t.PopupMenu.show(e.generateUniqueId(),i,s,{autoHide:true,offsetLeft:t.pos(i)["width"]/2,angle:{position:"top",offset:0},events:{onPopupClose:function(){this.destroy()}}})},createAppTriggerMenuItem:function(e,i){var a=this,o=[];var s=function(t,e){a.addTrigger(e.triggerData,function(t){a.openTriggerSettingsDialog(t)});this.getRootMenuWindow().close()};for(var n=0;n<i["APP_LIST"].length;++n){var r=i["APP_LIST"][n];var l="["+r["APP_NAME"]+"] "+r["NAME"];o.push({text:t.util.htmlspecialchars(l),triggerData:{DOCUMENT_STATUS:e,NAME:l,CODE:i.CODE,APPLY_RULES:{APP_ID:r["APP_ID"],CODE:r["CODE"]}},onclick:s})}if(t.getClass("BX.rest.Marketplace")){if(o.length)o.push({delimiter:true});o.push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER_MARKETPLACE"),onclick:function(){t.rest.Marketplace.open({PLACEMENT:a.component.data["MARKETPLACE_TRIGGER_PLACEMENT"]});this.getRootMenuWindow().close()}})}return{text:i.NAME,items:o}},addTrigger:function(t,e){var i=new n(this);i.init(t,this.viewMode);i.draft=true;if(e)e(i)},deleteTrigger:function(t,e){if(t.getId()>0){t.markDeleted()}else{for(var i=0;i<this.triggers.length;++i){if(this.triggers[i]===t)this.triggers.splice(i,1)}}if(e)e(t);this.modified=true},insertTriggerNode:function(t,e){var i=this.component.node.querySelector('[data-role="trigger-list"][data-status-id="'+t+'"]');if(i){i.appendChild(e)}},serialize:function(){var t=[];for(var e=0;e<this.triggers.length;++e){t.push(this.triggers[e].serialize())}return t},getTriggerName:function(t){for(var e=0;e<this.availableTriggers.length;++e){if(t==this.availableTriggers[e]["CODE"])return this.availableTriggers[e]["NAME"]}return t},getAvailableTrigger:function(t){for(var e=0;e<this.availableTriggers.length;++e){if(t==this.availableTriggers[e]["CODE"])return this.availableTriggers[e]}return null},needSave:function(){return this.modified},openTriggerSettingsDialog:function(i){var a=this,o="bizproc_automation_trigger_dialog";var s=t.create("form",{props:{name:o},style:{"min-width":"540px"}});s.appendChild(a.renderConditionSettings(i));var n=t.create("div",{attrs:{className:"bizproc-automation-robot-help"},events:{click:t.delegate(this.component.onGlobalHelpClick,this.component)}});s.appendChild(n);var r=this.getTriggerName(i.data["CODE"]);s.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:t.message("BIZPROC_AUTOMATION_CMP_TRIGGER_NAME")+":"}));s.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("input",{attrs:{className:"bizproc-automation-popup-input",type:"text",name:"name",value:i.data["NAME"]||r}})]}));if(!t.type.isPlainObject(i.data["APPLY_RULES"])){i.data["APPLY_RULES"]={}}var l=this.getAvailableTrigger(i.data["CODE"]);if(i.data["CODE"]==="WEBHOOK"){if(!i.data["APPLY_RULES"]["code"])i.data["APPLY_RULES"]["code"]=t.util.getRandomString(5);s.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:"URL:"}));s.appendChild(t.create("input",{props:{type:"hidden",value:i.data["APPLY_RULES"]["code"],name:"code"}}));var p=t.create("textarea",{attrs:{className:"bizproc-automation-popup-textarea",placeholder:"...",readonly:"readonly",name:"webhook_handler"},events:{click:function(t){this.select()}}});s.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[p]}));s.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:t.message("BIZPROC_AUTOMATION_CMP_WEBHOOK_ID")}));if(l&&l["HANDLER"]){var d=window.location.protocol+"//"+window.location.host+l["HANDLER"];d=t.util.add_url_param(d,{code:i.data["APPLY_RULES"]["code"]});d=d.replace("{{DOCUMENT_TYPE}}",this.component.documentType[2]);p.value=d}}else if(i.data["CODE"]==="EMAIL_LINK"){s.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:t.message("BIZPROC_AUTOMATION_TRIGGER_EMAIL_LINK_URL")+":"}));s.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("textarea",{attrs:{className:"bizproc-automation-popup-textarea",placeholder:"https://example.com"},props:{name:"url"},text:i.data["APPLY_RULES"]["url"]||""})]}))}else if(i.data["CODE"]=="WEBFORM"){if(l&&l["WEBFORM_LIST"]){var c=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"form_id",value:""},children:[t.create("option",{props:{value:""},text:t.message("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var u=0;u<l["WEBFORM_LIST"].length;++u){var h=l["WEBFORM_LIST"][u];c.appendChild(t.create("option",{props:{value:h["ID"]},text:h["NAME"]}))}if(t.type.isPlainObject(i.data["APPLY_RULES"])&&i.data["APPLY_RULES"]["form_id"]){c.value=i.data["APPLY_RULES"]["form_id"]}var m=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_LABEL")+":"}),c]});s.appendChild(m)}}else if(i.data["CODE"]=="STATUS"){if(l&&l["STATUS_LIST"]){var c=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"STATUS",value:""},children:[t.create("option",{props:{value:""},text:t.message("BIZPROC_AUTOMATION_TRIGGER_STATUS_ANY")})]});for(var u=0;u<l["STATUS_LIST"].length;++u){var h=l["STATUS_LIST"][u];c.appendChild(t.create("option",{props:{value:h["ID"]},text:h["NAME"]}))}if(t.type.isPlainObject(i.data["APPLY_RULES"])&&i.data["APPLY_RULES"]["STATUS"]){c.value=i.data["APPLY_RULES"]["STATUS"]}var m=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:l["STATUS_LABEL"]+":"}),c]});s.appendChild(m)}}else if(i.data["CODE"]=="CALL"){if(l&&l["LINES"]){var c=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"LINE_NUMBER",value:""},children:[t.create("option",{props:{value:""},text:t.message("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var u=0;u<l["LINES"].length;++u){var h=l["LINES"][u];c.appendChild(t.create("option",{props:{value:h["LINE_NUMBER"]},text:h["SHORT_NAME"]}))}if(i.data["APPLY_RULES"]["LINE_NUMBER"]){c.value=i.data["APPLY_RULES"]["LINE_NUMBER"]}var m=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_TRIGGER_CALL_LABEL")+":"}),c]});s.appendChild(m)}}else if(i.data["CODE"]=="OPENLINE"){if(l&&l["CONFIG_LIST"]){var c=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"config_id",value:""},children:[t.create("option",{props:{value:""},text:t.message("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var u=0;u<l["CONFIG_LIST"].length;++u){var h=l["CONFIG_LIST"][u];c.appendChild(t.create("option",{props:{value:h["ID"]},text:h["NAME"]}))}if(t.type.isPlainObject(i.data["APPLY_RULES"])&&i.data["APPLY_RULES"]["config_id"]){c.value=i.data["APPLY_RULES"]["config_id"]}var m=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_TRIGGER_OPENLINE_LABEL")+":"}),c]});s.appendChild(m)}}t.addClass(this.component.node,"automation-base-blocked");var f=new t.PopupWindow(e.generateUniqueId(),null,{titleBar:r,content:s,closeIcon:true,zIndex:-100,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:false,events:{onPopupClose:function(e){e.destroy();t.removeClass(a.component.node,"automation-base-blocked")}},buttons:[new t.PopupWindowButton({text:t.message("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function(){var e=t.ajax.prepareForm(s);i.data["NAME"]=e["data"]["name"];if(i.data["CODE"]==="WEBFORM"){i.data["APPLY_RULES"]={form_id:e["data"]["form_id"]}}if(i.data["CODE"]==="STATUS"){i.data["APPLY_RULES"]={STATUS:e["data"]["STATUS"]}}if(i.data["CODE"]==="CALL"&&e["data"]["LINE_NUMBER"]){i.data["APPLY_RULES"]={LINE_NUMBER:e["data"]["LINE_NUMBER"]}}if(i.data["CODE"]==="OPENLINE"){i.data["APPLY_RULES"]={config_id:e["data"]["config_id"]}}if(i.data["CODE"]==="WEBHOOK"){i.data["APPLY_RULES"]={code:e["data"]["code"]}}if(i.data["CODE"]==="EMAIL_LINK"){i.data["APPLY_RULES"]={url:e["data"]["url"]}}a.setConditionSettingsFromForm(e["data"],i);if(i.draft){a.triggers.push(i);a.insertTriggerNode(i.getStatusId(),i.node)}delete i.draft;i.reInit();a.modified=true;this.popupWindow.close()}}}),new t.PopupWindowButtonLink({text:t.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});f.show()},renderConditionSettings:function(e){var i=t.clone(e.getCondition());var a=new v(i,{fields:this.component.data["DOCUMENT_FIELDS"]});return t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION")+":"}),a.createNode()]})]})},setConditionSettingsFromForm:function(e,i){var a,o=new b;if(t.type.isArray(e["condition_field"])){for(a=0;a<e["condition_field"].length;++a){if(e["condition_field"][a]===""){continue}var s=new T;s.setField(e["condition_field"][a]);s.setOperator(e["condition_operator"][a]);s.setValue(e["condition_value"][a]);var n=b.Joiner.And;if(e["condition_joiner"]&&e["condition_joiner"][a]===b.Joiner.Or){n=b.Joiner.Or}o.addItem(s,n)}}i.setCondition(o);return this},onRestAppInstall:function(e,i){i.redirect=false;var a=this;setTimeout(function(){t.ajax({method:"POST",dataType:"json",url:a.component.getAjaxUrl(),data:{ajax_action:"get_available_triggers",document_signed:a.component.documentSigned},onsuccess:function(e){if(t.type.isArray(e["DATA"])){a.availableTriggers=e["DATA"]}}})},1500)}};var n=function(t){this.manager=t;this.component=t.component;this.tracker=t.component.tracker;this.data={};this.deleted=false;this.draggableItem=null;this.droppableItem=null;this.droppableColumn=null;this.stub=null;this.column=null};n.prototype={init:function(t,i){if(t)this.data=t;if(this.data&&this.data.APPLY_RULES&&this.data.APPLY_RULES.Condition){this.condition=new b(this.data.APPLY_RULES.Condition)}else{this.condition=new b}this.viewMode=i||e.ViewMode.View;this.node=this.createNode()},reInit:function(t,e){var i=this.node;this.node=this.createNode();if(i.parentNode)i.parentNode.replaceChild(this.node,i)},getId:function(){return this.data["ID"]||0},getStatusId:function(){return this.data["DOCUMENT_STATUS"]||""},getLogStatus:function(){var t=this.tracker.getTriggerLog(this.getId());return t?parseInt(t["STATUS"]):null},getCondition:function(){return this.condition},setCondition:function(t){this.condition=t;return this},createNode:function(){var i=this,a=this.getLogStatus();var o="bizproc-automation-trigger-item-wrapper";if(this.viewMode===e.ViewMode.Edit){o+=" bizproc-automation-trigger-item-wrapper-draggable";var s=t.create("div",{attrs:{className:"bizproc-automation-trigger-item-wrapper-edit"},text:t.message("BIZPROC_AUTOMATION_CMP_EDIT")})}else{if(a==e.LogStatus.Completed){o+=" bizproc-automation-trigger-item-wrapper-complete"}else if(this.component.isPreviousStatus(this.getStatusId())){o+=" bizproc-automation-trigger-item-wrapper-complete-light"}}var n=this.data["NAME"];if(!n){n=this.manager.getTriggerName(this.data["CODE"])}var r=t.create("DIV",{attrs:{"data-role":"trigger-container",className:"bizproc-automation-trigger-item","data-type":"item-trigger"},children:[t.create("div",{attrs:{className:o},children:[t.create("div",{attrs:{className:"bizproc-automation-trigger-item-wrapper-text"},text:n})]}),s]});if(this.viewMode===e.ViewMode.Edit){this.registerItem(r);var l=t.create("SPAN",{attrs:{"data-role":"btn-delete-trigger",className:"bizproc-automation-trigger-btn-delete"}});t.bind(l,"click",function(t){t.preventDefault();t.stopPropagation();i.onDeleteButtonClick(this)});r.appendChild(l);t.addClass(r.firstChild,"bizproc-automation-trigger-item-wrapper-border")}if(this.viewMode===e.ViewMode.Edit){t.bind(r,"click",function(t){i.onSettingsButtonClick(this)})}return r},onSettingsButtonClick:function(t){this.manager.openTriggerSettingsDialog(this)},registerItem:function(e){e.onbxdragstart=t.proxy(this.dragStart,this);e.onbxdrag=t.proxy(this.dragMove,this);e.onbxdragstop=t.proxy(this.dragStop,this);e.onbxdraghover=t.proxy(this.dragOver,this);jsDD.registerObject(e);jsDD.registerDest(e,1)},dragStart:function(){this.draggableItem=t.proxy_context;this.draggableItem.className="bizproc-automation-trigger-item";if(!this.draggableItem){jsDD.stopCurrentDrag();return}if(!this.stub){var e=this.draggableItem.offsetWidth;this.stub=this.draggableItem.cloneNode(true);this.stub.style.position="absolute";this.stub.className="bizproc-automation-trigger-item bizproc-automation-trigger-item-drag";this.stub.style.width=e+"px";document.body.appendChild(this.stub)}},dragMove:function(t,e){this.stub.style.left=t+"px";this.stub.style.top=e+"px"},dragOver:function(t,e,i){if(this.droppableItem){this.droppableItem.className="bizproc-automation-trigger-item"}if(this.droppableColumn){this.droppableColumn.className="bizproc-automation-trigger-list"}var a=t.getAttribute("data-type");if(a==="item-trigger"){this.droppableItem=t;this.droppableColumn=null}if(a==="column-trigger"){this.droppableColumn=t.children[0];this.droppableItem=null}if(this.droppableItem){this.droppableItem.className="bizproc-automation-trigger-item bizproc-automation-trigger-item-pre"}if(this.droppableColumn){this.droppableColumn.className="bizproc-automation-trigger-list bizproc-automation-trigger-list-pre"}},dragStop:function(t,e,i){i=i||window.event;var a,o=i&&i.ctrlKey;var s=function(t,e){var i=new n(t.manager);var a=t.serialize();delete a["ID"];if(a["CODE"]==="WEBHOOK"){a["APPLY_RULES"]={}}a["DOCUMENT_STATUS"]=e;i.init(a,t.viewMode);return i};if(this.draggableItem){if(this.droppableItem){this.droppableItem.className="bizproc-automation-trigger-item";var r=this.droppableItem.parentNode;if(!o){r.insertBefore(this.draggableItem,this.droppableItem);this.moveTo(r.getAttribute("data-status-id"))}else{a=s(this,r.getAttribute("data-status-id"));r.insertBefore(a.node,this.droppableItem)}}else if(this.droppableColumn){this.droppableColumn.className="bizproc-automation-trigger-list";if(!o){this.droppableColumn.appendChild(this.draggableItem);this.moveTo(this.droppableColumn.getAttribute("data-status-id"))}else{a=s(this,this.droppableColumn.getAttribute("data-status-id"));this.droppableColumn.appendChild(a.node)}}if(a){this.manager.triggers.push(a);this.manager.modified=true}}this.stub.parentNode.removeChild(this.stub);this.stub=null;this.draggableItem=null;this.droppableItem=null},onDeleteButtonClick:function(e){t.remove(e.parentNode);this.manager.deleteTrigger(this)},updateData:function(e){if(t.type.isPlainObject(e)){this.data=e}else throw"Invalid data"},markDeleted:function(){this.deleted=true;return this},serialize:function(){var e=t.clone(this.data);if(this.deleted){e["DELETED"]="Y"}if(!t.type.isPlainObject(e.APPLY_RULES)){e.APPLY_RULES={}}if(!this.condition.items.length){delete e.APPLY_RULES.Condition}else{e.APPLY_RULES.Condition=this.condition.serialize()}return e},moveTo:function(t){this.data["DOCUMENT_STATUS"]=t;this.manager.modified=true}};var r=function(t){this.component=t};r.prototype={init:function(e){if(!t.type.isPlainObject(e))e={};this.log=e;this.triggers={};this.robots={};for(var i in e){if(!e.hasOwnProperty(i))continue;if(e[i]["trigger"]){this.triggers[e[i]["trigger"]["ID"]]=e[i]["trigger"]}if(e[i]["robots"]){for(var a in e[i]["robots"]){if(!e[i]["robots"].hasOwnProperty(a))continue;this.robots[a]=e[i]["robots"][a]}}}},reInit:function(t){this.init(t)},getRobotLog:function(t){return this.robots[t]||null},getTriggerLog:function(t){return this.triggers[t]||null}};var l=function(i,a){var o=this;var s,n=a.getAttribute("data-config");if(n){s=t.parseJSON(n)}if(!t.type.isPlainObject(s))s={};this.container=a;this.itemsNode=t.create("span");this.inputBoxNode=t.create("span",{attrs:{className:"feed-add-destination-input-box"}});this.inputNode=t.create("input",{props:{type:"text"},attrs:{className:"feed-add-destination-inp"}});this.inputBoxNode.appendChild(this.inputNode);this.tagNode=t.create("a",{attrs:{className:"feed-add-destination-link"}});t.addClass(a,"bizproc-automation-popup-autocomplete");a.appendChild(this.itemsNode);a.appendChild(this.inputBoxNode);a.appendChild(this.tagNode);this.component=i;this.itemTpl=s.itemTpl;this.data=null;this.dialogId=e.generateUniqueId();this.createValueNode(s.valueInputName||"");this.selected=s.selected?t.clone(s.selected):[];this.selectOne=!s.multiple;this.required=s.required||false;this.additionalFields=t.type.isArray(s.additionalFields)?s.additionalFields:[];t.bind(this.tagNode,"focus",function(t){t.preventDefault();o.openDialog({bByFocusEvent:true})});t.bind(this.container,"click",function(t){t.preventDefault();o.openDialog()});this.addItems(this.selected);this.tagNode.innerHTML=this.selected.length<=0?t.message("BIZPROC_AUTOMATION_CMP_CHOOSE"):t.message("BIZPROC_AUTOMATION_CMP_EDIT")};l.prototype={getData:function(e){var i=this;if(i.ajaxProgress)return;i.ajaxProgress=true;t.ajax({method:"POST",dataType:"json",url:i.component.getAjaxUrl(),data:{ajax_action:"get_destination_data",document_signed:i.component.documentSigned},onsuccess:function(t){i.data=t.DATA||{};i.ajaxProgress=false;i.initDialog(e)}})},initDialog:function(e){var i,a=this,o=this.data;if(!o){a.getData(e);return}var s={};for(i=0;i<a.selected.length;++i){s[a.selected[i].id]=a.selected[i].entityType}var n={users:o.USERS||{},department:o.DEPARTMENT||{},departmentRelation:o.DEPARTMENT_RELATION||{},bpuserroles:o.ROLES||{}};var r={users:o.LAST.USERS||{},bpuserroles:o.LAST.ROLES||{}};for(i=0;i<this.additionalFields.length;++i){n.bpuserroles[this.additionalFields[i]["id"]]=this.additionalFields[i]}if(!n["departmentRelation"]){n["departmentRelation"]=t.SocNetLogDestination.buildDepartmentRelation(n["department"])}if(!a.inited){a.inited=true;var l=a.inputNode;l.id=a.dialogId+"input";var p=a.inputBoxNode;p.id=a.dialogId+"input-box";var d=this.tagNode;d.id=this.dialogId+"tag";var c=a.itemsNode;t.SocNetLogDestination.init({name:a.dialogId,searchInput:l,extranetUser:false,bindMainPopup:{node:a.container,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:a.container,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,sendAjaxSearch:true,callback:{select:function(e,i,o,s){a.addItem(e,i);if(a.selectOne)t.SocNetLogDestination.closeDialog()},unSelect:function(e){if(a.selectOne)return;a.unsetValue(e.entityId);t.SocNetLogDestination.BXfpUnSelectCallback.call({formName:a.dialogId,inputContainerName:c,inputName:l.id,tagInputName:d.id,tagLink1:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE"),tagLink2:t.message("BIZPROC_AUTOMATION_CMP_EDIT")},e)},openDialog:t.delegate(t.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:p.id,inputName:l.id,tagInputName:d.id}),closeDialog:t.delegate(t.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:p.id,inputName:l.id,tagInputName:d.id}),openSearch:t.delegate(t.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:p.id,inputName:l.id,tagInputName:d.id}),closeSearch:t.delegate(t.SocNetLogDestination.BXfpCloseSearchCallback,{inputBoxName:p.id,inputName:l.id,tagInputName:d.id})},items:n,itemsLast:r,itemsSelected:s,useClientDatabase:false,destSort:o.DEST_SORT||{},allowAddUser:false});t.onCustomEvent(t.SocNetLogDestination,"onTabsAdd",[a.dialogId,{id:"bpuserrole",name:t.message("BIZPROC_AUTOMATION_CMP_USER_SELECTOR_TAB"),itemType:"bpuserroles",dialogGroup:{groupCode:"bpuserroles",title:t.message("BIZPROC_AUTOMATION_CMP_USER_SELECTOR_TAB")}}]);t.bind(l,"keyup",t.delegate(t.SocNetLogDestination.BXfpSearch,{formName:a.dialogId,inputName:l.id,tagInputName:d.id}));t.bind(l,"keydown",t.delegate(t.SocNetLogDestination.BXfpSearchBefore,{formName:a.dialogId,inputName:l.id}));t.SocNetLogDestination.BXfpSetLinkName({formName:a.dialogId,tagInputName:d.id,tagLink1:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE"),tagLink2:t.message("BIZPROC_AUTOMATION_CMP_EDIT")})}e()},addItem:function(e,i){var a=this;var o=this.inputNode;var s=this.tagNode;var n=this.itemsNode;if(!t.findChild(n,{attr:{"data-id":e.id}},false,false)){if(a.selectOne&&a.inited){var r=[];for(var l=0;l<n.childNodes.length;++l){r.push({itemId:n.childNodes[l].getAttribute("data-id"),itemType:n.childNodes[l].getAttribute("data-type")})}a.initDialog(function(){for(var e=0;e<r.length;++e){t.SocNetLogDestination.deleteItem(r[e].itemId,r[e].itemType,a.dialogId)}});t.cleanNode(n);a.cleanValue()}var p=this.createItemNode({text:e.name,deleteEvents:{click:function(o){if(a.selectOne&&a.required){a.openDialog()}else{a.initDialog(function(){t.SocNetLogDestination.deleteItem(e.id,i,a.dialogId);t.remove(p);a.unsetValue(e.entityId)})}o.preventDefault()}}});this.setValue(e.entityId);p.setAttribute("data-id",e.id);p.setAttribute("data-type",i);n.appendChild(p);if(!e.entityType){e.entityType=i}}o.value="";s.innerHTML=t.message("BIZPROC_AUTOMATION_CMP_EDIT")},addItems:function(t){for(var e=0;e<t.length;++e){this.addItem(t[e],t[e].entityType)}},openDialog:function(e){var i=this;this.initDialog(function(){t.SocNetLogDestination.openDialog(i.dialogId,e)})},destroy:function(){if(this.inited){if(t.SocNetLogDestination.isOpenDialog()){t.SocNetLogDestination.closeDialog()}t.SocNetLogDestination.closeSearch()}},createItemNode:function(e){return t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-item"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-name"},html:e.text||""}),t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-delete"},events:e.deleteEvents})]})},createValueNode:function(e){this.valueNode=t.create("input",{props:{type:"hidden",name:e}});this.container.appendChild(this.valueNode)},setValue:function(t){if(/^\d+$/.test(t))t="["+t+"]";if(this.selectOne)this.valueNode.value=t;else{var e,i=[],a=this.valueNode.value.split(";");for(e=0;e<a.length;++e){if(!a[e]||t==a[e])continue;i.push(a[e])}i.push(t);this.valueNode.value=i.join(";")}},unsetValue:function(t){if(/^\d+$/.test(t))t="["+t+"]";if(this.selectOne)this.valueNode.value="";else{var e,i=[],a=this.valueNode.value.split(";");for(e=0;e<a.length;++e){if(!a[e]||t==a[e])continue;i.push(a[e])}this.valueNode.value=i.join(";")}},cleanValue:function(){this.valueNode.value=""}};var p=function(e,i){var a,o=i.getAttribute("data-config");if(o){a=t.parseJSON(o)}if(!t.type.isPlainObject(a))a={};this.container=i;this.type=a.type||p.Type.File;if(a.selected&&!a.selected.length){this.type=p.Type.None}this.multiple=a.multiple||false;this.required=a.required||false;this.valueInputName=a.valueInputName||"";this.typeInputName=a.typeInputName||"";this.useDisk=a.useDisk||false;this.label=a.label||"Attachment";this.labelFile=a.labelFile||"File";this.labelDisk=a.labelDisk||"Disk";this.setFileFields(e.data["DOCUMENT_FIELDS"]);this.createDom();if(a.selected&&a.selected.length>0){this.addItems(t.clone(a.selected))}};p.Type={None:"",Disk:"disk",File:"file"};p.prototype={setFileFields:function(t){var e=[];for(var i=0;i<t.length;++i){if(t[i]["Type"]==="file"){e.push(t[i])}}this.fileFields=e;return this},createDom:function(){this.container.appendChild(this.createBaseNode());this.showTypeControllerLayout(this.type)},createBaseNode:function(){var i=e.generateUniqueId();var a=null;if(this.fileFields.length>0){a=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",type:"radio",id:"type-1"+i,name:this.typeInputName,value:p.Type.File}});if(this.type===p.Type.File){a.setAttribute("checked","checked")}}var o=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",type:"radio",id:"type-2"+i,name:this.typeInputName,value:p.Type.Disk}});if(this.type===p.Type.Disk){o.setAttribute("checked","checked")}var s=[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:this.label+":"})];if(a){s.push(a,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-link",for:"type-1"+i},text:this.labelFile,events:{click:this.onTypeChange.bind(this,p.Type.File)}}))}s.push(o,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-link",for:"type-2"+i},text:this.labelDisk,events:{click:this.onTypeChange.bind(this,p.Type.Disk)}}));return t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:s})]})},showTypeControllerLayout:function(t){if(t===p.Type.Disk){this.hideFileControllerLayout();this.showDiskControllerLayout()}else if(t===p.Type.File){this.hideDiskControllerLayout();this.showFileControllerLayout()}else{this.hideFileControllerLayout();this.hideDiskControllerLayout()}},showDiskControllerLayout:function(){if(!this.diskControllerNode){this.diskControllerNode=t.create("div");this.container.appendChild(this.diskControllerNode);var e=this.getDiskUploader();e.layout(this.diskControllerNode);e.show(true)}else{t.show(this.diskControllerNode)}},hideDiskControllerLayout:function(){if(this.diskControllerNode){t.hide(this.diskControllerNode)}},showFileControllerLayout:function(){if(!this.fileControllerNode){this.fileItemsNode=t.create("span");this.fileControllerNode=t.create("div",{children:[this.fileItemsNode]});this.container.appendChild(this.fileControllerNode);var e=t.create("a",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-popup-settings-link-thin"},text:t.message("BIZPROC_AUTOMATION_CMP_ADD")});this.fileControllerNode.appendChild(e);t.bind(e,"click",this.onFileFieldAddClick.bind(this,e))}else{t.show(this.fileControllerNode)}},hideFileControllerLayout:function(){if(this.fileControllerNode){t.hide(this.fileControllerNode)}},getDiskUploader:function(){if(!this.diskUploader){this.diskUploader=t.Bizproc.Automation.DiskUploader.create("",{msg:{diskAttachFiles:t.message("BIZPROC_AUTOMATION_CMP_DISK_ATTACH_FILE"),diskAttachedFiles:t.message("BIZPROC_AUTOMATION_CMP_DISK_ATTACHED_FILES"),diskSelectFile:t.message("BIZPROC_AUTOMATION_CMP_DISK_SELECT_FILE"),diskSelectFileLegend:t.message("BIZPROC_AUTOMATION_CMP_DISK_SELECT_FILE_LEGEND"),diskUploadFile:t.message("BIZPROC_AUTOMATION_CMP_DISK_UPLOAD_FILE"),diskUploadFileLegend:t.message("BIZPROC_AUTOMATION_CMP_DISK_UPLOAD_FILE_LEGEND")}});this.diskUploader.setMode(1)}return this.diskUploader},onTypeChange:function(t){if(this.type!==t){this.type=t;this.showTypeControllerLayout(this.type)}},isFileItemSelected:function(t){var e=this.fileItemsNode.querySelector('[data-file-id="'+t.id+'"]');return!!e},addFileItem:function(e){if(this.isFileItemSelected(e)){return false}var i=this.createFileItemNode(e);if(!this.multiple){t.cleanNode(this.fileItemsNode)}this.fileItemsNode.appendChild(i)},addItems:function(t){if(this.type===p.Type.File){for(var e=0;e<t.length;++e){this.addFileItem(t[e])}}else{this.getDiskUploader().setValues(this.convertToDiskItems(t))}},convertToDiskItems:function(t){var e=[];for(var i=0;i<t.length;++i){var a=t[i];e.push({ID:a["id"],NAME:a["name"],SIZE:a["size"],VIEW_URL:""})}return e},removeFileItem:function(t){var e=this.fileItemsNode.querySelector('[data-file-id="'+t.id+'"]');if(e){this.fileItemsNode.removeChild(e)}},onFileFieldAddClick:function(i,a){var o=this,s,n=[];var r=this.fileFields;for(s=0;s<r.length;++s){n.push({text:t.util.htmlspecialchars(r[s]["Name"]),field:r[s],onclick:function(t,e){this.popupWindow.close();o.onFieldSelect(e.field)}})}if(!this.menuId){this.menuId=e.generateUniqueId()}t.PopupMenu.show(this.menuId,i,n,{zIndex:200,autoHide:true,offsetLeft:t.pos(i)["width"]/2,angle:{position:"top",offset:0}});this.menu=t.PopupMenu.currentItem;a.preventDefault()},onFieldSelect:function(t){this.addFileItem({id:t.Id,expression:t.Expression,name:t.Name,type:p.Type.File})},destroy:function(){if(this.menu){this.menu.popupWindow.close()}},createFileItemNode:function(e){return t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-item","data-file-id":e.id,"data-file-expression":e.expression},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-name"},text:e.name||""}),t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-delete"},events:{click:this.removeFileItem.bind(this,e)}})]})},onBeforeSave:function(){var e=[];if(this.type===p.Type.Disk){e=this.getDiskUploader().getValues()}else if(this.type===p.Type.File){this.fileItemsNode.childNodes.forEach(function(t){var i=t.getAttribute("data-file-expression");if(i!==""){e.push(i)}})}for(var i=0;i<e.length;++i){this.container.appendChild(t.create("input",{props:{type:"hidden",name:this.valueInputName+(this.multiple?"[]":""),value:e[i]}}))}}};var d=function(e,i){var a=this;this.component=e;this.documentFields=this.component.data["DOCUMENT_FIELDS"];this.targetInput=t.clone(i);this.menuButton=t.create("span",{attrs:{className:"bizproc-automation-popup-select-dotted"},events:{click:t.delegate(a.openMenu,this)}});var o=t.create("div",{attrs:{className:"bizproc-automation-popup-select"},children:[this.targetInput,this.menuButton]});i.parentNode.replaceChild(o,i);t.bind(this.targetInput,"keydown",function(t){a.onKeyDown(this,t)});this.targetInput.setAttribute("autocomplete","off");var s=this.targetInput.getAttribute("data-selector-type");if(s==="date"||s==="UF:date"||s==="datetime"){this.initDateTimeControl(s)}this.replaceOnWrite=this.targetInput.getAttribute("data-selector-write-mode")==="replace"};d.prototype={onKeyDown:function(t,e){if(e.keyCode==45&&e.altKey===false&&e.ctrlKey===false&&e.shiftKey===false){this.openMenu(e);e.preventDefault()}},openMenu:function(i){var a=this,o,s,n=this.documentFields;var r=function(t,e){(this.getRootMenuWindow()||this.popupWindow).close();a.onFieldSelect(e.field)};var l=[],p={ROOT:{text:this.component.data["ENTITY_NAME"],items:[]}};for(o=0;o<n.length;++o){s=n[o];var d=s["Id"].indexOf(".")<0?"ROOT":s["Id"].split(".")[0];var c=s["Name"];var u="";if(c&&c.indexOf(": ")>=0){var h=c.split(": ");u=h.shift();c=h.join(": ")}if(!p[d]){p[d]={text:u,items:[]}}p[d]["items"].push({text:c||s["Id"],field:s,onclick:r})}if(Object.keys(p).length<2){l=p["ROOT"]["items"]}else{l.push(p["ROOT"]);delete p["ROOT"];for(d in p){if(p.hasOwnProperty(d)){l.push(p[d])}}}var m=this.menuButton.getAttribute("data-selector-id");if(!m){m=e.generateUniqueId();this.menuButton.setAttribute("data-selector-id",m)}t.PopupMenu.show(m,this.menuButton,l,{zIndex:200,autoHide:true,offsetLeft:t.pos(this.menuButton)["width"]/2,angle:{position:"top",offset:0},maxWidth:300,maxHeight:500});this.menu=t.PopupMenu.currentItem},onFieldSelect:function(e){if(this.replaceOnWrite){this.targetInput.value="{{"+e["Name"]+"}}";this.targetInput.selectionEnd=this.targetInput.value.length}else{var i=this.targetInput.value.substr(0,this.targetInput.selectionEnd),a="{{"+e["Name"]+"}}",o=this.targetInput.value.substr(this.targetInput.selectionEnd);this.targetInput.value=i+a+o;this.targetInput.selectionEnd=i.length+a.length}t.fireEvent(this.targetInput,"change")},destroy:function(){if(this.menu)this.menu.popupWindow.close()},initDateTimeControl:function(e){this.targetInput.setAttribute("readonly","readonly");var i=[];if(t.type.isArray(this.component.data["DOCUMENT_FIELDS"])){var a,o;for(a=0;a<this.component.data["DOCUMENT_FIELDS"].length;++a){o=this.component.data["DOCUMENT_FIELDS"][a];if(o["Type"]=="date"||o["Type"]=="datetime"||o["Type"]=="UF:date")i.push(o)}}this.documentFields=i;var s=new m({labelNode:this.targetInput,basisFields:i,useAfterBasis:true,onchange:function(t){this.targetInput.value=t.toExpression(i)}.bind(this)});s.init(g.fromString(this.targetInput.value,i))}};var c=function(e,i){var a=this;this.component=e;this.documentFields=this.component.data["DOCUMENT_FIELDS"];this.editorNode=i.firstElementChild.firstElementChild;this.menuButton=t.create("span",{attrs:{className:"bizproc-automation-popup-select-dotted"},events:{click:t.delegate(a.openMenu,this)}});i.firstElementChild.appendChild(this.menuButton);this.bindEvents()};t.extend(c,d);c.prototype.getEditor=function(){var t;if(this.editorNode){var e=this.editorNode.id.split("-");t=BXHtmlEditor.Get(e[e.length-1])}return t};c.prototype.bindEvents=function(){this.editorInitFunction=this.bindEditorHooks.bind(this);t.addCustomEvent("OnEditorInitedAfter",this.editorInitFunction)};c.prototype.unBindEvents=function(){t.removeCustomEvent("OnEditorInitedAfter",this.editorInitFunction)};c.prototype.bindEditorHooks=function(e){var i="",a="";if(e.dom.cont!==this.editorNode){return false}t.addCustomEvent(e,"OnParse",function(t){if(!t){var e=this.content;e=e.replace(/(^[\s\S]*?)(<body.*?>)/i,function(t){i=t;return""});e=e.replace(/(<\/body>[\s\S]*?$)/i,function(t){a=t;return""});this.content=e}});t.addCustomEvent(e,"OnAfterParse",function(t){if(t){var e=this.content;e=e.replace(/^[\s\S]*?<body.*?>/i,"");e=e.replace(/<\/body>[\s\S]*?$/i,"");if(i!==""&&a!==""){e=i+e+a}this.content=e}})};c.prototype.onFieldSelect=function(t){var e="{{"+t["Name"]+"}}";var i=this.getEditor();if(i&&i.InsertHtml){i.InsertHtml(e)}};c.prototype.destroy=function(){if(this.menu)this.menu.popupWindow.close();this.unBindEvents()};c.prototype.onBeforeSave=function(){var t=this.getEditor();if(t&&t.SaveContent){t.SaveContent()}};c.prototype.onPopupResize=function(){var t=this.getEditor();if(t&&t.ResizeSceleton){t.ResizeSceleton()}};var u=function(e){this.targetInput=e;var i=new Date,a=this.unFormatTime(e.value);i.setHours(0,0,0,0);i.setTime(i.getTime()+a*1e3);e.value=this.formatTime(i);t.bind(e,"click",t.delegate(this.showClock,this))};u.prototype={showClock:function(e){if(!this.clockInstance){this.clockInstance=new t.CClockSelector({start_time:this.unFormatTime(this.targetInput.value),node:this.targetInput,callback:t.delegate(this.onTimeSelect,this),zIndex:200})}this.clockInstance.Show()},onTimeSelect:function(e){this.targetInput.value=e;t.fireEvent(this.targetInput,"change");this.clockInstance.closeWnd()},unFormatTime:function(t){var e=t.split(/[\s:]+/);if(e.length==3){var i=e[2];if(i=="pm"&&e[0]<12)e[0]=parseInt(e[0],10)+12;if(i=="am"&&e[0]==12)e[0]=0}return parseInt(e[0],10)*3600+parseInt(e[1],10)*60},formatTime:function(e){var i=t.date.convertBitrixFormat(t.message("FORMAT_DATE")).replace(/:?\s*s/,""),a=t.date.convertBitrixFormat(t.message("FORMAT_DATETIME")).replace(/:?\s*s/,""),o=t.date.format(i,e),s=t.date.format(a,e);return t.util.trim(s.replace(o,""))},destroy:function(){if(this.clockInstance)this.clockInstance.closeWnd()}};var h=function(t,e){this.checkbox=t;this.robot=e;this.needSync=e.draft;if(this.needSync){var i=this.getKey();var a=e.component.getUserOption("save_state_checkboxes",i,"N");if(a==="Y"){t.checked=true}}};h.prototype={getKey:function(){return this.checkbox.getAttribute("data-save-state-key")},destroy:function(){if(this.needSync){var t=this.getKey();var e=this.checkbox.checked?"Y":"N";this.robot.component.setUserOption("save_state_checkboxes",t,e)}}};var m=function(e){this.basisFields=[];this.onchange=null;if(t.type.isPlainObject(e)){this.labelNode=e.labelNode;this.useAfterBasis=e.useAfterBasis;if(t.type.isArray(e.basisFields))this.basisFields=e.basisFields;this.onchange=e.onchange}};m.prototype={init:function(t){this.delay=t;this.setLabelText();this.bindLabelNode();this.prepareBasisFields()},setLabelText:function(){if(this.delay&&this.labelNode){this.labelNode.textContent=I(this.delay,t.message("BIZPROC_AUTOMATION_CMP_AT_ONCE"),this.basisFields)}},bindLabelNode:function(){if(this.labelNode){t.bind(this.labelNode,"click",t.delegate(this.onLabelClick,this))}},onLabelClick:function(t){this.showDelayIntervalPopup();t.preventDefault()},showDelayIntervalPopup:function(){var i=this,a=this.delay;var o=e.generateUniqueId();var s=t.create("form",{attrs:{className:"bizproc-automation-popup-select-block"}});var n=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:o+"now",type:"radio",value:"now",name:"type"}});if(a.isNow())n.setAttribute("checked","checked");var r=t.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:o+"now"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message(this.useAfterBasis?"BIZPROC_AUTOMATION_CMP_BASIS_NOW":"BIZPROC_AUTOMATION_CMP_AT_ONCE_2")})]});var l=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message(this.useAfterBasis?"BIZPROC_AUTOMATION_CMP_DELAY_NOW_HELP_2":"BIZPROC_AUTOMATION_CMP_DELAY_NOW_HELP")}});r.appendChild(l);s.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[n,r]}));s.appendChild(this.createAfterControlNode());if(this.basisFields.length>0){s.appendChild(this.createBeforeControlNode());s.appendChild(this.createInControlNode())}var p=t.create("input",{attrs:{type:"checkbox",id:o+"worktime",name:"worktime",value:"1",style:"vertical-align: middle"},props:{checked:a.workTime}});var d=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message("BIZPROC_AUTOMATION_CMP_DELAY_WORKTIME_HELP")}});s.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings-title"},children:[p,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-lbl",for:o+"worktime"},text:t.message("BIZPROC_AUTOMATION_CMP_WORK_TIME")}),d]}));var c=t.create("input",{attrs:{type:"checkbox",id:o+"localtime",name:"localtime",value:"1",style:"vertical-align: middle"},props:{checked:a.localTime}});var u=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message("BIZPROC_AUTOMATION_CMP_DELAY_LOCALTIME_HELP")}});s.appendChild(t.create("br"));s.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings-title"},children:[c,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-lbl",for:o+"localtime"},text:t.message("BIZPROC_AUTOMATION_CMP_LOCAL_TIME")}),u]}));t.UI.Hint.init(s);var h=new t.PopupWindow("bizproc-automation-popup-set",this.labelNode,{autoHide:true,closeByEsc:true,closeIcon:false,titleBar:false,zIndex:0,angle:true,offsetLeft:20,content:s,buttons:[new t.PopupWindowButton({text:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE"),className:"webform-button webform-button-create bizproc-automation-button-left",events:{click:function(){var e=t.ajax.prepareForm(s);i.saveFormData(e["data"]);this.popupWindow.close()}}})],events:{onPopupClose:function(){if(i.fieldsMenu){i.fieldsMenu.popupWindow.close()}if(i.valueTypeMenu){i.valueTypeMenu.popupWindow.close()}}},overlay:{backgroundColor:"transparent"}});h.show()},saveFormData:function(t){if(t["type"]==="now"){this.delay.setNow()}else if(t["type"]===g.Type.In){this.delay.setType(g.Type.In);this.delay.setValue(0);this.delay.setValueType("i");this.delay.setBasis(t["basis_in"])}else{this.delay.setType(t["type"]);this.delay.setValue(t["value_"+t["type"]]);this.delay.setValueType(t["value_type_"+t["type"]]);if(t["type"]===g.Type.After){if(this.useAfterBasis)this.delay.setBasis(t["basis_after"]);else this.delay.setBasis(g.Basis.CurrentDateTime)}else this.delay.setBasis(t["basis_before"])}this.delay.setWorkTime(t["worktime"]);this.delay.setLocalTime(t["localtime"]);this.setLabelText();if(this.onchange){this.onchange(this.delay)}},createAfterControlNode:function(){var i=this,a=this.delay;var o=e.generateUniqueId();var s=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:o,type:"radio",value:g.Type.After,name:"type"}});if(a.type===g.Type.After&&a.value>0)s.setAttribute("checked","checked");var n=t.create("input",{attrs:{type:"text",name:"value_after",className:"bizproc-automation-popup-settings-input"},props:{value:a.type===g.Type.After&&a.value?a.value:"5"}});var r=t.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:o},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_CMP_THROUGH_2")}),n,this.createValueTypeSelector("value_type_after")]});if(this.useAfterBasis){r.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-auto-width"},text:t.message("BIZPROC_AUTOMATION_CMP_AFTER")}));var l=this.getBasisField(a.basis,true);var p=a.basis;if(!l){l=this.getBasisField(g.Basis.CurrentDateTime,true);p=l.SystemExpression}var d=t.create("input",{attrs:{type:"hidden",name:"basis_after",value:p}});var c=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"},text:l?l.Name:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE_DATE_FIELD"),events:{click:function(t){i.onBasisClick(t,this,function(t){c.textContent=t.Name;d.value=t.SystemExpression},g.Type.After)}}});r.appendChild(d);r.appendChild(c)}if(!this.useAfterBasis){var u=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message("BIZPROC_AUTOMATION_CMP_DELAY_AFTER_HELP")}});r.appendChild(u)}return t.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[s,r]})},createBeforeControlNode:function(){var i=this,a=this.delay;var o=e.generateUniqueId();var s=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:o,type:"radio",value:g.Type.Before,name:"type"}});if(a.type===g.Type.Before)s.setAttribute("checked","checked");var n=t.create("input",{attrs:{type:"text",name:"value_before",className:"bizproc-automation-popup-settings-input"},props:{value:a.type===g.Type.Before&&a.value?a.value:"5"}});var r=t.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:o},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_CMP_FOR_TIME_2")}),n,this.createValueTypeSelector("value_type_before"),t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-auto-width"},text:t.message("BIZPROC_AUTOMATION_CMP_BEFORE")})]});var l=this.getBasisField(a.basis);var p=a.basis;if(!l){l=this.basisFields[0];p=l.SystemExpression}var d=t.create("input",{attrs:{type:"hidden",name:"basis_before",value:p}});var c=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"},text:l?l.Name:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE_DATE_FIELD"),events:{click:function(t){i.onBasisClick(t,this,function(t){c.textContent=t.Name;d.value=t.SystemExpression})}}});r.appendChild(d);r.appendChild(c);if(!this.useAfterBasis){var u=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message("BIZPROC_AUTOMATION_CMP_DELAY_BEFORE_HELP")}});r.appendChild(u)}return t.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[s,r]})},createInControlNode:function(){var i=this,a=this.delay;var o=e.generateUniqueId();var s=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:o,type:"radio",value:g.Type.In,name:"type"}});if(a.type===g.Type.In)s.setAttribute("checked","checked");var n=t.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:o},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_CMP_IN_TIME_2")})]});var r=this.getBasisField(a.basis);var l=a.basis;if(!r){r=this.basisFields[0];l=r.SystemExpression}var p=t.create("input",{attrs:{type:"hidden",name:"basis_in",value:l}});var d=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"},text:r?r.Name:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE_DATE_FIELD"),events:{click:function(t){i.onBasisClick(t,this,function(t){d.textContent=t.Name;p.value=t.SystemExpression})}}});n.appendChild(p);n.appendChild(d);if(!this.useAfterBasis){var c=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message("BIZPROC_AUTOMATION_CMP_DELAY_IN_HELP")}});n.appendChild(c)}return t.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[s,n]})},createValueTypeSelector:function(e){var i=this.delay;var a={i:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_M"),h:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_H"),d:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_D")};var o=t.create("label",{attrs:{className:"bizproc-automation-popup-settings-link"},text:a[i.valueType]});var s=t.create("input",{attrs:{type:"hidden",name:e},props:{value:i.valueType}});t.bind(o,"click",this.onValueTypeSelectorClick.bind(this,o,s));return t.create("span",{children:[o,s]})},onValueTypeSelectorClick:function(i,a){var o=e.generateUniqueId();var s=function(t,e){this.popupWindow.close();a.value=e.valueId;i.textContent=e.text};var n=[{text:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_M"),valueId:"i",onclick:s},{text:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_H"),valueId:"h",onclick:s},{text:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_D"),valueId:"d",onclick:s}];t.PopupMenu.show(o,i,n,{autoHide:true,offsetLeft:25,angle:{position:"top"},zIndex:200,events:{onPopupClose:function(){this.destroy()}},overlay:{backgroundColor:"transparent"}});this.valueTypeMenu=t.PopupMenu.currentItem},onBasisClick:function(i,a,o,s){var n=this,r,l=[];if(s===g.Type.After){l.push({text:t.message("BIZPROC_AUTOMATION_CMP_BASIS_NOW"),field:{Name:t.message("BIZPROC_AUTOMATION_CMP_BASIS_NOW"),SystemExpression:g.Basis.CurrentDateTime},onclick:function(t,e){if(o)o(e.field);this.popupWindow.close()}},{text:t.message("BIZPROC_AUTOMATION_CMP_BASIS_NOW_LOCAL"),field:{Name:t.message("BIZPROC_AUTOMATION_CMP_BASIS_NOW_LOCAL"),SystemExpression:g.Basis.CurrentDateTimeLocal},onclick:function(t,e){if(o)o(e.field);this.popupWindow.close()}},{text:t.message("BIZPROC_AUTOMATION_CMP_BASIS_DATE"),field:{Name:t.message("BIZPROC_AUTOMATION_CMP_BASIS_DATE"),SystemExpression:g.Basis.CurrentDate},onclick:function(t,e){if(o)o(e.field);this.popupWindow.close()}},{delimiter:true})}for(r=0;r<this.basisFields.length;++r){l.push({text:this.basisFields[r].Name,field:this.basisFields[r],onclick:function(t,e){if(o)o(e.field||e.options.field);this.popupWindow.close()}})}var p=a.getAttribute("data-menu-id");if(!p){p=e.generateUniqueId();a.setAttribute("data-menu-id",p)}t.PopupMenu.show(p,a,l,{zIndex:200,autoHide:true,offsetLeft:t.pos(a)["width"]/2,angle:{position:"top",offset:0},overlay:{backgroundColor:"transparent"}});this.fieldsMenu=t.PopupMenu.currentItem},getBasisField:function(e,i){if(i&&e===g.Basis.CurrentDateTime)return{Name:t.message("BIZPROC_AUTOMATION_CMP_BASIS_NOW"),SystemExpression:g.Basis.CurrentDateTime};if(i&&e===g.Basis.CurrentDateTimeLocal)return{Name:t.message("BIZPROC_AUTOMATION_CMP_BASIS_NOW_LOCAL"),SystemExpression:g.Basis.CurrentDateTimeLocal};if(i&&e===g.Basis.CurrentDate)return{Name:t.message("BIZPROC_AUTOMATION_CMP_BASIS_DATE"),SystemExpression:g.Basis.CurrentDate};var a=null;for(var o=0;o<this.basisFields.length;++o){if(e===this.basisFields[o].SystemExpression)a=this.basisFields[o]}return a},prepareBasisFields:function(){var t,e,i=[];for(t=0;t<this.basisFields.length;++t){e=this.basisFields[t];if(e["Id"].indexOf("DATE_CREATE")<0&&e["Id"].indexOf("DATE_MODIFY")<0&&e["Id"].indexOf("EVENT_DATE")<0&&e["Id"].indexOf("BIRTHDATE")<0)i.push(e)}this.basisFields=i}};var f={setRobotSettingsDialog:function(t){this.robotSettingsDialog=t},getRobotSettingsDialog:function(){return this.robotSettingsDialog}};var g=function(e){this.basis=g.Basis.CurrentDateTime;this.type=g.Type.After;this.value=0;this.valueType="i";this.workTime=false;this.localTime=false;if(t.type.isPlainObject(e)){if(e["type"])this.setType(e["type"]);if(e["value"])this.setValue(e["value"]);if(e["valueType"])this.setValueType(e["valueType"]);if(e["basis"])this.setBasis(e["basis"]);if(e["workTime"])this.setWorkTime(e["workTime"]);if(e["localTime"])this.setLocalTime(e["localTime"])}};g.Type={After:"after",Before:"before",In:"in"};g.Basis={CurrentDate:"{=System:Date}",CurrentDateTime:"{=System:Now}",CurrentDateTimeLocal:"{=System:NowLocal}"};g.isSystemBasis=function(t){return t===this.Basis.CurrentDate||t===this.Basis.CurrentDateTime||t===this.Basis.CurrentDateTimeLocal};g.fromString=function(e,i){e=e.toString();var a={basis:g.Basis.CurrentDateTime,i:0,h:0,d:0,workTime:false,localTime:false};if(e.indexOf("=dateadd(")===0||e.indexOf("=workdateadd(")===0){if(e.indexOf("=workdateadd(")===0){e=e.substr(13);a["workTime"]=true}else{e=e.substr(9)}var o=e.split(",");a["basis"]=o[0].trim();o[1]=o[1].replace(/['")]+/g,"");a["type"]=o[1].indexOf("-")===0?g.Type.Before:g.Type.After;var s,n=/s*([\d]+)\s*(i|h|d)\s*/gi;while(s=n.exec(o[1])){a[s[2]]=parseInt(s[1])}}else{a["basis"]=e}if(!g.isSystemBasis(a["basis"])&&t.type.isArray(i)){var r=false;for(var l=0,p=i.length;l<p;++l){if(a["basis"]===i[l].SystemExpression||a["basis"]===i[l].Expression){a["basis"]=i[l].SystemExpression;r=true;break}}if(!r){a["basis"]=g.Basis.CurrentDateTime}}var d=a["i"]+a["h"]*60+a["d"]*60*24;if(d%1440===0){a["value"]=d/1440;a["valueType"]="d"}else if(d%60===0){a["value"]=d/60;a["valueType"]="h"}else{a["value"]=d;a["valueType"]="i"}if(!a["value"]&&a["basis"]!==g.Basis.CurrentDateTime&&a["basis"]){a["type"]=g.Type.In}return new g(a)};g.prototype={setType:function(t){if(t!==g.Type.After&&t!==g.Type.Before&&t!==g.Type.In){t=g.Type.After}this.type=t},setValue:function(t){t=parseInt(t);this.value=t>=0?t:0},setValueType:function(t){if(t!=="i"&&t!=="h"&&t!=="d")t="i";this.valueType=t},setBasis:function(e){if(t.type.isNotEmptyString(e))this.basis=e},setWorkTime:function(t){this.workTime=!!t},setLocalTime:function(t){this.localTime=!!t},isNow:function(){return this.type===g.Type.After&&this.basis===g.Basis.CurrentDateTime&&!this.value},setNow:function(){this.setType(g.Type.After);this.setValue(0);this.setValueType("i");this.setBasis(g.Basis.CurrentDateTime)},serialize:function(){return{type:this.type,value:this.value,valueType:this.valueType,basis:this.basis,workTime:this.workTime?1:0,localTime:this.localTime?1:0}},toExpression:function(e){var i=this.basis?this.basis:g.Basis.CurrentDate;if(!g.isSystemBasis(i)&&t.type.isArray(e)){for(var a=0,o=e.length;a<o;++a){if(i===e[a].SystemExpression){i=e[a].Expression;break}}}if(!this.workTime&&(this.type===g.Type.In||this.isNow())){return i}var s=0,n=0,r=0;switch(this.valueType){case"i":r=this.value;break;case"h":n=this.value;break;case"d":s=this.value;break}var l="";if(this.type===g.Type.Before)l="-";if(s>0)l+=s+"d";if(n>0)l+=n+"h";if(r>0)l+=r+"i";var p=this.workTime?"workdateadd":"dateadd";if(p==="workdateadd"&&l===""){l="0d"}return"="+p+"("+i+',"'+l+'")'}};var T=function(e){this.field="";this.operator="!empty";this.value="";if(t.type.isPlainObject(e)){if(e["field"]){this.setField(e["field"])}if(e["operator"]){this.setOperator(e["operator"])}if("value"in e){this.setValue(e["value"])}}};T.prototype={setField:function(e){if(t.type.isNotEmptyString(e)){this.field=e}},setOperator:function(t){if(!t){t="="}this.operator=t},setValue:function(t){this.value=t;if(this.operator==="="&&this.value===""){this.operator="empty"}else if(this.operator==="!="&&this.value===""){this.operator="!empty"}},serialize:function(){var t=this.operator;var e=this.value;return{field:this.field,operator:t,value:e}}};var b=function(e){this.type=b.Type.Field;this.items=[];if(t.type.isPlainObject(e)){if(e["type"]){this.type=e["type"]}if(t.type.isArray(e["items"])){var i=this;e["items"].forEach(function(t){var e=new T(t[0]);i.addItem(e,t[1])})}}};b.Type={Field:"field"};b.Joiner={And:"AND",Or:"OR"};b.prototype={addItem:function(t,e){this.items.push([t,e])},serialize:function(){var t=[];this.items.forEach(function(e){if(e.field!==""){t.push([e[0].serialize(),e[1]])}});return{type:this.type,items:t}}};var v=function(e,i){this.conditionGroup=e;this.fields=[];if(t.type.isPlainObject(i)){if(t.type.isArray(i.fields)){this.fields=i.fields}}};v.prototype={createNode:function(){var e=this,i=[],a=this.fields;this.conditionGroup.items.forEach(function(t){var e=new O(t[0],{fields:a});i.push(e.createNode())});i.push(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:"[+]",events:{click:function(){e.addItem(this)}}}));var o=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-wrapper"},children:i});return o},addItem:function(t){var e=new O(new T,{fields:this.fields});t.parentNode.insertBefore(e.createNode(),t)}};var O=function(e,i){this.condition=e;this.fields=[];if(t.type.isPlainObject(i)){if(t.type.isArray(i.fields)){this.fields=i.fields}}};O.prototype={createNode:function(){var e=this.fieldNode=t.create("input",{attrs:{type:"hidden",name:"condition_field[]",value:this.condition.field}});var i=this.operatorNode=t.create("input",{attrs:{type:"hidden",name:"condition_operator[]",value:this.condition.operator}});var a=this.valueNode=t.create("input",{attrs:{type:"hidden",name:"condition_value[]",value:this.condition.value}});var o=t.create("input",{attrs:{type:"hidden",name:"condition_joiner[]",value:b.Joiner.And}});var s=this.labelNode=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-wrapper"}});this.setLabelText();this.bindLabelNode();var n=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-remove"},events:{click:this.removeCondition.bind(this)}});this.node=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-wrapper"},children:[e,i,a,o,s,n]});return this.node},init:function(t){this.condition=t;this.setLabelText();this.bindLabelNode()},setLabelText:function(){if(!this.labelNode||!this.condition)return;t.cleanNode(this.labelNode);if(this.condition.field!==""){var e=this.getField(this.condition.field)||"?";var i=this.condition.value;if(i&&e["Type"]==="bool"){i=t.message(this.condition.value==="Y"?"BIZPROC_AUTOMATION_YES":"BIZPROC_AUTOMATION_NO")}else if(i&&e["Type"]==="select"&&e["Options"][this.condition.value]){i=e["Options"][this.condition.value]}this.labelNode.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:e.Name}));this.labelNode.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:this.getOperatorLabel(this.condition.operator)}));if(i){this.labelNode.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:i}))}}else{this.labelNode.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_EMPTY")}))}},bindLabelNode:function(){if(this.labelNode){t.bind(this.labelNode,"click",t.delegate(this.onLabelClick,this))}},onLabelClick:function(t){this.showPopup()},showPopup:function(){var e=this,i=this.filterFields();var a=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"}});for(var o=0;o<i.length;++o){a.appendChild(t.create("option",{props:{value:i[o]["Id"]},text:i[o]["Name"]}))}var s=this.getField(this.condition.field);if(!s)s=i[0];var n=this.condition.operator.indexOf("empty")<0?this.createValueNode(s):null;var r=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[n]});var l=this.createOperatorNode(s,r);var p=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[l]});if(this.condition.field!==""){a.value=this.condition.field;l.value=this.condition.operator;if(n){n.value=this.condition.value}}var d=t.create("form",{attrs:{className:"bizproc-automation-popup-select-block"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[a]}),p,r]});t.bind(a,"change",this.onFieldChange.bind(this,a,p,r));var c=new t.PopupWindow("bizproc-automation-popup-set",this.labelNode,{className:"bizproc-automation-popup-set",autoHide:true,closeByEsc:true,closeIcon:false,titleBar:false,zIndex:0,angle:true,offsetLeft:45,content:d,buttons:[new t.PopupWindowButton({text:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE"),className:"webform-button webform-button-create",events:{click:function(){e.condition.setField(a.value);e.condition.setOperator(p.firstChild.value);if(r.firstChild){e.condition.setValue(r.firstChild.value)}else{e.condition.setValue("")}e.setLabelText();e.updateValueNodes();this.popupWindow.close()}}})],overlay:{backgroundColor:"transparent"}});c.show()},updateValueNodes:function(){if(this.condition){if(this.fieldNode){this.fieldNode.value=this.condition.field}if(this.operatorNode){this.operatorNode.value=this.condition.operator}if(this.valueNode){this.valueNode.value=this.condition.value}}},onFieldChange:function(t,e,i){var a=this.getField(t.value);var o=this.createOperatorNode(a,i);e.replaceChild(o,e.firstChild);this.onOperatorChange(o,a,i)},onOperatorChange:function(e,i,a){t.cleanNode(a);if(e.value.indexOf("empty")<0){var o=this.createValueNode(i);a.appendChild(o)}},getField:function(t){var e=null;for(var i=0;i<this.fields.length;++i){if(t===this.fields[i].Id){e=this.fields[i]}}return e},getOperators:function(e){var i;switch(e){case"bool":case"select":i={"!empty":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_EMPTY"),empty:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_EMPTY"),"=":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_EQ"),"!=":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NE")};break;case"date":case"datetime":i={"!empty":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_EMPTY"),empty:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_EMPTY")};break;default:i={"!empty":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_EMPTY"),empty:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_EMPTY"),"=":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_EQ"),">":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_GT"),">=":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_GTE"),"<":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_LT"),"<=":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_LTE"),"!=":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NE"),in:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_IN"),contain:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_CONTAIN")}}return i},getOperatorLabel:function(t){return this.getOperators()[t]},filterFields:function(){var t,e,i=[];for(t=0;t<this.fields.length;++t){e=this.fields[t]["Type"];if(e=="bool"||e=="date"||e=="datetime"||e=="double"||e=="int"||e=="select"||e=="string"||e=="text"){i.push(this.fields[t])}}return i},createValueNode:function(e){var i;switch(e["Type"]){case"bool":i=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},children:[t.create("option",{props:{value:"Y"},text:t.message("BIZPROC_AUTOMATION_YES")}),t.create("option",{props:{value:"N"},text:t.message("BIZPROC_AUTOMATION_NO")})]});break;case"select":i=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"}});var a=e["Options"];for(var o in a){if(!a.hasOwnProperty(o))continue;i.appendChild(t.create("option",{props:{value:o},text:a[o]}))}break;default:i=t.create("input",{attrs:{className:"bizproc-automation-popup-input",type:"text"}})}return i},createOperatorNode:function(e,i){var a=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"}});var o=this.getOperators(e["Type"]);for(var s in o){if(!o.hasOwnProperty(s))continue;a.appendChild(t.create("option",{props:{value:s},text:o[s]}))}t.bind(a,"change",this.onOperatorChange.bind(this,a,e,i));return a},removeCondition:function(e){this.condition=null;t.remove(this.node);this.labelNode=this.fieldNode=this.operatorNode=this.valueNode=this.node=null;e.stopPropagation()}};var I=function(e,i,a){var o=i,s;if(e.type==g.Type.In){o=t.message("BIZPROC_AUTOMATION_CMP_IN_TIME");if(t.type.isArray(a)){for(var n=0;n<a.length;++n){if(e.basis==a[n].SystemExpression){o+=" "+a[n].Name;break}}}}else if(e.value){s=e.type==g.Type.After?t.message("BIZPROC_AUTOMATION_CMP_THROUGH"):t.message("BIZPROC_AUTOMATION_CMP_FOR_TIME");o=s+" "+N(e.value,e.valueType);if(t.type.isArray(a)){for(var n=0;n<a.length;++n){if(e.basis==a[n].SystemExpression){o+=" "+t.message("BIZPROC_AUTOMATION_CMP_BEFORE")+" "+a[n].Name;break}}}}if(e.workTime){o+=", "+t.message("BIZPROC_AUTOMATION_CMP_IN_WORKTIME")}return o};var _=function(e){var i=[];if(e==="i")i=[t.message("BIZPROC_AUTOMATION_CMP_MIN1"),t.message("BIZPROC_AUTOMATION_CMP_MIN2"),t.message("BIZPROC_AUTOMATION_CMP_MIN3")];else if(e==="h")i=[t.message("BIZPROC_AUTOMATION_CMP_HOUR1"),t.message("BIZPROC_AUTOMATION_CMP_HOUR2"),t.message("BIZPROC_AUTOMATION_CMP_HOUR3")];else if(e==="d")i=[t.message("BIZPROC_AUTOMATION_CMP_DAY1"),t.message("BIZPROC_AUTOMATION_CMP_DAY2"),t.message("BIZPROC_AUTOMATION_CMP_DAY3")];return i};var N=function(t,e){var i=t+" ";var a=0;if(t>20)t=t%10;if(t==1)a=0;else if(t>1&&t<5)a=1;else a=2;var o=_(e);return i+(o?o[a]:"")};var C={popupHint:null,bindToNode:function(e){t.bind(e,"mouseover",t.proxy(function(){this.showHint(t.proxy_context)},this));t.bind(e,"mouseout",t.delegate(this.hideHint,this))},showHint:function(e){var i=e.getAttribute("data-text");if(!i)return;var a=t.util.htmlspecialchars(i);a=t.util.nl2br(a);if(!t.type.isNotEmptyString(a))return;this.popupHint=new t.PopupWindow("bizproc-automation-help-tip",e,{lightShadow:true,autoHide:false,darkMode:true,offsetLeft:0,offsetTop:2,bindOptions:{position:"top"},zIndex:1100,events:{onPopupClose:function(){this.destroy()}},content:t.create("div",{attrs:{style:"padding-right: 5px; width: 250px;"},html:a})});this.popupHint.setAngle({offset:32,position:"bottom"});this.popupHint.show();return true},hideHint:function(){if(this.popupHint)this.popupHint.close();this.popupHint=null}};t.Bizproc.Automation.Component=e;t.Bizproc.Automation.Designer=f})(window.BX||window.top.BX);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:100:"/bitrix/components/bitrix/bizproc.automation/templates/.default/disk_uploader.min.js?154412738718192";s:6:"source";s:80:"/bitrix/components/bitrix/bizproc.automation/templates/.default/disk_uploader.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
if(!BX.getClass("BX.Bizproc.Automation.DiskUploader"))(function(e){"use strict";e.namespace("BX.Bizproc.Automation");var t=function(){this._id="";this._settings={};this._messages={};this._agent=null;this._form=this._wrapper=this._switchContainer=this._container=this._fileInput=this._fileSelector=this._label=this._dropZoneWrapper=this._dropZone=this._itemContainer=null;this._mode=t.InterfaceMode.edit;this._items=[];this._fileUploadStartHandler=e.delegate(this._onFileUploadStart,this);this._fileUploadProgressHandler=e.delegate(this._onFileUploadProgress,this);this._fileUploadCompleteHandler=e.delegate(this._onFileUploadComplete,this);this._fileUploadErrorHandler=e.delegate(this._onFileUploadError,this);this._fileSelectButtonClickHandler=e.delegate(this._onFileSelectButtonClick,this);this._fileDialogInitHandler=e.delegate(this._onFileDialogInit,this);this._dropZoneMouseOverHandler=e.delegate(this._onDropZoneMouseOver,this);this._dropZoneMouseOutHandler=e.delegate(this._onDropZoneMouseOut,this);this._agentErrorHandler=e.delegate(this._onAgentError,this);this._agentFileInputReinitHandler=e.delegate(this._onAgentFileInputReinit,this);this._agentFileInitHandler=e.delegate(this._onAgentFileInit,this);this._uploadFileUrl="/bitrix/tools/disk/uf.php?action=uploadfile";this._selectFileUrl="/bitrix/tools/disk/uf.php?action=selectFile";this._isShown=false;this._hasLayout=false};t.InterfaceMode={edit:1,view:2};t.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._messages=this.getSetting("msg",{})},getId:function(){return this._id},getSetting:function(e,t){return typeof this._settings[e]!="undefined"?this._settings[e]:t},getMessages:function(){return this.getSetting("msg",{})},getMessage:function(e,t){if(typeof t==="undefined"){t=""}return this._messages.hasOwnProperty(e)?this._messages[e]:t},getFileInputName:function(){return this._fileInput},getPlaceHolder:function(){return this._itemContainer},getMode:function(){return this._mode},setMode:function(e){if(this._mode===e){return}if(this._hasLayout){throw"Could not set mode while control has layout."}this._mode=e},getAgent:function(){return this._agent},getItems:function(){return this._items},getItem:function(e){for(var t=0;t<this._items.length;t++){var i=this._items[t];if(i.getId()===e){return i}}return null},hasItems:function(){return this._items.length>0},getFileIds:function(){var e=[];for(var t=0;t<this._items.length;t++){var i=this._items[t].getFileId();if(i>0){e.push(i)}}return e},getValues:function(){return this.getFileIds()},setValues:function(t){for(var i=0;i<t.length;i++){var s=t[i];var a=typeof s["ID"]!=="undefined"?parseInt(s["ID"]):0;var r=this.addItem(a.toString(),{fileId:a,name:s["NAME"],size:s["SIZE"],viewUrl:e.type.isNotEmptyString(s["VIEW_URL"])?s["VIEW_URL"]:"",progress:100});if(this._hasLayout){r.setContainer(this._itemContainer);r.layout()}}if(this.hasItems()){this.show(true)}},clearValues:function(){this.removeAllItems()},removeItem:function(e){for(var t=0;t<this._items.length;t++){if(this._items[t]===e){e.cleanLayout();this._items.splice(t,1);return}}},removeAllItems:function(){for(var e=0;e<this._items.length;e++){this._items[e].cleanLayout()}this._items=[]},layout:function(i){var s=this._mode;if(s===t.InterfaceMode.edit){this.prepareEditLayout(i);this._agent=e.Uploader.getInstance({id:this._id,allowUpload:"A",uploadMethod:"immediate",uploadFileUrl:this._uploadFileUrl,deleteFileOnServer:true,filesInputMultiple:true,filesInputName:this.getFileInputName(),input:this._fileInput,dropZone:this._dropZone,showImage:false,fields:{preview:{params:{width:212,height:119}}}});e.addCustomEvent(this._agent,"onError",this._agentErrorHandler);e.addCustomEvent(this._agent,"onFileinputIsReinited",this._agentFileInputReinitHandler);e.addCustomEvent(this._agent,"onFileIsInited",this._agentFileInitHandler);this._container.style.display=this._isShown?"block":"none";this._switchContainer.style.display=this._isShown?"none":"block";this._label.style.display=this.hasItems()?"":"none"}else if(s===t.InterfaceMode.view){this._prepareViewLayout(i)}for(var a=0;a<this._items.length;a++){var r=this._items[a];r.setContainer(this._itemContainer);r.layout()}this._hasLayout=true},cleanLayout:function(){if(!this._hasLayout){return}if(this._agent){e.removeCustomEvent(this._agent,"onError",this._agentErrorHandler);e.removeCustomEvent(this._agent,"onFileinputIsReinited",this._agentFileInputReinitHandler);e.removeCustomEvent(this._agent,"onFileIsInited",this._agentFileInitHandler)}if(this._dropZoneWrapper){e.unbind(this._dropZoneWrapper,"mouseover",this._dropZoneMouseOverHandler);e.unbind(this._dropZoneWrapper,"mouseout",this._dropZoneMouseOutHandler)}if(this._fileSelector){e.unbind(this._fileSelector,"click",this._fileSelectButtonClickHandler)}if(this._wrapper){e.cleanNode(this._wrapper,true)}for(var t=0;t<this._items.length;t++){var i=this._items[t];i.cleanLayout();i.setContainer(null)}this._form=this._wrapper=this._switchContainer=this._container=this._fileInput=this._label=this._dropZone=this._itemContainer=null;this._hasLayout=false},show:function(e){e=!!e;if(this._isShown===e){return}this._isShown=e;if(this._hasLayout){this._container.style.display=e?"block":"none";this._switchContainer.style.display=e?"none":"block"}},showLabel:function(e){if(this._hasLayout){this._label.style.display=!!e?"":"none"}},prepareEditLayout:function(t){if(!e.type.isElementNode(t)){return}this._form=e.create("FORM",{});t.appendChild(this._form);this._form.appendChild(e.create("INPUT",{props:{type:"hidden",name:"sessid",value:e.bitrix_sessid()}}));this._switchContainer=e.create("DIV",{attrs:{className:"bx-crm-add-file-link"},children:[e.create("SPAN",{attrs:{className:"bx-crm-add-file-link-text"},text:this.getMessage("diskAttachFiles"),events:{click:e.delegate(this._onSwitchButtonClick,this)}})]});this._form.appendChild(this._switchContainer);this._container=e.create("DIV",{attrs:{className:"bx-crm-dialog-activity-diskuf-container"}});this._form.appendChild(this._container);this._container.style.height="auto";this._innerContainer=e.create("DIV",{attrs:{className:"bx-crm-dialog-activity-diskuf-container-inner"}});this._container.appendChild(this._innerContainer);this._wrapper=e.create("DIV",{attrs:{className:"diskuf-selectdialog"}});this._innerContainer.appendChild(this._wrapper);this._wrapper.style.display="block";this._wrapper.style.opacity="1";var i=e.create("DIV",{attrs:{className:"diskuf-files-block"}});i.style.display="block";this._wrapper.appendChild(i);this._label=e.create("DIV",{attrs:{className:"diskuf-label"},children:[e.create("SPAN",{text:this.getMessage("diskAttachedFiles")+":"}),e.create("SPAN",{attrs:{className:"diskuf-label-icon"}})]});i.appendChild(this._label);var s=e.create("DIV",{attrs:{className:"diskuf-placeholder"}});i.appendChild(s);this._itemContainer=e.create("TABLE",{attrs:{className:"files-list",cellspacing:"0",cellpadding:"0",border:"0"}});s.appendChild(this._itemContainer);var a=e.create("DIV",{attrs:{className:"diskuf-extended"}});a.style.display="block";this._wrapper.appendChild(a);var r=e.create("TABLE",{attrs:{className:"diskuf-selector-table wd-fa-add-file-light-table",cellspacing:"0",cellpadding:"0",border:"0"}});a.appendChild(r);var n=r.insertRow(-1);var l=n.insertCell(-1);l.className="wd-fa-add-file-light-cell";this._fileSelector=e.create("DIV",{attrs:{className:"wd-fa-add-file-light-title-text diskuf-selector-link"},text:this.getMessage("diskSelectFile")});e.bind(this._fileSelector,"click",this._fileSelectButtonClickHandler);l.appendChild(e.create("SPAN",{attrs:{className:"wd-fa-add-file-light"},children:[e.create("SPAN",{attrs:{className:"wd-fa-add-file-light-text"},children:[e.create("SPAN",{attrs:{className:"wd-fa-add-file-light-title"},children:[this._fileSelector]}),e.create("SPAN",{attrs:{className:"wd-fa-add-file-light-descript"},text:this.getMessage("diskSelectFileLegend")})]})]}));l=n.insertCell(-1);l.className="wd-fa-add-file-form-light-separate-cell";l.appendChild(e.create("DIV",{attrs:{className:"wd-fa-add-file-form-light-spacer"}}));l=this._dropZoneWrapper=n.insertCell(-1);l.className="diskuf-selector wd-fa-add-file-light-cell wd-fa-add-file-from-main";this._fileInput=e.create("INPUT",{attrs:{className:"diskuf-fileUploader wd-test-file-light-inp "},props:{type:"file",size:1,multiple:"multiple",name:this.getFileInputName()}});if(e.browser.IsIE()){this._dropZone=e.create("DIV",{attrs:{className:"wduf-selector"},children:[e.create("SPAN",{attrs:{className:"wduf-uploader"},children:[e.create("SPAN",{attrs:{className:"wduf-uploader-left"}}),e.create("SPAN",{attrs:{className:"wduf-but-text"},text:this.getMessage("loadFiles")}),e.create("SPAN",{attrs:{className:"wduf-uploader-right"}}),this._fileInput]})]})}else{this._dropZone=e.create("DIV",{attrs:{className:"diskuf-uploader"},children:[e.create("SPAN",{attrs:{className:"wd-fa-add-file-light"},children:[e.create("SPAN",{attrs:{className:"wd-fa-add-file-light-text"},children:[e.create("SPAN",{attrs:{className:"wd-fa-add-file-light-title"},children:[e.create("SPAN",{attrs:{className:"wd-fa-add-file-light-title-text"},text:this.getMessage("diskUploadFile")})]}),e.create("SPAN",{attrs:{className:"wd-fa-add-file-light-descript"},text:this.getMessage("diskUploadFileLegend")})]})]}),this._fileInput]})}l.appendChild(this._dropZone);e.bind(l,"mouseover",this._dropZoneMouseOverHandler);e.bind(l,"mouseout",this._dropZoneMouseOutHandler)},_prepareViewLayout:function(t){if(!e.type.isElementNode(t)){return}this._form=e.create("FORM",{});t.appendChild(this._form);this._form.appendChild(e.create("INPUT",{props:{type:"hidden",name:"sessid",value:e.bitrix_sessid()}}));this._container=e.create("DIV",{attrs:{className:"bx-crm-dialog-activity-diskuf-container"}});this._form.appendChild(this._container);this._container.style.height="auto";this._innerContainer=e.create("DIV",{attrs:{className:"bx-crm-dialog-activity-diskuf-container-inner"}});this._container.appendChild(this._innerContainer);this._wrapper=e.create("DIV",{attrs:{className:"diskuf-selectdialog"}});this._innerContainer.appendChild(this._wrapper);this._wrapper.style.display="block";this._wrapper.style.opacity="1";var i=e.create("DIV",{attrs:{className:"diskuf-files-block"}});i.style.display="block";this._wrapper.appendChild(i);this._label=e.create("DIV",{attrs:{className:"diskuf-label"},children:[e.create("SPAN",{text:this.getMessage("diskAttachedFiles")+":"}),e.create("SPAN",{attrs:{className:"diskuf-label-icon"}})]});i.appendChild(this._label);var s=e.create("DIV",{attrs:{className:"diskuf-placeholder"}});i.appendChild(s);this._itemContainer=e.create("TABLE",{attrs:{className:"files-list",cellspacing:"0",cellpadding:"0",border:"0"}});s.appendChild(this._itemContainer)},processItemDeletion:function(e){this.removeItem(e);if(!this.hasItems()){this.showLabel(false)}},_onSwitchButtonClick:function(t){this.show(true);return e.PreventDefault(t)},_onAgentFileInputReinit:function(e){if(e||this._agent.fileInput){this._fileInput=e?e:this._agent.fileInput}},_onAgentError:function(e,t,i){},_onAgentFileInit:function(t,i,s){e.addCustomEvent(i,"onUploadStart",this._fileUploadStartHandler);e.addCustomEvent(i,"onUploadProgress",this._fileUploadProgressHandler);e.addCustomEvent(i,"onUploadDone",this._fileUploadCompleteHandler);e.addCustomEvent(i,"onUploadError",this._fileUploadErrorHandler)},addItem:function(t,s){var a=i.create(t,{uploader:this,container:this._itemContainer,name:e.type.isNotEmptyString(s.name)?s.name:"",size:e.type.isNotEmptyString(s.size)?s.size:"",fileId:e.type.isNumber(s.fileId)?s.fileId:0,viewUrl:e.type.isNotEmptyString(s.viewUrl)?s.viewUrl:"",progress:e.type.isNumber(s.progress)?s.progress:0});this._items.push(a);return a},_onFileUploadStart:function(e,t,i,s){var a=this.addItem(e.id,{name:e.name,size:e.size,fileId:0,progress:parseInt(t)});a.layout()},_onFileUploadProgress:function(e,t,i,s){var a=this.getItem(e.id);if(a){if(t>=100)t=99;a.setProgress(t)}},_onFileUploadComplete:function(t,i,s,a){var r=this.getItem(t.id);if(!r){return}r.setProgress(100);e.removeCustomEvent(t,"onUploadStart",this._fileUploadStartHandler);e.removeCustomEvent(t,"onUploadProgress",this._fileUploadProgressHandler);e.removeCustomEvent(t,"onUploadDone",this._fileUploadCompleteHandler);e.removeCustomEvent(t,"onUploadError",this._fileUploadErrorHandler);var n=0;if(typeof i.file!=="undefined"){if(typeof i.file["fileId"]!=="undefined"){n=parseInt(i.file["fileId"])}else if(typeof i.file["originalId"]!=="undefined"){n=parseInt(i.file["originalId"])}}if(n>0){r.setFileId(n)}this.showLabel(true)},_onFileUploadError:function(t,i,s,a){var r=this.getItem(t.id);if(r){r.remove()}e.removeCustomEvent(t,"onUploadStart",this._fileUploadStartHandler);e.removeCustomEvent(t,"onUploadProgress",this._fileUploadProgressHandler);e.removeCustomEvent(t,"onUploadDone",this._fileUploadCompleteHandler);e.removeCustomEvent(t,"onUploadError",this._fileUploadErrorHandler)},_onFileSelectButtonClick:function(t){e.addCustomEvent(e.DiskFileDialog,"inited",this._fileDialogInitHandler);e.ajax({url:this._selectFileUrl,method:"GET",timeout:30});return e.PreventDefault(t)},_onFileDialogInit:function(t){e.removeCustomEvent(e.DiskFileDialog,"inited",this._fileDialogInitHandler);this.flagFileDialogInited=true;e.DiskFileDialog.obCallback[t]={saveButton:e.delegate(this._onFileSelect,this)};e.DiskFileDialog.openDialog(t)},_onFileSelect:function(t,i,s){for(var a in s){if(!s.hasOwnProperty(a)){return}var r=s[a];var n=e.type.isNotEmptyString(r["type"])?r["type"]:"";if(n!=="file"){continue}var l=e.type.isNotEmptyString(r["id"])?r["id"]:"";if(l===""){continue}var o=/^n(\d+)$/;var d=o.exec(l);if(d&&d.length>1){var h=parseInt(d[1]);if(h>0){var p=e.type.isNotEmptyString(r["name"])?r["name"]:l;var c=e.type.isNotEmptyString(r["size"])?r["size"]:0;this.addItem(l,{fileId:h,name:p,size:c,progress:100}).layout()}}}},_onDropZoneMouseOver:function(t){e.addClass(this._dropZoneWrapper,"wd-fa-add-file-light-hover")},_onDropZoneMouseOut:function(t){e.removeClass(this._dropZoneWrapper,"wd-fa-add-file-light-hover")}};t.items={};t.create=function(i,s){if(!e.type.isNotEmptyString(i)){i="BX_BP_ATM_FILEUPLOADER_"+Math.random()}var a=new t;a.initialize(i,s);this.items[i]=a;return a};var i=function(){this._id="";this._settings={};this._fileId=0;this._name="";this._size="";this._viewUrl="";this._progress=0;this._uploader=this._container=this._wrapper=null;this._progressContainer=this._progressWrap=this._progressTerminateBtn=this._progressBar=this._progressText=this._deleteButton=null;this._deleteButtonClickHandler=e.delegate(this._onDeleteButtonClick,this);this._hasLayout=false};i.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._uploader=this.getSetting("uploader");this._container=this.getSetting("container");this._fileId=parseInt(this.getSetting("fileId",0));this._name=this.getSetting("name","");this._size=this.getSetting("size","");this._viewUrl=this.getSetting("viewUrl","");this.setProgress(this.getSetting("progress",0))},getId:function(){return this._id},getSetting:function(e,t){return typeof this._settings[e]!="undefined"?this._settings[e]:t},getFileId:function(){return this._fileId},setFileId:function(e){this._fileId=e},getName:function(){return this._name},getSize:function(){return this._size},getProgress:function(){return this._progress},setProgress:function(e){e=parseInt(e);if(isNaN(e)||e<0){e=0}if(e>100){e=100}if(this._progress===e){return}this._progress=e;if(this._hasLayout){this._progressBar.style.width=this._progress+"%";this._progressText.innerHTML=this._progress+"%";this._progressWrap.style.display=e<100?"":"none"}},getContainer:function(){return this._container},setContainer:function(e){this._container=e},layout:function(){if(this._hasLayout){return}if(!this._container){throw"Error: Could not find container."}var i=this._wrapper=this._container.insertRow(-1);var s=i.insertCell(-1);s.className="files-name";if(this._viewUrl!==""){s.appendChild(e.create("A",{attrs:{className:"files-text",href:this._viewUrl},text:this._name}))}else{s.appendChild(e.create("SPAN",{attrs:{className:"files-text"},text:this._name}))}s=i.insertCell(-1);s.className="files-size";s.innerHTML=this._size;s=this._progressContainer=i.insertCell(-1);s.className="files-storage";this._progressWrap=e.create("SPAN",{attrs:{className:"feed-add-post-loading-wrap"}});s.appendChild(this._progressWrap);this._progressTerminateBtn=e.create("SPAN",{attrs:{className:"feed-add-post-loading-cancel del-but"}});e.bind(this._progressTerminateBtn,"click",this._deleteButtonClickHandler);this._progressWrap.appendChild(e.create("SPAN",{attrs:{className:"feed-add-post-loading"},children:[this._progressTerminateBtn]}));this._progressBar=e.create("SPAN",{attrs:{className:"feed-add-post-load-indicator"},style:{width:this._progress+"%"}});this._progressWrap.appendChild(this._progressBar);this._progressText=e.create("SPAN",{attrs:{className:"feed-add-post-load-number"},text:this._progress+"%"});this._progressBar.appendChild(this._progressText);if(this._progress===100){this._progressWrap.style.display="none"}s=i.insertCell(-1);s.className="files-del-btn";if(this._uploader.getMode()===t.InterfaceMode.edit){this._deleteButton=e.create("SPAN",{attrs:{className:"del-but"}});e.bind(this._deleteButton,"click",this._deleteButtonClickHandler);s.appendChild(this._deleteButton)}this._hasLayout=true},cleanLayout:function(){if(!this._hasLayout){return}e.unbind(this._progressTerminateBtn,"click",this._deleteButtonClickHandler);if(this._deleteButton){e.unbind(this._deleteButton,"click",this._deleteButtonClickHandler)}this._container.deleteRow(this._wrapper.rowIndex);this._wrapper=this._progressContainer=this._progressWrap=this._progressTerminateBtn=this._progressBar=this._progressText=this._deleteButton=null;this._hasLayout=false},remove:function(){if(this._uploader.getMode()!==t.InterfaceMode.edit){return}var e=this._uploader.getAgent();if(e){var i=e.queue.items.getItem(this._id);if(i){i.deleteFile()}}this._uploader.processItemDeletion(this)},_onDeleteButtonClick:function(e){this.remove()}};i.create=function(e,t){var s=new i;s.initialize(e,t);return s};e.Bizproc.Automation.DiskUploader=t})(window.BX||window.top.BX);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:88:"/bitrix/components/bitrix/ui.button.panel/templates/.default/script.min.js?1544127465770";s:6:"source";s:70:"/bitrix/components/bitrix/ui.button.panel/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.UI");var t=function(){};t.prototype={init:function(t){t=t||{};this.context=BX("ui-button-panel");this.isFrame=t.isFrame||false;this.hasHints=t.hasHints||false;this.pinner=new BX.UI.Pinner(this.context,{fixBottom:this.isFrame,fullWidth:this.isFrame});if(this.hasHints){BX.UI.Hint.init(this.context)}t.buttons.forEach(this.initButton,this)},initButton:function(t){if(!t.ID){return}t.node=BX(t.ID);if(!t.node){return}BX.bind(t.node,"click",this.onButtonClick.bind(this,t))},onButtonClick:function(t,i){BX.onCustomEvent(this,"button-click",[t]);if(t.WAIT){BX.addClass(BX(t.ID),"ui-btn-wait")}if(this.isFrame&&(t.TYPE==="close"||t.TYPE==="cancel")){i.preventDefault();top.BX.SidePanel.Instance.close()}}};BX.UI.ButtonPanel=new t})();
/* End */
;; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?154412738440309*/
; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js?1544127384575*/
; /* /bitrix/components/bitrix/bizproc.automation/templates/.default/script.min.js?154412738799148*/
; /* /bitrix/components/bitrix/bizproc.automation/templates/.default/disk_uploader.min.js?154412738718192*/
; /* /bitrix/components/bitrix/ui.button.panel/templates/.default/script.min.js?1544127465770*/

//# sourceMappingURL=page_93f561c590be2da5db41fa76cfe69c57.map.js