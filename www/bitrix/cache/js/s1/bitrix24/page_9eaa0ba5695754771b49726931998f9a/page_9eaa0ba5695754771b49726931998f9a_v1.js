
; /* Start:"a:4:{s:4:"full";s:97:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?154412738440309";s:6:"source";s:77:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Main");if(typeof BX.Main.interfaceButtons==="undefined"){BX.Main.interfaceButtons=function(t,e){this.classItem="main-buttons-item";this.classItemSublink="main-buttons-item-sublink";this.classItemText="main-buttons-item-text";this.classItemCounter="main-buttons-item-counter";this.classItemIcon="main-buttons-item-icon";this.classItemMore="main-buttons-item-more";this.classOnDrag="main-buttons-drag";this.classDropzone="main-buttons-submenu-dropzone";this.classSeporator="main-buttons-submenu-separator";this.classHiddenLabel="main-buttons-hidden-label";this.classSubmenuItem="main-buttons-submenu-item";this.classItemDisabled="main-buttons-disabled";this.classItemOver="over";this.classItemActive="main-buttons-item-active";this.classSubmenu="main-buttons-submenu";this.classSecret="secret";this.classItemLocked="locked";this.submenuIdPrefix="main_buttons_popup_";this.childMenuIdPrefix="main_buttons_popup_child_";this.submenuWindowIdPrefix="menu-popup-";this.classSettingMenuItem="main-buttons-submenu-setting";this.classEditState="main-buttons-edit";this.classEditItemButton="main-buttons-item-edit-button";this.classDragItemButton="main-buttons-item-drag-button";this.classSettingsApplyButton="main-buttons-submenu-settings-apply";this.classSettingsResetButton="main-buttons-submenu-settings-reset";this.classSetHome="main-buttons-set-home";this.classSetHide="main-buttons-set-hide";this.classManage="main-buttons-manage";this.classContainer="main-buttons";this.classSubmenuNoHiddenItem="main-buttons-submenu-item-no-hidden";this.classDefaultSubmenuItem="menu-popup-item";this.classInner="main-buttons-inner-container";this.listContainer=null;this.pinContainer=null;this.dragItem=null;this.overItem=null;this.moreButton=null;this.messages=null;this.licenseParams=null;this.isSubmenuShown=false;this.isSubmenuShownOnDragStart=false;this.isSettingsEnabled=true;this.containerId=e.containerId;this.tmp={};this.init(t,e);return{getItemById:BX.delegate(this.getItemById,this),getAllItems:BX.delegate(this.getAllItems,this),getHiddenItems:BX.delegate(this.getHiddenItems,this),getVisibleItems:BX.delegate(this.getVisibleItems,this),getDisabledItems:BX.delegate(this.getDisabledItems,this),getMoreButton:BX.delegate(this.getMoreButton,this),adjustMoreButtonPosition:BX.delegate(this.adjustMoreButtonPosition,this),showSubmenu:BX.delegate(this.showSubmenu,this),closeSubmenu:BX.delegate(this.closeSubmenu,this),refreshSubmenu:BX.delegate(this.refreshSubmenu,this),getCurrentSettings:BX.delegate(this.getCurrentSettings,this),saveSettings:BX.delegate(this.saveSettings,this),setCounterValueByItemId:BX.delegate(this.setCounterValueByItemId,this),getCounterValueByItemId:BX.delegate(this.getCounterValueByItemId,this),updateCounter:BX.delegate(this.updateCounter,this),getActive:BX.delegate(this.getActive,this),isEditEnabled:BX.delegate(this.isEditEnabled,this),isActiveInMoreMenu:BX.delegate(this.isActiveInMoreMenu,this),isSettingsEnabled:this.isSettingsEnabled,classes:{item:this.classItem,itemText:this.classItemText,itemCounter:this.classItemCounter,itemIcon:this.classItemIcon,itemDisabled:this.classItemDisabled,itemOver:this.classItemOver,itemActive:this.classItemActive,itemLocked:this.classItemLocked,submenu:this.classSubmenu,submenuItem:this.classSubmenuItem,containerOnDrag:this.classOnDrag,classSettingMenuItem:this.classSettingMenuItem},itemsContainer:this.listContainer,itemsContainerId:this.listContainer.id}};BX.Main.interfaceButtons.prototype={init:function(t,e){this.listContainer=BX(this.getId());if(!BX.type.isPlainObject(e)){throw"BX.MainButtons: params is not Object"}if(!("containerId"in e)||!BX.type.isNotEmptyString(e.containerId)){throw"BX.MainButtons: containerId not set in params"}if(!BX.type.isDomNode(this.listContainer)){throw"BX.MainButtons: #"+e.containerId+" is not dom node"}if("classes"in e&&BX.type.isPlainObject(e.classes)){this.setCustomClasses(e.classes)}if("messages"in e&&BX.type.isPlainObject(e.messages)){this.setMessages(e.messages)}if("licenseWindow"in e&&BX.type.isPlainObject(e.licenseWindow)){this.setLicenseWindowParams(e.licenseWindow)}if("disableSettings"in e&&e.disableSettings==="true"){this.isSettingsEnabled=false;this.visibleControlMoreButton()}this.moreButton=this.getMoreButton();this.listChildItems={};if(this.isSettingsEnabled){this.dragAndDropInit()}this.adjustMoreButtonPosition();this.bindOnClickOnMoreButton();this.bindOnScrollWindow();this.setContainerHeight();BX.bind(this.getContainer(),"click",BX.delegate(this._onDocumentClick,this));BX.addCustomEvent("onPullEvent-main",BX.delegate(this._onPush,this));this.updateMoreButtonCounter();if(this.isActiveInMoreMenu()){this.activateItem(this.moreButton)}var i=this.getVisibleItems();var s=BX.type.isArray(i)&&i.length>0?i[0]:null;var n=BX.Buttons.Utils.getByTag(s,"a");if(!BX.type.isDomNode(n)){return}var a=n.getAttribute("href");if(a.charAt(0)==="?"){a=n.pathname+n.search}if(!this.lastHomeLink){this.lastHomeLink=a}this.bindOnResizeFrame()},_onDocumentClick:function(t){var e=this.getItem(t);var i,s,n,a,o,u;if(this.isDragButton(t.target)){t.preventDefault();t.stopPropagation()}if(BX.type.isDomNode(e)){if(this.isSettings(e)){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton());return false}if(this.isApplySettingsButton(e)){t.preventDefault();t.stopPropagation();this.disableEdit();BX.show(this.getSettingsButton());BX.hide(this.getSettingsApplyButton());return false}if(this.isResetSettingsButton(e)){this.resetSettings();return false}if(this.isLocked(e)){t.preventDefault();this.showLicenseWindow();return false}if(this.isEditButton(t.target)){var r,h;t.preventDefault();t.stopPropagation();if(this.isSubmenuItem(e)){e=this.getItemAlias(e)}try{r=JSON.parse(BX.data(e,"item"))}catch(t){}h=this.getItemEditMenu();if(h&&h.popupWindow.isShown()&&this.lastEditNode===e){h.popupWindow.close()}else{this.showItemEditMenu(r,t.target)}this.lastEditNode=e;return false}if(this.isSetHide(e)){o=this.getVisibleItems();u=BX.type.isArray(o)?o.length:null;a=this.editItemData.ID.replace(this.listContainer.id+"_","");s=this.getItemById(a);n=this.getItemAlias(s);s=this.isVisibleItem(s)?s:n;if(this.isDisabled(n)){this.enableItem(n)}else if(!this.isDisabled(n)&&u>2){this.disableItem(n)}if(u===2){BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[s,this])}this.refreshSubmenu();this.saveSettings();this.adjustMoreButtonPosition();if(this.isEditEnabled()){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton())}this.editMenu.popupWindow.close();return false}if(this.isSetHome(e)){a=this.editItemData.ID.replace(this.listContainer.id+"_","");s=this.getItemById(a);n=this.getItemAlias(s);if(this.isDisabled(n)){this.enableItem(n)}this.listContainer.insertBefore(s,BX.firstChild(this.listContainer));this.adjustMoreButtonPosition();this.refreshSubmenu();this.saveSettings();if(this.isEditEnabled()){this.enableEdit();BX.hide(this.getSettingsButton());BX.show(this.getSettingsApplyButton())}this.editMenu.popupWindow.close();return false}if(!this.isSublink(t.target)){i=this.dataValue(e,"onclick");if(BX.type.isNotEmptyString(i)){t.preventDefault();this.execScript(i)}}}if(this.isEditEnabled()){this.getSubmenu().popupWindow.setAutoHide(false)}},isActiveInMoreMenu:function(){var t=this.getHiddenItems();var e=this.getDisabledItems();var i=t.concat(e);return i.some(function(t){var e;try{e=JSON.parse(BX.data(t,"item"))}catch(t){}return BX.type.isPlainObject(e)&&("IS_ACTIVE"in e&&e.IS_ACTIVE===true||e.IS_ACTIVE==="true"||e.IS_ACTIVE==="Y")},this)},_onPush:function(t,e){if(t==="user_counter"&&e&&BX.message("SITE_ID")in e){var i=e[BX.message("SITE_ID")];for(var s in i){if(i.hasOwnProperty(s)){this.updateCounter(s,i[s])}}}},bindOnScrollWindow:function(){BX.bind(window,"scroll",BX.delegate(this._onScroll,this))},getActive:function(){var t=this.getAllItems();var e,i;var s=null;if(BX.type.isArray(t)){t.forEach(function(t){try{e=JSON.parse(BX.data(t,"item"))}catch(t){e=null}if(BX.type.isPlainObject(e)&&"IS_ACTIVE"in e&&(e.IS_ACTIVE===true||e.IS_ACTIVE==="true"||e.IS_ACTIVE==="Y")){s=e}},this)}if(BX.type.isPlainObject(s)){i=BX(s.ID);if(BX.type.isDomNode(i)){s.NODE=i}else{s.NODE=null}}return s},isSetHome:function(t){return BX.hasClass(t,this.classSetHome)},isSetHide:function(t){return BX.hasClass(t,this.classSetHide)},getSettingsButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingMenuItem)},getSettingsApplyButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingsApplyButton)},isApplySettingsButton:function(t){return BX.hasClass(t,this.classSettingsApplyButton)},enableEdit:function(){var t=this.getSubmenu();if(t&&"popupWindow"in t){t.popupWindow.setAutoHide(false)}BX.addClass(this.listContainer,this.classEditState);BX.addClass(this.getSubmenuContainer(),this.classEditState);this.isEditEnabledState=true},disableEdit:function(){var t=this.getSubmenu();if(t&&"popupWindow"in t){t.popupWindow.setAutoHide(true)}BX.removeClass(this.listContainer,this.classEditState);BX.removeClass(this.getSubmenuContainer(),this.classEditState);this.isEditEnabledState=false},isEditEnabled:function(){return this.isEditEnabledState},showItemEditMenu:function(t,e){if(BX.type.isPlainObject(t)&&"ID"in t){var i=[this.listContainer.id,"_edit_item"].join("");var s=BX.PopupMenu.getMenuById(i);if(s){BX.PopupMenu.destroy(i)}s=this.createItemEditMenu(t,i,e);s.popupWindow.show()}},getContainer:function(){if(!BX.type.isDomNode(this.container)){this.container=BX(this.containerId).parentNode}return this.container},getItemEditMenu:function(){return BX.PopupMenu.getMenuById([this.listContainer.id,"_edit_item"].join(""))},createItemEditMenu:function(t,e,i){var s;var n=[{text:this.message("MIB_SET_HOME"),className:"main-buttons-set-home menu-popup-no-icon"}];var a=t.ID.replace(this.listContainer.id+"_","");var o=this.getItemById(a);if(this.isDisabled(o)){n.push({text:this.message("MIB_SET_SHOW"),className:"main-buttons-set-hide menu-popup-no-icon"})}else{n.push({text:this.message("MIB_SET_HIDE"),className:"main-buttons-set-hide menu-popup-no-icon"})}var u=BX.pos(i);var r={menuId:e,anchor:i,menuItems:n,settings:{autoHide:true,offsetTop:0,offsetLeft:u.width/2,zIndex:20,angle:{position:"top",offset:u.width/2}}};s=BX.PopupMenu.create(r.menuId,r.anchor,r.menuItems,r.settings);if(this.isVisibleItem(o)){t.NODE=o}else{t.NODE=this.getItemAlias(o)}this.editItemData=t;if("menuItems"in s&&BX.type.isArray(s.menuItems)){s.menuItems.forEach(function(t){BX.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))},this)}BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onBeforeCreateEditMenu",[s,t,this]);this.editMenu=s;return s},setHome:function(){var t=this.getVisibleItems();var e=BX.type.isArray(t)&&t.length>0?t[0]:null;var i=BX.Buttons.Utils.getByTag(e,"a");if(!BX.type.isDomNode(i)){return}var s=i.getAttribute("href");if(s.charAt(0)==="?"){s=i.pathname+i.search}if(!this.lastHomeLink){this.lastHomeLink=s}if(this.lastHomeLink!==s){BX.userOptions.save("ui",this.listContainer.id,"firstPageLink",s);BX.onCustomEvent("BX.Main.InterfaceButtons:onFirstItemChange",[s,e])}this.lastHomeLink=s},isEditButton:function(t){return BX.hasClass(t,this.classEditItemButton)},isDragButton:function(t){return BX.hasClass(t,this.classDragItemButton)},isResetSettingsButton:function(t){return BX.hasClass(t,this.classSettingsResetButton)},getContainerHeight:function(){var t=this.getAllItems().map(function(t){var e=getComputedStyle(t);return BX.height(t)+parseInt(e.marginTop)+parseInt(e.marginBottom)});return Math.max.apply(Math,t)},setContainerHeight:function(){var t=this.getContainerHeight();var e=8;BX.height(this.listContainer,t-e)},setLicenseWindowParams:function(t){this.licenseParams=t||{}},message:function(t){var e;try{e=this.messages[t]}catch(t){e=""}return e},setCustomClasses:function(t){if(!BX.type.isPlainObject(t)){return}this.classItem=t.item||this.classItem;this.classItemSublink=t.itemSublink||this.classItemSublink;this.classItemText=t.itemText||this.classItemText;this.classItemCounter=t.itemCounter||this.classItemCounter;this.classItemIcon=t.itemIcon||this.classItemIcon;this.classItemMore=t.itemMore||this.classItemMore;this.classItemOver=t.itemOver||this.classItemOver;this.classItemActive=t.itemActive||this.classItemActive;this.classItemDisabled=t.itemDisabled||this.classItemDisabled;this.classOnDrag=t.onDrag||this.classOnDrag;this.classDropzone=t.dropzone||this.classDropzone;this.classSeporator=t.separator||this.classSeporator;this.classSubmenuItem=t.submenuItem||this.classSubmenuItem;this.classSubmenu=t.submenu||this.classSubmenu;this.classSecret=t.secret||this.classSecret;this.classItemLocked=t.itemLocked||this.classItemLocked},setMessages:function(t){if(!BX.type.isPlainObject(t)){return}this.messages=t},makeFullItemId:function(t){if(!BX.type.isNotEmptyString(t)){return}return[this.listContainer.id,t.replace("-","_")].join("_")},getItemById:function(t){var e=null;var i;if(BX.type.isNotEmptyString(t)){i=this.makeFullItemId(t);e=BX.Buttons.Utils.getBySelector(this.listContainer,"#"+i)}return e},getItemCounterObject:function(t){var e=null;if(BX.type.isDomNode(t)){e=BX.Buttons.Utils.getByClass(t,this.classItemCounter)}return e},setCounterValue:function(t,e){var i=this.getItemCounterObject(t);if(BX.type.isDomNode(i)){i.innerText=e>99?"99+":e>0?e:"";t.dataset.counter=e}this.updateMoreButtonCounter()},updateCounter:function(t,e){if(t.indexOf("crm")===0&&e<0){return}var i,s,n;var a=null;var o=this.getAllItems();if(BX.type.isArray(o)){o.forEach(function(e){try{s=JSON.parse(BX.data(e,"item"))}catch(t){s={}}if(BX.type.isPlainObject(s)&&"COUNTER_ID"in s&&s.COUNTER_ID===t){a=e}},this)}i=this.getItemCounterObject(a);if(BX.type.isDomNode(i)){a=this.getItem(i);i.innerText=e>99?"99+":e>0?e:"";a.dataset.counter=e}n=this.getItemAlias(a);if(BX.type.isDomNode(n)){i=this.getItemCounterObject(n);if(BX.type.isDomNode(i)){i.innerText=e>99?"99+":e>0?e:"";n.dataset.counter=e}}this.updateMoreButtonCounter()},setCounterValueByItemId:function(t,e){var i=e!==null?parseFloat(e):null;var s,n;if(!BX.type.isNotEmptyString(t)){throw"Bad first arg. Need string as item id"}if(i!==null&&!BX.type.isNumber(i)){throw"Bad two arg. Need number counter value - Integer, Float or string with number"}s=this.getItemById(t);if(!BX.type.isDomNode(s)){console.info("Not found node with id #"+t);return}n=this.getItemAlias(s);this.setCounterValue(s,i);this.setCounterValue(n,i)},getCounterValueByItemId:function(t){var e,i;var s=NaN;if(!BX.type.isNotEmptyString(t)){throw"Bad first arg. Need string item id"}else{e=this.getItemById(t);s=this.dataValue(e,"counter");s=parseFloat(s);if(!BX.type.isNumber(s)){i=this.getItemCounterObject(e);s=parseFloat(i.innerText)}}return s},setMoreButtonCounter:function(t){var e=this.getItemCounterObject(this.moreButton);var i=t>99?"99+":t>0?t:"";i=parseInt(i);i=BX.type.isNumber(i)?i:"";e.innerText=i},bindOnClickOnMoreButton:function(){BX.bind(this.moreButton,"click",BX.delegate(this._onClickMoreButton,this))},bindOnResizeFrame:function(){window.frames["maininterfacebuttonstmpframe-"+this.getId()].onresize=BX.throttle(this._onResizeHandler,20,this)},getId:function(){return BX.Buttons.Utils.getByClass(this.getContainer(),this.classInner).id},getAllItems:function(){return BX.Buttons.Utils.getByClass(this.listContainer,this.classItem,true)},getVisibleItems:function(){var t=this.getAllItems();var e=this;var i=[];if(t&&t.length){i=t.filter(function(t){return e.isVisibleItem(t)&&!e.isDisabled(t)})}return i},getHiddenItems:function(){var t=this.getAllItems();var e=[];var i=this;if(t&&t.length){e=t.filter(function(t){return!i.isVisibleItem(t)&&!i.isDisabled(t)})}return e},getDisabledItems:function(){return this.getAllItems().filter(function(t){return this.isDisabled(t)},this)},getMoreButton:function(){var t=null;this.getAllItems().forEach(function(e){!t&&BX.hasClass(e,this.classItemMore)&&(t=e)},this);return t},getLastVisibleItem:function(){var t=this.getVisibleItems();var e=null;if(BX.type.isArray(t)&&t.length){e=t[t.length-1]}if(!BX.type.isDomNode(e)){e=null}return e},adjustMoreButtonPosition:function(){var t=this.getLastVisibleItem();var e=this.isMoreButton(t);if(!e){this.listContainer.insertBefore(this.moreButton,t)}this.updateMoreButtonCounter()},getSubmenuId:function(t){var e="";if(BX.type.isDomNode(this.listContainer)&&BX.type.isNotEmptyString(this.listContainer.id)){e=this.submenuIdPrefix+this.listContainer.id}if(t){e=this.submenuWindowIdPrefix+e}return e},getChildMenuId:function(){var t="";if(BX.type.isDomNode(this.listContainer)&&BX.type.isNotEmptyString(this.listContainer.id)){t=this.childMenuIdPrefix+this.listContainer.id}return t},getSubmenuItemText:function(t){var e,i,s;if(!BX.type.isDomNode(t)){return null}e=this.findChildrenByClassName(t,this.classItemText);i=this.findChildrenByClassName(t,this.classItemCounter);if(BX.type.isDomNode(i)&&BX.type.isDomNode(e)){i.dataset.counter=this.dataValue(t,"counter");s=e.outerHTML+i.outerHTML}else{e=this.dataValue(t,"text");i=this.dataValue(t,"counter");s=e}return s},getChildMenuItemText:function(t){var e,i,s;if(!BX.type.isDomNode(t)){return null}e=this.findChildrenByClassName(t,this.classItemText);i=this.findChildrenByClassName(t,this.classItemCounter);if(BX.type.isDomNode(i)&&BX.type.isDomNode(e)){i.dataset.counter=this.dataValue(t,"counter");s=e.outerHTML+i.outerHTML}else{e=this.dataValue(t,"text");s=e}return s},getLockedClass:function(t){var e="";if(BX.type.isDomNode(t)&&this.isLocked(t)){e=this.classItemLocked}return e},getSubmenuItems:function(){var t=this.getAllItems();var e=this.getHiddenItems();var i=this.getDisabledItems();var s=[];var n,a;if(t.length){t.forEach(function(t){if(e.indexOf(t)===-1&&i.indexOf(t)===-1){s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:[this.classSubmenuItem,this.getIconClass(t),this.classSecret,this.getAliasLink(t),this.getLockedClass(t)].join(" ")})}},this)}if(e.length){e.forEach(function(t){try{n=JSON.parse(this.dataValue(t,"item"))}catch(t){n=null}a=[this.classSubmenuItem,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(BX.type.isPlainObject(n)&&("IS_ACTIVE"in n&&n.IS_ACTIVE===true||n.IS_ACTIVE==="true"||n.IS_ACTIVE==="Y")){a.push(this.classItemActive)}s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:a.join(" "),items:this.getChildMenuItems(t)})},this)}if(this.isSettingsEnabled){s.push({text:"<span>"+this.message("MIB_HIDDEN")+"</span>",className:[this.classSeporator,this.classSubmenuItem,this.classHiddenLabel].join(" ")});if(!i.length){s.push({text:"<span>"+this.message("MIB_NO_HIDDEN")+"</span>",className:[this.classSubmenuItem,this.classSubmenuNoHiddenItem].join(" ")})}if(i.length){i.forEach(function(t){try{n=JSON.parse(this.dataValue(t,"item"))}catch(t){n=null}a=[this.classSubmenuItem,this.classItemDisabled,this.getIconClass(t),this.getAliasLink(t),this.getLockedClass(t)];if(BX.type.isPlainObject(n)&&("IS_ACTIVE"in n&&n.IS_ACTIVE===true||n.IS_ACTIVE==="true"||n.IS_ACTIVE==="Y")){a.push(this.classItemActive)}s.push({text:this.getSubmenuItemText(t),href:this.dataValue(t,"url"),onclick:this.dataValue(t,"onclick"),title:t.getAttribute("title"),className:a.join(" "),items:this.getChildMenuItems(t)})},this)}s.push({text:"<span>"+this.message("MIB_MANAGE")+"</span>",className:[this.classSeporator,this.classSubmenuItem,this.classHiddenLabel,this.classManage].join(" ")});s.push({text:this.message("MIB_SETTING_MENU_ITEM"),className:[this.classSettingMenuItem,this.classSubmenuItem].join(" ")});s.push({text:this.message("MIB_APPLY_SETTING_MENU_ITEM"),className:[this.classSettingsApplyButton,this.classSubmenuItem].join(" ")});s.push({text:this.message("MIB_RESET_SETTINGS"),className:[this.classSettingsResetButton,this.classSubmenuItem].join(" ")})}return s},getChildMenuItems:function(t){var e;try{e=JSON.parse(this.dataValue(t,"item"))}catch(t){e=null}if(!BX.type.isPlainObject(e)){return[]}if(!BX.type.isArray(this.listChildItems[t.id])){var i={};this.setListAllItems(i,e);var s=this.getListItems(i,"");if(s.length){this.listChildItems[t.id]=BX.type.isArray(s[0].items)?s[0].items:[]}}return this.listChildItems[t.id]},setListAllItems:function(t,e){var i=[];if(BX.type.isPlainObject(e)){i.push(e)}else{i=e}i.forEach(function(e){t[e["ID"].replace(this.containerId+"_","")]=e;if(BX.type.isArray(e["ITEMS"])){this.setListAllItems(t,e["ITEMS"])}},this)},getListItems:function(t,e){var i=[];for(var s in t){if(!t.hasOwnProperty(s)){continue}var n=t[s];if(n["PARENT_ID"]===e){var a,o={text:n["TEXT"],href:n["URL"],onclick:n["ON_CLICK"],title:n["TITLE"]};a=this.getListItems(t,s);if(a.length){o.items=a}i.push(o);delete t[s]}}return i},getSubmenuArgs:function(){var t=this.getSubmenuId();var e=this.moreButton;var i=BX.pos(e);var s=this.getSubmenuItems();var n={autoHide:true,offsetLeft:i.width/2-80,angle:{position:"top",offset:100},zIndex:0,events:{onPopupClose:BX.delegate(this._onSubmenuClose,this)}};return[t,e,s,n]},getChildMenuArgs:function(t){var e=this.getChildMenuId();var i=this.getChildMenuItems(t);if(!i||BX.type.isArray(i)&&!i.length){return[]}var s={autoHide:true,angle:true,offsetLeft:t.getBoundingClientRect().width/2};return[e,t,i,s]},visibleControlMoreButton:function(){var t=this.getHiddenItems();if(!t.length||t.length===1&&this.isMoreButton(t[0])){this.getMoreButton().style.display="none"}else{this.getMoreButton().style.display=""}},createSubmenu:function(){var t=BX.PopupMenu.create.apply(BX.PopupMenu,this.getSubmenuArgs());if(this.isSettingsEnabled){this.dragAndDropInitInSubmenu()}t.menuItems.forEach(function(t){BX.bind(t.layout.item,"click",BX.delegate(this._onDocumentClick,this))},this);return t},createChildMenu:function(t){return BX.PopupMenu.create.apply(BX.PopupMenu,this.getChildMenuArgs(t))},showSubmenu:function(){var t=this.getSubmenu();if(t!==null){t.popupWindow.show()}else{this.destroySubmenu();t=this.createSubmenu();t.popupWindow.show()}this.setSubmenuShown(true);this.activateItem(this.moreButton);if(this.isEditEnabled()){t.popupWindow.setAutoHide(false)}},showChildMenu:function(t){var e=BX.PopupMenu.getMenuById(this.getChildMenuId()),i=null;if(e&&e.bindElement){if(e.bindElement.id!==t.id){this.destroyChildMenu(t);i=this.createChildMenu(t);i.popupWindow.show()}else{e.popupWindow.show()}}else{this.destroyChildMenu(t);i=this.createChildMenu(t);i.popupWindow.show()}},closeSubmenu:function(){var t=this.getSubmenu();if(t===null){return}t.popupWindow.close();if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}this.setSubmenuShown(false)},closeChildMenu:function(t){var e=this.getChildMenu(t);if(e===null){return}e.popupWindow.close()},getSubmenu:function(){return BX.PopupMenu.getMenuById(this.getSubmenuId())},getChildMenu:function(){return BX.PopupMenu.getMenuById(this.getChildMenuId())},destroySubmenu:function(){BX.PopupMenu.destroy(this.getSubmenuId())},destroyChildMenu:function(){BX.PopupMenu.destroy(this.getChildMenuId())},refreshSubmenu:function(){var t=this.getSubmenu();var e;if(t===null){return}e=this.getSubmenuArgs();if(BX.type.isArray(e)){this.destroySubmenu();this.createSubmenu();this.showSubmenu()}},setSubmenuShown:function(t){this.isSubmenuShown=false;if(BX.type.isBoolean(t)){this.isSubmenuShown=t}},activateItem:function(t){if(!BX.type.isDomNode(t)){return}if(!BX.hasClass(t,this.classItemActive)){BX.addClass(t,this.classItemActive)}},deactivateItem:function(t){if(!BX.type.isDomNode(t)){return}if(BX.hasClass(t,this.classItemActive)){BX.removeClass(t,this.classItemActive)}},getCurrentSettings:function(){var t={};this.getAllItems().forEach(function(e,i){t[e.id]={sort:i,isDisabled:this.isDisabled(e)}},this);return t},saveSettings:function(){var t=this.getCurrentSettings();var e="settings";var i;if(!BX.type.isPlainObject(t)){return}if(BX.type.isDomNode(this.listContainer)){if("id"in this.listContainer){i=this.listContainer.id;t=JSON.stringify(t);BX.userOptions.save("ui",i,e,t);this.setHome()}}},resetSettings:function(){var t=null;var e=BX.PopupWindowManager.create(this.listContainer.id+"_reset_popup",null,{content:this.message("MIB_RESET_ALERT"),autoHide:false,overlay:true,closeByEsc:true,closeIcon:true,draggable:{restrict:true},titleBar:this.message("MIB_RESET_SETTINGS"),buttons:[t=new BX.PopupWindowButton({text:this.message("MIB_RESET_BUTTON"),className:"popup-window-button-create",events:{click:function(){if(BX.hasClass(t.buttonNode,"popup-window-button-wait")){return}BX.addClass(t.buttonNode,"popup-window-button-wait");this.handleResetSettings(function(i){if(i){BX.removeClass(t.buttonNode,"popup-window-button-wait");e.setContent(i)}else{var s="settings";BX.userOptions.save("ui",this.listContainer.id,s,JSON.stringify({}));BX.userOptions.save("ui",this.listContainer.id,"firstPageLink","");window.location.reload()}}.bind(this))}.bind(this)}}),new BX.PopupWindowButtonLink({text:this.message("MIB_CANCEL_BUTTON"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});e.show()},handleResetSettings:function(t){var e=[];BX.onCustomEvent("BX.Main.InterfaceButtons:onBeforeResetMenu",[e,this]);var i=new BX.Promise;var s=i;for(var n=0;n<e.length;n++){i=i.then(e[n])}i.then(function(e){t(null,e)},function(e){t(e,null)});s.fulfill()},moveButtonAlias:function(t){var e,i;if(!t||!this.dragItem){return}e=this.getItemAlias(this.dragItem);i=this.getItemAlias(t);if(this.isListItem(e)){if(!i){this.listContainer.appendChild(e)}else{this.listContainer.insertBefore(e,i)}}},moveButton:function(t){var e;if(!BX.type.isDomNode(t)||!BX.type.isDomNode(this.dragItem)){return}if(this.isListItem(t)){if(this.isDisabled(this.dragItem)){this.dragItem.dataset.disabled="false"}if(BX.type.isDomNode(t)){this.listContainer.insertBefore(this.dragItem,t)}else{this.listContainer.appendChild(this.dragItem)}}if(this.isSubmenuItem(t)){if(this.isDisabled(this.dragItem)&&!this.isDisabled(t)){this.enableItem(this.dragItem)}e=this.getSubmenuContainer();e.insertBefore(this.dragItem,t)}},getSubmenuContainer:function(){var t=this.getSubmenu();var e=null;if(t!==null){e=t.itemsContainer}return e},findNextSiblingByClass:function(t,e){var i=t;for(;!!t;t=t.nextElementSibling){if(e){if(BX.hasClass(t,e)&&t!==i){return t}}else{return null}}},findParentByClassName:function(t,e){for(;t&&t!==document;t=t.parentNode){if(e){if(BX.hasClass(t,e)){return t}}else{return null}}},findChildrenByClassName:function(t,e){var i=null;if(BX.type.isDomNode(t)&&BX.type.isNotEmptyString(e)){i=BX.Buttons.Utils.getByClass(t,e)}return i},dragAndDropInit:function(){this.getAllItems().forEach(function(t,e){if(!this.isSeparator(t)&&!this.isSettings(t)&&!this.isApplySettingsButton(t)&&!this.isResetSettingsButton(t)){t.setAttribute("draggable","true");t.setAttribute("tabindex","-1");t.dataset.link="item"+e;BX.bind(t,"dragstart",BX.delegate(this._onDragStart,this));BX.bind(t,"dragend",BX.delegate(this._onDragEnd,this));BX.bind(t,"dragenter",BX.delegate(this._onDragEnter,this));BX.bind(t,"dragover",BX.delegate(this._onDragOver,this));BX.bind(t,"dragleave",BX.delegate(this._onDragLeave,this));BX.bind(t,"drop",BX.delegate(this._onDrop,this))}BX.bind(t,"mouseover",BX.delegate(this._onMouse,this));BX.bind(t,"mouseout",BX.delegate(this._onMouse,this))},this)},dragAndDropInitInSubmenu:function(){var t=this.getSubmenu();var e=t.menuItems;e.forEach(function(t){if(!this.isSeparator(t.layout.item)&&!this.isSettings(t.layout.item)&&!this.isApplySettingsButton(t.layout.item)&&!this.isResetSettingsButton(t.layout.item)){t.layout.item.draggable=true;t.layout.item.dataset.sortable=true;BX.bind(t.layout.item,"dragstart",BX.delegate(this._onDragStart,this));BX.bind(t.layout.item,"dragenter",BX.delegate(this._onDragEnter,this));BX.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this));BX.bind(t.layout.item,"dragleave",BX.delegate(this._onDragLeave,this));BX.bind(t.layout.item,"dragend",BX.delegate(this._onDragEnd,this));BX.bind(t.layout.item,"drop",BX.delegate(this._onDrop,this))}if(BX.hasClass(t.layout.item,this.classHiddenLabel)&&!BX.hasClass(t.layout.item,this.classManage)){BX.bind(t.layout.item,"dragover",BX.delegate(this._onDragOver,this))}},this)},getItem:function(t){if(!BX.type.isDomNode(t)){if(!t||!BX.type.isDomNode(t.target)){return null}}else{t={target:t}}var e=this.findParentByClassName(t.target,this.classItem);if(!BX.type.isDomNode(e)){e=this.findParentByClassName(t.target,this.classDefaultSubmenuItem)}return e},setOpacity:function(t){if(!BX.type.isDomNode(t)){return}BX.style(t,"opacity",".1")},unsetOpacity:function(t){if(!BX.type.isDomNode(t)){return}BX.style(t,"opacity","1")},setDragStyles:function(){BX.addClass(this.listContainer,this.classOnDrag);BX.addClass(BX(this.getSubmenuId(true)),this.classOnDrag);this.setOpacity(this.dragItem)},unsetDragStyles:function(){var t=this.getSubmenu();this.getAllItems().forEach(function(t){this.unsetOpacity(t);BX.removeClass(t,"over")},this);if(t&&"menuItems"in t&&BX.type.isArray(t.menuItems)&&t.menuItems.length){t.menuItems.forEach(function(t){this.unsetOpacity(t);BX.removeClass(t.layout.item,"over")},this)}BX.removeClass(this.listContainer,this.classOnDrag);BX.removeClass(BX(this.getSubmenuId(true)),this.classOnDrag)},getIconClass:function(t){var e="";if(BX.type.isDomNode(t)&&"dataset"in t&&"class"in t.dataset&&BX.type.isNotEmptyString(t.dataset.class)){e=t.dataset.class}return e},disableItem:function(t){var e=this.getItemAlias(t);if(t&&"dataset"in t){t.dataset.disabled="true";if(e){e.dataset.disabled="true"}}},enableItem:function(t){var e;if(!BX.type.isDomNode(t)){return}if(this.isSubmenuItem(t)){BX.removeClass(t,this.classItemDisabled);e=this.getItemAlias(t);if(BX.type.isDomNode(e)){e.dataset.disabled="false"}}},getAliasLink:function(t){return this.dataValue(t,"link")||""},getItemAlias:function(t){var e=null;if(!BX.type.isDomNode(t)){return e}var i=this.getAllItems();var s=this.isSubmenuItem(t);var n=this.isListItem(t);if(!s&&!n){return e}if(s){i.forEach(function(i){BX.hasClass(t,this.getAliasLink(i))&&(e=i)},this)}if(n){e=BX.Buttons.Utils.getByClass(document,this.getAliasLink(t))}return e},hideItem:function(t){!!t&&BX.addClass(t,this.classSecret)},showItem:function(t){!!t&&BX.removeClass(t,this.classSecret)},fakeDragItem:function(){var t=null;if(!BX.type.isDomNode(this.dragItem)||!BX.type.isDomNode(this.overItem)){return}if(this.isDragToSubmenu()){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.listContainer.appendChild(this.dragItem);this.dragItem=t;this.showItem(this.dragItem);this.adjustMoreButtonPosition();this.updateSubmenuItems();this.tmp.moved=false;this.tmp.movetToSubmenu=true;this.setOpacity(this.dragItem)}}if(this.isDragToList()&&!this.tmp.movetToSubmenu){t=this.getItemAlias(this.dragItem);if(t!==this.dragItem){this.hideItem(this.dragItem);this.dragItem=t;this.adjustMoreButtonPosition();this.updateSubmenuItems();this.setOpacity(this.dragItem)}}this.tmp.movetToSubmenu=false},updateSubmenuItems:function(){var t=this.getHiddenItems();var e=this.getDisabledItems();var i=this;var s=[];var n,a,o;n=this.getSubmenu();if(n===null){return}a=n.menuItems;if(!BX.type.isArray(a)||!a.length){return}s=e.concat(t);a.forEach(function(t){o=[].some.call(s,function(e){return BX.hasClass(t.layout.item,i.dataValue(e,"link"))||i.isDisabled(t.layout.item)||i.isSeparator(t.layout.item)||i.isDropzone(t.layout.item)});if(o||(i.isSettings(t.layout.item)||i.isApplySettingsButton(t.layout.item)||i.isResetSettingsButton(t.layout.item)||i.isNotHiddenItem(t.layout.item)||i.isSeparator(t.layout.item)||t.layout.item===i.dragItem)&&!i.isMoreButton(t.layout.item)){i.showItem(t.layout.item)}else{i.hideItem(t.layout.item)}})},isNotHiddenItem:function(t){return BX.hasClass(t,this.classSubmenuNoHiddenItem)},getNotHidden:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSubmenuNoHiddenItem)},setOverStyles:function(t){if(BX.type.isDomNode(t)&&!BX.hasClass(t,this.classItemOver)){BX.addClass(t,this.classItemOver)}},unsetOverStyles:function(t){if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItemOver)){BX.removeClass(t,this.classItemOver)}},dataValue:function(t,e){var i="";var s;if(BX.type.isDomNode(t)){s=BX.data(t,e);if(typeof s!=="undefined"){i=s}}return i},execScript:function(script){if(BX.type.isNotEmptyString(script)){eval(script)}},showLicenseWindow:function(){var t;if(!B24.licenseInfoPopup){return}t=B24.licenseInfoPopup;t.init({B24_LICENSE_BUTTON_TEXT:this.message("MIB_LICENSE_BUY_BUTTON"),B24_TRIAL_BUTTON_TEXT:this.message("MIB_LICENSE_TRIAL_BUTTON"),IS_FULL_DEMO_EXISTS:this.licenseParams.isFullDemoExists,HOST_NAME:this.licenseParams.hostname,AJAX_URL:this.licenseParams.ajaxUrl,LICENSE_ALL_PATH:this.licenseParams.licenseAllPath,LICENSE_DEMO_PATH:this.licenseParams.licenseDemoPath,FEATURE_GROUP_NAME:this.licenseParams.featureGroupName,AJAX_ACTIONS_URL:this.licenseParams.ajaxActionsUrl,B24_FEATURE_TRIAL_SUCCESS_TEXT:this.message("MIB_LICENSE_WINDOW_TRIAL_SUCCESS_TEXT")});t.show("main-buttons",this.message("MIB_LICENSE_WINDOW_HEADER_TEXT"),this.message("MIB_LICENSE_WINDOW_TEXT"))},_onDragStart:function(t){var e=this.getVisibleItems();var i=BX.type.isArray(e)?e.length:null;this.dragItem=this.getItem(t);if(!BX.type.isDomNode(this.dragItem)){return}if(i===2&&this.isListItem(this.dragItem)){t.preventDefault();BX.onCustomEvent(window,"BX.Main.InterfaceButtons:onHideLastVisibleItem",[this.dragItem,this]);return}if(this.isMoreButton(this.dragItem)||this.isSeparator(this.dragItem)||this.isNotHiddenItem(this.dragItem)){t.preventDefault();return}this.isSubmenuShownOnDragStart=!!this.isSubmenuShown;if(this.isListItem(this.dragItem)){this.showSubmenu()}this.setDragStyles();if(!this.isEditEnabled()){this.enableEdit()}},_onDragEnd:function(t){t.preventDefault();var e=this.getItem(t);var i,s;if(!BX.type.isDomNode(e)){return}this.unsetDragStyles();if(!this.isSubmenuShownOnDragStart){this.refreshSubmenu();if(!this.isEditEnabled()){this.closeSubmenu()}}else{this.refreshSubmenu()}i=BX.findNextSibling(this.dragItem,BX.delegate(function(t){return this.isVisibleItem(t)},this));s=BX.findPreviousSibling(this.dragItem,BX.delegate(function(t){return this.isVisibleItem(t)},this));if(BX.type.isDomNode(s)&&(BX.hasClass(s,this.classHiddenLabel)||this.isDisabled(s)&&this.isSubmenuItem(s))||(BX.type.isDomNode(i)&&BX.hasClass(i,this.classManage)||this.isDisabled(i)&&this.isSubmenuItem(i))){this.disableItem(this.dragItem);this.refreshSubmenu()}if(this.isEditEnabled()){this.enableEdit();BX.show(this.getSettingsApplyButton());BX.hide(this.getSettingsButton())}else{this.disableEdit();BX.hide(this.getSettingsApplyButton());BX.show(this.getSettingsButton())}this.updateMoreButtonCounter();this.saveSettings();this.dragItem=null;this.overItem=null;this.tmp.moved=false},updateMoreButtonCounter:function(){var t,e,i,s;t=this.getHiddenItems();s=this.getDisabledItems();t=t.concat(s);e=0;if(BX.type.isArray(t)){t.forEach(function(t){e+=parseInt(this.dataValue(t,"counter"))||0},this)}if(BX.type.isNumber(e)){this.setMoreButtonCounter(e)}},_onDragEnter:function(t){var e=this.getItem(t);if(BX.type.isDomNode(e)&&this.isNotHiddenItem(e)){this.setOverStyles(e)}},_onDragOver:function(t){t.preventDefault();var e=null;this.overItem=this.getItem(t);if(!BX.type.isDomNode(this.overItem)||!BX.type.isDomNode(this.dragItem)||this.overItem===this.dragItem||this.isNotHiddenItem(this.overItem)){return}this.fakeDragItem();if(this.isNext(t)&&this.isGoodPosition(t)&&!this.isMoreButton(this.overItem)){e=this.findNextSiblingByClass(this.overItem,this.classItem);if(this.isMoreButton(e)&&!this.tmp.moved){e=e.previousElementSibling;this.tmp.moved=true}if(!BX.type.isDomNode(e)){e=this.findNextSiblingByClass(this.overItem,this.classSubmenuItem)}if(BX.type.isDomNode(e)){this.moveButton(e);this.moveButtonAlias(e);this.adjustMoreButtonPosition();this.updateSubmenuItems()}}if(!this.isNext(t)&&this.isGoodPosition(t)&&!this.isMoreButton(this.overItem)||!this.isGoodPosition(t)&&this.isMoreButton(this.overItem)&&this.getVisibleItems().length===1){this.moveButton(this.overItem);this.moveButtonAlias(this.overItem);this.adjustMoreButtonPosition();this.updateSubmenuItems()}},_onDragLeave:function(t){var e=this.getItem(t);if(BX.type.isDomNode(e)){this.unsetOverStyles(t.target)}},_onDrop:function(t){var e=this.getItem(t);if(!BX.type.isDomNode(e)){return}if(this.isNotHiddenItem(e)||this.isDisabled(e)){this.disableItem(this.dragItem);this.adjustMoreButtonPosition()}this.unsetDragStyles();t.preventDefault()},getIndex:function(t,e){return[].indexOf.call(t||[],e)},_onSubmenuClose:function(){this.setSubmenuShown(false);if(this.isEditEnabled()){this.activateItem(this.moreButton)}else{if(!this.isActiveInMoreMenu()){this.deactivateItem(this.moreButton)}}},_onResizeHandler:function(){this.adjustMoreButtonPosition();this.updateSubmenuItems();if(!this.isSettingsEnabled){this.visibleControlMoreButton()}},_onClickMoreButton:function(t){t.preventDefault();this.showSubmenu()},_onMouse:function(t){var e=this.getItem(t);if(t.type==="mouseover"&&!BX.hasClass(e,this.classItemOver)){if(!BX.hasClass(e,this.classItemMore)){this.showChildMenu(e)}BX.addClass(e,this.classItemOver)}if(t.type==="mouseout"&&BX.hasClass(e,this.classItemOver)){BX.removeClass(e,this.classItemOver)}},getSettingsResetButton:function(){return BX.Buttons.Utils.getByClass(this.getSubmenuContainer(),this.classSettingsResetButton)},_onScroll:function(){if(BX.style(this.pinContainer,"position")==="fixed"){this.closeSubmenu()}},isDisabled:function(t){var e=false;if(BX.type.isDomNode(t)){e=this.dataValue(t,"disabled")==="true"||BX.hasClass(t,this.classItemDisabled)}return e},isSettings:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classSettingMenuItem)}return e},isLocked:function(t){var e=false;if(BX.type.isDomNode(t)){e=this.dataValue(t,"locked")==="true"||BX.hasClass(t,this.classItemLocked)}return e},isDropzone:function(t){return BX.hasClass(t,this.classDropzone)},isNext:function(t){var e=this.dragItem.getBoundingClientRect();var i=this.overItem.getBoundingClientRect();var s=getComputedStyle(this.dragItem);var n=parseInt(s.marginRight.replace("px",""));var a=null;if(this.isListItem(this.overItem)){a=t.clientX>i.left-n&&t.clientX>e.right}if(this.isSubmenuItem(this.overItem)){a=t.clientY>e.top}return a},isGoodPosition:function(t){var e=this.overItem;var i,s;if(!BX.type.isDomNode(e)){return false}i=e.getBoundingClientRect();if(this.isListItem(e)){s=this.isNext(t)&&t.clientX>=i.left+i.width/2||!this.isNext(t)&&t.clientX<=i.left+i.width/2}if(this.isSubmenuItem(e)){s=this.isNext(t)&&t.clientY>=i.top+i.height/2||!this.isNext(t)&&t.clientY<=i.top+i.height/2}return s},isSubmenuItem:function(t){return BX.hasClass(t,this.classSubmenuItem)},isVisibleItem:function(t){if(!BX.type.isDomNode(t)){return false}return t.offsetTop===0},isMoreButton:function(t){var e=false;if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItemMore)){e=true}return e},isListItem:function(t){var e=false;if(BX.type.isDomNode(t)&&BX.hasClass(t,this.classItem)){e=true}return e},isSublink:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classItemSublink)}return e},isSeparator:function(t){var e=false;if(BX.type.isDomNode(t)){e=BX.hasClass(t,this.classSeporator)}return e},isDragToSubmenu:function(){return!this.isSubmenuItem(this.dragItem)&&this.isSubmenuItem(this.overItem)},isDragToList:function(){return this.isSubmenuItem(this.dragItem)&&!this.isSubmenuItem(this.overItem)}}}if(typeof BX.Main.interfaceButtonsManager==="undefined"){BX.Main.interfaceButtonsManager={data:{},init:function(t){var e=null;if(!BX.type.isPlainObject(t)||!("containerId"in t)){throw"BX.Main.interfaceButtonsManager: containerId not set in params Object"}e=BX(t.containerId);if(BX.type.isDomNode(e)){this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)}else{BX(BX.delegate(function(){e=BX(t.containerId);if(!BX.type.isDomNode(e)){throw"BX.Main.interfaceButtonsManager: container is not dom node"}this.data[t.containerId]=new BX.Main.interfaceButtons(e,t)},this))}},getById:function(t){var e=null;if(BX.type.isString(t)&&BX.type.isNotEmptyString(t)){try{e=this.data[t]}catch(t){}}return e},getObjects:function(){return this.data}}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:94:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js?1544127384575";s:6:"source";s:76:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.js";s:3:"min";s:80:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js";s:3:"map";s:80:"/bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Buttons");BX.Buttons.Utils={getByClass:function(e,t,l){var n=[];if(t){n=(e||document.body).getElementsByClassName(t);if(!l){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getByTag:function(e,t,l){var n=[];if(t){n=(e||document.body).getElementsByTagName(t);if(!l){n=n.length?n[0]:null}else{n=[].slice.call(n)}}return n},getBySelector:function(e,t,l){var n=[];if(t){if(!l){n=(e||document.body).querySelector(t)}else{n=(e||document.body).querySelectorAll(t);n=[].slice.call(n)}}return n}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:98:"/bitrix/components/bitrix/crm.entity.counter.panel/templates/.default/script.min.js?15441274015274";s:6:"source";s:79:"/bitrix/components/bitrix/crm.entity.counter.panel/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
if(typeof BX.CrmEntityCounterPanel==="undefined"){BX.CrmEntityCounterPanel=function(){this._id="";this._settings={};this._userId=0;this._userName="";this._entityTypeId=0;this._extras=null;this._codes=null;this._data=null;this._totalInfo=null;this._items=null;this._counterManager=null;this._container=null;this._valueContainer=null;this._stubContainer=null};BX.CrmEntityCounterPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._userId=BX.prop.getInteger(this._settings,"userId",0);this._userName=BX.prop.getString(this._settings,"userName",this._userId);this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._extras=BX.prop.getObject(this._settings,"extras",{});this._codes=BX.prop.getArray(this._settings,"codes",[]);if(BX.CrmEntityType.isDefined(this._entityTypeId)){this._counterManager=BX.Crm.EntityCounterManager.create(this._id,{entityTypeId:this._entityTypeId,codes:this._codes,extras:this._extras,serviceUrl:BX.prop.getString(this._settings,"serviceUrl","")})}this._data=BX.prop.getObject(this._settings,"data",{});this._totalInfo=BX.prop.getObject(this._settings,"totalInfo",{});this._container=BX(this.getSetting("containerId",""));if(!BX.type.isElementNode(this._container)){throw"BX.CrmEntityCounterPanel: Could not find container."}this._valueContainer=BX(BX.prop.getString(this._settings,"valueContainerId"));if(!BX.type.isElementNode(this._valueContainer)){throw"BX.CrmEntityCounterPanel: Could not find valueContainer."}this._stubContainer=BX(BX.prop.getString(this._settings,"stubContainerId"));if(!BX.type.isElementNode(this._stubContainer)){throw"BX.CrmEntityCounterPanel: Could not find stubContainer."}this._items=[];var n=this._valueContainer.querySelectorAll("a.crm-counter-container");for(var i=0,r=n.length;i<r;i++){var s=n[i];var a=s.getAttribute("data-entity-counter-code");if(!BX.type.isNotEmptyString(a)){continue}var o=BX.prop.getObject(this._data,a,null);if(!o){continue}this._items.push(BX.CrmEntityCounterPanelItem.create(a,{parent:this,data:o,container:s}))}BX.addCustomEvent("onPullEvent-main",BX.delegate(this.onPullEvent,this))},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},processItemSelection:function(t){var e=t.getTypeId();if(e>0){var n={userId:this._userId.toString(),userName:this._userName,counterTypeId:e.toString(),cancel:false};BX.onCustomEvent(window,"BX.CrmEntityCounterPanel:applyFilter",[this,n]);if(n.cancel){return false}}return true},onPullEvent:function(t,e){if(t!=="user_counter"){return}var n=false;var i=BX.prop.getObject(e,BX.message("SITE_ID"),{});for(var r in i){if(!i.hasOwnProperty(r)){continue}if(!(r.indexOf("crm")===0&&i[r]>=0)){continue}if(!this._data.hasOwnProperty(r)){continue}if(this._data[r].hasOwnProperty("VALUE")&&BX.convert.toNumber(this._data[r]["VALUE"])===BX.convert.toNumber(i[r])){continue}this._data[r]["VALUE"]=i[r];if(!n){n=true}}if(n){this.prepareTotalInfo();this.refreshLayout()}},prepareTotalInfo:function(){var t=0;for(var e=0,n=this._items.length;e<n;e++){t+=this._items[e].getValue()}var i=BX.CrmMessageHelper.getCurrent().prepareEntityNumberDeclension(t,BX.prop.getObject(this._settings,"entityNumberDeclensions",{}));this._totalInfo={value:t,caption:i}},refreshLayout:function(){var t=BX.prop.getInteger(this._totalInfo,"value",0);if(t>0){if(this._stubContainer.style.display!=="none"){this._stubContainer.style.display="none"}if(this._valueContainer.style.display!==""){this._valueContainer.style.display=""}for(var e=0,n=this._items.length;e<n;e++){this._items[e].refreshLayout()}}else{if(this._valueContainer.style.display!=="none"){this._valueContainer.style.display="none"}if(this._stubContainer.style.display!==""){this._stubContainer.style.display=""}}}};BX.CrmEntityCounterPanel.create=function(t,e){var n=new BX.CrmEntityCounterPanel;n.initialize(t,e);return n}}if(typeof BX.CrmEntityCounterPanelItem==="undefined"){BX.CrmEntityCounterPanelItem=function(){this._id="";this._settings={};this._parent=null;this._container=null;this._data=null;this._clickHandler=BX.delegate(this.onClick,this)};BX.CrmEntityCounterPanelItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._parent=BX.prop.get(this._settings,"parent");if(!this._parent){throw"BX.CrmEntityCounterPanelItem: Could not find parent."}this._data=BX.prop.getObject(this._settings,"data",{});this._container=BX.prop.getElementNode(this._settings,"container");if(!this._container){throw"BX.CrmEntityCounterPanelItem: Could not find container."}BX.bind(this._container,"click",this._clickHandler)},getId:function(){return this._id},getTypeId:function(){return BX.prop.getInteger(this._data,"TYPE_ID",0)},getValue:function(){return BX.prop.getInteger(this._data,"VALUE",0)},refreshLayout:function(){var t=this.getValue();var e=this._container.querySelector(".crm-counter-number");if(e){e.innerHTML=t}this._container.style.display=t>0?"":"none"},onClick:function(t){if(!this._parent.processItemSelection(this)){return BX.PreventDefault(t)}}};BX.CrmEntityCounterPanelItem.create=function(t,e){var n=new BX.CrmEntityCounterPanelItem;n.initialize(t,e);return n}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/crm.widget_panel/templates/.default/script.min.js?1544127401182724";s:6:"source";s:71:"/bitrix/components/bitrix/crm.widget_panel/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
if(typeof BX.CrmWidget==="undefined"){BX.CrmWidget=function(){this._id="";this._settings=null;this._entityTypeName="";this._typeName="";this._serviceUrl="";this._title="";this._prefix="";this._heightInPixel=0;this._widthInPercent=0;this._layout="";this._config=null;this._configEditor=null;this._data={};this._container=null;this._wrapper=null;this._headerWrapper=null;this._contentWrapper=null;this._settingButton=null;this._hasLayout=false;this._cell=null;this._settingButtonClickHandler=BX.delegate(this.onSettingButtonClick,this);this._isSettingMenuShown=false;this._settingMenuId="";this._settingMenu=null;this._settingMenuHandler=BX.delegate(this.onSettingMenuItemClick,this)};BX.CrmWidget.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._entityTypeName=this.getSetting("entityTypeName","");this._cell=this.getSetting("cell",null);this._config=this.getSetting("config","");this._typeName=BX.type.isNotEmptyString(this._config["typeName"])?this._config["typeName"]:"";if(this._typeName===""){throw"CrmWidget: The type name is not found."}this._data=this.getSetting("data",{});if(!this._data["attributes"])this._data["attributes"]={};if(!BX.type.isArray(this._data["items"])){this._data["items"]=[]}this._prefix=this.getSetting("prefix","");var i=this.getSetting("containerId","");this._container=BX(i!==""?i:this._prefix+"_"+"container");this._heightInPixel=parseInt(this.getSetting("heightInPixel",0));if(this._heightInPixel<=0){this._heightInPixel=BX.CrmWidgetLayoutHeight.full}this._widthInPercent=parseInt(this.getSetting("widthInPercent",0));if(this._widthInPercent<=0){this._widthInPercent=100}this._layout=BX.type.isNotEmptyString(this._config["layout"])?this._config["layout"]:"";this.doInitialize()},doInitialize:function(){},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getTypeName:function(){return this._typeName},getEntityTypeName:function(){return this._entityTypeName},getTitle:function(){return BX.type.isNotEmptyString(this._config["title"])?this._config["title"]:""},getMessage:function(t){var e=BX.CrmWidget.messages;return e.hasOwnProperty(t)?e[t]:t},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getWrapper:function(){return this._wrapper},getPanel:function(){return this._cell?this._cell.getPanel():null},getCell:function(){return this._cell},getRow:function(){return this._cell?this._cell.getRow():null},getIndex:function(){return this._cell?this._cell.getWidgetIndex(this):-1},getNextSibling:function(){return this._cell?this._cell.getNextWidget(this):null},getConfig:function(){return this._config},getPeriodDescription:function(){var t=BX.type.isPlainObject(this._config["filter"])?this._config["filter"]:null;if(!t){return""}var e=BX.CrmWidgetConfigPeriodEditor.create("",{config:t});return!e.isEmpty()?e.getDescription():""},getHeight:function(){return BX.CrmWidgetLayoutHeight.undifined},getData:function(){return this._data},setData:function(t){this._data=t},refresh:function(){this.clearLayout();this.layout();var t=this.getPanel();if(t){t.processWidgetRefresh(this)}},invalidate:function(){},prepareHeader:function(t,e){var i=BX.create("DIV",{attrs:{className:"crm-widget-head"}});if(e&&typeof e["settings"]!=="undefined"){i.appendChild(e["settings"])}var r=BX.create("SPAN",{attrs:{className:"crm-widget-title-container"},children:[BX.create("SPAN",{attrs:{className:"crm-widget-title-inner"},children:[BX.create("SPAN",{attrs:{className:"crm-widget-title",title:t},text:t})]})]});i.appendChild(r);if(e&&typeof e["edit"]!=="undefined"){r.appendChild(e["edit"])}if(e&&typeof e["intitle_config"]!=="undefined"){r.firstElementChild.appendChild(e["intitle_config"])}return i},prepareButtons:function(){return{settings:BX.create("SPAN",{attrs:{className:"crm-widget-settings"}})}},renderHeader:function(t){this._headerWrapper=BX.create("DIV",{attrs:{className:"crm-widget-head"}});if(BX.type.isElementNode(t)){t.appendChild(this._headerWrapper)}else{this._wrapper.appendChild(this._headerWrapper)}this._settingButton=BX.create("SPAN",{attrs:{className:"crm-widget-settings"}});this._headerWrapper.appendChild(this._settingButton);var e=this.getTitle();if(e===""){e=this.getMessage("untitled")}this._headerWrapper.appendChild(BX.create("SPAN",{attrs:{className:"crm-widget-title-container"},children:[BX.create("SPAN",{attrs:{className:"crm-widget-title-inner"},children:[BX.create("SPAN",{attrs:{className:"crm-widget-title",title:e},text:e}),this._editButton]})]}))},renderContent:function(){},renderLayout:function(){this.renderHeader();this.renderContent()},layout:function(){if(this._hasLayout){return}if(!this._container){throw"CrmWidget: Could not find container."}this._wrapper=BX.create("DIV",{attrs:{className:"crm-widget"}});this._wrapper.setAttribute("data-widget-id",this._id);var t=this.getNextSibling();var e=t!==null?t.getWrapper():null;if(e===null){this._container.appendChild(this._wrapper)}else{this._container.insertBefore(this._wrapper,e)}this.renderLayout();if(this._settingButton){BX.bind(this._settingButton,"click",this._settingButtonClickHandler)}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}this.innerClearLayout();if(this._settingButton){BX.unbind(this._settingButton,"click",this._settingButtonClickHandler);this._settingButton=null}if(this._container){try{this._container.removeChild(this._wrapper)}catch(t){}}this._wrapper=null;this._hasLayout=false},innerClearLayout:function(){},remove:function(){if(!window.confirm(this.getMessage("removalConfirmation").replace(/#TITLE#/gi,this.getTitle()))){return false}this.clearLayout();this.undock();return true},dock:function(t,e){t.addWidget(this,e);this._cell=t},undock:function(){if(this._cell){this._cell.removeWidget(this);this._cell=null}},processConfigSave:function(){var t=this.getPanel();if(!t||!this._configEditor){return}this._configEditor.saveConfig();this._config=this._configEditor.getConfig();t.saveConfig(BX.delegate(this.onAfterConfigSave,this))},onAfterConfigSave:function(){BX.CrmWidgetManager.getCurrent().prepareWidgetData(this)},ensureConfigEditorCreated:function(){if(!this._configEditor){this._configEditor=BX.CrmWidgetConfigEditor.create(this._id+"_config",{widget:this,config:this._config,entityTypeName:this._entityTypeName})}},onSettingButtonClick:function(){if(!this._isSettingMenuShown){this.openSettingMenu()}else{this.closeSettingMenu()}},openSettingMenu:function(){if(this._isSettingMenuShown){return}this._settingMenuId=this._id+"_menu";if(typeof BX.PopupMenu.Data[this._settingMenuId]!=="undefined"){BX.PopupMenu.Data[this._settingMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._settingMenuId]}this._settingMenu=BX.PopupMenu.create(this._settingMenuId,this._settingButton,this._data&&this._data["attributes"]&&this._data["attributes"]["isConfigurable"]===false?[{id:"remove",text:this.getMessage("menuItemRemove"),onclick:this._settingMenuHandler}]:[{id:"configure",text:this.getMessage("menuItemConfigure"),onclick:this._settingMenuHandler},{id:"remove",text:this.getMessage("menuItemRemove"),onclick:this._settingMenuHandler}],{autoHide:true,offsetLeft:-5,offsetTop:-17,angle:{position:"top",offset:45},events:{onPopupClose:BX.delegate(this.onSettingMenuClose,this)}});this._settingMenu.popupWindow.show();this._isSettingMenuShown=true},closeSettingMenu:function(){if(this._settingMenu&&this._settingMenu.popupWindow){this._settingMenu.popupWindow.close()}},onSettingMenuClose:function(){this._settingMenu=null;if(typeof BX.PopupMenu.Data[this._settingMenuId]!=="undefined"){BX.PopupMenu.Data[this._settingMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._settingMenuId]}this._isSettingMenuShown=false},onSettingMenuItemClick:function(t,e){if(e.id==="configure"){this.openConfigDialog()}else if(e.id==="remove"){var i=this.getPanel();if(i){i.processWidgetRemoval(this)}}this.closeSettingMenu()},openConfigDialog:function(){this.ensureConfigEditorCreated();this._configEditor.openDialog()},scrollIntoView:function(){if(this._hasLayout&&this._container){this._container.scrollIntoView(true)}}};if(typeof BX.CrmWidget.messages==="undefined"){BX.CrmWidget.messages={}}BX.CrmWidget.create=function(t,e){var i=new BX.CrmWidget;i.initialize(t,e);return i}}if(typeof BX.CrmFunnelWidget==="undefined"){BX.CrmFunnelWidget=function(){this._chart=null;BX.CrmFunnelWidget.superclass.constructor.apply(this)};BX.extend(BX.CrmFunnelWidget,BX.CrmWidget);BX.CrmFunnelWidget.prototype.doInitialize=function(){};BX.CrmFunnelWidget.prototype.renderContent=function(){if(!AmCharts.isReady){if(BX.CrmWidgetPanel.isAjaxMode){AmCharts.handleLoad()}else{AmCharts.ready(BX.delegate(this.renderContent,this));return}}this._contentWrapper=BX.create("DIV",{attrs:{id:this._prefix+"_"+"content_wrapper",className:"crm-widget-content"}});this._wrapper.appendChild(this._contentWrapper);if(this._heightInPixel>0){this._contentWrapper.style.height=this._heightInPixel+"px"}var t=this.getPeriodDescription();if(t!==""){this._contentWrapper.appendChild(BX.create("SPAN",{attrs:{className:"crm-widget-content-period"},children:[BX.create("SPAN",{html:this.getMessage("periodCaption")+": "+t})]}))}var e=BX.create("DIV",{attrs:{id:this._prefix+"_chart_wrapper"}});this._contentWrapper.appendChild(e);if(this._heightInPixel>0){e.style.height=this._heightInPixel-55+"px"}var i=BX.type.isNotEmptyString(this._data["valueField"])?this._data["valueField"]:"";var r=BX.type.isNotEmptyString(this._data["titleField"])?this._data["titleField"]:"";var n=BX.type.isArray(this._data["items"])?this._data["items"]:[];for(var s=0;s<n.length;s++){var o=BX.type.isNotEmptyString(n[s][r])?n[s][r]:"";if(o!==""){n[s]["BALLOON_TEXT"]=BX.util.htmlspecialchars(o)}}this._chart=AmCharts.makeChart(e.id,{type:"funnel",theme:"none",titleField:r,valueField:i,dataProvider:n,labelPosition:"right",depth3D:160,angle:16,outlineAlpha:2,outlineColor:"#FFFFFF",outlineThickness:2,startY:-400,marginRight:240,marginLeft:10,balloon:{fixedPosition:true}});this._chart.balloonText="<div>[[BALLOON_TEXT]]</div>"};BX.CrmFunnelWidget.prototype.innerClearLayout=function(){if(this._chart){this._chart.clear();this._chart=null}};BX.CrmFunnelWidget.prototype.ensureConfigEditorCreated=function(){if(!this._configEditor){this._configEditor=BX.CrmWidgetManager.getCurrent().createConfigEditor(this._entityTypeName,this._typeName,this._id+"_config",{widget:this,config:this._config,enableTitle:true,entityTypeName:this._entityTypeName})}};BX.CrmFunnelWidget.prototype.getHeight=function(){return BX.CrmWidgetLayoutHeight.full};BX.CrmFunnelWidget.prototype.invalidate=function(){if(this._chart){this._chart.invalidateSize()}};BX.CrmFunnelWidget.create=function(t,e){var i=new BX.CrmFunnelWidget;i.initialize(t,e);return i}}if(typeof BX.CrmPieWidget==="undefined"){BX.CrmPieWidget=function(){this._chart=null;BX.CrmPieWidget.superclass.constructor.apply(this)};BX.extend(BX.CrmPieWidget,BX.CrmWidget);BX.CrmPieWidget.prototype.getTitle=function(){var t=BX.type.isNotEmptyString(this._config["title"])?this._config["title"]:"";if(t===""&&BX.type.isArray(this._config["configs"])&&this._config["configs"].length>0&&BX.type.isNotEmptyString(this._config["configs"][0]["title"])){t=this._config["configs"][0]["title"]}return t};BX.CrmPieWidget.prototype.renderContent=function(){if(!AmCharts.isReady){if(BX.CrmWidgetPanel.isAjaxMode){AmCharts.handleLoad()}else{AmCharts.ready(BX.delegate(this.renderContent,this));return}}this._contentWrapper=BX.create("DIV",{attrs:{id:this._prefix+"_"+"content_wrapper",className:"crm-widget-content"}});this._wrapper.appendChild(this._contentWrapper);if(this._heightInPixel>0){this._contentWrapper.style.height=this._heightInPixel+"px"}var t=this.getPeriodDescription();if(t!==""){this._contentWrapper.appendChild(BX.create("SPAN",{attrs:{className:"crm-widget-content-period"},children:[BX.create("SPAN",{html:this.getMessage("periodCaption")+": "+t})]}))}var e=BX.create("DIV",{attrs:{id:this._prefix+"_chart_wrapper"}});this._contentWrapper.appendChild(e);if(this._heightInPixel>0){e.style.height=this._heightInPixel-40+"px"}var i=BX.prop.getString(this._data,"titleField","");var r=BX.prop.getString(this._data,"valueField","");var n=BX.prop.getArray(this._data,"items",[]);if(i!==""){for(var s=0,o=n.length;s<o;s++){n[s][i]=BX.util.strip_tags(BX.prop.getString(n[s],i,""))}}this._chart=AmCharts.makeChart(e.id,{type:"pie",theme:"none",titleField:i,valueField:r,dataProvider:n,labelsEnabled:false,depth3D:15,angle:30,outlineAlpha:.4,outlineColor:"#FFFFFF",outlineThickness:1,legend:{markerType:"circle",position:"right",marginRight:10,autoMargins:false}})};BX.CrmPieWidget.prototype.innerClearLayout=function(){if(this._chart){this._chart.clear();this._chart=null}};BX.CrmPieWidget.prototype.ensureConfigEditorCreated=function(){if(!this._configEditor){this._configEditor=BX.CrmWidgetManager.getCurrent().createConfigEditor(this._entityTypeName,this._typeName,this._id+"_config",{widget:this,config:this._config,entityTypeName:this._entityTypeName})}};BX.CrmPieWidget.prototype.getHeight=function(){return BX.CrmWidgetLayoutHeight.full};BX.CrmPieWidget.prototype.invalidate=function(){if(this._chart){this._chart.invalidateSize()}};BX.CrmPieWidget.create=function(t,e){var i=new BX.CrmPieWidget;i.initialize(t,e);return i}}if(typeof BX.CrmCustomWidget==="undefined"){BX.CrmCustomWidget=function(){BX.CrmCustomWidget.superclass.constructor.apply(this)};BX.extend(BX.CrmCustomWidget,BX.CrmWidget);BX.CrmCustomWidget.prototype.doInitialize=function(){this._controller=null;if(this._config&&this._config.customType){this._controller=this.resolveController(this._config.customType)}};BX.CrmCustomWidget.prototype.resolveController=function(t){var e=null;switch(t){case"saletarget":e="BX.Crm.Widget.Custom.SaleTarget";break}return e?BX.getClass(e):null};BX.CrmCustomWidget.prototype.prepareButtons=function(){if(this._controller&&this._controller.prepareButtons){return this._controller.prepareButtons(this)}return BX.CrmCustomWidget.superclass.prepareButtons.apply(this)};BX.CrmCustomWidget.prototype.renderLayout=function(){var t=BX.type.isArray(this._data["items"])&&this._data["items"].length>0?this._data["items"][0]:null;if(!t){return}var e,i,r,n,s;var o=this.prepareButtons();this._settingButton=o["settings"];BX.addClass(this._wrapper,"crm-widget-custom");var a=this._controller&&this._controller.useAutoHeight(this);if(a){BX.addClass(this._wrapper,"crm-widget-height-auto");var h=this.getCell();var l=h.getRow();BX.addClass(l.getContainer(),"crm-widget-row-height-auto")}else if(this.getHeight()!==BX.CrmWidgetLayoutHeight.full){BX.addClass(this._wrapper,"crm-widget-number")}r=typeof t["display"]!=="undefined"?t["display"]:{};n=BX.CrmWidgetColorScheme.getInfo(BX.type.isNotEmptyString(r["colorScheme"])?r["colorScheme"]:"");if(n){this._wrapper.style.backgroundColor=n["color"]}this._headerWrapper=this.prepareHeader(BX.type.isNotEmptyString(t["title"])?t["title"]:this._config["title"]||this.getMessage("untitled"),o);this._wrapper.appendChild(this._headerWrapper);this._contentWrapper=BX.create("DIV",{attrs:{id:this._prefix+"_"+"content_wrapper",className:"crm-widget-content"}});if(a){BX.addClass(this._contentWrapper,"crm-widget-content-height-auto")}this._wrapper.appendChild(this._contentWrapper);if(this._controller&&this._controller.createContentNode){s=this._controller.createContentNode(this,t)}else if(t["html"]){var g=BX.processHTML(t["html"]),d=BX.util.getRandomString(10);s=BX.create("DIV",{attrs:{id:"bx-crm-custom-widget-"+d},html:g["HTML"],style:{fontSize:"14px",opacity:1}});if(g["SCRIPT"]){var c=0,p=function(){if(c++>100)return;if(BX("bx-crm-custom-widget-"+d))return BX.ajax.processScripts(g["SCRIPT"]);setTimeout(p,500)};setTimeout(p,500)}}else{e=BX.util.htmlspecialchars(t["text"]);i=BX.type.isNotEmptyString(t["url"])?BX.util.htmlspecialchars(t["url"]):"";s=i!==""?BX.create("A",{attrs:{className:"crm-widget-content-text"},props:{href:i,target:"_top"},html:e,style:{fontSize:"48px",lineHeight:"56px",opacity:1}}):BX.create("SPAN",{attrs:{className:"crm-widget-content-text"},html:e,style:{fontSize:"48px",lineHeight:"56px",opacity:1}})}if(a){this._contentWrapper.appendChild(s)}else{this._contentWrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-widget-content-amt"},children:[s]}))}var u=this.getPeriodDescription();if(u!==""){this._contentWrapper.appendChild(BX.create("SPAN",{attrs:{className:"crm-widget-content-period"},children:[BX.create("SPAN",{html:this.getMessage("periodCaption")+": "+u})]}))}this.ajustFontSize(this._wrapper.querySelectorAll(".crm-widget-content-text"));this._widowResizeHandler=BX.throttle(BX.delegate(this.onWidowResize,this),300);BX.bind(window,"resize",this._widowResizeHandler)};BX.CrmCustomWidget.prototype.innerClearLayout=function(){BX.unbind(window,"resize",this._widowResizeHandler);this._widowResizeHandler=null};BX.CrmCustomWidget.prototype.openConfigDialog=function(){var t=BX.type.isArray(this._data["items"])&&this._data["items"].length>0?this._data["items"][0]:null;if(!t){return}if(this._controller){this._controller.openConfigDialog(this,t);return}var e=BX.type.isNotEmptyString(t["url"])?t["url"]:"";if(e){window.location.href=e;return}BX.CrmCustomWidget.superclass.openConfigDialog.apply(this,arguments)};BX.CrmCustomWidget.prototype.getHeight=function(){if(this._heightInPixel===BX.CrmWidgetLayoutHeight.full)return BX.CrmWidgetLayoutHeight.full;return BX.CrmWidgetLayoutHeight.half};BX.CrmCustomWidget.prototype.onWidowResize=function(t){if(this._hasLayout&&this._wrapper){this.ajustFontSize(this._wrapper.querySelectorAll(".crm-widget-content-text"))}};BX.CrmCustomWidget.prototype.ajustFontSize=function(t){var e=0;var i=0;var r=true;var n=true;var s=0;if(!t)return;for(var o=0;o<t.length;o++){e=parseInt(BX.style(t[o],"font-size"));if(!s)s=72;else s=53;r=t[o].offsetWidth>t[o].parentNode.offsetWidth-20;n=t[o].offsetWidth<t[o].parentNode.offsetWidth-20;while(t[o].offsetWidth>t[o].parentNode.offsetWidth-20&&r){e-=2;t[o].style.fontSize=e+"px";t[o].style.lineHeight=e+8+"px";n=false}while(t[o].offsetWidth<t[o].parentNode.offsetWidth-20&&e<s&&n){e+=2;t[o].style.fontSize=e+"px";t[o].style.lineHeight=e+8+"px";r=false}if(!i&&o>0)i=e;if(o>0)i=Math.min(i,e)}for(var a=0;a<t.length;a++){t[a].style.opacity=1;if(a>0){t[a].style.fontSize=i+"px";t[a].style.lineHeight=i+8+"px"}}};BX.CrmCustomWidget.create=function(t,e){var i=new BX.CrmCustomWidget;i.initialize(t,e);return i}}if(typeof BX.CrmGraphWidget==="undefined"){BX.CrmGraphWidget=function(){this._chart=null;this._chartWrapper=null;this._maxGraphCount=0;BX.CrmGraphWidget.superclass.constructor.apply(this)};BX.extend(BX.CrmGraphWidget,BX.CrmWidget);BX.CrmGraphWidget.prototype.doInitialize=function(){var t=this.getPanel();if(t){this._maxGraphCount=t.getMaxGraphCount()}};BX.CrmGraphWidget.prototype.prepareGraphSettings=function(t){this._graphCounter=this._graphCounter||0;this._graphCounter++;var e={id:"g"+this._graphCounter,title:t["title"],valueField:t["selectField"],balloonText:"[[title]]: [[value]]"};var i=this._config&&!!this._config["display"]?this._config["display"]:{};if(BX.type.isPlainObject(t["display"])){for(var r in t["display"]){if(t["display"].hasOwnProperty(r)){i[r]=BX.clone(t["display"][r])}}}var n=typeof i["graph"]!=="undefined"?i["graph"]:{};var s=i["type"]||this._typeName;if(BX.type.isNotEmptyString(n["type"])){s=n["type"]}if(BX.type.isNotEmptyString(n["clustered"])){e["clustered"]=n["clustered"]==="Y"}var o=BX.CrmWidgetColorScheme.getInfo(BX.type.isNotEmptyString(i["colorScheme"])?i["colorScheme"]:"");if(o){e["lineColor"]=o["color"]}if(s==="bar"){e["type"]="column";e["fillAlphas"]=1}else if(s==="area"){e["type"]="line";e["fillAlphas"]=.4}else if(s==="line"){e["type"]="line";e["balloon"]={cornerRadius:7,adjustBorderColor:false,borderThickness:0,color:"#ffffff",verticalPadding:8};e["bullet"]="round";e["bulletBorderAlpha"]=1;e["bulletColor"]="#FFFFFF";e["bulletSize"]=4;e["hideBulletsCount"]=30;e["useLineColorForBulletBorder"]=true}else{e["type"]="smoothedLine";e["lineThickness"]=2;e["bullet"]="round";e["bulletSize"]=7;e["bulletBorderAlpha"]=1}return e};BX.CrmGraphWidget.prototype.renderContent=function(){if(!AmCharts.isReady){if(BX.CrmWidgetPanel.isAjaxMode){AmCharts.handleLoad()}else{AmCharts.ready(BX.delegate(this.renderContent,this));return}}this._contentWrapper=BX.create("DIV",{attrs:{id:this._prefix+"_"+"content_wrapper",className:"crm-widget-content"}});this._wrapper.appendChild(this._contentWrapper);if(this._heightInPixel>0){this._contentWrapper.style.height=this._heightInPixel-this._headerWrapper.offsetHeight+"px";this._contentWrapper.style.overflow="visible"}var t=this.getPeriodDescription();if(t!==""){this._contentWrapper.appendChild(BX.create("SPAN",{attrs:{className:"crm-widget-content-period"},children:[BX.create("SPAN",{html:this.getMessage("periodCaption")+": "+t})]}))}var e=BX.type.isArray(this._data["items"])&&this._data["items"].length>0?this._data["items"][0]:{};var i=[],r,n,s;var o=BX.type.isArray(e["graphs"])?e["graphs"]:null;if(o){var a=this._maxGraphCount>0&&o.length<this._maxGraphCount?o.length:this._maxGraphCount;for(n=0;n<a;n++){i.push(this.prepareGraphSettings(o[n]))}}else{i.push(this.prepareGraphSettings(e))}var h=typeof this._config["display"]!=="undefined"?this._config["display"]:{};var l=BX.type.isArray(e["values"])?e["values"]:[];var g=BX.type.isNotEmptyString(e["groupField"])?e["groupField"]:"";var d={type:"serial",theme:"none",marginLeft:20,dataProvider:l,graphs:i,dataDateFormat:this._data["dateFormat"],categoryField:g,categoryAxis:{axisAlpha:.5,axisColor:"#808992"},color:"#808992",legend:{useGraphSettings:true,equalWidths:false,position:"bottom"},chartCursor:{enabled:true,oneBalloonOnly:true,categoryBalloonEnabled:true,categoryBalloonColor:"#000000"}};var c=BX.type.isPlainObject(this._config["format"])?this._config["format"]:{};if(BX.type.isNotEmptyString(c["isCurrency"])&&c["isCurrency"]==="Y"){var p=this.getPanel().getCurrencyFormat();if(BX.type.isPlainObject(p)){d["numberFormatter"]={decimalSeparator:p["DEC_POINT"],thousandsSeparator:p["THOUSANDS_SEP"]}}}if(i.length<=0){}else if(this._typeName==="graph"){d["valueAxes"]=[{id:"v1",axisAlpha:.3,gridAlpha:0,axisColor:"#808992"}]}else if(this._typeName==="bar"){var u={id:"v1",axisAlpha:.3,gridAlpha:0,axisColor:"#808992"};if(BX.type.isNotEmptyString(this._config["enableStack"])&&this._config["enableStack"]==="Y"){u["stackType"]="regular"}if(BX.type.isNotEmptyString(this._config["integersOnly"])&&this._config["integersOnly"]==="Y"){u["integersOnly"]=true}d["valueAxes"]=[u]}i={};for(n=0;n<d.graphs.length;n++){i[d.graphs[n]["valueField"]]=0}for(n=0;n<d.dataProvider.length;n++){for(r in i){if(i.hasOwnProperty(r)){if(d.dataProvider[n][r])i[r]++;else d.dataProvider[n][r]=0}}}s=[];for(n=0;n<d.graphs.length;n++){if(i[d.graphs[n]["valueField"]]>0){s.push(d.graphs[n])}}d.graphs=s;if(g==="DATE"){var f={defaultPeriodType:BX.CrmWidgetManager.filter.lastDays30};if(BX.CrmWidgetManager.filter["defaultPeriodType"]){f["defaultPeriodType"]=BX.CrmWidgetManager.filter["defaultPeriodType"];if(BX.CrmWidgetManager.filter["defaultYear"])f["year"]=BX.CrmWidgetManager.filter["defaultYear"];if(BX.CrmWidgetManager.filter["defaultQuater"])f["quater"]=BX.CrmWidgetManager.filter["defaultQuater"];if(BX.CrmWidgetManager.filter["defaultMonth"])f["month"]=BX.CrmWidgetManager.filter["defaultMonth"]}if(this._config["filter"]&&this._config["filter"]["periodType"])f=this._config["filter"];else if(BX.CrmWidgetManager.filter["periodType"])f=BX.CrmWidgetManager.filter;f=BX.CrmWidgetFilterPeriod.getPeriod(BX.CrmWidgetConfigPeriodEditor.create("",{config:BX.clone(f,true)}));var _=/^(\d{4})-(\d{2})-(\d{2})$/,m=new Date,C;if(!f["start"]||!f["end"]){var y=false,B=false;if(!f["start"]){f["start"]=new Date;y=true}if(!f["end"]){f["end"]=new Date;B=true}for(n=0;n<e["values"].length;n++){C=_.exec(e["values"][n]["DATE"]);m.setFullYear(C[1],C[2]-1,C[3]);if(y&&f["start"].valueOf()>m.valueOf())f["start"].setFullYear(C[1],C[2]-1,C[3]);if(B&&f["end"].valueOf()<m.valueOf())f["end"].setFullYear(C[1],C[2]-1,C[3])}f["start"].setHours(0,0,0);f["end"].setHours(23,59,59)}var X={},v=[],S={},W=function(t,e){return String(e+t).slice(-e.length)};for(n=0;n<e["values"].length;n++){X[e["values"][n]["DATE"]]=e["values"][n]}var w=new Date;w.setFullYear(f["start"].getFullYear(),f["start"].getMonth(),f["start"].getDate());while(w.getTime()<f["end"].getTime()){C=w.getFullYear().toString()+"-"+W((w.getMonth()+1).toString(),"00")+"-"+W(w.getDate().toString(),"00");S=X[C]||{DATE:C};for(n=0;n<d.graphs.length;n++){if(!S[d.graphs[n]["valueField"]])S[d.graphs[n]["valueField"]]=0}v.push(S);w.setDate(w.getDate()+1)}d.dataProvider=v;var N=[];var E=[];for(var x=1;x<=12;x++){N.push(BX.message["MONTH_"+x.toString()]);E.push(BX.message["MON_"+x.toString()])}AmCharts.monthNames=N;AmCharts.shortMonthNames=E;var I=BX.message("FORMAT_DATE");var P=I.indexOf("D")<I.indexOf("M")?"DD MMM":"MMM DD";d["chartCursor"]["categoryBalloonDateFormat"]=P;d["categoryAxis"]["parseDates"]=true;d["categoryAxis"]["minPeriod"]="DD";d["categoryAxis"]["dateFormats"]=[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:P},{period:"WW",format:P},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}];if(h["chartScrollbar"]==="Y"&&d["graphs"].length>0){d["chartScrollbar"]={graph:d["graphs"][0]["id"],scrollbarHeight:50,backgroundAlpha:0,selectedBackgroundAlpha:.1,selectedBackgroundColor:"#888888",graphFillAlpha:0,graphLineAlpha:.5,selectedGraphFillAlpha:0,selectedGraphLineAlpha:1,autoGridCount:true,color:"#AAAAAA"};if(d.dataProvider.length>7&&f["start"]&&f["end"]){var D=new Date;if(f["end"].getMonth()-f["start"].getMonth()>=3){D.setFullYear(f["end"].getFullYear(),f["end"].getMonth()-3,f["end"].getDate())}else if(f["end"].getMonth()-f["start"].getMonth()>1){D.setFullYear(f["end"].getFullYear(),f["end"].getMonth()-1,f["end"].getDate())}else if(f["end"].getTime()-f["start"].getTime()>7*86400){D.setFullYear(f["end"].getFullYear(),f["end"].getMonth(),f["end"].getDate());D.setDate(D.getDate()-7)}var T=BX.proxy(function(t){t.chart.zoomToDates(D,f["end"])},this);d["listeners"]=[{event:"dataUpdated",method:T},{event:"drawn",method:T}]}}}else if(g==="USER"){if(this._config["enableAvatar"]==="Y"){if(false&&this._config["enableStack"]!=="Y"){d["rotate"]=true;d["listeners"]=[{event:"drawn",method:BX.proxy(this.customiseAvatarInClusteredBar,this)}]}else if(this._config["enableStack"]==="Y"){var b="";for(n=0;n<d.graphs.length;n++){b+="+ '"+d.graphs[n]["title"]+': \' + dataItem["dataContext"]["'+d.graphs[n]["valueField"]+"\"] + '; '"}d.graphs.push({clustered:false,bulletSize:54,bulletOffset:15,bullet:"custom",type:"column",valueField:"avatars",fillAlphas:0,lineAlpha:0,customBullet:"data:image/svg+xml;charset=US-ASCII,%3Csvg%20viewBox%3D%220%200%2089%2089%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Ccircle%20fill%3D%22%23535C69%22%20cx%3D%2244.5%22%20cy%3D%2244.5%22%20r%3D%2244.5%22/%3E%3Cpath%20d%3D%22M68.18%2071.062c0-3.217-3.61-16.826-3.61-16.826%200-1.99-2.6-4.26-7.72-5.585-1.734-.483-3.383-1.233-4.887-2.223-.33-.188-.28-1.925-.28-1.925l-1.648-.25c0-.142-.14-2.225-.14-2.225%201.972-.663%201.77-4.574%201.77-4.574%201.252.695%202.068-2.4%202.068-2.4%201.482-4.3-.738-4.04-.738-4.04.388-2.625.388-5.293%200-7.918-.987-8.708-15.847-6.344-14.085-3.5-4.343-.8-3.352%209.082-3.352%209.082l.942%202.56c-1.85%201.2-.564%202.65-.5%204.32.09%202.466%201.6%201.955%201.6%201.955.093%204.07%202.1%204.6%202.1%204.6.377%202.556.142%202.12.142%202.12l-1.786.217c.024.58-.023%201.162-.14%201.732-2.1.936-2.553%201.485-4.64%202.4-4.032%201.767-8.414%204.065-9.193%207.16-.78%203.093-3.095%2015.32-3.095%2015.32H68.18z%22%20fill%3D%22%23FFF%22/%3E%3C/svg%3E",classNameField:"userClassNameField",switchable:false,visibleInLegend:false,balloonFunction:new Function("dataItem",'return dataItem["dataContext"]["USER"] + \': \' '+b+";"),maxBulletSize:54,hideBulletsCount:15});d["marginTop"]=40;for(n=0;n<d.dataProvider.length;n++){for(r=0;r<d.graphs.length;r++){d.dataProvider[n][d.graphs[r]["valueField"]]=d.dataProvider[n][d.graphs[r]["valueField"]]||0}d.dataProvider[n]["avatars"]=0;d.dataProvider[n]["userClassNameField"]="bx-user-"+d.dataProvider[n]["USER_ID"];d.dataProvider[n]["id"]="bx-user-"+d.dataProvider[n]["USER_ID"]}d["listeners"]=[{event:"drawn",method:BX.proxy(this.customiseAvatarInStackedBar,this)}];d["chartCursor"]["graphBulletSize"]=1}}d["categoryAxis"]["labelRotation"]=l.length<5?0:45}this._chartWrapper=BX.create("DIV",{attrs:{id:this._prefix+"_chart_wrapper"}});this._contentWrapper.appendChild(this._chartWrapper);if(this._heightInPixel>0){this._chartWrapper.style.height=this._heightInPixel-this._headerWrapper.offsetHeight+"px"}d["path"]=BX.message("AMCHARTS_PATH");d["pathToImages"]=BX.message("AMCHARTS_IMAGES_PATH");var T=BX.proxy(function(){this._chart=AmCharts.makeChart(this._chartWrapper.id,BX.clone(d,true))},this);T();BX.bind(window,"resize",BX.throttle(function(){if(this._chart)this._chart.clear();setTimeout(T,100)},300,this))};BX.CrmGraphWidget.prototype.customiseAvatarInClusteredBar=function(t){var e,i,r,n,s,o,a=t.chart.categoryAxis.allLabels,h,l,g={},d,c,p;for(l in a){if(a.hasOwnProperty(l)&&(s=a[l].node.textContent)&&(o=this.users[s+""])&&o){e=a[l].node;h=e.parentNode;d={src:"data:image/svg+xml;charset=US-ASCII,%3Csvg%20viewBox%3D%220%200%2089%2089%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Ccircle%20fill%3D%22%23535C69%22%20cx%3D%2244.5%22%20cy%3D%2244.5%22%20r%3D%2244.5%22/%3E%3Cpath%20d%3D%22M68.18%2071.062c0-3.217-3.61-16.826-3.61-16.826%200-1.99-2.6-4.26-7.72-5.585-1.734-.483-3.383-1.233-4.887-2.223-.33-.188-.28-1.925-.28-1.925l-1.648-.25c0-.142-.14-2.225-.14-2.225%201.972-.663%201.77-4.574%201.77-4.574%201.252.695%202.068-2.4%202.068-2.4%201.482-4.3-.738-4.04-.738-4.04.388-2.625.388-5.293%200-7.918-.987-8.708-15.847-6.344-14.085-3.5-4.343-.8-3.352%209.082-3.352%209.082l.942%202.56c-1.85%201.2-.564%202.65-.5%204.32.09%202.466%201.6%201.955%201.6%201.955.093%204.07%202.1%204.6%202.1%204.6.377%202.556.142%202.12.142%202.12l-1.786.217c.024.58-.023%201.162-.14%201.732-2.1.936-2.553%201.485-4.64%202.4-4.032%201.767-8.414%204.065-9.193%207.16-.78%203.093-3.095%2015.32-3.095%2015.32H68.18z%22%20fill%3D%22%23FFF%22/%3E%3C/svg%3E",width:30,height:30,left:0,top:0};if(o["avatar"]&&o["avatar"]["width"]>0&&o["avatar"]["height"]>0){c=Math.max(d["width"]/o["avatar"]["width"],d["height"]/o["avatar"]["height"]);d.src=o["avatar"]["src"];p=Math.ceil(c*o["avatar"]["width"]);d.left=Math.ceil((d.width-p)/2);d.width=p;p=Math.ceil(c*o["avatar"]["height"]);d.top=Math.ceil((d.height-p)/2);d.height=p}i=document.createElementNS("http://www.w3.org/2000/svg","g");i.setAttribute("transform","translate(-17)");g.defs=document.createElementNS("http://www.w3.org/2000/svg","defs");g.pattern=document.createElementNS("http://www.w3.org/2000/svg","pattern");g.pattern.setAttribute("id","img"+s);g.pattern.setAttribute("patternUnits","objectBoundingBox");g.pattern.setAttribute("width",d.width);g.pattern.setAttribute("height",d.height);g.image=document.createElementNS("http://www.w3.org/2000/svg","image");g.image.setAttributeNS("http://www.w3.org/1999/xlink","href",d.src);g.image.setAttribute("x",d.left);g.image.setAttribute("y",d.top);g.image.setAttribute("width",d.width);g.image.setAttribute("height",d.height);g.image.setAttributeNS(null,"clip-path","url(#circleView"+s+")");g.pattern.appendChild(g.image);g.defs.appendChild(g.pattern);i.appendChild(g.defs);g.circle=document.createElementNS("http://www.w3.org/2000/svg","circle");g.circle.setAttributeNS(null,"cx","0");g.circle.setAttributeNS(null,"cy","0");g.circle.setAttributeNS(null,"r","15");g.circle.setAttribute("style","fill: url(#img"+s+");");i.appendChild(g.circle);i.setAttribute("class","amcharts-user-pic");i.setAttribute("transform",e.getAttribute("transform"));h.removeChild(e);h.appendChild(i)}}};BX.CrmGraphWidget.prototype.customiseAvatarInStackedBar=function(t){var e,i=t.chart.dataProvider,r,n,s={},o,a,h,l=BX.findChildren(t.chart.bulletSet.node,{tagName:"IMAGE"},true),g,d={offset:15,extDiameter:54,strokeWidth:5};for(n=0;n<l.length;n++){g=l[n].parentNode;r={avatar:i[n]["USER_PHOTO"],user:i[n]["USER_ID"]};s.circle0=document.createElementNS("http://www.w3.org/2000/svg","circle");s.circle0.setAttributeNS(null,"r",Math.ceil(d.extDiameter/2)+5+"");s.circle0.setAttribute("style","fill: white;");g.insertBefore(s.circle0,g.firstChild);if(r["avatar"]&&r["avatar"]["width"]>0&&r["avatar"]["height"]>0){h={width:d.extDiameter,height:d.extDiameter,left:0,top:0};o=Math.max(h["width"]/r["avatar"]["width"],h["height"]/r["avatar"]["height"]);h.src=r["avatar"]["src"];a=Math.ceil(o*r["avatar"]["width"]);h.left=Math.ceil((h.width-a)/2);h.width=a;a=Math.ceil(o*r["avatar"]["height"]);h.top=Math.ceil((h.height-a)/2);h.height=a;s.defs=document.createElementNS("http://www.w3.org/2000/svg","defs");s.pattern=document.createElementNS("http://www.w3.org/2000/svg","pattern");s.pattern.setAttribute("id","imgF"+r["user"]);s.pattern.setAttribute("patternUnits","objectBoundingBox");s.pattern.setAttribute("width","100%");s.pattern.setAttribute("height","100%");s.image=document.createElementNS("http://www.w3.org/2000/svg","image");s.image.setAttributeNS("http://www.w3.org/1999/xlink","href",h.src);s.image.setAttribute("x",h.left);s.image.setAttribute("y",h.top);s.image.setAttribute("width",h.width);s.image.setAttribute("height",h.height);s.pattern.appendChild(s.image);s.defs.appendChild(s.pattern);s.circle=document.createElementNS("http://www.w3.org/2000/svg","circle");s.circle.setAttributeNS(null,"r",Math.ceil(d.extDiameter/2));s.circle.setAttribute("style","fill: url(#imgF"+r["user"]+");");s.image1=BX.findChild(g,{tagName:"IMAGE"},true);s.image1.parentNode.removeChild(s.image1);g.appendChild(s.defs);g.appendChild(s.circle)}}};BX.CrmGraphWidget.prototype.innerClearLayout=function(){if(this._chart){this._chart.clear();this._chart=null}};BX.CrmGraphWidget.prototype.ensureConfigEditorCreated=function(){if(!this._configEditor){this._configEditor=BX.CrmWidgetManager.getCurrent().createConfigEditor(this._entityTypeName,this._typeName,this._id+"_config",{widget:this,config:this._config,enableTitle:true,maxGraphCount:this.getMaxGraphCount(),entityTypeName:this.getEntityTypeName()})}};BX.CrmGraphWidget.prototype.getHeight=function(){return BX.CrmWidgetLayoutHeight.full};BX.CrmGraphWidget.prototype.invalidate=function(){if(this._chart){this._chart.invalidateSize()}};BX.CrmGraphWidget.prototype.getMaxGraphCount=function(){return this._maxGraphCount};BX.CrmGraphWidget.create=function(t,e){var i=new BX.CrmGraphWidget;i.initialize(t,e);return i}}if(typeof BX.CrmRatingWidget==="undefined"){BX.CrmRatingWidget=function(){BX.CrmRatingWidget.superclass.constructor.apply(this)};BX.extend(BX.CrmRatingWidget,BX.CrmWidget);BX.CrmRatingWidget.prototype.renderContent=function(){BX.addClass(this._wrapper,"crm-widget-rating");this._contentWrapper=BX.create("DIV",{attrs:{id:this._prefix+"_"+"content_wrapper",className:"crm-widget-content"}});this._wrapper.appendChild(this._contentWrapper);var t=BX.create("DIV",{attrs:{className:"crm-widget-content-rating"}});this._contentWrapper.appendChild(t);var e=this.getPeriodDescription();if(e!==""){this._contentWrapper.appendChild(BX.create("SPAN",{attrs:{className:"crm-widget-content-period"},children:[BX.create("SPAN",{html:this.getMessage("periodCaption")+": "+e})]}))}var i=BX.type.isArray(this._data["items"])&&this._data["items"].length>0?this._data["items"][0]:{};var r=parseInt(i["nomineeId"]);var n=BX.type.isArray(i["positions"])?i["positions"]:[];var s;var o=-1;for(s=0;s<n.length;s++){if(parseInt(n[s]["id"])===r){o=s;break}}var a;if(o>=0){var h=n[o];a=BX.type.isNotEmptyString(h["legendType"])&&h["legendType"]==="html"?h["legend"]:BX.util.htmlspecialchars(h["legend"]);t.appendChild(BX.create("DIV",{attrs:{className:"crm-widget-rating-position"},children:[BX.create("DIV",{attrs:{className:"crm-widget-rating-position-inner"},children:[BX.create("SPAN",{attrs:{className:"crm-widget-rating-pl"},text:this.getMessage("nomineeRatingPosition").replace("#POSITION#",h["value"])}),BX.create("SPAN",{attrs:{className:"crm-widget-rating-result"},children:[BX.create("SPAN",{html:BX.util.htmlspecialchars(this.getMessage("legend")).replace("#LEGEND#",a)})]})]})]}))}var l=BX.create("DIV",{attrs:{className:"crm-widget-rating-positions"}});t.appendChild(l);for(s=0;s<n.length;s++){var g=n[s];var d=parseInt(g["id"]);if(d===r){continue}a=BX.type.isNotEmptyString(g["legendType"])&&g["legendType"]==="html"?g["legend"]:BX.util.htmlspecialchars(g["legend"]);l.appendChild(BX.create("DIV",{attrs:{className:"crm-widget-rating-position"},children:[this.getMessage("ratingPosition").replace("#POSITION#",g["value"]),BX.create("SPAN",{attrs:{className:"crm-widget-rating-result"},children:[BX.create("SPAN",{html:BX.util.htmlspecialchars(this.getMessage("legend")).replace("#LEGEND#",a)})]})]}))}};BX.CrmRatingWidget.prototype.ensureConfigEditorCreated=function(){if(!this._configEditor){this._configEditor=BX.CrmWidgetManager.getCurrent().createConfigEditor(this._entityTypeName,this._typeName,this._id+"_config",{widget:this,config:this._config,entityTypeName:this.getEntityTypeName()})}};BX.CrmRatingWidget.prototype.getHeight=function(){return BX.CrmWidgetLayoutHeight.half};BX.CrmRatingWidget.create=function(t,e){var i=new BX.CrmRatingWidget;i.initialize(t,e);return i}}if(typeof BX.CrmNumericWidget==="undefined"){BX.CrmNumericWidget=function(){BX.CrmNumericWidget.superclass.constructor.apply(this);this._widowResizeHandler=null};BX.extend(BX.CrmNumericWidget,BX.CrmWidget);BX.CrmNumericWidget.prototype.doInitialize=function(){};BX.CrmNumericWidget.prototype.getTitle=function(){var t=BX.type.isNotEmptyString(this._config["title"])?this._config["title"]:"";if(BX.type.isArray(this._data["items"])&&this._data["items"].length>0&&BX.type.isNotEmptyString(this._data["items"][0]["title"])){t=this._data["items"][0]["title"]}return t};BX.CrmNumericWidget.prototype.renderLayout=function(){var t,e,i,r,n;var s=this.prepareButtons();this._settingButton=s["settings"];var o=this.getPeriodDescription();if(this._layout==="tiled"){BX.addClass(this._wrapper,"crm-widget-total");var a,h,l;if(BX.type.isArray(this._data["items"])){if(this._data["items"].length>0){a=this._data["items"][0]}if(this._data["items"].length>1){h=this._data["items"][1]}if(this._data["items"].length>2){l=this._data["items"][2]}}if(!a){return}i=typeof a["display"]!=="undefined"?a["display"]:{};r=BX.CrmWidgetColorScheme.getInfo(BX.type.isNotEmptyString(i["colorScheme"])?i["colorScheme"]:"");var g=BX.create("DIV",{attrs:{className:"crm-widget-total-top"}});if(r){g.style.backgroundColor=r["color"]}this._wrapper.appendChild(g);this._headerWrapper=this.prepareHeader(BX.type.isNotEmptyString(a["title"])?a["title"]:this.getMessage("untitled"),s);g.appendChild(this._headerWrapper);this._contentWrapper=BX.create("DIV",{attrs:{id:this._prefix+"_"+"content_wrapper",className:"crm-widget-content"}});if(o!==""){this._contentWrapper.appendChild(BX.create("SPAN",{attrs:{className:"crm-widget-content-period"},children:[BX.create("SPAN",{html:this.getMessage("periodCaption")+": "+o})]}))}t=this.prepareItemHtml(a);e=BX.type.isNotEmptyString(a["url"])?a["url"]:"";n=e!==""?BX.create("A",{attrs:{className:"crm-widget-content-text"},props:{href:e,target:"_top"},html:t,style:{fontSize:"48px",lineHeight:"56px",opacity:1}}):BX.create("SPAN",{attrs:{className:"crm-widget-content-text"},html:t,style:{fontSize:"48px",lineHeight:"56px",opacity:1}});this._contentWrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-widget-content-amt"},children:[n]}));g.appendChild(this._contentWrapper);var d=BX.create("DIV",{attrs:{className:"crm-widget-total-bottom"}});this._wrapper.appendChild(d);var c=BX.create("DIV",{attrs:{className:"crm-widget-total-left"}});d.appendChild(c);if(h){i=typeof h["display"]!=="undefined"?h["display"]:{};r=BX.CrmWidgetColorScheme.getInfo(BX.type.isNotEmptyString(i["colorScheme"])?i["colorScheme"]:"");if(r){c.style.backgroundColor=r["color"]}var p=this.prepareHeader(BX.type.isNotEmptyString(h["title"])?h["title"]:this.getMessage("untitled"));c.appendChild(p);t=this.prepareItemHtml(h);e=BX.type.isNotEmptyString(h["url"])?h["url"]:"";n=e!==""?BX.create("A",{attrs:{className:"crm-widget-content-text"},props:{href:e,target:"_top"},html:t,style:{fontSize:"48px",lineHeight:"56px",opacity:1}}):BX.create("SPAN",{attrs:{className:"crm-widget-content-text"},html:t,style:{fontSize:"48px",lineHeight:"56px",opacity:1}});var u=BX.create("DIV",{attrs:{className:"crm-widget-content"},children:[BX.create("DIV",{attrs:{className:"crm-widget-content-amt"},children:[n]})]});c.appendChild(u)}var f=BX.create("DIV",{attrs:{className:"crm-widget-total-right"}});d.appendChild(f);if(l){i=typeof l["display"]!=="undefined"?l["display"]:{};r=BX.CrmWidgetColorScheme.getInfo(BX.type.isNotEmptyString(i["colorScheme"])?i["colorScheme"]:"");if(r){f.style.backgroundColor=r["color"]}var _=this.prepareHeader(BX.type.isNotEmptyString(l["title"])?l["title"]:this.getMessage("untitled"));f.appendChild(_);t=this.prepareItemHtml(l);e=BX.type.isNotEmptyString(l["url"])?l["url"]:"";n=e!==""?BX.create("A",{attrs:{className:"crm-widget-content-text"},props:{href:e,target:"_top"},html:t,style:{fontSize:"48px",lineHeight:"56px",opacity:1}}):BX.create("SPAN",{attrs:{className:"crm-widget-content-text"},html:t,style:{fontSize:"48px",lineHeight:"56px",opacity:1}});var m=BX.create("DIV",{attrs:{className:"crm-widget-content"},children:[BX.create("DIV",{attrs:{className:"crm-widget-content-amt"},children:[n]})]});f.appendChild(m)}}else{BX.addClass(this._wrapper,"crm-widget-number");var C=BX.type.isArray(this._data["items"])&&this._data["items"].length>0?this._data["items"][0]:null;if(!C){return}i=typeof C["display"]!=="undefined"?C["display"]:{};r=BX.CrmWidgetColorScheme.getInfo(BX.type.isNotEmptyString(i["colorScheme"])?i["colorScheme"]:"");if(r){this._wrapper.style.backgroundColor=r["color"]}this._headerWrapper=this.prepareHeader(BX.type.isNotEmptyString(C["title"])?C["title"]:this.getMessage("untitled"),s);this._wrapper.appendChild(this._headerWrapper);this._contentWrapper=BX.create("DIV",{attrs:{id:this._prefix+"_"+"content_wrapper",className:"crm-widget-content"}});this._wrapper.appendChild(this._contentWrapper);t=this.prepareItemHtml(C);e=BX.type.isNotEmptyString(C["url"])?C["url"]:"";n=e!==""?BX.create("A",{attrs:{className:"crm-widget-content-text"},props:{href:e,target:"_top"},html:t,style:{fontSize:"48px",lineHeight:"56px",opacity:1}}):BX.create("SPAN",{attrs:{className:"crm-widget-content-text"},html:t,style:{fontSize:"48px",lineHeight:"56px",opacity:1}});if(o!==""){this._contentWrapper.appendChild(BX.create("SPAN",{attrs:{className:"crm-widget-content-period"},children:[BX.create("SPAN",{html:this.getMessage("periodCaption")+": "+o})]}))}this._contentWrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-widget-content-amt"},children:[n]}))}this.ajustFontSize(this._wrapper.querySelectorAll(".crm-widget-content-text"));this._widowResizeHandler=BX.throttle(BX.delegate(this.onWidowResize,this),300);BX.bind(window,"resize",this._widowResizeHandler)};BX.CrmNumericWidget.prototype.prepareItemHtml=function(t){var e="";if(BX.type.isNotEmptyString(t["html"])){e=t["html"]}else if(BX.type.isNotEmptyString(t["text"])){e=BX.util.htmlspecialchars(t["text"])}else if(BX.type.isNotEmptyString(t["value"])){var i=t["value"];var r=typeof t["format"]!=="undefined"?t["format"]:{};if(BX.type.isNotEmptyString(r["isPercent"])&&r["isPercent"]==="Y"){i+="%"}e=BX.util.htmlspecialchars(i)}return e};BX.CrmNumericWidget.prototype.innerClearLayout=function(){BX.unbind(window,"resize",this._widowResizeHandler);this._widowResizeHandler=null};BX.CrmNumericWidget.prototype.ensureConfigEditorCreated=function(){if(!this._configEditor){this._configEditor=BX.CrmWidgetManager.getCurrent().createConfigEditor(this._entityTypeName,this._typeName,this._id+"_config",{widget:this,config:this._config,entityTypeName:this.getEntityTypeName()})}};BX.CrmNumericWidget.prototype.getHeight=function(){return this._layout==="tiled"?BX.CrmWidgetLayoutHeight.full:BX.CrmWidgetLayoutHeight.half};BX.CrmNumericWidget.prototype.onWidowResize=function(t){if(this._hasLayout&&this._wrapper){this.ajustFontSize(this._wrapper.querySelectorAll(".crm-widget-content-text"))}};BX.CrmNumericWidget.prototype.ajustFontSize=function(t){var e=0;var i=0;var r=true;var n=true;var s=0;if(!t)return;for(var o=0;o<t.length;o++){e=parseInt(BX.style(t[o],"font-size"));if(!s)s=72;else s=53;r=t[o].offsetWidth>t[o].parentNode.offsetWidth-20;n=t[o].offsetWidth<t[o].parentNode.offsetWidth-20;while(t[o].offsetWidth>t[o].parentNode.offsetWidth-20&&r){e-=2;t[o].style.fontSize=e+"px";t[o].style.lineHeight=e+8+"px";n=false}while(t[o].offsetWidth<t[o].parentNode.offsetWidth-20&&e<s&&n){e+=2;t[o].style.fontSize=e+"px";t[o].style.lineHeight=e+8+"px";r=false}if(!i&&o>0)i=e;if(o>0)i=Math.min(i,e)}for(var a=0;a<t.length;a++){t[a].style.opacity=1;if(a>0){t[a].style.fontSize=i+"px";t[a].style.lineHeight=i+8+"px"}}};BX.CrmNumericWidget.create=function(t,e){var i=new BX.CrmNumericWidget;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetConfigEditor==="undefined"){BX.CrmWidgetConfigEditor=function(){this._id="";this._settings=null;this._entityTypeName="";this._widget=null;this._config=null;this._enableTitle=false;this._dlg=null;this._container=null;this._leadingWrapper=null;this._titleEditor=null;this._period=null;this._extraEditors=null};BX.CrmWidgetConfigEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._entityTypeName=this.getSetting("entityTypeName","");this._widget=this.getSetting("widget");if(!this._widget){throw"BX.CrmWidgetConfigEditor: Could not find widget parameter."}this._config=this.getSetting("config");if(!this._config){throw"BX.CrmWidgetConfigEditor: Could not find config parameter."}this._enableTitle=this.getSetting("enableTitle",false);this._extraEditors=this.getSetting("extraEditors");if(!BX.type.isArray(this._extraEditors)){this._extraEditors=[]}this.doInitialize()},doInitialize:function(){},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmWidgetConfigEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getEntityTypeName:function(){return this._entityTypeName},openDialog:function(){if(this._dlg){return}var t=this._id;this._dlg=new BX.PopupWindow(t,null,{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:false,closeIcon:{top:"10px",right:"15px"},zIndex:0,titleBar:this.getMessage("dialogTitle")+" ("+BX.CrmEntityType.getCaptionByName(this._entityTypeName).toLowerCase()+")",content:this.prepareDialogContent(),buttons:[new BX.PopupWindowButton({text:this.getMessage("dialogSaveButton"),className:"popup-window-button-accept",events:{click:BX.delegate(this.onDialogAcceptButtonClick,this)}}),new BX.PopupWindowButtonLink({text:this.getMessage("dialogCancelButton"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this.onDialogCancelButtonClick,this)}})],events:{onPopupShow:BX.delegate(this.onDialogShow,this),onPopupClose:BX.delegate(this.onDialogClose,this),onPopupDestroy:BX.delegate(this.onDialogDestroy,this)}});this._dlg.show()},closeDialog:function(){if(this._dlg){this._dlg.close()}},prepareDialogContent:function(){this._container=BX.create("DIV",{});this._leadingWrapper=BX.create("DIV",{attrs:{className:"container-item"}});this._container.appendChild(this._leadingWrapper);if(this._enableTitle){this._titleEditor=BX.CrmWidgetConfigTitleEditor.create(this._id,{config:this._config,backgroundColor:"#b0b6bc",enableBackgroundColorChange:false});this._titleEditor.prepareLayout(this._leadingWrapper)}var t=BX.type.isPlainObject(this._config["filter"])?this._config["filter"]:{};this._period=BX.CrmWidgetConfigPeriodEditor.create(this._id+"_period",{isNested:true,config:t});this._period.prepareLayout(this._leadingWrapper);var e=BX.type.isPlainObject(t["extras"])?t["extras"]:{};for(var i=0,r=this._extraEditors.length;i<r;i++){this._extraEditors[i].setConfig(e);this._extraEditors[i].prepareLayout(this._leadingWrapper,i%2>0?"left":"right")}this.innerPrepareDialogContent(this._container);return this._container},innerPrepareDialogContent:function(t){},reset:function(){},getWidget:function(){return this._widget},getWidgetTypeName:function(){return this._widget.getTypeName()},getConfig:function(){return this._config},saveConfig:function(){if(this._entityTypeName!==""){this._config["entityTypeName"]=this._entityTypeName}if(this._enableTitle&&this._titleEditor){this._titleEditor.saveConfig();this._titleEditor.copyToConfig(this._config)}this._period.saveConfig();if(!BX.type.isPlainObject(this._config["filter"])){this._config["filter"]={}}this._period.copyToConfig(this._config["filter"]);if(!BX.type.isPlainObject(this._config["filter"]["extras"])){this._config["filter"]["extras"]={}}for(var t=0,e=this._extraEditors.length;t<e;t++){this._extraEditors[t].saveConfig();this._extraEditors[t].copyToConfig(this._config["filter"]["extras"])}this.innerSaveConfig()},innerSaveConfig:function(){},onDialogShow:function(){},onDialogClose:function(){if(this._dlg){this.reset();this._dlg.destroy()}},onDialogDestroy:function(){this._dlg=null},onDialogAcceptButtonClick:function(){this._widget.processConfigSave();this.closeDialog()},onDialogCancelButtonClick:function(){this.closeDialog()}};if(typeof BX.CrmWidgetConfigEditor.messages==="undefined"){BX.CrmWidgetConfigEditor.messages={}}BX.CrmWidgetConfigEditor.createSelect=function(t,e){var i=BX.create("SELECT",t);this.setupSelectOptions(i,e);return i};BX.CrmWidgetConfigEditor.setupSelectOptions=function(t,e){var i=t.value;var r=false;while(t.options.length>0){t.remove(0)}var n=null;var s="";for(var o=0;o<e.length;o++){var a=e[o];var h=BX.type.isNotEmptyString(a["group"])?a["group"]:"";if(h!==""&&h!==s){s=h;n=document.createElement("OPTGROUP");n.label=h;t.appendChild(n)}var l=BX.type.isNotEmptyString(a["value"])?a["value"]:"";var g=BX.type.isNotEmptyString(a["text"])?a["text"]:a["value"];if(!r&&l===i){r=true}var d=new Option(g,l,false,false);if(BX.type.isBoolean(a["disabled"])&&a["disabled"]){d.disabled=true}var c=BX.type.isPlainObject(a["attrs"])?a["attrs"]:null;if(c){for(var p in c){if(!c.hasOwnProperty(p)){continue}d.setAttribute("data-"+p,c[p])}}if(n){n.appendChild(d)}else{if(!BX.browser.IsIE()){t.add(d,null)}else{try{t.add(d,t.options[null])}catch(e){t.add(d,null)}}}}if(r){t.value=i}};BX.CrmWidgetConfigEditor.create=function(t,e){var i=new BX.CrmWidgetConfigEditor;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetConfigPeriodEditor==="undefined"){BX.CrmWidgetConfigPeriodEditor=function(){this._id="";this._settings=null;this._isNested=false;this._enableEmpty=true;this._config=null;this._period="";this._curYear=0;this._curMonth=0;this._curQuarter=0;this._year=0;this._quarter=0;this._month=0;this._periodSelector=null;this._yearSelector=null;this._quarterSelector=null;this._monthSelector=null;this._yearSelectorWrapper=null;this._quarterSelectorWrapper=null;this._monthSelectorWrapper=null;this._periodChangeHandler=BX.delegate(this.onPeriodChange,this);this._yearChangeHandler=BX.delegate(this.onYearChange,this);this._quarterChangeHandler=BX.delegate(this.onQuarterChange,this);this._monthChangeHandler=BX.delegate(this.onMonthChange,this);this._changeNotifier=null};BX.CrmWidgetConfigPeriodEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._isNested=this.getSetting("isNested",false);this._config=this.getSetting("config",{});this._period=BX.type.isNotEmptyString(this._config["periodType"])?this._config["periodType"].toUpperCase():this.getDefaultPeriod();this._enableEmpty=BX.type.isBoolean(this._config["enableEmpty"])?this._config["enableEmpty"]:true;var i=new Date;this._curYear=i.getFullYear();this._curMonth=i.getMonth()+1;this._curQuarter=this._curMonth>=10?4:this._curMonth>=7?3:this._curMonth>=4?2:1;this._year=typeof this._config["year"]!=="undefined"?parseInt(this._config["year"]):this._curYear;this._quarter=typeof this._config["quarter"]!=="undefined"?parseInt(this._config["quarter"]):this._curQuarter;this._month=typeof this._config["month"]!=="undefined"?parseInt(this._config["month"]):this._curMonth;this._changeNotifier=BX.CrmNotifier.create(this);var r=this.getSetting("controls");if(BX.type.isPlainObject(r)){this._yearSelectorWrapper=BX(r["yearWrap"]);this._quarterSelectorWrapper=BX(r["quarterWrap"]);this._monthSelectorWrapper=BX(r["monthWrap"]);this._periodSelector=BX(r["period"]);BX.CrmWidgetConfigEditor.setupSelectOptions(this._periodSelector,this.preparePeriodListItems());this._periodSelector.value=this._period;BX.bind(this._periodSelector,"change",this._periodChangeHandler);this._yearSelector=BX(r["year"]);BX.CrmWidgetConfigEditor.setupSelectOptions(this._yearSelector,this.prepareYearListItems());this._yearSelector.value=this._year;BX.bind(this._yearSelector,"change",this._yearChangeHandler);this._quarterSelector=BX(r["quarter"]);BX.CrmWidgetConfigEditor.setupSelectOptions(this._quarterSelector,this.prepareQuarterListItems());this._quarterSelector.value=this._quarter;BX.bind(this._quarterSelector,"change",this._quarterChangeHandler);this._monthSelector=BX(r["month"]);BX.CrmWidgetConfigEditor.setupSelectOptions(this._monthSelector,this.prepareMonthListItems());this._monthSelector.value=this._month;BX.bind(this._monthSelector,"change",this._monthChangeHandler);this.adjust()}BX.onCustomEvent(window,"CrmWidgetConfigPeriodEditorCreate",[this])},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmWidgetConfigPeriodEditor.messages;return e.hasOwnProperty(t)?e[t]:t},isNested:function(){return this._isNested},getDefaultPeriod:function(){return this.getSetting("defaultPeriodType",BX.CrmWidgetFilterPeriod.undefined)},getPeriod:function(){return this._period},setPeriod:function(t){this._period=t;this._periodSelector.value=t;this.adjust();this._changeNotifier.notify()},getYear:function(){return this._year},setYear:function(t){this._year=t;this._yearSelector.value=t;this._changeNotifier.notify()},getQuarter:function(){return this._quarter},setQuarter:function(t){this._quarter=t;this._quarterSelector.value=t;this._changeNotifier.notify()},getMonth:function(){return this._month},setMonth:function(t){this._month=t;this._monthSelector.value=t;this._changeNotifier.notify()},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},prepareYearListItems:function(){var t=[];for(var e=this._curYear-20;e<=this._curYear+20;e++){t.push({value:e.toString(),text:e.toString()})}return t},prepareQuarterListItems:function(){return[{value:"1",text:"I"},{value:"2",text:"II"},{value:"3",text:"III"},{value:"4",text:"IV"}]},prepareMonthListItems:function(){var t=[];var e=BX.CrmWidgetConfigPeriodEditor.getMonthNames();for(var i=1;i<=12;i++){t.push({value:i.toString(),text:e[i-1]})}return t},preparePeriodListItems:function(){return!this._isNested?BX.CrmWidgetFilterPeriod.prepareListItems({},!this._enableEmpty):this._enableEmpty?BX.CrmWidgetFilterPeriod.prepareListItems({"":this.getMessage("accordingToFilter")},false):BX.CrmWidgetFilterPeriod.prepareListItems({},true)},prepareLayout:function(t){this._periodSelector=BX.CrmWidgetConfigEditor.createSelect({events:{change:this._periodChangeHandler}},this.preparePeriodListItems());this._periodSelector.value=this._period;this._yearSelector=BX.CrmWidgetConfigEditor.createSelect({events:{change:this._yearChangeHandler}},this.prepareYearListItems());this._yearSelector.value=this._year;this._yearSelectorWrapper=BX.create("SPAN",{attrs:{className:"select-container select-container-period select-container-period-year"},children:[this._yearSelector]});this._quarterSelector=BX.CrmWidgetConfigEditor.createSelect({events:{change:this._quarterChangeHandler}},this.prepareQuarterListItems());this._quarterSelector.value=this._quarter;this._quarterSelectorWrapper=BX.create("SPAN",{attrs:{className:"select-container select-container-period select-container-period-quarter"},children:[this._quarterSelector]});this._monthSelector=BX.CrmWidgetConfigEditor.createSelect({events:{change:this._monthChangeHandler}},this.prepareMonthListItems());this._monthSelector.value=this._month;this._monthSelectorWrapper=BX.create("SPAN",{attrs:{className:"select-container select-container-period select-container-period-month"},children:[this._monthSelector]});t.appendChild(BX.create("DIV",{attrs:{className:"field-container field-container-period field-container-small field-container-left"},children:[BX.create("LABEL",{attrs:{className:"field-container-title"},text:this.getMessage("caption")+":"}),BX.create("SPAN",{attrs:{className:"select-container select-container-period"},children:[this._periodSelector]}),this._monthSelectorWrapper,this._quarterSelectorWrapper,this._yearSelectorWrapper]}));this.adjust()},resetLayout:function(){},saveConfig:function(){this._config["periodType"]=this._period;if(this._period===BX.CrmWidgetFilterPeriod.year||this._period===BX.CrmWidgetFilterPeriod.quarter||this._period===BX.CrmWidgetFilterPeriod.month){this._config["year"]=this._year}if(this._period===BX.CrmWidgetFilterPeriod.quarter){this._config["quarter"]=this._quarter}if(this._period===BX.CrmWidgetFilterPeriod.month){this._config["month"]=this._month}},getConfig:function(){return this._config},copyToConfig:function(t){if(this._config===t){return}var e=["periodType","year","quarter","month"];for(var i=0,r=e.length;i<r;i++){var n=e[i];if(this._config.hasOwnProperty(n)){t[n]=this._config[n]}else{delete t[n]}}},isEmpty:function(){return this._period===BX.CrmWidgetFilterPeriod.undefined},getDescription:function(){var t;if(this._period===BX.CrmWidgetFilterPeriod.undefined){return""}else if(this._period===BX.CrmWidgetFilterPeriod.year){return this.getMessage("yearDescription").replace(/#YEAR#/gi,this._year)}else if(this._period===BX.CrmWidgetFilterPeriod.quarter){var e=3*this._quarter;var i=e-2;t=BX.CrmWidgetConfigPeriodEditor.getMonthNames();return this.getMessage("quarterDescription").replace(/#YEAR#/gi,this._year).replace(/#FIRST_MONTH#/gi,t[i-1]).replace(/#LAST_MONTH#/gi,t[e-1])}else if(this._period===BX.CrmWidgetFilterPeriod.month){t=BX.CrmWidgetConfigPeriodEditor.getMonthNames();return this.getMessage("monthDescription").replace(/#YEAR#/gi,this._year).replace(/#MONTH#/gi,t[this._month-1])}else if(this._period===BX.CrmWidgetFilterPeriod.currentMonth){return BX.CrmWidgetFilterPeriod.getDescription(BX.CrmWidgetFilterPeriod.currentMonth).toLowerCase()}else if(this._period===BX.CrmWidgetFilterPeriod.currentQuarter){return BX.CrmWidgetFilterPeriod.getDescription(BX.CrmWidgetFilterPeriod.currentQuarter).toLowerCase()}else if(this._period===BX.CrmWidgetFilterPeriod.lastDays90){return this.getMessage("lastDaysDescription").replace(/#DAYS#/gi,90)}else if(this._period===BX.CrmWidgetFilterPeriod.lastDays60){return this.getMessage("lastDaysDescription").replace(/#DAYS#/gi,60)}else if(this._period===BX.CrmWidgetFilterPeriod.lastDays30){return this.getMessage("lastDaysDescription").replace(/#DAYS#/gi,30)}else if(this._period===BX.CrmWidgetFilterPeriod.lastDays7){return this.getMessage("lastDaysDescription").replace(/#DAYS#/gi,7)}else if(this._period===BX.CrmWidgetFilterPeriod.lastDays0){return BX.CrmWidgetFilterPeriod.getDescription(BX.CrmWidgetFilterPeriod.lastDays0).toLowerCase()}return""},adjust:function(){this._yearSelectorWrapper.style.display=this._period===BX.CrmWidgetFilterPeriod.year||this._period===BX.CrmWidgetFilterPeriod.quarter||this._period===BX.CrmWidgetFilterPeriod.month?"":"none";this._quarterSelectorWrapper.style.display=this._period===BX.CrmWidgetFilterPeriod.quarter?"":"none";this._monthSelectorWrapper.style.display=this._period===BX.CrmWidgetFilterPeriod.month?"":"none"},onPeriodChange:function(t){this._period=this._periodSelector.value;this.adjust();this._changeNotifier.notify()},onYearChange:function(t){this._year=parseInt(this._yearSelector.value);this._changeNotifier.notify()},onQuarterChange:function(t){this._quarter=parseInt(this._quarterSelector.value);this._changeNotifier.notify()},onMonthChange:function(t){this._month=parseInt(this._monthSelector.value);this._changeNotifier.notify()}};BX.CrmWidgetConfigPeriodEditor.monthNames=null;BX.CrmWidgetConfigPeriodEditor.getMonthNames=function(){if(!this.monthNames){this.monthNames=[];for(var t=1;t<=12;t++){this.monthNames.push(BX.message["MONTH_"+t.toString()])}}return this.monthNames};if(typeof BX.CrmWidgetConfigPeriodEditor.messages==="undefined"){BX.CrmWidgetConfigPeriodEditor.messages={}}BX.CrmWidgetConfigPeriodEditor.items={};BX.CrmWidgetConfigPeriodEditor.create=function(t,e){var i=new BX.CrmWidgetConfigPeriodEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmWidgetConfigTitleEditor==="undefined"){BX.CrmWidgetConfigTitleEditor=function(){this._id="";this._settings=null;this._config=null;this._mode=BX.CrmWidgetConfigControlMode.undifined;this._title="";this._titleBackgroundColor="";this._letter="";this._schemeId="";this._titleInput=null;this._titleEditButton=null;this._titleSaveButton=null;this._schemeSelectButton=null;this._enableScemeChange=true;this._deleteButton=null;this._enableDeletion=false;this._wrapper=null;this._titleViewContainer=null;this._titleEditContainer=null;this._titleWrapper=null;this._inputKeyDownHandler=BX.delegate(this.onInputKeyDown,this);this._titleEitButtonClickHandler=BX.delegate(this.onTitleEditButtonClick,this);this._titleSaveButtonClickHandler=BX.delegate(this.onTitleSaveButtonClick,this);this._schemeSelectButtonCkickHandler=BX.delegate(this.onSchemeSelectButtonClick,this);this._isSchemeMenuShown=false;this._schemeMenuId="";this._schemeMenu=null;this._schemeMenuHandler=BX.delegate(this.onSchemeMenuItemClick,this);this._schemeChangeNotifier=null;this._deleteButtonCkickHandler=BX.delegate(this.onDeleteButtonClick,this);this._deletionNotifier=null};BX.CrmWidgetConfigTitleEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._config=this.getSetting("config",{});this._title=BX.type.isNotEmptyString(this._config["title"])?this._config["title"]:"";this._letter=this.getSetting("letter","");this._titleBackgroundColor=this.getSetting("backgroundColor","#22d02c");if(BX.type.isPlainObject(this._config["display"])&&BX.type.isNotEmptyString(this._config["display"]["colorScheme"])){this._schemeId=this._config["display"]["colorScheme"];var i=BX.CrmWidgetColorScheme.getInfo(this._schemeId);if(i){this._titleBackgroundColor=i["color"]}}this._mode=BX.CrmWidgetConfigControlMode.view;this._enableScemeChange=this.getSetting("enableBackgroundColorChange",true);this._schemeChangeNotifier=BX.CrmNotifier.create(this);this._enableDeletion=this.getSetting("enableDeletion",false);this._deletionNotifier=BX.CrmNotifier.create(this)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmWidgetConfigTitleEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getId:function(){return this._id},getTitle:function(){return this._title},setTitle:function(t){this._title=t;if(this._titleInput){this._titleInput.value=t}if(this._titleViewContainer){this._titleViewContainer.innerHTML=BX.util.htmlspecialchars(t)}},getName:function(){return this._name},getTitleBackgroundColor:function(){return this._titleBackgroundColor},prepareLayout:function(t){this._titleEditButton=BX.create("SPAN",{attrs:{className:"field-title-icon-edit"},events:{click:this._titleEitButtonClickHandler}});this._titleSaveButton=BX.create("SPAN",{attrs:{className:"field-title-icon-ready"},events:{click:this._titleSaveButtonClickHandler},style:{display:"none"}});var e=this._title!==""?this._title:this.getMessage("untitled");this._titleViewContainer=BX.create("SPAN",{attrs:{className:"title-name"},text:e});this._titleInput=BX.create("INPUT",{props:{type:"text",placeholder:this.getTitle("placeholder")}});this._titleEditContainer=BX.create("SPAN",{attrs:{className:"fiedl-title-input-container"},children:[this._titleInput],style:{display:"none"}});var i=[];if(this._letter!==""){i.push(BX.create("SPAN",{attrs:{className:"field-title-letter"},text:this._letter}))}i.push(this._titleViewContainer);i.push(this._titleEditContainer);this._titleWrapper=BX.create("SPAN",{attrs:{className:"field-title-title-inner"},children:[BX.create("SPAN",{attrs:{className:"field-title-name"},children:i}),this._titleEditButton,this._titleSaveButton]});var r=BX.create("DIV",{attrs:{className:"field-title-panel"}});if(this._enableScemeChange){this._schemeSelectButton=BX.create("DIV",{attrs:{className:"field-title-panel-button field-title-button-bucket"},events:{click:this._schemeSelectButtonCkickHandler}});r.appendChild(this._schemeSelectButton)}if(this._enableDeletion){this._deleteButton=BX.create("DIV",{attrs:{className:"field-title-panel-button field-title-button-close"},events:{click:this._deleteButtonCkickHandler}});r.appendChild(this._deleteButton)}this._wrapper=BX.create("DIV",{attrs:{className:"field-title"},style:{backgroundColor:this._titleBackgroundColor},children:[r,BX.create("SPAN",{attrs:{className:"field-title-title"},children:[this._titleWrapper]})]});t.appendChild(this._wrapper);return t},resetLayout:function(){if(this._schemeMenu&&this._schemeMenu.popupWindow){this._schemeMenu.popupWindow.close()}if(this._titleEditButton){BX.unbind(this._titleEditButton,"click",this._titleEitButtonClickHandler);this._titleEditButton=null}if(this._titleSaveButton){BX.unbind(this._titleSaveButton,"click",this._titleSaveButtonClickHandler);this._titleSaveButton=null}if(this._schemeSelectButton){BX.unbind(this._schemeSelectButton,"click",this._schemeSelectButtonCkickHandler);this._schemeSelectButton=null}this._titleInput=null;this._titleWrapper=null;this._titleViewContainer=null;this._titleEditContainer=null;BX.cleanNode(this._wrapper,true);this._wrapper=null},getConfig:function(){return this._config},getColorSchemeId:function(){return this._schemeId},saveConfig:function(){if(this._mode===BX.CrmWidgetConfigControlMode.edit){this.saveInputValue();this.switchMode(BX.CrmWidgetConfigControlMode.view)}this._config["title"]=this._title;if(this._schemeId!==""){if(typeof this._config["display"]==="undefined"){this._config["display"]={}}this._config["display"]["colorScheme"]=this._schemeId}else if(typeof this._config["display"]!=="undefined"){delete this._config["display"]["colorScheme"]}},copyToConfig:function(t){t["title"]=this._config["title"];if(BX.type.isPlainObject(this._config["display"])&&BX.type.isNotEmptyString(this._config["display"]["colorScheme"])){if(typeof t["display"]==="undefined"){t["display"]={}}t["display"]["colorScheme"]=this._config["display"]["colorScheme"]}else if(BX.type.isPlainObject(t["display"])&&BX.type.isNotEmptyString(t["display"]["colorScheme"])){delete t["display"]["colorScheme"]}},switchMode:function(t){if(this._mode===t){return}if(t===BX.CrmWidgetConfigControlMode.view){BX.unbind(this._titleInput,"keydown",this._inputKeyDownHandler);this._titleInput.blur();BX.removeClass(this._titleWrapper,"input-container-edit");this._titleSaveButton.style.display="none";this._titleEditContainer.style.display="none";this._titleEditButton.style.display="";this._titleViewContainer.style.display=""}else if(t===BX.CrmWidgetConfigControlMode.edit){BX.addClass(this._titleWrapper,"input-container-edit");this._titleEditButton.style.display="none";this._titleViewContainer.style.display="none";this._titleSaveButton.style.display="";this._titleEditContainer.style.display="";BX.bind(this._titleInput,"keydown",this._inputKeyDownHandler);this._titleInput.focus()}this._mode=t},addColorSchemeChangeListener:function(t){this._schemeChangeNotifier.addListener(t)},removeColorSchemeChangeListener:function(t){this._schemeChangeNotifier.removeListener(t)},addDeletionListener:function(t){this._deletionNotifier.addListener(t)},removeDeletionListener:function(t){this._deletionNotifier.removeListener(t)},onTitleEditButtonClick:function(t){this.initInputValue();this.switchMode(BX.CrmWidgetConfigControlMode.edit)},onTitleSaveButtonClick:function(t){this.saveInputValue();this.switchMode(BX.CrmWidgetConfigControlMode.view)},saveInputValue:function(){this._title=this._titleInput.value;this._titleViewContainer.innerHTML=this._title!==""?BX.util.htmlspecialchars(this._title):this.getMessage("untitled")},initInputValue:function(){this._titleInput.value=this._title},onInputKeyDown:function(t){if(this._mode!==BX.CrmWidgetConfigControlMode.edit){return}t=t||window.event;if(t.keyCode===13){this.saveInputValue();this.switchMode(BX.CrmWidgetConfigControlMode.view)}else if(t.keyCode===27){this.switchMode(BX.CrmWidgetConfigControlMode.view)}},onSchemeSelectButtonClick:function(t){if(!this._isSchemeMenuShown){this.openSchemeMenu()}else{this.closeSchemeMenu()}},onDeleteButtonClick:function(t){this._deletionNotifier.notify()},openSchemeMenu:function(){if(this._isSchemeMenuShown){return}this._schemeMenuId=this._id+"_scheme_menu";if(typeof BX.PopupMenu.Data[this._schemeMenuId]!=="undefined"){BX.PopupMenu.Data[this._schemeMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._schemeMenuId]}this._schemeMenu=BX.PopupMenu.create(this._schemeMenuId,this._schemeSelectButton,BX.CrmWidgetColorScheme.prepareMenuItems(this._schemeMenuHandler),{autoHide:true,offsetLeft:-21,offsetTop:-3,angle:{position:"top",offset:42},events:{onPopupClose:BX.delegate(this.onSchemeMenuClose,this)}});this._schemeMenu.popupWindow.show();this._isSchemeMenuShown=true},closeSchemeMenu:function(){if(this._schemeMenu&&this._schemeMenu.popupWindow){this._schemeMenu.popupWindow.close()}},onSchemeMenuClose:function(){this._schemeMenu=null;if(typeof BX.PopupMenu.Data[this._schemeMenuId]!=="undefined"){BX.PopupMenu.Data[this._schemeMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._schemeMenuId]}this._isSchemeMenuShown=false},onSchemeMenuItemClick:function(t,e){this._schemeId=e.id;var i=BX.CrmWidgetColorScheme.getInfo(this._schemeId);if(i&&this._wrapper){this._wrapper.style.backgroundColor=this._titleBackgroundColor=i["color"]}this.closeSchemeMenu();this._schemeChangeNotifier.notify()}};if(typeof BX.CrmWidgetConfigTitleEditor.messages==="undefined"){BX.CrmWidgetConfigTitleEditor.messages={}}BX.CrmWidgetConfigTitleEditor.create=function(t,e){var i=new BX.CrmWidgetConfigTitleEditor;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetConfigPresetEditor==="undefined"){BX.CrmWidgetConfigPresetEditor=function(){this._id="";this._settings=null;this._config=null;this._entityTypeName="";this._isSemanticsSupported=true;this._extraGrouping="";this._contextId="";this._enableContextChange=true;this._semanticId="";this._categoryName="";this._preset=null;this._typeSelector=null;this._enableSemanticsChange=true;this._presetSelector=null;this._contextSwitches={};this._contextChangeHandler=BX.delegate(this.onContextChange,this);this._typeChangeHandler=BX.delegate(this.onTypeChange,this);this._presetChangeHandler=BX.delegate(this.onPresetChange,this);this._presetChangeCallback=null;this._extraEditors=null;this._container=null;this._semanticsWrapper=null;this._presetWrapper=null;this._hasLayout=false};BX.CrmWidgetConfigPresetEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._config=this.getSetting("config",{});this._preset=BX.CrmWidgetDataPreset.getItem(BX.type.isNotEmptyString(this._config["dataPreset"])?this._config["dataPreset"]:this._config["name"]);this._entityTypeName=this._preset&&BX.type.isNotEmptyString(this._preset["entity"])?this._preset["entity"]:this.getSetting("entityTypeName","");this._isSemanticsSupported=BX.CrmPhaseSemantics.isSupported(this._entityTypeName);if(this._isSemanticsSupported){var i=BX.type.isPlainObject(this._config["filter"])?this._config["filter"]:{};this._semanticId=BX.type.isNotEmptyString(i["semanticID"])?i["semanticID"]:""}this._extraGrouping=this.getSetting("extraGrouping","");this._contextId=this.getSetting("context",BX.CrmWidgetDataContext.undefined);if(this._contextId===BX.CrmWidgetDataContext.undefined){this._contextId=this._preset?this._preset["context"]:BX.CrmWidgetDataContext.entity}this._categoryName=this.getSetting("category","");if(this._categoryName===""){this._categoryName=this._preset&&BX.type.isNotEmptyString(this._preset["category"])?this._preset["category"]:""}this._presetChangeCallback=this.getSetting("presetChange",null);this._enableContextChange=this.getSetting("enableContextChange",true);this._extraEditors=this.getSetting("extraEditors");if(!BX.type.isArray(this._extraEditors)){this._extraEditors=[]}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmWidgetConfigPresetEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getId:function(){return this._id},prepareLayout:function(t,e){if(this._hasLayout){return}this._container=t;var i=null;if(this._enableContextChange){i=BX.create("SPAN",{attrs:{className:"radiobox-container"}});var r=BX.CrmWidgetDataContext.descriptions;for(var n in r){if(!r.hasOwnProperty(n)||n===BX.CrmWidgetDataContext.undefined){continue}var s=r[n];var o=this.getId()+"_data_context";var a=o+"_"+n.toLowerCase();this._contextSwitches[n]=BX.create("INPUT",{props:{type:"radio",id:a,name:o},events:{click:this._contextChangeHandler}});if(this._contextId===n){this._contextSwitches[n].checked=true}i.appendChild(this._contextSwitches[n]);i.appendChild(BX.create("LABEL",{attrs:{for:a},text:s}))}}var h="";var l=[{value:"",text:this.getMessage("notSelected")}];if(this._isSemanticsSupported){h=BX.CrmPhaseSemantics.getSelectorTitle(this._entityTypeName);if(h===""){h=this.getMessage("semanticsCaption")}var g=BX.CrmPhaseSemantics.prepareListItems(this._entityTypeName);var d=BX.CrmPhaseSemantics.getGroupTitle(this._entityTypeName);for(var c=0;c<g.length;c++){var p=g[c];if(p["value"]!==""){p["attrs"]={context:"semantics"};p["group"]=d;l.push(p)}}}else{h=BX.CrmWidgetDataCategory.selectorTitle}if(h===""){h=this.getMessage("categoryCaption")}var u=BX.CrmWidgetDataCategory.prepareListItems(this._entityTypeName);var f,_;if(this._isSemanticsSupported){for(f=0;f<u.length;f++){_=u[f];if(_["value"]===""){continue}_["attrs"]={context:"category"};_["group"]=BX.CrmWidgetDataCategory.groupTitle;l.push(_)}}else{for(f=0;f<u.length;f++){_=u[f];if(_["value"]!==""){l.push(_)}}}this._typeSelector=BX.CrmWidgetConfigEditor.createSelect({events:{change:this._typeChangeHandler}},l);if(this._semanticId!==""){this._typeSelector.value=this._semanticId}else if(this._categoryName!==""){this._typeSelector.value=this._categoryName}this.adjustTypeSelector();this._presetSelector=BX.CrmWidgetConfigEditor.createSelect({events:{change:this._presetChangeHandler}},BX.CrmWidgetDataPreset.prepareListItems(this._entityTypeName,this._categoryName,this._contextId,this._extraGrouping));if(this._preset){this._presetSelector.value=this._preset["name"]}if(!BX.type.isNotEmptyString(e)){e=""}var m=BX.type.isPlainObject(this._config["filter"])?this._config["filter"]:{};var C=this._extraEditors.length;if(e==="wide"){this._semanticsWrapper=BX.create("DIV",{attrs:{className:"field-container field-container-left"},children:[BX.create("LABEL",{attrs:{className:"field-container-title"},text:h+":"}),BX.create("SPAN",{attrs:{className:"select-container"},children:[this._typeSelector]})]});t.appendChild(this._semanticsWrapper);this._presetWrapper=BX.create("DIV",{attrs:{className:"field-container field-container-right"},children:[BX.create("LABEL",{attrs:{className:"field-container-title"},text:this.getMessage("nameCaption")+":"}),BX.create("SPAN",{attrs:{className:"select-container"},children:[this._presetSelector]})]});t.appendChild(this._presetWrapper);if(this._enableContextChange){t.appendChild(BX.create("DIV",{attrs:{className:"field-container field-container-left"},children:[i]}))}var y=this._enableContextChange?["right","left"]:["left","right"];for(var B=0;B<C;B++){this._extraEditors[B].setConfig(m);this._extraEditors[B].prepareLayout(t,y[B%2===0?0:1])}}else{this._semanticsWrapper=BX.create("DIV",{attrs:{className:"field-container"},children:[BX.create("LABEL",{attrs:{className:"field-container-title"},text:h+":"}),BX.create("SPAN",{attrs:{className:"select-container"},children:[this._typeSelector]})]});t.appendChild(this._semanticsWrapper);if(this._enableContextChange){t.appendChild(BX.create("DIV",{attrs:{className:"field-container"},children:[i]}))}this._presetWrapper=BX.create("DIV",{attrs:{className:"field-container"},children:[BX.create("LABEL",{attrs:{className:"field-container-title"},text:this.getMessage("nameCaption")+":"}),BX.create("SPAN",{attrs:{className:"select-container"},children:[this._presetSelector]})]});t.appendChild(this._presetWrapper);for(var X=0;X<C;X++){var v=BX.create("DIV",{attrs:{className:"field-container"}});t.appendChild(v);this._extraEditors[X].setConfig(m);this._extraEditors[X].prepareLayout(v,"")}}this._hasLayout=true},resetLayout:function(){if(!this._hasLayout){return}if(this._presetSelector){BX.unbind(this._presetSelector,"change",this._presetChangeHandler);this._presetSelector=null}if(this._typeSelector){BX.unbind(this._typeSelector,"change",this._typeChangeHandler);this._typeSelector=null}for(var t in this._contextSwitches){if(!this._contextSwitches.hasOwnProperty(t)){continue}BX.unbind(this._contextSwitches[t],"click",this._contextChangeHandler)}this._contextSwitches={};for(var e=0,i=this._extraEditors.length;e<i;e++){this._extraEditors[e].resetLayout()}this._semanticsWrapper=this._presetWrapper=null;BX.cleanNode(this._container,false);this._hasLayout=false},getContextId:function(){return this._preset?this._preset["context"]:this._contextId},setContextId:function(t){if(this._contextId===t){return}this._contextId=t;this.adjustTypeSelector();BX.CrmWidgetConfigEditor.setupSelectOptions(this._presetSelector,BX.CrmWidgetDataPreset.prepareListItems(this._entityTypeName,this._categoryName,this._contextId,this._extraGrouping))},getExtraGrouping:function(){return this._extraGrouping},setExtraGrouping:function(t){if(this._extraGrouping===t){return}this._extraGrouping=t;this.adjustTypeSelector();BX.CrmWidgetConfigEditor.setupSelectOptions(this._presetSelector,BX.CrmWidgetDataPreset.prepareListItems(this._entityTypeName,this._categoryName,this._contextId,this._extraGrouping))},saveConfig:function(){if(this._isSemanticsSupported){if(this._semanticId!==BX.CrmPhaseSemantics.undefined){if(!BX.type.isPlainObject(this._config["filter"])){this._config["filter"]={}}this._config["filter"]["semanticID"]=this._semanticId}else if(BX.type.isPlainObject(this._config["filter"])){delete this._config["filter"]["semanticID"]}}if(this._preset){if(this._config["title"]===""){this._config["title"]=this._preset["title"]}this._config["dataPreset"]=this._preset["name"];this._config["dataSource"]=this._preset["source"];this._config["select"]=this._preset["select"];var t=this.getContextId();if(t===BX.CrmWidgetDataContext.fund){if(!BX.type.isPlainObject(this._config["format"])){this._config["format"]={}}this._config["format"]["isCurrency"]="Y";this._config["format"]["enableDecimals"]="N"}else if(BX.type.isPlainObject(this._config["format"])){delete this._config["format"]["isCurrency"];delete this._config["format"]["enableDecimals"]}if(t===BX.CrmWidgetDataContext.percent){if(!BX.type.isPlainObject(this._config["format"])){this._config["format"]={}}this._config["format"]["isPercent"]="Y"}else if(BX.type.isPlainObject(this._config["format"])){delete this._config["format"]["isPercent"]}}if(this._extraEditors.length>0){if(!BX.type.isPlainObject(this._config["filter"])){this._config["filter"]={}}for(var e=0,i=this._extraEditors.length;e<i;e++){this._extraEditors[e].saveConfig();this._extraEditors[e].copyToConfig(this._config["filter"])}}},getConfig:function(){return this._config},adjustTypeSelector:function(){var t=false;for(var e=0,i=this._typeSelector.options.length;e<i;e++){var r=this._typeSelector.options[e];if(this._isSemanticsSupported&&r.getAttribute("data-context","")!=="category"){continue}var n=r.value;if(n===""){continue}var s=!BX.CrmWidgetDataPreset.hasItems(this._entityTypeName,n,this._contextId,this._extraGrouping);r.disabled=s;if(s&&e===this._typeSelector.selectedIndex){t=true}}if(t){this._typeSelector.value="";this.onTypeChange()}},onContextChange:function(t){if(this._contextId!==BX.CrmWidgetDataContext.fund&&this._contextSwitches[BX.CrmWidgetDataContext.fund].checked){this.setContextId(BX.CrmWidgetDataContext.fund)}else if(this._contextId!==BX.CrmWidgetDataContext.entity&&this._contextSwitches[BX.CrmWidgetDataContext.entity].checked){this.setContextId(BX.CrmWidgetDataContext.entity)}else if(this._contextId!==BX.CrmWidgetDataContext.percent&&this._contextSwitches[BX.CrmWidgetDataContext.percent].checked){this.setContextId(BX.CrmWidgetDataContext.percent)}},onTypeChange:function(t){if(!this._hasLayout){return}var e=this._typeSelector.selectedIndex;var i=e>=0?this._typeSelector.options[e]:null;if(!i){this._semanticId=BX.CrmPhaseSemantics.undefined;this._categoryName=""}else{if(!this._isSemanticsSupported){this._semanticId=BX.CrmPhaseSemantics.undefined;this._categoryName=i.value}else{var r=i.getAttribute("data-context","");if(r==="category"){this._semanticId=BX.CrmPhaseSemantics.undefined;this._categoryName=i.value}else{this._semanticId=i.value;this._categoryName=""}}}var n=this._presetSelector.value;BX.CrmWidgetConfigEditor.setupSelectOptions(this._presetSelector,BX.CrmWidgetDataPreset.prepareListItems(this._entityTypeName,this._categoryName,this._contextId,this._extraGrouping));for(var s=0;s<this._presetSelector.options.length;s++){if(this._presetSelector.options[s].value===n){this._presetSelector.value=n;break}}},onPresetChange:function(t){this._preset=BX.CrmWidgetDataPreset.getItem(this._presetSelector.value);if(BX.type.isFunction(this._presetChangeCallback)){this._presetChangeCallback(this,this._preset)}}};if(typeof BX.CrmWidgetConfigPresetEditor.messages==="undefined"){BX.CrmWidgetConfigPresetEditor.messages={}}BX.CrmWidgetConfigPresetEditor.create=function(t,e){var i=new BX.CrmWidgetConfigPresetEditor;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetConfigGroupingEditor==="undefined"){BX.CrmWidgetConfigGroupingEditor=function(){this._id="";this._settings=null;this._config=null;this._control=null;this._grouping="";this._groupingSelector=null;this._groupingChangeHandler=BX.delegate(this.onGroupingChange,this);this._changeNotifier=null};BX.CrmWidgetConfigGroupingEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._control=this.getSetting("control",null);if(!this._control){throw"BX.CrmWidgetConfigGroupingEditor: Could not find 'control' parameter."}this._config=this.getSetting("config",{});this._grouping=BX.type.isNotEmptyString(this._config["group"])?this._config["group"].toUpperCase():"";if(this._grouping===""){var i=BX.type.isArray(this._config["configs"])?this._config["configs"]:[];var r=i.length>0?i[0]:null;if(r&&BX.type.isNotEmptyString(r["group"])){this._grouping=r["group"].toUpperCase()}}if(this._grouping===""){this._grouping=this._control.getDefault()}this._changeNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmWidgetConfigGroupingEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getGrouping:function(){return this._grouping},getExtraGrouping:function(){return this._grouping!==""&&!this._control.isCommonGrouping(this._grouping)?this._grouping:""},isExtraGrouping:function(){return!this._control.isCommonGrouping(this._grouping)},prepareLayout:function(t,e){this._groupingSelector=BX.CrmWidgetConfigEditor.createSelect({events:{change:this._groupingChangeHandler}},this._control.prepareListItems());this._groupingSelector.value=this._grouping;var i="field-container";if(BX.type.isNotEmptyString(e)){if(e==="left"){i+=" field-container-left"}else if(e==="right"){i+=" field-container-right"}}t.appendChild(BX.create("DIV",{attrs:{className:i},children:[BX.create("LABEL",{attrs:{className:"field-container-title"},text:this.getMessage("caption")+":"}),BX.create("SPAN",{attrs:{className:"select-container select-container-period"},children:[this._groupingSelector]})]}))},resetLayout:function(){if(this._groupingSelector){BX.unbind(this._groupingSelector,"change",this._groupingChangeHandler);this._groupingSelector=null}},saveConfig:function(){this._config["group"]=this._grouping;var t=BX.type.isArray(this._config["configs"])?this._config["configs"]:[];for(var e=0,i=t.length;e<i;e++){if(typeof t[e]["group"]!=="undefined"){delete t[e]["group"]}}},getConfig:function(){return this._config},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},onGroupingChange:function(t){this._grouping=this._groupingSelector.value;var e={grouping:this._grouping,isExtra:!this._control.isCommonGrouping(this._grouping)};this._changeNotifier.notify([e])}};if(typeof BX.CrmWidgetConfigGroupingEditor.messages==="undefined"){BX.CrmWidgetConfigGroupingEditor.messages={}}BX.CrmWidgetConfigGroupingEditor.create=function(t,e){var i=new BX.CrmWidgetConfigGroupingEditor;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetConfigContextEditor==="undefined"){BX.CrmWidgetConfigContextEditor=function(){this._id="";this._settings=null;this._config=null;this._contextId=BX.CrmWidgetDataContext.undefined;this._contextSwitches={};this._contextChangeHandler=BX.delegate(this.onContextChange,this);this._contextChangeCallback=null};BX.CrmWidgetConfigContextEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._config=this.getSetting("config",{});this._contextId=BX.type.isNotEmptyString(this._config["context"])?this._config["context"]:BX.CrmWidgetDataContext.entity;this._contextChangeCallback=this.getSetting("contextChange",null)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},prepareLayout:function(t,e){var i=BX.create("SPAN",{attrs:{className:"radiobox-container"}});var r=BX.CrmWidgetDataContext.descriptions;for(var n in r){if(!r.hasOwnProperty(n)||n===BX.CrmWidgetDataContext.undefined){continue}var s=r[n];var o=this.getId()+"_data_context";var a=o+"_"+n.toLowerCase();this._contextSwitches[n]=BX.create("INPUT",{props:{type:"radio",id:a,name:o},events:{click:this._contextChangeHandler}});if(this._contextId===n){this._contextSwitches[n].checked=true}i.appendChild(this._contextSwitches[n]);i.appendChild(BX.create("LABEL",{attrs:{for:a},text:s}))}var h="field-container";if(BX.type.isNotEmptyString(e)){if(e==="left"){h+=" field-container-left"}else if(e==="right"){h+=" field-container-right"}}t.appendChild(BX.create("DIV",{attrs:{className:h},children:[i]}))},resetLayout:function(){for(var t in this._contextSwitches){if(!this._contextSwitches.hasOwnProperty(t)){continue}BX.unbind(this._contextSwitches[t],"click",this._contextChangeHandler)}this._contextSwitches={}},getContextId:function(){return this._contextId},setContextId:function(t){if(this._contextId===t){return}this._contextId=t;if(BX.type.isFunction(this._contextChangeCallback)){this._contextChangeCallback(this,this._contextId)}},saveConfig:function(){this._config["context"]=this._contextId},getConfig:function(){return this._config},onContextChange:function(t){if(this._contextId!==BX.CrmWidgetDataContext.fund&&this._contextSwitches[BX.CrmWidgetDataContext.fund].checked){this.setContextId(BX.CrmWidgetDataContext.fund)}else if(this._contextId!==BX.CrmWidgetDataContext.entity&&this._contextSwitches[BX.CrmWidgetDataContext.entity].checked){this.setContextId(BX.CrmWidgetDataContext.entity)}else if(this._contextId!==BX.CrmWidgetDataContext.percent&&this._contextSwitches[BX.CrmWidgetDataContext.percent].checked){this.setContextId(BX.CrmWidgetDataContext.percent)}}};BX.CrmWidgetConfigContextEditor.create=function(t,e){var i=new BX.CrmWidgetConfigContextEditor;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetConfigSelectListEditor==="undefined"){BX.CrmWidgetConfigSelectListEditor=function(){this._id="";this._settings=null;this._configParamName="";this._configParamCaption="";this._config=null;this._listItems=null;this._selector=null;this._selectorChangeHandler=BX.delegate(this.onSelectorChange,this);this._defaultValue="";this._selectedValue="";this._changeNotifier=null};BX.CrmWidgetConfigSelectListEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._configParamName=this.getSetting("configParamName");if(!BX.type.isNotEmptyString(this._configParamName)){throw"BX.CrmWidgetConfigSelectListEditor: Could not find configParamName parameter."}this._configParamCaption=this.getSetting("configParamCaption");if(!BX.type.isNotEmptyString(this._configParamCaption)){this._configParamCaption=this._configParamName}this._defaultValue=this.getSetting("defaultValue","");this._listItems=this.getSetting("listItems");if(!BX.type.isArray(this._listItems)){this._listItems=[]}this.setConfig(this.getSetting("config",{}));this._changeNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getSelectedValue:function(){return this._selectedValue},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},prepareLayout:function(t,e){this._selector=BX.CrmWidgetConfigEditor.createSelect({events:{change:this._selectorChangeHandler}},this._listItems);this._selector.value=this._selectedValue;var i="field-container";if(BX.type.isNotEmptyString(e)){if(e==="left"){i+=" field-container-left"}else if(e==="right"){i+=" field-container-right"}}t.appendChild(BX.create("DIV",{attrs:{className:i},children:[BX.create("LABEL",{attrs:{className:"field-container-title"},text:this._configParamCaption+":"}),BX.create("SPAN",{attrs:{className:"select-container"},children:[this._selector]})]}))},resetLayout:function(){},saveConfig:function(){var t=this._selectedValue;if(t!==""){this._config[this._configParamName]=t}else if(typeof this._config[this._configParamName]!=="undefined"){delete this._config[this._configParamName]}},copyToConfig:function(t){if(this._config===t){return}if(typeof this._config[this._configParamName]!=="undefined"){t[this._configParamName]=this._config[this._configParamName]}else if(typeof t[this._configParamName]!=="undefined"){delete t[this._configParamName]}},setConfig:function(t){this._config=BX.type.isPlainObject(t)?t:{};this._selectedValue=BX.type.isNotEmptyString(this._config[this._configParamName])?this._config[this._configParamName]:this._defaultValue},getConfig:function(){return this._config},isEmpty:function(){return this._selectedValue===""},onSelectorChange:function(t){this._selectedValue=this._selector.value;this._changeNotifier.notify()}};BX.CrmWidgetConfigSelectListEditor.items={};BX.CrmWidgetConfigSelectListEditor.create=function(t,e){var i=new BX.CrmWidgetConfigSelectListEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmRatingWidgetConfigEditor==="undefined"){BX.CrmRatingWidgetConfigEditor=function(){BX.CrmRatingWidgetConfigEditor.superclass.constructor.apply(this);this._config=null;this._titleEditor=null;this._presetEditor=null;this._presetChangeHandler=BX.delegate(this.onPresetChange,this)};BX.extend(BX.CrmRatingWidgetConfigEditor,BX.CrmWidgetConfigEditor);BX.CrmRatingWidgetConfigEditor.prototype.innerPrepareDialogContent=function(t){this._titleEditor=BX.CrmWidgetConfigTitleEditor.create(this._id,{config:this._config,backgroundColor:"#43a4af",enableBackgroundColorChange:false});var e=BX.type.isArray(this._config["configs"])&&this._config["configs"].length>0?this._config["configs"][0]:{};this._presetEditor=BX.CrmWidgetManager.getCurrent().createPresetEditor(this._entityTypeName,this._widget.getTypeName(),this._id,{config:e,presetChange:this._presetChangeHandler,entityTypeName:this.getEntityTypeName()});var i=BX.create("DIV",{attrs:{className:"container-item container-item-center"}});t.appendChild(i);this._titleEditor.prepareLayout(i);this._presetEditor.prepareLayout(i,"wide");return t};BX.CrmRatingWidgetConfigEditor.prototype.innerSaveConfig=function(){this._titleEditor.saveConfig();this._config["title"]=this._titleEditor.getTitle();this._presetEditor.saveConfig();this._config["configs"]=[this._presetEditor.getConfig()]};BX.CrmRatingWidgetConfigEditor.prototype.reset=function(){this._titleEditor.resetLayout();this._titleEditor=null;this._presetEditor.resetLayout();this._presetEditor=null;this._period.resetLayout();this._period=null};BX.CrmRatingWidgetConfigEditor.prototype.onPresetChange=function(t,e){if(e&&BX.type.isNotEmptyString(e["title"])&&this._titleEditor){this._titleEditor.setTitle(e["title"])}};BX.CrmRatingWidgetConfigEditor.create=function(t,e){var i=new BX.CrmRatingWidgetConfigEditor;i.initialize(t,e);return i}}if(typeof BX.CrmNumericWidgetConfigEditor==="undefined"){BX.CrmNumericWidgetConfigEditor=function(){BX.CrmNumericWidgetConfigEditor.superclass.constructor.apply(this);this._fields=[]};BX.extend(BX.CrmNumericWidgetConfigEditor,BX.CrmWidgetConfigEditor);BX.CrmNumericWidgetConfigEditor.prototype.innerPrepareDialogContent=function(t){var e=BX.type.isArray(this._config["configs"])?this._config["configs"]:[];var i,r;var n="";if(e.length===1){n="#43a4af"}for(i=0;i<e.length;i++){var s=e[i];var o=this._id+"_"+i;var a={config:s,index:i,parent:this,titleBackgroundColor:n,entityTypeName:this.getEntityTypeName()};this._fields.push(BX.CrmNumericWidgetConfigExpressionFieldEditor.isExpression(s)?BX.CrmNumericWidgetConfigExpressionFieldEditor.create(o,a):BX.CrmNumericWidgetConfigPresetFieldEditor.create(o,a))}for(i=0;i<this._fields.length;i++){this._fields[i].postInitialize()}var h=null;var l=[];for(i=0;i<this._fields.length;i++){var g=this._fields[i];if(i===0){t.appendChild(g.prepareLayout(BX.create("DIV",{attrs:{className:"container-item"}}),"wide"))}else{if(!h){h=BX.create("DIV",{attrs:{className:"container-item-wrapper"}});t.appendChild(h)}var d=BX.create("DIV",{attrs:{className:"container-item container-item-5 "+(i%2>0?"container-item-first":"container-item-second")}});h.appendChild(d);g.prepareLayout(d)}g.prepareExtraControls(l)}if(l.length>0){for(i=0;i<l.length;i++){var c=l[i];if(!BX.type.isArray(c["controls"])){continue}if(BX.type.isNotEmptyString(c["type"])&&c["type"]==="action"){var p=BX.create("DIV",{attrs:{className:"action-container"}});for(r=0;r<c["controls"].length;r++){p.appendChild(c["controls"][r])}if(h){t.insertBefore(p,h)}else{t.appendChild(p)}}else{for(r=0;r<c["controls"].length;r++){t.appendChild(c["controls"][r])}}}}return t};BX.CrmNumericWidgetConfigEditor.prototype.getFieldByName=function(t){for(var e=0;e<this._fields.length;e++){var i=this._fields[e];if(t===i.getName()){return i}}return null};BX.CrmNumericWidgetConfigEditor.prototype.getFields=function(){return this._fields};BX.CrmNumericWidgetConfigEditor.prototype.innerSaveConfig=function(){for(var t=0;t<this._fields.length;t++){this._fields[t].saveConfig();this._config["configs"][t]=this._fields[t].getConfig()}};BX.CrmNumericWidgetConfigEditor.prototype.reset=function(){for(var t=0;t<this._fields.length;t++){this._fields[t].resetLayout()}this._fields=[];this._period.resetLayout();this._period=null};BX.CrmNumericWidgetConfigEditor.create=function(t,e){var i=new BX.CrmNumericWidgetConfigEditor;i.initialize(t,e);return i}}if(typeof BX.CrmPieWidgetConfigEditor==="undefined"){BX.CrmPieWidgetConfigEditor=function(){BX.CrmPieWidgetConfigEditor.superclass.constructor.apply(this);this._field=null;this._grouping=null;this._groupingChangeHandler=BX.delegate(this.onGroupingChange,this)};BX.extend(BX.CrmPieWidgetConfigEditor,BX.CrmWidgetConfigEditor);BX.CrmPieWidgetConfigEditor.prototype.innerPrepareDialogContent=function(t){this._grouping=BX.CrmWidgetConfigGroupingEditor.create(this._id,{config:this._config,control:BX.CrmWidgetDataGroup.create({entityTypeName:this.getEntityTypeName()})});this._grouping.prepareLayout(this._leadingWrapper,"right");this._grouping.addChangeListener(this._groupingChangeHandler);var e=this._grouping.getExtraGrouping();var i=BX.type.isArray(this._config["configs"])?this._config["configs"]:[];var r=i.length>0?i[0]:null;if(r){var n=this._id+"_1";var s={config:r,extraGrouping:e,parent:this,isNew:false,index:0,titleBackgroundColor:"",entityTypeName:this.getEntityTypeName()};this._field=BX.CrmPieWidgetConfigFieldEditor.create(n,s);t.appendChild(this._field.prepareLayout(BX.create("DIV",{attrs:{className:"container-item"}}),"wide"))}return t};BX.CrmPieWidgetConfigEditor.prototype.innerSaveConfig=function(){this._grouping.saveConfig();this._field.saveConfig();this._config["configs"]=[this._field.getConfig()]};BX.CrmPieWidgetConfigEditor.prototype.reset=function(){this._field.resetLayout();this._field=null;this._grouping.resetLayout();this._grouping=null};BX.CrmPieWidgetConfigEditor.prototype.onGroupingChange=function(t,e){var i=e["isExtra"]?e["grouping"]:"";this._field.setExtraGrouping(i)};BX.CrmPieWidgetConfigEditor.create=function(t,e){var i=new BX.CrmPieWidgetConfigEditor;i.initialize(t,e);return i}}if(typeof BX.CrmGraphWidgetConfigEditor==="undefined"){BX.CrmGraphWidgetConfigEditor=function(){BX.CrmGraphWidgetConfigEditor.superclass.constructor.apply(this);this._grouping=null;this._context=null;this._fields=[];this._maxGraphCount=0;this._buttonContainer=null;this._addButton=null;this._contextChangeHandler=BX.delegate(this.onContextChange,this);this._fieldDeletionHandler=BX.delegate(this.onFieldDelete,this);this._addButtonClickHandler=BX.delegate(this.onAddButtonClick,this);this._groupingChangeHandler=BX.delegate(this.onGroupingChange,this)};BX.extend(BX.CrmGraphWidgetConfigEditor,BX.CrmWidgetConfigEditor);BX.CrmGraphWidgetConfigEditor.prototype.doInitialize=function(){this._maxGraphCount=parseInt(this.getSetting("maxGraphCount",0));if(isNaN(this._maxGraphCount)){this._maxGraphCount=0}};BX.CrmGraphWidgetConfigEditor.prototype.innerPrepareDialogContent=function(t){this._grouping=BX.CrmWidgetConfigGroupingEditor.create(this._id,{config:this._config,control:BX.CrmWidgetDataGroup.create({entityTypeName:this.getEntityTypeName()})});this._grouping.prepareLayout(this._leadingWrapper,"left");this._grouping.addChangeListener(this._groupingChangeHandler);this._context=BX.CrmWidgetConfigContextEditor.create(this._id,{config:this._config,contextChange:this._contextChangeHandler});this._context.prepareLayout(this._leadingWrapper,"right");var e=this._context.getContextId();var i=this._grouping.getExtraGrouping();var r=BX.type.isArray(this._config["configs"])?this._config["configs"]:[];var n=this._maxGraphCount>0&&r.length<this._maxGraphCount?r.length:this._maxGraphCount;for(var s=0;s<n;s++){var o=r[s];var a=this._id+"_"+(s+1).toString();var h={config:o,extraGrouping:i,context:e,parent:this,isNew:false,index:s,titleBackgroundColor:"",entityTypeName:this.getEntityTypeName()};this._fields.push(BX.CrmGraphWidgetConfigFieldEditor.create(a,h))}for(var l=0;l<this._fields.length;l++){var g=this._fields[l];g.addDeletionListener(this._fieldDeletionHandler);t.appendChild(g.prepareLayout(BX.create("DIV",{attrs:{className:"container-item"}}),"wide"))}this._addButton=BX.create("A",{attrs:{className:"field-link",href:"#"},text:this.getMessage("addGraph")});this._buttonContainer=BX.create("DIV",{attrs:{className:"container-item container-item-button"},children:[this._addButton]});BX.bind(this._addButton,"click",this._addButtonClickHandler);t.appendChild(this._buttonContainer);return t};BX.CrmGraphWidgetConfigEditor.prototype.getMessage=function(t){if(BX.CrmGraphWidgetConfigEditor.messages.hasOwnProperty(t)){return BX.CrmGraphWidgetConfigEditor.messages[t]}return BX.CrmGraphWidgetConfigEditor.superclass.getMessage.apply(this,[t])};BX.CrmGraphWidgetConfigEditor.prototype.getFieldByName=function(t){for(var e=0;e<this._fields.length;e++){var i=this._fields[e];if(t===i.getName()){return i}}return null};BX.CrmGraphWidgetConfigEditor.prototype.getFields=function(){return this._fields};BX.CrmGraphWidgetConfigEditor.prototype.createField=function(){var t=0;for(var e=0;e<this._fields.length;e++){if(!this._fields[e].isDeleted()){t++}}if(t>=this._maxGraphCount){alert(this.getMessage("maxGraphError").replace(/#MAX_GRAPH_COUNT#/gi,this._maxGraphCount));return}var i=this._fields.length;var r=this._id+"_"+(i+1).toString();var n={config:{name:"param"+(i+1).toString()},extraGrouping:this._grouping.getExtraGrouping(),context:this._context.getContextId(),parent:this,isNew:true,index:i,titleBackgroundColor:"",entityTypeName:this.getEntityTypeName()};var s=BX.CrmGraphWidgetConfigFieldEditor.create(r,n);this._fields.push(s);this._container.insertBefore(s.prepareLayout(BX.create("DIV",{attrs:{className:"container-item"}}),"wide"),this._buttonContainer);s.addDeletionListener(this._fieldDeletionHandler)};BX.CrmGraphWidgetConfigEditor.prototype.removeField=function(t){t.resetLayout()};BX.CrmGraphWidgetConfigEditor.prototype.removeConfig=function(t){if(!BX.type.isArray(this._config["configs"])){return}for(var e=0;e<this._config["configs"].length;e++){if(t===this._config["configs"][e]){this._config["configs"].splice(e,1);return}}};BX.CrmGraphWidgetConfigEditor.prototype.innerSaveConfig=function(){this._grouping.saveConfig();this._context.saveConfig();for(var t=0;t<this._fields.length;t++){var e=this._fields[t];if(!e.isDeleted()){e.saveConfig();if(e.isNew()){this._config["configs"].push(e.getConfig())}}else if(!e.isNew()){this.removeConfig(e.getConfig())}}};BX.CrmGraphWidgetConfigEditor.prototype.reset=function(){for(var t=0;t<this._fields.length;t++){this._fields[t].resetLayout()}this._fields=[];this._grouping.resetLayout();this._grouping=null;this._context.resetLayout();this._context=null;BX.unbind(this._addButton,"click",this._addButtonClickHandler);BX.cleanNode(this._buttonContainer,true);this._buttonContainer=null;this._addButton=null};BX.CrmGraphWidgetConfigEditor.prototype.onContextChange=function(t,e){for(var i=0;i<this._fields.length;i++){this._fields[i].setContextId(e)}};BX.CrmGraphWidgetConfigEditor.prototype.onGroupingChange=function(t,e){var i=e["isExtra"]?e["grouping"]:"";for(var r=0;r<this._fields.length;r++){this._fields[r].setExtraGrouping(i)}};BX.CrmGraphWidgetConfigEditor.prototype.onFieldDelete=function(t){this.removeField(t)};BX.CrmGraphWidgetConfigEditor.prototype.onAddButtonClick=function(t){this.createField();return BX.PreventDefault(t)};if(typeof BX.CrmGraphWidgetConfigEditor.messages==="undefined"){BX.CrmGraphWidgetConfigEditor.messages={}}BX.CrmGraphWidgetConfigEditor.create=function(t,e){var i=new BX.CrmGraphWidgetConfigEditor;i.initialize(t,e);return i}}if(typeof BX.CrmNumericWidgetConfigFieldEditor==="undefined"){BX.CrmNumericWidgetConfigFieldEditor=function(){this._id="";this._settings=null;this._parent=null;this._name="";this._index=0;this._letter="";this._config=null;this._titleBackgroundColor="";this._titleEditor=null};BX.CrmNumericWidgetConfigFieldEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._parent=this.getSetting("parent");if(!this._parent){throw"CrmNumericWidgetConfigFieldEditor: Could not find 'parent' parameter."}this._index=this.getSetting("index",0);this._letter=String.fromCharCode(65+this._index);this._config=this.getSetting("config",{});this._name=BX.type.isNotEmptyString(this._config["name"])?this._config["name"]:"c"+(this._index+1);this._titleBackgroundColor=this.getSetting("titleBackgroundColor","");if(BX.type.isPlainObject(this._config["display"])&&BX.type.isNotEmptyString(this._config["display"]["colorScheme"])){this._schemeId=this._config["display"]["colorScheme"];var i=BX.CrmWidgetColorScheme.getInfo(this._schemeId);if(i){this._titleBackgroundColor=i["color"]}}if(this._titleBackgroundColor===""){if(this._index>1){this._titleBackgroundColor="#dec01f"}else if(this._index>0){this._titleBackgroundColor="#4fc3f7"}else{this._titleBackgroundColor="#22d02c"}}this.innerInitialize()},innerInitialize:function(){},postInitialize:function(){},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getIndex:function(){return this._index},getLetter:function(){return this._letter},getName:function(){return this._name},getTitleEditor:function(){return this._titleEditor},getTitleBackgroundColor:function(){return this._titleEditor?this._titleEditor.getTitleBackgroundColor():this._titleBackgroundColor},prepareLayout:function(t,e){this._titleEditor=BX.CrmWidgetConfigTitleEditor.create(this._id,{config:this._config,backgroundColor:this._titleBackgroundColor,letter:this._letter});this._titleEditor.prepareLayout(t);this.innerPrepareLayout(t,e);return t},innerPrepareLayout:function(t,e){},prepareExtraControls:function(t){},resetLayout:function(){this._titleEditor.resetLayout();this._titleEditor=null;this.innerResetLayout()},innerResetLayout:function(){},getConfig:function(){return this._config},saveConfig:function(){this._config["name"]=this._name;this._titleEditor.saveConfig();this._config["title"]=this._titleEditor.getTitle();this.innerSaveConfig()},innerSaveConfig:function(){}}}if(typeof BX.CrmNumericWidgetConfigPresetFieldEditor==="undefined"){BX.CrmNumericWidgetConfigPresetFieldEditor=function(){BX.CrmNumericWidgetConfigPresetFieldEditor.superclass.constructor.apply(this);this._entityTypeName="";this._presetEditor=null;this._presetChangeHandler=BX.delegate(this._onPresetChange,this)};BX.extend(BX.CrmNumericWidgetConfigPresetFieldEditor,BX.CrmNumericWidgetConfigFieldEditor);BX.CrmNumericWidgetConfigPresetFieldEditor.prototype.innerInitialize=function(){this._entityTypeName=this.getSetting("entityTypeName","")};BX.CrmNumericWidgetConfigPresetFieldEditor.prototype.getContextId=function(){return this._presetEditor?this._presetEditor.getContextId():BX.CrmWidgetDataContext.undefined};BX.CrmNumericWidgetConfigPresetFieldEditor.prototype.innerPrepareLayout=function(t,e){this._presetEditor=BX.CrmWidgetManager.getCurrent().createPresetEditor(this._entityTypeName,this._parent.getWidgetTypeName(),this._id,{config:this._config,entityTypeName:this._entityTypeName,presetChange:this._presetChangeHandler});this._presetEditor.prepareLayout(t,e)};BX.CrmNumericWidgetConfigPresetFieldEditor.prototype.innerResetLayout=function(){this._presetEditor.resetLayout();this._presetEditor=null};BX.CrmNumericWidgetConfigPresetFieldEditor.prototype.innerSaveConfig=function(){this._presetEditor.saveConfig();this._config=this._presetEditor.getConfig()};BX.CrmNumericWidgetConfigPresetFieldEditor.prototype._onPresetChange=function(t,e){if(e&&BX.type.isNotEmptyString(e["title"])&&this._titleEditor){this._titleEditor.setTitle(e["title"])}};BX.CrmNumericWidgetConfigPresetFieldEditor.create=function(t,e){var i=new BX.CrmNumericWidgetConfigPresetFieldEditor;i.initialize(t,e);return i}}if(typeof BX.CrmNumericWidgetConfigExpressionFieldEditor==="undefined"){BX.CrmNumericWidgetConfigExpressionFieldEditor=function(){BX.CrmNumericWidgetConfigExpressionFieldEditor.superclass.constructor.apply(this);this._source=null;this._operation="";this._leftItem=null;this._rightItem=null;this._leftIcon=null;this._icon=null;this._rightIcon=null;this._operationLegend=null;this._operationIcon=null;this._operationSign=null;this._operationSelector=null;this._operationChangeHandler=BX.delegate(this.onOperationChange,this);this._colorSchemeChangeHandler=BX.delegate(this.onColorSchemeChange,this);this._leftItemColorSchemeChangeHandler=BX.delegate(this.onLeftItemColorSchemeChange,this);this._rightItemColorSchemeChangeHandler=BX.delegate(this.onRightItemColorSchemeChange,this)};BX.extend(BX.CrmNumericWidgetConfigExpressionFieldEditor,BX.CrmNumericWidgetConfigFieldEditor);BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.innerInitialize=function(){this._source=BX.type.isPlainObject(this._config["dataSource"])?this._config["dataSource"]:{};this._operation=BX.type.isNotEmptyString(this._source["operation"])?this._source["operation"].toUpperCase():BX.CrmWidgetExpressionOperation.diff};BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.postInitialize=function(){this._items={};var t=new RegExp("%([^%]+)%");var arguments=BX.type.isArray(this._source["arguments"])?this._source["arguments"]:[];var e=arguments.length;var i;if(e>0){if(e<2){throw"CrmNumericWidgetExpressionConfigEditor: Configuration must contain at least two arguments."}for(var r=0;r<2;r++){var n=t.exec(arguments[r]);if(!n){throw"CrmNumericWidgetExpressionConfigEditor: Could not parse argument."}var s=n[1];i=this._parent.getFieldByName(s);if(!i){throw"CrmNumericWidgetExpressionConfigEditor: Could not find field."}if(r===0){this._leftItem=i}else{this._rightItem=i}}}else{var o=this._parent.getFields();var a=o.length;if(a<2){throw"CrmNumericWidgetExpressionConfigEditor: Parent must contain at least two fields."}for(var h=0;h<2;h++){if(h===0){this._leftItem=o[h]}else{this._rightItem=o[h]}}}};BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.innerPrepareLayout=function(t,e){this._operationLegend=BX.create("P",{text:BX.CrmWidgetExpressionOperation.getLegend(this._operation)});t.appendChild(BX.create("DIV",{attrs:{className:"field-container"},children:[this._operationLegend]}));this._icon=BX.create("SPAN",{attrs:{className:"color-digit"},style:{backgroundColor:this.getTitleBackgroundColor()},text:this._letter});this._leftIcon=BX.create("SPAN",{attrs:{className:"color-digit"},style:{backgroundColor:this._leftItem.getTitleBackgroundColor()},text:this._leftItem.getLetter()});this._rightIcon=BX.create("SPAN",{attrs:{className:"color-digit"},style:{backgroundColor:this._rightItem.getTitleBackgroundColor()},text:this._rightItem.getLetter()});this._operationSign=BX.create("SPAN",{attrs:{className:BX.CrmWidgetExpressionOperation.getSymbolClassName(this._operation)}});t.appendChild(BX.create("DIV",{attrs:{className:"subtraction"},children:[BX.create("DIV",{children:[this._icon,BX.create("SPAN",{attrs:{className:"symbol symbol-equally"}}),this._leftIcon,this._operationSign,this._rightIcon]})]}));if(BX.type.isElementNode(t.parentNode)){t.parentNode.appendChild(BX.create("DIV",{attrs:{className:"container-item-equally"},children:[BX.create("SPAN")]}))}var i=this.getTitleEditor();if(i){i.addColorSchemeChangeListener(this._colorSchemeChangeHandler)}var r=this._leftItem.getTitleEditor();if(r){r.addColorSchemeChangeListener(this._leftItemColorSchemeChangeHandler)}var n=this._rightItem.getTitleEditor();if(n){n.addColorSchemeChangeListener(this._rightItemColorSchemeChangeHandler)}};BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.prepareExtraControls=function(t){var e={type:"action",controls:[]};this._operationIcon=BX.create("SPAN",{attrs:{className:BX.CrmWidgetExpressionOperation.getIconClassName(this._operation)}});e["controls"].push(this._operationIcon);this._operationSelector=BX.CrmWidgetConfigEditor.createSelect({events:{change:this._operationChangeHandler}},BX.CrmWidgetExpressionOperation.prepareListItems());this._operationSelector.value=this._operation;e["controls"].push(BX.create("SPAN",{attrs:{className:"select-container"},children:[this._operationSelector]}));e["controls"].push(BX.create("SPAN",{text:BX.CrmWidgetExpressionOperation.getHint()}));t.push(e)};BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.innerSaveConfig=function(){if(!BX.type.isPlainObject(this._config["dataSource"])){this._config["dataSource"]={}}this._config["dataSource"]["name"]="EXPRESSION";this._config["dataSource"]["operation"]=this._operation;this._config["dataSource"]["arguments"]=["%"+this._leftItem.getName()+"%","%"+this._rightItem.getName()+"%"];if(this._operation!==BX.CrmWidgetExpressionOperation.percent&&(this._leftItem.getContextId()===BX.CrmWidgetDataContext.fund||this._rightItem.getContextId()===BX.CrmWidgetDataContext.fund)){if(!BX.type.isPlainObject(this._config["format"])){this._config["format"]={}}this._config["format"]["isCurrency"]="Y";this._config["format"]["enableDecimals"]="N"}else if(BX.type.isPlainObject(this._config["format"])){delete this._config["format"]["isCurrency"];delete this._config["format"]["enableDecimals"]}};BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.innerResetLayout=function(){var t=this.getTitleEditor();if(t){t.removeColorSchemeChangeListener(this._colorSchemeChangeHandler)}this._leftIcon=null;var e=this._leftItem?this._leftItem.getTitleEditor():null;if(e){e.removeColorSchemeChangeListener(this._leftItemColorSchemeChangeHandler)}this._rightIcon=null;var i=this._rightItem?this._rightItem.getTitleEditor():null;if(i){i.removeColorSchemeChangeListener(this._rightItemColorSchemeChangeHandler)}this._operationLegend=null;this._operationSign=null;this._operationIcon=null;if(this._operationSelector){BX.unbind(this._presetSelector,"change",this._operationChangeHandler);this._operationSelector=null}};BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.onOperationChange=function(t){this._operation=this._operationSelector.value;this._operationIcon.className=BX.CrmWidgetExpressionOperation.getIconClassName(this._operation);this._operationLegend.innerHTML=BX.util.htmlspecialchars(BX.CrmWidgetExpressionOperation.getLegend(this._operation));this._operationSign.className=BX.CrmWidgetExpressionOperation.getSymbolClassName(this._operation);this._titleEditor.setTitle(BX.CrmWidgetExpressionOperation.getDescription(this._operation))};BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.onColorSchemeChange=function(){if(this._icon){this._icon.style.backgroundColor=this.getTitleBackgroundColor()}};BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.onLeftItemColorSchemeChange=function(){if(this._leftItem&&this._leftIcon){this._leftIcon.style.backgroundColor=this._leftItem.getTitleBackgroundColor()}};BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.onRightItemColorSchemeChange=function(){if(this._rightItem&&this._rightIcon){this._rightIcon.style.backgroundColor=this._rightItem.getTitleBackgroundColor()}};BX.CrmNumericWidgetConfigExpressionFieldEditor.prototype.getOperation=function(){return this._operation};BX.CrmNumericWidgetConfigExpressionFieldEditor.isExpression=function(t){var e=BX.type.isPlainObject(t["dataSource"])?t["dataSource"]:{};return BX.type.isNotEmptyString(e["name"])&&e["name"].toUpperCase()==="EXPRESSION"};BX.CrmNumericWidgetConfigExpressionFieldEditor.create=function(t,e){var i=new BX.CrmNumericWidgetConfigExpressionFieldEditor;i.initialize(t,e);return i}}if(typeof BX.CrmGraphWidgetConfigFieldEditor==="undefined"){BX.CrmGraphWidgetConfigFieldEditor=function(){this._id="";this._settings=null;this._parent=null;this._name="";this._index=0;this._config=null;this._entityTypeName="";this._extraGrouping="";this._contextId=BX.CrmWidgetDataContext.undefined;this._titleBackgroundColor="";this._titleEditor=null;this._presetEditor=null;this._presetChangeHandler=BX.delegate(this.onPresetChange,this);this._titleDeletionHandler=BX.delegate(this.onTitleDeletion,this);this._isNew=false;this._isDeleted=false;this._deletionNotifier=null;this._container=null;this._hasLayout=false};BX.CrmGraphWidgetConfigFieldEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._parent=this.getSetting("parent",null);if(!this._parent){throw"CrmGraphWidgetConfigFieldEditor: The 'parent' parameter is not found."}this._entityTypeName=this.getSetting("entityTypeName","");this._index=this.getSetting("index",0);this._extraGrouping=this.getSetting("extraGrouping","");this._contextId=this.getSetting("context",BX.CrmWidgetDataContext.entity);this._config=this.getSetting("config",{});this._name=BX.type.isNotEmptyString(this._config["name"])?this._config["name"]:"c"+(this._index+1);this._titleBackgroundColor=this.getSetting("titleBackgroundColor","");this._isNew=this.getSetting("isNew",false);this._deletionNotifier=BX.CrmNotifier.create(this)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getIndex:function(){return this._index},getName:function(){return this._name},getContextId:function(){return this._contextId},setContextId:function(t){this._contextId=t;if(this._presetEditor){this._presetEditor.setContextId(t)}},getExtraGrouping:function(){return this._extraGrouping},setExtraGrouping:function(t){this._extraGrouping=t;if(this._presetEditor){this._presetEditor.setExtraGrouping(t)}},getTitleBackgroundColor:function(){return this._titleBackgroundColor},getTitleEditor:function(){return this._titleEditor},prepareLayout:function(t){if(this._hasLayout){return}this._container=t;this._titleEditor=BX.CrmWidgetConfigTitleEditor.create(this._id,{config:this._config,enableDeletion:true,backgroundColor:this._titleBackgroundColor});this._titleEditor.addDeletionListener(this._titleDeletionHandler);this._titleEditor.prepareLayout(t);this._presetEditor=BX.CrmWidgetManager.getCurrent().createPresetEditor(this._entityTypeName,this._parent.getWidgetTypeName(),this._id,{config:this._config,entityTypeName:this._entityTypeName,presetChange:this._presetChangeHandler,extraGrouping:this._extraGrouping,context:this._contextId,enableContextChange:false});this._presetEditor.prepareLayout(t,"wide");this._hasLayout=true;return t},resetLayout:function(){if(!this._hasLayout){return}this._titleEditor.removeDeletionListener(this._titleDeletionHandler);this._titleEditor.resetLayout();this._titleEditor=null;this._presetEditor.resetLayout();this._presetEditor=null;BX.cleanNode(this._container,true);this._container=null;this._hasLayout=false},getConfig:function(){return this._config},saveConfig:function(){this._config["name"]=this._name;this._titleEditor.saveConfig();this._presetEditor.saveConfig()},addDeletionListener:function(t){this._deletionNotifier.addListener(t)},removeDeletionListener:function(t){this._deletionNotifier.removeListener(t)},isNew:function(){return this._isNew},isDeleted:function(){return this._isDeleted},onPresetChange:function(t,e){if(e&&BX.type.isNotEmptyString(e["title"])&&this._titleEditor){this._titleEditor.setTitle(e["title"])}},onTitleDeletion:function(t){this._isDeleted=true;this._deletionNotifier.notify()}};BX.CrmGraphWidgetConfigFieldEditor.create=function(t,e){var i=new BX.CrmGraphWidgetConfigFieldEditor;i.initialize(t,e);return i}}if(typeof BX.CrmPieWidgetConfigFieldEditor==="undefined"){BX.CrmPieWidgetConfigFieldEditor=function(){this._id="";this._settings=null;this._parent="";this._name="";this._config=null;this._entityTypeName="";this._extraGrouping="";this._titleEditor=null;this._presetEditor=null;this._presetChangeHandler=BX.delegate(this.onPresetChange,this);this._container=null;this._hasLayout=false};BX.CrmPieWidgetConfigFieldEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._parent=this.getSetting("parent",null);if(!this._parent){throw"CrmPieWidgetConfigFieldEditor: The 'parent' parameter is not found."}this._entityTypeName=this.getSetting("entityTypeName","");this._extraGrouping=this.getSetting("extraGrouping","");this._config=this.getSetting("config",{});this._name=BX.type.isNotEmptyString(this._config["name"])?this._config["name"]:"c0"},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getIndex:function(){return this._index},getName:function(){return this._name},getContextId:function(){return this._contextId},setContextId:function(t){this._contextId=t;if(this._presetEditor){this._presetEditor.setContextId(t)}},getExtraGrouping:function(){return this._extraGrouping},setExtraGrouping:function(t){this._extraGrouping=t;if(this._presetEditor){this._presetEditor.setExtraGrouping(t)}},getTitleEditor:function(){return this._titleEditor},prepareLayout:function(t){if(this._hasLayout){return}this._container=t;this._titleEditor=BX.CrmWidgetConfigTitleEditor.create(this._id,{config:this._config,backgroundColor:"#b0b6bc",enableBackgroundColorChange:false});this._titleEditor.prepareLayout(t);this._presetEditor=BX.CrmWidgetManager.getCurrent().createPresetEditor(this._entityTypeName,this._parent.getWidgetTypeName(),this._id,{config:this._config,entityTypeName:this._entityTypeName,presetChange:this._presetChangeHandler,extraGrouping:this._extraGrouping,enableContextChange:true});this._presetEditor.prepareLayout(t,"wide");this._hasLayout=true;return t},resetLayout:function(){if(!this._hasLayout){return}this._titleEditor.resetLayout();this._titleEditor=null;this._presetEditor.resetLayout();this._presetEditor=null;BX.cleanNode(this._container,true);this._container=null;this._hasLayout=false},getConfig:function(){return this._config},saveConfig:function(){this._config["name"]=this._name;this._titleEditor.saveConfig();this._presetEditor.saveConfig()},onPresetChange:function(t,e){if(e&&BX.type.isNotEmptyString(e["title"])&&this._titleEditor){this._titleEditor.setTitle(e["title"])}}};BX.CrmPieWidgetConfigFieldEditor.create=function(t,e){var i=new BX.CrmPieWidgetConfigFieldEditor;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetDataPreset==="undefined"){BX.CrmWidgetDataPreset=function(){};BX.CrmWidgetDataPreset.prototype={};BX.CrmWidgetDataPreset.items=[];BX.CrmWidgetDataPreset.notSelected="-";BX.CrmWidgetDataPreset.hasItems=function(t,e,i,r){if(!BX.type.isNotEmptyString(t)){return false}if(!BX.type.isString(e)){e=""}if(!BX.type.isString(i)){i=BX.CrmWidgetDataContext.undefined}if(!BX.type.isString(r)){r=""}var n=BX.type.isNotEmptyString(r);for(var s=0;s<this.items.length;s++){var o=this.items[s];var a=BX.type.isNotEmptyString(o["entity"])?o["entity"]:"";var h=BX.type.isNotEmptyString(o["category"])?o["category"]:"";var l=BX.type.isNotEmptyString(o["context"])?o["context"]:"";if(a!==t||h!==e||i!==BX.CrmWidgetDataContext.undefined&&l!==i){continue}if(n){var g=BX.type.isPlainObject(o["grouping"])&&BX.type.isArray(o["grouping"]["extras"])?o["grouping"]["extras"]:[];var d=false;for(var c=0,p=g.length;c<p;c++){if(g[c]===r){d=true;break}}if(!d){continue}}return true}return false};BX.CrmWidgetDataPreset.prepareListItems=function(t,e,i,r){if(!BX.type.isNotEmptyString(t)){return[{value:"",text:this.notSelected}]}if(!BX.type.isString(e)){e=""}if(!BX.type.isString(i)){i=BX.CrmWidgetDataContext.undefined}if(!BX.type.isString(r)){r=""}var n=BX.type.isNotEmptyString(r);var s=[{value:"",text:this.notSelected}];for(var o=0;o<this.items.length;o++){var a=this.items[o];var h=BX.type.isNotEmptyString(a["entity"])?a["entity"]:"";var l=BX.type.isNotEmptyString(a["category"])?a["category"]:"";var g=BX.type.isNotEmptyString(a["context"])?a["context"]:"";if(h!==t||l!==e||i!==BX.CrmWidgetDataContext.undefined&&g!==i){continue}if(n){var d=BX.type.isPlainObject(a["grouping"])&&BX.type.isArray(a["grouping"]["extras"])?a["grouping"]["extras"]:[];var c=false;for(var p=0,u=d.length;p<u;p++){if(d[p]===r){c=true;break}}if(!c){continue}}var f=BX.type.isNotEmptyString(a["name"])?a["name"]:"";var _=BX.type.isNotEmptyString(a["listTitle"])?a["listTitle"]:"";if(_===""){_=BX.type.isNotEmptyString(a["title"])?a["title"]:""}if(_===""){_=f}s.push({value:f,text:_})}return s};BX.CrmWidgetDataPreset.getItem=function(t){if(!BX.type.isNotEmptyString(t)){return null}for(var e=0;e<this.items.length;e++){var i=this.items[e];var r=BX.type.isNotEmptyString(i["name"])?i["name"]:"";if(r===t){return i}}return null}}if(typeof BX.CrmWidgetDataCategory==="undefined"){BX.CrmWidgetDataCategory=function(){};BX.CrmWidgetDataCategory.prototype={};BX.CrmWidgetDataCategory.items=[];BX.CrmWidgetDataCategory.notSelected="-";BX.CrmWidgetDataCategory.groupTitle="";BX.CrmWidgetDataCategory.selectorTitle="";BX.CrmWidgetDataCategory.getItem=function(t){if(!BX.type.isNotEmptyString(t)){return null}for(var e=0;e<this.items.length;e++){var i=this.items[e];var r=BX.type.isNotEmptyString(i["name"])?i["name"]:"";if(r===t){return i}}return null};BX.CrmWidgetDataCategory.prepareListItems=function(t){if(!BX.type.isNotEmptyString(t)){t=""}var e=[{value:"",text:this.notSelected}];for(var i=0;i<this.items.length;i++){var r=this.items[i];var n=BX.type.isNotEmptyString(r["entity"])?r["entity"]:"";if(n!==t){continue}var s=BX.type.isNotEmptyString(r["name"])?r["name"]:"";var o=BX.type.isNotEmptyString(r["title"])?r["title"]:"";if(o===""){o=s}e.push({value:s,text:o})}return e}}if(typeof BX.CrmWidgetPanelCell==="undefined"){BX.CrmWidgetPanelCell=function(){this._id="";this._settings=null;this._prefix="";this._hasLayout=false;this._panel=null;this._row=null;this._container=null;this._widgets=[]};BX.CrmWidgetPanelCell.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._prefix=this.getSetting("prefix",this._id);this._row=this.getSetting("row");if(!this._row){throw"BX.CrmWidgetPanelCell: Parameter 'row' is not found."}this._panel=this.getSetting("panel");if(!this._panel){this._panel=this._row.getPanel()}this._container=this.getSetting("container",null);var i=this.getSetting("data",[]);var r=this.getSetting("controls",[]);var n=this._row.getHeight();var s=this._panel.getWidgetCount();var o=this._panel.getMaxWidgetCount();for(var a=0;a<i.length;a++){if(o>0&&s>=o){break}var h=r[a];var l=BX.type.isNotEmptyString(h["entityTypeName"])?h["entityTypeName"]:"";if(l===""){l=this._panel.getDefaultEntityTypeName()}var g=BX.CrmWidgetManager.getCurrent().createWidget(this._prefix+"_"+a,{cell:this,prefix:this._prefix,data:i[a],config:h,entityTypeName:l,heightInPixel:n});this._widgets.push(g);s++}},createWidget:function(t,e){var i=BX.CrmWidgetManager.getCurrent().createWidget(this._prefix+"_"+e,{cell:this,prefix:this._prefix,entityTypeName:BX.type.isNotEmptyString(t["entityTypeName"])?t["entityTypeName"]:"",config:BX.type.isPlainObject(t["config"])?t["config"]:{},data:BX.type.isPlainObject(t["data"])?t["data"]:{},heightInPixel:this._row.getHeight()});this.addWidget(i,e);return i},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getRow:function(){return this._row},getPanel:function(){return this._panel},getContainer:function(){return this._container},getIndex:function(){return this._row.getCellIndex(this)},getConfig:function(){var t={controls:[]};for(var e=0;e<this._widgets.length;e++){var i=this._widgets[e];t["controls"].push(i.getConfig())}if(t["controls"].length==0){t["isEmpty"]="Y"}return t},getWidgets:function(){return this._widgets},getWidgetCount:function(){return this._widgets.length},getWidgetTotalHeight:function(){var t=0;for(var e=0;e<this._widgets.length;e++){t+=this._widgets[e].getHeight()}return t},getWidgetById:function(t){for(var e=0;e<this._widgets.length;e++){var i=this._widgets[e];if(i.getId()===t){return i}}return null},getWidgetIndex:function(t){for(var e=0;e<this._widgets.length;e++){if(t===this._widgets[e]){return e}}return-1},getNextWidget:function(t){var e=this._widgets.length-1;for(var i=0;i<e;i++){if(t===this._widgets[i]){return this._widgets[i+1]}}return null},addWidget:function(t,e){if(e<this._widgets.length){this._widgets.splice(e,0,t)}else{this._widgets.push(t)}t.setContainer(this._container)},removeWidget:function(t){var e=-1;for(var i=0;i<this._widgets.length;i++){if(t===this._widgets[i]){e=i;break}}if(e>=0){this._widgets.splice(e,1);t.setContainer(null)}},isEmpty:function(){return this._widgets.length===0},isThin:function(){return this._row.getHeight()-this.getWidgetTotalHeight()>0},layout:function(){if(this._hasLayout){return}this._container=BX.create("DIV",{attrs:{id:this._prefix+"_container",className:"crm-widget-container"}});if(this._row.getCellCount()>1){BX.addClass(this._container,this.getIndex()===0?"crm-widget-left":"crm-widget-right")}this._row.getContainer().appendChild(this._container);for(var t=0;t<this._widgets.length;t++){var e=this._widgets[t];e.setContainer(this._container);e.layout()}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}for(var t=0;t<this._widgets.length;t++){var e=this._widgets[t];e.clearLayout()}BX.cleanNode(this._container,true);this._container=null;this._hasLayout=false},invalidate:function(){for(var t=0;t<this._widgets.length;t++){this._widgets[t].invalidate()}}};BX.CrmWidgetPanelCell.getItemWidgetCount=function(t){return t?t.getWidgetCount():0};BX.CrmWidgetPanelCell.create=function(t,e){var i=new BX.CrmWidgetPanelCell;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetPanelRow==="undefined"){BX.CrmWidgetPanelRow=function(){this._id="";this._settings=null;this._panel=null;this._prefix="";this._height=0;this._hasLayout=false;this._container=null;this._index=-1;this._cells=[]};BX.CrmWidgetPanelRow.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._panel=this.getSetting("panel");if(!this._panel){throw"BX.CrmWidgetPanelRow: Parameter 'panel' is not found."}this._prefix=this.getSetting("prefix",this._id);this._height=parseInt(this.getSetting("height",BX.CrmWidgetLayoutHeight.full));var i=this.getSetting("cells",[]);for(var r=0;r<i.length;r++){var n=BX.CrmWidgetPanelCell.create(this._prefix+"_"+(r+1),{row:this,controls:i[r]["controls"],data:i[r]["data"]});this._cells.push(n)}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getPanel:function(){return this._panel},getContainer:function(){return this._container},getCells:function(){return this._cells},getCellCount:function(){return this._cells.length},getMaxCellHeight:function(){var t=0;for(var e=0;e<this._cells.length;e++){var i=this._cells[e].getWidgetTotalHeight();if(i>t){t=i}}return t},getHeight:function(){return this._height},setHeight:function(t){this._height=t;if(this._container){this._container.style.height=this._height+"px"}},getIndex:function(){return this._panel.getRowIndex(this)},getConfig:function(){var t={cells:[]};for(var e=0;e<this._cells.length;e++){var i=this._cells[e];t["cells"].push(i.getConfig())}if(this._height>0){t["height"]=this._height}return t},getCellIndex:function(t){for(var e=0;e<this._cells.length;e++){if(this._cells[e]===t){return e}}return-1},getCellByIndex:function(t){return this._cells.length>t?this._cells[t]:null},getThinCells:function(){var t=[];for(var e=0;e<this._cells.length;e++){var i=this._cells[e];if(i.isThin()){t.push(i)}}return t},getWidgetById:function(t){var e=null;for(var i=0;i<this._cells.length;i++){e=this._cells[i].getWidgetById(t);if(e){break}}return e},getWidgetCount:function(){var t=0;for(var e=0;e<this._cells.length;e++){t+=this._cells[e].getWidgetCount()}return t},isEmpty:function(){for(var t=0;t<this._cells.length;t++){if(!this._cells[t].isEmpty()){return false}}return true},ensureCellCreated:function(t,e){if(t<0){return}e=!!e;for(var i=0;i<=t;i++){if(this._cells.length<=i){var r=BX.CrmWidgetPanelCell.create(this._prefix+"_"+(i+1),{row:this});this._cells.push(r);if(e){r.layout()}}}},layout:function(){if(this._hasLayout){return}this._container=BX.create("DIV",{attrs:{id:this._prefix+"_container",className:"crm-widget-row"}});this._container.style.height=this._height+"px";var t=this.getIndex();var e=this._panel.getContainer();if(t<0||t>e.children.length){t=e.children.length}if(t===e.children.length){e.appendChild(this._container)}else{e.insertBefore(this._container,e.children[t])}for(var i=0;i<this._cells.length;i++){this._cells[i].layout()}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}for(var t=0;t<this._cells.length;t++){var e=this._cells[t];e.clearLayout()}if(this._container){BX.cleanNode(this._container,true);this._container=null}this._hasLayout=false},invalidate:function(){for(var t=0;t<this._cells.length;t++){this._cells[t].invalidate()}}};BX.CrmWidgetPanelRow.create=function(t,e){var i=new BX.CrmWidgetPanelRow;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetPanel==="undefined"){BX.CrmWidgetPanel=function(){this._id="";this._settings=null;this._defaultEntityTypeName="";this._entityTypeNames=null;this._layoutType=BX.CrmWidgetLayout.undifined;this._prefix="";this._container=null;this._settingButton=null;this._rows=[];this._dragDropController=null;this._saveConfigCallback=null;this._isSettingMenuShown=false;this._settingMenuId="";this._settingMenu=null;this._settingMenuHandler=BX.delegate(this.onSettingMenuItemClick,this);this._settingButtonClickHandler=BX.delegate(this.onSettingButtonClick,this);this._dynamicRowKeys={};this._isAjaxMode=false;this._isDemoMode=false;this._useDemoMode=true;this._demoModeInfoContainer=null;this._disableDemoModeButton=null;this._demoModeInfoCloseButton=null;this._disableDemoButtonClickHandler=BX.delegate(this.onDisableDemoButtonClick,this);this._demoModeInfoCloseButtonClickHandler=BX.delegate(this.onDemoInfoCloseButtonClick,this);this._typeSelector=null;this._layoutTypeSelector=null;this._maxGraphCount=0;this._maxWidgetCount=0};BX.CrmWidgetPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._entityTypeNames=this.getSetting("entityTypes",[]);this._defaultEntityTypeName=this.getSetting("defaultEntityType","");if(this._defaultEntityTypeName===""&&this._entityTypeNames.length>0){this._defaultEntityTypeName=this._entityTypeNames[0]}this._isAjaxMode=this.getSetting("isAjaxMode",false);this._prefix=this.getSetting("prefix",this._id);var i=this.getSetting("containerId");if(!BX.type.isNotEmptyString(i)){throw"BX.CrmWidgetPanel: Parameter 'containerId' is not found."}this._container=BX(i);if(!this._container){throw"BX.CrmWidgetPanel: Container is not found."}this._layoutType=this.getSetting("layout",BX.CrmWidgetLayout.l50r50);this.processLayoutTypeChange();this._maxGraphCount=parseInt(this.getSetting("maxGraphCount",0));this._maxWidgetCount=parseInt(this.getSetting("maxWidgetCount",0));var r=this.getSetting("rows");if(BX.type.isArray(r)){for(var n=0;n<r.length;n++){var s=r[n];s["panel"]=this;var o=BX.CrmWidgetPanelRow.create(this._prefix+"_"+(n+1),s);this._rows.push(o)}}this._settingButton=BX(this.getSetting("settingButtonId"));if(this._settingButton){BX.bind(this._settingButton,"click",this._settingButtonClickHandler)}this._isDemoMode=this.getSetting("isDemoMode");this._useDemoMode=this.getSetting("useDemoMode",true);if(this._isDemoMode){this._demoModeInfoContainer=BX(this.getSetting("demoModeInfoContainerId"));this._disableDemoModeButton=BX(this.getSetting("disableDemoModeButtonId"));if(this._disableDemoModeButton){BX.bind(this._disableDemoModeButton,"click",this._disableDemoButtonClickHandler)}this._demoModeInfoCloseButton=BX(this.getSetting("demoModeInfoCloseButtonId"));if(this._demoModeInfoCloseButton){BX.bind(this._demoModeInfoCloseButton,"click",this._demoModeInfoCloseButtonClickHandler)}}BX.addCustomEvent("BX.Main.Filter:apply",BX.delegate(this.onFilterApply,this));BX.onCustomEvent(window,"CrmWidgetPanelCreated",[this])},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getMessage:function(t){var e=BX.CrmWidgetPanel.messages;return e.hasOwnProperty(t)?e[t]:t},getContainer:function(){return this._container},getDefaultEntityTypeName:function(){return this._defaultEntityTypeName},getEntityTypeNames:function(){return this._entityTypeNames},getLayoutType:function(){return this._layoutType},setLayoutType:function(t){if(this._layoutType===t){return}this._layoutType=t;this.processLayoutTypeChange();this.invalidate();BX.showWait();BX.ajax.post(this.getSetting("serviceUrl",""),{guid:this._id,action:"savelayout",layout:t},BX.delegate(this.onAfterConfigSave,this))},getRows:function(){return this._rows},getRowCount:function(){return this._rows.length},getRowIndex:function(t){for(var e=0;e<this._rows.length;e++){if(this._rows[e]===t){return e}}return-1},getRowById:function(t){for(var e=0;e<this._rows.length;e++){var i=this._rows[e];if(i.getId()===t){return i}}return null},getRowByIndex:function(t){return this._rows.length>t?this._rows[t]:null},getThinCells:function(){var t=[];for(var e=0;e<this._rows.length;e++){var i=this._rows[e].getThinCells();for(var r=0;r<i.length;r++){t.push(i[r])}}return t},getWidgetById:function(t){var e=null;for(var i=0;i<this._rows.length;i++){e=this._rows[i].getWidgetById(t);if(e){break}}return e},getWidgetCount:function(){var t=0;for(var e=0;e<this._rows.length;e++){t+=this._rows[e].getWidgetCount()}return t},getCurrencyFormat:function(){return this.getSetting("currencyFormat",null)},getMaxGraphCount:function(){return this._maxGraphCount},getMaxWidgetCount:function(){return this._maxWidgetCount},openTypeSelector:function(){if(this._layoutTypeSelector&&this._layoutTypeSelector.isDialogOpened()){this._layoutTypeSelector.closeDialog()}if(!this._typeSelector){this._typeSelector=BX.CrmWidgetTypeSelector.create(this._id+"_widget_type_selector",{entityTypeNames:this._entityTypeNames.length>0?this._entityTypeNames:[this._defaultEntityTypeName],callback:BX.delegate(this.onConfiguratorAction,this)})}this._typeSelector.openDialog()},openLayoutTypeSelector:function(){if(this._typeSelector&&this._typeSelector.isDialogOpened()){this._typeSelector.closeDialog()}if(!this._layoutTypeSelector){this._layoutTypeSelector=BX.CrmWidgetPanelLayoutTypeSelector.create(this._id+"_layout_type_selector",{layoutType:this._layoutType,callback:BX.delegate(this.onConfiguratorAction,this)})}this._layoutTypeSelector.openDialog()},onConfiguratorAction:function(t,e){if(t!==this._typeSelector&&t!==this._layoutTypeSelector){return}t.closeDialog();var i=BX.type.isNotEmptyString(e["action"])?e["action"]:"";var r=BX.type.isPlainObject(e["data"])?e["data"]:{};if(i==="addItem"&&BX.type.isPlainObject(r["params"])){this.addWidget(r["params"],true)}else if(i="changeLayout"&&BX.type.isNotEmptyString(r["layoutType"])){this.setLayoutType(r["layoutType"])}},addWidget:function(t,e){var i=this.getWidgetCount();if(this._maxWidgetCount>0&&i>=this._maxWidgetCount){alert(this.getMessage("maxWidgetError").replace(/#MAX_WIDGET_COUNT#/gi,this._maxWidgetCount));return}var r=this.createRow({index:0,height:BX.type.isNumber(t["rowHeight"])?t["rowHeight"]:BX.CrmWidgetLayoutHeight.full,cellCount:1});var n=r.getCellByIndex(0).createWidget(t,0);n.layout();if(e){n.scrollIntoView()}this._dragDropController.registerRow(r);this.saveConfig(function(){n.openConfigDialog()})},createRow:function(t){var e=BX.util.getRandomString(6).toLowerCase();while(this._dynamicRowKeys.hasOwnProperty(e)){e=BX.util.getRandomString(8).toLowerCase()}var i=this._prefix+"_"+e;this._dynamicRowKeys[e]=i;var r=t["index"];var n=t["height"];var s=t["cellCount"];var o=BX.CrmWidgetPanelRow.create(i,{panel:this,height:n,dynamicKey:e});for(var a=0;a<s;a++){o.ensureCellCreated(a,false)}this._rows.splice(r,0,o);o.layout();return o},removeRow:function(t){for(var e=0;e<this._rows.length;e++){if(this._rows[e]===t){var i=t.getSetting("dynamicKey","");if(i!==""){delete this._dynamicRowKeys[i]}t.clearLayout();this._rows.splice(e,1);return}}},moveWidget:function(t,e,i,r){t.clearLayout();t.undock();e.ensureCellCreated(i);var n=e.getCellByIndex(i);t.dock(n,r);t.layout()},processWidgetRemoval:function(t){var e=t.getRow();if(!e){return}if(!t.remove()){return}this._dragDropController.processRowChange(e);this.saveConfig()},processWidgetRefresh:function(t){this._dragDropController.processWidgetChange(t)},processLayoutTypeChange:function(){var t="crm-widget";if(this._layoutType===BX.CrmWidgetLayout.l70r30){t="crm-widget-70-30"}else if(this._layoutType===BX.CrmWidgetLayout.l50r50){t="crm-widget-50-50"}else if(this._layoutType===BX.CrmWidgetLayout.l30r70){t="crm-widget-30-70"}this._container.className=t},layout:function(){for(var t=0;t<this._rows.length;t++){this._rows[t].layout()}this._dragDropController=BX.CrmWidgetDragDropController.create(this._id,{panel:this,wrapper:this._container,rows:this._rows})},saveConfig:function(t){var e=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(e)){throw"BX.CrmWidgetPanel: Parameter 'serviceUrl' is not found."}var i={guid:this._id,action:"saveconfig",rows:[]};for(var r=0;r<this._rows.length;r++){i["rows"].push(this._rows[r].getConfig())}if(BX.type.isFunction(t)){this._saveConfigCallback=t}BX.showWait();BX.ajax.post(e,i,BX.delegate(this.onAfterConfigSave,this))},resetConfig:function(t){var e=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(e)){throw"BX.CrmWidgetPanel: Parameter 'serviceUrl' is not found."}var i={guid:this._id,action:"resetrows",rows:[]};for(var r=0;r<this._rows.length;r++){i["rows"].push(this._rows[r].getConfig())}if(BX.type.isFunction(t)){this._saveConfigCallback=t}BX.showWait();BX.ajax.post(e,i,BX.delegate(this.onAfterConfigSave,this))},enableDemoMode:function(t,e){t=!!t;window.setTimeout(this.reloadWindow.bind(this),200);var i=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(i)){throw"BX.CrmWidgetPanel: Parameter 'serviceUrl' is not found."}i=BX.util.add_url_param(i,{hideDemo:this._id});var r={guid:this._id,action:"enabledemo",enable:t?"Y":"N"};if(BX.type.isFunction(e)){this._saveConfigCallback=e}BX.showWait();BX.ajax.post(i,r,BX.delegate(this.onAfterConfigSave,this))},isAjaxMode:function(){return this._isAjaxMode},invalidate:function(){for(var t=0;t<this._rows.length;t++){this._rows[t].invalidate()}},onAfterConfigSave:function(){BX.closeWait();if(this._saveConfigCallback){this._saveConfigCallback();this._saveConfigCallback=null}},onSettingButtonClick:function(){if(!this._isSettingMenuShown){this.openSettingMenu()}else{this.closeSettingMenu()}},openSettingMenu:function(){if(this._isSettingMenuShown){return}this._settingMenuId=this._id+"_menu";if(typeof BX.PopupMenu.Data[this._settingMenuId]!=="undefined"){BX.PopupMenu.Data[this._settingMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._settingMenuId]}var t=[];if(!this._isDemoMode){t.push({id:"add",text:this.getMessage("menuItemAdd"),onclick:this._settingMenuHandler})}t.push({id:"layout",text:this.getMessage("menuChangeLayout"),onclick:this._settingMenuHandler});t.push({id:"reset",text:this.getMessage("menuItemReset"),onclick:this._settingMenuHandler});if(!this._isDemoMode&&this._useDemoMode){t.push({id:"enabledemomode",text:this.getMessage("menuItemEnableDemoMode"),onclick:this._settingMenuHandler})}this._settingMenu=BX.PopupMenu.create(this._settingMenuId,this._settingButton,t,{autoHide:true,offsetLeft:-21,offsetTop:-3,angle:{position:"top",offset:42},events:{onPopupClose:BX.delegate(this.onSettingMenuClose,this)}});this._settingMenu.popupWindow.show();this._isSettingMenuShown=true},closeSettingMenu:function(){if(this._settingMenu&&this._settingMenu.popupWindow){this._settingMenu.popupWindow.close()}},onSettingMenuClose:function(){this._settingMenu=null;if(typeof BX.PopupMenu.Data[this._settingMenuId]!=="undefined"){BX.PopupMenu.Data[this._settingMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._settingMenuId]}this._isSettingMenuShown=false},onSettingMenuItemClick:function(t,e){this.processAction(e.id);this.closeSettingMenu()},onDisableDemoButtonClick:function(t){this.enableDemoMode(false,this.reloadWindow.bind(this))},onDemoInfoCloseButtonClick:function(){if(this._disableDemoModeButton){BX.unbind(this._disableDemoModeButton,"click",this._disableDemoButtonClickHandler);this._disableDemoModeButton=null}if(this._demoModeInfoCloseButton){BX.unbind(this._demoModeInfoCloseButton,"click",this._demoModeInfoCloseButtonClickHandler);this._demoModeInfoCloseButton=null}BX.cleanNode(this._demoModeInfoContainer,true);this._demoModeInfoContainer=null},onFilterApply:function(t,e,i){this.reloadWindow()},processAction:function(t){if(t==="add"){var e=this.getWidgetCount();if(this._maxWidgetCount>0&&e>=this._maxWidgetCount){alert(this.getMessage("maxWidgetError").replace(/#MAX_WIDGET_COUNT#/gi,this._maxWidgetCount))}else{this.openTypeSelector()}}else if(t==="layout"){this.openLayoutTypeSelector()}else if(t==="reset"){this.resetConfig(this.reloadWindow.bind(this))}else if(t==="enabledemomode"){this.enableDemoMode(true,this.reloadWindow.bind(this))}},reloadWindow:function(){window.location.reload()}};if(typeof BX.CrmWidgetPanel.messages==="undefined"){BX.CrmWidgetPanel.messages={}}BX.CrmWidgetPanel.isAjaxMode=false;BX.CrmWidgetPanel.current=null;BX.CrmWidgetPanel.create=function(t,e){var i=new BX.CrmWidgetPanel;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetLayout==="undefined"){BX.CrmWidgetLayout={undifined:"",l70r30:"L70R30",l50r50:"L50R50",l30r70:"L30R70",getAll:function(){return[this.l70r30,this.l50r50,this.l30r70]}}}if(typeof BX.CrmWidgetLayoutHeight==="undefined"){BX.CrmWidgetLayoutHeight={undifined:0,full:380,half:180}}if(typeof BX.CrmWidgetExpressionOperation==="undefined"){BX.CrmWidgetExpressionOperation={undefined:"",sum:"SUM",diff:"DIFF",percent:"PC",descriptions:{},prepareListItems:function(){var t=[];for(var e in this.descriptions){if(!this.descriptions.hasOwnProperty(e)){continue}t.push({value:e,text:this.descriptions[e]})}return t},getMessage:function(t){var e=BX.CrmWidgetExpressionOperation.messages;return e.hasOwnProperty(t)?e[t]:t},getDescription:function(t){return this.descriptions.hasOwnProperty(t)?this.descriptions[t]:""},getLegend:function(t){t=t.toUpperCase();if(t===this.diff){return this.getMessage("diffLegend")}else if(t===this.sum){return this.getMessage("sumLegend")}else if(t===this.percent){return this.getMessage("percentLegend")}return""},getHint:function(){return this.getMessage("hint")},getSign:function(t){t=t.toUpperCase();if(t===this.diff){return"&#8722;"}else if(t===this.sum){return"&#43;"}else if(t===this.percent){return"&#37;"}return""},getIconClassName:function(t){t=t.toUpperCase();if(t===this.diff){return"action-icon action-icon-minus"}else if(t===this.sum){return"action-icon action-icon-plus"}else if(t===this.percent){return"action-icon action-icon-persent"}return"action-icon"},getSymbolClassName:function(t){t=t.toUpperCase();if(t===this.diff){return"symbol symbol-minus"}else if(t===this.sum){return"symbol symbol-plus"}else if(t===this.percent){return"symbol symbol-persent"}return""}};if(typeof BX.CrmWidgetExpressionOperation.messages==="undefined"){BX.CrmWidgetExpressionOperation.messages={}}}if(typeof BX.CrmWidgetConfigControlMode==="undefined"){BX.CrmWidgetConfigControlMode={undifined:0,view:1,edit:2}}if(typeof BX.CrmWidgetFilterPeriod==="undefined"){BX.CrmWidgetFilterPeriod={undefined:"",year:"Y",quarter:"Q",month:"M",currentMonth:"M0",currentQuarter:"Q0",currentDay:"D0",lastDays90:"D90",lastDays60:"D60",lastDays30:"D30",lastDays7:"D7",lastDays0:"D0",descriptions:{},getDescription:function(t){return this.descriptions.hasOwnProperty(t)?this.descriptions[t]:""},prepareListItems:function(t,e){if(!t){t={}}e=!!e;var i=[];for(var r in this.descriptions){if(!this.descriptions.hasOwnProperty(r)){continue}if(r===BX.CrmWidgetFilterPeriod.undefined&&e){continue}var n=t.hasOwnProperty(r)?t[r]:this.descriptions[r];i.push({value:r,text:n})}return i},getPeriod:function(t){var e={start:null,end:null};var i,r,n,s;if(t.getPeriod()===BX.CrmWidgetFilterPeriod.year){e["start"]=new Date;e["start"].setFullYear(t.getYear(),0,1);e["end"]=new Date;e["end"].setFullYear(t.getYear(),11,31)}else if(t.getPeriod()===BX.CrmWidgetFilterPeriod.quarter){i=t.getQuarter();r=3*i-1;n=r-2;e["start"]=new Date;e["start"].setFullYear(t.getYear(),n,1);e["end"]=new Date;e["end"].setFullYear(t.getYear(),r+1,1);e["end"].setDate(e["end"].getDate()-1)}else if(t.getPeriod()===BX.CrmWidgetFilterPeriod.month){s=t.getMonth();e["start"]=new Date;e["start"].setFullYear(t.getYear(),s-1,1);e["end"]=new Date;e["end"].setFullYear(t.getYear(),s,1);e["end"].setDate(e["end"].getDate()-1)}else if(t.getPeriod()===BX.CrmWidgetFilterPeriod.currentMonth){e["start"]=new Date;e["start"].setFullYear(e["start"].getFullYear(),e["start"].getMonth(),1);e["end"]=new Date}else if(t.getPeriod()===BX.CrmWidgetFilterPeriod.currentQuarter){e["start"]=new Date;n=e["start"].getMonth();n=n<=2?0:n<=5?3:n<=8?6:9;e["start"].setFullYear(e["start"].getFullYear(),n,1);e["end"]=new Date}else if(t.getPeriod()===BX.CrmWidgetFilterPeriod.currentDay||t.getPeriod()===BX.CrmWidgetFilterPeriod.lastDays90||t.getPeriod()===BX.CrmWidgetFilterPeriod.lastDays60||t.getPeriod()===BX.CrmWidgetFilterPeriod.lastDays30||t.getPeriod()===BX.CrmWidgetFilterPeriod.lastDays7){e["start"]=new Date;e["end"]=new Date;var o=0;if(t.getPeriod()===BX.CrmWidgetFilterPeriod.lastDays90)o=90;else if(t.getPeriod()===BX.CrmWidgetFilterPeriod.lastDays60)o=60;else if(t.getPeriod()===BX.CrmWidgetFilterPeriod.lastDays30)o=30;else if(t.getPeriod()===BX.CrmWidgetFilterPeriod.lastDays7)o=7;e["start"].setDate(e["start"].getDate()-o)}if(e["start"])e["start"].setHours(0,0,0);if(e["end"])e["end"].setHours(23,59,59);return e}}}if(typeof BX.CrmWidgetColorScheme==="undefined"){BX.CrmWidgetColorScheme={undifined:"",red:"red",green:"green",blue:"blue",cyan:"cyan",yellow:"yellow",descriptions:{},infos:{red:{color:"#f02f2f"},green:{color:"#05d215"},blue:{color:"#4fc3f7"},cyan:{color:"#50c5d3"},yellow:{color:"#f7d622"}},getInfo:function(t){return typeof this.infos[t]!=="undefined"?this.infos[t]:null},prepareMenuItems:function(t){var e=[];for(var i in this.infos){if(!this.infos.hasOwnProperty(i)){continue}var r=this.infos[i]["color"];var n=this.descriptions[i];e.push({id:i,text:'<span class="color-item"><span style="background: '+r+';" class="color"></span>'+n+"</span>",onclick:t})}return e}}}if(typeof BX.CrmWidgetDataContext==="undefined"){BX.CrmWidgetDataContext={undefined:"",entity:"E",fund:"F",percent:"P",descriptions:{},prepareListItems:function(){var t=[];for(var e in this.descriptions){if(!this.descriptions.hasOwnProperty(e)){continue}t.push({value:e,text:this.descriptions[e]})}return t}}}if(typeof BX.CrmPhaseSemantics==="undefined"){BX.CrmPhaseSemantics={undefined:"",process:"P",success:"S",failure:"F",descriptions:{},detailedInfos:{},getCaption:function(t){return BX.type.isNotEmptyString(t)&&BX.type.isPlainObject(this.detailedInfos[t])&&BX.type.isNotEmptyString(this.detailedInfos[t]["caption"])?this.detailedInfos[t]["caption"]:""},getSelectorTitle:function(t){return BX.type.isNotEmptyString(t)&&BX.type.isPlainObject(this.detailedInfos[t])&&BX.type.isNotEmptyString(this.detailedInfos[t]["selectorTitle"])?this.detailedInfos[t]["selectorTitle"]:""},getGroupTitle:function(t){return BX.type.isNotEmptyString(t)&&BX.type.isPlainObject(this.detailedInfos[t])&&BX.type.isNotEmptyString(this.detailedInfos[t]["groupTitle"])?this.detailedInfos[t]["groupTitle"]:""},prepareListItems:function(t){var e=BX.type.isNotEmptyString(t)&&BX.type.isPlainObject(this.detailedInfos[t])&&BX.type.isPlainObject(this.detailedInfos[t]["descriptions"])?this.detailedInfos[t]["descriptions"]:this.descriptions;var i=[];for(var r in e){if(!e.hasOwnProperty(r)){continue}i.push({value:r,text:e[r]})}return i},isSupported:function(t){return t===BX.CrmEntityType.names.lead||t===BX.CrmEntityType.names.deal||t===BX.CrmEntityType.names.invoice}}}if(typeof BX.CrmWidgetManager==="undefined"){BX.CrmWidgetManager=function(){this._factories={};this._defaultFactory=null;this._requestQueue=null;this._isRequestRunning=false};BX.CrmWidgetManager.prototype={initialize:function(){this._requestQueue=[]},createWidget:function(t,e){e=e?e:{};var i=e.hasOwnProperty("config")?e["config"]:{};var r=i.hasOwnProperty("typeName")?i["typeName"]:"";if(r===""){throw"CrmWidgetManager: The type name is not found."}if(r==="funnel"){return BX.CrmFunnelWidget.create(t,e)}else if(r==="pie"){return BX.CrmPieWidget.create(t,e)}else if(r==="graph"||r==="bar"){return BX.CrmGraphWidget.create(t,e)}else if(r==="number"){return BX.CrmNumericWidget.create(t,e)}else if(r==="rating"){return BX.CrmRatingWidget.create(t,e)}else if(r==="custom"){return BX.CrmCustomWidget.create(t,e)}return BX.CrmWidget.create(t,e)},createConfigEditor:function(t,e,i,r){return this.resolveFactory(t).createConfigEditor(e,i,r)},createPresetEditor:function(t,e,i,r){return this.resolveFactory(t).createPresetEditor(e,i,r)},prepareWidgetData:function(t){this.addToQueueItem(t,"PREPARE_DATA",{CONTROL:t.getConfig(),FILTER:BX.CrmWidgetManager.filter,CONTEXT_DATA:BX.CrmWidgetManager.contextData,CONTEXT_ENTITY_TYPE_NAME:BX.CrmWidgetManager.contextEntityTypeName,CONTEXT_ENTITY_ID:BX.CrmWidgetManager.contextEntityID});this.processQueue()},registerFactory:function(t,e){this._factories[t]=e},unregisterFactory:function(t){if(typeof this._factories[t]!=="undefined"){delete this._factories[t]}},getDefaultFactory:function(){if(this._defaultFactory===null){this._defaultFactory=BX.CrmWidgetFactory.create("default")}return this._defaultFactory},resolveFactory:function(t){if(typeof this._factories[t]!=="undefined"){return this._factories[t]}return this.getDefaultFactory()},addToQueueItem:function(t,e,i){var r=t.getId()+"_"+BX.util.getRandomString(8).toLowerCase();this._requestQueue.push({guid:r,widget:t,action:e,params:i})},getQueueItem:function(t){for(var e=0;e<this._requestQueue.length;e++){if(this._requestQueue[e]["guid"]===t){return this._requestQueue[e]}}return null},removeQueueItem:function(t){for(var e=0;e<this._requestQueue.length;e++){if(this._requestQueue[e]===t){this._requestQueue.splice(e,1);return true}}return false},processQueue:function(){if(this._isRequestRunning||this._requestQueue.length===0){return}var t=this._requestQueue[0];var e=t["params"];e["GUID"]=t["guid"];this._startRequest(t["action"],e)},getContextParam:function(t,e){var i=BX.CrmWidgetManager.contextData;return i.hasOwnProperty(t)?i[t]:e},_startRequest:function(t,e){if(this._isRequestRunning){return false}var i=BX.CrmWidgetManager.serviceUrl;if(!BX.type.isNotEmptyString(i)){throw"CrmWidgetManager: Could no start request. The fild 'serviceUrl' is not assigned."}this._isRequestRunning=true;BX.showWait();BX.ajax({url:i,method:"POST",dataType:"json",data:{ACTION:t,PARAMS:e},onsuccess:BX.delegate(this._onRequestSuccess,this),onfailure:BX.delegate(this._onRequestFailure,this)});return true},_onRequestSuccess:function(t){this._isRequestRunning=false;BX.closeWait();if(!BX.type.isPlainObject(t["RESULT"])){return}var e=t["RESULT"];var i=BX.type.isNotEmptyString(e["GUID"])?this.getQueueItem(e["GUID"]):null;if(!i){return}if(BX.type.isPlainObject(e["DATA"])){i["widget"].setData(e["DATA"]);i["widget"].refresh()}this.removeQueueItem(i)},_onRequestFailure:function(t){this._isRequestRunning=false;BX.closeWait()}};if(typeof BX.CrmWidgetManager.serviceUrl==="undefined"){BX.CrmWidgetManager.serviceUrl=""}if(typeof BX.CrmWidgetManager.filter==="undefined"){BX.CrmWidgetManager.filter={}}if(typeof BX.CrmWidgetManager.contextData==="undefined"){BX.CrmWidgetManager.contextData={}}if(typeof BX.CrmWidgetManager.contextEntityTypeName==="undefined"){BX.CrmWidgetManager.contextEntityTypeName=""}if(typeof BX.CrmWidgetManager.contextEntityID==="undefined"){BX.CrmWidgetManager.contextEntityID=0}BX.CrmWidgetManager.current=null;BX.CrmWidgetManager.getCurrent=function(){if(!this.current){this.current=new BX.CrmWidgetManager;this.current.initialize()}return this.current}}if(typeof BX.CrmWidgetDragDropController==="undefined"){BX.CrmWidgetDragDropController=function(){this._id="";this._settings=null;this.panel=null;this.wrapper=null;this.dropZoneListObj={};this.dropZoneList=[];this.dropZoneCounter=0;this.dropZoneActiveClass="crm-widget-catcher-inner-active";this.activeDragRow=null;this.prevEventPosX=0;this.prevEventPosY=0;this.isDropBlockShow=false};BX.CrmWidgetDragDropController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this.panel=e.panel;var i=e.rows;for(var r=0;r<i.length;r++){var n=i[r];n.getContainer().setAttribute("data-row-id",n.getId())}this.wrapper=e.wrapper;this.ddPlaceBlock=this.createDropZoneBlock();this.crmDnD=BX.DragDrop.create({dragItemClassName:"crm-widget",dropZoneList:this.dropZoneList,dragActiveClass:"crm-widget-drag-active",drag:BX.delegate(this.drag,this),dragStart:BX.delegate(this.dragStart,this),dragDrop:BX.delegate(this.dragDrop,this),dragEnter:BX.delegate(this.dragEnter,this),dragLeave:BX.delegate(this.dragLeave,this),dragEnd:BX.delegate(this.dragEnd,this),sortable:{rootElem:e.wrapper,className:"crm-widget-row",node:this.ddPlaceBlock}});this.initializeCellDropZones()},initializeCellDropZones:function(){var t=this.panel.getThinCells();for(var e=0;e<t.length;e++){var i=t[e];var r=i.getWidgetTotalHeight();if(r>BX.CrmWidgetLayoutHeight.half){continue}var n=i.getRow();var s=r>0?BX.CrmWidgetLayoutHeight.half:n.getHeight();var o=this.createDropZone({parentRowId:n.getId(),parentCellId:i.getId(),height:s,htmlHeight:s,position:n.getCellCount()>1?n.getCellIndex(i)>0?"right":"left":"wide"});o.style.display="none";i.getContainer().appendChild(o)}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getRowInfo:function(t){var e={height:0,node:null,index:0,chartsCount:0};var i=this.panel.getRowById(t);if(i){e.height=i.getHeight();e.node=i.getContainer();e.index=i.getIndex();e.chartsCount=i.getWidgetCount()}return e},getWidgetInfo:function(t){var e={height:0,node:null,parentRowId:"",parentCellId:"",rowIndex:-1,cellIndex:-1,index:-1};var i=this.panel.getWidgetById(t);if(i){var r=i.getCell();var n=r.getRow();e.height=i.getHeight();e.node=i.getWrapper();e.parentRowId=n.getId();e.parentCellId=r.getId();e.rowIndex=n.getIndex();e.cellIndex=r.getIndex();e.index=i.getIndex()}return e},createDropZone:function(t){var e=t.position||null,i=t.parentRowId||null,r=t.parentCellId||null,n=t.height,s=t.htmlHeight;var o="dropZone-"+this.dropZoneCounter;this.dropZoneCounter++;var a=BX.create("div",{props:{className:"crm-widget-catcher-inner"},attrs:{"data-dropZone-id":o},style:{height:s+"px"}});this.dropZoneListObj[o]={id:o,node:a,position:e,parentRowId:i,parentCellId:r,height:n};if(i)this.crmDnD.addCatcher(a);if(e)this.dropZoneList.push(a);return a},createDropZoneBlock:function(){return BX.create("div",{props:{className:"crm-widget-catcher-wrap"},children:[BX.create("div",{props:{className:"crm-widget-catcher crm-widget-left"},children:[this.createDropZone({position:"left",height:BX.CrmWidgetLayoutHeight.full,htmlHeight:55})]}),BX.create("div",{props:{className:"crm-widget-catcher crm-widget-right"},children:[this.createDropZone({position:"right",height:BX.CrmWidgetLayoutHeight.full,htmlHeight:55})]}),BX.create("div",{props:{className:"crm-widget-catcher crm-widget-bottom"},children:[this.createDropZone({position:"wide",height:BX.CrmWidgetLayoutHeight.full,htmlHeight:55})]})]})},showDropZone:function(t){for(var e in this.dropZoneListObj){if(t==BX.CrmWidgetLayoutHeight.half&&this.dropZoneListObj[e].height<=BX.CrmWidgetLayoutHeight.full)this.dropZoneListObj[e].node.style.display="block";else if(this.dropZoneListObj[e].height==BX.CrmWidgetLayoutHeight.full)this.dropZoneListObj[e].node.style.display="block"}},hideDropZone:function(){for(var t in this.dropZoneListObj){BX.removeClass(this.dropZoneListObj[t].node,this.dropZoneActiveClass);this.dropZoneListObj[t].node.style.display="none"}},showDropBlock:function(t){this.ddPlaceBlock.style.display="block";this.wrapper.insertBefore(this.ddPlaceBlock,t);setTimeout(BX.delegate(function(){this.ddPlaceBlock.style.height=133+"px"},this),50)},hideDropBlock:function(){this.ddPlaceBlock.style.height=0;this.isDropBlockShow=false;setTimeout(BX.delegate(function(){if(BX(this.wrapper)&&BX(this.ddPlaceBlock)&&this.ddPlaceBlock.parentNode===this.wrapper){this.wrapper.removeChild(this.ddPlaceBlock)}},this),300)},showNewRow:function(t){var e=this.getRowInfo(t);this.wrapper.insertBefore(e.node,this.ddPlaceBlock);e.node.setAttribute("data-row-id",t);e.node.style.opacity=0;e.node.style.height=133+"px";this.ddPlaceBlock.style.display="none";setTimeout(BX.delegate(function(){e.node.style.height=e.height+"px";e.node.style.opacity=1}),50)},getCellDropZone:function(t){for(var e in this.dropZoneListObj){if(!this.dropZoneListObj.hasOwnProperty(e)){continue}var i=this.dropZoneListObj[e];if(i.parentCellId===t){return i}}return null},registerRow:function(t){var e=t.getContainer();e.setAttribute("data-row-id",t.getId());this.crmDnD.addSortableItem(e);var i=t.getCells();for(var r=0;r<i.length;r++){var n=i[r].getWidgets();for(var s=0;s<n.length;s++){this.crmDnD.addDragItem([n[s].getWrapper()])}}this.processRowChange(t)},processWidgetChange:function(t){this.crmDnD.addDragItem([t.getWrapper()])},processRowChange:function(t){if(t.isEmpty()){this.crmDnD.removeSortableItem(t.getContainer());this.panel.removeRow(t);return}var e=0,i=null,r=0,n=0;var s=t.getCells();var o=s.length;for(e=0;e<o;e++){r=s[e].getWidgetTotalHeight();if(n<r){n=r}}var a=t.getHeight();if(a!==n){a=n>BX.CrmWidgetLayoutHeight.half?BX.CrmWidgetLayoutHeight.full:BX.CrmWidgetLayoutHeight.half;t.setHeight(a)}for(e=0;e<o;e++){i=s[e];r=i.getWidgetTotalHeight();var h=this.getCellDropZone(i.getId());var l=a-r>=BX.CrmWidgetLayoutHeight.half;if(!l&&h){delete this.dropZoneListObj[h.id];this.crmDnD.removeCatcher(h.node);BX.cleanNode(h.node,true)}else if(l){var g=r===0?a:BX.CrmWidgetLayoutHeight.half;if(h){delete this.dropZoneListObj[h.id];this.crmDnD.removeCatcher(h.node);BX.cleanNode(h.node,true)}var d=this.createDropZone({parentRowId:t.getId(),parentCellId:i.getId(),height:g,htmlHeight:g,position:o>1?i.getIndex()>0?"right":"left":"wide"});d.style.display="none";i.getContainer().appendChild(d)}}},dragStart:function(t){var e=t.dragElement.getAttribute("data-widget-id");var i=this.getWidgetInfo(e);var r=i.parentRowId;var n=this.getRowInfo(r).node;var s=i.height;this.showDropZone(s);this.activeDragRow=n;this.prevEventPosY=t.event.clientY;this.prevEventPosX=t.event.clientX},drag:function(t,e,i){this.dragClientY=i.clientFFY||i.clientY;if(this.dragClientY>this.prevEventPosY&&!this.isDropBlockShow){this.showDropBlock(this.activeDragRow.nextSibling);this.isDropBlockShow=true}else if(this.dragClientY<this.prevEventPosY&&!this.isDropBlockShow){this.showDropBlock(this.activeDragRow);this.isDropBlockShow=true}this.prevEventPosY=this.dragClientY},dragDrop:function(t,e){var i=t.getAttribute("data-dropZone-id");var r=this.dropZoneListObj[i];var n=e.getAttribute("data-widget-id");var s=this.panel.getWidgetById(n);var o=null;var a=0;var h=0;if(r.parentRowId){o=this.panel.getRowById(r.parentRowId);a=r.position==="right"?1:0;h=BX.CrmWidgetPanelCell.getItemWidgetCount(o.getCellByIndex(a))}else if(r.position){var l=this.panel.getRowCount();var g=BX.findNextSibling(this.ddPlaceBlock,{tagName:"DIV",className:"crm-widget-row"});if(g){l=this.panel.getRowById(g.getAttribute("data-row-id")).getIndex()}o=this.panel.createRow({index:l,height:s.getHeight(),cellCount:r.position==="wide"?1:2});a=r.position==="right"?1:0;h=0;var d=o.getId();this.crmDnD.addSortableItem(o.getContainer());this.showNewRow(d)}var c=s.getRow();this.panel.moveWidget(s,o,a,h);this.crmDnD.addDragItem([s.getWrapper()]);o=s.getRow();this.processRowChange(c);if(o!==c){this.processRowChange(o)}this.panel.saveConfig()},dragEnter:function(t){BX.addClass(t,this.dropZoneActiveClass)},dragLeave:function(t){BX.removeClass(t,this.dropZoneActiveClass)},dragEnd:function(){this.hideDropZone();this.hideDropBlock();this.isDropBlockShow=false}};BX.CrmWidgetDragDropController.items={};BX.CrmWidgetDragDropController.create=function(t,e){var i=new BX.CrmWidgetDragDropController;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmWidgetTypeSelector==="undefined"){BX.CrmWidgetTypeSelector=function(){this._id="";this._settings=null;this._currentEntityTypeName="";this._entityTypeNames=null;this._tabs=null;this._widgetTypeItems=null;this._widgetTypeContainer=null;this._tabSelectionHandler=BX.delegate(this.onTabSelection,this);this._widgetTypeSelectionHandler=BX.delegate(this.onWidgetTypeSelection,this);this._callback=null;this._dlg=null};BX.CrmWidgetTypeSelector.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._entityTypeNames=this.getSetting("entityTypeNames",[]);this._currentEntityTypeName=this._entityTypeNames.length>0?this._entityTypeNames[0]:"";this._callback=this.getSetting("callback");if(!BX.type.isFunction(this._callback)){this._callback=null}},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmWidgetTypeSelector.messages;return e.hasOwnProperty(t)?e[t]:t},isEntityTypeEnabled:function(t){for(var e=0;e<this._entityTypeNames.length;e++){if(this._entityTypeNames[e]===t){return true}}return false},openDialog:function(){if(this._dlg){return}var t=this._id;this._dlg=new BX.PopupWindow(t,null,{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:false,closeIcon:{top:"10px",right:"15px"},zIndex:0,titleBar:this.getMessage("dialogTitle"),content:this.prepareDialogContent(),buttons:[new BX.PopupWindowButtonLink({text:this.getMessage("dialogCancelButton"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this.onDialogCancelButtonClick,this)}})],events:{onPopupShow:BX.delegate(this.onDialogShow,this),onPopupClose:BX.delegate(this.onDialogClose,this),onPopupDestroy:BX.delegate(this.onDialogDestroy,this)}});this._dlg.show()},closeDialog:function(){if(this._dlg){this._dlg.close()}},isDialogOpened:function(){return this._dlg&&this._dlg.isShown()},prepareDialogContent:function(){var t=BX.create("DIV",{attrs:{className:"view-report-wrapper-container"}});var e=BX.create("DIV",{attrs:{className:"view-report-sidebar"}});t.appendChild(e);this._tabs=[];for(var i=0;i<BX.CrmWidgetTypeSelector.entityTypeInfos.length;i++){var r=BX.CrmWidgetTypeSelector.entityTypeInfos[i];var n=BX.type.isNotEmptyString(r["name"])?r["name"]:"";if(n===""){continue}var s=BX.type.isNotEmptyString(r["description"])?r["description"]:"";if(s===""){s=n}var o=this.isEntityTypeEnabled(n);var a=BX.CrmWidgetPanelConfiguratorTab.create(n,{title:s,isEnabled:o,isActive:this._currentEntityTypeName===n,container:e,configurator:this});this._tabs.push(a);a.addSelectionListener(this._tabSelectionHandler);a.layout()}var h=BX.create("DIV",{attrs:{className:"view-report-wrapper view-report-wrapper-popup"}});t.appendChild(h);this._widgetTypeContainer=BX.create("DIV",{attrs:{className:"view-report-wrapper-inner"}});h.appendChild(this._widgetTypeContainer);this._widgetTypeItems=[];for(var l=0;l<BX.CrmWidgetTypeSelector.infos.length;l++){var g=BX.CrmWidgetTypeSelector.infos[l];if(g["name"]==="funnel"&&(this.isEntityTypeEnabled("ACTIVITY")||this.isEntityTypeEnabled("CONTACT")||this.isEntityTypeEnabled("COMPANY"))){continue}var d=BX.CrmWidgetTypeSelectorItem.create(g["name"],{info:g,wrapper:this._widgetTypeContainer,configurator:this});this._widgetTypeItems.push(d);d.layout();d.addSelectionListener(this._widgetTypeSelectionHandler)}return t},onDialogShow:function(){},onDialogClose:function(){if(BX.type.isArray(this._tabs)){for(var t=0;t<this._tabs.length;t++){var e=this._tabs[t];e.removeSelectionListener(this._tabSelectionHandler);e.cleanLayout()}}this._tabs=null;if(this._dlg){this._dlg.destroy()}},onDialogDestroy:function(){this._dlg=null},onDialogCancelButtonClick:function(){this.closeDialog()},onTabSelection:function(t){var e=t.getId();if(this._currentEntityTypeName===e){return}this._currentEntityTypeName=e;for(var i=0,r=this._tabs.length;i<r;i++){var n=this._tabs[i];n.setActive(n.getId()===e)}},onWidgetTypeSelection:function(t){if(!this._callback){return}var e=t.getInfo();var i=BX.clone(e["params"]);i["entityTypeName"]=this._currentEntityTypeName;this._callback(this,{action:"addItem",data:{params:i}})}};if(typeof BX.CrmWidgetTypeSelector.messages==="undefined"){BX.CrmWidgetTypeSelector.messages={}}if(typeof BX.CrmWidgetTypeSelector.entityTypeInfos==="undefined"){BX.CrmWidgetTypeSelector.entityTypeInfos=[]}if(typeof BX.CrmWidgetTypeSelector.infos==="undefined"){BX.CrmWidgetTypeSelector.infos=[]}BX.CrmWidgetTypeSelector.create=function(t,e){var i=new BX.CrmWidgetTypeSelector;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetTypeSelectorItem==="undefined"){BX.CrmWidgetTypeSelectorItem=function(){this._id="";this._settings=null;this._info=null;this._configurator=null;this._wrapper=null;this._container=null;this._clickHandler=BX.delegate(this.onClick,this);this._selectionNotifier=null;this._hasLayout=false};BX.CrmWidgetTypeSelectorItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._info=this.getSetting("info");if(!this._info){throw"CrmWidgetTypeSelectorItem: The 'info' parameter is not found."}this._configurator=this.getSetting("configurator");if(!this._configurator){throw"CrmWidgetTypeSelectorItem: The 'configurator' parameter is not found."}this._wrapper=this.getSetting("wrapper");if(!this._wrapper){throw"CrmWidgetTypeSelectorItem: The 'wrapper' parameter is not found."}this._selectionNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getInfo:function(){return this._info},addSelectionListener:function(t){this._selectionNotifier.addListener(t)},removeSelectionListener:function(t){this._selectionNotifier.removeListener(t)},layout:function(){if(this._hasLayout){return}this._container=BX.create("DIV",{attrs:{className:"view-report-container"},children:[BX.create("DIV",{attrs:{className:"view-report"},children:[BX.create("IMG",{props:{src:this._info["logo"]}})]}),BX.create("DIV",{attrs:{className:"view-report-title"},text:this._info["title"]})]});BX.bind(this._container,"click",this._clickHandler);this._wrapper.appendChild(this._container);this._hasLayout=true},cleanLayout:function(){if(!this._hasLayout){return}BX.unbind(this._container,"click",this._clickHandler);BX.cleanNode(this._container,true);this._container=null;this._hasLayout=false},onClick:function(t){this._selectionNotifier.notify();return BX.PreventDefault(t)}};BX.CrmWidgetTypeSelectorItem.create=function(t,e){var i=new BX.CrmWidgetTypeSelectorItem;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetPanelLayoutTypeSelector==="undefined"){BX.CrmWidgetPanelLayoutTypeSelector=function(){this._id="";this._settings=null;this._layoutTypeItems=null;this._layoutType=BX.CrmWidgetLayout.undifined;this._layoutTypeContainer=null;this._layoutTypeSelectionHandler=BX.delegate(this.onLayoutTypeSelection,this);this._callback=null;this._dlg=null};BX.CrmWidgetPanelLayoutTypeSelector.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._layoutType=this.getSetting("layoutType",BX.CrmWidgetLayout.l50r50);this._callback=this.getSetting("callback");if(!BX.type.isFunction(this._callback)){this._callback=null}},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmWidgetPanelLayoutTypeSelector.messages;return e.hasOwnProperty(t)?e[t]:t},openDialog:function(){if(this._dlg){return}var t=this._id;this._dlg=new BX.PopupWindow(t,null,{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:false,closeIcon:{top:"10px",right:"15px"},zIndex:0,titleBar:this.getMessage("dialogTitle"),content:this.prepareDialogContent(),buttons:[new BX.PopupWindowButtonLink({text:this.getMessage("dialogCancelButton"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this.onDialogCancelButtonClick,this)}})],events:{onPopupShow:BX.delegate(this.onDialogShow,this),onPopupClose:BX.delegate(this.onDialogClose,this),onPopupDestroy:BX.delegate(this.onDialogDestroy,this)}});this._dlg.show()},closeDialog:function(){if(this._dlg){this._dlg.close()}},isDialogOpened:function(){return this._dlg&&this._dlg.isShown()},prepareDialogContent:function(){var t=BX.create("DIV",{attrs:{className:"view-report-wrapper-container"}});var e=BX.create("DIV",{attrs:{className:"view-report-wrapper view-report-wrapper-popup"}});t.appendChild(e);this._layoutTypeContainer=BX.create("DIV",{attrs:{className:"view-report-wrapper-inner"}});e.appendChild(this._layoutTypeContainer);this._layoutTypeItems=[];var i=BX.CrmWidgetLayout.getAll();for(var r=0;r<i.length;r++){var n=i[r];var s=BX.CrmWidgetPanelLayoutTypeItem.create(n,{layoutType:n,isActive:this._layoutType===n,container:this._layoutTypeContainer,configurator:this});this._layoutTypeItems.push(s);s.layout();s.addSelectionListener(this._layoutTypeSelectionHandler)}return t},onDialogShow:function(){},onDialogClose:function(){if(this._dlg){this._dlg.destroy()}},onDialogDestroy:function(){this._dlg=null},onDialogCancelButtonClick:function(){this.closeDialog()},onLayoutTypeSelection:function(t){if(!this._callback){return}this._layoutType=t.getLayoutType();this._callback(this,{action:"changeLayout",data:{layoutType:this._layoutType}})}};if(typeof BX.CrmWidgetPanelLayoutTypeSelector.messages==="undefined"){BX.CrmWidgetPanelLayoutTypeSelector.messages={}}BX.CrmWidgetPanelLayoutTypeSelector.create=function(t,e){var i=new BX.CrmWidgetPanelLayoutTypeSelector;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetPanelLayoutTypeItem==="undefined"){BX.CrmWidgetPanelLayoutTypeItem=function(){this._id="";this._settings=null;this._layoutType=BX.CrmWidgetLayout.undifined;this._container=null;this._configurator=null;this._isActive=false;this._clickHandler=BX.delegate(this.onClick,this);this._selectionNotifier=null;this._hasLayout=false};BX.CrmWidgetPanelLayoutTypeItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._layoutType=this.getSetting("layoutType");if(this._layoutType===BX.CrmWidgetLayout.undifined){throw"CrmWidgetPanelLayoutTypeItem: The 'layoutType' parameter is not found."}this._container=this.getSetting("container");if(!this._container){throw"CrmWidgetPanelLayoutTypeItem: The 'container' parameter is not found."}this._configurator=this.getSetting("configurator");if(!this._configurator){throw"CrmWidgetPanelLayoutTypeItem: The 'configurator' parameter is not found."}this._isActive=this.getSetting("isActive",false);this._selectionNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getLayoutType:function(){return this._layoutType},addSelectionListener:function(t){this._selectionNotifier.addListener(t)},removeSelectionListener:function(t){this._selectionNotifier.removeListener(t)},layout:function(){if(this._hasLayout){return}var t="crm-widget-template";if(this._isActive){t+=" crm-widget-template-active"}this._wrapper=BX.create("DIV",{attrs:{className:t}});this._container.appendChild(this._wrapper);var e=5;var i=5;if(this._layoutType===BX.CrmWidgetLayout.l30r70){e=3;i=7}else if(this._layoutType===BX.CrmWidgetLayout.l70r30){e=7;i=3}this._wrapper.appendChild(this.prepareTileLayout(e));this._wrapper.appendChild(this.prepareTileLayout(i));this._wrapper.appendChild(BX.create("BR"));this._wrapper.appendChild(this.prepareTileLayout(10));this._wrapper.appendChild(BX.create("BR"));this._wrapper.appendChild(this.prepareTileLayout(e));this._wrapper.appendChild(this.prepareTileLayout(i));BX.bind(this._wrapper,"click",this._clickHandler);this._hasLayout=true},prepareTileLayout:function(t){var e="crm-widget-template-item";if(t<10){e+=" template-item-"+t.toString()}return BX.create("DIV",{attrs:{className:e},text:(t*10).toString()+"%"})},cleanLayout:function(){if(!this._hasLayout){return}BX.unbind(this._wrapper,"click",this._clickHandler);BX.cleanNode(this._wrapper,true);this._wrapper=null;this._hasLayout=false},onClick:function(t){this._selectionNotifier.notify();return BX.PreventDefault(t)}};BX.CrmWidgetPanelLayoutTypeItem.create=function(t,e){var i=new BX.CrmWidgetPanelLayoutTypeItem;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetPanelConfiguratorTab==="undefined"){BX.CrmWidgetPanelConfiguratorTab=function(){this._id="";this._settings=null;this._title="";this._configurator=null;this._isEnabled=false;this._isActive=false;this._container=null;this._element=null;this._clickHandler=BX.delegate(this.onClick,this);this._selectionNotifier=null;this._hasLayout=false};BX.CrmWidgetPanelConfiguratorTab.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._title=this.getSetting("title");if(this._title===""){this._title=this._id}this._configurator=this.getSetting("configurator");if(!this._configurator){throw"CrmWidgetPanelConfiguratorTab: The 'configurator' parameter is not found."}this._container=this.getSetting("container");if(!this._container){throw"CrmWidgetPanelConfiguratorTab: The 'container' parameter is not found."}this._isActive=this.getSetting("isActive",false);this._isEnabled=this.getSetting("isEnabled",false);this._selectionNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},addSelectionListener:function(t){this._selectionNotifier.addListener(t)},removeSelectionListener:function(t){this._selectionNotifier.removeListener(t)},layout:function(){if(this._hasLayout){return}this._element=BX.create("A",{attrs:{className:"sidebar-tab"},props:{href:"#"},text:this._title});this._container.appendChild(this._element);BX.bind(this._element,"click",this._clickHandler);var t=this.getSetting("className","");if(t!==""){BX.addClass(this._element,t)}if(!this._isEnabled){BX.addClass(this._element,"sidebar-tab-disabled")}if(this._isActive){BX.addClass(this._element,"sidebar-tab-active")}this._hasLayout=true},cleanLayout:function(){if(!this._hasLayout){return}BX.unbind(this._element,"click",this._clickHandler);BX.cleanNode(this._element,true);this._element=null;this._hasLayout=false},isActive:function(){return this._isActive},setActive:function(t){t=!!t;this._isActive=t;if(t){BX.addClass(this._element,"sidebar-tab-active")}else{BX.removeClass(this._element,"sidebar-tab-active")}},onClick:function(t){if(this._isEnabled){this._selectionNotifier.notify()}return BX.PreventDefault(t)}};BX.CrmWidgetPanelConfiguratorTab.create=function(t,e){var i=new BX.CrmWidgetPanelConfiguratorTab;i.initialize(t,e);return i}}if(typeof BX.CrmWidgetDataGroup==="undefined"){BX.CrmWidgetDataGroup=function(){this._settings={};this._entityTypeName=""};BX.CrmWidgetDataGroup.undefined="";BX.CrmWidgetDataGroup.date="DATE";BX.CrmWidgetDataGroup.user="USER";BX.CrmWidgetDataGroup.prototype={initialize:function(t){this._settings=t?t:{};this._entityTypeName=this.getSetting("entityTypeName","")},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getDefault:function(){return BX.CrmWidgetDataGroup.date},isCommonGrouping:function(t){return BX.CrmWidgetDataGroup.isCommonGrouping(t)},prepareListItems:function(t){t=!!t;var e=[];var i=BX.CrmWidgetDataGroup.descriptions;for(var r in i){if(!i.hasOwnProperty(r)){continue}if(r!==BX.CrmWidgetDataGroup.undefined||t){e.push({value:r,text:i[r]})}}if(this._entityTypeName!==""){var n=BX.CrmWidgetDataGroup.extras;for(var s=0,o=n.length;s<o;s++){var a=n[s];if(!BX.type.isNotEmptyString(a["name"])){continue}if(BX.type.isNotEmptyString(a["entity"])&&a["entity"]===this._entityTypeName){e.push({value:a["name"],text:BX.type.isNotEmptyString(a["title"])?a["title"]:a["name"],attrs:{category:"extra"}})}}}return e}};if(typeof BX.CrmWidgetDataGroup.descriptions==="undefined"){BX.CrmWidgetDataGroup.descriptions={}}if(typeof BX.CrmWidgetDataGroup.extras==="undefined"){BX.CrmWidgetDataGroup.extras={}}BX.CrmWidgetDataGroup.isCommonGrouping=function(t){return t===this.date||t===this.user};BX.CrmWidgetDataGroup.create=function(t){var e=new BX.CrmWidgetDataGroup;e.initialize(t);return e}}if(typeof BX.CrmWidgetFactory==="undefined"){BX.CrmWidgetFactory=function(){this._id=""};BX.CrmWidgetFactory.prototype={initialize:function(t){this._id=BX.type.isNotEmptyString(t)?t:""},getId:function(){return this._id},createConfigEditor:function(t,e,i){if(t==="pie"){return BX.CrmPieWidgetConfigEditor.create(e,i)}else if(t==="graph"||t==="bar"){return BX.CrmGraphWidgetConfigEditor.create(e,i)}else if(t==="number"){return BX.CrmNumericWidgetConfigEditor.create(e,i)}else if(t==="rating"){return BX.CrmRatingWidgetConfigEditor.create(e,i)}return BX.CrmWidgetConfigEditor.create(e,i)},createPresetEditor:function(t,e,i){return BX.CrmWidgetConfigPresetEditor.create(e,i)}};BX.CrmWidgetFactory.create=function(t){var e=new BX.CrmWidgetFactory;e.initialize(t);return e}}if(typeof BX.CrmDealWidgetFactory==="undefined"){BX.CrmDealWidgetFactory=function(){this._id="";this._settings=null;this._basic=null};BX.CrmDealWidgetFactory.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._basic=BX.CrmWidgetFactory.create(this._id)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmDealWidgetFactory.messages;return e.hasOwnProperty(t)?e[t]:t},getCurrentCategoryId:function(){return parseInt(BX.CrmWidgetManager.getCurrent().getContextParam("dealCategoryID",-1))},createConfigEditor:function(t,e,i){if(t==="funnel"){var r=BX.CrmDealCategory.getDefaultValue();var n=BX.CrmDealCategory.getListItems();if(this.getCurrentCategoryId()>=0){n.unshift({value:"?",text:this.getMessage("current")});r="?"}i["extraEditors"]=[BX.CrmWidgetConfigSelectListEditor.create("dealCategorySelector",{configParamName:"dealCategoryID",configParamCaption:this.getMessage("categoryConfigParamCaption"),defaultValue:r,listItems:n})];return BX.CrmWidgetConfigEditor.create(e,i)}return this._basic.createConfigEditor(t,e,i)},createPresetEditor:function(t,e,i){var r=BX.CrmDealCategory.getListItems();if(this.getCurrentCategoryId()>=0){r.unshift({value:"?",text:this.getMessage("current")})}r.unshift({value:"",text:this.getMessage("notSelected")});i["extraEditors"]=[BX.CrmWidgetConfigSelectListEditor.create("dealCategorySelector",{configParamName:"dealCategoryID",configParamCaption:this.getMessage("categoryConfigParamCaption"),defaultValue:"",listItems:r})];return BX.CrmWidgetConfigPresetEditor.create(e,i)}};if(typeof BX.CrmDealWidgetFactory.messages==="undefined"){BX.CrmDealWidgetFactory.messages={}}BX.CrmDealWidgetFactory.create=function(t,e){var i=new BX.CrmDealWidgetFactory;i.initialize(t,e);return i}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/crm.interface.toolbar/templates/title/script.min.js?15441274012568";s:6:"source";s:73:"/bitrix/components/bitrix/crm.interface.toolbar/templates/title/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
if(typeof BX.InterfaceToolBar==="undefined"){BX.InterfaceToolBar=function(){this._id="";this._settings=null;this._container=null;this._menuButton=null;this._menuPopup=null;this._isMenuOpened=false;this._autoClose=false};BX.InterfaceToolBar.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:BX.CrmParamBag.create(null);this._menuButton=this._container=BX(this.getSetting("buttonId",""));this._bindElement=BX(this.getSetting("bindElementId",""))||this._menuButton;if(this._menuButton){BX.bind(this._menuButton,"click",BX.delegate(this.onMenuButtonClick,this))}this._autoClose=this._settings.getBooleanParam("autoClose",false)},getId:function(){return this._id},getSetting:function(e,t){return this._settings.getParam(e,t)},openMenu:function(e){if(this._isMenuOpened){this.closeMenu();return}var t=this.getSetting("items",null);if(!BX.type.isArray(t)){return}var n=/return\s+false(\s*;)?\s*$/;var i=/;\s*$/;var o=[];for(var u=0;u<t.length;u++){var s=t[u];var p=typeof s["SEPARATOR"]!=="undefined"?s["SEPARATOR"]:false;if(p){o.push({SEPARATOR:true,delimiter:true});continue}var a=typeof s["LINK"]!=="undefined"?s["LINK"]:"";var l=typeof s["ONCLICK"]!=="undefined"?s["ONCLICK"]:"";if(a!==""){var r='window.location.href = "'+a+'";';l=l!==""?r+" "+l:r}if(l!==""){if(!n.test(l)){if(!i.test(l)){l+=";"}if(!this._autoClose){l+=" return false;"}}}o.push({text:typeof s["TEXT"]!=="undefined"?s["TEXT"]:"",onclick:this._autoClose?this.onMenuItemClick.bind(this,l):l,className:typeof s["CLASS_NAME"]!=="undefined"?s["CLASS_NAME"]:"",disabled:typeof s["DISABLED"]!=="undefined"?s["DISABLED"]:false})}this._menuId=this._id.toLowerCase()+"_menu";BX.PopupMenu.show(this._menuId,this._bindElement,o,{autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:0,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._menuPopup=BX.PopupMenu.currentItem},closeMenu:function(){if(this._menuPopup){if(this._menuPopup.popupWindow){this._menuPopup.popupWindow.destroy()}}},onMenuButtonClick:function(e){this.openMenu()},onMenuItemClick:function(script){eval(script);if(this._menuPopup){this._menuPopup.close()}},onPopupShow:function(){this._isMenuOpened=true},onPopupClose:function(){this.closeMenu()},onPopupDestroy:function(){this._isMenuOpened=false;this._menuPopup=null;if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){delete BX.PopupMenu.Data[this._menuId]}}};BX.InterfaceToolBar.create=function(e,t){var n=new BX.InterfaceToolBar;n.initialize(e,t);return n}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/crm.interface.filter/templates/title/script.min.js?15441274012949";s:6:"source";s:72:"/bitrix/components/bitrix/crm.interface.filter/templates/title/script.js";s:3:"min";s:76:"/bitrix/components/bitrix/crm.interface.filter/templates/title/script.min.js";s:3:"map";s:76:"/bitrix/components/bitrix/crm.interface.filter/templates/title/script.map.js";}"*/
if(typeof BX.InterfaceGridFilterNavigationBar==="undefined"){BX.InterfaceGridFilterNavigationBar=function(){this._id="";this._settings=null;this._binding=null;this._items=null;this._activeItem=null};BX.InterfaceGridFilterNavigationBar.prototype={initialize:function(t,i){this._id=t;this._settings=i?i:BX.CrmParamBag.create(null);this._binding=this.getSetting("binding",null);this._items=[];var e=this.getSetting("items",[]);for(var n=0;n<e.length;n++){var r=e[n];var a=BX.type.isNotEmptyString(r["id"])?r["id"]:n;r["parent"]=this;var s=BX.InterfaceGridFilterNavigationBarItem.create(a,BX.CrmParamBag.create(r));if(this._activeItem===null&&s.isActive()){this._activeItem=s}this._items.push(s)}},getId:function(){return this._id},getSetting:function(t,i){return this._settings.getParam(t,i)},getBinding:function(){return this._binding},processMenuItemClick:function(t){if(!t.isActive()){t.openUrl()}}};BX.InterfaceGridFilterNavigationBar.create=function(t,i){var e=new BX.InterfaceGridFilterNavigationBar;e.initialize(t,i);return e}}if(typeof BX.InterfaceGridFilterNavigationBarItem==="undefined"){BX.InterfaceGridFilterNavigationBarItem=function(){this._id="";this._settings=null;this._parent=null;this._element=null;this._name="";this._isActive=false;this._elementClickHandler=BX.delegate(this.onElementClick,this)};BX.InterfaceGridFilterNavigationBarItem.prototype={initialize:function(t,i){this._id=t;this._settings=i?i:BX.CrmParamBag.create(null);this._name=this.getSetting("name","");this._parent=this.getSetting("parent");if(!this._parent){throw"InterfaceGridFilterNavigationBarItem: The parameter 'parent' is not found."}this._element=BX(this.getSetting("elementId"));if(!BX.type.isElementNode(this._element)){throw"InterfaceGridFilterNavigationBarItem: The parameter 'element' is not found."}BX.bind(this._element,"click",this._elementClickHandler);this._isActive=this.getSetting("active",false)},getId:function(){return this._id},getSetting:function(t,i){return this._settings.getParam(t,i)},getName:function(){return this._name},getElement:function(){return this._element},isActive:function(){return this._isActive},openUrl:function(){var t=this.getSetting("url","");if(t===""){return}var i=this._parent.getBinding();if(i){var e=BX.type.isNotEmptyString(i["category"])?i["category"]:"";var n=BX.type.isNotEmptyString(i["name"])?i["name"]:"";var r=BX.type.isNotEmptyString(i["key"])?i["key"]:"";if(e!==""&&n!==""&&r!==""){var a=new Date;var s=a.getFullYear().toString();var l=a.getMonth()+1;l=l>=10?l.toString():"0"+l.toString();var g=a.getDate();g=g>=10?g.toString():"0"+g.toString();var o=this._id+":"+s+l+g;BX.userOptions.save(e,n,r,o,false)}}setTimeout(function(){window.location.href=t},150)},onElementClick:function(t){this._parent.processMenuItemClick(this)}};BX.InterfaceGridFilterNavigationBarItem.create=function(t,i){var e=new BX.InterfaceGridFilterNavigationBarItem;e.initialize(t,i);return e}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/main.ui.selector/templates/.default/script.min.js?154412738410379";s:6:"source";s:71:"/bitrix/components/bitrix/main.ui.selector/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Main");BX.Main.selectorManager={getById:function(t){if(typeof this.controls[t]!="undefined"){return this.controls[t]}return null},controls:{}};BX.Main.Selector=function(){this.initialized=false;this.blockInit=false;this.id="";this.inputId=null;this.input=null;this.tagId=null;this.tag=null;this.options=null;this.callback=null;this.items=null;this.entities=null;this.mainPopupWindow=null;this.entitiesSet=["users","emails","crmemails","groups","sonetgroups","department","departmentRelation","contacts","companies","leads","deals"];this.auxObject=null};BX.Main.Selector.controls={};BX.Main.Selector.create=function(t){if(typeof t.id=="undefined"||!t.id){t.id=BX.util.hashCode(Math.random().toString())}else if(typeof BX.Main.selectorManager.controls[t.id]!="undefined"){return BX.Main.selectorManager.controls[t.id]}var e=new BX.Main.Selector;e.init(t);BX.Main.selectorManager.controls[e.getId()]=e;return e};BX.Main.Selector.proxyCallback=function(t,e){t(e)};BX.Main.Selector.prototype={init:function(t){try{if(!("SocNetLogDestination"in BX)){throw new ReferenceError("No BX.SocNetLogDestination detected. Forgot to include socialnetwork module and/or its assets?")}}catch(t){throw t}this.id=t.id;this.inputId=t.inputId?t.inputId:null;this.input=t.inputId&&BX(t.inputId)?BX(t.inputId):null;this.containerNode=t.containerId&&BX(t.containerId)?BX(t.containerId):null;this.bindNode=t.bindId&&BX(t.bindId)?BX(t.bindId):this.containerNode;this.tagId=t.tagId?t.tagId:null;this.tag=t.tagId&&BX(t.tagId)?BX(t.tagId):null;this.openDialogWhenInit=typeof t.openDialogWhenInit=="undefined"||!!t.openDialogWhenInit;this.options=t.options||{};this.callback=t.callback||null;this.items=t.items||null;this.entities=t.entities||null;var e={name:this.id,pathToAjax:t.pathToAjax?t.pathToAjax:null,searchInput:this.input||null,bindMainPopup:{node:this.bindNode,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:this.bindNode,offsetTop:"5px",offsetLeft:"15px"},userSearchArea:this.getOption("userSearchArea"),lazyLoad:this.getOption("lazyLoad")=="Y",useClientDatabase:this.getOption("useClientDatabase")=="Y",sendAjaxSearch:this.getOption("sendAjaxSearch")!="N",showSearchInput:this.getOption("useSearch")=="Y",allowAddUser:this.getOption("allowAddUser")=="Y",allowAddCrmContact:this.getOption("allowAddCrmContact")=="Y",allowAddSocNetGroup:this.getOption("allowAddSocNetGroup")=="Y",allowSearchEmailUsers:this.getOption("allowSearchEmailUsers")=="Y",allowSearchCrmEmailUsers:this.getOption("allowSearchCrmEmailUsers")=="Y",allowSearchNetworkUsers:this.getOption("allowSearchNetworkUsers")=="Y",enableDepartments:this.getOption("enableDepartments")=="Y",departmentSelectDisable:this.getOption("departmentSelectDisable")=="Y",enableSonetgroups:this.getOption("enableSonetgroups")=="Y",enableProjects:this.getOption("enableProjects")=="Y",isCrmFeed:this.getOption("isCrmFeed")=="Y",callback:{select:this.callback.select!=null?BX.delegate(function(t,e,i,n,o,a){this.getOption("useNewCallback")=="Y"?BX.Main.Selector.proxyCallback(this.callback.select,{name:o,item:t,type:e,search:i,bUndeleted:n,state:a}):this.callback.select(t,e,i,n,o,a)},this):null,unSelect:this.callback.unSelect!=null?BX.delegate(function(t,e,i,n){this.getOption("useNewCallback")=="Y"?BX.Main.Selector.proxyCallback(this.callback.unSelect,{name:n,item:t,type:e,search:i}):this.callback.unSelect(t,e,i,n)},this):null,openDialog:this.callback.openDialog!=null?BX.delegate(function(t){this.getOption("useNewCallback")=="Y"?BX.Main.Selector.proxyCallback(this.callback.openDialog,{name:t}):this.callback.openDialog(t)},this):null,closeDialog:this.callback.closeDialog!=null?BX.delegate(function(t){this.getOption("useNewCallback")=="Y"?BX.Main.Selector.proxyCallback(this.callback.closeDialog,{name:t}):this.callback.closeDialog(t)},this):null,openSearch:this.callback.openSearch!=null?BX.delegate(function(t){this.getOption("useNewCallback")=="Y"?BX.Main.Selector.proxyCallback(this.callback.openSearch,{name:t}):this.callback.openSearch(t)},this):null,closeSearch:this.callback.closeSearch!=null?BX.delegate(function(t){this.getOption("useNewCallback")=="Y"?BX.Main.Selector.proxyCallback(this.callback.closeSearch,{name:t}):this.callback.closeSearch(t)},this):null,openEmailAdd:this.callback.openEmailAdd!=null?BX.delegate(function(t){this.getOption("useNewCallback")=="Y"?BX.Main.Selector.proxyCallback(this.callback.openEmailAdd,{name:t}):this.callback.openEmailAdd(t)},this):null,closeEmailAdd:this.callback.closeEmailAdd!=null?BX.delegate(function(t){this.getOption("useNewCallback")=="Y"?BX.Main.Selector.proxyCallback(this.callback.closeEmailAdd,{name:t}):this.callback.closeEmailAdd(t)},this):null},allowSonetGroupsAjaxSearchFeatures:this.getOption("allowSonetGroupsAjaxSearchFeatures")};var i=null;e.items={};for(var n=0;n<this.entitiesSet.length;n++){i=this.entitiesSet[n];e.items[i]=this.entities[i]||{}}e.itemsLast={};e.itemsSelected=this.items.selected||{};BX.SocNetLogDestination.init(e);if(this.input){if(!this.options.lazyLoad){this.initDialog()}if(this.tag){BX.bind(this.tag,"focus",BX.delegate(function(t){this.initDialog({realParams:true,bByFocusEvent:true});return BX.PreventDefault(t)},this));BX.SocNetLogDestination.BXfpSetLinkName({formName:this.id,tagInputName:t.tagId,tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")})}BX.bind(this.input,"keydown",BX.proxy(BX.SocNetLogDestination.BXfpSearchBefore,{formName:this.id,inputName:t.inputId}));this.auxObject={formName:this.id,inputNode:BX(t.inputId),tagInputName:t.tagId};BX.bind(this.input,"bxchange",BX.proxy(BX.SocNetLogDestination.BXfpSearch,this.auxObject));this.input.setAttribute("data-bxchangehandler","Y")}else if(e.showSearchInput){if(!this.options.lazyLoad){this.initDialog()}}if(this.items.hidden){for(var o in this.items.hidden){if(this.items.hidden.hasOwnProperty(o)){this.callback.select.apply({id:(typeof this.items.hidden[o]["PREFIX"]!="undefined"?this.items.hidden[o]["PREFIX"]:"SG")+this.items.hidden[o]["ID"],name:this.items.hidden[o]["NAME"]},typeof this.items.hidden[o]["TYPE"]!="undefined"?this.items.hidden[o]["TYPE"]:"sonetgroups","",true,"","init")}}}},show:function(){this.initDialog()},initDialog:function(t){if(typeof t=="undefined"||typeof t.realParams=="undefined"){t=null}if(this.blockInit){return}var e={id:this.id};if(!this.initialized){BX.onCustomEvent(window,"BX.Main.Selector:beforeInitDialog",[e])}setTimeout(BX.delegate(function(){if(typeof e.blockInit=="undefined"||e.blockInit!==true){if(this.initialized){if(!this.mainPopupWindow||!this.mainPopupWindow.isShown()){this.openDialog(t)}}else{this.getData(BX.delegate(function(e){if(!!this.openDialogWhenInit){this.openDialog(t)}BX.onCustomEvent(window,"BX.Main.Selector:afterInitDialog",[{id:this.id}]);if(typeof this.options.eventOpen!="undefined"){BX.addCustomEvent(window,this.options.eventOpen,BX.delegate(function(t){if(typeof t.id=="undefined"||t.id!=this.id){return}if(t.bindNode){var e=BX.findChild(t.bindNode,{tagName:"input",attr:{type:"text"}},true);if(e){BX.bind(e,"keydown",BX.proxy(BX.SocNetLogDestination.BXfpSearchBefore,{formName:this.id,inputName:null,inputNode:e}));this.auxObject={formName:this.id,inputNode:e,tagInputName:t.tagId};BX.SocNetLogDestination.obElementBindMainPopup[this.id].node=e;BX.SocNetLogDestination.obElementBindSearchPopup[this.id].node=e;if(e.getAttribute("data-bxchangehandler")!=="Y"){BX.bind(e,"bxchange",BX.proxy(BX.SocNetLogDestination.BXfpSearch,this.auxObject));BX.SocNetLogDestination.obItemsSelected[this.id]={};e.setAttribute("data-bxchangehandler","Y")}if(typeof t.value!="undefined"){BX.SocNetLogDestination.obItemsSelected[this.id]=t.value}}this.openDialog({bindNode:t.bindNode})}},this))}},this))}}},this),1)},openDialog:function(t){BX.SocNetLogDestination.openDialog(this.id,t);this.mainPopupWindow=BX.SocNetLogDestination.popupWindow},closeDialog:function(){BX.SocNetLogDestination.closeDialog()},getData:function(t){this.blockInit=true;BX.ajax({url:"/bitrix/components/bitrix/main.ui.selector/ajax.php",method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),site:BX.message("SITE_ID"),options:this.options,action:"getData"},onsuccess:BX.delegate(function(e){this.blockInit=false;if(!!e.SUCCESS){this.addData(e.DATA,t);this.initialized=true}},this),onfailure:BX.delegate(function(t){this.blockInit=false},this)})},addData:function(t,e){function i(t,e){if(typeof e!="undefined"){if(typeof t=="undefined"){t={}}for(var i in e){if(e.hasOwnProperty(i)){t[i]=e[i]}}}}i(BX.SocNetLogDestination.obItems[this.id]["groups"],t.ITEMS.GROUPS);i(BX.SocNetLogDestination.obItems[this.id]["users"],t.ITEMS.USERS);i(BX.SocNetLogDestination.obItems[this.id]["emails"],t.ITEMS.EMAILS);i(BX.SocNetLogDestination.obItems[this.id]["crmemails"],t.ITEMS.CRMEMAILS);i(BX.SocNetLogDestination.obItems[this.id]["sonetgroups"],t.ITEMS.SONETGROUPS);i(BX.SocNetLogDestination.obItems[this.id]["department"],t.ITEMS.DEPARTMENT);BX.SocNetLogDestination.obItems[this.id]["departmentRelation"]=BX.SocNetLogDestination.buildDepartmentRelation(BX.SocNetLogDestination.obItems[this.id]["department"]);BX.SocNetLogDestination.obItemsLast[this.id]["users"]=typeof t["ITEMS_LAST"]["USERS"]!="undefined"?t["ITEMS_LAST"]["USERS"]:{};BX.SocNetLogDestination.obItemsLast[this.id]["emails"]=typeof t["ITEMS_LAST"]["EMAILS"]!="undefined"?t["ITEMS_LAST"]["EMAILS"]:{};BX.SocNetLogDestination.obItemsLast[this.id]["crmemails"]=typeof t["ITEMS_LAST"]["CRMEMAILS"]!="undefined"?t["ITEMS_LAST"]["CRMEMAILS"]:{};BX.SocNetLogDestination.obItemsLast[this.id]["sonetgroups"]=typeof t["ITEMS_LAST"]["SONETGROUPS"]!="undefined"?t["ITEMS_LAST"]["SONETGROUPS"]:{};BX.SocNetLogDestination.obItemsLast[this.id]["department"]=typeof t["ITEMS_LAST"]["DEPARTMENT"]!="undefined"?t["ITEMS_LAST"]["DEPARTMENT"]:{};BX.SocNetLogDestination.obItemsLast[this.id]["groups"]=typeof t["ITEMS_LAST"]["GROUPS"]!="undefined"?t["ITEMS_LAST"]["GROUPS"]:{};if(typeof t.ITEMS_LAST.CRM!="undefined"&&t.ITEMS_LAST.CRM.length>0){BX.SocNetLogDestination.obCrmFeed[this.id]=true}if(typeof t.SONETGROUPS_LIMITED!="undefined"&&t.SONETGROUPS_LIMITED=="Y"){BX.SocNetLogDestination.obAllowSonetGroupsAjaxSearch[this.id]=true}BX.SocNetLogDestination.obDestSort[this.id]=t.DEST_SORT;e.apply(this,t)},getId:function(){return this.id},getOption:function(t){return typeof this.options[t]!="undefined"?this.options[t]:null}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.ui.filter/templates/.default/script.min.js?154412738446925";s:6:"source";s:69:"/bitrix/components/bitrix/main.ui.filter/templates/.default/script.js";s:3:"min";s:73:"/bitrix/components/bitrix/main.ui.filter/templates/.default/script.min.js";s:3:"map";s:73:"/bitrix/components/bitrix/main.ui.filter/templates/.default/script.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main");BX.Main.Filter=function(t,e,s,i,r,a){this.params=t;this.search=null;this.popup=null;this.presets=null;this.fields=null;this.types=s;this.dateTypes=i;this.additionalDateTypes=a;this.numberTypes=r;this.settings=new BX.Filter.Settings(e,this);this.filter=null;this.api=null;this.isAddPresetModeState=false;this.firstInit=true;this.init()};function t(t){if(BX.type.isString(t)){t=t.toLowerCase();t=t.replace(/[\-_\s]+(.)?/g,function(t,e){return e?e.toUpperCase():""});return t.substr(0,1).toLowerCase()+t.substr(1)}return t}BX.Main.Filter.prototype={init:function(){BX.bind(document,"mousedown",BX.delegate(this._onDocumentClick,this));BX.bind(document,"keydown",BX.delegate(this._onDocumentKeydown,this));BX.bind(window,"load",BX.delegate(this.onWindowLoad,this));BX.addCustomEvent("Grid::ready",BX.delegate(this._onGridReady,this));this.getSearch().updatePreset(this.getParam("CURRENT_PRESET"))},onWindowLoad:function(){this.settings.get("AUTOFOCUS")&&this.adjustFocus()},clearGet:function(){if("history"in window){var t=window.location.toString();var e=BX.util.remove_url_param(t,"apply_filter");window.history.replaceState(null,"",e)}},adjustFocus:function(){this.getSearch().adjustFocus()},_onAddPresetKeydown:function(t){if(BX.Filter.Utils.isKey(t,"enter")){this._onSaveButtonClick()}},_onDocumentKeydown:function(t){if(BX.Filter.Utils.isKey(t,"escape")){if(this.getPopup().isShown()){BX.onCustomEvent(window,"BX.Main.Filter:blur",[this]);this.closePopup();if(this.getParam("VALUE_REQUIRED_MODE")){this.restoreRemovedPreset()}if(this.getParam("VALUE_REQUIRED")){if(!this.getSearch().getSquares().length){this.getPreset().applyPinnedPreset()}}}}},getApi:function(){if(!(this.api instanceof BX.Filter.Api)){this.api=new BX.Filter.Api(this)}return this.api},addSidebarItem:function(t,e,s){var i=this.getPreset();var r=i.getContainer();var a=i.createSidebarItem(t,e,s);var n=i.getPresetNodeById(t);if(BX.type.isDomNode(n)){BX.remove(n);BX.prepend(a,r)}else{r&&r.insertBefore(a,i.getAddPresetField())}BX.bind(a,"click",BX.delegate(i._onPresetClick,i))},saveUserSettings:function(t){var e={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER_ARRAY"};var s=this.getPreset();var i=s.getCurrentPresetId();var r={};this.params["PRESETS"]=BX.clone(this.editablePresets);r.current_preset=i;s.getPresets().forEach(function(e,i){var a=s.getPresetId(e);if(a&&a!=="tmp_filter"){var n=s.getPreset(a);n.TITLE=BX.util.htmlspecialchars(BX.util.htmlspecialcharsback(n.TITLE));n.SORT=i;s.updatePresetName(e,n.TITLE);r[a]={sort:i,name:n.TITLE,fields:this.preparePresetSettingsFields(n.FIELDS),for_all:t&&!BX.type.isBoolean(n.FOR_ALL)||t&&n.FOR_ALL===true}}},this);this.saveOptions(r,e,null,t)},isForAll:function(t){var e=this.getForAllCheckbox();return BX.type.isBoolean(t)&&t||!!e&&!!e.checked},getForAllCheckbox:function(){if(!this.forAllCheckbox){this.forAllCheckbox=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classForAllCheckbox)}return this.forAllCheckbox},preparePresetSettingsFields:function(t){var e={};var s;(t||[]).forEach(function(t){switch(t.TYPE){case this.types.STRING:{e[t.NAME]=t.VALUE;break}case this.types.SELECT:{e[t.NAME]="VALUE"in t.VALUE?t.VALUE.VALUE:"";break}case this.types.MULTI_SELECT:{if(BX.type.isArray(t.VALUE)&&t.VALUE.length){t.VALUE.forEach(function(s,i){e[t.NAME]=BX.type.isPlainObject(e[t.NAME])?e[t.NAME]:{};e[t.NAME][i]=s.VALUE},this)}break}case this.types.CHECKBOX:{if(BX.type.isArray(t.VALUE)&&t.VALUE.length){t.VALUE.forEach(function(s,i){e[t.NAME]=BX.type.isPlainObject(e[t.NAME])?e[t.NAME]:{};e[t.NAME][i]=s.VALUE},this)}break}case this.types.DATE:{if(BX.type.isPlainObject(t.VALUES)){s=Object.keys(t.VALUES);e[t.NAME+"_datesel"]=t.SUB_TYPE.VALUE;s.forEach(function(s){e[t.NAME+s]=t.VALUES[s]},this)}break}case this.types.NUMBER:{if(BX.type.isPlainObject(t.VALUES)){s=Object.keys(t.VALUES);e[t.NAME+"_numsel"]=t.SUB_TYPE.VALUE;s.forEach(function(s){e[t.NAME+s]=t.VALUES[s]},this)}break}case this.types.DEST_SELECTOR:{if(BX.type.isPlainObject(t.VALUES)){e[t.NAME]=t.VALUES._value;e[t.NAME+"_label"]=t.VALUES._label}break}case this.types.CUSTOM_ENTITY:{if(BX.type.isPlainObject(t.VALUES)){e[t.NAME]=t.VALUES._value;e[t.NAME+"_label"]=t.VALUES._label}break}default:{break}}},this);return e},savePreset:function(){var t="filter_"+ +new Date;var e=BX.util.htmlspecialcharsback(this.getPreset().getAddPresetFieldInput().value);this.updatePreset(t,e,null,true,null,null,true);this.addSidebarItem(t,e);this.getPreset().applyPreset(t);this.getPreset().activatePreset(t);this.applyFilter()},updatePreset:function(t,e,s,i,r,a,n){var l=this.getFilterFieldsValues();var o=this.getPreset().getFields().map(function(t){return BX.data(t,"name")});var h=this.getPreset().getCurrentPresetData();var d={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"};var u,c,f,p,g;var B={};B.additional={};if(t!=="tmp_filter"&&t!=="default_filter"&&!n){var E=BX.type.isArray(h.ADDITIONAL)?h.ADDITIONAL:[];E.forEach(function(t){Object.keys(l).forEach(function(e){if(e.indexOf(t.NAME)!==-1){B.additional[e]=l[e];delete l[e]}})})}u=Object.keys(l);if(!s){B.apply_filter="Y"}else{B.clear_filter="Y"}B.save="Y";B.fields=l;B.rows=o.join(",");B.preset_id=t||h.ID;if(BX.type.isNotEmptyString(e)){B.name=BX.util.htmlspecialchars(e)}else{f=this.getPreset().getPresetNodeById(B.preset_id);p=this.getPreset().getPresetInput(f);if(BX.type.isDomNode(p)&&BX.type.isNotEmptyString(p.value)){B.name=p.value}else{B.name=h.TITLE}}if((!("sort"in B)||!BX.type.isNumber(B.sort))&&i){g=this.getParam("PRESETS");B.sort=g.length+2}if(!s){u.forEach(function(t){if(BX.type.isArray(B.fields[t])){c=B.fields[t].length?{}:"";B.fields[t].forEach(function(t,e){c[e]=t},this);if(c||BX.type.isNumber(c)||BX.type.isBoolean(c)){B.fields[t]=c}}},this)}if(B.preset_id==="tmp_filter"||this.isAddPresetEnabled()||s){this.updateParams(B)}if(BX.type.isFunction(r)){r()}var m=new BX.Promise(null,this);m.setAutoResolve("fulfill",0);m.then(function(){var t=new BX.Promise(null,this);this.saveOptions(B,d,BX.proxy(t.fulfill,t));return t}).then(function(){!!a&&a()});return m},saveFieldsSort:function(){var t={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"};var e=this.getPreset().getFields();var s={};s.preset_id="default_filter";if(BX.type.isArray(e)){s.rows=e.map(function(t){return BX.data(t,"name")});s.rows=s.rows.join(",")}this.updateParams(s);this.saveOptions(s,t)},updateParams:function(t){var e,s;var i=[];if(BX.type.isPlainObject(t)&&"preset_id"in t){e=this.getPreset().getPreset(t.preset_id);if(BX.type.isPlainObject(e)){if("name"in t&&BX.type.isNotEmptyString(t.name)){e.TITLE=t.name}if("rows"in t&&!("fields"in t)){t.fields={};t.rows.split(",").forEach(function(e){t.fields[e]=""})}if("fields"in t){e.FIELDS=this.preparePresetFields(t.fields,t.rows)}if("additional"in t&&e.ID!=="tmp_filter"){e.ADDITIONAL=this.preparePresetFields(t.additional,t.rows)}}else{s=this.getParam("PRESETS");e={ID:t.preset_id,TITLE:t.name,SORT:s.length+2,FIELDS:this.preparePresetFields(t.fields,t.rows)};s.push(e)}}},preparePresetFields:function(t,e){var s,i;var r=[];if(BX.type.isPlainObject(t)){e=BX.type.isNotEmptyString(e)?e.split(","):[];s=e.length?e:Object.keys(t);s.forEach(function(e){e=e.replace("_datesel","").replace("_numsel","");i=BX.clone(this.getFieldByName(e));if(BX.type.isPlainObject(i)){if(i.TYPE===this.types.STRING){i.VALUE=t[e]}if(i.TYPE===this.types.MULTI_SELECT){i.VALUE=this.prepareMultiSelectValue(t[e],i.ITEMS)}if(i.TYPE===this.types.SELECT||i.TYPE===this.types.CHECKBOX){i.VALUE=this.prepareSelectValue(t[e],i.ITEMS)}if(i.TYPE===this.types.DATE){i.SUB_TYPE=this.prepareSelectValue(t[e+"_datesel"],i.SUB_TYPES);i.VALUES={_from:t[e+"_from"],_to:t[e+"_to"],_days:t[e+"_days"],_month:t[e+"_month"],_quarter:t[e+"_quarter"],_year:t[e+"_year"],_allow_year:t[e+"_allow_year"]}}if(i.TYPE===this.types.CUSTOM_DATE){i.VALUE={days:Object.keys(t[e+"_days"]||{}).map(function(s){return t[e+"_days"][s]}),months:Object.keys(t[e+"_months"]||{}).map(function(s){return t[e+"_months"][s]}),years:Object.keys(t[e+"_years"]||{}).map(function(s){return t[e+"_years"][s]})}}if(i.TYPE===this.types.NUMBER){i.SUB_TYPE=this.prepareSelectValue(t[e+"_numsel"],i.SUB_TYPES);i.VALUES={_from:t[e+"_from"],_to:t[e+"_to"]}}if(i.TYPE===this.types.DEST_SELECTOR){if(typeof t[e+"_label"]!=="undefined"){i.VALUES._label=t[e+"_label"]}if(typeof t[e]!=="undefined"){i.VALUES._value=t[e]}}if(i.TYPE===this.types.CUSTOM_ENTITY){if(typeof t[e+"_label"]!=="undefined"){i.VALUES._label=t[e+"_label"]}if(typeof t[e]!=="undefined"){i.VALUES._value=t[e]}}if(i.TYPE===this.types.CUSTOM){i._VALUE=t[e]}r.push(i)}},this)}return r},prepareSelectValue:function(t,e){var s={};var i;if(BX.type.isNotEmptyString(t)&&BX.type.isArray(e)){i=this.prepareMultiSelectValue({0:t},e);s=i.length>0?i[0]:{}}else{s=e[0]}return s},prepareMultiSelectValue:function(t,e){var s=[];if(BX.type.isPlainObject(t)&&BX.type.isArray(e)){var i=Object.keys(t);var r=i.map(function(e){return t[e]});s=e.filter(function(t){return r.some(function(e){return e===t.VALUE})},this)}return s},getFieldByName:function(t){var e=this.getParam("FIELDS");e=e.filter(function(e){return e.NAME===t},this);return e.length>0?e[0]:null},confirmSaveForAll:function(){return new Promise(function(t){var e={CONFIRM:true,CONFIRM_MESSAGE:this.getParam("MAIN_UI_FILTER__CONFIRM_MESSAGE_FOR_ALL"),CONFIRM_APPLY_BUTTON:this.getParam("MAIN_UI_FILTER__CONFIRM_APPLY_FOR_ALL"),CONFIRM_CANCEL_BUTTON:this.getParam("CONFIRM_CANCEL")};this.confirmDialog(e,t)}.bind(this))},saveOptions:function(e,s,i,r){s.action=t(s.action);s.forAll=this.isForAll(r);s.commonPresetsId=this.getParam("COMMON_PRESETS_ID");s.apply_filter=e.apply_filter||"N";s.clear_filter=e.clear_filter||"N";s.with_preset=e.with_preset||"N";s.save=e.save||"N";var a={params:s,data:e};delete e.apply_filter;delete e.save;delete e.clear_filter;delete e.with_preset;if(s.forAll&&s.action==="setFilterArray"){return this.confirmSaveForAll().then(function(){return this.backend(s.action,a)}.bind(this)).then(function(){this.disableEdit();this.disableAddPreset()}.bind(this))}return this.backend(s.action,a).then(function(){BX.removeClass(this.getFindButton(),this.settings.classWaitButtonClass);BX.type.isFunction(i)&&i()}.bind(this))},backend:function(t,e){return BX.ajax.runComponentAction("bitrix:main.ui.filter",t,{mode:"ajax",data:e})},prepareEvent:function(t){var e,s;if(!("path"in t)||!t.path.length){t.path=[t.target];e=0;while((s=t.path[e++].parentNode)!==null){t.path.push(s)}}return t},restoreRemovedPreset:function(){if(this.getParam("VALUE_REQUIRED_MODE")){var t=this.getParam("CURRENT_PRESET");if(BX.type.isPlainObject(t)){var e=t.ID;var s=this.getPreset().getPresetNodeById(e);this.getPreset().applyPreset(e);this.getPreset().activatePreset(s)}}},hasScrollClick:function(t){var e="clientX"in t?t.clientX:"x"in t?t.x:0;return e>=document.documentElement.offsetWidth},isUseCommonPresets:function(){return!!this.getParam("COMMON_PRESETS_ID")},isInsideFilterEvent:function(t){t=this.prepareEvent(t);return(t.path||[]).some(function(t){return BX.type.isDomNode(t)&&(BX.hasClass(t,this.settings.classFilterContainer)||BX.hasClass(t,this.settings.classSearchContainer)||BX.hasClass(t,this.settings.classDefaultPopup)||BX.hasClass(t,this.settings.classPopupOverlay))},this)},_onDocumentClick:function(t){var e=this.getPopup();if(!this.isInsideFilterEvent(t)&&!this.hasScrollClick(t)){if(e&&e.isShown()){this.closePopup();if(this.getParam("VALUE_REQUIRED_MODE")){this.restoreRemovedPreset()}if(this.getParam("VALUE_REQUIRED")){if(!this.getSearch().getSquares().length){this.getPreset().applyPinnedPreset()}}}BX.onCustomEvent(window,"BX.Main.Filter:blur",[this])}},_onAddFieldClick:function(t){var e=this.getFieldsPopup();t.stopPropagation();t.preventDefault();if(e&&!e.isShown()){this.showFieldsPopup();this.syncFields()}else{this.closeFieldListPopup()}},syncFields:function(t){if(BX.type.isPlainObject(t)){if(t.cache===false){this.fieldsPopupItems=null}}var e=this.getPreset().getFields();var s=this.getFieldsPopupItems();var i,r;if(BX.type.isArray(s)&&s.length){s.forEach(function(t){i=BX.data(t,"name").replace("_datesel","").replace("_numsel","");r=e.some(function(t){return BX.data(t,"name")===i});if(r){BX.addClass(t,this.settings.classMenuItemChecked)}else{BX.removeClass(t,this.settings.classMenuItemChecked)}},this)}},getFieldsPopupItems:function(){if(!BX.type.isArray(this.fieldsPopupItems)){var t=this.getFieldsPopup();if("contentContainer"in t&&BX.type.isDomNode(t.contentContainer)){this.fieldsPopupItems=BX.Filter.Utils.getByClass(t.contentContainer,this.settings.classMenuItem,true)}}return this.fieldsPopupItems},getFieldListContainerClassName:function(t){var e=this.settings.classPopupFieldList1Column;if(t>6&&t<12){e=this.settings.classPopupFieldList2Column}if(t>12){e=this.settings.classPopupFieldList3Column}return e},prepareFieldsDecl:function(t){return(t||[]).map(function(t){return{block:"main-ui-filter-field-list-item",label:"LABEL"in t?t.LABEL:"",id:"ID"in t?t.ID:"",name:"NAME"in t?t.NAME:"",item:t,onClick:BX.delegate(this._clickOnFieldListItem,this)}},this)},getLazyLoadFields:function(){var t=new BX.Promise;BX.ajax({method:"GET",url:this.getParam("LAZY_LOAD")["GET_LIST"],dataType:"json",onsuccess:function(e){t.fulfill(e)}});return t},getFieldsListPopupContent:function(){var t=new BX.Promise;var e=this.getParam("FIELDS");var s=BX.type.isArray(e)?e.length:0;if(this.getParam("LAZY_LOAD")){this.getLazyLoadFields().then(function(e){var s={block:this.settings.classPopupFieldList,mix:this.getFieldListContainerClassName(e.length),content:this.prepareFieldsDecl(e)};t.fulfill(BX.decl(s))}.bind(this));return t}var i={block:this.settings.classPopupFieldList,mix:this.getFieldListContainerClassName(s),content:this.prepareFieldsDecl(e)};t.fulfill(BX.decl(i));return t},getFieldLoader:function(){if(!this.fieldLoader){this.fieldLoader=new BX.Loader({mode:"custom",size:18,offset:{left:"5px",top:"5px"}})}return this.fieldLoader},_clickOnFieldListItem:function(t){var e=t.target;var s;if(!BX.hasClass(e,this.settings.classFieldListItem)){e=BX.findParent(e,{className:this.settings.classFieldListItem},true,false)}if(BX.type.isDomNode(e)){try{s=JSON.parse(BX.data(e,"item"))}catch(t){}var i=new BX.Promise;if(this.getParam("LAZY_LOAD")){this.getFieldLoader().show(e);var r=e.querySelector(".main-ui-select-inner-label");if(r){r.classList.add("main-ui-no-before")}this.getLazyLoadField(s.NAME).then(function(t){i.fulfill(t);this.getFieldLoader().hide();if(r){r.classList.remove("main-ui-no-before")}}.bind(this))}else{i.fulfill(s)}i.then(function(t){this.params.FIELDS.push(t);if(BX.hasClass(e,this.settings.classMenuItemChecked)){BX.removeClass(e,this.settings.classMenuItemChecked);this.getPreset().removeField(t)}else{if(BX.type.isPlainObject(t)){this.getPreset().addField(t);BX.addClass(e,this.settings.classMenuItemChecked);if(BX.type.isString(t.HTML)){var s=BX.create("div");this.getHiddenElement().appendChild(s);BX.html(s,t.HTML)}}}this.syncFields()}.bind(this))}},getHiddenElement:function(){if(!this.hiddenElement){this.hiddenElement=BX.create("div");document.body.appendChild(this.hiddenElement)}return this.hiddenElement},getLazyLoadField:function(t){var e=new BX.Promise;BX.ajax({method:"get",url:BX.util.add_url_param(this.getParam("LAZY_LOAD")["GET_FIELD"],{id:t}),dataType:"json",onsuccess:function(t){e.fulfill(t)}});return e},showFieldsPopup:function(){var t=this.getFieldsPopup();this.adjustFieldListPopupPosition();t.show()},closeFieldListPopup:function(){var t=this.getFieldsPopup();t.close()},adjustFieldListPopupPosition:function(){var t=this.getFieldsPopup();var e=BX.pos(this.getAddField());e.forceBindPosition=true;t.adjustPosition(e)},getFieldsPopup:function(){var t=this.getAddField();if(!this.fieldsPopup){this.fieldsPopup=new BX.PopupWindow(this.getParam("FILTER_ID")+"_fields_popup",t,{autoHide:true,offsetTop:4,offsetLeft:0,lightShadow:true,closeIcon:false,closeByEsc:false,noAllPaddings:true,zIndex:13});this.fieldsPopupLoader=new BX.Loader({target:this.fieldsPopup.contentContainer});this.fieldsPopupLoader.show();this.fieldsPopup.contentContainer.style.width="630px";this.fieldsPopup.contentContainer.style.height="330px";this.getFieldsListPopupContent().then(function(t){this.fieldsPopup.contentContainer.removeAttribute("style");this.fieldsPopupLoader.hide();this.fieldsPopup.setContent(t);this.syncFields({cache:false})}.bind(this))}return this.fieldsPopup},_onAddPresetClick:function(){this.enableAddPreset()},enableWaitSate:function(t){!!t&&BX.addClass(t,this.settings.classWaitButtonClass)},disableWaitState:function(t){!!t&&BX.removeClass(t,this.settings.classWaitButtonClass)},_onSaveButtonClick:function(){var t=!!this.getSaveForAllCheckbox()&&this.getSaveForAllCheckbox().checked;var e=this.getPreset().getAddPresetFieldInput();var s=e.parentNode.querySelector(".main-ui-filter-edit-mask");var i;function r(t){if(t.animationName==="fieldError"){t.currentTarget.removeEventListener("animationend",r);t.currentTarget.removeEventListener("oAnimationEnd",r);t.currentTarget.removeEventListener("webkitAnimationEnd",r);t.currentTarget.classList.remove("main-ui-filter-error")}}function a(t){t.addEventListener("animationend",r);t.addEventListener("oAnimationEnd",r);t.addEventListener("webkitAnimationEnd",r);t.classList.add("main-ui-filter-error");var e=new BX.Promise;e.fulfill(true);return e}this.enableWaitSate(this.getFindButton());if(this.isAddPresetEnabled()&&!t){i=e.value;if(i.length){this.savePreset();this.disableAddPreset()}else{a(s).then(function(){e.focus()})}}if(this.isEditEnabled()){var n=this.getPreset();var l=n.getPresetNodeById(n.getCurrentPresetId());var o=n.getPresetInput(l);if(o.value.length){n.updateEditablePreset(n.getCurrentPresetId());this.saveUserSettings(t);!t&&this.disableEdit()}else{var h=l.querySelector(".main-ui-filter-edit-mask");a(h).then(function(){o.focus()})}}},_onCancelButtonClick:function(){this.disableAddPreset();this.getPreset().clearAddPresetFieldInput();this.disableEdit();!!this.getSaveForAllCheckbox()&&(this.getSaveForAllCheckbox().checked=null)},_onGridReady:function(t){if(!this.grid&&t.getContainerId()===this.getParam("GRID_ID")){this.grid=t}},_onFilterMousedown:function(t){var e=t.target;if(this.getFields().isDragButton(e)){var s=BX.Filter.Utils.getByTag(e.parentNode,"input",true);(s||[]).forEach(function(t){BX.fireEvent(t,"blur")});BX.fireEvent(this.getFilter(),"click")}},_onFilterClick:function(t){var e=this.getFields();var s=this.getPreset();var i;if(e.isFieldDelete(t.target)){i=e.getField(t.target);s.removeField(i)}if(e.isFieldValueDelete(t.target)){i=e.getField(t.target);e.clearFieldValue(i)}},getButtonsContainer:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classButtonsContainer)},getSaveButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classSaveButton)},getCancelButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classCancelButton)},getFindButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classFindButton)},getResetButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classResetButton)},getAddPresetButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classAddPresetButton)},isAddPresetEnabled:function(){return this.isAddPresetModeState},enableAddPreset:function(){var t=this.getPreset();var e=t.getAddPresetField();var s=t.getAddPresetFieldInput();var i=this.getButtonsContainer();BX.show(e);BX.show(i);BX.hide(this.getPresetButtonsContainer());this.hideForAllCheckbox();if(BX.type.isDomNode(s)){s.focus()}BX.addClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.isAddPresetModeState=true},disableAddPreset:function(){var t=this.getPreset();var e=t.getAddPresetField();var s=this.getButtonsContainer();BX.hide(e);BX.hide(s);BX.show(this.getPresetButtonsContainer());this.showForAllCheckbox();t.getAddPresetFieldInput().value="";BX.removeClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.isAddPresetModeState=false},getControls:function(){var t=this.getFieldListContainer();var e=null;if(BX.type.isDomNode(t)){e=BX.Filter.Utils.getByClass(t,this.settings.classControl,true)}return e},getFilterFields:function(){var t=this.getFieldListContainer();var e=[];var s=[];if(BX.type.isDomNode(t)){e=BX.Filter.Utils.getByClass(t,this.settings.classField,true);s=BX.Filter.Utils.getByClass(t,this.settings.classFieldGroup,true);if(!BX.type.isArray(e)){e=[]}if(BX.type.isArray(s)){s.forEach(function(t){e.push(t)})}}return e},getFilterFieldsValues:function(){var t=this.getPreset().getFields();var e=this.getSearch();var s={};var i,r;s["FIND"]=e.getInput().value;if(BX.type.isArray(t)&&t.length){t.forEach(function(t){i=BX.data(t,"type");r=BX.data(t,"name");switch(i){case this.types.STRING:{this.prepareControlStringValue(s,t);break}case this.types.NUMBER:{this.prepareControlNumberValue(s,r,t);break}case this.types.DATE:{this.prepareControlDateValue(s,r,t);break}case this.types.CUSTOM_DATE:{this.prepareControlCustomDateValue(s,r,t);break}case this.types.SELECT:{this.prepareControlSelectValue(s,r,t);break}case this.types.MULTI_SELECT:{this.prepareControlMultiselectValue(s,r,t);break}case this.types.DEST_SELECTOR:{this.prepareControlCustomEntityValue(s,r,t);break}case this.types.CUSTOM:{this.prepareControlCustomValue(s,r,t);break}case this.types.CUSTOM_ENTITY:{this.prepareControlCustomEntityValue(s,r,t);break}default:{break}}},this)}return s},prepareControlCustomEntityValue:function(t,e,s){var i=this.fetchSquares(s);var r=this.fetchSquaresData(i);var a=BX.Main.ui.CustomEntity.isMultiple(s);t[e]="";t[e+"_label"]="";if(a){t[e]=[];t[e+"_label"]=[];!!r&&r.forEach(function(s){t[e].push(s._value.toString());t[e+"_label"].push(s._label.toString())})}else{if(r.length){t[e]=r[0]._value.toString();t[e+"_label"]=r[0]._label.toString()}}},fetchSquares:function(t){return!!t?BX.Filter.Utils.getByClass(t,this.settings.classSquare,true):[]},fetchSquaresData:function(t){return t.map(function(t){return JSON.parse(BX.data(t,"item"))},this)},prepareControlCustomValue:function(t,e,s){var i=BX.Filter.Utils.getByTag(s,"input",true);t[e]="";if(BX.type.isArray(i)){i.forEach(function(e){if(BX.type.isNotEmptyString(e.name)){t[e.name]=e.value}})}},prepareControlMultiselectValue:function(t,e,s){var i=BX.Filter.Utils.getByClass(s,this.settings.classMultiSelect);var r=JSON.parse(BX.data(i,"value"));t[e]="";if(BX.type.isArray(r)&&r.length){t[e]={};r.forEach(function(s,i){t[e][i]=s.VALUE})}},prepareControlSelectValue:function(t,e,s){var i=BX.Filter.Utils.getByClass(s,this.settings.classSelect);var r=JSON.parse(BX.data(i,"value"));t[e]=r.VALUE},prepareControlCustomDateValue:function(t,e,s){var i=s.querySelector('[data-name="'+e+"_days"+'"]');if(i){var r=JSON.parse(i.dataset.value);t[e+"_days"]=r.map(function(t){return t.VALUE})}var a=s.querySelector('[data-name="'+e+"_months"+'"]');if(a){var n=JSON.parse(a.dataset.value);t[e+"_months"]=n.map(function(t){return t.VALUE})}var l=s.querySelector('[data-name="'+e+"_years"+'"]');if(l){var o=JSON.parse(l.dataset.value);t[e+"_years"]=o.map(function(t){return t.VALUE})}},prepareControlDateValue:function(t,e,s){var i=BX.Filter.Utils.getByClass(s,this.settings.classSelect);var r=s.querySelector('.main-ui-select[data-name*="_allow_year"]');var a=e+this.settings.datePostfix;var n=e+this.settings.fromPostfix;var l=e+this.settings.toPostfix;var o=e+this.settings.daysPostfix;var h=e+this.settings.monthPostfix;var d=e+this.settings.quarterPostfix;var u=e+this.settings.yearPostfix;var c=e+"_allow_year";var f,p,g,B,E;t[a]="";t[n]="";t[l]="";t[o]="";t[h]="";t[d]="";t[u]="";f=JSON.parse(BX.data(i,"value"));t[a]=f.VALUE;if(r){E=JSON.parse(BX.data(r,"value"));t[c]=E.VALUE}switch(f.VALUE){case this.dateTypes.EXACT:{p=BX.Filter.Utils.getByClass(s,this.settings.classDateInput);t[n]=p.value;t[l]=p.value;break}case this.dateTypes.QUARTER:{g=BX.Filter.Utils.getByClass(s,this.settings.classControl,true);if(BX.type.isArray(g)){g.forEach(function(e){B=BX.data(e,"name");if(B&&B.indexOf("_quarter")!==-1){t[d]=JSON.parse(BX.data(e,"value")).VALUE}if(B&&B.indexOf("_year")!==-1){t[u]=JSON.parse(BX.data(e,"value")).VALUE}},this)}break}case this.dateTypes.YEAR:{g=BX.Filter.Utils.getByClass(s,this.settings.classControl,true);if(BX.type.isArray(g)){g.forEach(function(e){B=BX.data(e,"name");if(B&&B.indexOf("_year")!==-1){t[u]=JSON.parse(BX.data(e,"value")).VALUE}},this)}break}case this.dateTypes.MONTH:{g=BX.Filter.Utils.getByClass(s,this.settings.classControl,true);if(BX.type.isArray(g)){g.forEach(function(e){B=BX.data(e,"name");if(B&&B.indexOf("_month")!==-1){t[h]=JSON.parse(BX.data(e,"value")).VALUE}if(B&&B.indexOf("_year")!==-1){t[u]=JSON.parse(BX.data(e,"value")).VALUE}},this)}break}case this.additionalDateTypes.PREV_DAY:case this.additionalDateTypes.NEXT_DAY:case this.additionalDateTypes.MORE_THAN_DAYS_AGO:case this.additionalDateTypes.AFTER_DAYS:case this.dateTypes.NEXT_DAYS:case this.dateTypes.PREV_DAYS:{var m=BX.Filter.Utils.getByClass(s,this.settings.classNumberInput);if(!!m&&m.name===o){t[o]=m.value}break}case this.dateTypes.RANGE:{p=BX.Filter.Utils.getByClass(s,this.settings.classDateInput,true);p.forEach(function(e){if(e.name===n){t[n]=e.value}else if(e.name===l){t[l]=e.value}},this);break}case"CUSTOM_DATE":{var P={};this.prepareControlCustomDateValue(P,e,s);t[e+"_days"]=P[e+"_days"];t[h]=P[e+"_months"];t[u]=P[e+"_years"];break}default:{break}}},prepareControlNumberValue:function(t,e,s){var i=BX.Filter.Utils.getByClass(s,this.settings.classNumberInput,true);var r=BX.Filter.Utils.getByClass(s,this.settings.classSelect);var a=e+this.settings.numberPostfix;var n=e+this.settings.fromPostfix;var l=e+this.settings.toPostfix;var o;t[n]="";t[l]="";o=JSON.parse(BX.data(r,"value"));t[a]=o.VALUE;i.forEach(function(e){if(e.name.indexOf(this.settings.fromPostfix)!==-1){t[n]=e.value||"";if(t[a]==="exact"){t[l]=e.value||""}}else if(e.name.indexOf(this.settings.toPostfix)!==-1){t[l]=e.value||""}},this)},prepareControlStringValue:function(t,e){var s=BX.Filter.Utils.getByClass(e,this.settings.classStringInput);var i;if(BX.type.isDomNode(s)){i=s.name;t[i]=s.value}},showGridAnimation:function(){this.grid&&this.grid.tableFade()},hideGridAnimation:function(){this.grid&&this.grid.tableUnfade()},getPresetId:function(t,e){var s=this.getPreset().getCurrentPresetId();if(!this.isEditEnabled()&&!this.isAddPresetEnabled()&&!e||s==="default_filter"&&!t){s="tmp_filter"}return s},applyFilter:function(t,e){var s=this.getPresetId(t,e);var i=this.getParam("FILTER_ID");var r=new BX.Promise(null,this);var a=this.getPreset();var n=this.getSearch();var l={autoResolve:!this.grid};var o=this;this.clearGet();this.showGridAnimation();BX.onCustomEvent(window,"BX.Main.Filter:beforeApply",[i,{},this,r]);this.updatePreset(s,null,t,null).then(function(){n.updatePreset(a.getPreset(s));if(o.getParam("VALUE_REQUIRED")){if(!n.getSquares().length){o.lastPromise=a.applyPinnedPreset()}}}).then(function(){var t={apply_filter:"Y",clear_nav:"Y"};var e=BX.delegate(r.fulfill,r);var s=BX.delegate(r.reject,r);o.grid&&o.grid.reloadTable("POST",t,e,s);BX.onCustomEvent(window,"BX.Main.Filter:apply",[i,{},o,r,l]);l.autoResolve&&r.fulfill()});return r},getAddField:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classAddField)},getFieldListContainer:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classFileldControlList)},getFields:function(){if(!(this.fields instanceof BX.Filter.Fields)){this.fields=new BX.Filter.Fields(this)}return this.fields},getPreset:function(){if(!(this.presets instanceof BX.Filter.Presets)){this.presets=new BX.Filter.Presets(this)}return this.presets},resetControlData:function(t){if(BX.type.isPlainObject(t)){switch(t.TYPE){case this.types.MULTI_SELECT:{t.VALUE=[];break}case this.types.SELECT:{t.VALUE=t.ITEMS[0];break}case this.types.DATE:{t.SUB_TYPE=t.SUB_TYPES[0];t.VALUES={_from:"",_to:"",_days:"",_quarter:"",_year:""};break}case this.types.CUSTOM_DATE:{t.VALUES={days:[],months:[],years:[]};break}case this.types.NUMBER:{t.SUB_TYPE=t.SUB_TYPES[0];t.VALUES={_from:"",_to:""};break}case this.types.DEST_SELECTOR:{t.VALUES={_label:"",_value:""};break}case this.types.CUSTOM_ENTITY:{t.VALUES={_label:"",_value:""};break}case this.types.CUSTOM:{t._VALUE="";break}default:{t.VALUE=""}}}return t},clearControl:function(t){var e=this.getPreset().getField({NAME:t});var s,i;if(BX.type.isDomNode(e)){s=this.getFieldByName(t);s=this.resetControlData(s);i=this.getPreset().createControl(s);BX.insertAfter(i,e);BX.remove(e)}},clearControls:function(t){if(BX.type.isArray(t)){t.forEach(function(t){"name"in t&&this.clearControl(t.name)},this)}else if(BX.type.isPlainObject(t)&&"name"in t){this.clearControl(t.name)}},getTemplate:function(){return BX.html(BX(this.settings.generalTemplateId))},isIe:function(){if(!BX.type.isBoolean(this.ie)){this.ie=BX.hasClass(document.documentElement,"bx-ie")}return this.ie},closePopup:function(){var t=this.getPopup();var e=t.popupContainer;var s=this.settings.get("FILTER_CLOSE_DELAY");var i;setTimeout(BX.delegate(function(){if(!this.isIe()){BX.removeClass(e,this.settings.classAnimationShow);BX.addClass(e,this.settings.classAnimationClose);i=parseFloat(BX.style(e,"animation-duration"));if(BX.type.isNumber(i)){i=i*1e3}setTimeout(function(){t.close()},i)}else{t.close()}},this),s);this.closeFieldListPopup();this.adjustFocus()},showPopup:function(){var t=this.getPopup();var e;if(!t.isShown()){this.isOpened=true;var s=this.settings.get("FILTER_SHOW_DELAY");setTimeout(BX.delegate(function(){t.show();if(!this.isIe()){e=t.popupContainer;BX.removeClass(e,this.settings.classAnimationClose);BX.addClass(e,this.settings.classAnimationShow);BX.onCustomEvent(window,"BX.Main.Filter:show",[this])}},this),s)}},getSaveForAllCheckbox:function(){if(!this.saveForAllCheckbox&&!!this.getSaveForAllCheckboxContainer()){this.saveForAllCheckbox=BX.Filter.Utils.getBySelector(this.getSaveForAllCheckboxContainer(),'input[type="checkbox"]')}return this.saveForAllCheckbox},getSaveForAllCheckboxContainer:function(){if(!this.saveForAllCheckboxContainer){this.saveForAllCheckboxContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classForAllCheckbox)}return this.saveForAllCheckboxContainer},showForAllCheckbox:function(){!!this.getSaveForAllCheckboxContainer()&&BX.removeClass(this.getSaveForAllCheckboxContainer(),this.settings.classHide)},hideForAllCheckbox:function(){!!this.getSaveForAllCheckboxContainer()&&BX.addClass(this.getSaveForAllCheckboxContainer(),this.settings.classHide)},getPopupBindElement:function(){if(!this.popupBindElement){var t=this.settings.get("POPUP_BIND_ELEMENT_SELECTOR");var e=null;if(BX.type.isNotEmptyString(t)){e=BX.Filter.Utils.getBySelector(document,t)}this.popupBindElement=!!e?e:this.getSearch().getContainer()}return this.popupBindElement},getPopup:function(){if(!(this.popup instanceof BX.PopupWindow)){this.popup=new BX.PopupWindow(this.getParam("FILTER_ID")+this.settings.searchContainerPostfix,this.getPopupBindElement(),{autoHide:false,offsetTop:parseInt(this.settings.get("POPUP_OFFSET_TOP")),offsetLeft:parseInt(this.settings.get("POPUP_OFFSET_LEFT")),lightShadow:true,closeIcon:false,closeByEsc:false,noAllPaddings:true,zIndex:12});this.popup.setContent(this.getTemplate());BX.bind(this.getFieldListContainer(),"keydown",BX.delegate(this._onFieldsContainerKeydown,this));BX.bind(this.getFilter(),"click",BX.delegate(this._onFilterClick,this));BX.bind(this.getAddPresetButton(),"click",BX.delegate(this._onAddPresetClick,this));BX.bind(this.getPreset().getAddPresetFieldInput(),"keydown",BX.delegate(this._onAddPresetKeydown,this));BX.bind(this.getPreset().getContainer(),"keydown",BX.delegate(this._onPresetInputKeydown,this));BX.bind(this.getSaveButton(),"click",BX.delegate(this._onSaveButtonClick,this));BX.bind(this.getCancelButton(),"click",BX.delegate(this._onCancelButtonClick,this));BX.bind(this.getFindButton(),"click",BX.delegate(this._onFindButtonClick,this));BX.bind(this.getResetButton(),"click",BX.delegate(this._onResetButtonClick,this));BX.bind(this.getAddField(),"click",BX.delegate(this._onAddFieldClick,this));BX.bind(this.getEditButton(),"click",BX.delegate(this._onEditButtonClick,this));BX.bind(this.getRestoreButton(),"click",BX.delegate(this._onRestoreButtonClick,this));BX.bind(this.getRestoreFieldsButton(),"click",BX.delegate(this._onRestoreFieldsButtonClick,this));this.getFilter().addEventListener("mousedown",BX.delegate(this._onFilterMousedown,this),true);this.getPreset().showCurrentPresetFields();this.getPreset().bindOnPresetClick()}return this.popup},_onRestoreFieldsButtonClick:function(){this.restoreDefaultFields()},restoreDefaultFields:function(){var t=this.getPreset().getPreset("default_filter",true);var e=this.getParam("PRESETS");var s=this.getPreset().getCurrentPresetId();var i={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"};var r=t.FIELDS.map(function(t){return t.NAME});var a=r.join(",");e.forEach(function(s,i){if(s.ID==="default_filter"){e[i]=BX.clone(t)}},this);if(BX.type.isArray(this.editablePresets)){this.editablePresets.forEach(function(e,s){if(e.ID==="default_filter"){this.editablePresets[s]=BX.clone(t)}},this)}this.getPreset().applyPreset(s);this.updatePreset(s);this.saveOptions({preset_id:"default_filter",rows:a,save:"Y",apply_filter:"N"},i)},getRestoreFieldsButton:function(){if(!this.restoreFieldsButton){this.restoreFieldsButton=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classRestoreFieldsButton)}return this.restoreFieldsButton},restoreFilter:function(){var t=this.getParam("DEFAULT_PRESETS");var e=this.getParam("PRESETS");var s=false;var i,r,a;if(BX.type.isArray(t)){t.sort(function(t,e){return t.SORT<e.SORT});t.forEach(function(t){s=e.some(function(e,s){if(e.ID===t.ID){i=s;return true}});if(s){e[i]=BX.clone(t)}else{e.push(BX.clone(t))}if(t.ID!=="default_filter"){this.addSidebarItem(t.ID,t.TITLE,t.PINNED);if(t.PINNED){r=t.ID}}},this)}this.saveRestoreFilter();this.disableAddPreset();this.disableEdit();if(!r){r="default_filter"}a=this.getPreset().getPresetNodeById(r);if(a){BX.fireEvent(a,"click")}},saveRestoreFilter:function(){var t={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"RESTORE_FILTER"};var e=this.getParam("PRESETS");var s={};var i;if(BX.type.isArray(e)){e.forEach(function(t){i=t.FIELDS.map(function(t){return t.NAME});i=i.join(",");s[t.ID]={name:t.TITLE||null,sort:t.SORT,preset_id:t.ID,fields:this.prepareFields(t.FIELDS),rows:i,for_all:t.FOR_ALL}},this);this.saveOptions(s,t)}},prepareFields:function(t){var e={};var s;if(BX.type.isArray(t)){t.forEach(function(t){if(t.TYPE===this.types.SELECT){e[t.NAME]="VALUE"in t.VALUE?t.VALUE.VALUE:""}if(t.TYPE===this.types.MULTI_SELECT){t.VALUE.forEach(function(s,i){e[t.NAME]=e[t.NAME]||{};e[t.NAME][i]=s.VALUE});e[t.NAME]=e[t.NAME]||""}if(t.TYPE===this.types.DATE||t.TYPE===this.types.NUMBER){s=Object.keys(t.VALUES);s.forEach(function(s){e[t.NAME+s]=t.VALUES[s]});if(t.TYPE===this.types.DATE){e[t.NAME+"_datesel"]="VALUE"in t.SUB_TYPE?t.SUB_TYPE.VALUE:t.SUB_TYPES[0].VALUE}if(t.TYPE===this.types.NUMBER){e[t.NAME+"_numsel"]="VALUE"in t.SUB_TYPE?t.SUB_TYPE.VALUE:t.SUB_TYPES[0].VALUE}}if(t.TYPE===this.types.DEST_SELECTOR){e[t.NAME+"_label"]=t.VALUES._label;e[t.NAME+"_value"]=t.VALUES._value}if(t.TYPE===this.types.CUSTOM_ENTITY){e[t.NAME+"_label"]=t.VALUES._label;e[t.NAME+"_value"]=t.VALUES._value}},this)}return e},getRestoreButton:function(){if(!BX.type.isDomNode(this.restoreButton)){this.restoreButton=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classRestoreButton)}return this.restoreButton},_onPresetInputKeydown:function(t){if(BX.Filter.Utils.isKey(t,"enter")&&t.target.tagName==="INPUT"){BX.fireEvent(this.getSaveButton(),"click")}},_onFieldsContainerKeydown:function(t){if(BX.Filter.Utils.isKey(t,"enter")&&t.target.tagName==="INPUT"){BX.fireEvent(this.getFindButton(),"click")}},_onFindButtonClick:function(){var t=this.getPreset();var e=t.getCurrentPresetId();var s;if(e!=="tmp_filter"&&e!=="default_filter"&&!t.isPresetValuesModified(e)){var i=t.getPreset(e);var r=t.getAdditionalValues(e);var a=t.getFields().map(function(t){return BX.data(t,"name")});i.ADDITIONAL=this.preparePresetFields(r,a);i.ADDITIONAL=i.ADDITIONAL.filter(function(t){return!this.getPreset().isEmptyField(t)},this);t.applyPreset(e);s=this.applyFilter(false,e);this.closePopup()}else{t.deactivateAllPresets();s=this.applyFilter();this.closePopup()}return s},_onResetButtonClick:function(){if(this.getParam("VALUE_REQUIRED")){var t=this.getPreset().getCurrentPresetData();if(t.ADDITIONAL.length){this.closePopup()}BX.fireEvent(this.getSearch().getClearButton(),"click")}else{if(this.getParam("RESET_TO_DEFAULT_MODE")){this.getSearch().clearInput();this.getPreset().applyPinnedPreset()}else{this.resetFilter()}this.closePopup()}},resetFilter:function(t){var e=this.getSearch();var s=this.getPreset();if(!t){e.clearInput()}e.removePreset();s.deactivateAllPresets();s.resetPreset(true);e.hideClearButton();e.adjustPlaceholder();return this.applyFilter(true,true)},_onEditButtonClick:function(){if(!this.isEditEnabled()){this.enableEdit()}else{this.disableEdit()}},enableFieldsDragAndDrop:function(){var t=this.getPreset().getFields();this.fieldsList=[];if(BX.type.isArray(t)){this.fieldsList=t.map(this.registerDragItem,this)}},registerDragItem:function(t){var e=this.getDragButton(t);e.onbxdragstart=BX.delegate(this._onFieldDragStart,this);e.onbxdragstop=BX.delegate(this._onFieldDragStop,this);e.onbxdrag=BX.delegate(this._onFieldDrag,this);jsDD.registerObject(e);jsDD.registerDest(e);return t},unregisterDragItem:function(t){var e=this.getDragButton(t);jsDD.unregisterObject(e);jsDD.unregisterDest(e)},_onFieldDragStart:function(){this.dragItem=this.getFields().getField(jsDD.current_node);this.dragIndex=BX.Filter.Utils.getIndex(this.fieldsList,this.dragItem);this.dragRect=this.dragItem.getBoundingClientRect();this.offset=this.dragRect.height;this.dragStartOffset=jsDD.start_y-(this.dragRect.top+BX.scrollTop(window));BX.Filter.Utils.styleForEach(this.fieldsList,{transition:"100ms"});BX.addClass(this.dragItem,this.settings.classPresetOndrag);BX.bind(document,"mousemove",BX.delegate(this._onMouseMove,this))},_onFieldDragStop:function(){BX.unbind(document,"mousemove",BX.delegate(this._onMouseMove,this));BX.removeClass(this.dragItem,this.settings.classPresetOndrag);BX.Filter.Utils.styleForEach(this.fieldsList,{transition:"",transform:""});BX.Filter.Utils.collectionSort(this.dragItem,this.targetItem);this.fieldsList=this.getPreset().getFields();this.saveFieldsSort()},_onFieldDrag:function(){var t=this;var e,s;this.dragOffset=this.realY-this.dragRect.top-this.dragStartOffset;this.sortOffset=t.realY+BX.scrollTop(window);BX.Filter.Utils.styleForEach([this.dragItem],{transition:"0ms",transform:"translate3d(0px, "+this.dragOffset+"px, 0px)"});this.fieldsList.forEach(function(i,r){if(i){e=i.getBoundingClientRect();s=e.top+BX.scrollTop(window)+e.height/2;if(r>t.dragIndex&&t.sortOffset>s&&i.style.transform!=="translate3d(0px, "+-t.offset+"px, 0px)"&&i.style.transform!==""){t.targetItem=i;BX.style(i,"transform","translate3d(0px, "+-t.offset+"px, 0px)");BX.style(i,"transition","300ms")}if(r<t.dragIndex&&t.sortOffset<s&&i.style.transform!=="translate3d(0px, "+t.offset+"px, 0px)"&&i.style.transform!==""){t.targetItem=i;BX.style(i,"transform","translate3d(0px, "+t.offset+"px, 0px)");BX.style(i,"transition","300ms")}if((r<t.dragIndex&&t.sortOffset>s||r>t.dragIndex&&t.sortOffset<s)&&i.style.transform!=="translate3d(0px, 0px, 0px)"){if(i.style.transform!==""){t.targetItem=i}BX.style(i,"transform","translate3d(0px, 0px, 0px)");BX.style(i,"transition","300ms")}}})},disableFieldsDragAndDrop:function(){if(BX.type.isArray(this.fieldsList)&&this.fieldsList.length){this.fieldsList.map(this.unregisterDragItem,this)}},enablePresetsDragAndDrop:function(){var t,e,s,i;t=this.getPreset();e=t.getPresets();this.presetsList=[];if(BX.type.isArray(e)&&e.length){e.forEach(function(e){i=t.getPresetId(e);if(!BX.hasClass(e,this.settings.classAddPresetField)&&i!=="default_filter"&&!BX.hasClass(e,this.settings.classDefaultFilter)){s=this.getDragButton(e);s.onbxdragstart=BX.delegate(this._onDragStart,this);s.onbxdragstop=BX.delegate(this._onDragStop,this);s.onbxdrag=BX.delegate(this._onDrag,this);jsDD.registerObject(s);jsDD.registerDest(s);this.presetsList.push(e)}},this)}},getDragButton:function(t){return BX.Filter.Utils.getByClass(t,this.settings.classPresetDragButton)},disablePresetsDragAndDrop:function(){if(BX.type.isArray(this.presetsList)&&this.presetsList.length){this.presetsList.forEach(function(t){if(!BX.hasClass(t,this.settings.classAddPresetField)){jsDD.unregisterObject(t);jsDD.unregisterDest(t)}},this)}},_onDragStart:function(){this.dragItem=this.getPreset().normalizePreset(jsDD.current_node);this.dragIndex=BX.Filter.Utils.getIndex(this.presetsList,this.dragItem);this.dragRect=this.dragItem.getBoundingClientRect();this.offset=this.dragRect.height;this.dragStartOffset=jsDD.start_y-(this.dragRect.top+BX.scrollTop(window));BX.Filter.Utils.styleForEach(this.list,{transition:"100ms"});BX.addClass(this.dragItem,this.settings.classPresetOndrag);BX.bind(document,"mousemove",BX.delegate(this._onMouseMove,this))},_onMouseMove:function(t){this.realX=t.clientX;this.realY=t.clientY},getDragOffset:function(){return jsDD.x-this.startDragOffset-this.dragRect.left},_onDragStop:function(){var t,e;BX.unbind(document,"mousemove",BX.delegate(this._onMouseMove,this));BX.removeClass(this.dragItem,this.settings.classPresetOndrag);BX.Filter.Utils.styleForEach(this.presetsList,{transition:"",transform:""});BX.Filter.Utils.collectionSort(this.dragItem,this.targetItem);t=this.getPreset();e=t.getPresets();this.presetsList=[];if(BX.type.isArray(e)&&e.length){e.forEach(function(t){if(!BX.hasClass(t,this.settings.classAddPresetField)&&!BX.hasClass(t,this.settings.classDefaultFilter)){this.presetsList.push(t)}},this)}},_onDrag:function(){var t=this;var e,s;this.dragOffset=this.realY-this.dragRect.top-this.dragStartOffset;this.sortOffset=t.realY+BX.scrollTop(window);BX.Filter.Utils.styleForEach([this.dragItem],{transition:"0ms",transform:"translate3d(0px, "+this.dragOffset+"px, 0px)"});this.presetsList.forEach(function(i,r){if(i){e=i.getBoundingClientRect();s=e.top+BX.scrollTop(window)+e.height/2;if(r>t.dragIndex&&t.sortOffset>s&&i.style.transform!=="translate3d(0px, "+-t.offset+"px, 0px)"&&i.style.transform!==""){t.targetItem=i;BX.style(i,"transform","translate3d(0px, "+-t.offset+"px, 0px)");BX.style(i,"transition","300ms")}if(r<t.dragIndex&&t.sortOffset<s&&i.style.transform!=="translate3d(0px, "+t.offset+"px, 0px)"&&i.style.transform!==""){t.targetItem=i;BX.style(i,"transform","translate3d(0px, "+t.offset+"px, 0px)");BX.style(i,"transition","300ms")}if((r<t.dragIndex&&t.sortOffset>s||r>t.dragIndex&&t.sortOffset<s)&&i.style.transform!=="translate3d(0px, 0px, 0px)"){if(i.style.transform!==""){t.targetItem=i}BX.style(i,"transform","translate3d(0px, 0px, 0px)");BX.style(i,"transition","300ms")}}})},getSidebarControlsContainer:function(){if(!BX.type.isDomNode(this.sidebarControlsContainer)){this.sidebarControlsContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classSidebarControlsContainer)}return this.sidebarControlsContainer},enableEdit:function(){var t=this.getPreset();var e=t.getPresets();var s;if(BX.type.isArray(e)&&e.length){e.forEach(function(e){s=t.getPresetId(e);if(!BX.hasClass(e,this.settings.classAddPresetField)&&s!=="default_filter"){BX.addClass(e,this.settings.classPresetEdit)}},this)}this.enablePresetsDragAndDrop();BX.show(this.getButtonsContainer());BX.hide(this.getPresetButtonsContainer());BX.addClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.editablePresets=BX.clone(this.getParam("PRESETS"));this.isEditEnabledState=true},disableEdit:function(){var t=this.getPreset();var e=t.getPresets();if(BX.type.isArray(e)&&e.length){e.forEach(function(t){if(!BX.hasClass(t,this.settings.classAddPresetField)){BX.removeClass(t,this.settings.classPresetEdit);this.getPreset().disableEditPresetName(t)}},this)}this.disablePresetsDragAndDrop();if(!this.isAddPresetEnabled()){BX.style(this.getButtonsContainer(),"display","")}BX.show(this.getPresetButtonsContainer());BX.removeClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.editablePresets=null;this.isEditEnabledState=false;this.applyFilter(null,true)},getPresetButtonsContainer:function(){if(!BX.type.isDomNode(this.presetButtonsContainer)){this.presetButtonsContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classPresetButtonsContainer)}return this.presetButtonsContainer},isEditEnabled:function(){return this.isEditEnabledState},getEditButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classEditButton)},getParam:function(t,e){return t in this.params?this.params[t]:e},getFilter:function(){return BX.Filter.Utils.getByClass(this.getPopup().contentContainer,this.settings.classFilterContainer)},getSearch:function(){if(!(this.search instanceof BX.Filter.Search)){this.search=new BX.Filter.Search(this)}return this.search},_onRestoreButtonClick:function(){var t={CONFIRM:true,CONFIRM_MESSAGE:this.getParam("CONFIRM_MESSAGE"),CONFIRM_APPLY_BUTTON:this.getParam("CONFIRM_APPLY"),CONFIRM_CANCEL_BUTTON:this.getParam("CONFIRM_CANCEL")};this.confirmDialog(t,BX.delegate(this.restoreFilter,this))},confirmDialog:function(t,e,s){if("CONFIRM"in t&&t.CONFIRM){var i=this.getParam("FILTER_ID")+"-confirm-dialog";var r='<div class="main-ui-filter-confirm-content">'+t.CONFIRM_MESSAGE+"</div>";var a="CONFIRM_TITLE"in t?t.CONFIRM_TITLE:"";var n=new BX.PopupWindowButton({text:t.CONFIRM_APPLY_BUTTON,events:{click:function(){BX.type.isFunction(e)?e():null;this.popupWindow.close();this.popupWindow.destroy()}}});var l=new BX.PopupWindowButtonLink({text:t.CONFIRM_CANCEL_BUTTON,events:{click:function(){BX.type.isFunction(s)?s():null;this.popupWindow.close();this.popupWindow.destroy()}}});var o=new BX.PopupWindow(i,null,{content:r,titleBar:a,autoHide:false,zIndex:9999,overlay:.4,offsetTop:-100,closeIcon:true,closeByEsc:true,buttons:[n,l]});BX.addCustomEvent(o,"onPopupClose",BX.delegate(function(){!!this.getSaveForAllCheckbox()&&(this.getSaveForAllCheckbox().checked=null)},this));if(!o.isShown()){o.show();var h=o.popupContainer;BX.removeClass(h,this.settings.classAnimationShow);BX.addClass(h,this.settings.classAnimationShow)}}else{BX.type.isFunction(e)?e():null}}}})();(function(){BX.Main.filterManager={data:{},push:function(t,e){if(BX.type.isNotEmptyString(t)&&e){this.data[t]=e}},getById:function(t){var e=null;if(t in this.data){e=this.data[t]}return e}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:88:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/api.min.js?15441273841650";s:6:"source";s:69:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/api.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Filter");BX.Filter.Api=function(e){this.parent=e};BX.Filter.Api.prototype={setFields:function(e){var t,i;if(BX.type.isPlainObject(e)){this.parent.getPopup();t=this.parent.getPreset();t.deactivateAllPresets();i={preset_id:"tmp_filter",fields:e};this.parent.updateParams(i);t.applyPreset("tmp_filter")}},setFilter:function(e){if(typeof e==="object"){this.parent.updateParams(e);this.parent.getPreset().deactivateAllPresets();this.parent.getPreset().activatePreset(e.preset_id);this.parent.getPreset().applyPreset(e.preset_id);if(!e.checkFields||!this.parent.getPreset().isPresetValuesModified(e.preset_id)){this.parent.applyFilter(false,e.preset_id)}else{var t={};if(BX.type.isPlainObject(e.fields)){t=Object.assign({},e.fields)}if(BX.type.isPlainObject(e.additional)){t=Object.assign({},e.additional)}this.parent.getPreset().deactivateAllPresets();this.setFields(t);this.apply()}}},extendFilter:function(e){if(!!e&&typeof e==="object"){Object.keys(e).forEach(function(t){if(BX.type.isNumber(e[t])){e[t]=""+e[t]}});var t=this.parent.getPreset().getCurrentPresetId();if(t==="tmp_filter"||t==="default_filter"){var i=Object.assign({},this.parent.getFilterFieldsValues(),e);this.setFields(i);this.apply();return}var s=this.parent.getPreset().getAdditionalValues(t);if(BX.type.isPlainObject(s)&&Object.keys(s).length){e=Object.assign({},s,e)}this.setFilter({preset_id:t,additional:e,checkFields:true})}},apply:function(){if(!this.parent.isEditEnabled()){if(!this.parent.isEditEnabled()){this.parent.applyFilter()}this.parent.closePopup();if(this.parent.isAddPresetEnabled()){this.parent.disableAddPreset()}}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:105:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/destination-selector.min.js?15441273845460";s:6:"source";s:86:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/destination-selector.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Filter");BX.Filter.DestinationSelectorManager={fields:[],controls:{},onSelect:function(t){if(typeof t=="undefined"||!BX.type.isNotEmptyString(t.name)||typeof t.item=="undefined"||!BX.type.isNotEmptyString(t.type)){return}var e=t.name,i=t.type,o=t.item;BX.SocNetLogDestination.obItemsSelected[e]={};BX.SocNetLogDestination.obItemsSelected[e][o.id]=i;var n=BX.Filter.DestinationSelectorManager.controls[e];if(n){n.setData(BX.util.htmlspecialcharsback(o.name),o.id);n.getLabelNode().value="";n.getLabelNode().blur();if(BX.SocNetLogDestination.popupWindow!=null){BX.SocNetLogDestination.popupWindow.close()}if(BX.SocNetLogDestination.popupSearchWindow!=null){BX.SocNetLogDestination.popupSearchWindow.close()}}},onDialogOpen:function(t){if(typeof t=="undefined"||!BX.type.isNotEmptyString(t.name)){return}var e=t.name;var i=BX.Filter.DestinationSelector.items[e];if(i){i.onDialogOpen()}},onDialogClose:function(t){if(typeof t=="undefined"||!BX.type.isNotEmptyString(t.name)){return}var e=t.name;var i=BX.Filter.DestinationSelector.items[e];if(i){i.onDialogClose()}}};BX.Filter.DestinationSelector=function(){this.id="";this.filterId="";this.settings={};this.fieldId="";this.control=null;this.inited=null};BX.Filter.DestinationSelector.items={};BX.Filter.DestinationSelector.create=function(t,e){if(typeof this.items[t]!="undefined"){return this.items[t]}var i=new BX.Filter.DestinationSelector(t,e);i.initialize(t,e);this.items[t]=i;BX.onCustomEvent(window,"BX.Filter.DestinationSelector:create",[t]);return i};BX.Filter.DestinationSelector.prototype.getSetting=function(t,e){return this.settings.hasOwnProperty(t)?this.settings[t]:e};BX.Filter.DestinationSelector.prototype.getSearchInput=function(){return this.control?this.control.getLabelNode():null};BX.Filter.DestinationSelector.prototype.initialize=function(t,e){this.id=t;this.settings=e?e:{};this.fieldId=this.getSetting("fieldId","");this.filterId=this.getSetting("filterId","");this.inited=false;this.opened=null;var i=this.getSetting("initialValue",false);if(!!i){var o={};o[this.fieldId]=i.itemId;o[this.fieldId+"_label"]=i.itemName;BX.Main.filterManager.getById(this.filterId).getApi().setFields(o)}BX.addCustomEvent(window,"BX.Main.Filter:customEntityFocus",BX.delegate(this.onCustomEntitySelectorOpen,this));BX.addCustomEvent(window,"BX.Main.Filter:customEntityBlur",BX.delegate(this.onCustomEntitySelectorClose,this));BX.addCustomEvent(window,"BX.Main.Filter:onGetStopBlur",BX.delegate(this.onGetStopBlur,this));BX.addCustomEvent(window,"BX.Main.Selector:beforeInitDialog",BX.delegate(this.onBeforeInitDialog,this));BX.addCustomEvent(window,"BX.SocNetLogDestination:onBeforeSwitchTabFocus",BX.delegate(this.onBeforeSwitchTabFocus,this));BX.addCustomEvent(window,"BX.SocNetLogDestination:onBeforeSelectItemFocus",BX.delegate(this.onBeforeSelectItemFocus,this));BX.addCustomEvent(window,"BX.Main.Filter:customEntityRemove",BX.delegate(this.onCustomEntityRemove,this))};BX.Filter.DestinationSelector.prototype.open=function(){var t=this.id;if(!this.inited){var e=this.getSearchInput();e.id=e.name;BX.addCustomEvent(window,"BX.Main.Selector:afterInitDialog",BX.delegate(function(t){if(typeof t.id!="undefined"||t.id!=this.id){return}this.opened=true},this));BX.onCustomEvent(window,"BX.Filter.DestinationSelector:openInit",[{id:this.id,inputId:e.id,containerId:e.id}])}else{var i={};i[this.currentUser.entityId]="users";BX.onCustomEvent(window,"BX.Filter.DestinationSelector:open",[{id:this.id,bindNode:this.control.getField(),value:i}]);this.opened=true}};BX.Filter.DestinationSelector.prototype.close=function(){if(typeof BX.Main.selectorManager.controls[this.id]!=="undefined"){BX.Main.selectorManager.controls[this.id].closeDialog()}};BX.Filter.DestinationSelector.prototype.onCustomEntitySelectorOpen=function(t){var e=t.getId();if(this.fieldId!==e){this.control=null}else{this.control=t;if(this.control){var i=this.control.getCurrentValues();this.currentUser={entityId:i["value"]}}BX.Filter.DestinationSelectorManager.controls[this.id]=this.control;if(!this.opened){this.open()}else{this.close()}}};BX.Filter.DestinationSelector.prototype.onCustomEntitySelectorClose=function(t){if(this.fieldId===t.getId()&&this.inited===true&&this.opened===true){this.control=null;window.setTimeout(BX.delegate(this.close,this),0)}};BX.Filter.DestinationSelector.prototype.onGetStopBlur=function(t,e){if(BX.findParent(t.target,{className:"bx-lm-box"})){e.stopBlur=true}};BX.Filter.DestinationSelector.prototype.onCustomEntityRemove=function(t){if(this.fieldId===t.getId()){if(typeof t.hiddenInput!="undefined"&&typeof t.hiddenInput.value!="undefined"&&typeof BX.SocNetLogDestination.obItemsSelected[this.id]!="undefined"&&typeof BX.SocNetLogDestination.obItemsSelected[this.id][t.hiddenInput.value]!="undefined"){delete BX.SocNetLogDestination.obItemsSelected[this.id][t.hiddenInput.value]}}};BX.Filter.DestinationSelector.prototype.onBeforeSwitchTabFocus=function(t){if(this.id===t.id){t.blockFocus=true}};BX.Filter.DestinationSelector.prototype.onBeforeSelectItemFocus=function(t){if(this.id===t.id){t.blockFocus=true}};BX.Filter.DestinationSelector.prototype.onBeforeInitDialog=function(t){if(typeof t.id=="undefined"||t.id!=this.id){return}this.inited=true;if(!this.control){t.blockInit=true}};BX.Filter.DestinationSelector.prototype.onDialogOpen=function(){this.opened=true};BX.Filter.DestinationSelector.prototype.onDialogClose=function(){this.opened=false}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:101:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/field-controller.min.js?15441273842703";s:6:"source";s:82:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/field-controller.js";s:3:"min";s:86:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/field-controller.min.js";s:3:"map";s:86:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/field-controller.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Filter");BX.Filter.FieldController=function(t,e){this.field=null;this.parent=null;this.type=null;this.input=null;this.deleteButton=null;this.init(t,e)};BX.Filter.FieldController.prototype={init:function(t,e){if(!BX.type.isDomNode(t)){throw"BX.Filter.FieldController.init: field isn't dom node"}if(!(e instanceof BX.Main.Filter)){throw"BX.Filter.FieldController.init: parent not instance of BX.Main.ui.Filter"}this.field=t;this.parent=e;this.bind();this.isShowDelete()?this.showDelete():this.hideDelete()},isShowDelete:function(){var t=this.getSquares();return this.getInputValue()||BX.type.isArray(t)&&t.length},getField:function(){return this.field},getInput:function(){var t,e;if(!BX.type.isDomNode(this.input)){t=this.getType();e=this.parent.types;if(t===e.DATE){this.input=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classDateInput)}if(t===e.NUMBER||t==="number"){this.input=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classNumberInput)}if(t===e.STRING){this.input=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classStringInput)}if(t===e.CUSTOM_ENTITY){this.input=BX.Filter.Utils.getBySelector(this.getField(),'input[type="hidden"]')}}return this.input},getDeleteButton:function(){if(!BX.type.isDomNode(this.deleteButton)){this.deleteButton=BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classValueDelete)}return this.deleteButton},getSquares:function(){return BX.Filter.Utils.getByClass(this.getField(),this.parent.settings.classSquare)},bind:function(){if(this.getType()!==this.parent.types.MULTI_SELECT&&this.getType()!==this.parent.types.SELECT){BX.bind(this.getDeleteButton(),"click",BX.delegate(this._onDeleteClick,this));BX.bind(this.getInput(),"input",BX.delegate(this._onInput,this))}},clearInput:function(){var t=this.getInput();if(BX.type.isDomNode(t)){t.value=""}},hideDelete:function(){var t=this.getDeleteButton();if(BX.type.isDomNode(t)){BX.addClass(t,this.parent.settings.classHide)}},showDelete:function(){var t=this.getDeleteButton();if(BX.type.isDomNode(t)){BX.removeClass(t,this.parent.settings.classHide)}},removeSquares:function(){var t=this.getSquares();if(BX.type.isArray(t)&&t.length){t.forEach(function(t){BX.remove(t)})}},_onDeleteClick:function(){this.removeSquares();this.clearInput();this.hideDelete()},_onInput:function(){this.getInputValue()?this.showDelete():this.hideDelete()},getInputValue:function(){var t="";var e=this.getInput();if(BX.type.isDomNode(e)){t=e.value}return t},getType:function(){if(!BX.type.isNotEmptyString(this.type)){this.type=BX.data(this.getField(),"type")}return this.type}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/fields.min.js?154412738423035";s:6:"source";s:72:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/fields.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Filter");BX.Filter.Fields=function(t){this.parent=null;this.init(t)};BX.Filter.Fields.prototype={init:function(t){this.parent=t;BX.addCustomEvent(window,"UI::Select::change",BX.delegate(this._onDateTypeChange,this))},deleteField:function(t){BX.remove(t)},isFieldDelete:function(t){return BX.hasClass(t,this.parent.settings.classFieldDelete)},isFieldValueDelete:function(t){return BX.hasClass(t,this.parent.settings.classValueDelete)||BX.hasClass(t.parentNode,this.parent.settings.classValueDelete)},isDragButton:function(t){return t&&BX.hasClass(t,this.parent.settings.classPresetDragButton)},clearFieldValue:function(t){if(t){var e=BX.Filter.Utils.getByClass(t,this.parent.settings.classControl,true);var n=BX.Filter.Utils.getByClass(t,this.parent.settings.classSquare,true);(n||[]).forEach(BX.remove);(e||[]).forEach(function(t){t&&"value"in t&&(t.value="")},this)}},getField:function(t){var e;if(BX.type.isDomNode(t)){e=BX.findParent(t,{class:this.parent.settings.classField},true,false);if(!BX.type.isDomNode(e)){e=BX.findParent(t,{class:this.parent.settings.classFieldGroup},true,false)}}return e},render:function(t,e){var n,i,a,r;if(BX.type.isPlainObject(e)&&BX.type.isNotEmptyString(t)){n=Object.keys(e);n.forEach(function(n){r="{{"+n+"}}";t=t.replace(new RegExp(r,"g"),e[n])});a=BX.create("div",{html:t});i=BX.Filter.Utils.getByClass(a,this.parent.settings.classFieldGroup);if(!BX.type.isDomNode(i)){i=BX.Filter.Utils.getByClass(a,this.parent.settings.classField)}if(!BX.type.isDomNode(i)){i=BX.Filter.Utils.getByClass(a,this.parent.settings.classFieldLine)}}return i},createInputText:function(t){var e={block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:true,valueDelete:true,name:t.NAME,type:t.TYPE,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:[{block:"main-ui-control-string",name:t.NAME,placeholder:t.PLACEHOLDER||"",value:BX.type.isNotEmptyString(t.VALUE)||BX.type.isNumber(t.VALUE)?t.VALUE:"",tabindex:t.TABINDEX}]};return BX.decl(e)},createDestSelector:function(t){var e,n;var i={block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:true,valueDelete:true,name:t.NAME,type:t.TYPE,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-control-entity",mix:"main-ui-control",attrs:{"data-multiple":JSON.stringify(t.MULTIPLE)},content:[]}};if("_label"in t.VALUES&&!!t.VALUES._label){if(t.MULTIPLE){var a=!!t.VALUES._label?t.VALUES._label:[];if(BX.type.isPlainObject(a)){a=Object.keys(a).map(function(t){return a[t]})}if(!BX.type.isArray(a)){a=[a]}var r=!!t.VALUES._value?t.VALUES._value:[];if(BX.type.isPlainObject(r)){r=Object.keys(r).map(function(t){return r[t]})}if(!BX.type.isArray(r)){r=[r]}a.forEach(function(t,e){i.content.content.push({block:"main-ui-square",tag:"span",name:t,item:{_label:t,_value:r[e]}})})}else{i.content.content.push({block:"main-ui-square",tag:"span",name:"_label"in t.VALUES?t.VALUES["_label"]:"",item:t.VALUES})}}i.content.content.push({block:"main-ui-square-search",tag:"span",content:{block:"main-ui-control-string",name:t.NAME+"_label",tabindex:t.TABINDEX,type:"text",placeholder:t.PLACEHOLDER||""}},{block:"main-ui-control-string",name:t.NAME,type:"hidden",placeholder:t.PLACEHOLDER||"",value:"_value"in t.VALUES?t.VALUES["_value"]:"",tabindex:t.TABINDEX});i=BX.decl(i);e=BX.Filter.Utils.getBySelector(i,'.main-ui-control-string[type="text"]');BX.addClass(e,"main-ui-square-search-item");BX.bind(e,"focus",function(t){BX.fireEvent(t.currentTarget,"click")});BX.bind(e,"click",BX.proxy(this._onCustomEntityInputClick,this));if(!this.bindDocument){BX.bind(document,"click",BX.proxy(this._onCustomEntityBlur,this));document.addEventListener("focus",BX.proxy(this._onDocumentFocus,this),true);this.bindDocument=true}BX.bind(e,"keydown",BX.proxy(this._onCustomEntityKeydown,this));BX.bind(i,"click",BX.proxy(this._onCustomEntityFieldClick,this));BX.ready(BX.proxy(function(){BX.Filter.DestinationSelector.create(t.NAME,{filterId:this.parent.getParam("FILTER_ID"),fieldId:t.NAME})},this));return i},createCustomEntity:function(t){var e,n;var i={block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,deleteButton:true,valueDelete:true,name:t.NAME,type:t.TYPE,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-control-entity",mix:"main-ui-control",attrs:{"data-multiple":JSON.stringify(t.MULTIPLE)},content:[]}};if("_label"in t.VALUES&&!!t.VALUES._label){if(t.MULTIPLE){var a=!!t.VALUES._label?t.VALUES._label:[];if(BX.type.isPlainObject(a)){a=Object.keys(a).map(function(t){return a[t]})}if(!BX.type.isArray(a)){a=[a]}var r=!!t.VALUES._value?t.VALUES._value:[];if(BX.type.isPlainObject(r)){r=Object.keys(r).map(function(t){return r[t]})}if(!BX.type.isArray(r)){r=[r]}a.forEach(function(t,e){i.content.content.push({block:"main-ui-square",tag:"span",name:t,item:{_label:t,_value:r[e]}})})}else{i.content.content.push({block:"main-ui-square",tag:"span",name:"_label"in t.VALUES?t.VALUES["_label"]:"",item:t.VALUES})}}i.content.content.push({block:"main-ui-square-search",tag:"span",content:{block:"main-ui-control-string",name:t.NAME+"_label",tabindex:t.TABINDEX,type:"text",placeholder:t.PLACEHOLDER||""}},{block:"main-ui-control-string",name:t.NAME,type:"hidden",placeholder:t.PLACEHOLDER||"",value:"_value"in t.VALUES?t.VALUES["_value"]:"",tabindex:t.TABINDEX});i=BX.decl(i);e=BX.Filter.Utils.getBySelector(i,'.main-ui-control-string[type="text"]');BX.addClass(e,"main-ui-square-search-item");BX.bind(e,"focus",BX.proxy(this._onCustomEntityInputFocus,this));BX.bind(e,"click",BX.proxy(this._onCustomEntityInputClick,this));if(!this.bindDocument){BX.bind(document,"click",BX.proxy(this._onCustomEntityBlur,this));document.addEventListener("focus",BX.proxy(this._onDocumentFocus,this),true);this.bindDocument=true}BX.bind(e,"keydown",BX.proxy(this._onCustomEntityKeydown,this));BX.bind(i,"click",BX.proxy(this._onCustomEntityFieldClick,this));return i},_onCustomEntityInputFocus:function(t){BX.fireEvent(t.currentTarget,"click")},_onCustomEntityInputClick:function(t){var e,n,i,a;t.preventDefault();t.stopPropagation();if(t.isTrusted){this.trustTimestamp=t.timeStamp;this.notTrustTimestamp=this.notTrustTimestamp||t.timeStamp}else{this.notTrustTimestamp=t.timeStamp}e=new Date(this.trustTimestamp);n=new Date(this.notTrustTimestamp);i=e.getMinutes()+":"+e.getSeconds();a=n.getMinutes()+":"+n.getSeconds();if(i!==a){this._onCustomEntityFocus(t)}},_onDocumentFocus:function(t){var e=this.getCustomEntityInstance();var n=e.getPopupContainer();var i=e.getLabelNode()===t.target;var a=!!n&&n.contains(t.target);if(!i&&!a){this._onCustomEntityBlur(t)}},_onCustomEntityKeydown:function(t){var e=BX.Filter.Utils.getByClass(t.target.parentNode.parentNode,this.parent.settings.classSquare,true);var n=null;if(e.length){n=e[e.length-1]}if(BX.Filter.Utils.isKey(t,"backspace")&&t.currentTarget.selectionStart===0){if(BX.type.isDomNode(n)){if(BX.hasClass(n,this.parent.settings.classSquareSelected)){BX.remove(n);var i=BX.Filter.Utils.getBySelector(t.target.parentNode.parentNode,'input[type="hidden"]');i.value="";BX.fireEvent(i,"input")}else{BX.addClass(n,this.parent.settings.classSquareSelected)}}}else if(BX.type.isDomNode(n)&&BX.hasClass(n,this.parent.settings.classSquareSelected)){BX.removeClass(n,this.parent.settings.classSquareSelected)}},_onCustomEntityFieldClick:function(t){var e;if(BX.hasClass(t.target,this.parent.settings.classSquareDelete)){e=BX.findParent(t.target,{className:this.parent.settings.classSquare},true,false);if(BX.type.isDomNode(e)){var n=this.getCustomEntityInstance();BX.onCustomEvent(window,"BX.Main.Filter:customEntityRemove",[n]);BX.remove(e)}}else{var i=BX.Filter.Utils.getBySelector(t.target,'input[type="text"]');BX.fireEvent(i,"focus")}},_onCustomEntityBlur:function(t){var e={stopBlur:false};BX.onCustomEvent(window,"BX.Main.Filter:onGetStopBlur",[t,e]);if(typeof e.stopBlur=="undefined"||!e.stopBlur){var n=this.getCustomEntityInstance();BX.onCustomEvent(window,"BX.Main.Filter:customEntityBlur",[n]);BX.unbind(n.getPopupContainer(),"click",this._stopPropagation);BX.removeClass(n.getField(),this.parent.settings.classFocus)}},_stopPropagation:function(t){t.stopPropagation()},getCustomEntityInstance:function(){if(!(this.customEntityInstance instanceof BX.Main.ui.CustomEntity)){this.customEntityInstance=new BX.Main.ui.CustomEntity}return this.customEntityInstance},_onCustomEntityFocus:function(t){var e=BX.findParent(t.currentTarget,{className:"main-ui-control-entity"},true,false);var n=this.getCustomEntityInstance();t.stopPropagation();n.setField(e);BX.onCustomEvent(window,"BX.Main.Filter:customEntityFocus",[n]);var i=n.getPopupContainer();if(BX.type.isElementNode(i)){BX.bind(i,"click",this._stopPropagation)}BX.addClass(e,this.parent.settings.classFocus)},createCustom:function(t){var e,n,i;var a=[];t.VALUE=BX.util.htmlspecialcharsback(t.VALUE);a.push("main-ui-control");a.push("main-ui-custom-style");i=BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,name:t.NAME,type:t.TYPE,deleteButton:true,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-custom",mix:a,attrs:{"data-name":t.NAME},content:""}});n='name="'+t.NAME+'" value="'+("_VALUE"in t?t._VALUE:"")+'"';e=BX.Filter.Utils.getByClass(i,"main-ui-custom");try{t.VALUE=t.VALUE.replace('name="'+t.NAME+'"',n)}catch(t){}BX.html(e,t.VALUE);return i},createSelect:function(t){return BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,name:t.NAME,type:t.TYPE,deleteButton:true,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:this.parent.settings.classSelect,name:t.NAME,items:t.ITEMS,value:"VALUE"in t?t.VALUE:t.ITEMS[0],params:t.PARAMS,tabindex:t.TABINDEX,valueDelete:false}})},createMultiSelect:function(t){return BX.decl({block:"main-ui-control-field",mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel]:null,name:t.NAME,type:t.TYPE,deleteButton:true,label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),content:{block:"main-ui-multi-select",name:t.NAME,tabindex:"TABINDEX"in t?t.TABINDEX:"",placeholder:!this.parent.getParam("ENABLE_LABEL")&&"PLACEHOLDER"in t?t.PLACEHOLDER:"",items:"ITEMS"in t?t.ITEMS:[],value:"VALUE"in t?t.VALUE:[],params:"PARAMS"in t?t.PARAMS:{isMulti:true},valueDelete:true}})},createCustomDate:function(t){var e={block:"main-ui-control-field-group",type:t.TYPE,mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel,"main-ui-filter-date-group"]:["main-ui-filter-date-group"],label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),tabindex:"TABINDEX"in t?t.TABINDEX:"",name:"NAME"in t?t.NAME:"",deleteButton:true,content:[]};if(BX.type.isPlainObject(t.VALUE.days)){t.VALUE.days=Object.keys(t.VALUE.days).map(function(e){return t.VALUE.days[e]})}var n=t.DAYS.filter(function(e){return t.VALUE.days.some(function(t){return t===e.VALUE})});var i={block:"main-ui-control-field",mix:["main-ui-control-custom-date"],placeholder:t.DAYS_PLACEHOLDER,dragButton:false,content:{block:"main-ui-multi-select",name:t.NAME+"_days",tabindex:"TABINDEX"in t?t.TABINDEX:"",items:t.DAYS,value:n,params:"PARAMS"in t?t.PARAMS:{isMulti:true},valueDelete:true,attrs:{"data-placeholder":t.DAYS_PLACEHOLDER}}};if(BX.type.isPlainObject(t.VALUE.months)){t.VALUE.months=Object.keys(t.VALUE.months).map(function(e){return t.VALUE.months[e]})}var a=t.MONTHS.filter(function(e){return t.VALUE.months.some(function(t){return t===e.VALUE})});var r={block:"main-ui-control-field",mix:["main-ui-control-custom-date"],dragButton:false,content:{block:"main-ui-multi-select",name:t.NAME+"_months",tabindex:"TABINDEX"in t?t.TABINDEX:"",items:t.MONTHS,value:a,params:"PARAMS"in t?t.PARAMS:{isMulti:true},valueDelete:true,attrs:{"data-placeholder":t.MONTHS_PLACEHOLDER}}};if(BX.type.isPlainObject(t.VALUE.years)){t.VALUE.years=Object.keys(t.VALUE.years).map(function(e){return t.VALUE.years[e]})}var l=t.YEARS.filter(function(e){return t.VALUE.years.some(function(t){return t===e.VALUE})});var s={block:"main-ui-control-field",mix:["main-ui-control-custom-date"],dragButton:false,content:{block:"main-ui-multi-select",name:t.NAME+"_years",tabindex:"TABINDEX"in t?t.TABINDEX:"",items:t.YEARS,value:l,params:"PARAMS"in t?t.PARAMS:{isMulti:true},valueDelete:true,attrs:{"data-placeholder":t.YEARS_PLACEHOLDER}}};e.content.push(i);e.content.push(r);e.content.push(s);return BX.decl(e)},_onDateTypeChange:function(t,e){if(this.parent.getPopup().contentContainer.contains(t.node)){var n={};var i=null;var a,r,l,s,o,E,u,c;if(BX.type.isPlainObject(e)&&"VALUE"in e){s=BX.data(t.getNode(),"name");r=t.getParams();if(!BX.type.isPlainObject(r)&&(s.indexOf("_datesel")!==-1||s.indexOf("_numsel")!==-1)){a=t.getNode().parentNode.parentNode;n.TABINDEX=t.getInput().getAttribute("tabindex");n.SUB_TYPES=t.getItems();n.SUB_TYPE=e;n.NAME=BX.data(a,"name");n.TYPE=BX.data(a,"type");E=this.parent.getPreset().getCurrentPresetData();if("FIELDS"in E&&E.FIELDS.length){u=E.FIELDS.filter(function(t){return t.NAME===n.NAME},this);if(u.length){u=u[0];if(s.indexOf("_datesel")!==-1){n.MONTHS=u.MONTHS;n.MONTH=u.MONTH;n.YEARS=u.YEARS;n.YEAR=u.YEAR;n.QUARTERS=u.QUARTERS;n.QUARTER=u.QUARTER;n.ENABLE_TIME=u.ENABLE_TIME;n.YEARS_SWITCHER=u.YEARS_SWITCHER}n.VALUES=u.VALUES}}if(this.parent.getParam("ENABLE_LABEL")){l=BX.Filter.Utils.getByClass(a,this.parent.settings.classFieldLabel);n.LABEL=l.innerText}if(s.indexOf("_datesel")!==-1){i=this.createDate(n)}else{i=this.createNumber(n)}if(BX.type.isArray(this.parent.fieldsList)){c=this.parent.fieldsList.indexOf(a);if(c!==-1){this.parent.fieldsList[c]=i;this.parent.registerDragItem(i)}}this.parent.unregisterDragItem(a);o=BX.Filter.Utils.getByClass(i,this.parent.settings.classField,true);if(BX.type.isArray(o)&&o.length){o.forEach(function(t){t.FieldController=new BX.Filter.FieldController(t,this.parent)},this)}BX.insertAfter(i,a);BX.remove(a)}}}},createNumber:function(t){var e,n,i,a,r,l;var s=this.parent.numberTypes;var o=s.SINGLE;if("SUB_TYPE"in t&&BX.type.isPlainObject(t.SUB_TYPE)){o=t.SUB_TYPE.VALUE;i="PLACEHOLDER"in t.SUB_TYPE?t.SUB_TYPE.PLACEHOLDER:""}t.NAME=t.NAME.replace("_numsel","");e={block:"number-group",type:t.TYPE,mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel,"main-ui-filter-number-group"]:["main-ui-filter-number-group"],label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),tabindex:"TABINDEX"in t?t.TABINDEX:"",value:"SUB_TYPE"in t?t.SUB_TYPE:{},items:"SUB_TYPES"in t?t.SUB_TYPES:[],name:"NAME"in t?t.NAME:"",deleteButton:true,content:[]};if(o!==s.LESS){a={block:"main-ui-control-field",type:t.TYPE,dragButton:false,content:{block:"main-ui-number",mix:["filter-type-single"],calendarButton:true,valueDelete:true,placeholder:i,name:"NAME"in t?t.NAME+"_from":"",tabindex:"TABINDEX"in t?t.TABINDEX:"",value:"VALUES"in t?t.VALUES._from:""}};e.content.push(a)}if(o===s.RANGE){r={block:"main-ui-filter-field-line",content:{block:"main-ui-filter-field-line-item",tag:"span"}};e.content.push(r)}if(o===s.RANGE||o===s.LESS){l={block:"main-ui-control-field",type:t.TYPE,dragButton:false,content:{block:"main-ui-number",calendarButton:true,valueDelete:true,name:"NAME"in t?t.NAME+"_to":"",tabindex:"TABINDEX"in t?t.TABINDEX:"",value:"VALUES"in t?t.VALUES._to:""}}}e.content.push(l);return BX.decl(e)},createDate:function(t){var e,n,i,a,r,l,s,o,E;var u=this.parent.dateTypes;var c=this.parent.additionalDateTypes;var A=u.NONE;if("SUB_TYPE"in t&&BX.type.isPlainObject(t.SUB_TYPE)){A=t.SUB_TYPE.VALUE;l="PLACEHOLDER"in t.SUB_TYPE?t.SUB_TYPE.PLACEHOLDER:""}t.NAME=t.NAME.replace("_datesel","");if("VALUES"in t&&BX.type.isPlainObject(t.VALUES)){var m=Object.keys(t.VALUES);m.forEach(function(e){if(!t.VALUES[e]){t.VALUES[e]=""}})}e={block:"date-group",type:t.TYPE,mix:this.parent.getParam("ENABLE_LABEL")?[this.parent.settings.classFieldWithLabel,"main-ui-filter-date-group"]:["main-ui-filter-date-group"],label:this.parent.getParam("ENABLE_LABEL")?t.LABEL:"",dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_FIELD_TITLE"),deleteTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_FIELD"),tabindex:"TABINDEX"in t?t.TABINDEX:"",value:"SUB_TYPE"in t?t.SUB_TYPE:{},items:"SUB_TYPES"in t?t.SUB_TYPES:[],name:"NAME"in t?t.NAME:"",enableTime:"ENABLE_TIME"in t?t.ENABLE_TIME:false,deleteButton:true,content:[]};t.NAME=t.NAME.replace("_datesel","");if(A===u.EXACT){a={block:"main-ui-control-field",type:t.TYPE,dragButton:false,content:{block:"main-ui-date",mix:["filter-type-single"],calendarButton:true,valueDelete:true,placeholder:l,name:"NAME"in t?t.NAME+"_from":"",tabindex:"TABINDEX"in t?t.TABINDEX:"",value:"VALUES"in t?t.VALUES._from:"",enableTime:t.ENABLE_TIME}};e.content.push(a)}if(A===u.NEXT_DAYS||A===u.PREV_DAYS||A===c.PREV_DAY||A===c.NEXT_DAY||A===c.MORE_THAN_DAYS_AGO||A===c.AFTER_DAYS){a={block:"main-ui-control-field",type:t.TYPE,dragButton:false,content:{block:"main-ui-number",mix:["filter-type-single"],calendarButton:true,valueDelete:true,placeholder:l,name:"NAME"in t?t.NAME+"_days":"",tabindex:"TABINDEX"in t?t.TABINDEX:"",value:"VALUES"in t?t.VALUES._days:""}};e.content.push(a)}if(A===u.RANGE){var d={block:"main-ui-filter-range-group",content:[]};n={block:"main-ui-control-field",type:t.TYPE,dragButton:false,content:{block:"main-ui-date",calendarButton:true,valueDelete:true,name:"NAME"in t?t.NAME+"_from":"",tabindex:"TABINDEX"in t?t.TABINDEX:"",value:"VALUES"in t?t.VALUES._from:"",placeholder:l,enableTime:t.ENABLE_TIME}};r={block:"main-ui-filter-field-line",content:{block:"main-ui-filter-field-line-item",tag:"span"}};i={block:"main-ui-control-field",type:t.TYPE,dragButton:false,content:{block:"main-ui-date",calendarButton:true,valueDelete:true,name:"NAME"in t?t.NAME+"_to":"",tabindex:"TABINDEX"in t?t.TABINDEX:"",value:"VALUES"in t?t.VALUES._to:"",placeholder:l,enableTime:t.ENABLE_TIME}};d.content.push(n);d.content.push(r);d.content.push(i);e.content.push(d)}if(A===u.MONTH){if("_month"in t.VALUES&&t.VALUES._month){t.MONTH=t.MONTHS.filter(function(e){return e.VALUE===t.VALUES._month});t.MONTH=t.MONTH.length?t.MONTH[0]:null}if(!t.MONTH){t.MONTH=t.MONTHS[0]}E={block:"main-ui-control-field",dragButton:false,content:{block:"main-ui-select",tabindex:"tabindex"in t?t.tabindex:"",value:t.MONTH,items:t.MONTHS,name:t.NAME+"_month",valueDelete:false}};if("_year"in t.VALUES&&t.VALUES._year){t.YEAR=t.YEARS.filter(function(e){return e.VALUE===t.VALUES._year});t.YEAR=t.YEAR.length?t.YEAR[0]:null}if(!t.YEAR){t.YEAR=t.YEARS[0]}s={block:"main-ui-control-field",dragButton:false,content:{block:"main-ui-select",tabindex:"tabindex"in t?t.tabindex:"",value:t.YEAR,items:t.YEARS,name:t.NAME+"_year",valueDelete:false}};e.content.push(E);e.content.push(s)}if(A===u.QUARTER){if("_year"in t.VALUES&&t.VALUES._year){t.YEAR=t.YEARS.filter(function(e){return e.VALUE===t.VALUES._year});t.YEAR=t.YEAR.length?t.YEAR[0]:null}if(!t.YEAR){t.YEAR=t.YEARS[0]}s={block:"main-ui-control-field",dragButton:false,content:{block:"main-ui-select",tabindex:"tabindex"in t?t.tabindex:"",value:t.YEAR,items:t.YEARS,name:t.NAME+"_year",valueDelete:false}};if("_quarter"in t.VALUES&&t.VALUES._quarter){t.QUARTER=t.QUARTERS.filter(function(e){return e.VALUE===t.VALUES._quarter});t.QUARTER=t.QUARTER.length?t.QUARTER[0]:null}if(!t.QUARTER){t.QUARTER=t.QUARTERS[0]}o={block:"main-ui-control-field",dragButton:false,content:{block:"main-ui-select",tabindex:"tabindex"in t?t.tabindex:"",value:t.QUARTER,items:t.QUARTERS,name:t.NAME+"_quarter",params:t.PARAMS,valueDelete:false}};e.content.push(o);e.content.push(s)}if(A===u.YEAR){if("_year"in t.VALUES&&t.VALUES._year){t.YEAR=t.YEARS.filter(function(e){return e.VALUE===t.VALUES._year});t.YEAR=t.YEAR.length?t.YEAR[0]:null}if(!t.YEAR){t.YEAR=t.YEARS[0]}s={block:"main-ui-control-field",dragButton:false,content:{block:"main-ui-select",tabindex:"tabindex"in t?t.tabindex:"",value:t.YEAR,items:t.YEARS,name:t.NAME+"_year",valueDelete:false}};e.content.push(s)}if(A==="CUSTOM_DATE"){var p=t.SUB_TYPES.filter(function(t){return t.VALUE==="CUSTOM_DATE"});if(p[0]){p=BX.clone(p[0].DECL);if(BX.type.isArray(t.VALUES._days)){p.VALUE.days=t.VALUES._days}if(BX.type.isArray(t.VALUES._month)){p.VALUE.months=t.VALUES._month}if(BX.type.isArray(t.VALUES._year)){p.VALUE.years=t.VALUES._year}var L=this.createCustomDate(p);L.classList.remove("main-ui-filter-wield-with-label");var B=L.querySelector(".main-ui-item-icon-container");if(B){BX.remove(B)}var _=L.querySelector(".main-ui-filter-icon-grab");if(_){BX.remove(_)}e.content.push(L);e.mix.push("main-ui-filter-custom-date-group")}}if(A!==u.NONE&&A!==c.CUSTOM_DATE&&t["YEARS_SWITCHER"]){if("_allow_year"in t.VALUES&&t.VALUES._allow_year){var f=t.YEARS_SWITCHER.ITEMS.filter(function(e){return e.VALUE===t.VALUES._allow_year});f=f.length?f[0]:null;if(f){t.YEARS_SWITCHER.VALUE=f}}var h=this.createSelect(t["YEARS_SWITCHER"]);h.classList.add("main-ui-filter-year-switcher");h.classList.add("main-ui-filter-with-padding");h.classList.remove("main-ui-filter-wield-with-label");B=h.querySelector(".main-ui-item-icon-container");if(B){BX.remove(B)}_=h.querySelector(".main-ui-filter-icon-grab");if(_){BX.remove(_)}if(e.content[e.content.length-1]){if(BX.type.isPlainObject(e.content[e.content.length-1])){if(!BX.type.isArray(e.content[e.content.length-1].mix)){e.content[e.content.length-1].mix=[]}e.content[e.content.length-1].mix.push("main-ui-filter-remove-margin-right")}if(BX.type.isDomNode(e.content[e.content.length-1])){e.content[e.content.length-1].classList.add("main-ui-filter-remove-margin-right")}}requestAnimationFrame(function(){h.previousElementSibling.classList.add("main-ui-filter-remove-margin-right")});e.content.push(h);e.mix.push("main-ui-filter-date-with-years-switcher")}return BX.decl(e)}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:114:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/main-ui-control-custom-entity.min.js?15441273843115";s:6:"source";s:95:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/main-ui-control-custom-entity.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui");BX.Main.ui.CustomEntity=function(){this.field=null;this.labelInput=null;this.hiddenInput=null;this.popupContainer=null;this.inputClass="main-ui-control-string";this.squareClass="main-ui-square";this.multiple=null};BX.Main.ui.CustomEntity.isMultiple=function(t){if(!!t&&!BX.hasClass(t,"main-ui-control-entity")){t=BX.Filter.Utils.getByClass(t,"main-ui-control-entity")}return!!t&&JSON.parse(BX.data(t,"multiple"))};BX.Main.ui.CustomEntity.prototype={setField:function(t){if(this.field!==t){this.field=t;this.reset()}},isMultiple:function(){return BX.Main.ui.CustomEntity.isMultiple(this.getField())},reset:function(){this.labelInput=null;this.hiddenInput=null},getField:function(){return this.field},getId:function(){var t=this.getHiddenNode();var e=null;if(BX.type.isDomNode(t)){e=t.name}return e},getLabelNode:function(){if(!BX.type.isDomNode(this.labelInput)){this.labelInput=BX.Filter.Utils.getBySelector(this.getField(),"."+this.inputClass+'[type="text"]')}return this.labelInput},getHiddenNode:function(){if(!BX.type.isDomNode(this.hiddenInput)){this.hiddenInput=BX.Filter.Utils.getBySelector(this.getField(),"."+this.inputClass+'[type="hidden"]')}return this.hiddenInput},getSquareByValue:function(t){return BX.Filter.Utils.getBySelector(this.getField(),['[data-item*=":'+BX.util.jsencode(t)+'}"]','[data-item*=":\\"'+BX.util.jsencode(t)+'\\"}"]'].join(", "))},getSquares:function(){return BX.Filter.Utils.getByClass(this.getField(),this.squareClass,true)},removeSquares:function(){this.getSquares().forEach(BX.remove)},setSquare:function(t,e){var i=this.getField();var n={block:"main-ui-square",name:t,item:{_label:t,_value:e}};var s=BX.decl(n);var l=this.getSquares();if(!l.length){BX.prepend(s,i)}else{BX.insertAfter(s,l[l.length-1])}},getCurrentValues:function(){var t=this.getSquares();var e,i;if(this.isMultiple()){i=[];for(var n=0,s=t.length;n<s;n++){try{e=JSON.parse(BX.data(t[n],"item"));i.push({label:e._label,value:e._value})}catch(t){}}}else{if(t.length===0){i={label:"",value:""}}else{try{e=JSON.parse(BX.data(t[0],"item"));i={label:e._label,value:e._value}}catch(t){i={label:"",value:""}}}}return i},setData:function(t,e){return this.isMultiple()?this.setMultipleData(t,e):this.setSingleData(t,e)},setSingleData:function(t,e){var i=this.getHiddenNode();this.removeSquares();this.setSquare(t,e);if(BX.type.isDomNode(i)){i.value=e;BX.fireEvent(i,"input")}},setMultipleData:function(t,e){var i=[];var n=this.getHiddenNode();if(BX.type.isArray(t)){this.removeSquares();if(BX.type.isArray(t)){t.forEach(function(t){i.push(t.value);this.setSquare(t.label,t.value)},this);if(BX.type.isDomNode(n)){n.value=JSON.stringify(i);BX.fireEvent(n,"input")}}}if(!BX.type.isArray(t)&&e!==null){if(!this.getSquareByValue(e)){this.setSquare(t,e);this.getSquares().forEach(function(t){var e=JSON.parse(BX.data(t,"item"));if(BX.type.isPlainObject(e)){i.push(e._value)}});n.value=JSON.stringify(i);BX.fireEvent(n,"input")}}},setPopupContainer:function(t){if(BX.type.isDomNode(t)){this.popupContainer=t}},getPopupContainer:function(){return this.popupContainer}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:93:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/presets.min.js?154412738417210";s:6:"source";s:73:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/presets.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Filter");BX.Filter.Presets=function(e){this.parent=null;this.presets=null;this.container=null;this.init(e)};BX.Filter.Presets.prototype={init:function(e){this.parent=e},bindOnPresetClick:function(){(this.getPresets()||[]).forEach(function(e){BX.bind(e,"click",BX.delegate(this._onPresetClick,this))},this)},getAddPresetField:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classAddPresetField)},getAddPresetFieldInput:function(){return BX.Filter.Utils.getByClass(this.getAddPresetField(),this.parent.settings.classAddPresetFieldInput)},clearAddPresetFieldInput:function(){var e=this.getAddPresetFieldInput();e&&(e.value="")},normalizePreset:function(e){if(!BX.hasClass(e,this.parent.settings.classPreset)){e=BX.findParent(e,{className:this.parent.settings.classPreset},true,false)}return e},deactivateAllPresets:function(){var e=this.getPresets();var t=this;(e||[]).forEach(function(e){if(BX.hasClass(e,t.parent.settings.classPresetCurrent)){BX.removeClass(e,t.parent.settings.classPresetCurrent)}})},createSidebarItem:function(e,t,s){return BX.decl({block:"sidebar-item",text:BX.util.htmlspecialcharsback(t),id:e,pinned:s,noEditPinTitle:this.parent.getParam("MAIN_UI_FILTER__IS_SET_AS_DEFAULT_PRESET"),editNameTitle:this.parent.getParam("MAIN_UI_FILTER__EDIT_PRESET_TITLE"),removeTitle:this.parent.getParam("MAIN_UI_FILTER__REMOVE_PRESET"),editPinTitle:this.parent.getParam("MAIN_UI_FILTER__SET_AS_DEFAULT_PRESET"),dragTitle:this.parent.getParam("MAIN_UI_FILTER__DRAG_TITLE")})},activatePreset:function(e){this.deactivateAllPresets();if(BX.type.isNotEmptyString(e)){e=this.getPresetNodeById(e)}if(e&&!BX.hasClass(e,this.parent.settings.classPresetCurrent)){BX.addClass(e,this.parent.settings.classPresetCurrent)}},getPresetNodeById:function(e){var t=this.getPresets();var s=t.filter(function(t){return BX.data(t,"id")===e},this);return s.length>0?s[0]:null},getPresetId:function(e){return BX.data(e,"id")},updatePresetName:function(e,t){var s;if(BX.type.isDomNode(e)&&BX.type.isNotEmptyString(t)){s=this.getPresetNameNode(e);if(BX.type.isDomNode(s)){BX.html(s,t)}}},removePreset:function(e,t,s){var i=this.getCurrentPresetId();var r=[];var a={preset_id:t,is_default:s};var n={FILTER_ID:this.parent.getParam("FILTER_ID"),action:"REMOVE_FILTER"};this.parent.saveOptions(a,n);BX.remove(e);if(BX.type.isArray(this.parent.params["PRESETS"])){r=this.parent.params["PRESETS"].filter(function(e){return e.ID!==t},this);this.parent.params["PRESETS"]=r}if(BX.type.isArray(this.parent.editablePresets)){r=this.parent.editablePresets.filter(function(e){return e.ID!==t},this);this.parent.editablePresets=r}if(t===i){this.parent.getSearch().removePreset();this.resetPreset()}},pinPreset:function(e){if(!BX.type.isNotEmptyString(e)){e="default_filter"}var t=this.getPresetNodeById(e);if(this.parent.getParam("VALUE_REQUIRED_MODE")){if(e==="default_filter"){return}}var s={FILTER_ID:this.parent.getParam("FILTER_ID"),GRID_ID:this.parent.getParam("GRID_ID"),action:"PIN_PRESET"};var i={preset_id:e};this.getPresets().forEach(function(e){BX.removeClass(e,this.parent.settings.classPinnedPreset)},this);BX.addClass(t,this.parent.settings.classPinnedPreset);this.parent.saveOptions(i,s)},_onPresetClick:function(e){var t,s,i,r,a,n,l;e.preventDefault();l=this.parent;n=l.settings;a=e.target;t=e.currentTarget;s=this.getPresetId(t);i=this.getPreset(s);if(BX.hasClass(a,n.classPinButton)){if(this.parent.isEditEnabled()){if(BX.hasClass(t,n.classPinnedPreset)){this.pinPreset("default_filter")}else{this.pinPreset(s)}}}if(BX.hasClass(a,n.classPresetEditButton)){this.enableEditPresetName(t)}if(BX.hasClass(a,n.classPresetDeleteButton)){r="IS_DEFAULT"in i?i.IS_DEFAULT:false;this.removePreset(t,s,r);return false}if(!BX.hasClass(a,n.classPresetDragButton)&&!BX.hasClass(a,n.classAddPresetFieldInput)){if(this.parent.isEditEnabled()){this.updateEditablePreset(this.getCurrentPresetId())}var p=this.getPreset(this.getCurrentPresetId());var h=this.getPreset(s);p.ADDITIONAL=[];h.ADDITIONAL=[];this.activatePreset(t);this.applyPreset(s);if(!this.parent.isEditEnabled()){l.applyFilter(null,true);if(e.isTrusted){l.closePopup()}if(l.isAddPresetEnabled()){l.disableAddPreset()}}}},applyPinnedPreset:function(){var e=this.parent;var t=this.isPinned(this.getCurrentPresetId());var s;if(this.parent.getParam("VALUE_REQUIRED")&&this.getPinnedPresetId()==="default_filter"){this.applyPreset("default_filter");this.deactivateAllPresets();s=this.parent.applyFilter()}else{if(!t){var i=this.getPinnedPresetId();var r=this.getPinnedPresetNode();var a=false;var n=true;this.deactivateAllPresets();this.activatePreset(r);this.applyPreset(i);s=e.applyFilter(a,n);e.closePopup()}else{s=e.resetFilter()}}return s},updateEditablePreset:function(e){var t=this.parent.getFilterFieldsValues();var s=this.getFields().map(function(e){return BX.data(e,"name")});var i=this.parent.preparePresetFields(t,s);var r=this.getPreset(e);r.FIELDS=i;r.TITLE=this.getPresetInput(this.getPresetNodeById(e)).value;r.ROWS=s},getPresetInput:function(e){return BX.Filter.Utils.getByClass(e,this.parent.settings.classPresetEditInput)},enableEditPresetName:function(e){var t=this.getPresetInput(e);BX.addClass(e,this.parent.settings.classPresetNameEdit);t.focus();t.value=BX.util.htmlspecialcharsback(t.value);BX.bind(t,"input",BX.delegate(this._onPresetNameInput,this))},_onPresetNameInput:function(e){var t=this.parent.getSearch();var s=e.currentTarget.value;var i=BX.findParent(e.currentTarget,{className:this.parent.settings.classPreset},true,false);var r=this.getPresetId(i);var a=this.getCurrentPresetId();var n={ID:r,TITLE:s};if(r===a){t.updatePreset(n)}},getPresetNameNode:function(e){return BX.Filter.Utils.getByClass(e,this.parent.settings.classPresetName)},disableEditPresetName:function(e){var t=this.getPresetInput(e);BX.removeClass(e,this.parent.settings.classPresetNameEdit);if(BX.type.isDomNode(t)){t.blur();BX.unbind(t,"input",BX.delegate(this._onPresetNameInput,this))}},getPreset:function(e,t){var s=this.parent.getParam(t?"DEFAULT_PRESETS":"PRESETS",[]);if(this.parent.isEditEnabled()&&!t){s=this.parent.editablePresets}var i=s.filter(function(t){return t.ID===e});if(e==="tmp_filter"&&!i.length){var r=BX.clone(this.getPreset("default_filter"));r.ID="tmp_filter";s.push(r);i.push(r)}return i.length!==0?i[0]:null},getPresetField:function(e,t){var s=this.getPreset(e);var i=null;if(BX.type.isPlainObject(s)&&"FIELDS"in s&&BX.type.isArray(s.FIELDS)){i=s.FIELDS.filter(function(e){return e.NAME===t});i=i.length?i[0]:null}return i},applyPreset:function(e,t){e=t?"default_filter":e||"default_filter";var s=this.getPreset(e);if(e!=="default_preset"){s=this.extendPreset(s)}this.parent.getSearch().updatePreset(s);this.updatePresetFields(s,t)},extendPreset:function(e){var t=BX.clone(this.getPreset("default_filter"));if(BX.type.isPlainObject(e)){e=BX.clone(e);e.FIELDS.forEach(function(e){var s;var i=t.FIELDS.some(function(t,i){var r=false;if(t.NAME===e.NAME){s=i;r=true}return r},this);if(i&&s||i&&s===0){t.FIELDS[s]=e}else{if(!this.isEmptyField(e)){t.FIELDS.push(e)}}},this);e.FIELDS=t.FIELDS}return e},isEmptyField:function(e){var t=true;if(e.TYPE===this.parent.types.STRING){if(e.VALUE&&e.VALUE.length){t=false}}if(e.TYPE===this.parent.types.SELECT){if(BX.type.isPlainObject(e.VALUE)&&"VALUE"in e.VALUE&&e.VALUE.VALUE){t=false}}if(e.TYPE===this.parent.types.MULTI_SELECT){if(BX.type.isArray(e.VALUE)&&e.VALUE.length){t=false}}if(e.TYPE===this.parent.types.CUSTOM_DATE){if(BX.type.isArray(e.VALUE.days)&&e.VALUE.days.length||BX.type.isArray(e.VALUE.months)&&e.VALUE.months.length||BX.type.isArray(e.VALUE.years)&&e.VALUE.years.length){t=false}}if(e.TYPE===this.parent.types.CUSTOM_ENTITY||e.TYPE===this.parent.types.DEST_SELECTOR){if(BX.type.isPlainObject(e.VALUES)){if(BX.type.isNotEmptyString(e.VALUES._label)&&BX.type.isNotEmptyString(e.VALUES._value)){t=false}if(BX.type.isPlainObject(e.VALUES._label)&&BX.type.isPlainObject(e.VALUES._value)&&Object.keys(e.VALUES._label).length&&Object.keys(e.VALUES._value).length){t=false}if(BX.type.isArray(e.VALUES._label)&&BX.type.isArray(e.VALUES._value)&&e.VALUES._label.length&&e.VALUES._value.length){t=false}if((BX.type.isArray(e.VALUES._label)&&e.VALUES._label.length||BX.type.isPlainObject(e.VALUES._label)&&Object.keys(e.VALUES._label).length)&&(BX.type.isArray(e.VALUES._value)&&e.VALUES._value.length||BX.type.isPlainObject(e.VALUES._value)&&Object.keys(e.VALUES._value).length)){t=false}}}if(e.TYPE===this.parent.types.DATE){var s="_datesel"in e.VALUES?e.VALUES._datesel:e.SUB_TYPE.VALUE;if(BX.type.isPlainObject(e.VALUES)&&(e.VALUES._from||e.VALUES._to||e.VALUES._quarter||e.VALUES._month&&!BX.type.isArray(e.VALUES._month)||e.VALUES._year&&!BX.type.isArray(e.VALUES._year)||e.VALUES._days&&!BX.type.isArray(e.VALUES._days))||BX.type.isArray(e.VALUES._days)&&e.VALUES._days.length||BX.type.isArray(e.VALUES._month)&&e.VALUES._month.length||BX.type.isArray(e.VALUES._year)&&e.VALUES._year.length||(s===this.parent.dateTypes.CURRENT_DAY||s===this.parent.dateTypes.CURRENT_WEEK||s===this.parent.dateTypes.CURRENT_MONTH||s===this.parent.dateTypes.CURRENT_QUARTER||s===this.parent.dateTypes.LAST_7_DAYS||s===this.parent.dateTypes.LAST_30_DAYS||s===this.parent.dateTypes.LAST_60_DAYS||s===this.parent.dateTypes.LAST_90_DAYS||s===this.parent.dateTypes.LAST_WEEK||s===this.parent.dateTypes.LAST_MONTH||s===this.parent.dateTypes.TOMORROW||s===this.parent.dateTypes.YESTERDAY||s===this.parent.dateTypes.NEXT_WEEK||s===this.parent.dateTypes.NEXT_MONTH)){t=false}}if(e.TYPE===this.parent.types.NUMBER){if(BX.type.isPlainObject(e.VALUES)&&(e.VALUES._from||e.VALUES._to)){t=false}}if(e.TYPE===this.parent.types.CHECKBOX){if(BX.type.isPlainObject(e.VALUE)&&e.VALUE.VALUE){t=false}}return t},resetPreset:function(e){this.applyPreset("",e)},getFields:function(){var e=this.parent.getFieldListContainer();var t=null;if(BX.type.isDomNode(e)){t=BX.Filter.Utils.getBySelector(e.parentNode,"."+this.parent.settings.classFileldControlList+" > div",true)}return t},getField:function(e){var t=this.getFields();var s=null;var i,r;if(BX.type.isArray(t)&&t.length){r=t.filter(function(t){if(BX.type.isDomNode(t)){i=BX.data(t,"name")}return i===e.NAME},this);s=r.length>0?r[0]:null}return s},removeField:function(e,t){var s,i;t=t||false;if(BX.type.isPlainObject(e)){i=e.NAME;e=this.getField(e);if(BX.type.isArray(this.parent.fieldsList)){s=this.parent.fieldsList.indexOf(e);if(s!==-1){delete this.parent.fieldsList[s]}}this.parent.unregisterDragItem(e)}if(BX.type.isDomNode(e)){i=BX.data(e,"name");this.parent.getFields().deleteField(e)}if(!this.parent.isEditEnabled()&&!this.parent.isAddPresetEnabled()){var r=this.getCurrentPresetId();var a=this.getPresetField(r,i);if(a&&!this.isEmptyField(a)){this.deactivateAllPresets();this.parent.applyFilter()}}if(!t){this.parent.saveFieldsSort()}},removeFields:function(e){e.forEach(function(e){this.removeField(e,true)},this);this.parent.saveFieldsSort()},addField:function(e){var t,s,i;if(BX.type.isPlainObject(e)){t=this.parent.getFieldListContainer();i=this.parent.getControls();s=BX.type.isArray(i)?i[i.length-1]:null;if(BX.type.isDomNode(s)){if(s.nodeName!=="INPUT"){s=BX.Filter.Utils.getByTag(s,"input")}if(BX.type.isDomNode(s)){e.TABINDEX=parseInt(s.getAttribute("tabindex"))+1}}else{e.TABINDEX=2}if(BX.type.isDomNode(t)){s=this.createControl(e);if(BX.type.isDomNode(s)){BX.append(s,t);if(BX.type.isArray(this.parent.fieldsList)){this.parent.fieldsList.push(s)}this.parent.registerDragItem(s)}}}if(!this.parent.isEditEnabled()&&!this.parent.isAddPresetEnabled()){var r=this.getCurrentPresetId();var a=this.getPresetField(r,e.NAME);if(a&&!this.isEmptyField(a)){this.parent.updatePreset("tmp_filter");this.deactivateAllPresets();this.parent.getSearch().updatePreset(this.getPreset("tmp_filter"))}}this.parent.saveFieldsSort()},createControl:function(e){var t;switch(e.TYPE){case this.parent.types.STRING:{t=this.parent.getFields().createInputText(e);break}case this.parent.types.SELECT:{t=this.parent.getFields().createSelect(e);break}case this.parent.types.MULTI_SELECT:{t=this.parent.getFields().createMultiSelect(e);break}case this.parent.types.NUMBER:{t=this.parent.getFields().createNumber(e);break}case this.parent.types.DATE:{t=this.parent.getFields().createDate(e);break}case this.parent.types.CUSTOM_DATE:{t=this.parent.getFields().createCustomDate(e);break}case this.parent.types.DEST_SELECTOR:{t=this.parent.getFields().createDestSelector(e);break}case this.parent.types.CUSTOM:{t=this.parent.getFields().createCustom(e);break}case this.parent.types.CUSTOM_ENTITY:{t=this.parent.getFields().createCustomEntity(e);break}default:{break}}if(BX.type.isDomNode(t)){t.dataset.name=e.NAME;t.FieldController=new BX.Filter.FieldController(t,this.parent)}return t},removeNotCompareVariables:function(e,t){if(BX.type.isPlainObject(e)){var s=this.parent.dateTypes;var i=this.parent.additionalDateTypes;if("FIND"in e){delete e.FIND}if(!t){Object.keys(e).forEach(function(t){if(t.indexOf("_numsel")!==-1){delete e[t]}if(t.indexOf("_datesel")!==-1){var r=e[t];if(r===s.EXACT||r===s.RANGE||r===i.PREV_DAY||r===i.NEXT_DAY||r===i.MORE_THAN_DAYS_AGO||r===i.AFTER_DAYS||r===s.PREV_DAYS||r===s.NEXT_DAYS||r===s.YEAR||r===s.MONTH||r===s.QUARTER||r===s.NONE||r===s.CUSTOM_DATE){delete e[t]}}var a=this.parent.getFieldByName(t);if(e[t]===""&&(!a||!a["STRICT"])){delete e[t]}},this)}}},isPresetValuesModified:function(e){var t=this.getPreset(e);var s=this.parent.preparePresetSettingsFields(t.FIELDS);var i=this.parent.getFilterFieldsValues();this.removeNotCompareVariables(s);this.removeNotCompareVariables(i);var r=BX.Filter.Utils.sortObject(s);var a=BX.Filter.Utils.sortObject(i);return!Object.keys(r).every(function(e){return r[e]===a[e]||(BX.type.isPlainObject(r[e])||BX.type.isArray(r[e]))&&BX.Filter.Utils.objectsIsEquals(r[e],a[e])})},getAdditionalValues:function(e){var t=this.getPreset(e);var s=t.FIELDS.filter(function(e){return!this.isEmptyField(e)},this);var i=this.parent.preparePresetSettingsFields(s);var r=this.parent.getFilterFieldsValues();this.removeNotCompareVariables(i,true);this.removeNotCompareVariables(r,true);this.removeSameProperties(r,i);return r},removeSameProperties:function(e,t){if(BX.type.isPlainObject(e)&&BX.type.isPlainObject(t)){Object.keys(t).forEach(function(t){if(t in e){delete e[t]}})}},removeAdditionalField:function(e){var t=this.getPreset(this.getCurrentPresetId());if(BX.type.isArray(t.ADDITIONAL)){t.ADDITIONAL=t.ADDITIONAL.filter(function(t){return t.NAME!==e})}},updatePresetFields:function(e,t){var s,i;var r=[];if(BX.type.isPlainObject(e)&&"FIELDS"in e){s=e.FIELDS;if(BX.type.isArray(e.ADDITIONAL)){e.ADDITIONAL.forEach(function(e){var t=false;e.IS_PRESET_FIELD=true;s.forEach(function(i,r){if(e.NAME===i.NAME){s[r]=e;t=true}});if(!t){s.push(e)}})}(s||[]).forEach(function(e,s){e.TABINDEX=s+1;if(t){switch(e.TYPE){case this.parent.types.SELECT:{e.VALUE=e.ITEMS[0];break}case this.parent.types.MULTI_SELECT:{e.VALUE=[];break}case this.parent.types.DATE:{e.SUB_TYPE=e.SUB_TYPES[0];e.VALUES={_from:"",_to:"",_days:""};break}case this.parent.types.CUSTOM_DATE:{e.VALUE={days:[],months:[],years:[]};break}case this.parent.types.NUMBER:{e.SUB_TYPE=e.SUB_TYPES[0];e.VALUES={_from:"",_to:""};break}case this.parent.types.CUSTOM_ENTITY:{e.VALUES={_label:"",_value:""};break}case this.parent.types.CUSTOM:{e._VALUE="";break}default:{if("VALUE"in e){if(BX.type.isArray(e.VALUE)){e.VALUE=[]}else{e.VALUE=""}}break}}}r.push(this.createControl(e))},this);this.parent.disableFieldsDragAndDrop();i=this.parent.getFieldListContainer();BX.cleanNode(i);if(r.length){r.forEach(function(t,r){if(BX.type.isDomNode(t)){if(e.ID!=="tmp_filter"&&e.ID!=="default_filter"&&!("IS_PRESET_FIELD"in s[r])&&!this.isEmptyField(s[r])){BX.addClass(t,this.parent.settings.classPresetField)}BX.append(t,i);if(BX.type.isString(s[r].HTML)){var a=BX.create("div");this.parent.getHiddenElement().appendChild(a);BX.html(a,s[r].HTML)}}},this);this.parent.enableFieldsDragAndDrop()}}},showCurrentPresetFields:function(){var e=this.getCurrentPresetData();this.updatePresetFields(e)},getCurrentPreset:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classPresetCurrent)},getCurrentPresetId:function(){var e=this.getCurrentPreset();var t=null;if(BX.type.isDomNode(e)){t=this.getPresetId(e)}else{t="tmp_filter"}return t},getCurrentPresetData:function(){var e=this.getCurrentPresetId();var t=null;if(BX.type.isNotEmptyString(e)){t=this.getPreset(e);t=this.extendPreset(t)}return t},getContainer:function(){return BX.Filter.Utils.getByClass(this.parent.getFilter(),this.parent.settings.classPresetsContainer)},getPresets:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classPreset,true)},getDefaultPresets:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classDefaultFilter,true)},getPinnedPresetNode:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classPinnedPreset)},isPinned:function(e){return this.getPinnedPresetId()===e},getPinnedPresetId:function(){var e=this.getPinnedPresetNode();var t="default_filter";if(!!e){var s=BX.data(e,"id");t=!!s?s:t}return t}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:92:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/search.min.js?154412738418784";s:6:"source";s:72:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/search.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Filter");BX.Filter.Search=function(t){this.parent=null;this.container=null;this.input=null;this.preset=null;this.buttonsContainer=null;this.delay=800;this.timeout=null;this.init(t)};BX.Filter.Search.prototype={init:function(t){this.parent=t;BX.bind(this.getInput(),"input",BX.delegate(this._onInputWithoutDebounce,this));if(this.parent.getParam("ENABLE_LIVE_SEARCH")){BX.bind(this.getInput(),"input",BX.debounce(this._onInput,this.delay,this))}BX.bind(this.getInput(),"keydown",BX.delegate(this._onKeyDown,this));BX.bind(this.getFindButton(),"click",BX.delegate(this._onSearchClick,this));BX.bind(this.getContainer(),"click",BX.delegate(this._onSearchContainerClick,this));this.removeAutofocus();this.firstInit=true},removeAutofocus:function(){var t=this.getInput();if(!!t){t.blur();t.autofocus=null}},getFindButton:function(){if(!BX.type.isDomNode(this.findButton)){this.findButton=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSearchButton)}return this.findButton},_onSearchClick:function(){this.apply()},selectSquare:function(t){!!t&&BX.addClass(t,this.parent.settings.classSquareSelected)},selectSquares:function(){this.getSquares().forEach(this.selectSquare,this)},unselectSquare:function(t){!!t&&BX.removeClass(t,this.parent.settings.classSquareSelected)},unselectSquares:function(){this.getSquares().forEach(this.unselectSquare,this)},removeSquares:function(){this.getSquares().forEach(this.removeSquare,this)},isSquaresSelected:function(){var t=this.getSquares();return t.length&&t.every(this.isSquareSelected,this)},isSquareSelected:function(t){return!!t&&BX.hasClass(t,this.parent.settings.classSquareSelected)},getLastSquare:function(){var t=this.getSquares();return!!t?t[t.length-1]:null},isTextSelected:function(){var t=this.getSearchString().length;var e=this.getInput();var s=e.selectionStart;var i=e.selectionEnd;return s===0&&i!==0&&i===t},isSelectionStart:function(){var t=this.getInput();var e=t.selectionStart;var s=t.selectionEnd;return e===0&&s===0},isSquareRemoveButton:function(t){return!!t&&BX.hasClass(t,this.parent.settings.classSquareDelete)},isClearButton:function(t){return!!t&&BX.hasClass(t,this.parent.settings.classClearSearchValueButton)},getClearButton:function(){return this.getContainer().querySelector("."+this.parent.settings.classClearSearchValueButton)},isSearchButton:function(t){return!!t&&BX.hasClass(t,this.parent.settings.classSearchButton)},adjustFocus:function(){if(!BX.browser.IsMobile()){var t=this.getInput();if(document.activeElement!==t&&window.scrollY<BX.pos(t).top){t.value=t.value;t.blur();t.focus()}}},findSquareByChild:function(t){return BX.findParent(t,{className:this.parent.settings.classSquare},true,false)},getSquareData:function(t){var e=BX.data(t,"item");return!!t&&!!e?JSON.parse(e):null},isSquareControl:function(t){var e=this.getSquareData(t);return!!e&&(e.type==="control"||BX.type.isArray(e))},onPresetSquareRemove:function(){var t=this.parent;var e=t.getPreset();var s=e.getCurrentPresetId();var i=t.getParam("RESET_TO_DEFAULT_MODE");var r=t.getParam("VALUE_REQUIRED");var a=e.isPinned(s);var n=this.getSquares();if(n.length===1){if(r&&a){this.parent.showPopup();this.adjustPlaceholder();this.parent.getPreset().deactivateAllPresets()}else{if(i&&a||!i){var o=true;this.lastPromise=t.resetFilter(o);t.closePopup()}}if(i&&!a){this.lastPromise=t.getPreset().applyPinnedPreset()}}if(n.length>1){var h=e.getPreset(e.getCurrentPresetId());var l=e.getPreset("tmp_filter");l.FIELDS=BX.clone(h.ADDITIONAL);h.ADDITIONAL=[];e.deactivateAllPresets();e.applyPreset("tmp_filter");t.applyFilter()}},onControlSquareRemove:function(t){var e=this.parent;var s=e.getPreset();var i=e.getParam("RESET_TO_DEFAULT_MODE");var r=e.getParam("VALUE_REQUIRED");var a;if(i&&this.getSquares().length===1){if(r){a=this.getSquareData(t);e.clearControls(a);this.parent.showPopup();this.adjustPlaceholder();this.parent.getPreset().deactivateAllPresets()}else{this.lastPromise=e.getPreset().applyPinnedPreset()}}else{a=this.getSquareData(t);e.clearControls(a);e.closePopup();if(BX.type.isArray(a)){a.forEach(function(t){s.removeAdditionalField(t.name)})}if(BX.type.isPlainObject(a)){s.removeAdditionalField(a.name)}this.apply()}},onValueRequiredSquareRemove:function(){var t=this.parent;t.getPreset().deactivateAllPresets();t.showPopup();this.adjustPlaceholder()},complexSquareRemove:function(t){var e=this.parent.getParam("VALUE_REQUIRED_MODE");var s=!this.isSquareControl(t);if(e){this.onValueRequiredSquareRemove()}else{if(s){this.onPresetSquareRemove()}else{this.onControlSquareRemove(t)}}this.removeSquare(t);this.adjustClearButton()},adjustClearButton:function(){!!this.getLastSquare()?this.showClearButton():this.hideClearButton()},removeSquare:function(t){!!t&&BX.remove(t)},_onSearchContainerClick:function(t){var e=this.parent;if(this.isClearButton(t.target)){if(!e.getParam("VALUE_REQUIRED")){if(!e.getParam("VALUE_REQUIRED_MODE")){if(e.getParam("RESET_TO_DEFAULT_MODE")){this.clearInput();this.lastPromise=e.getPreset().applyPinnedPreset()}else{e.resetFilter()}e.closePopup();this.adjustFocus()}else{this.removeSquares();e.showPopup();this.adjustPlaceholder();this.hideClearButton();e.getPreset().deactivateAllPresets()}}else{var s=e.getPreset().isPinned(e.getPreset().getCurrentPresetId());if(s||e.getPreset().getCurrentPresetId()==="tmp_filter"){var i=e.getPreset().getPreset(e.getPreset().getCurrentPresetId());if(i.ADDITIONAL.length){i.ADDITIONAL=[];this.lastPromise=e.getPreset().applyPreset(e.getPreset().getCurrentPresetId());this.apply()}else{this.removeSquares();e.showPopup();this.adjustPlaceholder();this.hideClearButton();e.getPreset().deactivateAllPresets()}}else{if(e.getParam("RESET_TO_DEFAULT_MODE")){this.lastPromise=e.getPreset().applyPinnedPreset()}else{e.resetFilter()}e.closePopup();this.adjustFocus()}this.clearInput()}}else if(this.isSearchButton(t.target)){this.apply();this.adjustFocus()}else if(this.isSquareRemoveButton(t.target)){var r=this.findSquareByChild(t.target);this.complexSquareRemove(r);this.adjustFocus()}else{if(!e.getPopup().isShown()){e.showPopup()}else{var a=this.getInput();var n=a.selectionStart;var o=a.selectionEnd;var h=this.getSearchString().length;if(!(h&&n===0&&o===h)){if(e.getParam("VALUE_REQUIRED")){if(!this.getSquares().length){this.lastPromise=e.getPreset().applyPinnedPreset()}else{e.closePopup()}}else{e.closePopup();if(e.getParam("VALUE_REQUIRED_MODE")){e.restoreRemovedPreset()}}}}}},_onKeyDown:function(t){var e=BX.Filter.Utils;var s=this.parent;if(e.isKey(t,"enter")){if(s.getParam("VALUE_REQUIRED")){if(!this.getSquares().length){this.parent.getPreset().applyPinnedPreset()}else{this.apply();this.firstInit=false;this.lastSearchString=this.getSearchString()}}else{this.apply();this.firstInit=false;this.lastSearchString=this.getSearchString()}s.closePopup()}if(e.isKey(t,"tab")||e.isKey(t,"downArrow")){s.showPopup();s.adjustFocus();this.unselectSquares()}if(e.isKey(t,"upArrow")){s.closePopup();if(s.getParam("VALUE_REQUIRED_MODE")){this.parent.restoreRemovedPreset()}if(s.getParam("VALUE_REQUIRED")){if(!this.getSquares().length){this.parent.getPreset().applyPinnedPreset()}}}if(e.isKey(t,"a")&&t.metaKey||e.isKey(t,"a")&&t.ctrlKey){this.selectSquares()}if(e.isKey(t,"backspace")&&this.isTextSelected()&&this.isSquaresSelected()){clearTimeout(this.timeout);if(this.parent.getParam("VALUE_REQUIRED")){var i=this.parent.getPreset().isPinned(this.parent.getPreset().getCurrentPresetId());if(i){this.removeSquares();this.parent.showPopup();this.adjustPlaceholder();this.hideClearButton();this.parent.getPreset().deactivateAllPresets()}else{if(this.parent.getParam("RESET_TO_DEFAULT_MODE")){this.lastPromise=this.parent.getPreset().applyPinnedPreset()}else{this.parent.resetFilter()}this.parent.closePopup();this.adjustFocus()}this.clearInput()}else{if(this.parent.getParam("RESET_TO_DEFAULT_MODE")){this.lastPromise=this.parent.getPreset().applyPinnedPreset()}else{this.lastPromise=this.parent.resetFilter()}this.parent.closePopup()}}if(e.isKey(t,"backspace")&&this.isSelectionStart()){clearTimeout(this.timeout);var r=this.getLastSquare();this.isSquareSelected(r)?this.complexSquareRemove(r):this.selectSquare(r)}if(!e.isKey(t,"backspace")&&!t.metaKey&&this.isSquaresSelected()){this.unselectSquares()}},getSearchString:function(){var t=this.getInput();return!!t?t.value:""},getSquares:function(){return BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare,true)},adjustPlaceholder:function(){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER"+(this.parent.getParam("DISABLE_SEARCH")||!this.parent.settings.get("SEARCH")?"":"_DEFAULT")))},isResolvedRequest:function(){return!this.lastPromise||!!this.lastPromise&&this.lastPromise.state},apply:function(){if(this.isResolvedRequest()){this.lastPromise=this.parent._onFindButtonClick()}return this.lastPromise},reset:function(){if(this.isResolvedRequest()){this.parent.getSearch().removePreset();this.parent.getPreset().deactivateAllPresets();this.parent.getPreset().resetPreset(true);this.timeout=setTimeout(BX.delegate(function(){this.lastPromise=this.parent.resetFilter()},this),this.delay)}return this.lastPromise},_onInputWithoutDebounce:function(){clearTimeout(this.timeout);var t=this.getSearchString();this.lastSearchString=!!this.lastSearchString?this.lastSearchString:t;if(t!==this.lastSearchString&&(!this.parent.isIe()||!this.firstInit)){if(this.parent.getParam("ENABLE_LIVE_SEARCH")){this.parent.showGridAnimation();BX.onCustomEvent(window,"BX.Filter.Search:input",[this.parent.params.FILTER_ID,t])}this.parent.getPopup().isShown()&&this.parent.closePopup()}if(t){this.showClearButton()}else{if(!this.getSquares().length&&this.lastSearchString!==t){this.hideClearButton();this.adjustPlaceholder()}}},_onInput:function(){var t=this.getSearchString();if(t!==this.lastSearchString&&(!this.parent.isIe()||!this.firstInit)){this.apply()}this.firstInit=false;this.lastSearchString=t},getButtonsContainer:function(){if(!BX.type.isDomNode(this.buttonsContainer)){this.buttonsContainer=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSearchButtonsContainer)}return this.buttonsContainer},showClearButton:function(){BX.addClass(this.getButtonsContainer(),this.parent.settings.classShow)},hideClearButton:function(){BX.removeClass(this.getButtonsContainer(),this.parent.settings.classShow)},getInput:function(){var t;if(!BX.type.isDomNode(this.input)){t=[this.parent.getParam("FILTER_ID",""),"_search"].join("");this.input=BX(t)}return this.input},getContainer:function(){var t;if(!BX.type.isDomNode(this.container)){t=[this.parent.getParam("FILTER_ID"),"_search_container"].join("");this.container=BX(t)}return this.container},setInputPlaceholder:function(t){var e=this.getInput();e.placeholder=t},clearInput:function(){var t=this.getInput();if(BX.type.isDomNode(t)){t.value=null}},clearForm:function(){this.clearInput();this.removePreset()},makeSquares:function(t,e,s){var i;var r=null;var a=this.getContainer();var n={squares:[],moreSquares:[]};t.forEach(function(t,o){if(o<e){i=BX.decl(t);r=r||i;if(!s){if(o===0){BX.prepend(i,a)}else{BX.insertAfter(i,r)}}else{var h=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare);if(h){BX.insertAfter(i,h)}else{BX.prepend(i,a)}}r=i;n.squares.push(i)}else{n.moreSquares.push({type:"control",name:t.value,title:t.title})}},this);return n},squares:function(t,e,s){var i,r,a,n,o;var h=BX.Filter.Utils.getByClass(this.getContainer(),this.parent.settings.classSquare,true);if(s){h.forEach(function(t){var e=BX.data(t,"item");if(e){BX.remove(t)}})}else{h.forEach(BX.remove)}i=this.prepareSquaresData(t);r=this.makeSquares(i,e,s);n=0;o={squaresData:i,width:0};if(r.moreSquares.length){a={block:"main-ui-search-square",name:this.parent.getParam("MAIN_UI_FILTER__AND")+" "+this.parent.getParam("MAIN_UI_FILTER__MORE")+" "+r.moreSquares.length,item:r.moreSquares,title:r.moreSquares.map(function(t){return t.title}).join(", \n")};a=BX.decl(a);r.squares.push(a);BX.insertAfter(a,r.squares[r.squares.length-2]);n=r.squares.reduce(function(t,e){return t+BX.width(e)+(parseFloat(BX.style(e,"margin-right"))||0)},0)}o.width=n;return o},setPreset:function(t){var e=this.getContainer();var s,i;var r;if(BX.type.isPlainObject(t)){i=BX.Filter.Utils.getByClass(e,this.parent.settings.classSquare,true);i.forEach(BX.remove);t=BX.clone(t);t.ADDITIONAL=t.ADDITIONAL||[];BX.onCustomEvent(window,"BX.Filter.Search:beforeSquaresUpdate",[t,this]);if(t.ID!=="default_filter"&&t.ID!=="tmp_filter"){s=BX.decl({block:"main-ui-search-square",name:t.TITLE,value:t.ID,isPreset:true});BX.prepend(s,e);if("ADDITIONAL"in t&&BX.type.isArray(t.ADDITIONAL)&&t.ADDITIONAL.length){r=this.squares(t.ADDITIONAL,1,true);if(BX.width(e)-r.width<100){r=this.squares(t.ADDITIONAL,0,true)}}}else{if("ADDITIONAL"in t&&BX.type.isArray(t.ADDITIONAL)&&t.ADDITIONAL.length){t.ADDITIONAL.forEach(function(e,s){if(!("ID"in e)){e.ID="ADDITIONAL_ID_"+s}if(!("NAME"in e)){e.NAME="ADDITIONAL_NAME_"+s}if(!("TYPE"in e)){e.TYPE="STRING"}if("LABEL"in e&&"LABEL"in e){t.FIELDS.push(e)}})}if(BX.type.isArray(t.FIELDS)&&t.FIELDS.length){r=this.squares(t.FIELDS,2);if(BX.width(e)-r.width<100){r=this.squares(t.FIELDS,1)}}}if(r&&BX.type.isArray(r.squaresData)&&r.squaresData.length||t.ID!=="default_filter"&&t.ID!=="tmp_filter"){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_WITH_FILTER"));this.showClearButton()}else{if(this.parent.getParam("DISABLE_SEARCH")||!this.parent.settings.get("SEARCH")){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER"))}else{this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_DEFAULT"))}}if(BX.type.isNotEmptyString(this.parent.getSearch().getInput().value)){this.showClearButton()}}},prepareSquaresData:function(t){var e,s,i,r;var a=[];t.map(function(t){e=null;switch(t.TYPE){case this.parent.types.DATE:{e=t.LABEL+": "+t.SUB_TYPE.NAME;if(t.SUB_TYPE.VALUE===this.parent.dateTypes.QUARTER&&BX.type.isNotEmptyString(t.VALUES._quarter)){var r=t.QUARTERS.filter(function(e){return e.VALUE==t.VALUES._quarter}).map(function(t){return t.NAME});r=r.length?r.join(""):"";e=t.LABEL+": "+r+" "+this.parent.getParam("MAIN_UI_FILTER__QUARTER").toLocaleLowerCase()+" "+t.VALUES._year}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.YEAR&&BX.type.isNotEmptyString(t.VALUES._year)){e=t.LABEL+": "+t.VALUES._year}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.MONTH&&BX.type.isNotEmptyString(t.VALUES._month)){var n=t.MONTHS.filter(function(e){return e.VALUE==t.VALUES._month}).map(function(t){return t.NAME});n=n.length?n.join(""):"";e=t.LABEL+": "+n+" "+t.VALUES._year}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.EXACT&&BX.type.isNotEmptyString(t.VALUES._from)){e=t.LABEL+": "+t.VALUES._from}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.RANGE){if(BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+t.VALUES._from+"-"+t.VALUES._to}else if(!BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__BEFORE")+" "+t.VALUES._to}else if(BX.type.isNotEmptyString(t.VALUES._from)&&!BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__AFTER")+" "+t.VALUES._from}}if((t.SUB_TYPE.VALUE===this.parent.dateTypes.NEXT_DAYS||t.SUB_TYPE.VALUE===this.parent.dateTypes.PREV_DAYS)&&!BX.type.isNumber(parseInt(t.VALUES._days))){e=null}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.NEXT_DAYS&&BX.type.isNumber(parseInt(t.VALUES._days))){e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__DATE_NEXT_DAYS_LABEL").replace("#N#",t.VALUES._days)}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.PREV_DAYS&&BX.type.isNumber(parseInt(t.VALUES._days))){e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__DATE_PREV_DAYS_LABEL").replace("#N#",t.VALUES._days)}if(t.SUB_TYPE.VALUE===this.parent.dateTypes.NONE){e=null}break}case this.parent.types.CUSTOM_DATE:{if(BX.type.isArray(t.VALUE.days)&&t.VALUE.days.length||BX.type.isArray(t.VALUE.months)&&t.VALUE.months.length||BX.type.isArray(t.VALUE.years)&&t.VALUE.years.length){e=t.LABEL}break}case this.parent.types.SELECT:{if(BX.type.isPlainObject(t.VALUE)&&t.VALUE.VALUE||t.STRICT){e=t.LABEL+": "+t.VALUE.NAME}break}case this.parent.types.MULTI_SELECT:{if(BX.type.isArray(t.VALUE)&&t.VALUE.length){s=[];e=t.LABEL+": ";t.VALUE.forEach(function(t,e){if(e<2){s.push(t.NAME)}});e+=s.join(", ");if(t.VALUE.length>2){i=[];t.VALUE.forEach(function(t){i.push(t.NAME)});e=i.join(", ")}}break}case this.parent.types.NUMBER:{if(t.SUB_TYPE.VALUE==="exact"){if(BX.type.isNotEmptyString(t.VALUES._from)){e=t.LABEL+": "+t.VALUES._from}else{e=null}}if(t.SUB_TYPE.VALUE==="range"){if(BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+t.VALUES._from+"-"+t.VALUES._to}else if(!BX.type.isNotEmptyString(t.VALUES._from)&&BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__NUMBER_LESS")+" "+t.VALUES._to}else if(BX.type.isNotEmptyString(t.VALUES._from)&&!BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": "+this.parent.getParam("MAIN_UI_FILTER__NUMBER_MORE")+" "+t.VALUES._from}else{e=null}}if(t.SUB_TYPE.VALUE==="more"){if(BX.type.isNotEmptyString(t.VALUES._from)){e=t.LABEL+": > ";e+=t.VALUES._from}}if(t.SUB_TYPE.VALUE==="less"){if(BX.type.isNotEmptyString(t.VALUES._to)){e=t.LABEL+": < ";e+=t.VALUES._to}}break}case this.parent.types.CUSTOM_ENTITY:case this.parent.types.DEST_SELECTOR:{if(t.MULTIPLE){var o=!!t.VALUES._label?t.VALUES._label:[];if(BX.type.isPlainObject(o)){o=Object.keys(o).map(function(t){return o[t]})}if(!BX.type.isArray(o)){o=[o]}if(o.length>0){e=t.LABEL+": ";e+=o.join(", ")}}else{if(BX.type.isNotEmptyString(t.VALUES._value)&&BX.type.isNotEmptyString(t.VALUES._label)){e=t.LABEL+": ";e+=t.VALUES._label}}break}case this.parent.types.CUSTOM:{e="_VALUE"in t&&BX.type.isNotEmptyString(t._VALUE)?t.LABEL:null;break}default:{if(BX.type.isNotEmptyString(t.VALUE)){e=t.LABEL+": "+t.VALUE}break}}if(e!==null){a.push({block:"main-ui-search-square",name:e,value:t.NAME,item:{type:"control",name:t.NAME},title:e})}},this);return a},getPreset:function(){var t=this.getContainer();var e=this.parent.settings.classSquare;var s=null;if(BX.type.isDomNode(t)){s=BX.Filter.Utils.getByClass(t,e)}return s},removePreset:function(){var t=this.getPreset();if(BX.type.isDomNode(t)){BX.remove(t);if(this.parent.getParam("DISABLE_SEARCH")||!this.parent.settings.get("SEARCH")){this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER"))}else{this.setInputPlaceholder(this.parent.getParam("MAIN_UI_FILTER__PLACEHOLDER_DEFAULT"))}}this.hideClearButton()},updatePreset:function(t){this.removePreset();this.setPreset(t)}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:93:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/settings.min.js?15441273844327";s:6:"source";s:74:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/settings.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Filter");BX.Filter.Settings=function(i,t){this.classField="main-ui-control-field";this.classFieldGroup="main-ui-control-field-group";this.classFieldLine="main-ui-filter-field-line";this.classFieldDelete="main-ui-filter-field-delete";this.classFieldLabel="main-ui-control-field-label";this.classFieldWithLabel="main-ui-filter-wield-with-label";this.classPresetName="main-ui-filter-sidebar-item-text";this.classControl="main-ui-control";this.classDateInput="main-ui-date-input";this.classHide="main-ui-hide";this.classNumberInput="main-ui-number-input";this.classSelect="main-ui-select";this.classMultiSelect="main-ui-multi-select";this.classValueDelete="main-ui-control-value-delete";this.classStringInput="main-ui-control-string";this.classAddField="main-ui-filter-field-add-item";this.classAddPresetField="main-ui-filter-new-filter";this.classAddPresetFieldInput="main-ui-filter-sidebar-edit-control";this.classAddPresetButton="main-ui-filter-add-item";this.classButtonsContainer="main-ui-filter-field-button-container";this.classSaveButton="main-ui-filter-save";this.classCancelButton="main-ui-filter-cancel";this.classMenuItem="main-ui-select-inner-item";this.classMenuItemText="main-ui-select-inner-item-element";this.classMenuMultiItemText="main-ui-select-inner-label";this.classMenuItemChecked="main-ui-checked";this.classSearchContainer="main-ui-filter-search";this.classDefaultPopup="popup-window";this.classPopupFieldList="main-ui-filter-popup-field-list";this.classPopupFieldList1Column="main-ui-filter-field-list-1-column";this.classPopupFieldList2Column="main-ui-filter-field-list-2-column";this.classPopupFieldList3Column="main-ui-filter-field-list-3-column";this.classFieldListItem="main-ui-filter-field-list-item";this.classEditButton="main-ui-filter-add-edit";this.classPresetEdit="main-ui-filter-edit";this.classPresetNameEdit="main-ui-filter-edit-text";this.classPresetDeleteButton="main-ui-delete";this.classPresetDragButton="main-ui-filter-icon-grab";this.classPresetEditButton="main-ui-filter-icon-edit";this.classPresetEditInput="main-ui-filter-sidebar-item-input";this.classPresetOndrag="main-ui-filter-sidebar-item-ondrag";this.classSquare="main-ui-square";this.classSquareDelete="main-ui-square-delete";this.classSquareSelected="main-ui-square-selected";this.classPresetsContainer="main-ui-filter-sidebar-item-container";this.classPreset="main-ui-filter-sidebar-item";this.classPresetCurrent="main-ui-filter-current-item";this.classFilterContainer="main-ui-filter-wrapper";this.classFileldControlList="main-ui-filter-field-container-list";this.classRestoreFieldsButton="main-ui-filter-field-restore-items";this.classClearSearchValueButton="main-ui-delete";this.classSearchButtonsContainer="main-ui-item-icon-block";this.classSearchButton="main-ui-search";this.classDisabled="main-ui-disable";this.classAnimationShow="main-ui-popup-show-animation";this.classAnimationClose="main-ui-popup-close-animation";this.classSidebarControlsContainer="main-ui-filter-add-container";this.searchContainerPostfix="_search_container";this.classPresetButtonsContainer="main-ui-filter-field-preset-button-container";this.classFindButton="main-ui-filter-find";this.classResetButton="main-ui-filter-reset";this.classDefaultFilter="main-ui-filter-default-preset";this.classRestoreButton="main-ui-filter-reset-link";this.classPinButton="main-ui-filter-icon-pin";this.classPopupOverlay="popup-window-overlay";this.classPinnedPreset="main-ui-item-pin";this.classWaitButtonClass="ui-btn-clock";this.classForAllCheckbox="main-ui-filter-save-for-all";this.classShow="main-ui-show";this.classFocus="main-ui-focus";this.classPresetField="main-ui-filter-preset-field";this.numberPostfix="_numsel";this.datePostfix="_datesel";this.toPostfix="_to";this.fromPostfix="_from";this.daysPostfix="_days";this.monthPostfix="_month";this.quarterPostfix="_quarter";this.yearPostfix="_year";this.generalTemplateId="";this.init(i,t)};BX.Filter.Settings.prototype={init:function(i,t){this.generalTemplateId=t.getParam("FILTER_ID")+"_GENERAL_template";this.mergeSettings(i)},get:function(i,t){return i&&i in this&&!BX.type.isFunction(this[i])?this[i]:t},mergeSettings:function(i){if(BX.type.isPlainObject(i)){Object.keys(i).forEach(function(t){if(!BX.type.isFunction(this[t])){this[t]=i[t]}},this)}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:90:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/utils.min.js?15441273842208";s:6:"source";s:71:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/utils.js";s:3:"min";s:75:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/utils.min.js";s:3:"map";s:75:"/bitrix/components/bitrix/main.ui.filter/templates/.default/js/utils.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Filter");BX.Filter.Utils={cache:{},styleForEach:function(e,t){var n;t=BX.type.isPlainObject(t)?t:null;n=Object.keys(t);[].forEach.call(e||[],function(e){n.forEach(function(n){BX.style(e,n,t[n])})})},closestParent:function(e,t){if(e){if(!t){return e.parentNode||null}else{return BX.findParent(e,{className:t})}}},closestChilds:function(e){return!!e?e.children:null},getNext:function(e){return!!e?e.nextElementSibling:null},getPrev:function(e){return!!e?e.previousElementSibling:null},collectionSort:function(e,t){var n,i,r,o,l;if(e&&t&&e!==t&&e.parentNode===t.parentNode){n=this.closestParent(t);i=this.closestChilds(n);r=i.length;o=this.getIndex(i,e);l=this.getIndex(i,t);if(r===l){n.appendChild(t)}if(o>l){n.insertBefore(e,t)}if(o<l&&r!==l){n.insertBefore(e,this.getNext(t))}}},getIndex:function(e,t){return[].indexOf.call(e||[],t)},getByClass:function(e,t,n){var i=[];if(t){i=(e||document.body).getElementsByClassName(t);if(!n){i=i.length?i[0]:null}else{i=[].slice.call(i)}}return i},getByTag:function(e,t,n){var i=[];if(t){i=(e||document.body).getElementsByTagName(t);if(!n){i=i.length?i[0]:null}else{i=[].slice.call(i)}}return i},getBySelector:function(e,t,n){var i=[];if(t){if(!n){i=(e||document.body).querySelector(t)}else{i=(e||document.body).querySelectorAll(t);i=[].slice.call(i)}}return i},requestAnimationFrame:function(){var e=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};e.apply(window,arguments)},sortObject:function(e){var t={};Object.keys(e).sort().forEach(function(n){t[n]=e[n]});return t},objectsIsEquals:function(e,t){return JSON.stringify(e)===JSON.stringify(t)},isKey:function(e,t){var n={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",27:"escape",32:"space",37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",46:"delete",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",65:"a"};var i=!!e?"keyCode"in e?e.keyCode:"which"in e?e.which:0:0;return i in n&&n[i]===t}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:99:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/date-group.min.js?15441273841411";s:6:"source";s:80:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/date-group.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui.block");BX.Main.ui.block["date-group"]=function(t){var e,n,i,a,l;e={block:"main-ui-control-field-group",name:"name"?t.name+"_datesel":"",mix:"mix"in t?t.mix:null,attrs:{"data-type":"type"in t?t.type:"","data-name":"name"in t?t.name:"","data-time":t.enableTime},content:[]};if("label"in t&&BX.type.isNotEmptyString(t.label)){a={block:"main-ui-control-field-label",tag:"span",attrs:{title:t.label},content:t.label};e.content.push(a)}n={block:"main-ui-control-field",dragButton:false,content:{block:"main-ui-select",tabindex:"tabindex"in t?t.tabindex:"",value:"value"in t?t.value:"",items:"items"in t?t.items:"",name:"name"in t?t.name+"_datesel":"",params:"params"in t?t.params:"",valueDelete:false}};e.content.push(n);if("content"in t&&BX.type.isArray(t.content)){t.content.forEach(function(t){e.content.push(t)})}if("content"in t&&(BX.type.isPlainObject(t.content)||BX.type.isNotEmptyString(t.content))){e.content.push(t.content)}i={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in t&&t.deleteTitle?t.deleteTitle:""}}};e.content.push(i);if(!("dragButton"in t)||t.dragButton!==false){l={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in t&&t.dragTitle?t.dragTitle:""}};e.content.push(l)}return e}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:116:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-field-group.min.js?15441273841102";s:6:"source";s:97:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-field-group.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-control-field-group"]=function(t){var e,n,i,a;e={block:"main-ui-control-field-group",mix:"mix"in t?t.mix:null,attrs:{"data-type":"type"in t?t.type:"","data-name":"name"in t?t.name:""},content:[]};if("label"in t&&BX.type.isNotEmptyString(t.label)){i={block:"main-ui-control-field-label",tag:"span",attrs:{title:t.label},content:t.label};e.content.push(i)}if(BX.type.isArray(t.content)){t.content.forEach(function(t){e.content.push(t)})}else if(BX.type.isPlainObject(t.content)||BX.type.isNotEmptyString(t.content)){e.content.push(t.content)}if("deleteButton"in t&&t.deleteButton===true){n={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in t&&t.deleteTitle?t.deleteTitle:""}}};e.content.push(n)}if(!("dragButton"in t)||t.dragButton!==false){a={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in t&&t.dragTitle?t.dragTitle:""}};e.content.push(a)}return e}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:110:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-field.min.js?15441273841258";s:6:"source";s:91:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-field.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-control-field"]=function(t){var e,n,i,l,a;e={block:"main-ui-control-field",mix:"mix"in t?t.mix:null,attrs:{"data-type":"type"in t?t.type:"","data-name":"name"in t?t.name:""},content:[]};if("label"in t&&BX.type.isNotEmptyString(t.label)){l={block:"main-ui-control-field-label",tag:"span",attrs:{title:t.label},content:t.label};e.content.push(l)}if(BX.type.isArray(t.content)){t.content.forEach(function(t){e.content.push(t)})}else if(BX.type.isPlainObject(t.content)||BX.type.isNotEmptyString(t.content)){e.content.push(t.content)}if("valueDelete"in t&&t.valueDelete===true){i={block:"main-ui-control-value-delete",content:{block:"main-ui-control-value-delete-item",tag:"span"}};e.content.push(i)}if("deleteButton"in t&&t.deleteButton===true){n={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in t&&t.deleteTitle?t.deleteTitle:""}}};e.content.push(n)}if(!("dragButton"in t)||t.dragButton!==false){a={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in t&&t.dragTitle?t.dragTitle:""}};e.content.push(a)}return e}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:110:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-string.min.js?1544127384422";s:6:"source";s:92:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-string.js";s:3:"min";s:96:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-string.min.js";s:3:"map";s:96:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-string.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-control-string"]=function(n){return{block:"main-ui-control-string",mix:["main-ui-control"],tag:"input",attrs:{type:"type"in n?n.type:"text",name:"name"in n?n.name:"",placeholder:"placeholder"in n?n.placeholder:"",tabindex:"tabindex"in n?n.tabindex:"",value:"value"in n?n.value:""}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:118:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-filter-field-list-item.min.js?1544127384490";s:6:"source";s:100:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-filter-field-list-item.js";s:3:"min";s:104:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-filter-field-list-item.min.js";s:3:"map";s:104:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-filter-field-list-item.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-filter-field-list-item"]=function(i){var e={block:"main-ui-select-inner-label",content:"label"in i?i.label:""};var n={block:"main-ui-filter-field-list-item",mix:"main-ui-select-inner-item",attrs:{"data-id":i.id,"data-name":i.name,"data-item":"item"in i?JSON.stringify(i.item):{}},events:{click:"onClick"in i?i.onClick:""},content:e};return n}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:107:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-filter-info.min.js?1544127384250";s:6:"source";s:89:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-filter-info.js";s:3:"min";s:93:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-filter-info.min.js";s:3:"map";s:93:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-filter-info.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-filter-info"]=function(t){return{block:"main-ui-filter-info",tag:"span",content:t.content,attrs:{title:t.title}}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:102:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-number.min.js?1544127384754";s:6:"source";s:84:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-number.js";s:3:"min";s:88:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-number.min.js";s:3:"map";s:88:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-number.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-number"]=function(e){var n,i,t;n={block:"main-ui-number",mix:["main-ui-control"],content:[]};if("mix"in e&&BX.type.isArray(e.mix)){e.mix.forEach(function(e){n.mix.push(e)})}i={block:"main-ui-number-input",mix:["main-ui-control-input"],tag:"input",attrs:{type:"number",name:"name"in e?e.name:"",tabindex:"tabindex"in e?e.tabindex:"",value:"value"in e?e.value:"",placeholder:"placeholder"in e?e.placeholder:"",autocomplete:"off"}};n.content.push(i);if("valueDelete"in e&&e.valueDelete===true){t={block:"main-ui-control-value-delete",content:{block:"main-ui-control-value-delete-item",tag:"span"}};n.content.push(t)}return n}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:109:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-search-square.min.js?1544127384513";s:6:"source";s:91:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-search-square.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui.block");BX.Main.ui.block["main-ui-search-square"]=function(i){var e=["main-ui-filter-search-square"];if("isPreset"in i&&i.isPreset){e.push("main-ui-filter-search-square-preset")}return{block:"main-ui-square",mix:e,attrs:{"data-item":"item"in i?JSON.stringify(i.item):"",title:"title"in i?i.title:""},content:[{block:"main-ui-square-item",content:"name"in i?BX.util.htmlspecialcharsback(i.name):""},{block:"main-ui-square-delete",mix:["main-ui-item-icon"]}]}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:101:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/number-group.min.js?15441273841390";s:6:"source";s:82:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/number-group.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui.block");BX.Main.ui.block["number-group"]=function(t){var n,e,i,a,l;n={block:"main-ui-control-field-group",name:"name"in t?t.name+"_numsel":"",mix:"mix"in t?t.mix:null,attrs:{"data-type":"type"in t?t.type:"","data-name":"name"in t?t.name:""},content:[]};if("label"in t&&BX.type.isNotEmptyString(t.label)){a={block:"main-ui-control-field-label",tag:"span",attrs:{title:t.label},content:t.label};n.content.push(a)}e={block:"main-ui-control-field",dragButton:false,content:{block:"main-ui-select",tabindex:"tabindex"in t?t.tabindex:"",value:"value"in t?t.value:"",items:"items"in t?t.items:"",name:"name"in t?t.name+"_numsel":"",params:"params"in t?t.params:"",valueDelete:false}};n.content.push(e);if("content"in t&&BX.type.isArray(t.content)){t.content.forEach(function(t){n.content.push(t)})}if("content"in t&&(BX.type.isPlainObject(t.content)||BX.type.isNotEmptyString(t.content))){n.content.push(t.content)}i={block:"main-ui-item-icon-container",content:{block:"main-ui-item-icon",mix:["main-ui-delete","main-ui-filter-field-delete"],tag:"span",attrs:{title:"deleteTitle"in t&&t.deleteTitle?t.deleteTitle:""}}};n.content.push(i);if(!("dragButton"in t)||t.dragButton!==false){l={block:"main-ui-filter-icon-grab",mix:["main-ui-item-icon"],tag:"span",attrs:{title:"dragTitle"in t&&t.dragTitle?t.dragTitle:""}};n.content.push(l)}return n}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:101:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/sidebar-item.min.js?15441273841364";s:6:"source";s:82:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/sidebar-item.js";s:3:"min";s:86:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/sidebar-item.min.js";s:3:"map";s:86:"/bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/sidebar-item.map.js";}"*/
(function(){"use strict";BX.namespace("BX.Main.ui.block");BX.Main.ui.block["sidebar-item"]=function(i){return{block:"main-ui-filter-sidebar-item"+("pinned"in i&&i.pinned?" main-ui-item-pin":""),attrs:{"data-id":"id"in i?i.id:""},content:[{block:"main-ui-filter-icon-grab",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"dragTitle"in i&&i.dragTitle?i.dragTitle:""}},{block:"main-ui-filter-sidebar-item-text-container",tag:"span",content:[{block:"main-ui-filter-sidebar-item-input",tag:"input",attrs:{type:"text",placeholder:"placeholder"in i?i.placeholder:"",value:"text"in i?BX.util.htmlspecialchars(BX.util.htmlspecialcharsback(i.text)):""}},{block:"main-ui-filter-sidebar-item-text",tag:"span",content:"text"in i?i.text:""},{block:"main-ui-filter-icon-pin",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"noEditPinTitle"in i&&i.noEditPinTitle?i.noEditPinTitle:""}}]},{block:"main-ui-filter-icon-edit",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"editNameTitle"in i&&i.editNameTitle?i.editNameTitle:""}},{block:"main-ui-delete",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"removeTitle"in i&&i.removeTitle?i.removeTitle:""}},{block:"main-ui-filter-icon-pin",tag:"span",mix:["main-ui-item-icon"],attrs:{title:"editPinTitle"in i&&i.editPinTitle?i.editPinTitle:""}},{block:"main-ui-filter-edit-mask"}]}}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:103:"/bitrix/components/bitrix/crm.widget.custom.saletarget/templates/.default/script.min.js?154412740115387";s:6:"source";s:83:"/bitrix/components/bitrix/crm.widget.custom.saletarget/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Crm.Widget.Custom");BX.Crm.Widget.Custom.SaleTarget=function(e){"use strict";var t=function(t){this.loopData={};this.rootNode=e.type.isDomNode(t)?e.clone(t):this.getTemplateNode(t)};t.prototype={getTemplateNode:function(t){var a=window.document.querySelector('[data-template="'+t+'"]');var r=e.create("div",{html:a.innerHTML});this.replaceIncludes(r);return r},getTemplateAttribute:function(e,t){var a=window.document.querySelector('[data-template="'+e+'"]');return a.getAttribute("data-"+t)},replaceIncludes:function(e){var t=e.querySelectorAll("[data-include]");for(var a=0;a<t.length;++a){var r=t[a].getAttribute("data-include");t[a].innerHTML="";t[a].appendChild(this.getTemplateNode(r))}},loop:function(a,r,n){var s=this.rootNode.querySelector('[data-loop="'+a+'"]');if(!s){return false}var i=s.firstElementChild;this.loopData[a]={itemNode:i,loopFn:n};e.cleanNode(s);for(var o=0;o<r.length;++o){var g=new t(i);if(n(g,r[o])!==false){s.appendChild(g.get())}}return true},loopAppend:function(e,a){var r=this.rootNode.querySelector('[data-loop="'+e+'"]');if(!r||!this.loopData[e]){return false}var n=new t(this.loopData[e]["itemNode"]);this.loopData[e]["loopFn"](n,a,true);r.appendChild(n.get());return true},applyIf:function(t,a){a=a.toString();var r=this.rootNode.querySelectorAll('[data-if^="'+t+'="]');for(var n=0;n<r.length;++n){var s=r[n].getAttribute("data-if").split("=")[1];if(s!==a){e.remove(r[n])}}},get:function(e){if(!e)return this.rootNode;return this.rootNode.querySelector('[data-role="'+e+'"]')},getAll:function(e){return Array.prototype.slice.call(this.rootNode.querySelectorAll('[data-role="'+e+'"]'))}};var a={getMonths:function(){return{1:e.message("CRM_WIDGET_SALETARGET_MONTH_JAN"),2:e.message("CRM_WIDGET_SALETARGET_MONTH_FEB"),3:e.message("CRM_WIDGET_SALETARGET_MONTH_MAR"),4:e.message("CRM_WIDGET_SALETARGET_MONTH_APR"),5:e.message("CRM_WIDGET_SALETARGET_MONTH_MAY"),6:e.message("CRM_WIDGET_SALETARGET_MONTH_JUN"),7:e.message("CRM_WIDGET_SALETARGET_MONTH_JUL"),8:e.message("CRM_WIDGET_SALETARGET_MONTH_AUG"),9:e.message("CRM_WIDGET_SALETARGET_MONTH_SEP"),10:e.message("CRM_WIDGET_SALETARGET_MONTH_OCT"),11:e.message("CRM_WIDGET_SALETARGET_MONTH_NOV"),12:e.message("CRM_WIDGET_SALETARGET_MONTH_DEC")}},getDaysOfMonth:function(){return{1:e.message("CRM_WIDGET_SALETARGET_DAY_OF_JAN"),2:e.message("CRM_WIDGET_SALETARGET_DAY_OF_FEB"),3:e.message("CRM_WIDGET_SALETARGET_DAY_OF_MAR"),4:e.message("CRM_WIDGET_SALETARGET_DAY_OF_APR"),5:e.message("CRM_WIDGET_SALETARGET_DAY_OF_MAY"),6:e.message("CRM_WIDGET_SALETARGET_DAY_OF_JUN"),7:e.message("CRM_WIDGET_SALETARGET_DAY_OF_JUL"),8:e.message("CRM_WIDGET_SALETARGET_DAY_OF_AUG"),9:e.message("CRM_WIDGET_SALETARGET_DAY_OF_SEP"),10:e.message("CRM_WIDGET_SALETARGET_DAY_OF_OCT"),11:e.message("CRM_WIDGET_SALETARGET_DAY_OF_NOV"),12:e.message("CRM_WIDGET_SALETARGET_DAY_OF_DEC")}},getQuarters:function(){return{1:e.message("CRM_WIDGET_SALETARGET_QUARTER_1"),2:e.message("CRM_WIDGET_SALETARGET_QUARTER_2"),3:e.message("CRM_WIDGET_SALETARGET_QUARTER_3"),4:e.message("CRM_WIDGET_SALETARGET_QUARTER_4")}},getHalfs:function(){return{1:e.message("CRM_WIDGET_SALETARGET_HALF_YEAR_1"),2:e.message("CRM_WIDGET_SALETARGET_HALF_YEAR_2")}},getDealPluralRules:function(){return[e.message("CRM_WIDGET_SALETARGET_DEAL_PLURAL_1"),e.message("CRM_WIDGET_SALETARGET_DEAL_PLURAL_2"),e.message("CRM_WIDGET_SALETARGET_DEAL_PLURAL_3")]},dealPlural:function(e){e=parseInt(e);var t=0;if(e>20)e=e%10;if(e===1)t=0;else if(e>1&&e<5)t=1;else t=2;return this.getDealPluralRules()[t]},month:function(e){var t=e.getMonth()+1;var a=this.getMonths();return a[t]?a[t]:""},day:function(e){var t=e.getDate(),a=e.getMonth()+1;var r=this.getDaysOfMonth();return(r[a]?r[a]:"").replace("#NUM#",t.toString())},quarter:function(e){var t=1,a=e.getMonth();if(a>8)t=4;else if(a>5)t=3;else if(a>2)t=2;return this.getQuarters()[t]},halfYear:function(e){var t=e.getMonth();var a=t<6?1:2;return this.getHalfs()[a]},number:function(t,a){var r=a?a["DEC_POINT"]:"";var n=a?a["THOUSANDS_SEP"]:" ";return e.util.number_format(t,0,r,n)},target:function(e,t,a){if(t===n.Type.Quantity){return this.number(e,a)+" <span>"+this.dealPlural(e)+"</span>"}e=this.number(e,a);var r="",s=false;var i=a["FORMAT_STRING"].split("#");for(var o=0;o<i.length;++o){if(i[o].length>0){r+="<span>"+i[o]+"</span>"}else if(!s){r+=e;s=true}}return r},copyPeriod:function(t){switch(t){case r.Type.Year:return e.message("CRM_WIDGET_SALETARGET_CONFIG_COPY_Y");break;case r.Type.Half:return e.message("CRM_WIDGET_SALETARGET_CONFIG_COPY_H");break;case r.Type.Quarter:return e.message("CRM_WIDGET_SALETARGET_CONFIG_COPY_Q");break;case r.Type.Month:return e.message("CRM_WIDGET_SALETARGET_CONFIG_COPY_M");break}return e.message("CRM_WIDGET_SALETARGET_CONFIG_COPY_PERIOD")}};var r=function(e){this.type=e.type;this.month=e.month?parseInt(e.month):null;this.year=e.year?parseInt(e.year):null;this.half=e.half?parseInt(e.half):null;this.quarter=e.quarter?parseInt(e.quarter):null;this.calculate()};r.Type={Year:"Y",Half:"H",Quarter:"Q",Month:"M"};r.getTypeList=function(){return[{id:"M",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_PERIOD_TYPE_M")},{id:"Q",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_PERIOD_TYPE_Q")},{id:"H",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_PERIOD_TYPE_H")},{id:"Y",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_PERIOD_TYPE_Y")}]};r.getYearList=function(){var e=2017;var t=(new Date).getFullYear()-e+5;var a=[];for(var r=0;r<=t;++r){a.push({id:e+r,name:(e+r).toString()})}return a};r.getHalfList=function(){return[{id:1,shortName:"I",name:e.message("CRM_WIDGET_SALETARGET_HALF_YEAR_1")},{id:2,shortName:"II",name:e.message("CRM_WIDGET_SALETARGET_HALF_YEAR_2")}]};r.getQuarterList=function(){return[{id:1,shortName:"I",name:e.message("CRM_WIDGET_SALETARGET_QUARTER_1")},{id:2,shortName:"II",name:e.message("CRM_WIDGET_SALETARGET_QUARTER_2")},{id:3,shortName:"III",name:e.message("CRM_WIDGET_SALETARGET_QUARTER_3")},{id:4,shortName:"IV",name:e.message("CRM_WIDGET_SALETARGET_QUARTER_4")}]};r.getMonthList=function(){return[{id:1,name:e.message("CRM_WIDGET_SALETARGET_MONTH_JAN")},{id:2,name:e.message("CRM_WIDGET_SALETARGET_MONTH_FEB")},{id:3,name:e.message("CRM_WIDGET_SALETARGET_MONTH_MAR")},{id:4,name:e.message("CRM_WIDGET_SALETARGET_MONTH_APR")},{id:5,name:e.message("CRM_WIDGET_SALETARGET_MONTH_MAY")},{id:6,name:e.message("CRM_WIDGET_SALETARGET_MONTH_JUN")},{id:7,name:e.message("CRM_WIDGET_SALETARGET_MONTH_JUL")},{id:8,name:e.message("CRM_WIDGET_SALETARGET_MONTH_AUG")},{id:9,name:e.message("CRM_WIDGET_SALETARGET_MONTH_SEP")},{id:10,name:e.message("CRM_WIDGET_SALETARGET_MONTH_OCT")},{id:11,name:e.message("CRM_WIDGET_SALETARGET_MONTH_NOV")},{id:12,name:e.message("CRM_WIDGET_SALETARGET_MONTH_DEC")}]};r.prototype={getId:function(){var e=r.Type.Year+this.year+this.type;switch(this.type){case r.Type.Month:e+=this.month;break;case r.Type.Quarter:e+=this.quarter;break;case r.Type.Half:e+=this.half;break}return e},calculate:function(){switch(this.type){case r.Type.Month:this.calculateMonth();break;case r.Type.Quarter:this.calculateQuarter();break;case r.Type.Half:this.calculateHalf();break;default:this.calculateYear()}},calculateMonth:function(){this.startDate=new Date(this.year,this.month-1,1);this.endDate=new Date(this.year,this.month,0)},calculateQuarter:function(){var e=(this.quarter-1)*3;this.startDate=new Date(this.year,e,1);this.endDate=new Date(this.year,e+3,0)},calculateHalf:function(){var e=this.half===1?0:6;this.startDate=new Date(this.year,e,1);this.endDate=new Date(this.year,e+6,0)},calculateYear:function(){this.startDate=new Date(this.year,0,1);this.endDate=new Date(this.year,11,31)},getLabel:function(){var e,t=this.startDate;switch(this.type){case r.Type.Month:e=a.month(t);break;case r.Type.Half:e=a.halfYear(t);break;case r.Type.Quarter:e=a.quarter(t);break}return(e?e+" ":"")+this.year},getDayPositionPercent:function(e){e.setHours(0,0,0,0);var t=e.getTime();var a=this.startDate.getTime();var r=this.endDate.getTime();if(e<a||e>r)return-1;return(t-a)/(r-a)*100},next:function(){switch(this.type){case r.Type.Month:this.month+=1;if(this.month>12){this.month=1;++this.year}break;case r.Type.Half:this.half+=1;if(this.half>2){this.half=1;++this.year}break;case r.Type.Quarter:this.quarter+=1;if(this.quarter>4){this.quarter=1;++this.year}break;default:++this.year}this.calculate();return this},getLeftBorder:function(){return this.startDate.getTime()/1e3},getRightBorder:function(){return this.endDate.getTime()/1e3}};var n=function(e,t,a,r){this.type=e;this.period=t;this.goal=parseInt(a);this.current=parseInt(r);this.calculate()};n.Type={Sum:"S",Quantity:"Q"};n.getTypeList=function(){return[{id:n.Type.Sum,name:e.message("CRM_WIDGET_SALETARGET_CONFIG_TARGET_TYPE_S")},{id:n.Type.Quantity,name:e.message("CRM_WIDGET_SALETARGET_CONFIG_TARGET_TYPE_Q")}]};n.prototype={calculate:function(){this.remaining=this.goal>this.current?this.goal-this.current:0;this.completedPercent=this.goal>0&&this.current>0?Math.floor(this.current/this.goal*100):0;this.progressPercent=Math.min(100,this.completedPercent)},append:function(e){this.goal+=e.goal;this.current+=e.current;this.calculate();return this}};return{useAutoHeight:function(){return true},prepareButtons:function(t){var a=e.CrmCustomWidget.superclass.prepareButtons.apply(t);if(t._data["attributes"]["isConfigurable"]===true){a["intitle_config"]=e.create("SPAN",{attrs:{className:"crm-widget-settings-text"},text:e.message("CRM_WIDGET_SALETARGET_CONFIG_LABEL"),events:{click:this.openConfigDialog.bind(this,t,null)}})}return a},createContentNode:function(s,i){var o=new t("widget-saletarget-main"),g=i.configuration;if(i.isNew){this.changeConfiguration(null,s,i);return e.create("div")}var l=s.getPanel().getCurrencyFormat();var u=new r(g.period);var _=new n(g.target.type,u,Math.max(0,g.target.totalGoal),i.totalCurrent);o.get("current-period").textContent=u.getLabel();o.get("total-target").innerHTML=a.target(_.goal,_.type,l);o.get("total-complete").innerHTML=a.target(_.current,_.type,l);o.get("total-remaining").innerHTML=a.target(_.remaining,_.type,l);o.get("total-progress-percent").textContent=Math.abs(_.completedPercent);o.applyIf("view-type",g.type);this.dealCategories=e.parseJSON(o.getTemplateAttribute("widget-saletarget-main","categories"));if(g.type==="COMPANY"){this.createCompanyContentNode(o,s,i)}else if(g.type==="CATEGORY"){this.createCategoryContentNode(o,s,i)}else if(g.type==="USER"){this.createUserContentNode(o,s,i)}o.getAll("today").forEach(function(e){e.textContent=a.day(new Date)});o.getAll("first-day").forEach(function(e){e.textContent=a.day(u.startDate)});o.getAll("last-day").forEach(function(e){e.textContent=a.day(u.endDate)});var T=Math.floor(u.getDayPositionPercent(new Date));o.getAll("progress-point").forEach(function(t){if(T>-1){t.style.left=T+"%";if(T<=2&&t.getAttribute("data-left-class")){e.addClass(t,t.getAttribute("data-left-class"))}else if(T>=98&&t.getAttribute("data-right-class")){e.addClass(t,t.getAttribute("data-right-class"))}}else{e.remove(t)}});o.getAll("progress-line").forEach(function(e){e.style.width=_.progressPercent+"%"});o.getAll("progress-total").forEach(function(e){e.textContent=_.completedPercent});if(_.completedPercent>95){o.getAll("progress").forEach(function(t){e.addClass(t,t.getAttribute("data-more-class"))})}if(i.previousConfigurationId>0){e.bind(o.get("previous-period"),"click",this.changeConfiguration.bind(this,i.previousConfigurationId,s,i))}else{e.remove(o.get("previous-period"))}if(i.nextConfigurationId>0){e.bind(o.get("next-period"),"click",this.changeConfiguration.bind(this,i.nextConfigurationId,s,i))}else{e.remove(o.get("next-period"))}return o?o.get():e.create("div",{text:"Invalid widget configuration."})},changeConfiguration:function(t,a,r){var n=this;if(a._contentWrapper.firstElementChild){a._contentWrapper.firstElementChild.style.opacity=.3}var s={sessid:e.bitrix_sessid(),site:e.message("SITE_ID"),action:"get_configuration",configuration_id:t};if(t===null){s.action="get_current_configuration";delete s.configuration_id}e.ajax({url:this.ajaxUrl||"/bitrix/components/bitrix/crm.widget.custom.saletarget/ajax.php",method:"POST",dataType:"json",data:s,onsuccess:function(e){delete r.isNew;r.configuration=e.configuration;r.current=e.current;r.nextConfigurationId=e.nextConfigurationId;r.previousConfigurationId=e.previousConfigurationId;r.totalCurrent=e.totalCurrent;a._contentWrapper.innerHTML="";a._contentWrapper.appendChild(n.createContentNode(a,r))},onfailure:function(){if(a._contentWrapper.firstElementChild){a._contentWrapper.firstElementChild.style.opacity=1}}})},createCompanyContentNode:function(e,t,a){return e},createCategoryContentNode:function(t,s,i){var o=i.configuration;var g=s.getPanel().getCurrencyFormat();var l=new r(o.period);t.loop("categories",this.dealCategories,function(t,r){var s=o.target.goal[r["id"]]||0;var u=i.current[r["id"]]||0;if(s<=0){return false}var _=new n(o.target.type,l,s,u);e.bind(t.get("category-row"),"click",function(t){e.toggleClass(t,t.getAttribute("data-open-class"));e.toggleClass(this,this.getAttribute("data-open-class"))}.bind(t.get("category-target-details"),t.get("category-row")));t.get("category-name").textContent=r.name;t.get("category-progress-line").style.width=_.progressPercent+"%";t.get("category-progress-line-value").textContent=_.completedPercent;if(_.completedPercent>95){e.addClass(t.get("category-progress"),t.get("category-progress").getAttribute("data-more-class"))}t.get("category-target").innerHTML=a.target(_.goal,_.type,g);t.get("category-target-current").innerHTML=a.target(_.current,_.type,g);t.get("category-target-remaining").innerHTML=a.target(_.remaining,_.type,g);t.get("category-target-effective").textContent=Math.abs(_.completedPercent)});return t},createUserContentNode:function(t,s,i){var o=i.configuration;var g=s.getPanel().getCurrencyFormat();var l=new r(o.period);var u=o.users.length<2;t.loop("users",o.users,function(t,r){var s=o.target.goal[r["id"]]||0;var _=i.current[r["id"]]||0;if(s<=0){return false}var T=new n(o.target.type,l,s,_);e.bind(t.get("user-row"),"click",function(t){e.toggleClass(t,t.getAttribute("data-open-class"));e.toggleClass(this,this.getAttribute("data-open-class"))}.bind(t.get("user-target-details"),t.get("user-row")));t.get("user-name").textContent=r.name;t.get("user-title").textContent=r.title;if(r.photo){t.get("user-photo").style.background="url("+r.photo+")"}t.get("user-progress-line").style.width=T.progressPercent+"%";t.get("user-progress-line-value").textContent=T.completedPercent;if(T.completedPercent>95){e.addClass(t.get("user-progress"),t.get("user-progress").getAttribute("data-more-class"))}t.get("user-target").innerHTML=a.target(T.goal,T.type,g);t.get("user-target-current").innerHTML=a.target(T.current,T.type,g);t.get("user-target-remaining").innerHTML=a.target(T.remaining,T.type,g);t.get("user-target-effective").textContent=Math.abs(T.completedPercent);if(u){e.addClass(t.get("user-row"),t.get("user-row").getAttribute("data-open-class"));e.addClass(t.get("user-target-details"),t.get("user-target-details").getAttribute("data-open-class"))}});return t},openConfigDialog:function(t,a){if(!a){a=e.type.isArray(t._data["items"])&&t._data["items"].length>0?t._data["items"][0]:null}new e.Crm.Widget.Custom.SaleTarget.ConfigPopup(t,a,{categories:this.dealCategories}).show()},Template:t,Period:r,Target:n,Label:a}}(window.BX||window.top.BX);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:109:"/bitrix/components/bitrix/crm.widget.custom.saletarget/templates/.default/user_selector.min.js?15441274011899";s:6:"source";s:90:"/bitrix/components/bitrix/crm.widget.custom.saletarget/templates/.default/user_selector.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Crm.Widget.Custom.SaleTarget");BX.Crm.Widget.Custom.SaleTarget.UserSelector=function(t){"use strict";var e=function(e){this.id="saletarget-user-selector-"+t.util.getRandomString(7);this.bindTo=e.bindTo;this.selected={};if(e.selected){for(var i=0;i<e.selected.length;++i){this.selected[e.selected[i].id]="user"}}e.selected?t.clone(e.selected):[];this.addCallback=e.addCallback;this.parentPopup=e.parentPopup;this.bind()};e.canUse=function(){return!!t.SocNetLogDestination};e.prototype={bind:function(){t.bind(this.bindTo,"click",this.onBindClick.bind(this));if(this.parentPopup){t.addCustomEvent(this.parentPopup,"onPopupClose",this.onParentPopupClose.bind(this))}},initDialog:function(){if(!e.canUse()){return false}if(this.inited){return true}var i={users:e.data.users||{},department:e.data.department||{},departmentRelation:e.data.departmentRelation||{}};var n={users:e.data.last.USERS||{}};if(!i["departmentRelation"]){i["departmentRelation"]=t.SocNetLogDestination.buildDepartmentRelation(i["department"])}var a=this.addCallback;t.SocNetLogDestination.init({name:this.id,showSearchInput:true,bindMainPopup:{node:this.bindTo,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,sendAjaxSearch:true,allowAddUser:false,extranetUser:false,useClientDatabase:false,items:i,itemsLast:n,itemsSelected:this.selected,destSort:e.data.destSort||{},callback:{select:function(e,i,n,s,o,r){if(r!=="select"){return}var d={id:parseInt(e["entityId"]),name:t.util.htmlspecialcharsback(e["name"]),title:t.util.htmlspecialcharsback(e["desc"]),photo:e["avatar"]};a(d);t.SocNetLogDestination.closeDialog()}}});return this.inited=true},onBindClick:function(){if(this.initDialog()){t.SocNetLogDestination.openDialog(this.id)}},onParentPopupClose:function(){if(this.inited){if(t.SocNetLogDestination.isOpenDialog()){t.SocNetLogDestination.closeDialog()}}}};return e}(window.BX||window.top.BX);
/* End */
;
; /* Start:"a:4:{s:4:"full";s:109:"/bitrix/components/bitrix/crm.widget.custom.saletarget/templates/.default/config_popup.min.js?154412740114163";s:6:"source";s:89:"/bitrix/components/bitrix/crm.widget.custom.saletarget/templates/.default/config_popup.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
BX.namespace("BX.Crm.Widget.Custom.SaleTarget");BX.Crm.Widget.Custom.SaleTarget.ConfigPopup=function(e){"use strict";var t=e.Crm.Widget.Custom.SaleTarget.Template;var i=e.Crm.Widget.Custom.SaleTarget.Period;var o=e.Crm.Widget.Custom.SaleTarget.Target;var n=e.Crm.Widget.Custom.SaleTarget.Label;var r=e.Crm.Widget.Custom.SaleTarget.UserSelector;var s=function(e){this.id="saletarget-selector-"+Math.random();this.controlNode=e.controlNode;this.displayNode=e.displayNode;this.parentPopup=e.parentPopup;this.menuPopup=null;this.listeners=e.events||{};this.values=e.values||[];this.createInput(e);if(e.value){this.setValue(e.value,true)}this.bind()};s.prototype={createInput:function(t){this.input=null;if(t.form&&t.name){this.input=e.create("input",{attrs:{type:"hidden",name:t.name}});t.form.appendChild(this.input)}},bind:function(){e.bind(this.controlNode,"click",this.onControlClick.bind(this));if(this.parentPopup){e.addCustomEvent(this.parentPopup,"onPopupClose",this.onParentPopupClose.bind(this))}},onControlClick:function(){var t=this,i,o=[];for(i=0;i<this.values.length;++i){o.push({text:this.values[i]["name"],valueId:this.values[i]["id"],onclick:function(e,i){this.popupWindow.close();t.setValue(i.valueId)}})}e.PopupMenu.show(this.id,this.controlNode,o,{autoHide:true,offsetLeft:40,angle:{position:"top"}});this.menuPopup=e.PopupMenu.currentItem},setValues:function(e){this.values=e;return this},getValueById:function(e){var t=null;for(var i=0;i<this.values.length;++i){if(this.values[i]["id"]===e){t=this.values[i];break}}return t},setValue:function(e,t){if(this.value!==e){var i=this.value;var o=this.getValueById(e);if(o!==null){if(t||this.fire("beforeChange",[e,i])){this.value=e;this.displayNode.textContent=o["shortName"]||o["name"];if(this.input){this.input.value=e}if(!t){this.fire("change",[e,i])}}}}return this},getValue:function(){return this.value},onParentPopupClose:function(){if(this.menuPopup){this.menuPopup.close();this.menuPopup.destroy();this.menuPopup=null}},show:function(){e.show(this.controlNode);return this},hide:function(){e.hide(this.controlNode);return this},fire:function(e,t){var i=true;if(this.listeners&&this.listeners[e]){if(this.listeners[e].apply(this,t)===false){i=false}}return i}};var a=function(t){this.isDirty=false;this.type=t.type;this.period=e.type.isPlainObject(t.period)?new i(t.period):t.period;this.target=t.target;this.users=e.type.isArray(t.users)?t.users:[]};a.prototype={dirty:function(){this.isDirty=true},getId:function(){return new i(this.period).getId()},setType:function(e){if(this.type!==e){this.type=e;this.clearGoal();this.dirty()}},setTargetType:function(e){if(this.target.type!==e){this.target.type=e;this.dirty()}},setGoal:function(t,i){if(typeof i==="undefined"&&e.type.isPlainObject(t)){this.target.goal=e.clone(t);this.dirty();return this}i=parseInt(i);if(isNaN(i)||i<0)i=0;if(this.target.goal[t]!==i){this.target.goal[t]=i;this.dirty()}return this},getGoal:function(e){var t=parseInt(this.target.goal[e]);return t>0?t:0},clearGoal:function(t){if(typeof t==="undefined"){this.target.goal={};this.dirty()}else if(e.type.isPlainObject(this.target.goal)){delete this.target.goal[t];this.dirty()}return this},addUser:function(e){this.users.push(e);if(this.type==="USER"){this.setGoal(e.id,0)}return this},removeUser:function(e){for(var t=0;t<this.users.length;++t){if(this.users[t]["id"]===e){if(this.type==="USER"){this.clearGoal(this.users[t]["id"])}this.users.splice(t,1);break}}},serialize:function(){return{type:this.type,period_type:this.period.type,period_year:this.period.year,period_half:this.period.half,period_quarter:this.period.quarter,period_month:this.period.month,target_type:this.target.type,target_goal:this.target.goal}}};var u=function(t,o,n){this.id="saletarget-config-popup-"+e.util.getRandomString(7);this.widget=t;if(o.configuration.id>0){this.initConfigurationPeriod=new i(o.configuration.period)}else{this.initConfigurationPeriod=new i({type:i.Type.Month,year:(new Date).getFullYear(),month:(new Date).getMonth()+1}).next()}this.configurations=[];this.users=[];this.categories=n.categories||[]};u.prototype={loadData:function(t){if(this.loading){return}if(this.loaded){if(t)t();return}this.loading=true;var i=this;e.ajax({url:this.ajaxUrl||"/bitrix/components/bitrix/crm.widget.custom.saletarget/ajax.php",method:"POST",dataType:"json",data:{sessid:e.bitrix_sessid(),site:e.message("SITE_ID"),action:"GET_CONFIGURATIONS"},onsuccess:function(e){i.loading=false;if(e.success){i.loaded=true;i.users=e.users;i.setConfigurations(e.configurations);i.setCurrentConfiguration(i.initConfigurationPeriod);if(t)t()}else{i.showAccessDeniedDialog(e)}},onfailure:function(){i.loading=false;window.alert(e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED"))}})},showAccessDeniedDialog:function(t){if(t.admins.length>0&&e.getClass("BX.Intranet.NotifyDialog")){var i=this.ajaxUrl||"/bitrix/components/bitrix/crm.widget.custom.saletarget/ajax.php";i=e.util.add_url_param(i,{action:"notify_admin",site:e.message("SITE_ID")});var o=new e.Intranet.NotifyDialog({listUserData:t.admins,notificationHandlerUrl:i,popupTexts:{title:e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED_TITLE"),header:e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED_HEADER"),description:e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED_DESCRIPTION"),sendButton:e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED_NOTIFY")}});o.show();return}window.alert(e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED"))},setConfigurations:function(e){for(var t=0;t<e.length;++t){this.configurations.push(new a(e[t]))}},setCurrentConfiguration:function(e){var t=this.findConfiguration(e);if(!t){var i=this.findPreviousConfiguration(e);t=new a({type:"USER",period:e,target:{type:o.Type.Sum,goal:{}},users:i&&i.users.length?i.users:[]});this.configurations.push(t)}this.configuration=t},findConfiguration:function(e){var t=e.getId();for(var i=0;i<this.configurations.length;++i){if(this.configurations[i].getId()===t){return this.configurations[i]}}return null},findPreviousConfiguration:function(e){var t=e.type,i=e.getLeftBorder(),o=0,n=null;for(var r=0;r<this.configurations.length;++r){if(this.configurations[r].period.type!==t)continue;var s=this.configurations[r].period.getLeftBorder();if(s>=i)continue;if(s>o){o=s;n=this.configurations[r]}}return n},show:function(){this.loadData(this.showPopup.bind(this))},showPopup:function(){var n=this;var r=new t("widget-saletarget-config");this.template=r;var a=function(){return this.saveConfigurations().then(function(e){if(e.success){n.widget.onAfterConfigSave()}else if(e.errors){window.alert(e.errors[0])}return e},function(e){if(e.errors){window.alert(e.errors[0])}return e})}.bind(this);var u=new e.PopupWindow("crm-start-config",null,{closeIcon:true,draggable:true,titleBar:e.message("CRM_WIDGET_SALETARGET_CONFIG_TITLE"),closeByEsc:true,content:r.get(),width:530,buttons:[new e.PopupWindowCustomButton({className:"webform-small-button webform-small-button-accept",text:e.message("JS_CORE_WINDOW_SAVE"),events:{click:function(){var t=this.popupWindow,i=this.buttonNode;e.addClass(i,"webform-small-button-wait");a().then(function(o){if(o.success){t.close()}e.removeClass(i,"webform-small-button-wait")},function(){e.removeClass(i,"webform-small-button-wait")})}}}),new e.PopupWindowButtonLink({className:"popup-window-button-link-cancel",text:e.message("JS_CORE_WINDOW_CANCEL"),events:{click:function(){this.popupWindow.close()}}})],events:{onPopupClose:function(e){e.destroy()}}});var l=true;this.periodTypeSelector=new s({controlNode:r.get("period-type"),displayNode:r.get("period-type"),parentPopup:u,values:i.getTypeList(),events:{beforeChange:function(t){if(l&&n.configuration.period.type!==t&&n.configurations.length>1){if(!window.confirm(e.message("CRM_WIDGET_SALETARGET_CONFIG_PERIOD_CHANGE_CONFIRMATION"))){return false}l=false}n.onPeriodTypeChange(t)},change:this.onAfterPeriodChange.bind(this)},value:this.configuration.period.type});this.periodYearSelector=new s({controlNode:r.get("period-year"),displayNode:r.get("period-year-value"),parentPopup:u,values:i.getYearList(),value:parseInt(this.configuration.period.year),events:{change:this.onAfterPeriodChange.bind(this)}});this.periodHalfSelector=new s({controlNode:r.get("period-half"),displayNode:r.get("period-half-value"),parentPopup:u,values:i.getHalfList(),value:parseInt(this.configuration.period.half)||1,events:{change:this.onAfterPeriodChange.bind(this)}});this.periodQuarterSelector=new s({controlNode:r.get("period-quarter"),displayNode:r.get("period-quarter-value"),parentPopup:u,values:i.getQuarterList(),value:parseInt(this.configuration.period.quarter)||1,events:{change:this.onAfterPeriodChange.bind(this)}});this.periodMonthSelector=new s({controlNode:r.get("period-month"),displayNode:r.get("period-month-value"),parentPopup:u,values:i.getMonthList(),value:parseInt(this.configuration.period.month)||1,events:{change:this.onAfterPeriodChange.bind(this)}});this.targetTypeSelector=new s({controlNode:r.get("target-type"),displayNode:r.get("target-type-value"),parentPopup:u,values:o.getTypeList(),value:this.configuration.target.type,events:{change:function(e){n.configuration.setTargetType(e)}}});this.viewTypeSelector=new s({controlNode:r.get("view-type"),displayNode:r.get("view-type-value"),parentPopup:u,values:[{id:"USER",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_VIEW_TYPE_USER")},{id:"CATEGORY",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_VIEW_TYPE_CATEGORY")},{id:"COMPANY",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_VIEW_TYPE_COMPANY")}],events:{change:function(e){n.configuration.setType(e);n.refreshConfigurationView()}}});this.onPeriodTypeChange(this.configuration.period.type);this.viewTypeSelector.setValue(this.configuration.type);var h=r.get("copy-configuration");e.bind(h,"click",this.onCopyConfiguration.bind(this));this.configPopup=u;this.configTemplate=r;u.show();return true},onPeriodTypeChange:function(e){switch(e){case i.Type.Year:this.periodHalfSelector.hide();this.periodQuarterSelector.hide();this.periodMonthSelector.hide();break;case i.Type.Half:this.periodHalfSelector.show();this.periodQuarterSelector.hide();this.periodMonthSelector.hide();break;case i.Type.Quarter:this.periodHalfSelector.hide();this.periodQuarterSelector.show();this.periodMonthSelector.hide();break;case i.Type.Month:this.periodHalfSelector.hide();this.periodQuarterSelector.hide();this.periodMonthSelector.show();break}},refreshConfigViewType:function(t){var i=this.template.get("view-type-content");i.innerHTML="";var o;if(t==="COMPANY"){o=this.getConfigCompanyTemplate()}else if(t==="CATEGORY"){o=this.getConfigCategoryTemplate()}else if(t==="USER"){o=this.getConfigUserTemplate()}i.appendChild(o.get());e[t==="CATEGORY"?"show":"hide"](this.template.get("categories-link"))},onAfterPeriodChange:function(){var e=new i({type:this.periodTypeSelector.getValue(),year:this.periodYearSelector.getValue(),half:this.periodHalfSelector.getValue(),quarter:this.periodQuarterSelector.getValue(),month:this.periodMonthSelector.getValue()});this.setCurrentConfiguration(e);this.refreshConfigurationView();var t=this.template.get("copy-configuration");t.textContent=" ";var o=this.findPreviousConfiguration(e);if(o){t.textContent=n.copyPeriod(e.type)}},refreshConfigurationView:function(){this.targetTypeSelector.setValue(this.configuration.target.type);this.viewTypeSelector.setValue(this.configuration.type,true);this.refreshConfigViewType(this.configuration.type)},onCopyConfiguration:function(){var e=this.findPreviousConfiguration(this.configuration.period);if(e){this.configuration.setType(e.type);this.configuration.setTargetType(e.target.type);this.configuration.setGoal(e.target.goal);if(e.type==="USER"){this.configuration.users=e.users}this.refreshConfigurationView()}},getConfigCompanyTemplate:function(){var e=new t("widget-saletarget-config-company");var i=this.configuration.getGoal("COMPANY");this.decorateGoalInput(e.get("company-target"),"COMPANY",i);return e},getConfigCategoryTemplate:function(){var e=this,i=new t("widget-saletarget-config-category");i.loop("categories",this.categories,function(t,i){t.get("category-name").textContent=i.name;var o=e.configuration.getGoal(i.id);e.decorateGoalInput(t.get("category-target"),i.id,o)});return i},getConfigUserTemplate:function(){var i=this,o=new t("widget-saletarget-config-user");var n=this.configuration.users;if(!n.length&&this.users.length>0){n=this.users}o.loop("users",n,function(t,o,n){var r=i.configuration.getGoal(o.id);t.get("user-name").textContent=o.name;t.get("user-title").textContent=o.title;if(o.photo){t.get("user-photo").style.background="url("+o.photo+")"}i.decorateGoalInput(t.get("user-target"),o.id,r);e.bind(t.get("user-remove"),"click",function(){i.configuration.removeUser(o.id);e.addClass(t.get(),t.get().getAttribute("data-remove-class"));setTimeout(function(){e.remove(t.get())},250)});if(n){var s=t.get();e.addClass(s,s.getAttribute("data-new-class"))}});new r({bindTo:o.get("user-add"),selected:n,addCallback:function(e){for(var t=0;t<n.length;++t){if(parseInt(n[t]["id"])===e["id"]){return}}i.configuration.addUser(e);o.loopAppend("users",e)},parentPopup:this.configPopup});return o},decorateGoalInput:function(t,i,o){t.setAttribute("name","target_goal["+i+"]");t.value=o>0?n.number(o):"";e.bind(t,"bxchange",this.onGoalInputChange.bind(this,t,i))},onGoalInputChange:function(e,t){var i=parseInt(e.value.replace(/[^0-9]+/g,""));if(isNaN(i)||i<0)i=0;e.value=i>0?n.number(i):"";this.configuration.setGoal(t,i)},saveConfigurations:function(){var t=[];for(var i=0;i<this.configurations.length;++i){if(this.configurations[i].isDirty){t.push(this.configurations[i].serialize())}}var o=new e.Promise;if(!t.length){o.fulfill({success:true});return o}e.ajax({url:this.ajaxUrl||"/bitrix/components/bitrix/crm.widget.custom.saletarget/ajax.php",method:"POST",dataType:"json",data:{sessid:e.bitrix_sessid(),site:e.message("SITE_ID"),action:"save_configurations",configurations:t,period_type:this.periodTypeSelector.getValue()},onsuccess:function(e){o.fulfill(e)},onfailure:function(){o.fulfill({success:false,errors:[e.message("CRM_WIDGET_SALETARGET_CONFIG_SAVE_ERROR")]})}});return o}};return u}(window.BX||window.top.BX);
/* End */
;; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/script.min.js?154412738440309*/
; /* /bitrix/components/bitrix/main.interface.buttons/templates/.default/utils.min.js?1544127384575*/
; /* /bitrix/components/bitrix/crm.entity.counter.panel/templates/.default/script.min.js?15441274015274*/
; /* /bitrix/components/bitrix/crm.widget_panel/templates/.default/script.min.js?1544127401182724*/
; /* /bitrix/components/bitrix/crm.interface.toolbar/templates/title/script.min.js?15441274012568*/
; /* /bitrix/components/bitrix/crm.interface.filter/templates/title/script.min.js?15441274012949*/
; /* /bitrix/components/bitrix/main.ui.selector/templates/.default/script.min.js?154412738410379*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/script.min.js?154412738446925*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/js/api.min.js?15441273841650*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/js/destination-selector.min.js?15441273845460*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/js/field-controller.min.js?15441273842703*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/js/fields.min.js?154412738423035*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/js/main-ui-control-custom-entity.min.js?15441273843115*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/js/presets.min.js?154412738417210*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/js/search.min.js?154412738418784*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/js/settings.min.js?15441273844327*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/js/utils.min.js?15441273842208*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/date-group.min.js?15441273841411*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-field-group.min.js?15441273841102*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-field.min.js?15441273841258*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-control-string.min.js?1544127384422*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-filter-field-list-item.min.js?1544127384490*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-filter-info.min.js?1544127384250*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-number.min.js?1544127384754*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/main-ui-search-square.min.js?1544127384513*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/number-group.min.js?15441273841390*/
; /* /bitrix/components/bitrix/main.ui.filter/templates/.default/blocks/sidebar-item.min.js?15441273841364*/
; /* /bitrix/components/bitrix/crm.widget.custom.saletarget/templates/.default/script.min.js?154412740115387*/
; /* /bitrix/components/bitrix/crm.widget.custom.saletarget/templates/.default/user_selector.min.js?15441274011899*/
; /* /bitrix/components/bitrix/crm.widget.custom.saletarget/templates/.default/config_popup.min.js?154412740114163*/

//# sourceMappingURL=page_9eaa0ba5695754771b49726931998f9a.map.js