
; /* Start:"a:4:{s:4:"full";s:93:"/bitrix/components/bitrix/crm.activity.email/templates/.default/script.min.js?154412740016406";s:6:"source";s:73:"/bitrix/components/bitrix/crm.activity.email/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(){if(window.BXCrmActivityEmailController)return;var t={};t.init=function(t){if(this.__inited)return;this.options=t;if(!BX.type.isPlainObject(this.options.templates))this.options.templates={};this.__dummyNode=document.createElement("DIV");this.templates={0:{FROM:"",SUBJECT:"",BODY:""}};if("edit"!=this.options.type){if(this.options.pageSize<1||this.options.pageSize>100)this.options.pageSize=5;this.__log={a:0,b:0};var i=BX("crm-activity-email-details-"+this.options.activityId);var e=BX.findChildByClassName(i.parentNode,"crm-task-list-mail-more-a",true);BX.bind(e,"click",this.handleLogClick.bind(this,"a"));var o=BX.findChildByClassName(i.parentNode,"crm-task-list-mail-more-b",true);BX.bind(o,"click",this.handleLogClick.bind(this,"b"));var a=BX.findChildrenByClassName(i.parentNode,"crm-task-list-mail-item",true);for(var l in a){var s=a[l].getAttribute("data-log").toLowerCase();if(typeof this.__log[s]!="undefined")this.__log[s]++;BX.bind(a[l],"click",this.handleLogItemClick.bind(this,a[l].getAttribute("data-id")))}}this.__inited=true};t.initScrollable=function(){if(!this.__scrollable){if(document.scrollingElement)this.__scrollable=document.scrollingElement}if(!this.__scrollable){if(document.documentElement.scrollTop>0||document.documentElement.scrollLeft>0)this.__scrollable=document.documentElement;else if(document.body.scrollTop>0||document.body.scrollLeft>0)this.__scrollable=document.body}if(!this.__scrollable){window.scrollBy(1,1);if(document.documentElement.scrollTop>0||document.documentElement.scrollLeft>0)this.__scrollable=document.documentElement;else if(document.body.scrollTop>0||document.body.scrollLeft>0)this.__scrollable=document.body;window.scrollBy(-1,-1)}return this.__scrollable};t.scrollWrapper=function(t){var i=this;if(!this.initScrollable())return;if(this.__scrollable.__animation){clearInterval(this.__scrollable.__animation);this.__scrollable.__animation=null}var e=this.__scrollable.scrollTop;var o=t-e;var a=0;this.__scrollable.__animation=setInterval(function(){a++;i.__scrollable.scrollTop=e+o*a/8;if(a>=8){clearInterval(i.__scrollable.__animation);i.__scrollable.__animation=null}},20)};t.scrollTo=function(t,i){if(!this.initScrollable())return;var e=BX.pos(this.__scrollable);e.top+=this.__scrollable.scrollTop;e.bottom+=this.__scrollable.scrollTop;var o=BX.pos(t);var a=typeof i=="undefined"||i===t?o:BX.pos(i);if(o.top<e.top){this.scrollWrapper(this.__scrollable.scrollTop-(e.top-o.top))}else if(a.bottom>e.bottom){this.scrollWrapper(Math.min(this.__scrollable.scrollTop-(e.top-o.top),this.__scrollable.scrollTop+(a.bottom-e.bottom)))}};t.handleLogClick=function(t,i){BX.PreventDefault(i);var e=BX.findChildByClassName(BX("crm-activity-email-details-"+this.options.activityId).parentNode,"crm-task-list-mail-more-"+t,true);this.loadLog(t,e)};t.loadLog=function(t,i){var e=this;var o=i.parentNode;if(this["__loadingLog"+t])return;this["__loadingLog"+t]=true;BX.ajax({method:"POST",url:this.options.ajaxUrl,data:{act:"log",id:this.options.activityId,log:t+this.__log[t],size:this.options.pageSize,template:"slider"},dataType:"json",onsuccess:function(i){e["__loadingLog"+t]=false;if(i.result!="error"){e.__dummyNode.innerHTML=i.html;var a=t=="a"?BX.findNextSibling(o,{tag:"div"}):o;while(e.__dummyNode.childNodes.length>0){var l=o.parentNode.insertBefore(e.__dummyNode.childNodes[0],a);if(l.nodeType==1&&BX.hasClass(l,"crm-task-list-mail-item")){e.__log[t]++;BX.addClass(l,"crm-activity-email-show-animation-rev");BX.bind(l,"click",e.handleLogItemClick.bind(e,l.getAttribute("data-id")))}}if(i.count<e.options.pageSize)o.style.display="none";if(t=="b")e.scrollWrapper(e.__scrollable.scrollHeight);e.__dummyNode.innerHTML=""}},onfailure:function(){e["__loadingLog"+t]=false}})};t.handleLogItemClick=function(t,i){i=i||window.event;if(i.target&&i.target.tagName&&i.target.tagName.toUpperCase()=="A")return;if(window.getSelection){if(window.getSelection().toString().trim()!="")return}else if(document.selection){if(document.selection.createRange().htmlText.trim()!="")return}BX.PreventDefault(i);this.toggleLogItem(t)};t.toggleLogItem=function(t){var i=this;var e=BX("crm-activity-email-details-"+this.options.activityId).parentNode;var o=BX.findChildByClassName(e,"crm-activity-email-logitem-"+t,false);var a=BX.findChildByClassName(e,"crm-activity-email-details-"+t,false);var l=BX.hasClass(o,"crm-task-list-mail-item-open");BX.toggleClass(o,"crm-task-list-mail-item-open");if(l){a.style.display="none";BX.addClass(o,"crm-activity-email-show-animation-rev");o.style.display=""}else{BX.removeClass(a,"crm-activity-email-show-animation-rev");BX.addClass(a,"crm-activity-email-show-animation");a.style.display="";if(a.getAttribute("data-empty")){BX.ajax({method:"POST",url:this.options.ajaxUrl,data:{act:"logitem",id:t,template:"slider"},dataType:"json",onsuccess:function(e){if(e.result=="error"){a.innerHTML=e.error;return}var l=BX.processHTML(e.html);BX.removeClass(a,"crm-activity-email-show-animation");BX.removeClass(a,"crm-activity-email-show-animation-rev");setTimeout(function(){a.style.textAlign="";a.innerHTML=l.HTML;if(a.offsetHeight>0)o.style.display="none";BX.ajax.processScripts(l.SCRIPT);BX.addClass(a,"crm-activity-email-show-animation-rev");var e=BX.findChildByClassName(a,"crm-task-list-mail-item-inner-header",true);BX.bind(e,"click",i.handleLogItemClick.bind(i,t));i.scrollTo(a)},10);a.removeAttribute("data-empty")}});this.scrollTo(o,a)}else{o.style.display="none";this.scrollTo(a)}}};t.removeLogItem=function(t){var i=BX("crm-activity-email-details-"+this.options.activityId).parentNode;var e=BX.findChildByClassName(i,"crm-activity-email-logitem-"+t,false);var o=BX.findChildByClassName(i,"crm-activity-email-details-"+t,false);var a=e.getAttribute("data-log").toLowerCase();if(typeof this.__log[a]!="undefined")this.__log[a]--;setTimeout(function(){i.removeChild(o);i.removeChild(e)},200);o.style.maxHeight=o.offsetHeight*1.5+"px";o.style.transition="max-height .2s ease-in";o.offsetHeight;o.style.maxHeight="0px";BX.removeClass(o,"crm-activity-email-show-animation");BX.removeClass(o,"crm-activity-email-show-animation-rev");BX.addClass(o,"crm-activity-email-close-animation")};t.applyTemplate=function(t,i,e,o){var a=this;var l=t>0?[t,i,e].join(":"):t;if(this.templates[l]){o(this.templates[l]);return}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?action=prepare_mail_template&templateid="+t,method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),ACTION:"PREPARE_MAIL_TEMPLATE",TEMPLATE_ID:t,OWNER_TYPE:i,OWNER_ID:e,CONTENT_TYPE:"HTML"},onsuccess:function(t){if(t.DATA){a.templates[l]=t.DATA;o(t.DATA)}}})};var i=function(e){var o=this;this.ctrl=t;this.options=e;for(var a in this.options.templates){if(!this.options.templates.hasOwnProperty(a))continue;if(!(this.ctrl.options.templates[a]&&this.ctrl.options.templates[a].length>0))this.ctrl.options.templates[a]=this.options.templates[a]}this.__dummyNode=document.createElement("DIV");this.htmlForm=BX(this.options.formId);this.htmlForm.__wrapper=this.htmlForm.parentNode;if(this.htmlForm.__inited)return;if("edit"!=this.ctrl.options.type){this.__wrapper=BX("crm-activity-email-details-"+this.ctrl.options.activityId);if(this.options.activityId!=this.ctrl.options.activityId)this.__wrapper=BX.findChildByClassName(this.__wrapper.parentNode,"crm-activity-email-details-"+this.options.activityId,false);BX.addCustomEvent("CrmActivityEmail:replyButtonClick",function(t){if(t!==o)o.hideReplyForm()});var l="activity_"+this.options.activityId+"_body";var s=typeof document.querySelectorAll!="undefined"?document.querySelectorAll("#"+l+" a"):BX.findChildren(BX(l),{tag:"a"},true);for(var r in s){if(!s.hasOwnProperty(r))continue;if(s[r]&&s[r].setAttribute)s[r].setAttribute("target","_blank")}var n=typeof document.querySelectorAll!="undefined"?document.querySelectorAll("#"+l+" blockquote"):BX.findChildren(BX(l),{tag:"blockquote"},true);for(var r in n){if(!n.hasOwnProperty(r))continue;BX.bind(n[r],"click",function(){BX.addClass(this,"crm-email-quote-unfolded")})}(top.BX.viewElementBind||BX.viewElementBind)(BX("activity_"+this.options.activityId+"_files_images_list"),{});var c=BX.findChildrenByClassName(this.__wrapper,"crm-task-list-mail-item-to-list-more");for(var r in c){BX.bind(c[r],"click",function(t){BX.findChildByClassName(this.parentNode,"crm-task-list-mail-item-to-list-hidden",false).style.display="inline";this.style.display="none";BX.PreventDefault(t)})}BX.addCustomEvent("onPullEvent-crm",function(t,i){if(t!="activity_email_read_confirmed")return;if(i.ID!=o.options.activityId)return;var e=BX.findChildrenByClassName(o.__wrapper,"read-confirmed-datetime",true);if(e&&e.length>0){for(var a in e)BX.adjust(e[a],{text:BX.message("CRM_ACT_EMAIL_VIEW_READ_CONFIRMED_SHORT")})}});var m=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);var d=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-reply",true);var h=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-answertoall",true);var p=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-resend",true);var u=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-skip",true);var _=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-spam",true);var f=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-delete",true);BX.bind(m,"click",this.showReplyForm.bind(this));BX.bind(h,"click",this.showReplyForm.bind(this));BX.bind(d,"click",this.showReplyForm.bind(this,true));BX.bind(p,"click",function(){var t=BX.CrmActivityType?BX.CrmActivityType.email:top.BX.CrmActivityType.email;window.location.href="/bitrix/components/bitrix/crm.activity.planner/slider.php"+"?site_id="+BX.message("SITE_ID")+"&ajax_action=ACTIVITY_EDIT"+"&TYPE_ID="+t+"&FROM_ACTIVITY_ID="+o.options.activityId+"&MESSAGE_TYPE=FWD&IFRAME=Y&IFRAME_TYPE=SIDE_SLIDER"});BX.bind(u,"click",this.delete.bind(this,"skip"));BX.bind(_,"click",this.delete.bind(this,"spam"));BX.bind(f,"click",this.delete.bind(this))}var v=BXMainMailForm.getForm(this.options.formId);BX.addCustomEvent(v,"MailForm:field:rcptSelectorClose",i.handleRcptSelectorClose.bind(this));BX.addCustomEvent(v,"MailForm:footer:buttonClick",i.handleFooterButtonClick.bind(this));BX.addCustomEvent(v,"MailForm:submit",i.handleFormSubmit.bind(this));BX.addCustomEvent(v,"MailForm:submit:ajaxSuccess",i.handleFormSubmitSuccess.bind(this));this.htmlForm.__inited=true};i.handleRcptSelectorClose=function(t,i){if(!i.params.name.match(/^DATA\[(to|cc|bcc)\]$/))return;for(var e=0,o;e<t.fields.length;e++){o=t.fields[e];if(o.selector==i.selector||!o.params.name.match(/^DATA\[(to|cc|bcc)\]$/))continue;BX.SocNetLogDestination.obItems[o.selector]=BX.SocNetLogDestination.obItems[i.selector];BX.SocNetLogDestination.obItemsLast[o.selector]=BX.SocNetLogDestination.obItemsLast[i.selector]}};i.handleFooterButtonClick=function(t,i){if(BX.hasClass(i,"main-mail-form-cancel-button")){if("edit"==this.ctrl.options.type){top.BX.SidePanel.Instance.getSliderByWindow(window).close()}else{this.hideReplyForm()}}};i.handleFormSubmit=function(t,i){var e=this.htmlForm.elements;var o=true;for(var a=0;a<e.length;a++){if("DATA[to][]"==e[a].name&&e[a].value.length>0)o=false}if(o){t.showError(BX.message("CRM_ACT_EMAIL_REPLY_EMPTY_RCPT"));return BX.PreventDefault(i)}var l;for(var a in t.postForm.controllers){if(!t.postForm.controllers.hasOwnProperty(a))continue;if(t.postForm.controllers[a].storage!="disk")continue;try{l=0;l=t.postForm.controllers[a].handler.agent.upload.filesCount}catch(t){}if(l>0){t.showError(BX.message("CRM_ACT_EMAIL_REPLY_UPLOADING"));return BX.PreventDefault(i)}}if("edit"==this.ctrl.options.type){var s=BX("crm_act_email_create_hidden");s.innerHTML="";var e=BX.findChildren(document,{tag:"input"},true);for(var a=0,r;a<e.length;a++){if(e[a].name&&e[a].name.indexOf("__crm_activity_planner[")>=0){r=e[a].cloneNode(true);r.removeAttribute("id");r.setAttribute("name","DATA"+e[a].name.substr("__crm_activity_planner".length));s.appendChild(r)}}}};i.handleFormSubmitSuccess=function(t,i){if(i.ERROR&&i.ERROR.length>0){var e=document.createElement("DIV");if(!BX.type.isArray(i.ERROR))i.ERROR=[i.ERROR];for(var o=0;o<i.ERROR.length;o++){e.appendChild(document.createTextNode(i.ERROR[o]));e.appendChild(document.createElement("BR"))}t.showError(e.innerHTML)}else{top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_CREATE",source_id:this.ctrl.options.activityId,target_id:i.ACTIVITY.ID}]);if("edit"!=this.ctrl.options.type){this.hideReplyForm()}var a=top.BX.SidePanel.Instance.getSliderByWindow(window);a.setCacheable(false);a.close()}};i.prototype.showReplyForm=function(t){var i=BXMainMailForm.getForm(this.options.formId);var e=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);if(this.htmlForm.parentNode===this.__dummyNode)this.htmlForm.__wrapper.appendChild(this.htmlForm);i.init();if(t===true){i.getField("DATA[to]").setValue(this.options.rcptSelected);i.getField("DATA[cc]").setValue()}else{i.getField("DATA[to]").setValue(this.options.rcptAllSelected);i.getField("DATA[cc]").setValue(this.options.rcptCcSelected)}i.getField("DATA[bcc]").setValue();BX.onCustomEvent("CrmActivityEmail:replyButtonClick",[this]);BX.addClass(this.htmlForm,"crm-activity-email-show-animation");this.htmlForm.style.display="";e.style.display="none";BX.onCustomEvent(i,"MailForm:show",[]);this.ctrl.scrollTo(this.htmlForm)};i.prototype.hideReplyForm=function(){var t=BXMainMailForm.getForm(this.options.formId);var i=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);BX.addClass(i,"crm-activity-email-show-animation-rev");i.style.display="";this.htmlForm.style.display="none";BX.onCustomEvent(t,"MailForm:hide",[]);this.__dummyNode.appendChild(this.htmlForm)};i.prototype.delete=function(t){var i=this;var e="CRM_ACT_EMAIL_DELETE_CONFIRM";switch(t){case"skip":e="CRM_ACT_EMAIL_SKIP_CONFIRM";break;case"spam":e="CRM_ACT_EMAIL_SPAM_CONFIRM";break}if(!window.confirm(BX.message(e)))return false;var o=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-delete",true);var a={sessid:BX.bitrix_sessid(),ACTION:"DELETE",IS_SKIP:"skip"==t?"Y":"N",IS_SPAM:"spam"==t?"Y":"N",ITEM_ID:this.options.activityId};var l=BX.findChildren(o.parentNode,{tag:"input"},true);for(var s=0;s<l.length;s++){if(l[s].name)a[l[s].name]=l[s].value}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?id="+this.options.activityId+"&action=delete",method:"POST",dataType:"json",data:a,onsuccess:function(t){top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_DELETE",source_id:i.ctrl.options.activityId,target_id:i.options.activityId}]);if(i.ctrl.options.activityId!=i.options.activityId){i.ctrl.removeLogItem(i.options.activityId)}else{var e=top.BX.SidePanel.Instance.getSliderByWindow(window);e.setCacheable(false);e.close()}}})};i.prototype.batch=function(t){var i=BXMainMailForm.getForm(this.options.formId);i.getField("DATA[cc]")[t?"hide":"show"]();i.getField("DATA[bcc]")[t?"hide":"show"]()};i.prototype.templateMenu=function(t,i,e){var o=this;var a=function(a,l){var s=BXMainMailForm.getForm(o.options.formId);o.ctrl.applyTemplate(l.__id,t,i,function(t){if(t.FROM&&t.FROM.length>0){var i=s.getField("DATA[from]");i.setValue(t.FROM);if(i.params.folded)i.unfold()}if(t.SUBJECT&&t.SUBJECT.length>0){var e=o.htmlForm.elements;var a=e["DATA[FORWARDED_ID]"]?e["DATA[FORWARDED_ID]"].value:0;var l=e["DATA[REPLIED_ID]"]?e["DATA[REPLIED_ID]"].value:0;if(!(a>0||l>0)){var r=s.getField("DATA[subject]");r.setValue(t.SUBJECT);if(r.params.folded)r.unfold()}}if(t.FILES&&t.FILES.length>0)s.getField("DATA[__diskfiles]").setValue(t.FILES);s.getField("DATA[message]").setValue(t.BODY,{quote:true,signature:true})});BX.adjust(e,{html:l.text});l.menuWindow.close()};var l=[];if(t!="")l=l.concat(this.ctrl.options.templates[t]||[]);l=l.concat(this.ctrl.options.templates[""]||[]);if(!(l.length>0))return;var s=[{__id:"0",text:BX.message("CRM_ACT_EMAIL_CREATE_NOTEMPLATE"),onclick:a},{delimiter:true}];for(var r in l){s.push({__id:l[r].id,text:BX.util.htmlspecialchars(l[r].title),onclick:a})}BX.PopupMenu.show("crm-activity-email-"+this.options.activityId+"-template-menu",e,s,{offsetLeft:40,angle:true,closeByEsc:true})};window.BXCrmActivityEmailController=t;window.BXCrmActivityEmail=i})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.mail.form/templates/.default/script.min.js?154412738422660";s:6:"source";s:69:"/bitrix/components/bitrix/main.mail.form/templates/.default/script.js";s:3:"min";s:73:"/bitrix/components/bitrix/main.mail.form/templates/.default/script.min.js";s:3:"map";s:73:"/bitrix/components/bitrix/main.mail.form/templates/.default/script.map.js";}"*/
(function(){if(window.BXMainMailForm)return;var e=function(t,i,a){if(e.__forms[t])return e.__forms[t];this.id=t;this.fields=i;this.options=a;e.__forms[this.id]=this};e.quoteNodeId="main-mail-quote-node-content";e.signatureNodeId="main-mail-form-signature";e.__forms={};e.getForm=function(t){return e.__forms[t]};e.prototype.getField=function(e){for(var t=this.fields.length;t-- >0;){if(this.fields[t].params.name==e)return this.fields[t]}return false};e.prototype.onSubmit=function(e){var t=this;var i=BX.findChildByClassName(this.formWrapper,"main-mail-form-footer",false);var a=BX.findChildByClassName(i,"main-mail-form-submit-button",true);if(a.disabled)return BX.PreventDefault();this.editor.OnSubmit();e=e||window.event;BX.onCustomEvent(this,"MailForm:submit",[this,e]);if(!e.defaultPrevented&&e.returnValue!==false){this.hideError();BX.addClass(a,"ui-btn-wait");a.disabled=true;a.offsetHeight;if(this.options.submitAjax){BX.ajax.submitAjax(this.htmlForm,{url:this.htmlForm.getAttribute("action"),method:"POST",dataType:"json",onsuccess:function(e){a.disabled=false;BX.removeClass(a,"ui-btn-wait");BX.onCustomEvent(t,"MailForm:submit:ajaxSuccess",[t,e])},onfailure:function(e){a.disabled=false;BX.removeClass(a,"ui-btn-wait");BX.onCustomEvent(t,"MailForm:submit:ajaxFailure",[t,e])}});return BX.PreventDefault(e)}}};e.prototype.showError=function(e){var t=BX.findChildByClassName(this.formWrapper,"main-mail-form-error",true);BX.adjust(t,{html:e,style:{display:"block"}});this.initScrollable();if(this.__scrollable){var i=BX.pos(this.__scrollable);var a=BX.pos(this.formWrapper);var o=BX.pos(t);if(i.top>o.top-10-this.__scrollable.scrollTop)this.__scrollable.scrollTop=o.top-10;else if(i.bottom<a.bottom-10-this.__scrollable.scrollTop)this.__scrollable.scrollTop=a.bottom-10-i.bottom}};e.prototype.hideError=function(){var e=BX.findChildByClassName(this.formWrapper,"main-mail-form-error",true);BX.adjust(e,{style:{display:"none"}})};e.prototype.init=function(){var t=this;if(this.__inited)return;this.formId="main_mail_form_"+this.id;this.formWrapper=BX(this.formId);this.htmlForm=BX.findParent(this.formWrapper,{tag:"form"});this.postForm=LHEPostForm.getHandler(this.formId+"_editor");this.editor=BXHtmlEditor.Get(this.formId+"_editor");this.editorInited=false;BX.addCustomEvent(this,"MailForm::from::change",BX.proxy(function(e,t){if(!BX.type.isString(t)){t="";var i;var a=BX(e.fieldId+"_value");if(a){i=a.value}if(i&&e.params&&BX.type.isArray(e.params.mailboxes)&&BX.type.isNotEmptyObject(e.params.signatures)){for(var o in e.params.mailboxes){if(e.params.mailboxes.hasOwnProperty(o)){if(e.params.mailboxes[o].formated===i){if(BX.type.isNotEmptyString(e.params.signatures[e.params.mailboxes[o].formated])){t=e.params.signatures[e.params.mailboxes[o].formated]}else if(BX.type.isNotEmptyString(e.params.signatures[e.params.mailboxes[o].email])){t=e.params.signatures[e.params.mailboxes[o].email]}else if(BX.type.isNotEmptyString(e.params.signatures[""])){t=e.params.signatures[""]}break}}}}}this.insertSignature(t)},this));this.initFields();this.initFooter();BX.bind(this.htmlForm,"submit",this.onSubmit.bind(this));this.__inited=true;BX.onCustomEvent(e,"MailForm:init:"+this.id,[this])};e.prototype.initScrollable=function(){if(!this.__scrollable){if(document.scrollingElement)this.__scrollable=document.scrollingElement}if(!this.__scrollable){if(document.documentElement.scrollTop>0||document.documentElement.scrollLeft>0)this.__scrollable=document.documentElement;else if(document.body.scrollTop>0||document.body.scrollLeft>0)this.__scrollable=document.body}if(!this.__scrollable){window.scrollBy(1,1);if(document.documentElement.scrollTop>0||document.documentElement.scrollLeft>0)this.__scrollable=document.documentElement;else if(document.body.scrollTop>0||document.body.scrollLeft>0)this.__scrollable=document.body;window.scrollBy(-1,-1)}};e.prototype.initFields=function(){for(var e=0,i;e<this.fields.length;e++){this.fields[e]=new t(this,this.fields[e]);i=this.fields[e].fieldId;this.fields[i]=this.fields[e]}var a=BX(this.formId+"_fields_footer");var o=BX(this.formId+"_fields_ext_footer");var r=[].concat(BX.findChildrenByClassName(a,"main-mail-form-field-button",true)||[]).concat(BX.findChildrenByClassName(o,"main-mail-form-field-button",true)||[]);for(var e=0,i;e<r.length;e++){i=r[e].getAttribute("data-target");if(typeof this.fields[i]!="undefined"){this.fields[i].__switch=r[e];BX.bind(r[e],"click",this.fields[i].unfold.bind(this.fields[i]))}}};e.prototype.initFooter=function(){var e=this;var t=BX.findChildByClassName(this.formWrapper,"main-mail-form-footer-wrapper",true);var i=BX.findChildByClassName(t,"main-mail-form-footer",false);var a=BX.findChildrenByClassName(i,"main-mail-form-footer-button",true);for(var o in a){(function(t){BX.bind(t,"click",function(){BX.onCustomEvent(e,"MailForm:footer:buttonClick",[e,t]);if(BX.hasClass(t,"main-mail-form-submit-button"))BX.submit(e.htmlForm)})})(a[o])}var r=function(){if(BX.hasClass(i,"main-mail-form-footer-fixed")){BX.removeClass(i,"main-mail-form-footer-fixed-hidden");BX.removeClass(i,"main-mail-form-footer-fixed");i.style.left="";i.style.width="";t.style.height=""}};var n=function(){e.initScrollable();if(e.formWrapper.offsetHeight>0&&e.__scrollable){var a=BX.pos(e.__scrollable);var o=BX.pos(e.formWrapper);if(a.bottom<o.bottom-10-e.__scrollable.scrollTop){i.style.left=o.left-a.left-e.__scrollable.scrollLeft+"px";i.style.width=e.formWrapper.offsetWidth+"px";if(!BX.hasClass(i,"main-mail-form-footer-fixed")){if(a.bottom<BX.pos(t).top-e.__scrollable.scrollTop)BX.addClass(i,"main-mail-form-footer-fixed-hidden");t.style.height=t.offsetHeight+"px";BX.addClass(i,"main-mail-form-footer-fixed")}var n=BX.findChildByClassName(e.formWrapper,"main-mail-form-editor-wrapper",true);if(a.bottom<BX.pos(n).top+i.offsetHeight-e.__scrollable.scrollTop)BX.addClass(i,"main-mail-form-footer-fixed-hidden");else BX.removeClass(i,"main-mail-form-footer-fixed-hidden");return}}r()};var s=function(){setTimeout(function(){if(!e.__footerMonitoring){e.__footerMonitoring=true;BX.bind(window,"resize",n);BX.bind(window,"scroll",n);BX.addCustomEvent(window,"AutoResizeFinished",n);n()}},400)};var l=function(){e.__footerMonitoring=false;BX.unbind(window,"resize",n);BX.unbind(window,"scroll",n);BX.removeCustomEvent(window,"AutoResizeFinished",n);r()};BX.addCustomEvent(this,"MailForm:show",s);BX.addCustomEvent(this,"MailForm:hide",l);if(this.formWrapper.offsetHeight>0)s()};e.prototype.insertSignature=function(t){if(this.editorInited){this.editor.synchro.Sync();var i=this.editor.GetIframeDoc().getElementById(e.signatureNodeId);if(!BX.type.isNotEmptyString(t)){if(i){BX.remove(i)}return}var a="<br />--<br />"+t;if(i){i.innerHTML=a}else{i=BX.create("div",{attrs:{id:e.signatureNodeId},html:a});var o=this.editor.GetIframeDoc().getElementById(e.quoteNodeId);if(o){o.parentNode.insertBefore(i,o)}else{BX.append(i,this.editor.GetIframeDoc().body)}}this.editor.synchro.FullSyncFromIframe()}else{BX.addCustomEvent(this,"MailForm::editor::init",BX.proxy(function(){this.insertSignature(t)},this))}};var t=function(e,t){this.form=e;this.params=t;this.fieldId=this.form.formId+"_"+this.params.id;this.init()};t.prototype.init=function(){this.params.__row=BX(this.fieldId);if(t.__types[this.params.type]&&t.__types[this.params.type].init)t.__types[this.params.type].init(this);if(this.params.menu){var e=this;var i=BX.findChildByClassName(this.params.__row,"main-mail-form-field-value-menu-ext-button",true);BX.addCustomEvent(this.form,"MailForm::editor:click",function(){var t=BX.PopupMenu.getMenuById(e.fieldId+"-menu-ext");if(t)t.close()});BX.addCustomEvent("onSubMenuShow",function(){var t=this.menuWindow;while(t.parentMenuWindow)t=t.parentMenuWindow;if(e.fieldId+"-menu-ext"==t.id)BX.addClass(this.subMenuWindow.popupWindow.popupContainer,"main-mail-form-field-value-menu-ext-content")});BX.bind(i,"click",function(){BX.onCustomEvent(e.form,"MailForm:field:setMenuExt",[e.form,e]);BX.PopupMenu.destroy(e.fieldId+"-menu-ext");BX.PopupMenu.show(e.fieldId+"-menu-ext",this,e.__menuExt,{className:"main-mail-form-field-value-menu-ext-content",offsetTop:-8,offsetLeft:13,angle:true,closeByEsc:true})})}};t.prototype.setMenuExt=function(e){this.__menuExt=e};t.prototype.insert=function(e){if(t.__types[this.params.type]&&t.__types[this.params.type].insert)t.__types[this.params.type].insert(this,e)};t.prototype.setValue=function(e,i){if(t.__types[this.params.type]&&t.__types[this.params.type].setValue)t.__types[this.params.type].setValue(this,e,i)};t.prototype.show=function(){this.params.hidden=false;BX.addClass(this.fieldId,"main-mail-form-drop-animation");BX(this.fieldId).style.display=this.params.folded?"none":"";this.__switch.style.display=this.params.folded?"":"none"};t.prototype.hide=function(){this.params.hidden=true;BX(this.fieldId).style.display="none";this.__switch.style.display="none";BX.removeClass(this.fieldId,"main-mail-form-drop-animation")};t.prototype.fold=function(){this.params.folded=true;if(!this.params.hidden)this.__switch.style.display="";BX(this.fieldId).style.display="none";BX.removeClass(this.fieldId,"main-mail-form-drop-animation")};t.prototype.unfold=function(){this.params.folded=false;if(!this.params.hidden){BX.addClass(this.fieldId,"main-mail-form-drop-animation");BX(this.fieldId).style.display=""}this.__switch.style.display="none"};t.__types={list:{},text:{},from:{},rcpt:{},editor:{},files:{}};t.__types["list"].init=function(e){BX.addCustomEvent(e.form,"MailForm::editor:click",function(){var t=BX.PopupMenu.getMenuById(e.fieldId+"-menu");if(t)t.close()});var t=BX.findChildByClassName(e.params.__row,"main-mail-form-field-value-menu",true);BX.bind(t,"click",function(){var i=BX(e.fieldId+"_value");var a=function(e,a){i.value=e;BX.adjust(t,{html:a})};var o=function(e,t){a(t.options.value,t.text);t.menuWindow.close()};var r=[];if(!e.params.required){r.push({text:BX.util.htmlspecialchars(e.params.placeholder),title:e.params.placeholder,value:"",onclick:o});r.push({delimiter:true})}for(var n in e.params.list){r.push({text:BX.util.htmlspecialchars(e.params.list[n]),title:e.params.list[n],value:n,onclick:o})}BX.PopupMenu.show(e.fieldId+"-menu",t,r,{className:"main-mail-form-field-value-menu-content",offsetLeft:40,angle:true,closeByEsc:true})})};t.__types["from"].init=function(e){BX.addCustomEvent(e.form,"MailForm::editor:click",function(){var t=BX.PopupMenu.getMenuById(e.fieldId+"-menu");if(t)t.close()});BX.onCustomEvent(e.form,"MailForm::from::change",[e]);var t=BX.findChildByClassName(e.params.__row,"main-mail-form-field-value-menu",true);BX.bind(t,"click",function(){var i=[];var a=BX(e.fieldId+"_value");var o=function(i,o){a.value=i;BX.adjust(t,{html:BX.util.strip_tags(o)});BX.onCustomEvent(e.form,"MailForm::from::change",[e])};var r=function(e,t){var r="apply";if(e&&e.target){var n="main-mail-form-field-from-menu-delete-icon";if(BX.hasClass(e.target,n)||BX.findParent(e.target,{class:n},t.layout.item)){r="delete"}}if("delete"==r){BXMainMailConfirm.deleteSender(t.id,function(){t.menuWindow.removeMenuItem(t.id);if(a.value==t.title){o(i[0].title,i[0].text)}})}else{o(t.title,t.text);t.menuWindow.close()}};var n,s;if(!e.params.required){i.push({text:BX.util.htmlspecialchars(e.params.placeholder),title:"",onclick:r});i.push({delimiter:true})}if(e.params.mailboxes&&e.params.mailboxes.length>0){for(var l in e.params.mailboxes){s="menu-popup-no-icon";n=BX.util.htmlspecialchars(e.params.mailboxes[l].formated);if(e.params.mailboxes[l]["can_delete"]&&e.params.mailboxes[l].id>0){n+='<span class="main-mail-form-field-from-menu-delete-icon popup-window-close-icon popup-window-titlebar-close-icon"\t\t\t\t\t\t\ttitle="'+BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_DELETE"))+'"></span>';s="menu-popup-no-icon menu-popup-right-icon"}i.push({text:n,title:e.params.mailboxes[l].formated,onclick:r,className:s,id:e.params.mailboxes[l].id})}i.push({delimiter:true})}i.push({text:BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_MENU")),onclick:function(t,i){i.menuWindow.close();BXMainMailConfirm.showForm(function(t,i){e.params.mailboxes.push({email:t.email,name:t.name,id:t.id,formated:i});o(i,BX.util.htmlspecialchars(i));BX.PopupMenu.destroy(e.fieldId+"-menu")})}});BX.PopupMenu.show(e.fieldId+"-menu",t,i,{className:"main-mail-form-field-value-menu-content",offsetLeft:40,angle:true,closeByEsc:true})})};t.__types["rcpt"].init=function(e){var t=BX.findChildByClassName(e.params.__row,"main-mail-form-field-rcpt-item-more",true);var i=BX.findChildByClassName(e.params.__row,"main-mail-form-field-value-wrapper",true);var a=BX.findChildByClassName(e.params.__row,"main-mail-form-field-rcpt-add-link",true);var o=BX(e.fieldId+"_fvalue");e.selector=e.fieldId+"-selector";var r=function(r,n,s,l,m,d){if(!e.params.multiple){var f=BX.SocNetLogDestination.getSelected(e.selector);for(var u in f){if(u!=r.id||f[u]!=n)BX.SocNetLogDestination.deleteItem(u,f[u],e.selector)}}var p=document.createElement("SPAN");p.setAttribute("data-id",r.id);BX.addClass(p,"main-mail-form-field-rcpt-item");i.insertBefore(p,t.parentNode);p.appendChild(BX.create("INPUT",{props:{type:"hidden",name:e.params.name+"[]",value:JSON.stringify(r)}}));r.showEmail="N";if(e.params.email&&r.email&&r.email.length>0&&r.email!=r.name){r=BX.clone(r);r.name=r.name+" &lt;"+r.email+"&gt;"}BX.SocNetLogDestination.BXfpSelectCallback({item:r,type:n,varName:"dummy_"+e.params.name,bUndeleted:false,containerInput:p,valueInput:o,formName:m,tagInputName:a,tagLink1:e.params.placeholder,tagLink2:e.params.placeholder});if("init"==d){var c=9;var h=BX.findChildrenByClassName(i,"main-mail-form-field-rcpt-item",false);if(h.length>c+1){for(var u=c;u<h.length;u++)h[u].style.display="none";t.setAttribute("title",t.getAttribute("title").replace(/-?\d+/,h.length-c));t.parentNode.style.display=""}}};var n=function(r,n,s,l){var m=BX.findChild(i,{attribute:{"data-id":r.id}},false);BX.SocNetLogDestination.BXfpUnSelectCallback.apply({formName:l,inputContainerName:m,inputName:o,tagInputName:a,tagLink1:e.params.placeholder,tagLink2:e.params.placeholder},[r]);if(m&&m.parentNode==i){if(!BX.findChildByClassName(m,"feed-add-post-destination"))i.removeChild(m)}var d=9;var f=0;var u=BX.findChildrenByClassName(i,"main-mail-form-field-rcpt-item",false);for(var p=0;p<u.length;p++){if(u[p].offsetHeight>0)f++}if(f<u.length&&(f<d||u.length<=d+1)){for(var p=0;p<u.length;p++){if(u[p].offsetHeight>0)continue;u[p].style.display="";f++;if(f>=Math.min(d,u.length)&&u.length>d+1)break}t.setAttribute("title",t.getAttribute("title").replace(/-?\d+/,u.length-d));if(f>=u.length)t.parentNode.style.display="none"}};var s={name:e.selector,searchInput:o,bindMainPopup:{node:i,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:i,offsetTop:"5px",offsetLeft:"15px"},callback:{select:r,unSelect:n,openDialog:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:o.parentNode,inputName:o,tagInputName:a}),closeDialog:function(){BX.onCustomEvent(e.form,"MailForm:field:rcptSelectorClose",[e.form,e]);BX.SocNetLogDestination.BXfpCloseDialogCallback.apply({inputBoxName:o.parentNode,inputName:o,tagInputName:a})},openSearch:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:o.parentNode,inputName:o,tagInputName:a})},items:{},itemsLast:{},itemsSelected:{},destSort:{}};if(e.params.selector){for(var l in e.params.selector)s[l]=e.params.selector[l]}BX.SocNetLogDestination.init(s);BX.bind(o,"keydown",BX.delegate(BX.SocNetLogDestination.BXfpSearchBefore,{formName:e.selector,inputName:o}));BX.bind(o,"keyup",BX.delegate(BX.SocNetLogDestination.BXfpSearch,{formName:e.selector,inputName:o,tagInputName:a}));BX.bind(o,"paste",BX.defer(BX.SocNetLogDestination.BXfpSearch,{formName:e.selector,inputName:o,tagInputName:a,onPasteEvent:true}));BX.bind(o,"blur",BX.delegate(BX.SocNetLogDestination.BXfpBlurInput,{inputBoxName:o.parentNode,tagInputName:a}));BX.bind(i,"click",function(t){BX.SocNetLogDestination.openDialog(e.selector);BX.PreventDefault(t)});BX.bind(t,"click",function(e){var t=BX.findChildrenByClassName(i,"main-mail-form-field-rcpt-item",false);for(var a=0;a<t.length;a++)t[a].style.display="";this.parentNode.style.display="none";BX.PreventDefault(e)})};t.__types["editor"].init=function(t){var a=t.form.postForm;var o=t.form.editor;if(t.params.value===null||t.params.value===undefined)t.params.value="";t.quoteNode=document.createElement("DIV");var r=document.createElement("DIV");r.setAttribute("id",e.quoteNodeId);r.innerHTML=t.params.value;t.quoteNode.appendChild(r);t.quoteNode.__folded=t.form.options.foldQuote;BX.onCustomEvent(a.eventNode,"OnShowLHE",["justShow"]);BX.addClass(o.dom.cont,"main-mail-form-editor");o.dom.toolbarCont.style.opacity="inherit";BX.addCustomEvent(o,"OnIframeClick",function(){BX.SocNetLogDestination.abortSearchRequest();BX.SocNetLogDestination.closeSearch();BX.SocNetLogDestination.closeDialog();BX.onCustomEvent(t.form,"MailForm::editor:click",[])});var n=BX.findChildByClassName(t.params.__row,"feed-add-post-form-editor-btn",true);var s=function(e){e=e?true:false;o.toolbar[e?"Show":"Hide"]();BX[e?"addClass":"removeClass"](n,"feed-add-post-form-btn-active");BX[e?"removeClass":"addClass"](t.params.__row,"main-mail-form-editor-no-toolbar")};s(o.toolbar.shown);BX.bind(n,"click",function(){s(!o.toolbar.shown)});var l=BX.findChildByClassName(t.form.htmlForm,"main-mail-form-quote-button",true);var m=function(){if(t.quoteNode.__folded){t.quoteNode.__folded=false;t.setValue(o.GetContent(),{quote:true,signature:false});o.Focus(false);var e,i;e=l.parentNode.offsetHeight;BX.hide(l,"inline-block");i=l.parentNode.offsetHeight;o.ResizeSceleton(0,o.config.height+e-i)}};BX.bind(l,"click",m);var d=function(){if(o.GetViewMode()!="wysiwyg"){BX.removeCustomEvent(o,"OnSetViewAfter",d);m()}};BX.addCustomEvent(o,"OnSetViewAfter",d);a.parser.disk_file.regexp=/(bxacid):(n?\d+)/gi;o.phpParser.AddBxNode("disk_file",{Parse:function(e,i){var a=o.GetIframeDoc().getElementById(i)||BX.findChild(t.quoteNode,{attr:{id:i}},true);if(a){var r=document.createElement("DIV");a=a.cloneNode(true);r.appendChild(a);if(a.tagName.toUpperCase()=="IMG"){var n="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";a.setAttribute("data-bx-orig-src",a.getAttribute("src"));a.setAttribute("src",n);return r.innerHTML.replace(n,"bxacid:"+e.value)}return r.innerHTML}return"[ "+e.value+" ]"}});BX.addCustomEvent(a.eventNode,"OnFileUploadRemove",function(e){o.synchro.Sync();for(i in o.bxTags){if(o.bxTags[i].params&&o.bxTags[i].params.value==e){var a=o.GetIframeDoc().getElementById(o.bxTags[i].id);if(a&&a.parentNode)a.parentNode.removeChild(a);var a=BX.findChild(t.quoteNode,{attr:{id:o.bxTags[i].id}},true);if(a&&a.parentNode)a.parentNode.removeChild(a);delete o.bxTags[i]}}o.synchro.FullSyncFromIframe()});BX.addCustomEvent(o,"OnCreateIframeAfter",function(){t.setValue("",{quote:true,signature:true});t.form.editorInited=true;BX.onCustomEvent(t.form,"MailForm::editor::init",[t])});BX.addCustomEvent(t.form,"MailForm:show",function(){t.form.editor.CheckAndReInit();t.form.editor.ResizeSceleton()});BX.addCustomEvent(t.form,"MailForm:hide",function(){t.form.editor.SaveContent()});BX.addCustomEvent(t.form,"MailForm:submit",function(){var e=o.GetContent();if(t.quoteNode.__folded)e+=o.Parse(t.quoteNode.innerHTML,true,false);BX(t.fieldId+"_value").value=e})};t.__types["from"].setValue=function(e,t){var i=BX(e.fieldId+"_value");var a=BX.findChildByClassName(e.params.__row,"main-mail-form-field-value-menu",true);if(!t.trim()){if(!e.params.required){i.value="";BX.adjust(a,{html:""})}BX.onCustomEvent(e.form,"MailForm::from::change",[e,""]);return}if(e.params.mailboxes&&e.params.mailboxes.length>0){var o=new RegExp("[-/\\^$*+?.()|[]{}]","g");for(var r in e.params.mailboxes){var n=new RegExp("(^|<)"+e.params.mailboxes[r].email.replace(o,"\\$&")+"(>|$)","i");if(t.trim().match(n)){i.value=t;BX.adjust(a,{html:BX.util.htmlspecialchars(t)});BX.onCustomEvent(e.form,"MailForm::from::change",[e]);break}}}};t.__types["rcpt"].setValue=function(e,t){var i=BX.SocNetLogDestination.getSelected(e.selector);for(var a in i)BX.SocNetLogDestination.deleteItem(a,i[a],e.selector);if(t&&BX.type.isPlainObject(t)){for(var a in t){if(t.hasOwnProperty(a)){BX.SocNetLogDestination.obItemsSelected[e.selector][a]=t[a];BX.SocNetLogDestination.runSelectCallback(a,t[a],e.selector,false,"init")}}}};t.__types["text"].insert=function(e,t){var i=BX(e.fieldId+"_value");if(typeof i.selectionStart!="undefined"){var a={start:i.selectionStart,end:i.selectionEnd};i.value=i.value.substr(0,a.start)+t+i.value.substr(a.end);i.selectionStart=i.selectionEnd=a.start+t.length}else{i.value=i.value+t}i.focus()};t.__types["text"].setValue=function(e,t){var i=BX(e.fieldId+"_value");i.value=t};t.__types["editor"].insert=function(e,t){var i=e.form.editor;if(i.synchro.IsFocusedOnTextarea()){i.textareaView.WrapWith("","",t);if(i.textareaView.element&&typeof i.textareaView.element.selectionStart!="undefined")i.textareaView.element.selectionStart=i.textareaView.element.selectionEnd}else{i.selection.GetRange().deleteContents();i.InsertHtml(t)}i.Focus()};t.__types["editor"].setValue=function(t,i,a){var o=t.form.postForm;var r=t.form.editor;if(i.length>0){for(var n in o.controllers){if(!o.controllers.hasOwnProperty(n))continue;var s=o.controllers[n];if(s.storage!="disk")continue;if(!s.values)break;for(var l in s.values){if(s.values.hasOwnProperty(l)&&s.values[l].src)i=i.replace("bxacid:"+l,s.values[l].src+"&__bxacid="+l)}break}}if(a&&a.signature){r.synchro.Sync();var m=r.GetIframeDoc().getElementById(e.signatureNodeId);if(m){var d=document.createElement("div");d.appendChild(m.cloneNode(true));i+=d.innerHTML}}if(a&&a.quote&&!t.quoteNode.__folded)i+=t.quoteNode.innerHTML;r.SetContent(i,true);var f=/[&?]__bxacid=(n?\d+)/;var u={IMG:"src",A:"href"};for(var p in u){var c=r.GetIframeDoc().getElementsByTagName(p);for(var h=0;h<c.length;h++){var B=c[h].getAttribute(u[p])?c[h].getAttribute(u[p]).match(f):false;if(B&&o.arFiles["disk_file"+B[1]]){c[h].removeAttribute("id");c[h].setAttribute(u[p],c[h].getAttribute(u[p]).replace(f,""));r.SetBxTag(c[h],{tag:"disk_file",params:{value:B[1]}});o.monitoringSetStatus("disk_file",B[1],true);o.monitoringStart()}}}r.synchro.FullSyncFromIframe()};t.__types["files"].setValue=function(e,t){var i=e.form.postForm;i.controllerInit("show");for(var a in i.controllers){if(!i.controllers.hasOwnProperty(a))continue;var o=i.controllers[a];if(o.storage!="disk")continue;if(!o.handler)break;t=BX.clone(t);if(o.values){for(var r=0;r<t.length;r++){if(o.values[t[r].id])t.splice(r--,1)}}o.handler.selectFile({},{},t);break}};window.BXMainMailForm=e})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:91:"/bitrix/components/bitrix/main.mail.confirm/templates/.default/script.min.js?15441273846063";s:6:"source";s:72:"/bitrix/components/bitrix/main.mail.confirm/templates/.default/script.js";s:3:"min";s:76:"/bitrix/components/bitrix/main.mail.confirm/templates/.default/script.min.js";s:3:"map";s:76:"/bitrix/components/bitrix/main.mail.confirm/templates/.default/script.map.js";}"*/
(function(){if(window.BXMainMailConfirm)return;var e={showForm:function(e,t){var a="email";var i;var n=t&&t.mode?t.mode:"add";var o=new BX.PopupWindow("add_from_email",null,{width:480,titleBar:BX.message("MAIN_MAIL_CONFIRM_TITLE"),draggable:true,closeIcon:true,lightShadow:true,contentColor:"white",contentNoPaddings:true,content:BX("new_from_email_dialog_content").innerHTML,buttons:[new BX.PopupWindowButton({text:BX.message("MAIN_MAIL_CONFIRM_GET_CODE"),className:"popup-window-button-create",events:{click:function(){var n=this;if(BX.hasClass(n.buttonNode,"popup-window-button-wait"))return;var l=BX.findChildByClassName(o.contentContainer,"new-from-email-dialog-email-block",true);var s=BX.findChildByClassName(o.contentContainer,"new-from-email-dialog-code-block",true);var r=BX.findChild(l,{attr:{"data-name":"name"}},true);var d=BX.findChild(l,{attr:{"data-name":"email"}},true);var m=BX.findChild(s,{attr:{"data-name":"code"}},true);var u=BX.findChild(o.contentContainer,{attr:{"data-name":"public"}},true);var f=BX.findChild(l,{attr:{"data-name":"smtp-server"}},true);var c=BX.findChild(l,{attr:{"data-name":"smtp-port"}},true);var _=BX.findChild(l,{attr:{"data-name":"smtp-login"}},true);var h=BX.findChild(l,{attr:{"data-name":"smtp-password"}},true);if("email"==a||"smtp"==a){m.value="";var N="[=a-z0-9_+~'!$&*^`|#%/?{}-]";var M=new RegExp("^"+N+"+(\\."+N+"+)*@([a-z0-9-]+\\.)+[a-z0-9-]{2,20}$","i");if(!d.value.match(M)){o.showNotify(BX.message(d.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_EMAIL":"MAIN_MAIL_CONFIRM_EMPTY_EMAIL"));return}}if("smtp"==a){if(!f.value.match(/^([a-z0-9-]+\.)+[a-z0-9-]{2,20}$/)){o.showNotify(BX.message(f.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_SMTP_SERVER":"MAIN_MAIL_CONFIRM_EMPTY_SMTP_SERVER"));return}if(!c.value.match(/^[0-9]+$/)||c.value<1||c.value>65535){o.showNotify(BX.message(c.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_SMTP_PORT":"MAIN_MAIL_CONFIRM_EMPTY_SMTP_PORT"));return}if(!(_.value.length>0)){o.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_SMTP_LOGIN"));return}if(!(h.value.length>0)){o.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_SMTP_PASSWORD"));return}}if("code"==a){if(m.value.length==0){o.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_CODE"));return}}o.hideNotify();BX.addClass(n.buttonNode,"popup-window-button-wait");var C={name:r.value,email:d.value,smtp:{},code:"",public:u.checked?u.value:""};if("smtp"==a){C.smtp={server:f.value,port:c.value,login:_.value,password:h.value}}if("code"==a){C.code=m.value}if(t&&t.data){for(var I in t.data){if(t.data.hasOwnProperty(I)){C[I]=t.data[I]}}}BX.ajax({url:"/bitrix/components/bitrix/main.mail.confirm/ajax.php?act=add",method:"POST",dataType:"json",data:C,onsuccess:function(t){BX.removeClass(n.buttonNode,"popup-window-button-wait");if(t.senderId){i=t.senderId}if(t.result=="error"){o.showNotify(t.error)}else if("email"==a||"smtp"==a){o.switchBlock("code")}else{n.popupWindow.close();if(BX.type.isFunction(e)){var l=r.value.length>0?r.value:BX.message("MAIN_MAIL_CONFIRM_USER_FULL_NAME");e({name:l,email:d.value,id:i},l.length>0?l+" <"+d.value+">":d.value)}}},onfailure:function(e){BX.removeClass(n.buttonNode,"popup-window-button-wait");o.showNotify(BX.message("MAIN_MAIL_CONFIRM_AJAX_ERROR"))}})}}}),new BX.PopupWindowButton({text:BX.message("MAIN_MAIL_CONFIRM_CANCEL"),className:"popup-window-button-link",events:{click:function(){if("code"==a&&"confirm"!=n){var e=BX.findChildByClassName(o.contentContainer,"new-from-email-dialog-smtp-block",true);o.switchBlock(e&&e.offsetHeight>0?"smtp":"email");o.hideNotify()}else{this.popupWindow.close()}}}})]});o.hideNotify=function(){var e=BX.findChild(o.contentContainer,{class:"new-from-email-dialog-error"},true);BX.hide(e,"block")};o.showNotify=function(e){var t=BX.findChild(o.contentContainer,{class:"new-from-email-dialog-error"},true);t.innerHTML=e;BX.show(t,"block")};o.switchBlock=function(e,t){var i=BX.findChildByClassName(o.contentContainer,"new-from-email-dialog-email-block",true);var n=BX.findChildByClassName(o.contentContainer,"new-from-email-dialog-code-block",true);var l,s;if("code"!=a&&"code"==e){l=i;s=n;o.buttons[0].setName(BX.message("MAIN_MAIL_CONFIRM_SAVE"));o.buttons[1].setName(BX.message("MAIN_MAIL_CONFIRM_BACK"))}else if("code"==a&&"code"!=e){l=n;s=i;o.buttons[0].setName(BX.message("MAIN_MAIL_CONFIRM_GET_CODE"));o.buttons[1].setName(BX.message("MAIN_MAIL_CONFIRM_CANCEL"))}a=e;if(l&&s){if(t){s.style.position="";s.style.height="";s.style.display="";l.style.display="none"}else{l.style.height=l.offsetHeight+"px";l.offsetHeight;l.style.height="0px";s.style.position="absolute";s.style.height="";s.style.display="";var r=s.offsetHeight;s.style.height="0px";s.style.position="";s.offsetHeight;s.style.height=r+"px"}}};var l=BX.findChildByClassName(o.contentContainer,"new-from-email-dialog-smtp-link",true);var s=BX.findChildByClassName(o.contentContainer,"new-from-email-dialog-smtp-block",true);if(l&&s){BX.bind(l,"click",function(e){var t=BX.findChildByClassName(o.contentContainer,"new-from-email-dialog-email-block",true);t.style.height="";if("smtp"==a){a="email";BX.hide(s,"table-row-group")}else{a="smtp";BX.show(s,"table-row-group")}e.preventDefault()})}if("confirm"==n){o.switchBlock("code",true);o.setOverlay(true)}o.show();var r=BX.findChildByClassName(o.contentContainer,"new-from-email-dialog-email-block",true);var d=BX.findChild(r,{attr:{"data-name":"name"}},true);var m=BX.findChild(r,{attr:{"data-name":"email"}},true);if(d.value.length>0){m.focus()}else{d.focus()}},deleteSender:function(e,t){if(e>0){if(confirm(BX.message("MAIN_MAIL_CONFIRM_DELETE_SENDER_CONFIRM"))){BX.ajax({url:"/bitrix/components/bitrix/main.mail.confirm/ajax.php?act=delete",method:"POST",dataType:"json",data:{senderId:e},onsuccess:function(e){if(e.result=="error"){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")})}else{if(BX.type.isFunction(t)){t()}}},onfailure:function(e){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")})}})}}}};window.BXMainMailConfirm=e})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:89:"/bitrix/components/bitrix/main.post.form/templates/.default/script.min.js?154412738466246";s:6:"source";s:69:"/bitrix/components/bitrix/main.post.form/templates/.default/script.js";s:3:"min";s:73:"/bitrix/components/bitrix/main.post.form/templates/.default/script.min.js";s:3:"map";s:73:"/bitrix/components/bitrix/main.post.form/templates/.default/script.map.js";}"*/
(function(){if(window["LHEPostForm"])return;var e={controller:{},handler:{}};BX.addCustomEvent(window,"BFileDLoadFormControllerWasBound",function(t){e.controller[t.id]=true});BX.addCustomEvent(window,"WDLoadFormControllerInit",function(t){e.controller[t.CID]=t});BX.addCustomEvent(window,"WDLoadFormControllerWasBound",function(t){e.controller[t.CID]=true});BX.addCustomEvent(window,"DiskDLoadFormControllerInit",function(t){e.controller[t.CID]=t});BX.addCustomEvent(window,"DiskLoadFormControllerWasBound",function(t){e.controller[t.CID]=true});BX.addCustomEvent(window,"OnEditorInitedBefore",function(t){if(e.handler[t.id]){t.__lhe_flags=["OnEditorInitedBefore"];if(e.handler[t.id]["params"]&&e.handler[t.id]["params"]["LHEJsObjName"])window[e.handler[t.id].params["LHEJsObjName"]]=t;e.handler[t.id].OnEditorInitedBefore(t)}});var t=function(t){if(e.handler[t.id]&&e.handler[t.id].editorIsLoaded!==true){e.handler[t.id].editorIsLoaded=true;e.handler[t.id].exec();BX.onCustomEvent(e.handler[t.id],"OnEditorIsLoaded",[e.handler[t.id],t])}};BX.addCustomEvent(window,"OnCreateIframeAfter",t);BX.addCustomEvent(window,"OnEditorInitedAfter",function(i,n){if(e.handler[i.id]){i.__lhe_flags.push("OnEditorInitedAfter");e.handler[i.id].OnEditorInitedAfter(i);if(e.handler[i.id].editorIsLoaded!==true&&n&&i.sandbox&&i.sandbox.inited)t.apply(i,[i])}});BX.util.object_search=function(e,t){for(var i in t){if(t.hasOwnProperty(i)){if(t[i]==e)return true;else if(typeof t[i]=="object"&&t[i]!==null){var n=BX.util.object_search_key(e,t[i]);if(n!==false)return n}}}return false};var i=function(e,t,i){i=i&&i.length>0?i:[];if(typeof t=="object"&&t.length>0){var n;while((n=t.pop())&&n&&t.length>0){i.push(n)}t=n}i.push(t);this.exist=true;this.bxTag=e;this.tag=t;this.tags=i;this.regexp=new RegExp("\\[("+i.join("|")+")=((?:\\s|\\S)*?)(?:\\s*?WIDTH=(\\d+)\\s*?HEIGHT=(\\d+))?\\]","ig");this.code="["+t+"=#ID##ADDITIONAL#]";this.wysiwyg='<span style="color: #2067B0; border-bottom: 1px dashed #2067B0; margin:0 2px;" id="#ID#"#ADDITIONAL#>#NAME#</span>'},n=function(t,i,n){this.CID=this.id=i;this.parser=t.parser["disk_file"]||null;this.params=n;this.node=BX("diskuf-selectdialog-"+i);this.handler=e.controller[i];this.manager=t;this.eventNode=this.manager.eventNode;this.parserName="disk_file";this.prefixNode="disk-edit-attach";this.prefixHTMLNode="disk-attach-";this.props={valueEditClassName:"wd-inline-file",securityCID:"disk-upload-cid"};this.storage="disk";this.fileToAttach={};this.xmlToAttach={};this.events={onInit:"DiskDLoadFormControllerInit",onShow:"DiskLoadFormController",onBound:"DiskLoadFormControllerWasBound"}};n.prototype={parser:false,eventNode:null,values:{},initialized:false,functionsToExec:[],exec:function(e,t){if(typeof e=="function")this.functionsToExec.push([e,t]);if(this.handler&&this.handler!==true){var i;while((i=this.functionsToExec.shift())&&i)i[0].apply(this,i[1])}},init:function(){if(this.initialized!==true){this.values={};this.functionsToExec=[];this.initialized=true;this.bindMainEvents(this.manager);if(this.parser!==null){this.bindEvents(this.manager);return this.initValues()}}return false},initValues:function(){var e=BX.findChildren(this.node,{className:this.props.valueEditClassName},true);if(e&&e.length>0){this.exec(this.runCheckText);return true}return false},bindMainEvents:function(t){var i=null;BX.addCustomEvent(t.eventNode,"onReinitializeBefore",BX.proxy(this.clean,this));BX.addCustomEvent(t.eventNode,"onShowControllers",BX.proxy(function(e){i=e;BX.onCustomEvent(t.eventNode,this.events.onShow,[e])},this));if(!e.controller[this.id]){var o=BX.delegate(function(e){if(e["UID"]==this.id||e["id"]==this.id){if(i==="show"||i==="hide"){BX.onCustomEvent(t.eventNode,this.events.onShow,[i]);i=null}BX.removeCustomEvent(window,this.events.onBound,o)}},this);BX.addCustomEvent(window,this.events.onBound,o)}if(BX["DD"]&&this.storage=="disk"){var a=BX.delegate(function(e){if((e["UID"]==this.id||e["id"]==this.id)&&this.manager["dropZoneExists"]!==true){BX.removeCustomEvent(window,this.events.onBound,a);this.manager["dropZoneExists"]=true;var i=this.eventNode,o=this.id;n.dndCatcher=n.dndCatcher||{};n.dndCatcher[o]={catch:true,files:[],dropZone:null,dropZoneMicro:null,initdrag:BX.delegate(function(){n.dndCatcher[o].dropZone=new BX.DD.dropFiles(t.eventNode);BX.addCustomEvent(t.eventNode,"OnImageDataUriHandle",BX.delegate(function(e,t){if(BX["UploaderUtils"]){var i=BX.UploaderUtils.dataURLToBlob(t.src);if(i&&i.size>0&&i.type.indexOf("image/")==0){i.name=i.name||t.title||"image."+i.type.substr(6);i.referrerToEditor=t;if(n.dndCatcher[o]["catch"]===true)n.dndCatcher[o]["drop"]([i]);else if(this.handler&&this.handler["addFile"])this.handler.addFile(i);BX.onCustomEvent(e,"OnImageDataUriCaught",[t])}}},this));BX.addCustomEvent(n.dndCatcher[o].dropZone,"dropFiles",n.dndCatcher[o]["drop"]);BX.addCustomEvent(n.dndCatcher[o].dropZone,"dragEnter",n.dndCatcher[o]["dragover"]);BX.addCustomEvent(n.dndCatcher[o].dropZone,"dragLeave",n.dndCatcher[o]["dragleave"]);if(BX("micro"+t.__divId)){n.dndCatcher[o].dropZoneMicro=new BX.DD.dropFiles(BX("micro"+t.__divId));BX.addCustomEvent(n.dndCatcher[o].dropZoneMicro,"dragEnter",function(){BX.onCustomEvent(t.eventNode,"OnShowLHE",["justShow"])})}BX.unbind(document,"dragover",n.dndCatcher[o]["initdrag"]);BX.onCustomEvent(t.eventNode,"onDropZoneExists",[])},this),dragover:BX.delegate(function(){BX.addClass(t.eventNode,"feed-add-post-dnd-over");BX.onCustomEvent(t.eventNode,"dragover",[])},this),dragleave:BX.delegate(function(){BX.removeClass(t.eventNode,"feed-add-post-dnd-over");BX.onCustomEvent(t.eventNode,"dragleave",[])},this),dragenterwindow:BX.delegate(function(){BX.addClass(t.eventNode,"feed-add-post-dnd-ready");if(BX("micro"+t.__divId)){BX.addClass(BX("micro"+t.__divId),"feed-add-post-micro-dnd-ready")}BX.onCustomEvent(t.eventNode,"dragenterwindow",[])},this),dragleavewindow:BX.delegate(function(e){BX.removeClass(t.eventNode,"feed-add-post-dnd-ready");if(BX("micro"+t.__divId)){BX.removeClass(BX("micro"+t.__divId),"feed-add-post-micro-dnd-ready")}BX.onCustomEvent(t.eventNode,"dragleavewindow",[])},this),drop:BX.delegate(function(e){BX.onCustomEvent(t.eventNode,"drop",[]);BX.onCustomEvent(window,"dragWindowLeave");BX.onCustomEvent(window,"__dragWindowLeave");var i=0;if(e&&e.length>0){if(n.dndCatcher[o]["catch"]===true){n.dndCatcher[o].files=e;i=1}else{i=2}BX.onCustomEvent(t.eventNode,this.events.onShow,["show"]);BX.removeClass(t.eventNode,"feed-add-post-dnd-ready feed-add-post-dnd-over")}return i},this)};BX.ready(function(){n.dndCatcher[o]["initdrag"]()});BX.addCustomEvent(i,"OnIframeDrop",BX.delegate(function(e){BX.PreventDefault(e);if(e["dataTransfer"]&&e["dataTransfer"]["files"]){if(n.dndCatcher[o].drop(e["dataTransfer"]["files"])===2){this.handler.agent.onChange(e["dataTransfer"]["files"])}}},this));BX.addCustomEvent(i,"OnIframeDragOver",n.dndCatcher[o].dragover);BX.addCustomEvent(i,"OnIframeDragLeave",n.dndCatcher[o].dragleave);if(!window["bxMpfDndCatcher"]){window["bxMpfDndCatcher"]=true;var s=false,r=function(){if(s===false){s=true;BX.bind(document,"dragleave",l);BX.bind(document,"dragover",l);BX.bind(document,"mouseout",d);BX.onCustomEvent(window,"dragWindowEnter")}},d=function(e){BX.unbind(document,"dragleave",l);BX.unbind(document,"dragover",l);BX.unbind(document,"mouseout",d);s=false;BX.onCustomEvent(window,"dragWindowLeave")},l=function(e){if(h>0){clearTimeout(h);h=0}BX.fixEventPageXY(e);var t=true;if(e.pageX>0&&e.pageY>0){var i=BX.GetWindowSize();if(e.pageY<i.scrollHeight&&e.pageX<i.scrollWidth){var n=e.pageY-i.scrollTop,o=e.pageX-i.scrollLeft;if(0<n&&n<i.innerHeight-20&&0<o&&o<i.innerWidth-20){t=false}}}if(t){d(e)}else{h=setTimeout(function(){l({type:"intervalLimit"})},100)}},h=0;BX.bind(document,"dragenter",function(e){if(window["bxMpfDndCatcher"]>0){clearTimeout(window["bxMpfDndCatcher"])}var t=true;if(e&&e["dataTransfer"]&&e["dataTransfer"]["types"]){for(var i=0;i<e["dataTransfer"]["types"].length;i++){if(e["dataTransfer"]["types"][i]=="Files"){t=true;break}}}if(t){r()}});BX.addCustomEvent(window,"__dragWindowLeave",d);BX.bind(document,"dragover",function(e){return BX.PreventDefault(e)});BX.bind(document,"drop",function(e){d(e);return BX.PreventDefault(e)})}BX.addCustomEvent(window,"dragWindowEnter",n.dndCatcher[o].dragenterwindow);BX.addCustomEvent(window,"dragWindowLeave",n.dndCatcher[o].dragleavewindow);this.__initCatcher=BX.delegate(function(e,i){if(e==this.id){BX.removeCustomEvent(t.eventNode,"onControllerInitialized",this.__initCatcher);i.agent.initDropZone(t.eventNode);if(n.dndCatcher[e].files.length>0){i.agent.onChange(n.dndCatcher[e].files);n.dndCatcher[e].files=[]}n.dndCatcher[e]["catch"]=false;this.__initCatcher=null}},this);BX.addCustomEvent(t.eventNode,"onControllerInitialized",this.__initCatcher)}},this);BX.addCustomEvent(window,this.events.onBound,a);if(e.controller[this.id])a(e.controller[this.id])}},bindEvents:function(e){this._catchHandler=BX.delegate(function(t){BX.removeCustomEvent(this.eventNode,this.events.onInit,this._catchHandler);this.handler=t;var i=BX.findChild(BX(e.formID),{attr:{id:this.props.securityCID}},true,false);if(i)i.value=this.handler.CID;this.exec();var n=BX.delegate(function(){BX.onCustomEvent(e.eventNode,"onUploadsHasBeenChanged",arguments)},this);BX.addCustomEvent(this.handler.agent,"onFileIsInited",n);BX.addCustomEvent(this.handler.agent,"ChangeFileInput",n);BX.onCustomEvent(e.eventNode,"onControllerInitialized",[this.id,t])},this);if(typeof this.handler!="object"||!this.handler)BX.addCustomEvent(e.eventNode,this.events.onInit,this._catchHandler);else this._catchHandler(this.handler);BX.addCustomEvent(e.eventNode,"OnFileUploadSuccess",BX.delegate(function(e,t,i){if(this.id==t.CID||this.id==t.id){i=i||{};i.usePostfix=true;this.addFile(e,i,t)}},this));BX.addCustomEvent(e.eventNode,"OnFileUploadFailed",BX.delegate(function(e,t,i){if(this.id==t.CID||this.id==t.id){this.failFile(e,i,t)}},this));BX.addCustomEvent(e.eventNode,"OnFileUploadRemove",BX.delegate(function(e,t){if(this.id==t.CID||this.id==t.id){this.deleteFile(e,{usePostfix:true},t)}},this));BX.addCustomEvent(this,"onFileIsInText",BX.proxy(function(e,t){this.adjustFile(this.checkFile(e),t)},this))},addFile:function(e,t,i){var n=this.checkFile(e.element_id,e,t);if(n){setTimeout(BX.proxy(function(){this.bindFile(n);this.adjustFile(n,false)},this),100);BX.onCustomEvent(this.eventNode,"onFileIsAdded",[n,this,i,t])}else{this.failFile(this,t,i)}return true},failFile:function(e,t,i){BX.onCustomEvent(this.eventNode,"onFileIsFailed",[this,i,t])},checkFile:function(e,t){e=""+(typeof e=="object"?e.id:e);if(typeof t=="object"&&t!==null&&e&&t.element_name&&BX(t.place)){var i={id:e,name:t.element_name,url:t.element_url,type:"isnotimage/xyz",isImage:false,place:BX(t.place,true),xmlID:BX(t.place,true).getAttribute("bx-attach-xml-id"),fileID:BX(t.place,true).getAttribute("bx-attach-file-id"),fileType:BX(t.place,true).getAttribute("bx-attach-file-type")},n;if(/(\.png|\.jpg|\.jpeg|\.gif|\.bmp)$/i.test(t.element_name)&&(n=BX.findChild(i.place,{className:"files-preview",tagName:"IMG"},true,false))&&n){i.type="image/xyz";i.lowsrc=n.src;i.element_url=i.src=n.src.replace(/\Wwidth=(\d+)/,"").replace(/\Wheight=(\d+)/,"");i.isImage=true;i.width=parseInt(n.getAttribute("data-bx-full-width")||n.getAttribute("data-bx-width"));i.height=parseInt(n.getAttribute("data-bx-full-height")||n.getAttribute("data-bx-height"))}if(i.xmlID)this.xmlToAttach[i.xmlID+""]=e;if(i.fileID)this.fileToAttach[i.fileID+""]=e;this.values[e]=i}return this.values[e]||false},bindFile:function(e){var t=e.place;if(typeof e=="object"&&t&&!t.hasAttribute("bx-file-is-bound")){var i=BX.findChild(t,{className:"f-wrap"},true,false),n=BX.findChild(t,{className:"files-preview"},true,false);if(i){BX.bind(i,"click",BX.delegate(function(){this.insertFile(e.id)},this));i.style.cursor="pointer";i.title=BX.message("MPF_FILE")}if(n){BX.bind(n,"click",BX.delegate(function(){this.insertFile(e.id)},this))}}},adjustFile:function(e,t){var i=e.place;if(t===true||t===false){if(!e.info)e.info=BX.findChild(e.place,{className:"files-info"},true,false);i=e.info;if(BX.type.isDomNode(i)){var n="check-in-text-"+e.id,o=BX(n),a=t===false?{attrs:{"bx-file-is-in-text":"N"},props:{className:"insert-btn"},html:'<span class="insert-btn-text">'+BX.message("MPF_FILE_INSERT_IN_TEXT")+"</span>"}:{attrs:{"bx-file-is-in-text":"Y"},props:{className:"insert-text"},html:'<span class="insert-btn-text">'+BX.message("MPF_FILE_IN_TEXT")+"</span>"};if(!o){a.attrs.id=n;a.events={click:BX.proxy(function(){this.insertFile(e.id)},this)};i.appendChild(BX.create("SPAN",a))}else{BX.adjust(o,a)}}}},insertFile:function(e){BX.onCustomEvent(this.eventNode,"onFileIsInserted",[this.checkFile(e),this])},deleteFile:function(e,t){e=this.checkFile(e,t);if(e){BX.onCustomEvent(this.eventNode,"onFileIsDeleted",[e,this]);this.values[e.id].place=null;delete this.values[e.id].place;this.values[e.id]=null;delete this.values[e.id];e=null;return true}return false},reinitValues:function(e,t){var i,n,o={};while((i=t.pop())&&i){n=BX(this.prefixHTMLNode+i);n=n?n.tagName=="A"?n:BX.findChild(n,{tagName:"IMG"},true):null;if(n){o["E"+i]={type:"file",id:i,name:n.getAttribute("data-bx-title")||n.getAttribute("data-title"),size:n.getAttribute("data-bx-size")||"",sizeInt:n.getAttribute("data-bx-size")||"",width:n.getAttribute("data-bx-width"),height:n.getAttribute("data-bx-height"),storage:"disk",previewUrl:n.tagName=="A"?"":n.getAttribute("data-bx-src")||n.getAttribute("data-src"),fileId:n.getAttribute("bx-attach-file-id")};if(n.hasAttribute("bx-attach-xml-id"))o["E"+i]["xmlId"]=n.getAttribute("bx-attach-xml-id");if(n.hasAttribute("bx-attach-file-type"))o["E"+i]["fileType"]=n.getAttribute("bx-attach-file-type")}}this.handler.selectFile({},{},o);this.runCheckText()},runCheckText:function(){if(!this._checkText)this._checkText=BX.delegate(this.checkText,this);this.manager.exec(this._checkText)},checkText:function(){var e,t=this.manager.getContent(),i=[],n,o;if(t!=""){e=t;for(o in this.xmlToAttach){if(this.xmlToAttach.hasOwnProperty(o)){t=t.replace(new RegExp("\\&\\#91\\;DOCUMENT ID=("+o+")([WIDTHHEIGHT=0-9 ]*)\\&\\#93\\;","gim"),"["+this.parser["tag"]+"="+this.xmlToAttach[o]+"$2]").replace(new RegExp("\\[DOCUMENT ID=("+o+")([WIDTHHEIGHT=0-9 ]*)\\]","gim"),"["+this.parser["tag"]+"="+this.xmlToAttach[o]+"$2]")}}for(o in this.fileToAttach){if(this.fileToAttach.hasOwnProperty(o)){t=t.replace(new RegExp("\\&\\#91\\;"+this.parser["tag"]+"=("+o+")([WIDTHHEIGHT=0-9 ]*)\\&\\#93\\;","gim"),"["+this.parser["tag"]+"="+this.fileToAttach[o]+"$2]").replace(new RegExp("\\["+this.parser["tag"]+"=("+o+")([WIDTHHEIGHT=0-9 ]*)\\]","gim"),"["+this.parser["tag"]+"="+this.fileToAttach[o]+"$2]")}}n=new RegExp("(?:\\&\\#91\\;)("+this.parser["tags"].join("|")+")=([a-z=0-9 ]+)(?:\\&\\#93\\;)","gim");if(n.test(t)){for(o in this.values){if(this.values.hasOwnProperty(o)){i.push(o)}}if(i.length>0){n=new RegExp("(?:\\&\\#91\\;|\\[)("+this.parser["tags"].join("|")+")=("+i.join("|")+")([WIDTHHEIGHT=0-9 ]*)(?:\\&\\#93\\;|\\])","gim");if(n.test(t))t=t.replace(n,BX.delegate(function(e,t,i,n){return"["+t+"="+i+n+"]"},this))}}if(e!=t)BX.onCustomEvent(this.eventNode,"onFileIsDetected",[t,this])}return t},clean:function(){if(this.handler&&this.handler.values){var e,t,i,n=BX(this.manager.formID);while((e=this.handler.values.pop())&&e){BX.remove(e)}if(this.handler.params&&this.handler.params.controlName){t=BX.findChildren(n,{tagName:"INPUT",attribute:{name:this.handler.params.controlName}},true)}if(t){for(i=0;i<t.length;i++){BX.remove(t[i])}}}},reinit:function(e,t){var i=[],n,o;for(n in t){if(t.hasOwnProperty(n)){if(t[n]["USER_TYPE_ID"]==this.parserName&&t[n]["VALUE"]){for(o in t[n]["VALUE"]){if(t[n]["VALUE"].hasOwnProperty(o)){i.push(t[n]["VALUE"][o])}}}}}if(i.length>0){this.exec(this.reinitValues,[e,i]);return true}return false}};var o=function(e,t,i){o.superclass.constructor.apply(this,arguments);this.parser=e.parser["webdav_element"]||null;this.node=BX("wduf-selectdialog-"+t);this.manager=e;this.parserName="webdav_element";this.prefixNode="wd-doc";this.prefixHTMLNode="wdif-doc-";this.storage="webdav";this.events={onInit:"WDLoadFormControllerInit",onShow:"WDLoadFormController",onBound:"WDLoadFormControllerWasBound"}};BX.extend(o,n);o.prototype.reinitValues=function(e,t){var i,n,o={};this.waitAnswerFromServer=[];while((i=t.pop())&&i){n=BX(this.prefixHTMLNode+i);n=n?n.tagName=="A"?n:BX.findChild(n,{tagName:"IMG"},true):null;if(n){o["E"+i]={type:"file",id:i,name:n.getAttribute("alt"),storage:"webdav",size:n.getAttribute("data-bx-size"),sizeInt:1,ext:"",link:n.getAttribute("data-bx-document")};if(n.hasAttribute("bx-attach-xml-id"))o["E"+i]["xmlId"]=n.getAttribute("bx-attach-xml-id");this.waitAnswerFromServer.push(i)}}if(this.waitAnswerFromServer.length>0){if(!this._defferCheckText)this._defferCheckText=BX.delegate(this.defferCheckText,this);BX.addCustomEvent(this.eventNode,"OnFileUploadSuccess",this._defferCheckText);this.handler.WDFD_SelectFile({},{},o)}};o.prototype.defferCheckText=function(e){var t=BX.util.array_search(e.element_id,this.waitAnswerFromServer);if(t>=0){this.runCheckText();this.waitAnswerFromServer=BX.util.deleteFromArray(this.waitAnswerFromServer,t)}if(this.waitAnswerFromServer.length<=0)BX.removeCustomEvent(this.eventNode,"OnFileUploadSuccess",this._defferCheckText)};var a=function(e,t,i){a.superclass.constructor.apply(this,arguments);this.parser=e.parser["file"]?e.parser["file"]:e.parser["postimage"]["exist"]?e.parser["postimage"]:null;this.postfix=i["postfix"]||"";this.node=BX("file-selectdialog-"+t);this.parserName="file";this.prefixNode="wd-doc";this.prefixHTMLNode="file-doc-";this.props={valueEditClassName:"file-inline-file",securityCID:"upload-cid"};this.storage="bfile";this.events={onInit:"BFileDLoadFormControllerInit",onShow:"BFileDLoadFormController",onBound:"BFileDLoadFormControllerWasBound"}};BX.extend(a,n);a.prototype.initValues=function(e){var t;if(e!==true){t=BX.findChildren(this.node,{className:this.props.valueEditClassName},true);if(t&&t.length>1){this.exec(this.initValues,[true]);return true}return false}t=this.handler.agent.values||[];var i,n,o,a,s={},r="/bitrix/components/bitrix/main.file.input/file.php?mfi_mode=down&cid="+this.handler.CID+"&sessid="+BX.bitrix_sessid();for(var d=0;d<t.length;d++){a=parseInt(t[d].getAttribute("id").replace(this.prefixNode,""));if(s["id"+a])continue;s["id"+a]="Y";if(a>0){n=BX.findChild(t[d],{className:"f-wrap"},true,false);if(!n)continue;o={element_id:a,element_name:n.innerHTML,parser:this.parser.bxTag,storage:"bfile",element_url:r+"&fileID="+a};i=this.addFile(o,{usePostfix:true,hasPreview:false})}}this.runCheckText();return true};a.prototype.checkFile=function(e,t,i){e=""+(typeof e=="object"?e.id:e);e=e+(i&&i["usePostfix"]===true?this.postfix:"");if(typeof t=="object"&&t!==null&&e&&t.element_name&&BX(this.prefixNode+t.element_id,true)){var n={id:e,name:t.element_name,url:t.element_url,type:"isnotimage/xyz",isImage:false,place:BX(this.prefixNode+t.element_id,true)},o;if((t["element_type"]&&t["element_type"].indexOf("image/")===0||/(\.png|\.jpg|\.jpeg|\.gif|\.bmp)$/i.test(t.element_name))&&((o=BX.findChild(n.place,{tagName:"IMG"},true,false))&&o||i&&i["hasPreview"]===false)){n.type="image/xyz";n.src=t["element_thumbnail"]||t["element_url"];n.isImage=true;n.hasPreview=false;n.lowsrc="";n.width="";n.height="";if(BX(o)){n.hasPreview=true;n.lowsrc=t["element_thumbnail"]||o["src"];n.width=parseInt(o.getAttribute("data-bx-full-width"));n.height=parseInt(o.getAttribute("data-bx-full-height"))}}else if(this.parser.bxTag=="postimage"){return false}if(BX(n.place,true).getAttribute("bx-attach-file-type")){n.fileType=BX(n.place,true).getAttribute("bx-attach-file-type")}this.values[e]=n}return this.values[e]||false};a.prototype.bindFile=function(e){var t=e&&e["place"]?e["place"]:null;if(typeof e=="object"&&t&&!t.hasAttribute("bx-file-is-bound")){if(e.isImage&&e.hasPreview){var i=BX.findChild(t,{className:"feed-add-img-title"},true,false),n=BX.findChild(t,{className:"feed-add-img-wrap"},true,false);if(n){BX.bind(n,"click",BX.proxy(function(){this.insertFile(e)},this));n.style.cursor="pointer";n.title=BX.message("MPF_IMAGE")}if(i){BX.bind(i,"click",BX.delegate(function(){this.insertFile(e)},this));i.style.cursor="pointer";i.title=BX.message("MPF_IMAGE")}}else a.superclass.bindFile.apply(this,arguments)}};a.prototype.clean=function(){a.superclass.clean.apply(this,arguments);if(this["handler"]&&this.handler["agent"]&&this.handler.agent["inputName"]){var e,t,i=BX(this.manager.formID);e=BX.findChildren(i,{tagName:"INPUT",attribute:{name:this.handler.agent.inputName+"[]"}},true);if(e){for(t=0;t<e.length;t++){BX.remove(e[t])}}}};var s=function(t,i){this.params=i;this.formID=t;this.showPinButton=!!BX("lhe_button_editor_"+this.formID);if(this.showPinButton){this.params.showPanelEditor=!!this.params.pinEditorPanel}this.oEditorId=i["LHEJsObjId"];this.__divId=i["LHEJsObjName"]||i["LHEJsObjId"];e.handler[this.oEditorId]=this;this.oEditor=s.getEditor(this.oEditorId);this.urlPreview=this.initUrlPreview(i);this.eventNode=BX("div"+this.__divId);BX.addCustomEvent(this.eventNode,"OnShowLHE",BX.delegate(this.OnShowLHE,this));BX.addCustomEvent(this.eventNode,"OnButtonClick",BX.delegate(this.OnButtonClick,this));BX.addCustomEvent(this.eventNode,"OnAfterShowLHE",function(e,t){if(t.oEditor&&t.oEditor["AllowBeforeUnloadHandler"])t.oEditor.AllowBeforeUnloadHandler();if(t.monitoringWakeUp===true)t.monitoringStart()});BX.addCustomEvent(this.eventNode,"OnAfterHideLHE",function(e,t){t.monitoringWakeUp=t.monitoringStop();if(t.oEditor&&t.oEditor["DenyBeforeUnloadHandler"])t.oEditor.DenyBeforeUnloadHandler()});this.initParsers(i);this.initFiles(t,i);BX.ready(BX.delegate(function(){if(BX("lhe_button_submit_"+t,true)){BX.bind(BX("lhe_button_submit_"+t,true),"click",BX.proxy(function(e){BX.onCustomEvent(this.eventNode,"OnButtonClick",["submit"]);return BX.PreventDefault(e)},this))}if(BX("lhe_button_cancel_"+t,true)){BX.bind(BX("lhe_button_cancel_"+t,true),"click",BX.proxy(function(e){BX.onCustomEvent(this.eventNode,"OnButtonClick",["cancel"]);return BX.PreventDefault(e)},this))}},this));this.inited=true;BX.addCustomEvent(BX(this.formID),"onAutoSavePrepare",function(e){e.FORM.setAttribute("bx-lhe-autosave-prepared","Y")});BX.onCustomEvent(this,"onInitialized",[this,t,i,this.parsers]);BX.onCustomEvent(this.eventNode,"onInitialized",[this,t,i,this.parsers]);if(this.oEditor&&this.oEditor.inited&&!this.oEditor["__lhe_flags"]){BX.onCustomEvent(this.oEditor,"OnEditorInitedBefore",[this.oEditor]);BX.onCustomEvent(this.oEditor,"OnEditorInitedAfter",[this.oEditor,true])}};s.prototype={editorIsLoaded:false,arFiles:{},parser:{},controllers:{},exec:function(e,t){this.functionsToExec=this.functionsToExec||[];if(typeof e=="function")this.functionsToExec.push([e,t]);if(this.editorIsLoaded===true){var i;while((i=this.functionsToExec.shift())&&i)i[0].apply(this,i[1])}},initParsers:function(e){this.parser={postimage:{exist:false,bxTag:"postimage",tag:"IMG ID",tags:["IMG ID"],regexp:/\[(IMG ID)=((?:\s|\S)*?)(?:\s*?WIDTH=(\d+)\s*?HEIGHT=(\d+))?\]/gi,code:"[IMG ID=#ID##ADDITIONAL#]",wysiwyg:'<img id="#ID#" src="'+'#SRC#" lowsrc="'+'#LOWSRC#" title=""#ADDITIONAL# />'},player:{exist:false,bxTag:"player",tag:"FILE ID",tags:["FILE ID"],regexp:/\[(FILE ID)=((?:\s|\S)*?)?\]/gi,code:"[FILE ID=#ID##ADDITIONAL#]",wysiwyg:'<img class="bxhtmled-player-surrogate" id="#ID#" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" contenteditable="false" title=""#ADDITIONAL# />'}};var t=e["parsers"]?e["parsers"]:{};for(var n in t){if(t.hasOwnProperty(n)&&/[a-z]/gi.test(n+"")){this.parser[n]=new i(n,t[n])}}if(BX.util.object_search("UploadImage",t)){this.parser["postimage"]["exist"]=true}if(typeof e["arSize"]=="object"){var o="";if(e["arSize"]["width"])o+="max-width:"+e["arSize"]["width"]+"px;";if(e["arSize"]["height"])o+="max-height:"+e["arSize"]["height"]+"px;";if(o!=="")this.parser["postimage"]["wysiwyg"]=this.parser["postimage"]["wysiwyg"].replace("#ADDITIONAL#",' style="'+o+'" #ADDITIONAL#')}},initFiles:function(e,t){this.arFiles={};this.controllers={common:{postfix:"",storage:"bfile",parser:"postimage",node:window,obj:null,init:false}};this.monitoring={interval:null,text:"",savedText:"",files:[],savedFiles:[]};if(!t["CID"]||typeof t["CID"]!=="object")return;BX.addCustomEvent(this.eventNode,"onFileIsAdded",BX.delegate(this.OnFileUploadSuccess,this));BX.addCustomEvent(this.eventNode,"onFileIsFailed",BX.delegate(this.OnFileUploadFailed,this));BX.addCustomEvent(this.eventNode,"onFileIsDeleted",BX.delegate(this.OnFileUploadRemove,this));BX.addCustomEvent(this.eventNode,"onFileIsDetected",BX.delegate(this.setContent,this));BX.addCustomEvent(this.eventNode,"onFileIsInserted",BX.delegate(this.insertFile,this));var i,s,r;for(s in t["CID"]){if(t["CID"].hasOwnProperty(s)){i=t["CID"][s]["parser"];if(i=="disk_file")this.controllers[s]=new n(this,s,t["CID"][s]);else if(i=="webdav_element")this.controllers[s]=new o(this,s,t["CID"][s]);else if(i=="file")this.controllers[s]=new a(this,s,t["CID"][s]);if(this.controllers[s]&&this.controllers[s].init()&&!r)r=true}}BX.ready(BX.delegate(function(){BX.bind(BX("bx-b-uploadfile-"+e),"click",BX.proxy(this.controllerInit,this));if(r)this.controllerInit("show")},this))},controllerInit:function(e){this.controllerInitStatus=e=="show"||e=="hide"?e:this.controllerInitStatus=="show"?"hide":"show";BX.onCustomEvent(this.eventNode,"onShowControllers",[this.controllerInitStatus])},initUrlPreview:function(){if(this.params["urlPreviewId"]&&window["BXUrlPreview"]&&BX(this.params["urlPreviewId"])){return new BXUrlPreview(BX(this.params["urlPreviewId"]))}return null},getContent:function(){return this.oEditor?this.oEditor.GetContent():""},setContent:function(e){if(this.oEditor)this.oEditor.SetContent(e)},OnFileUploadSuccess:function(e,t,i,n){if(this.controllers[t.id]){var o=t.parser.bxTag+e.id;this.arFiles[o]=this.arFiles[o]||[];this.arFiles[o].push(t.id);if(n&&n["referrerToEditor"]){var a=this.getFileToInsert(e,t);BX.onCustomEvent(n["referrerToEditor"],"OnImageDataUriCaughtUploaded",[a]);BX.onCustomEvent(this.oEditor,"OnImageDataUriCaughtUploaded",[n["referrerToEditor"],e,a])}else if(i===true&&e.isImage&&this.insertImageAfterUpload){if(!this._insertFile)this._insertFile=BX.delegate(this.insertFile,this);this.exec(this._insertFile,arguments)}}},OnFileUploadFailed:function(e,t,i){if(i&&i["referrerToEditor"]){BX.onCustomEvent(i["referrerToEditor"],"OnImageDataUriCaughtFailed",[]);BX.onCustomEvent(this.editor,"OnImageDataUriCaughtFailed",[i["referrerToEditor"]])}},OnFileUploadRemove:function(e,t){if(this.controllers[t.id]){var i=t.parser.bxTag+e.id;if(this.arFiles[i]){var n=BX.util.array_search(t.id,this.arFiles[i]);this.arFiles[i]=BX.util.deleteFromArray(this.arFiles[i],n);if(!this.arFiles[i]||this.arFiles[i].length<=0){this.arFiles[i]=null;delete this.arFiles[i];if(!this._deleteFile)this._deleteFile=BX.delegate(this.deleteFile,this);this.exec(this._deleteFile,arguments)}}}},showPanelEditor:function(e,t){if(e==undefined)e=!this.oEditor.toolbar.IsShown();this.params.showPanelEditor=e;var i=BX("lhe_button_editor_"+this.formID),n=BX("panel-close"+this.__divId);if(n){this.oEditor.dom.cont.appendChild(n)}if(e){this.oEditor.dom.toolbarCont.style.opacity="inherit";this.oEditor.toolbar.Show();if(i)BX.addClass(i,"feed-add-post-form-btn-active");if(n)n.style.display=""}else{this.oEditor.toolbar.Hide();if(i)BX.removeClass(i,"feed-add-post-form-btn-active");if(n)n.style.display="none"}if(t!==false)BX.userOptions.save("main.post.form","postEdit","showBBCode",e?"Y":"N")},monitoring:{},monitoringStart:function(){if(this.monitoring.interval===null){if(!this._monitoringStart){this._monitoringStart=BX.delegate(this.checkFilesInText,this);BX.addCustomEvent(this.oEditor,"OnContentChanged",BX.proxy(function(e){this.monitoring.text=e},this))}this.monitoring.interval=setInterval(this._monitoringStart,1e3)}},monitoringStop:function(){var e=this.monitoring.interval!==null;if(this.monitoring.interval!==null)clearInterval(this.monitoring.interval);this.monitoring.interval=null;return e},monitoringSetStatus:function(e,t,i){if(this.arFiles[e+t]){var n;for(var o=0;o<this.arFiles[e+t].length;o++){n=this.arFiles[e+t][o];BX.onCustomEvent(this.controllers[n],"onFileIsInText",[t,i])}}},checkFilesInText:function(){if(this.monitoring.text!==this.monitoring.savedText){this.monitoring.savedText=this.monitoring.text;this.monitoring.files=[];var e=this.monitoring.savedText,t,i=function(e,t){return function(i,n,o){e.monitoring.files.push([t,o].join("/"))}};for(t in this.parser){if(this.parser.hasOwnProperty(t)){if(!this.parser[t]["checkFilesInText"]){this.parser[t]["checkFilesInText"]=i(this,t)}e.replace(this.parser[t]["regexp"],this.parser[t]["checkFilesInText"])}}if(this.monitoring.savedFiles.join(",")!==this.monitoring.files.join(",")){var n={},o;while(o=this.monitoring.savedFiles.pop()){n[o]=null}for(t=0;t<this.monitoring.files.length;t++){o=this.monitoring.files[t];n[o]=n[o]>=0?n[o]+1:1}for(t in n){if(n.hasOwnProperty(t)){o=t.split("/");this.monitoringSetStatus(o[0],o[1],n[t]>0)}}}this.monitoring.savedFiles=this.monitoring.files;if(this.monitoring.savedFiles.length<=0)this.monitoringStop()}},checkFile:function(e,t){var i=false;if(typeof e=="string"){var n=typeof t=="string"?t:t.parser;if(!!this.arFiles[n+e]){var o=this.arFiles[n+e][0];t=this.controllers[o];i={file:t.values[e],controller:t}}}else if(this.controllers[t.id]){i={file:e,controller:t}}return i},insertFile:function(e,t){var i=this.oEditor;if(i&&e){var n=i.GetViewMode(),o=this.getFileToInsert(e,t);if(n=="wysiwyg"){i.InsertHtml(o.replacement);setTimeout(BX.delegate(i.AutoResizeSceleton,i),500);setTimeout(BX.delegate(i.AutoResizeSceleton,i),1e3)}else if(n=="code"){i.textareaView.Focus();if(!i.bbCode){var a=i.GetIframeDoc();var s=a.createElement("DIV");s.style.display="none";s.innerHTML=o.replacement;a.body.appendChild(s);o.replacement=i.Parse(o.replacement,true,false);s.parentNode.removeChild(s)}i.textareaView.WrapWith("","",o.replacement)}else{return}o["callback"]()}},getFileToInsert:function(e,t){var i=this.oEditor;if(i&&e){var n=e["id"],o="",a=t.parser,s=i.bbCode?i.GetViewMode():"wysiwyg",r=this.parser[a.bxTag][s];if(e["fileType"]&&this.parser[e["fileType"]]&&s=="wysiwyg"){r=this.parser[e["fileType"]][s]}if(e["isImage"]){r=s=="wysiwyg"?this.parser["postimage"][s]:r;if(e.width>0&&e.height>0&&i.sEditorMode=="html"){o=' style="width:'+e.width+"px;height:"+e.height+"px;\" onload=\"this.style.width='auto';this.style.height='auto';\""}}if(s=="wysiwyg"){r=r.replace("#ID#",i.SetBxTag(false,{tag:a.bxTag,params:{value:n}})).replace("#SRC#",e.src).replace("#URL#",e.url).replace("#LOWSRC#",e.lowsrc||"").replace("#NAME#",e.name).replace("#ADDITIONAL#",o)+"<span>&nbsp;</span>"}else if(s=="code"&&i.bbCode){r=r.replace("#ID#",n).replace("#ADDITIONAL#","")}return{replacement:r,callback:BX.proxy(function(){this.monitoringSetStatus(t.parser.bxTag,e.id,true);this.monitoringStart()},this)}}return{replacement:"",callback:BX.DoNothing}},deleteFile:function(e,t){var i=this.oEditor,n=t.parser,o=e.id,a=i.GetContent();if(n&&a.indexOf("="+o)>=0){if(i.GetViewMode()=="wysiwyg"){var s=i.GetIframeDoc(),r,d;for(r in i["bxTags"]){if(i["bxTags"].hasOwnProperty(r)){if(typeof i.bxTags[r]=="object"&&i.bxTags[r]["params"]&&i.bxTags[r]["params"]["value"]==e.id){d=s.getElementById(r);if(d)d.parentNode.removeChild(d)}}}i.SaveContent()}else{a=a.replace(n.regexp,function(t,i,n){return n==e.id?"":t});i.SetContent(a);i.Focus()}this.monitoringSetStatus(n.bxTag,e.id,false)}},reinit:function(e,t){BX.onCustomEvent(this.eventNode,"onReinitializeBefore",[this,e,t]);this.arFiles={};delete this.monitoringWakeUp;this.monitoringStop();this.oEditor.CheckAndReInit(e||"");BX.onCustomEvent(this.eventNode,"onReinitialize",[this,e,t]);var i,n=false;for(i in this.controllers){if(this.controllers.hasOwnProperty(i)){if(this.controllers[i]["init"]&&this.controllers[i].reinit(e,t))n=true}}this.controllerInit(n?"show":"hide");if(this.params["~height"]){this.oEditor.SetConfigHeight(this.params["~height"]);this.oEditor.ResizeSceleton()}if(this.urlPreview){this.urlPreview.detachUrlPreview();var o;for(var a in t){if(t.hasOwnProperty(a)&&t[a].hasOwnProperty("USER_TYPE_ID")&&t[a]["USER_TYPE_ID"]==="url_preview"){o=t[a]["VALUE"]}}if(o)this.urlPreview.attachUrlPreview({id:o})}},Parse:function(e,t,i){var n=this.parser[e],o=this;if(n){t=t.replace(n.regexp,function(t,a,s,r,d){var l=o.checkFile(s,e);if(l&&(l=l.file)&&l){var h="",f=l.isImage?o.parser.postimage.wysiwyg:n.wysiwyg;o.monitoringStart();if(l.fileType&&o.parser[l.fileType]&&o.parser[l.fileType].wysiwyg){f=o.parser[l.fileType].wysiwyg}if(l.isImage){r=parseInt(r);d=parseInt(d);h=r&&d?' width="'+r+'" height="'+d+'"':"";if(h===""&&l["width"]>0&&l["height"]>0){h=' style="width:'+l["width"]+"px;height:"+l["height"]+"px;\" onload=\"this.style.width='auto';this.style.height='auto';\""}}return f.replace("#ID#",i.SetBxTag(false,{tag:e,params:{value:s}})).replace("#NAME#",l.name).replace("#SRC#",l.src).replace("#LOWSRC#",l.lowsrc).replace("#ADDITIONAL#",h).replace("#WIDTH#",parseInt(r)).replace("#HEIGHT#",parseInt(d))}return t})}return t},Unparse:function(e,t){var i="",n=e.tag;if(this.parser[n]){var o=parseInt(t.node.hasAttribute("width")?t.node.getAttribute("width"):0),a=parseInt(t.node.hasAttribute("height")?t.node.getAttribute("height"):0),s="";if(o>0&&a>0){s=" WIDTH="+o+" HEIGHT="+a}i=this.parser[n]["code"].replace("#ID#",e.params.value).replace("#ADDITIONAL#",s).replace("#WIDTH#",o).replace("#HEIGHT#",a)}return i},OnShowLHE:function(e,t,i){var n=this.__divId;e=e===false?false:e==="hide"?"hide":e==="justShow"?"justShow":true;this.oEditor=this.oEditor||s.getEditor(this.oEditorId);if(!this.oEditor)return;this.oEditor.Init();var o=BX("micro"+n),a=this.eventNode;if(o){o.style.display=e===true||e==="justShow"?"none":"block"}if(e=="hide"){BX.onCustomEvent(this.eventNode,"OnBeforeHideLHE",[e,this]);if(this.eventNode.style.display=="none"){BX.onCustomEvent(this.eventNode,"OnAfterHideLHE",[e,this])}else{new BX["easing"]({duration:200,start:{opacity:100,height:this.eventNode.scrollHeight},finish:{opacity:0,height:20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){a.style.height=e.height+"px";a.style.opacity=e.opacity/100},complete:BX.proxy(function(){this.eventNode.style.cssText="";this.eventNode.style.display="none";BX.onCustomEvent(a,"OnAfterHideLHE",[e,this])},this)}).animate()}}else if(e){BX.onCustomEvent(this.eventNode,"OnBeforeShowLHE",[e,this]);if(e=="justShow"){this.eventNode.style.display="block";BX.onCustomEvent(this.eventNode,"OnAfterShowLHE",[e,this]);if(i!==false)this.oEditor.Focus()}else if(this.eventNode.style.display=="block"){BX.onCustomEvent(this.eventNode,"OnAfterShowLHE",[e,this]);if(i!==false)this.oEditor.Focus()}else{BX.adjust(this.eventNode,{style:{display:"block",overflow:"hidden",height:"20px",opacity:.1}});new BX["easing"]({duration:200,start:{opacity:10,height:20},finish:{opacity:100,height:a.scrollHeight},transition:BX["easing"].makeEaseOut(BX.easing.transitions.quad),step:function(e){a.style.height=e.height+"px";a.style.opacity=e.opacity/100},complete:BX.proxy(function(){BX.onCustomEvent(a,"OnAfterShowLHE",[e,this]);this.oEditor.Focus();this.eventNode.style.cssText=""},this)}).animate()}}else{BX.onCustomEvent(this.eventNode,"OnBeforeHideLHE",[e,this]);this.eventNode.style.display="none";BX.onCustomEvent(this.eventNode,"OnAfterHideLHE",[e,this])}},OnButtonClick:function(e){if(e!=="cancel"){var t={result:true};BX.onCustomEvent(this.eventNode,"OnClickBeforeSubmit",[this,t]);if(t["result"]!==false)BX.onCustomEvent(this.eventNode,"OnClickSubmit",[this])}else{BX.onCustomEvent(this.eventNode,"OnClickCancel",[this]);BX.onCustomEvent(this.eventNode,"OnShowLHE",["hide"])}},OnEditorInitedBefore:function(e){var t=this;this.oEditor=e;e.formID=this.formID;if(this.params)this.params["~height"]=e.config["height"];BX.addCustomEvent(e,"OnCtrlEnter",function(){e.SaveContent();if(t.params&&t.params["ctrlEnterHandler"]&&typeof window[t.params["ctrlEnterHandler"]]=="function")window[t.params["ctrlEnterHandler"]]();else BX.submit(BX(t.formID))});var i=this.params.parsers?this.params.parsers:[];if(BX.util.object_search("Spoiler",i)){e.AddButton({id:"spoiler",name:BX.message("spoilerText"),iconClassName:"spoiler",disabledForTextarea:false,src:BX.message("MPF_TEMPLATE_FOLDER")+"/images/lhespoiler.png",toolbarSort:205,handler:function(){var e=this,t=false;if(!e.editor.bbCode||!e.editor.synchro.IsFocusedOnTextarea()){t=e.editor.action.actions.formatBlock.exec("formatBlock","blockquote","bx-spoiler",false,{bxTagParams:{tag:"spoiler"}})}else{t=e.editor.action.actions.formatBbCode.exec("quote",{tag:"SPOILER"})}return t}});e.AddParser({name:"spoiler",obj:{Parse:function(e,t,i){if(/\[(cut|spoiler)(([^\]])*)\]/gi.test(t)){t=t.replace(/[\001-\006]/gi,"").replace(/\[cut(((?:=)[^\]]*)|)\]/gi,"$1").replace(/\[\/cut]/gi,"").replace(/\[spoiler([^\]]*)\]/gi,"$1").replace(/\[\/spoiler]/gi,"");var n=/(?:\001([^\001]*)\001)([^\001-\004]+)\002/gi,o=/(?:\003([^\003]*)\003)([^\001-\004]+)\004/gi,a=function(e,t){e=e.replace(/^(="|='|=)/gi,"").replace(/("|')?$/gi,"");return'<blockquote class="bx-spoiler" id="'+i.SetBxTag(false,{tag:"spoiler"})+'" title="'+e+'">'+t+"</blockquote>"},s=function(e,t,i){return a(t,i)};while(t.match(n)||t.match(o)){t=t.replace(n,s).replace(o,s)}}t=t.replace(/\001([^\001]*)\001/gi,"[cut$1]").replace(/\003([^\003]*)\003/gi,"[spoiler$1]").replace(/\002/gi,"[/cut]").replace(/\004/gi,"[/spoiler]");return t},UnParse:function(t,i){if(t.tag=="spoiler"){var n="",o;for(o=0;o<i.node.childNodes.length;o++){n+=e.bbParser.GetNodeHtml(i.node.childNodes[o])}n=BX.util.trim(n);if(n!="")return"[SPOILER"+(i.node.hasAttribute("title")?"="+i.node.getAttribute("title"):"")+"]"+n+"[/SPOILER]"}return""}}})}if(BX.util.object_search("MentionUser",i)){e.AddParser({name:"postuser",obj:{Parse:function(t,i){i=i.replace(/\[USER\s*=\s*(\d+)\]((?:\s|\S)*?)\[\/USER\]/gi,function(t,i,n){n=BX.util.trim(n);if(n=="")return"";return'<span id="'+e.SetBxTag(false,{tag:"postuser",params:{value:parseInt(i)}})+'" class="bxhtmled-metion">'+n+"</span>"});return i},UnParse:function(t,i){if(t.tag=="postuser"){var n="",o;for(o=0;o<i.node.childNodes.length;o++){n+=e.bbParser.GetNodeHtml(i.node.childNodes[o])}n=BX.util.trim(n);if(n!="")return"[USER="+t.params.value+"]"+n+"[/USER]"}return""}}})}var n=function(i,n){return t.Parse(i,n,e)},o=function(e,i){return t.Unparse(e,i)};for(var a in this.parser){if(this.parser.hasOwnProperty(a)){e.AddParser({name:a,obj:{Parse:n,UnParse:o}})}}if(this.showPinButton){this.pinEditorPanel=this.params&&this.params.pinEditorPanel===true;var s="toolbar_pin";var r=function(e,i){r.superclass.constructor.apply(this,arguments);this.id=s;this.title=BX.message("MPF_PIN_EDITOR_PANNEL");this.className+=" "+(t.pinEditorPanel?"bxhtmled-button-toolbar-pined":"bxhtmled-button-toolbar-pin");this.Create();if(i)i.appendChild(this.GetCont())};BX.extend(r,window.BXHtmlEditor.Button);r.prototype.OnClick=function(){BX.removeClass(this.pCont,"bxhtmled-button-toolbar-pined");BX.removeClass(this.pCont,"bxhtmled-button-toolbar-pin");if(t.pinEditorPanel){t.pinEditorPanel=false;BX.addClass(this.pCont,"bxhtmled-button-toolbar-pin")}else{t.pinEditorPanel=true;BX.addClass(this.pCont,"bxhtmled-button-toolbar-pined")}BX.userOptions.save("main.post.form","postEdit","pinEditorPanel",t.pinEditorPanel?"Y":"N")};window.BXHtmlEditor.Controls[s]=r;BX.addCustomEvent(e,"GetControlsMap",function(e){e.push({id:s,compact:true,hidden:false,sort:500,checkWidth:true,offsetWidth:32,wrap:"right"})})}},OnEditorInitedAfter:function(t){BX.addCustomEvent(t,"OnIframeDrop",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDrop",arguments)},this));BX.addCustomEvent(t,"OnIframeDragOver",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDragOver",arguments)},this));BX.addCustomEvent(t,"OnIframeDragLeave",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnIframeDragLeave",arguments)},this));BX.addCustomEvent(t,"OnImageDataUriHandle",BX.proxy(function(){BX.onCustomEvent(this.eventNode,"OnImageDataUriHandle",arguments)},this));BX.addCustomEvent(t,"OnAfterUrlConvert",this.OnAfterUrlConvert.bind(this));BX.addCustomEvent(t,"OnBeforeCommandExec",this.OnBeforeCommandExec.bind(this));t.contextMenu.items["postimage"]=t.contextMenu.items["postdocument"]=t.contextMenu.items["postfile"]=[{TEXT:BX.message("BXEdDelFromText"),bbMode:true,ACTION:function(){var e=t.contextMenu.GetTargetItem("postimage");if(!e)e=t.contextMenu.GetTargetItem("postdocument");if(!e)e=t.contextMenu.GetTargetItem("postfile");if(e&&e.element){t.selection.RemoveNode(e.element)}t.contextMenu.Hide()}}];if(!this.params["lazyLoad"]){BX.onCustomEvent(this.eventNode,"OnShowLHE",["justShow",t,false])}if(t.toolbar.controls&&t.toolbar.controls.FontSelector){t.toolbar.controls.FontSelector.SetWidth(45)}BX.addCustomEvent(BX(this.formID),"onAutoSavePrepare",function(e){var i=e;setTimeout(function(){BX.addCustomEvent(t,"OnContentChanged",BX.proxy(function(e){this["mpfTextContent"]=e;this.Init()},i))},1500)});BX.addCustomEvent(BX(this.formID),"onAutoSave",BX.proxy(function(e,t){if(BX.type.isNotEmptyString(e["mpfTextContent"]))t["text"+this.formID]=e["mpfTextContent"]},this));BX.addCustomEvent(BX(this.formID),"onAutoSaveRestore",BX.proxy(function(i,n){if(e.handler[t.id]){for(var o in e.handler[t.id].controllers){if(e.handler[t.id].controllers.hasOwnProperty(o)&&e.handler[t.id].controllers[o].handler&&e.handler[t.id].controllers[o].handler.params&&e.handler[t.id].controllers[o].handler.params.controlName&&e.handler[t.id].controllers[o].handler.params.controlName){delete n[e.handler[t.id].controllers[o].handler.params.controlName]}}}if(n["text"+this.formID]&&/[^\s]+/gi.test(n["text"+this.formID])){t.CheckAndReInit(n["text"+this.formID])}},this));if(BX(this.formID)&&BX(this.formID).hasAttribute("bx-lhe-autosave-prepared")&&BX(this.formID).BXAUTOSAVE){BX(this.formID).removeAttribute("bx-lhe-autosave-prepared");setTimeout(BX.proxy(function(){BX(this.formID).BXAUTOSAVE.Prepare()},this),100)}var i=this.formID,n=this.params;this.showPanelEditor(n.showPanelEditor,false);if(!t.mainPostFormCustomized){t.mainPostFormCustomized=true;BX.addCustomEvent(t,"OnIframeKeydown",function(e){if(window.onKeyDownHandler){window.onKeyDownHandler(e,t,i)}});BX.addCustomEvent(t,"OnIframeKeyup",function(e){if(window.onKeyUpHandler){window.onKeyUpHandler(e,t,i)}});if(window["BXfpdStopMent"+i]){BX.addCustomEvent(t,"OnIframeClick",function(){window["BXfpdStopMent"+i]()})}if(t&&t.textareaView.GetCursorPosition){BX.addCustomEvent(t,"OnTextareaKeyup",function(e){if(window.onTextareaKeyUpHandler){window.onTextareaKeyUpHandler(e,t,i)}});BX.addCustomEvent(t,"OnTextareaKeydown",function(e){if(window.onTextareaKeyDownHandler){window.onTextareaKeyDownHandler(e,t,i)}})}}},OnAfterUrlConvert:function(e){if(this.urlPreview){this.urlPreview.attachUrlPreview({url:e})}},OnBeforeCommandExec:function(e,t,i,n){if(this.urlPreview&&t=="createLink"&&BX.type.isPlainObject(n)&&n.hasOwnProperty("href")){this.urlPreview.attachUrlPreview({url:n.href})}}};s.getEditor=function(e){return window["BXHtmlEditor"]?window["BXHtmlEditor"].Get(typeof e=="object"?e.id:e):null};s.getHandler=function(t){return e.handler[typeof t=="object"?t.id:t]};s.unsetHandler=function(t){var i=typeof t=="object"?t.id:t;if(!e.handler[i])return;if(e.handler[i].oEditor)e.handler[i].oEditor.Destroy();e.handler[i]=null};s.reinitData=function(e,t,i){var n=s.getHandler(e);if(n)n.exec(n.reinit,[t,i]);return false};s.reinitDataBefore=function(e){var t=s.getHandler(e);if(t&&t["eventNode"])BX.onCustomEvent(t.eventNode,"onReinitializeBefore",[t])};window.LHEPostForm=s;window.BXPostFormTags=function(e,t){this.popup=null;this.formID=e;this.buttonID=t;this.sharpButton=null;this.addNewLink=null;this.tagsArea=null;this.hiddenField=null;this.popupContent=null;BX.ready(BX.proxy(this.init,this))};window.BXPostFormTags.prototype.init=function(){this.sharpButton=BX(this.buttonID);this.addNewLink=BX("post-tags-add-new-"+this.formID);this.tagsArea=BX("post-tags-block-"+this.formID);this.tagsContainer=BX("post-tags-container-"+this.formID);this.hiddenField=BX("post-tags-hidden-"+this.formID);this.popupContent=BX("post-tags-popup-content-"+this.formID);this.popupInput=BX.findChild(this.popupContent,{tag:"input"});var e=BX.findChildren(this.tagsContainer,{className:"feed-add-post-del-but"},true);for(var t=0,i=e.length;t<i;t++){BX.bind(e[t],"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:e[t].parentNode,tagValue:e[t].parentNode.getAttribute("data-tag")}))}BX.bind(this.sharpButton,"click",BX.proxy(this.onButtonClick,this));BX.bind(this.addNewLink,"click",BX.proxy(this.onAddNewClick,this))};window.BXPostFormTags.prototype.onTagDelete=function(){BX.remove(this.tagBox);this.obj.hiddenField.value=this.obj.hiddenField.value.replace(this.tagValue+",","").replace("  "," ")};window.BXPostFormTags.prototype.show=function(){if(this.popup===null){this.popup=new BX.PopupWindow("bx-post-tag-popup",this.addNewLink,{content:this.popupContent,lightShadow:false,offsetTop:8,offsetLeft:10,autoHide:true,angle:true,closeByEsc:true,zIndex:-840,buttons:[new BX.PopupWindowButton({text:BX.message("TAG_ADD"),events:{click:BX.proxy(this.onTagAdd,this)}})]});BX.bind(this.popupInput,"keydown",BX.proxy(this.onKeyPress,this));BX.bind(this.popupInput,"keyup",BX.proxy(this.onKeyPress,this))}this.popup.show();BX.focus(this.popupInput)};window.BXPostFormTags.prototype.addTag=function(e){var t=BX.type.isNotEmptyString(e)?e.split(","):this.popupInput.value.split(",");var i=[];for(var n=0;n<t.length;n++){var o=BX.util.trim(t[n]);if(o.length>0){var a=this.hiddenField.value.split(",");if(!BX.util.in_array(o,a)){var s;var r=BX.create("span",{children:[s=BX.create("span",{attrs:{class:"feed-add-post-del-but"}})],attrs:{class:"feed-add-post-tags"}});r.insertBefore(document.createTextNode(o),s);this.tagsContainer.insertBefore(r,this.addNewLink);BX.bind(s,"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:r,tagValue:o}));this.hiddenField.value+=o+",";i.push(o)}}}return i};window.BXPostFormTags.prototype.onTagAdd=function(){this.addTag();this.popupInput.value="";this.popup.close()};window.BXPostFormTags.prototype.onAddNewClick=function(e){e=e||window.event;this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onButtonClick=function(e){e=e||window.event;BX.show(this.tagsArea);this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onKeyPress=function(e){e=e||window.event;var t=e.keyCode?e.keyCode:e.which?e.which:null;if(t==13){setTimeout(BX.proxy(this.onTagAdd,this),0)}};window.BXPostFormImportant=function(e,t,i){if(i){this.formID=e;this.buttonID=t;this.inputName=i;this.fireButton=null;this.activeBlock=null;this.hiddenField=null;BX.ready(BX.proxy(this.init,this))}return false};window.BXPostFormImportant.prototype.init=function(){this.fireButton=BX(this.buttonID);this.activeBlock=BX(this.buttonID+"-active");var e=BX(this.formID);if(e){this.hiddenField=e[this.inputName];if(this.hiddenField&&this.hiddenField.value==1){this.showActive()}}BX.bind(this.fireButton,"click",BX.proxy(function(e){e=e||window.event;this.showActive();BX.PreventDefault(e)},this));BX.bind(this.activeBlock,"click",BX.proxy(function(e){e=e||window.event;this.hideActive();BX.PreventDefault(e)},this))};window.BXPostFormImportant.prototype.showActive=function(e){BX.hide(this.fireButton);BX.show(this.activeBlock,"inline-block");if(this.hiddenField){this.hiddenField.value=1}return false};window.BXPostFormImportant.prototype.hideActive=function(e){BX.hide(this.activeBlock);BX.show(this.fireButton,"inline-block");if(this.hiddenField){this.hiddenField.value=0}return false};var r=null;window.MPFbuttonShowWait=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||this;e=e?e.tagName=="A"?e:e.parentNode:e;if(e){BX.addClass(e,"ui-btn-clock");r=e;BX.defer(function(){e.disabled=true})()}};window.MPFbuttonCloseWait=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||r||this;if(e){e.disabled=false;BX.removeClass(e,"ui-btn-clock");r=null}};window.__mpf_wd_getinfofromnode=function(e,t){var i=BX.findChild(BX((e["prefixNode"]||"wd-doc")+e.element_id),{className:"files-preview",tagName:"IMG"},true,false);if(i){e.lowsrc=i.src;e.element_url=i.src.replace(/\Wwidth=(\d+)/,"").replace(/\Wheight\=(\d+)/,"");e.width=parseInt(i.getAttribute("data-bx-full-width"));e.height=parseInt(i.getAttribute("data-bx-full-height"))}else if(t.urlGet){e.element_url=t.urlGet.replace("#element_id#",e.element_id).replace("#ELEMENT_ID#",e.element_id).replace("#element_name#",e.element_name).replace("#ELEMENT_NAME#",e.element_name)}};var d={listen:false,plus:false,text:"",bSearch:false};window.BXfpdSelectCallback=function(e,t,i,n,o,a){BX.SocNetLogDestination.BXfpSelectCallback({item:e,type:t,bUndeleted:n,containerInput:BX("feed-add-post-destination-item"),valueInput:BX("feed-add-post-destination-input"),formName:o,tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2"),state:typeof a!="undefined"?a:null})};window.BXfpdUnSelectCallback=function(e,t,i,n){BX.SocNetLogDestination.BXfpUnSelectCallback.call({formName:n,inputContainerName:"feed-add-post-destination-item",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")},e)};window.BXfpdOpenDialogCallback=function(e){BX.SocNetLogDestination.BXfpOpenDialogCallback.call({inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})};window.BXfpdCloseDialogCallback=function(e){BX.SocNetLogDestination.BXfpCloseDialogCallback.call({inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})};window.BXfpdCloseSearchCallback=function(e){BX.SocNetLogDestination.BXfpCloseSearchCallback.call({inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})};window.onKeyDownHandler=function(e,t,i){var n=e.keyCode;if(!window["BXfpdStopMent"+i])return true;if(BX.util.in_array(n,[107,187])||(e.shiftKey||e.modifiers>3)&&BX.util.in_array(n,[50,43,61])||e.altKey&&BX.util.in_array(n,[76])){setTimeout(function(){var e=t.selection.GetRange(),n=t.GetIframeDoc(),o=e?e.endContainer.textContent:"",a=o?o.slice(e.endOffset-1,e.endOffset):"",s=o?o.slice(e.endOffset-2,e.endOffset-1):"";if((a=="@"||a=="+")&&(!s||BX.util.in_array(s,["+","@",",","("])||s.length==1&&BX.util.trim(s)==="")){d.listen=true;d.listenFlag=true;d.text="";d.leaveContent=true;e.setStart(e.endContainer,e.endOffset-1);e.setEnd(e.endContainer,e.endOffset);t.selection.SetSelection(e);var r=BX.create("SPAN",{props:{id:"bx-mention-node"}},n);t.selection.Surround(r,e);e.setStart(r,1);e.setEnd(r,1);t.selection.SetSelection(e);if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i],{bindNode:l(r,t)})}}},10)}if(d.listen){var o=d.bSearch?"search":BX.SocNetLogDestination.obTabSelected[window["BXSocNetLogDestinationFormNameMent"+i]];if(n==t.KEY_CODES["enter"]){BX.SocNetLogDestination.selectCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i]);t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["left"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"left");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["right"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"right");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["up"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"up");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}else if(n==t.KEY_CODES["down"]){BX.SocNetLogDestination.moveCurrentItem(o,window["BXSocNetLogDestinationFormNameMent"+i],"down");t.iframeKeyDownPreventDefault=true;BX.PreventDefault(e)}}if(!d.listen&&d.listenFlag&&n===t.KEY_CODES["enter"]){var a=t.selection.GetRange();if(a.collapsed){var s=a.endContainer,r=t.GetIframeDoc();if(s){if(s.className!=="bxhtmled-metion"){s=BX.findParent(s,function(e){return e.className=="bxhtmled-metion"},r.body)}if(s&&s.className=="bxhtmled-metion"){t.selection.SetAfter(s)}}}}};window.onKeyUpHandler=function(e,t,i){var n=e.keyCode,o,a,s;if(!window["BXfpdStopMent"+i])return true;if(d.listen===true){if(n==t.KEY_CODES["escape"]){window["BXfpdStopMent"+i]()}else if(n!==t.KEY_CODES["enter"]&&n!==t.KEY_CODES["left"]&&n!==t.KEY_CODES["right"]&&n!==t.KEY_CODES["up"]&&n!==t.KEY_CODES["down"]){o=t.GetIframeDoc();var r=o.getElementById("bx-mention-node");if(r){s=BX.util.trim(t.util.GetTextContent(r));var h=s;s=s.replace(/^[\+@]*/,"");d.bSearch=s.length>0;BX.SocNetLogDestination.search(s,true,window["BXSocNetLogDestinationFormNameMent"+i],BX.message("MPF_NAME_TEMPLATE"),{bindNode:l(r,t)});if(d.leaveContent&&d._lastText&&h===""){window["BXfpdStopMent"+i]()}else if(d.leaveContent&&d.lastText&&h!==""&&s===""){d.bSearch=false;window["BXfpdStopMent"+i]();BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i],{bindNode:l(r,t)})}d.lastText=s;d._lastText=h}else{window["BXfpdStopMent"+i]()}}}else{if(!e.shiftKey&&(n===t.KEY_CODES["space"]||n===t.KEY_CODES["escape"]||n===188||n===190)){a=t.selection.GetRange();if(a.collapsed){var f=a.endContainer;o=t.GetIframeDoc();if(f){if(f.className!=="bxhtmled-metion"){f=BX.findParent(f,function(e){return e.className=="bxhtmled-metion"},o.body)}if(f&&f.className=="bxhtmled-metion"){s=t.util.GetTextContent(f);var u=s.match(/[\s\.\,]$/);if(u||n===t.KEY_CODES["escape"]){f.innerHTML=s.replace(/[\s\.\,]$/,"");var c=BX.create("SPAN",{html:u||t.INVISIBLE_SPACE},o);t.util.InsertAfter(c,f);t.selection.SetAfter(c)}}}}}}};window.onTextareaKeyDownHandler=function(e,t,i){var n=e.keyCode;if(d.listen&&n==t.KEY_CODES["enter"]){BX.SocNetLogDestination.selectFirstSearchItem(window["BXSocNetLogDestinationFormNameMent"+i]);t.textareaKeyDownPreventDefault=true;BX.PreventDefault(e)}};window.onTextareaKeyUpHandler=function(e,t,i){var n,o,a=e.keyCode;if(d.listen===true){if(a==27){window["BXfpdStopMent"+i]()}else if(a!==13){o=t.textareaView.GetValue(false);n=t.textareaView.GetCursorPosition();if(o.indexOf("+")!==-1||o.indexOf("@")!==-1){var s=o.substr(0,n),r=Math.max(s.lastIndexOf("+"),s.lastIndexOf("@"));if(r>=0){var l=s.substr(r),h=l;l=l.replace(/^[\+@]*/,"");if(BX.SocNetLogDestination&&!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i])}d.bSearch=l.length>0;if(BX.SocNetLogDestination)BX.SocNetLogDestination.search(l,true,window["BXSocNetLogDestinationFormNameMent"+i],BX.message("MPF_NAME_TEMPLATE"));if(d.leaveContent&&d._lastText&&h===""){window["BXfpdStopMent"+i]()}else if(d.leaveContent&&d.lastText&&h!==""&&l===""){window["BXfpdStopMent"+i]();if(BX.SocNetLogDestination)BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i])}d.lastText=l;d._lastText=h}}}}else{if(a==16){var f=this;this.shiftPressed=true;if(this.shiftTimeout)this.shiftTimeout=clearTimeout(this.shiftTimeout);this.shiftTimeout=setTimeout(function(){f.shiftPressed=false},100)}if(a==107||(e.shiftKey||e.modifiers>3||this.shiftPressed)&&BX.util.in_array(a,[187,50,107,43,61])){n=t.textareaView.element.selectionStart;if(n>0){o=t.textareaView.element.value;var u=o.substr(n-1,1);if(u&&(u==="+"||u==="@")){d.listen=true;d.listenFlag=true;d.text="";d.textarea=true;if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+i])}}}}}};var l=function(e,t){var i=BX.pos(e),n=BX.pos(t.dom.areaCont),o=BX.GetWindowScrollPos(t.GetIframeDoc()),a=n.top+i.bottom-o.scrollTop+2,s=n.left+i.right-o.scrollLeft;return{top:a,left:s}};window.BxInsertMention=function(e){var t=e.item,i=e.type,n=e.formID,o=e.editorId,a=e.bNeedComa,r=s.getEditor(o),l;if(i=="users"&&t&&t.entityId>0&&r){if(r.GetViewMode()=="wysiwyg"){var h=r.GetIframeDoc(),f=r.selection.GetRange(),u=h.getElementById("bx-mention-node"),c=BX.create("SPAN",{props:{className:"bxhtmled-metion"},text:BX.util.htmlspecialcharsback(t.name)},h);l=BX.create("SPAN",{html:a?",&nbsp;":"&nbsp;"},h);r.SetBxTag(c,{tag:"postuser",params:{value:t.entityId}});if(u){r.util.ReplaceNode(u,c)}else{r.selection.InsertNode(c,f)}if(c&&c.parentNode){var p=BX.findParent(c,{className:"bxhtmled-metion"},h.body);if(p){r.util.InsertAfter(c,p)}}if(c&&c.parentNode){r.util.InsertAfter(l,c);r.selection.SetAfter(l)}}else if(r.GetViewMode()=="code"&&r.bbCode){r.textareaView.Focus();var m=r.textareaView.GetValue(false),B=r.textareaView.GetCursorPosition(),g=m.substr(0,B),X=Math.max(g.lastIndexOf("+"),g.lastIndexOf("@"));if(X>=0&&B>X){r.textareaView.SetValue(m.substr(0,X)+m.substr(B));r.textareaView.element.setSelectionRange(X,X)}r.textareaView.WrapWith(false,false,"[USER="+t.entityId+"]"+t.name+"[/USER]"+(a?", ":" "))}if(e.fireAddEvent===true){BX.onCustomEvent(window,"onMentionAdd",[t])}delete BX.SocNetLogDestination.obItemsSelected[window["BXSocNetLogDestinationFormNameMent"+n]][t.id];window["BXfpdStopMent"+n]();d["text"]="";if(r.GetViewMode()=="wysiwyg"){r.Focus();r.selection.SetAfter(l)}}};window.MPFMentionInit=function(e,t){if(!t["items"]["departmentRelation"]){t["items"]["departmentRelation"]=BX.SocNetLogDestination.buildDepartmentRelation(t["items"]["department"])}window["departmentRelation"]=t["items"]["departmentRelation"];if(t.initDestination===true){window.BXSocNetLogDestinationFormName="destination"+(""+(new Date).getTime()).substr(6);window.BXSocNetLogDestinationDisableBackspace=null;BX.SocNetLogDestination.init({name:window.BXSocNetLogDestinationFormName,searchInput:BX("feed-add-post-destination-input"),extranetUser:t["extranetUser"],bindMainPopup:{node:BX("feed-add-post-destination-container"),offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:BX("feed-add-post-destination-container"),offsetTop:"5px",offsetLeft:"15px"},callback:{select:window.BXfpdSelectCallback,unSelect:BX.delegate(BX.SocNetLogDestination.BXfpUnSelectCallback,{formName:window.BXSocNetLogDestinationFormName,inputContainerName:"feed-add-post-destination-item",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")}),openDialog:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}),closeDialog:BX.delegate(BX.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}),openSearch:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:"feed-add-post-destination-input-box",inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"})},items:t["items"],itemsLast:t["itemsLast"],itemsSelected:t["itemsSelected"],isCrmFeed:t["isCrmFeed"],useClientDatabase:!!t["useClientDatabase"],destSort:t["destSort"],allowAddUser:t["allowAddUser"],allowAddCrmContact:t["allowAddCrmContact"],allowSearchCrmEmailUsers:typeof t["allowSearchCrmEmailUsers"]!="undefined"?!!t["allowSearchCrmEmailUsers"]:false,userNameTemplate:typeof t["userNameTemplate"]!="undefined"?t["userNameTemplate"]:"",allowSonetGroupsAjaxSearch:typeof t["allowSonetGroupsAjaxSearch"]!="undefined"?t["allowSonetGroupsAjaxSearch"]:false,allowSonetGroupsAjaxSearchFeatures:typeof t["allowSonetGroupsAjaxSearchFeatures"]!="undefined"?t["allowSonetGroupsAjaxSearchFeatures"]:{},showVacations:true,usersVacation:typeof t["usersVacation"]!="undefined"?t["usersVacation"]:{}});BX.bind(BX("feed-add-post-destination-input"),"keyup",BX.delegate(BX.SocNetLogDestination.BXfpSearch,{formName:window.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag"}));BX.bind(BX("feed-add-post-destination-input"),"paste",BX.defer(BX.SocNetLogDestination.BXfpSearch,{formName:window.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input",tagInputName:"bx-destination-tag",onPasteEvent:true}));BX.bind(BX("feed-add-post-destination-input"),"keydown",BX.delegate(BX.SocNetLogDestination.BXfpSearchBefore,{formName:window.BXSocNetLogDestinationFormName,inputName:"feed-add-post-destination-input"}));BX.bind(BX("feed-add-post-destination-input"),"blur",BX.delegate(BX.SocNetLogDestination.BXfpBlurInput,{inputBoxName:"feed-add-post-destination-input-box",tagInputName:"bx-destination-tag"}));BX.bind(BX("bx-destination-tag"),"focus",function(e){BX.SocNetLogDestination.openDialog(window.BXSocNetLogDestinationFormName,{bByFocusEvent:true});return BX.PreventDefault(e)});BX.bind(BX("feed-add-post-destination-container"),"click",function(e){BX.SocNetLogDestination.openDialog(window.BXSocNetLogDestinationFormName);return BX.PreventDefault(e)});BX.addCustomEvent(window,"onMentionAdd",function(e){if(!BX.type.isPlainObject(BX.SocNetLogDestination.obItems[window.BXSocNetLogDestinationFormName]["users"][e.id])){BX.SocNetLogDestination.obItems[window.BXSocNetLogDestinationFormName]["users"][e.id]=e}BX.addCustomEvent(window,"BX.SocNetLogDestination:onBeforeSelectItemFocus",function(e){if(e.id==window.BXSocNetLogDestinationFormName){e.blockFocus=true}});if(typeof BX.SocNetLogDestination.obItemsSelected[window.BXSocNetLogDestinationFormName][e.id]=="undefined"||!BX.SocNetLogDestination.obItemsSelected[window.BXSocNetLogDestinationFormName][e.id]){BX.SocNetLogDestination.selectItem(window.BXSocNetLogDestinationFormName,null,null,e.id,"users",false)}});if(t["itemsHidden"]){for(var i in t["itemsHidden"]){if(t["itemsHidden"].hasOwnProperty(i)){window.BXfpdSelectCallback({id:(typeof t["itemsHidden"][i]["PREFIX"]!="undefined"?t["itemsHidden"][i]["PREFIX"]:"SG")+t["itemsHidden"][i]["ID"],name:t["itemsHidden"][i]["NAME"]},typeof t["itemsHidden"][i]["TYPE"]!="undefined"?t["itemsHidden"][i]["TYPE"]:"sonetgroups","",true,"","init")}}}BX.SocNetLogDestination.BXfpSetLinkName({formName:window.BXSocNetLogDestinationFormName,tagInputName:"bx-destination-tag",tagLink1:BX.message("BX_FPD_LINK_1"),tagLink2:BX.message("BX_FPD_LINK_2")})}window["BXfpdSelectCallbackMent"+e]=function(i,n,o){window.BxInsertMention({item:i,type:n,formID:e,editorId:t.editorId,fireAddEvent:t.initDestination})};window["BXfpdStopMent"+e]=function(){BX.SocNetLogDestination.closeDialog();BX.SocNetLogDestination.closeSearch();clearTimeout(BX.SocNetLogDestination.searchTimeout);BX.SocNetLogDestination.searchOnSuccessHandle=false};window["BXfpdOnDialogOpen"+e]=function(){d.listen=true;d.listenFlag=true};window["BXfpdOnDialogClose"+e]=function(){d.listen=false;setTimeout(function(){d.listenFlag=false;if(!d.listen){var e=s.getEditor(t.editorId);if(e){var i=e.GetIframeDoc(),n=i.getElementById("bx-mention-node");if(n){e.selection.SetAfter(n);if(d.leaveContent){e.util.ReplaceWithOwnChildren(n)}else{BX.remove(n)}}e.Focus()}}},100)};window["BXSocNetLogDestinationFormNameMent"+e]="mention"+(""+(new Date).getTime()).substr(5);window["BXSocNetLogDestinationDisableBackspace"]=null;var n=BX("bx-b-mention-"+e);if(!t.extranetUser&&typeof t.items.extranetRoot!="undefined"){t["items"]["departmentExtranet"]=BX.clone(t["items"]["department"]);for(var o in t["items"]["extranetRoot"]){if(t["items"]["extranetRoot"].hasOwnProperty(o)){t["items"]["departmentExtranet"][o]=t["items"]["extranetRoot"][o]}}t["items"]["departmentRelationExtranet"]=BX.SocNetLogDestination.buildDepartmentRelation(t["items"]["departmentExtranet"])}BX.SocNetLogDestination.init({name:window["BXSocNetLogDestinationFormNameMent"+e],searchInput:n,extranetUser:t.extranetUser,bindMainPopup:{node:n,offsetTop:"1px",offsetLeft:"12px"},bindSearchPopup:{node:n,offsetTop:"1px",offsetLeft:"12px"},callback:{select:window["BXfpdSelectCallbackMent"+e],openDialog:window["BXfpdOnDialogOpen"+e],closeDialog:window["BXfpdOnDialogClose"+e],openSearch:window["BXfpdOnDialogOpen"+e],closeSearch:window["BXfpdOnDialogClose"+e]},items:{users:t["items"]["mentionUsers"],groups:{},sonetgroups:{},department:typeof t["items"]["departmentExtranet"]!="undefined"?t["items"]["departmentExtranet"]:t["items"]["department"],departmentRelation:typeof t["items"]["departmentRelationExtranet"]!="undefined"?t["items"]["departmentRelationExtranet"]:t["items"]["departmentRelation"]},itemsLast:{users:t["itemsLast"]["mentionUsers"],sonetgroups:{},department:{},groups:{}},itemsSelected:{},destSort:typeof t["mentionDestSort"]!="undefined"&&t["mentionDestSort"]?t["mentionDestSort"]:{},departmentSelectDisable:true,obWindowClass:"bx-lm-mention",obWindowCloseIcon:false,useClientDatabase:!!t["useClientDatabase"],userNameTemplate:typeof t["userNameTemplate"]!="undefined"?t["userNameTemplate"]:"",showVacations:false,showSearchInput:BX.browser.IsMobile()});BX.ready(function(){var i=BX("bx-b-mention-"+e);BX.bind(i,"mousedown",function(n){if(d.listen!==true){var o=s.getEditor(t.editorId),a=o.GetIframeDoc();if(o.GetViewMode()=="wysiwyg"&&a){d.listen=true;d.listenFlag=true;d.text="";d.leaveContent=false;var r=o.selection.GetRange(),l=a.getElementById("bx-mention-node");if(l){BX.remove(l)}o.InsertHtml('<span id="bx-mention-node">'+o.INVISIBLE_SPACE+"</span>",r);setTimeout(function(){if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+e],{bindNode:i})}var t=a.getElementById("bx-mention-node");if(t){r.setStart(t,0);if(t.firstChild&&t.firstChild.nodeType==3&&t.firstChild.nodeValue.length>0){r.setEnd(t,1)}else{r.setEnd(t,0)}o.selection.SetSelection(r)}o.Focus()},100)}else if(o.GetViewMode()=="code"){d.listen=true;d.listenFlag=true;d.text="";d.leaveContent=false;setTimeout(function(){if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(window["BXSocNetLogDestinationFormNameMent"+e],{bindNode:i})}},100)}BX.onCustomEvent(i,"mentionClick")}})})}})();
/* End */
;
; /* Start:"a:4:{s:4:"full";s:71:"/bitrix/components/bitrix/system.field.edit/script.min.js?1544127384814";s:6:"source";s:53:"/bitrix/components/bitrix/system.field.edit/script.js";s:3:"min";s:57:"/bitrix/components/bitrix/system.field.edit/script.min.js";s:3:"map";s:57:"/bitrix/components/bitrix/system.field.edit/script.map.js";}"*/
function addElement(e,n){if(document.getElementById("main_"+e)){var d=document.getElementById("main_"+e).getElementsByTagName("div");if(d&&d.length>0&&d[0]){var t=d[0].parentNode;t.appendChild(d[d.length-1].cloneNode(true))}}}function addElementFile(e,n){var d=document.getElementById("main_"+e);var t=document.getElementById("main_add_"+e);if(d&&t){t=t.cloneNode(true);t.id="";t.style.display="";d.appendChild(t)}}function addElementDate(e,n){var d=document.getElementById("date_container_"+n);var t=document.getElementById("hidden_"+n).innerHTML;if(d&&t){var a=e[n].fieldName;var i=e[n].index;t=t.replace(/[#]FIELD_NAME[#]/g,a+"["+i+"]");t=t.replace(/[\%]23FIELD_NAME[\%]23/g,escape(a+"["+i+"]"));var l=d.appendChild(document.createElement("DIV"));l.innerHTML+=t;e[n].index++}}
/* End */
;
; /* Start:"a:4:{s:4:"full";s:87:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js?154412740428279";s:6:"source";s:67:"/bitrix/components/bitrix/disk.uf.file/templates/.default/script.js";s:3:"min";s:0:"";s:3:"map";s:0:"";}"*/
(function(e){var t=false,i=false,s=0,o=null,a=null,n={};BX.namespace("BX.Disk");if(BX.Disk.UF)return;BX.Disk.UF=function(){var t=function(t){this.dialogName="DiskFileDialog";this.params=t;this.CID=t["UID"];this.controller=t.controller;this.values=t.values||[];this.prefix="diskuf-doc";this.onUploaderIsAlmostInited=BX.delegate(this.onUploaderIsAlmostInited,this);BX.addCustomEvent(e,"onUploaderIsAlmostInited",this.onUploaderIsAlmostInited);this.agent=BX.Uploader.getInstance({id:t["UID"],streams:3,allowUpload:"A",uploadFormData:"N",uploadMethod:"immediate",uploadFileUrl:t["urlUpload"],showImage:false,sortItems:false,input:t["input"],dropZone:t["dropZone"],placeHolder:t["placeHolder"],queueFields:{thumb:{tagName:"TR",className:"wd-inline-file"}},fields:{thumb:{tagName:"",template:BX.message("DISK_TMPLT_THUMB")}}});this.urlSelect=!!t["urlSelect"]?t["urlSelect"]:null;this.urlRenameFile=!!t["urlRenameFile"]?t["urlRenameFile"]:null;this.urlDeleteFile=!!t["urlDeleteFile"]?t["urlDeleteFile"]:null;this.urlSelect=this._addUrlParam(this.urlSelect,"dialog2=Y&ACTION=SELECT&MULTI=Y");this.urlUpload=!!t["urlUpload"]?t["urlUpload"]:null;this.urlShow=!!t["urlShow"]?t["urlShow"]:null;this.params.controlName=this.params.controlName||"FILES[]";this.init();return this};t.prototype={_addUrlParam:function(e,t){if(!e)return null;if(e.indexOf(t)==-1)e+=(e.indexOf("?")==-1?"?":"&")+t;return e},_camelToSNAKE:function(e){var t={},i,s;for(i in e){s=i.replace(/(.)([A-Z])/g,"$1_$2").toUpperCase();t[s]=e[i];t[i]=e[i]}return t},onUploaderIsAlmostInited:function(t,i){if(this.CID!=i["id"])return;BX.removeCustomEvent(e,"onUploaderIsAlmostInited",this.onUploaderIsAlmostInited);var s=BX.findChild(this.controller,{className:"diskuf-simple"},true),o=BX.findChild(this.controller,{className:"diskuf-extended"},true);if(t=="BX.UploaderSimple"){BX.remove(o);BX.show(s)}else{BX.remove(s);BX.show(o)}i.input=BX.findChild(this.controller,{className:"diskuf-fileUploader"},true);i.dropZone=BX.findChild(this.controller,{className:"diskuf-extended"},false);this.params.placeHolder=i["placeHolder"]=BX.findChild(this.controller,{className:"diskuf-placeholder-tbody"},true)},init:function(){this._onItemIsAdded=BX.delegate(this.onItemIsAdded,this);this._onFileIsAppended=BX.delegate(this.onFileIsAppended,this);this._onFileIsAttached=BX.delegate(this.onFileIsAttached,this);this._onFileIsBound=BX.delegate(this.onFileIsBound,this);this._onFileIsInited=BX.delegate(this.onFileIsInited,this);this._onError=BX.delegate(this.onError,this);BX.addCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded);BX.addCustomEvent(this.agent,"onFileIsInited",this._onFileIsInited);BX.addCustomEvent(this.agent,"onError",this._onError);this._onUploadProgress=BX.delegate(this.onUploadProgress,this);this._onUploadDone=BX.delegate(this.onUploadDone,this);this._onUploadError=BX.delegate(this.onUploadError,this);this._onUploadRestore=BX.delegate(this.onUploadRestore,this);BX.onCustomEvent(BX(this.controller.parentNode),"DiskDLoadFormControllerInit",[this]);var e=[],t=[],i;for(var s=0;s<this.values.length;s++){i=BX.findChild(this.values[s],{className:"f-wrap"},true);if(!!i){e.push({name:i.innerHTML});t.push(this.values[s])}}this.values=[];this.agent.onAttach(e,t);var o=BX.findChild(this.controller,{className:"diskuf-selector-link"},true);if(!!o){BX.bind(o,"click",BX.proxy(this.showSelectDialog,this))}var a=BX.findChildren(this.controller,{className:"diskuf-selector-link-cloud"},true);if(!!a){for(var n in a){if(!a.hasOwnProperty(n))continue;BX.bind(a[n],"click",BX.proxy(this.showSelectDialogCloudImport,this))}}return false},addFile:function(e){return this.agent&&this.agent.onChange([e])},onItemIsAdded:function(){BX.removeCustomEvent(this.agent,"onItemIsAdded",this._onItemIsAdded);BX.show(BX.findParent(this.params.placeHolder,{className:"diskuf-files-block"}))},onFileIsInited:function(e,t){BX.addCustomEvent(t,"onFileIsAttached",this._onFileIsAttached);BX.addCustomEvent(t,"onFileIsAfterCreated",function(e,t,i,s){if(t&&!t.sizeInt){e.size=" "}});BX.addCustomEvent(t,"onFileIsAppended",this._onFileIsAppended);BX.addCustomEvent(t,"onFileIsBound",this._onFileIsBound);BX.addCustomEvent(t,"onUploadProgress",this._onUploadProgress);BX.addCustomEvent(t,"onUploadDone",this._onUploadDone);BX.addCustomEvent(t,"onUploadError",this._onUploadError)},onFileIs:function(e,t,i){this.bindEventsHandlers(e,t,i);var s={element_id:i.element_id,element_name:i.element_name||t.name,element_url:i.element_name||i.previewUrl||i.preview_url,place:e,storage:"disk"};this.values.push(e);BX.onCustomEvent(this.params.controller.parentNode,"OnFileUploadSuccess",[s,this,t.file,t]);t.__disk_element_id=i.element_id;BX.onCustomEvent(t,"OnFileUploadSuccess",[s,this])},onFileIsAppended:function(e,t){var i=this.agent.getItem(e),s=i.node;this.bindEventsHandlers(s,t,{})},onFileIsBound:function(e,t){var i=this.agent.getItem(e),s=i.node,o=s.getAttribute("id").replace("disk-edit-attach","");this.onFileIs(s,t,{element_id:o})},onFileIsAttached:function(e,t,i,s){if(!!s["sizeFormatted"])s["size"]=s["sizeFormatted"];if(!s.hasOwnProperty("service")){this.onUploadDone(t,{file:s});return}BX.Disk.ExternalLoader.startLoad({file:{id:s.id,name:s.name,service:s.service},onFinish:BX.delegate(function(e){var i=this.agent.getItem(t.id).node;BX.hide(i);var s={id:e.ufId,name:e.name,storage:e.storage,ext:t.ext,size:e.sizeFormatted,previewUrl:e.previewUrl,preview_url:e.previewUrl,element_url:e.previewUrl,size_int:parseInt(e.size,10)};var o;var a=BX.message("DISK_TMPLT_THUMB2").replace("#control_name#",this.params.controlName).replace("#CONTROL_NAME#",this.params.controlName);for(var n in s){o=s[n];if(s.hasOwnProperty(n)){if(n.toLowerCase()=="size"){if(s.hasOwnProperty("size_int")){if(parseInt(s["size_int"],10)==0||isNaN(s["size_int"])){o=""}}if(s.hasOwnProperty("SIZE_INT")||isNaN(s["SIZE_INT"])){if(parseInt(s["SIZE_INT"],10)==0){o=""}}}a=a.replace(new RegExp("#"+n.toLowerCase()+"#","gi"),o).replace(new RegExp("#"+n.toUpperCase()+"#","gi"),o)}}var l={id:"disk-edit-attach"+s.id,"bx-agentFileId":t.id},r;r=BX.create("TR",{attrs:l,props:{className:"wd-inline-file"},html:a});var d=BX.findChild(r,{className:"files-name-edit-btn"},true);if(d){BX.remove(d)}i.parentNode.insertBefore(r,i);s.element_id=s.id;this.agent.onAttach([s],[r]);t.deleteFile()},this),onProgress:BX.delegate(function(e){this.onUploadProgress(t,e)},this)})},onUploadProgress:function(e,t){t=Math.min(t,98);var i=e.id;if(!e.__progressBarWidth)e.__progressBarWidth=5;if(t>e.__progressBarWidth){e.__progressBarWidth=Math.ceil(t);e.__progressBarWidth=e.__progressBarWidth>100?100:e.__progressBarWidth;if(BX("wdu"+i+"Progressbar"))BX.adjust(BX("wdu"+i+"Progressbar"),{style:{width:e.__progressBarWidth+"%"}});if(BX("wdu"+i+"ProgressbarText"))BX.adjust(BX("wdu"+i+"ProgressbarText"),{text:e.__progressBarWidth+"%"})}},onUploadDone:function(e,t){if(t["file"]&&t["file"]["attachId"]&&t["file"]["attachId"]!=t["file"]["id"]){t["file"]["id"]=t["file"]["attachId"];delete t["file"]["attachId"]}var i=this.agent.getItem(e.id).node,s=this._camelToSNAKE(t["file"]);if(BX(i)){var o=BX.message("DISK_TMPLT_THUMB2").replace("#control_name#",this.params.controlName).replace("#CONTROL_NAME#",this.params.controlName),a;for(var n in s){if(s.hasOwnProperty(n)){a=s[n];if(n.toLowerCase()=="size"){if(s.hasOwnProperty("size_int")){if(parseInt(s["size_int"],10)==0){a=""}}if(s.hasOwnProperty("SIZE_INT")){if(parseInt(s["SIZE_INT"],10)==0){a=""}}}if(n.toLowerCase()=="storage"&&a==="disk"){l(s.id).then(function(e){if(e.crumbs){var t=e.crumbs.join(" / ");var i=BX("disk-edit-attach"+s.id);if(i){var o=BX.findChild(i,{className:"files-placement"},true);if(o){BX.adjust(o,{text:t})}}}})}o=o.replace(new RegExp("#"+n.toLowerCase()+"#","gi"),a).replace(new RegExp("#"+n.toUpperCase()+"#","gi"),a)}}o=o.replace(new RegExp("#(width|height)#","gi"),"0").replace(new RegExp("#preview_url#","gi"),"javascript:void(0);");var r={id:"disk-edit-attach"+s.id,"bx-agentFileId":e.id},d;if(s["XML_ID"])r["bx-attach-xml-id"]=s["XML_ID"];if(s["FILE_ID"])r["bx-attach-file-id"]="n"+s["FILE_ID"];if(s["FILE_TYPE"])r["bx-attach-file-type"]=s["FILE_TYPE"];d=BX.create("TR",{attrs:r,props:{className:"wd-inline-file"},html:o});if(!t.file.canChangeName){var h=BX.findChild(d,{className:"files-name-edit-btn"},true);if(h){BX.remove(h)}}i.parentNode.replaceChild(d,i);s.element_id=s.id;this.onFileIs(d,e,s)}else{this.onUploadError(e,t,this.agent)}},onUploadError:function(e,t,i){var s=this.agent.getItem(e.id);if(!!s&&(s=s.node)&&BX(s)&&(i==true||!BX(s).hasAttribute("bx-disk-error"))){BX(s).setAttribute("bx-disk-error","Y");BX.adjust(s,{props:{className:"error-load"}});var o=t&&t["error"]?t["error"]:"Uploading error";s.cells[1].innerHTML="";s.cells[2].innerHTML='<span class="info-icon"></span><span class="error-text">'+o+"</span>";BX.onCustomEvent(e,"OnFileUploadFailed",[s,this]);BX.onCustomEvent(this.params.controller.parentNode,"OnFileUploadFailed",[s,this,e.file,e])}},onError:function(e,t,i){var s="Uploading error.",o=s,a,n;if(i){if(i["error"]&&typeof i["error"]=="string")o=i["error"];else if(i["message"]&&typeof i["message"]=="string")o=i["message"];else if(BX.type.isArray(i["errors"])&&i["errors"].length>0){o=[];for(var l=0;l<i["errors"].length;l++){if(typeof i["errors"][l]=="object"&&i["errors"][l]["message"])o.push(i["errors"][l]["message"])}if(o.length<=0)o.push("Uploading error.");o=o.join(" ")}}e.files=e.files||{};for(n in e.files){if(e.files.hasOwnProperty(n)){a=this.agent.queue.items.getItem(n);this.onUploadError(a,{error:o},o!=s)}}},onBlurRenameInput:function(e){var t=e.target||e.srcElement;var i=BX.findChild(t.parentNode,{className:"files-name-edit-btn"},true);if(!!i)BX.fireEvent(i,"click")},bindEventsHandlers:function(t,i,s){var o=s.element_id,a="file-action-control",n=BX.findChild(t,{className:"files-path"},true),l=BX.findChild(t,{className:"files-name-edit-btn"},true),r=BX.findChild(t,{className:"f-wrap"},true);if(!!l&&!!n&&!!r&&!n.getAttribute(a)){n.setAttribute(a,"enabled");BX.show(n,"inline");BX.hide(BX.findChild(t,{className:"files-placement"},true));BX.bind(n,"click",BX.delegate(function(){this.move(o,r.innerHTML,t)},this))}if(!!l){BX.bind(l,"click",BX.delegate(function(){BX.toggleClass(l.parentNode,"files-name-editable");this.rename(o,t)},this));var d=BX.findChild(t,{className:"files-name-edit-inp"},true);if(d){BX.bind(d,"keydown",BX.delegate(function(i){var s=(i||e.event).keyCode||(i||e.event).charCode;if(s==13){BX.unbind(d,"blur",BX.proxy(this.onBlurRenameInput,this));BX.toggleClass(l.parentNode,"files-name-editable");this.rename(o,t);return BX.PreventDefault(i)}if(s==27){BX.unbind(d,"blur",BX.proxy(this.onBlurRenameInput,this));BX.toggleClass(l.parentNode,"files-name-editable");this.revertRename(o,t);return BX.PreventDefault(i)}},this))}}var h=BX.findChild(t,{className:"feed-add-post-loading"},true),u=BX.delegate(function(){this.deleteFile(t,i)},this),c=BX.create("SPAN",{props:{className:"del-but"},events:{click:u}});if(!!h){var m=BX.findChild(h,{className:"del-but"},true);if(!!m)BX.bind(m,"click",u);else h.appendChild(c.cloneNode(true))}if(!BX.findChild(t,{className:"files-info"},true)){t.appendChild(BX.create("TD",{props:{className:"files-info"}}))}if(!BX.findChild(t,{className:"files-del-btn"},true)){t.appendChild(BX.create("TD",{props:{className:"files-del-btn"},children:[c]}))}if(!c.hasAttribute("bx-bound")){c.setAttribute("bx-bound","Y");BX.bind(c,"click",u);BX.onCustomEvent(t,"OnMkClose",[t])}var p=BX.findChild(t,{className:"transformer-upgrade-popup"},true);if(p){BX.show(p.parentNode);BX.bind(p,"click",BX.proxy(BX.Disk.UF.showTransformationUpgradePopup,this))}},deleteFile:function(e,t){if(!!t.__disk_element_id){BX.Disk.ajax({url:this.urlDeleteFile,method:"POST",dataType:"json",data:{attachedId:t.__disk_element_id},onsuccess:function(e){}});BX.onCustomEvent(this.controller.parentNode,"OnFileUploadRemove",[t.__disk_element_id,this])}BX.removeCustomEvent(t,"onFileIsAttached",this._onFileIsAttached);BX.removeCustomEvent(t,"onFileIsAppended",this._onFileIsAppended);BX.removeCustomEvent(t,"onFileIsBound",this._onFileIsBound);BX.removeCustomEvent(t,"onUploadProgress",this._onUploadProgress);BX.removeCustomEvent(t,"onUploadDone",this._onUploadDone);BX.removeCustomEvent(t,"onUploadError",this._onUploadError);delete t.hash;t.deleteFile("deleteFile");BX.remove(e)},move:function(e,t,i){var s=this._addUrlParam(this.urlSelect.replace("ACTION=SELECT","").replace("MULTI=Y",""),"ID=E"+e+"&NAME="+t+"&wish=fakemove");while(s.indexOf("&&")>=0)s=s.replace("&&","&");if(!this._checkFileName){this._checkFileName=BX.proxy(this.checkFileName,this);this._selectFolder=BX.proxy(this.selectFolder,this);this._openSection=BX.proxy(this.openSection,this);this._selectItem=BX.proxy(this.selectItem,this);this._unSelectItem=BX.proxy(this.unSelectItem,this)}var o=i||BX("disk-edit-attach"+e),a=BX.findChild(o,{className:"f-wrap"},true);BX.DiskFileDialog.arParams={};BX.DiskFileDialog.arParams[this.dialogName]={element_id:e,element_name:a.innerHTML};BX.addCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.addCustomEvent(BX.DiskFileDialog,"selectItem",this._selectItem);BX.addCustomEvent(BX.DiskFileDialog,"unSelectItem",this._unSelectItem);return BX.ajax.get(s,"dialogName="+this.dialogName,BX.delegate(function(){setTimeout(BX.delegate(function(){BX.DiskFileDialog.obCallback[this.dialogName]={saveButton:this._selectFolder};BX.DiskFileDialog.openDialog(this.dialogName)},this),100)},this))},rename:function(e,t){if(!this.urlRenameFile){return}var i=BX.findChild(t,{className:"files-name-editable"},true);var s=BX.findChild(t,{className:"files-name-edit-inp"},true);var o=BX.findChild(t,{className:"f-wrap"},true);var a=o.textContent||o.innerText;var n=a.split(".").pop();var l=s.value+"."+n;if(!!i){BX.focus(s);BX.bind(s,"blur",BX.proxy(this.onBlurRenameInput,this))}else if(s.value&&l!==a){BX.adjust(o,{text:l});var r=t.getAttribute("bx-agentFileId");var d=r?this.agent.getItem(r):null;if(!!d){d.item.file.name=l;d.item.name=l}var h=this.manager?this.manager.checkFile("disk_file"+e):null;if(!!h){h.name=l}BX.Disk.ajax({url:this.urlRenameFile,method:"POST",dataType:"json",data:{newName:l,attachedId:e},onsuccess:function(e){}})}},revertRename:function(e,t){if(!this.urlRenameFile){return}var i=BX.findChild(t,{className:"files-name-editable"},true);var s=BX.findChild(t,{className:"files-name-edit-inp"},true);var o=BX.findChild(t,{className:"f-wrap"},true);var a=o.textContent||o.innerText;var n=a.split(".");var l=n.pop();s.value=n.join(".")},showMovedFile:function(e,t,i){if(!e)return false;var s,o=e,a=BX("disk-edit-attach"+o),n=BX.findChild(a,{className:"files-path"},true);BX.cleanNode(n);i=i.split("/").join(" / ");n.innerHTML=i;var l=parseInt(n.offsetWidth);var r=parseInt(n.parentNode.offsetWidth)-150,d;s=r/(l/i.length);if(l>r){d=Math.floor(s/2)+1;i=i.substr(0,d)+" ... "+i.substr(i.length-d);n.innerHTML=i}var h=BX("diskuf-doc"+o);if(!!h){var u=this._fileUnserialize(h.value);u.section=t["sectionID"];u.iblock=t["iblockID"];h.value=this._fileSerialize(u)}return true},_fileUnserialize:function(e){if(!BX.type.isString(e))return false;var t=e.split("|");return{id:t[0]||0,section:t[1]||0,iblock:t[2]||0}},_fileSerialize:function(e){var t=[e.id,e.section,e.iblock];return t.join("|")},selectFolder:function(e,t,i,s){var o=false,a=false,n,l,r;if(BX.DiskFileDialog.arParams&&BX.DiskFileDialog.arParams[this.dialogName]&&BX.DiskFileDialog.arParams[this.dialogName]["element_id"])o=BX.DiskFileDialog.arParams[this.dialogName]["element_id"];var d=BX.delegate(function(e,t,i,s){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","moveUploadedFile"),data:{attachedId:e,targetFolderId:t},onsuccess:BX.delegate(function(t){if(!t||t.status!="success"){BX.Disk.showModalWithStatusAction(t);return}this.showMovedFile(e,i,s)},this)})},this);for(n in i){if(i.hasOwnProperty(n)&&i[n].type==="folder"){l=e.name+i[n].path;r={sectionID:n,iblockID:e.iblock_id};d(o,i[n].id,r,l);a=true}}if(!a){l=e.name;r={sectionID:e.section_id,iblockID:e.iblock_id};if(!!s&&!!s.path&&s.path!="/"){l+=s.path;r.sectionID=s.id;if(!!s){d(o,s.id,r,l)}}}BX.removeCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.removeCustomEvent(BX.DiskFileDialog,"loadItemsDone",this._checkFileName);BX.removeCustomEvent(BX.DiskFileDialog,"selectItem",this._selectItem);BX.removeCustomEvent(BX.DiskFileDialog,"unSelectItem",this._unSelectItem)},checkFileName:function(e){if(this.noticeTimeout){clearTimeout(this.noticeTimeout);this.noticeTimeout=null}if(!!e&&e!=this.dialogName)return;var t=BX.DiskFileDialog.arParams[this.dialogName]["element_name"];var i=false,s;for(s in BX.DiskFileDialog.obItems[this.dialogName]){if(BX.DiskFileDialog.obItems[this.dialogName].hasOwnProperty(s)){if(BX.DiskFileDialog.obItems[this.dialogName][s]["name"]==t)i=true;if(i)break}}if(i)BX.DiskFileDialog.showNotice(BX.message("DISK_FILE_EXISTS"),this.dialogName);else BX.DiskFileDialog.closeNotice(this.dialogName)},selectItem:function(e,t,i){if(i!=this.dialogName)return;var s=t.substr(1);var o=BX.DiskFileDialog.obCurrentTab[i].link;o=o.replace("/index.php","")+"/element/upload/"+s+"/?use_light_view=Y&AJAX_CALL=Y&SIMPLE_UPLOAD=Y&IFRAME=Y&sessid="+BX.bitrix_sessid()+"&SECTION_ID="+s+"&CHECK_NAME="+BX.DiskFileDialog.arParams[this.dialogName]["element_name"];o=o.replace("/files/lib/","/files/");BX.ajax.loadJSON(o,BX.delegate(function(e){var t=e.permission===true&&e["okmsg"]!="";if(this.noticeTimeout){clearTimeout(this.noticeTimeout);this.noticeTimeout=null}this.noticeTimeout=setTimeout(BX.delegate(function(){if(t){BX.DiskFileDialog.showNotice(this.msg.file_exists,this.dialogName)}else{BX.DiskFileDialog.closeNotice(this.dialogName)}},this),200)},this))},unSelectItem:function(){if(this.noticeTimeout){clearTimeout(this.noticeTimeout);this.noticeTimeout=null}this.noticeTimeout=setTimeout(BX.delegate(function(){this.checkFileName()},this),200)},openSection:function(e,t){if(t==this.dialogName){BX.DiskFileDialog.target[t]=this._addUrlParam(e,"dialog2=Y")}},openSectionCloud:function(e,t){if(t==this.dialogName){BX.DiskFileDialog.target[t]=this._addUrlParam(e,"dialog2=Y");BX.DiskFileDialog.target[t]=this._addUrlParam(BX.DiskFileDialog.target[t],"cloudImport=1")}},selectFile:function(e,t,i){var s=[],o;for(o in i){if(i.hasOwnProperty(o)){if(i[o].type=="file"&&!BX(this.prefix+o)){i[o].sizeFormatted=i[o]["size"];i[o].size=i[o]["sizeInt"];if(!i[o]["ext"])i[o]["ext"]=i[o]["name"].split(".").pop();if(!i[o]["storage"])i[o]["storage"]="";s.push(i[o])}}}this.agent.onAttach(s,s);BX.removeCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection)},selectCloudFile:function(e,t,i){var s=[],o;for(o in i){if(i.hasOwnProperty(o)){if(i[o].type=="file"&&!BX(this.prefix+o)){if(i[o].hasOwnProperty("provider")){i[o].service=i[o].provider}else{i[o].service=a}i[o].sizeFormatted=i[o]["size"];i[o].size=i[o]["sizeInt"];if(!i[o]["ext"])i[o]["ext"]=i[o]["name"].split(".").pop();if(!i[o]["storage"])i[o]["storage"]="";s.push(i[o])}}}this.agent.onAttach(s,s);BX.removeCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection)},showSelectDialog:function(){this._openSection=BX.proxy(this.openSection,this);this._selectFile=BX.proxy(this.selectFile,this);BX.addCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.ajax.get(this.urlSelect,"dialogName="+this.dialogName,BX.delegate(function(){setTimeout(BX.delegate(function(){BX.DiskFileDialog.obCallback[this.dialogName]={saveButton:this._selectFile};BX.DiskFileDialog.openDialog(this.dialogName)},this),10)},this))},showSelectDialogCloudImport:function(e){var t=e.target||e.srcElement;if(!BX.hasClass(t,"diskuf-selector-link-cloud")){t=BX.findParent(t,{className:"diskuf-selector-link-cloud"})}if(!t||!t.getAttribute("data-bx-doc-handler"))return;a=t.getAttribute("data-bx-doc-handler");this._openSection=BX.proxy(this.openSectionCloud,this);this._selectFile=BX.proxy(this.selectFile,this);this._selectCloudFile=BX.proxy(this.selectCloudFile,this);BX.addCustomEvent(BX.DiskFileDialog,"loadItems",this._openSection);BX.ajax.get(this.urlSelect,"&cloudImport=1&service="+a+"&dialogName="+this.dialogName,BX.delegate(function(){setTimeout(BX.delegate(function(){BX.DiskFileDialog.obCallback[this.dialogName]={saveButton:this._selectCloudFile};BX.DiskFileDialog.openDialog(this.dialogName)},this),10)},this))}};return t}();BX.Disk.UF.dndCatcher={};BX.Disk.UF.add=function(e){e["controller"]=BX("diskuf-selectdialog-"+e["UID"]);if(e["controller"]&&BX.isNodeInDom(e["controller"])){e["values"]=BX.findChildren(e["controller"],{className:"wd-inline-file"},true);var t=BX(e["controller"]).parentNode;BX.onCustomEvent(e["controller"],"DiskLoadFormControllerWasBound",[e,"DiskLoadFormControllerWasBound"]);if(!BX(e["controller"]).hasAttribute("bx-disk-load-is-bound")){BX(e["controller"]).setAttribute("bx-disk-load-is-bound","Y");BX.addCustomEvent(t,"DiskLoadFormController",function(t){BX.Disk.UF.initialize(t,e)})}if(!!e["values"]&&e["values"].length>0&&!e["hideSelectDialog"])BX.onCustomEvent(e["controller"].parentNode,"DiskLoadFormController",["show"])}};BX.Disk.UF.initialize=function(e,t){e=e==="show"||e==="hide"?e:t["controller"].style.display!="none"?"hide":"show";if(!t["controller"].loaded){t["controller"].loaded=true;n[t["UID"]]=new BX.Disk.UF(t)}if(e=="show"){if(t["controller"].style.display!="block"){BX.fx.show(t["controller"],"fade",{time:.2});if(t["switcher"]&&t["switcher"].style.display!="none")BX.fx.hide(t["switcher"],"fade",{time:.1});BX.onCustomEvent(t["controller"],"onControllerIsShown",[t["controller"],n[t["UID"]]]);o=n[t["UID"]]}}else if(t["controller"].style.display!="none"){o=null;BX.fx.hide(t["controller"],"fade",{time:.2});BX.onCustomEvent(t["controller"],"onControllerIsHidden",[t["controller"],n[t["UID"]]])}return n[t["UID"]]};var l=function(e){return BX.Disk.ajaxPromise({url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","getBreadcrumbs"),method:"POST",dataType:"json",data:{attachedId:e}})};var r=function(e){if(!BX(e)||e.hasAttribute("bx-is-bound"))return;e.setAttribute("bx-is-bound","Y");this.img=e;this.node=e.parentNode.parentNode.parentNode;BX.unbindAll(e);BX.unbindAll(this.node);BX.show(this.node);BX.remove(this.node.nextSibling);this.id="wufdp_"+Math.random();BX.bind(this.node,"mouseover",BX.delegate(function(){this.turnOn()},this));BX.bind(this.node,"mouseout",BX.delegate(function(){this.turnOff()},this))};r.prototype={turnOn:function(){this.timeout=setTimeout(BX.delegate(function(){this.show()},this),500)},turnOff:function(){clearTimeout(this.timeout);this.timeout=null;this.hide()},show:function(){if(this.popup!=null)this.popup.close();if(this.popup==null){var e={width:this.img.naturalWidth,height:this.img.naturalHeight};if(BX["UploaderUtils"]){var t=BX.UploaderUtils.scaleImage(e,{width:parseInt(BX.message("DISK_THUMB_WIDTH")),height:parseInt(BX.message("DISK_THUMB_HEIGHT"))});e=t.destin}this.popup=new BX.PopupWindow("bx-wufd-preview-img-"+this.id,this.img.parentNode,{lightShadow:true,offsetTop:-7,offsetLeft:(51-28)/2+14,autoHide:true,closeByEsc:true,bindOptions:{position:"top"},events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.proxy(function(){this.popup=null},this)},content:BX.create("DIV",{props:e,children:[BX.create("IMG",{props:e,attrs:{src:this.img.src}})]})});this.popup.show()}this.popup.setAngle({position:"bottom"});this.popup.bindOptions.forceBindPosition=true;this.popup.adjustPosition();this.popup.bindOptions.forceBindPosition=false},hide:function(){if(this.popup!=null)this.popup.close()}};BX.addCustomEvent("onDiskPreviewIsReady",function(e){new r(e)});BX.Disk.UF.runImport=function(e){BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_PROCESS_LOADING"),showLoaderIcon:true,autoHide:false});BX.Disk.ExternalLoader.reloadLoadAttachedObject({attachedObject:{id:e.id,name:e.name,service:e.service},onFinish:BX.delegate(function(e){if(e.hasOwnProperty("hasNewVersion")&&!e.hasNewVersion){BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_HAS_LAST_VERSION"),showSuccessIcon:true,autoHide:true})}else if(e.status==="success"){BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_SUCCESS_LOADING"),showSuccessIcon:true,autoHide:true})}else{BX.Disk.showActionModal({text:BX.message("DISK_UF_FILE_STATUS_FAIL_LOADING"),autoHide:true})}},this),onProgress:BX.delegate(function(e){},this)}).start()};BX.Disk.UF.disableAutoCommentToAttachedObject=function(e){var t=e.attachedId;BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","disableAutoCommentToAttachedObject"),data:{attachedId:t},onsuccess:BX.delegate(function(e){},this)})};BX.Disk.UF.enableAutoCommentToAttachedObject=function(e){var t=e.attachedId;BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam("/bitrix/tools/disk/uf.php","action","enableAutoCommentToAttachedObject"),data:{attachedId:t},onsuccess:BX.delegate(function(e){},this)})};BX.Disk.UF.showTransformationUpgradePopup=function(e){B24.licenseInfoPopup.show("disk_transformation_video_limit",BX.message("DISK_UF_CONTROLLER_TRANSFORMATION_UPGRADE_POPUP_TITLE"),BX.message("DISK_UF_CONTROLLER_TRANSFORMATION_UPGRADE_POPUP_CONTENT"),false)};e.DiskCreateDocument=function(e){if(!o){return false}if(!e){return false}var t=new BX.CViewer({createDoc:true});var i=t.createBlankElementByParams({docType:e,editUrl:BX.message("DISK_CREATE_BLANK_URL"),renameUrl:BX.message("DISK_RENAME_FILE_URL")});t.setCurrent(i);i.afterSuccessCreate=function(e){var t={};var i=e.name.split(".");i.pop();t["E"+e.objectId]={type:"file",id:"n"+e.objectId,name:e.name,label:i.join("."),storage:e.folderName,size:e.size,sizeInt:e.sizeInt,ext:e.extension,canChangeName:true,link:e.link};setTimeout(function(){o.selectFile({},{},t)},200)};t.runActionByCurrentElement("create",{obElementViewer:t});try{BX.PreventDefault()}catch(e){}return false};e.DiskOpenMenuCreateService=function(e){var t=new BX.CViewer({});t.openMenu("disk_open_menu_with_services",BX(e),[BX.CViewer.isDisabledLocalEdit?null:{text:BX.message("DISK_FOLDER_TOOLBAR_LABEL_LOCAL_BDISK_EDIT"),className:"bx-viewer-popup-item item-b24",href:"#",onclick:BX.delegate(function(t){if(BX.CViewer.isEnableLocalEditInDesktop()){this.setEditService("l");BX.adjust(e,{text:BX.message("DISK_FOLDER_TOOLBAR_LABEL_LOCAL_BDISK_EDIT")});BX.PopupMenu.destroy("disk_open_menu_with_services")}else{this.helpDiskDialog()}return BX.PreventDefault(t)},t)},{text:t.getNameEditService("google"),className:"bx-viewer-popup-item item-gdocs",href:"#",onclick:BX.delegate(function(t){this.setEditService("google");BX.adjust(e,{text:this.getNameEditService("google")});BX.PopupMenu.destroy("disk_open_menu_with_services");return BX.PreventDefault(t)},t)},{text:t.getNameEditService("office365"),className:"bx-viewer-popup-item item-office365",href:"#",onclick:BX.delegate(function(t){this.setEditService("office365");BX.adjust(e,{text:this.getNameEditService("office365")});BX.PopupMenu.destroy("disk_open_menu_with_services");return BX.PreventDefault(t)},t)},{text:t.getNameEditService("skydrive"),className:"bx-viewer-popup-item item-office",href:"#",onclick:BX.delegate(function(t){this.setEditService("skydrive");BX.adjust(e,{text:this.getNameEditService("skydrive")});BX.PopupMenu.destroy("disk_open_menu_with_services");return BX.PreventDefault(t)},t)}],{offsetTop:0,offsetLeft:25})};e.DiskOpenMenuImportService=function(e,t){var i=[];for(var s in t){if(!t.hasOwnProperty(s))continue;i.push({text:t[s].name,code:t[s].id,href:"#",onclick:function(e,t){var i=t.layout.item;BX.addClass(i,"diskuf-selector-link-cloud");i.setAttribute("data-bx-doc-handler",t.code);BX.onCustomEvent("onManualChooseCloudImport",[{target:i}]);BX.removeClass(i,"diskuf-selector-link-cloud");i.removeAttribute("data-bx-doc-handler");BX.PopupMenu.destroy("disk_open_menu_with_import_services");return BX.PreventDefault(e)}})}var o=new BX.CViewer({});o.openMenu("disk_open_menu_with_import_services",BX(e),i,{offsetTop:0,offsetLeft:25});return BX.PreventDefault()};e.DiskActionFileMenu=function(e,t,i){s++;BX.PopupMenu.show("bx-viewer-wd-popup"+s+"_"+e,BX(t),i,{angle:{position:"top",offset:25},autoHide:true});return false};e.WDInlineElementClickDispatcher=function(e,t){var i=BX(t);if(i){BX.fireEvent(i,"click")}return false}})(window);
/* End */
;; /* /bitrix/components/bitrix/crm.activity.email/templates/.default/script.min.js?154412740016406*/
; /* /bitrix/components/bitrix/main.mail.form/templates/.default/script.min.js?154412738422660*/
; /* /bitrix/components/bitrix/main.mail.confirm/templates/.default/script.min.js?15441273846063*/
; /* /bitrix/components/bitrix/main.post.form/templates/.default/script.min.js?154412738466246*/
; /* /bitrix/components/bitrix/system.field.edit/script.min.js?1544127384814*/
; /* /bitrix/components/bitrix/disk.uf.file/templates/.default/script.min.js?154412740428279*/

//# sourceMappingURL=page_3b7181487e36676719957749ad8bfffa.map.js